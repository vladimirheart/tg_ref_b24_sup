#!/bin/sh
set -e

BASEDIR=$(CDPATH= cd -- "$(dirname "$0")" && pwd)
WRAPPER_DIR="$BASEDIR/.mvn"
MAVEN_VERSION="3.9.6"
MAVEN_DIR="$WRAPPER_DIR/apache-maven-$MAVEN_VERSION"
MAVEN_BIN="$MAVEN_DIR/bin/mvn"
ARCHIVE="$WRAPPER_DIR/apache-maven-$MAVEN_VERSION-bin.zip"
DOWNLOAD_URL="https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/$MAVEN_VERSION/apache-maven-$MAVEN_VERSION-bin.zip"

if [ ! -x "$MAVEN_BIN" ]; then
  mkdir -p "$WRAPPER_DIR"
  if [ ! -f "$ARCHIVE" ]; then
    if command -v curl >/dev/null 2>&1; then
      echo "Downloading Maven $MAVEN_VERSION via curl..." >&2
      curl -fsSL "$DOWNLOAD_URL" -o "$ARCHIVE" || true
    elif command -v wget >/dev/null 2>&1; then
      echo "Downloading Maven $MAVEN_VERSION via wget..." >&2
      wget -q "$DOWNLOAD_URL" -O "$ARCHIVE" || true
    else
      echo "Error: neither curl nor wget is available to download Maven." >&2
    fi
  fi
  if [ ! -f "$ARCHIVE" ]; then
    if command -v mvn >/dev/null 2>&1; then
      echo "Maven archive download failed; falling back to 'mvn' on PATH..." >&2
      exec mvn "$@"
    fi
    echo "Failed to download Maven $MAVEN_VERSION and no global 'mvn' command was found." >&2
    exit 1
  fi
  echo "Extracting Maven $MAVEN_VERSION..." >&2
  if command -v python3 >/dev/null 2>&1; then
    python3 - "$ARCHIVE" "$WRAPPER_DIR" <<'PY'
import sys
import zipfile
from pathlib import Path

archive = Path(sys.argv[1])
target = Path(sys.argv[2])
with zipfile.ZipFile(archive) as zf:
    zf.extractall(target)
PY
  elif command -v python >/dev/null 2>&1; then
    python - "$ARCHIVE" "$WRAPPER_DIR" <<'PY'
import sys
import zipfile
from pathlib import Path

archive = Path(sys.argv[1])
target = Path(sys.argv[2])
with zipfile.ZipFile(archive) as zf:
    zf.extractall(target)
PY
  elif command -v unzip >/dev/null 2>&1; then
    unzip -q "$ARCHIVE" -d "$WRAPPER_DIR"
  else
    echo "Error: need python (3.x) or unzip to extract Maven archive." >&2
    if command -v mvn >/dev/null 2>&1; then
      echo "Falling back to 'mvn' on PATH..." >&2
      exec mvn "$@"
    fi
    exit 1
  fi
fi

if [ ! -x "$MAVEN_BIN" ]; then
  if command -v mvn >/dev/null 2>&1; then
    echo "Unable to prepare Maven wrapper; using 'mvn' from PATH." >&2
    exec mvn "$@"
  fi
  echo "Maven wrapper binary is missing and no global 'mvn' command is available." >&2
  exit 1
fi

exec "$MAVEN_BIN" "$@"
