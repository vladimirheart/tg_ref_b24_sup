<!-- Unified sidebar fragment shared across all pages -->
<div xmlns:th="http://www.thymeleaf.org" th:fragment="navbar(active)">
    <div class="sidebar" id="app-sidebar">
        <div class="sidebar-header">
            <span class="brand">
                <img th:src="@{/iguana-icon.svg}" alt="–õ–æ–≥–æ—Ç–∏–ø iguana" class="brand-icon" loading="lazy" decoding="async"/>
                <span class="brand-name">iguana</span>
            </span>
            <div class="sidebar-actions" id="notify-bell-wrapper">
                <button id="bellBtn" class="icon-btn notify-btn" type="button" title="–û–ø–æ–≤–µ—â–µ–Ω–∏—è" aria-expanded="false">
                    <span class="icon" aria-hidden="true">üîî</span>
                    <span id="notify-count" class="notify-count" hidden>0</span>
                </button>
                <div id="notify-dropdown" class="notify-dropdown" hidden role="listbox" aria-label="–û–ø–æ–≤–µ—â–µ–Ω–∏—è"></div>
                <button id="pinSidebarBtn" class="icon-btn" type="button" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å/–æ—Ç–∫—Ä–µ–ø–∏—Ç—å">üìå</button>
                <button id="resetSidebarOrderBtn" class="icon-btn" type="button" title="–í–µ—Ä–Ω—É—Ç—å –ø–æ—Ä—è–¥–æ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é">‚Ü∫</button>
            </div>
        </div>

        <div class="alert alert-warning small mb-0" th:if="${dbWarning}" role="alert">
            <div class="fw-semibold">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</div>
            <div th:text="${dbWarning}"></div>
            <div class="mt-2 text-muted">–¢–µ–∫—É—â–∏–π –ø—É—Ç—å: <span class="fw-semibold" th:text="${dbPath}"></span></div>
            <div class="mt-1">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è <code>APP_DB_TICKETS</code> –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø–∞–Ω–µ–ª—å.</div>
        </div>

        <nav class="sidebar-nav" aria-label="–û—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è">
            <a class="nav-link" data-page-key="dialogs"
               th:classappend="${active}=='dialogs' ? ' active'"
               th:href="@{/}">
                <span class="icon" aria-hidden="true">üí¨</span>
                <span class="label">–î–∏–∞–ª–æ–≥–∏</span>
            </a>
            <a class="nav-link" data-page-key="tasks" th:if="${canManageTasks}"
               th:classappend="${active}=='tasks' ? ' active'"
               th:href="@{/tasks}">
                <span class="icon" aria-hidden="true">‚úÖ</span>
                <span class="label">–ó–∞–¥–∞—á–∏</span>
            </a>
            <a class="nav-link" data-page-key="clients" th:if="${canViewClients}"
               th:classappend="${active}=='clients' ? ' active'"
               th:href="@{/clients}">
                <span class="icon" aria-hidden="true">üë•</span>
                <span class="label">–ö–ª–∏–µ–Ω—Ç—ã</span>
            </a>
            <a class="nav-link" data-page-key="passports" th:if="${canViewPassports}"
               th:classappend="${active}=='passports' ? ' active'"
               th:href="@{/object-passports}">
                <span class="icon" aria-hidden="true">üóÉÔ∏è</span>
                <span class="label">–ü–∞—Å–ø–æ—Ä—Ç –æ–±—ä–µ–∫—Ç–æ–≤</span>
            </a>
            <a class="nav-link" data-page-key="public"
               th:classappend="${active}=='public' ? ' active'"
               th:href="@{/public/forms/demo}">
                <span class="icon" aria-hidden="true">üåê</span>
                <span class="label">–í–Ω–µ—à–Ω–∏–µ —Ñ–æ—Ä–º—ã</span>
            </a>
            <a class="nav-link" data-page-key="knowledge" th:if="${canEditKnowledgeBase}"
               th:classappend="${active}=='knowledge' ? ' active'"
               th:href="@{/knowledge-base}">
                <span class="icon" aria-hidden="true">üìö</span>
                <span class="label">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</span>
            </a>
            <a class="nav-link" data-page-key="dashboard"
               th:classappend="${active}=='dashboard' ? ' active'"
               th:href="@{/dashboard}">
                <span class="icon" aria-hidden="true">üìä</span>
                <span class="label">–î–∞—à–±–æ—Ä–¥</span>
            </a>
            <a class="nav-link" data-page-key="analytics" th:if="${canViewAnalytics}"
               th:classappend="${active}=='analytics' ? ' active'"
               th:href="@{/analytics}">
                <span class="icon" aria-hidden="true">üìà</span>
                <span class="label">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
            </a>
            <a class="nav-link" data-page-key="channels" th:if="${canManageChannels}"
               th:classappend="${active}=='channels' ? ' active'"
               th:href="@{/channels}">
                <span class="icon" aria-hidden="true">üì°</span>
                <span class="label">–ö–∞–Ω–∞–ª—ã</span>
            </a>
            <a class="nav-link" data-page-key="settings" th:if="${canViewSettings}"
               th:classappend="${active}=='settings' ? ' active'"
               th:href="@{/settings}">
                <span class="icon" aria-hidden="true">‚öôÔ∏è</span>
                <span class="label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
            </a>
            <a class="nav-link" data-page-key="users" th:if="${canManageUsers}"
               th:classappend="${active}=='users' ? ' active'"
               th:href="@{/users}">
                <span class="icon" aria-hidden="true">üë•</span>
                <span class="label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <div class="sidebar-order-controls">
                <button
                        id="editSidebarOrderBtn"
                        class="sidebar-order-btn"
                        type="button"
                        aria-label="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ä—è–¥–æ–∫"
                        title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ä—è–¥–æ–∫">
                    <span class="icon" aria-hidden="true">‚áÖ</span>
                </button>
            </div>
            <div class="sidebar-user-card" th:if="${#authentication?.name}">
                <div class="sidebar-user-avatar">
                    <img th:src="${sidebarUserAvatarUrl}" alt="–ê–≤–∞—Ç–∞—Ä" loading="lazy" decoding="async"/>
                </div>
                <div class="sidebar-user-meta">
                    <span class="sidebar-user-name" th:text="${sidebarUserDisplayName}">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                    <span class="sidebar-user-username" th:text="${sidebarUserUsername}"></span>
                </div>
            </div>
            <button type="button" class="sidebar-account-btn" data-sidebar-change-password>
                <span class="icon" aria-hidden="true">üîê</span>
                <span class="label">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</span>
            </button>
            <a class="sidebar-logout-btn" th:href="@{/logout}">
                <span class="icon" aria-hidden="true">üö™</span>
                <span class="label">–í—ã–π—Ç–∏</span>
            </a>
        </div>
    </div>

    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true" data-sidebar-password-modal>
        <div class="modal-dialog">
            <form class="modal-content" data-change-password-form>
                <div class="modal-header">
                    <h5 class="modal-title">–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger d-none" data-change-password-error role="alert"></div>
                    <div class="alert alert-success d-none" data-change-password-success role="alert"></div>
                    <div class="mb-3">
                        <label class="form-label" for="changePasswordCurrent">–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
                        <input type="password" class="form-control" id="changePasswordCurrent" name="current_password" autocomplete="current-password" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="changePasswordNew">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                        <input type="password" class="form-control" id="changePasswordNew" name="new_password" autocomplete="new-password" required minlength="8">
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="changePasswordConfirm">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                        <input type="password" class="form-control" id="changePasswordConfirm" name="confirm_password" autocomplete="new-password" required>
                    </div>
                    <p class="text-muted small mb-0">–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–æ–ª–∏—Ç–∏–∫–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary" data-change-password-submit>
                        <span data-change-password-submit-text>–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</span>
                        <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true" data-change-password-spinner></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <style id="modal-animations-style">
        .modal.fade .modal-dialog {
            --modal-scale-hidden: 0.92;
            --modal-scale-visible: 1;
            --modal-scale-closing: 0.9;
            --modal-scale: var(--modal-scale-hidden);
            transform: var(--modal-transform, scale(var(--modal-scale)));
            opacity: 0;
            transform-origin: center;
            transition: transform 0.25s ease, opacity 0.25s ease;
        }

        .modal.fade.show .modal-dialog,
        .modal.fade.showing .modal-dialog {
            --modal-scale: var(--modal-scale-visible);
            opacity: 1;
        }

        .modal.fade.modal-closing .modal-dialog {
            --modal-scale: var(--modal-scale-closing);
            opacity: 0;
        }

        .modal.fade.modal-closing {
            pointer-events: none;
        }
    </style>

    <script th:src="@{/js/theme.js}"></script>
    <script th:src="@{/js/sidebar.js}"></script>
</div>
