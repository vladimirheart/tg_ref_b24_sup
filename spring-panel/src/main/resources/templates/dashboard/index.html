<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="_csrf" th:content="${_csrf.token}" />
  <title>–û—Ç—á—ë—Ç—ã ‚Äî iguana</title>
  <link rel="icon" type="image/svg+xml" th:href="@{/iguana-icon.svg}" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <link th:href="@{/css/style.css}" rel="stylesheet" />
  <link th:href="@{/css/sidebar.css(v='2')}" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
  <script th:src="@{/js/common.js}"></script>
  <style>
    body {
      padding-top: 0;
      background-color: #f8f9fa;
    }
    .card { margin-bottom: 20px; }
    .chart-container { height: 300px; }
    .stats-value { font-size: 1.5rem; font-weight: bold; }
    .stats-change { font-size: 0.9rem; }
    .positive-change { color: #28a745; }
    .negative-change { color: #dc3545; }
    .filter-section { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    .chart-value-label {
      font-size: 0.75rem;
      font-weight: bold;
      fill: #000;
    }
    .period-presets {
      display: flex;
      gap: 10px;
      margin-top: 5px;
      flex-wrap: wrap;
    }
    .period-preset-btn {
      padding: 4px 8px;
      font-size: 0.75rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: white;
      cursor: pointer;
    }
    .period-preset-btn:hover {
      background: #f0f0f0;
    }
    .period-preset-btn.active {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }
    .container-fluid {
      padding-left: 20px;
      padding-right: 20px;
    }
    .navbar {
      position: fixed !important;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1030;
      margin-bottom: 0;
    }
    .restaurant-filter-container {
      position: relative;
    }
    .restaurant-filter-container .select2-container {
      width: 100% !important;
    }
    .filter-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .filter-buttons .btn {
      white-space: nowrap;
    }
    .notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }
    .notification {
      background: white;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      border-left: 4px solid;
      min-width: 300px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .notification.success {
      border-left-color: #28a745;
    }
    .notification.error {
      border-left-color: #dc3545;
    }
    .notification.warning {
      border-left-color: #ffc107;
    }
    .notification.info {
      border-left-color: #17a2b8;
    }
    .notification-close {
      background: none;
      border: none;
      font-size: 1.125rem;
      cursor: pointer;
      color: #6c757d;
    }
    .notification-close:hover {
      color: #000;
    }
    /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ –∫–∞—Ä—Ç–æ—á–∫–∏ */
    .filters-and-stats-row {
      display: flex;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .filters-column {
      flex: 1;
      min-width: 300px;
    }
    .stats-column {
      flex: 0 0 300px;
      margin-left: 20px;
    }
    .card-sm {
      height: 90%; /* –£–º–µ–Ω—å—à–∞–µ–º –Ω–∞ 10% */
    }
    /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫—Ä—É–≥–æ–≤—ã—Ö –¥–∏–∞–≥—Ä–∞–º–º —Å –ª–µ–≥–µ–Ω–¥–æ–π —Å–ø—Ä–∞–≤–∞ */
    .pie-chart-container {
      display: flex;
      align-items: center;
      height: 100%;
    }
    .pie-chart-wrapper {
      flex: 0 0 60%;
      position: relative;
      height: 300px;
    }
    .pie-chart-legend {
      flex: 0 0 40%;
      padding-left: 30px;
      max-height: 300px;
      overflow-y: auto;
    }
    .pie-chart-legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      font-size: 0.875rem;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .pie-chart-legend-item.hidden {
      opacity: 0.5;
    }
    .pie-chart-legend-color {
      width: 16px;
      height: 16px;
      margin-right: 8px;
      border-radius: 3px;
    }
    .pie-chart-legend-label {
      display: flex;
      justify-content: space-between;
      flex-grow: 1;
    }
    .pie-chart-legend-value {
      font-weight: bold;
      margin-left: 10px;
    }

    @media (max-width: 768px) {
      .filters-and-stats-row {
        flex-direction: column;
      }
      .stats-column {
        margin-left: 0;
        margin-top: 20px;
        flex: 1;
      }
      .pie-chart-container {
        flex-direction: column;
      }
      .pie-chart-wrapper {
        flex: 0 0 100%;
        width: 100%;
      }
      .pie-chart-legend {
        flex: 0 0 100%;
        padding-left: 0;
        padding-top: 20px;
        width: 100%;
      }
    }
    .stats-column .card {
      margin-bottom: 15px;
    }

    .stats-column .card:last-child {
      margin-bottom: 0;
    }

    .time-stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
    }

    .time-stats-value {
      font-size: 1.8rem;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .time-stats-details {
      font-size: 0.85rem;
      opacity: 0.9;
    }

    .time-stats-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.8;
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º */
    .staff-time-stats {
      max-height: 300px;
      overflow-y: auto;
    }

    .staff-time-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 10px 0;
      border-bottom: 1px solid #f0f0f0;
      flex-direction: column;
    }

    .staff-time-item:last-child {
      border-bottom: none;
    }

    .staff-time-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      margin-bottom: 5px;
    }

    .staff-time-name {
      font-weight: bold;
      flex: 1;
    }

    .staff-time-total {
      font-weight: bold;
      color: #6c757d;
    }

    .staff-time-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      width: 100%;
      font-size: 0.85rem;
    }

    .staff-time-detail {
      display: flex;
      flex-direction: column;
    }

    .staff-time-label {
      font-size: 0.75rem;
      color: #6c757d;
      margin-bottom: 2px;
    }

    .staff-time-value {
      font-weight: 500;
    }

    .staff-time-avg {
      color: #28a745;
    }

    .staff-time-response {
      color: #007bff;
    }

    .staff-time-count {
      color: #6c757d;
    }
    .top-sticky-bar { position: sticky; top: 0; z-index: 1030; }
    .toast, .alert[data-role="loaded-hint"] { z-index: 1020 !important; }
    .page-title { margin-top: 0 !important; }
    header h1, .content h1, .container h1 { margin-top: 0 !important; }
  </style>
</head>
<body class="with-sidebar sidebar-pinned">
  <div th:replace="~{fragments/navbar :: navbar(${activePage})}"></div>
  <main class="main-content container-fluid">
  <div class="container-fluid mt-4">
    <h2>üìà –û—Ç—á—ë—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏</h2>

    <ul class="nav nav-tabs mb-3" id="reportsTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-dashboard" data-bs-toggle="tab" data-bs-target="#reports-dashboard" type="button" role="tab">–î–∞—à–±–æ—Ä–¥</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-managers" data-bs-toggle="tab" data-bs-target="#reports-managers" type="button" role="tab">–û—Ç—á—ë—Ç—ã –ø–æ —É–ø—Ä–∞–≤–ª—è—é—â–∏–º</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-olap" data-bs-toggle="tab" data-bs-target="#reports-olap" type="button" role="tab">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –æ—Ç—á—ë—Ç–æ–≤</button>
      </li>
    </ul>

    <div class="tab-content">
      <div class="tab-pane fade show active" id="reports-dashboard" role="tabpanel">

    <!-- –§–∏–ª—å—Ç—Ä—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ -->
    <div class="filters-and-stats-row">
      <!-- –ö–æ–ª–æ–Ω–∫–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ -->
      <div class="filters-column">
        <div class="filter-section">
          <div class="row">
            <div class="col-md-12">
              <label for="dateRange">–ü–µ—Ä–∏–æ–¥:</label>
              <input type="text" id="dateRange" class="form-control" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥">
              <div class="period-presets">
                <button class="period-preset-btn" data-preset="week">–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è</button>
                <button class="period-preset-btn" data-preset="month">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</button>
                <button class="period-preset-btn" data-preset="quarter">–¢–µ–∫—É—â–∏–π –∫–≤–∞—Ä—Ç–∞–ª</button>
                <button class="period-preset-btn" data-preset="year">–¢–µ–∫—É—â–∏–π –≥–æ–¥</button>
                <button class="period-preset-btn" data-preset="all">–ó–∞ –≤—Å—ë –≤—Ä–µ–º—è</button>
              </div>
            </div>
          </div>

          <div class="row mt-3">
            <div class="col-md-12">
              <label for="restaurantFilter">–†–µ—Å—Ç–æ—Ä–∞–Ω:</label>
              <select id="restaurantFilter" class="form-control" multiple="multiple">
                <option th:each="restaurant : ${restaurants}" th:value="${restaurant}" th:text="${restaurant}"></option>
              </select>
            </div>
          </div>

          <div class="row mt-3">
            <div class="col-md-12">
              <div class="filter-buttons">
                <button id="applyFilters" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                <button id="resetFilters" class="btn btn-secondary">–°–±—Ä–æ—Å–∏—Ç—å</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- –ö–æ–ª–æ–Ω–∫–∞ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π -->
      <div class="stats-column">
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞—è–≤–æ–∫ -->
        <div class="card text-center">
          <div class="card-body">
            <h5 class="card-title">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</h5>
            <div class="stats-value" id="totalTickets">0</div>
            <div class="stats-change" id="totalTicketsChange"></div>
          </div>
        </div>

        <!-- –ù–û–í–ê–Ø –ö–ê–†–¢–û–ß–ö–ê - –ó–ê–¢–†–ê–ß–ï–ù–ù–û–ï –í–†–ï–ú–Ø -->
        <div class="card text-center time-stats-card mt-3">
          <div class="card-body">
            <h5 class="card-title">‚è±Ô∏è –ó–∞—Ç—Ä–∞—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è</h5>
            <div class="time-stats-value" id="totalTime">0 —á</div>
            <div class="time-stats-details">
              <div class="time-stats-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –Ω–∞ –∑–∞—è–≤–∫—É</div>
              <div id="avgTimePerTicket">0 –º–∏–Ω</div>
              <div class="time-stats-label">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞—è–≤–æ–∫</div>
              <div id="resolvedCount">0</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- –í—Ä–µ–º—è –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º -->
    <div class="card mt-3">
        <div class="card-body">
            <h5 class="card-title">‚è±Ô∏è –í—Ä–µ–º—è –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º</h5>
            <div id="staffTimeStats" class="staff-time-stats">
                <div class="text-center text-muted py-3">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
            </div>
        </div>
    </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ –∫–∞–Ω–∞–ª–∞–º -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">–ó–∞—è–≤–∫–∏ –ø–æ –∫–∞–Ω–∞–ª–∞–º</h5>
            <div class="chart-container">
              <canvas id="chartByChannel"></canvas>
            </div>
          </div>
        </div>
      </div>
    <!-- –û—Å—Ç–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å –¥–∞—à–±–æ—Ä–¥–∞ (–≥—Ä–∞—Ñ–∏–∫–∏) -->
    <div class="row">
      <!-- –ü–æ –±–∏–∑–Ω–µ—Å—É (–∫—Ä—É–≥–æ–≤–∞—è) -->
      <div class="col-md-6">
          <div class="card">
              <div class="card-body">
                  <h5 class="card-title">–ü–æ –±–∏–∑–Ω–µ—Å—É</h5>
                  <div class="pie-chart-container">
                    <div class="pie-chart-wrapper">
                      <canvas id="businessChart"></canvas>
                    </div>
                    <div class="pie-chart-legend" id="businessLegend"></div>
                  </div>
              </div>
          </div>
      </div>

      <!-- –ü–æ —Å–µ—Ç—è–º (–∫—Ä—É–≥–æ–≤–∞—è) -->
      <div class="col-md-6">
          <div class="card">
              <div class="card-body">
                  <h5 class="card-title">–ü–æ —Å–µ—Ç—è–º</h5>
                  <div class="pie-chart-container">
                    <div class="pie-chart-wrapper">
                      <canvas id="networkChart"></canvas>
                    </div>
                    <div class="pie-chart-legend" id="networkLegend"></div>
                  </div>
              </div>
          </div>
      </div>
    </div>

    <div class="row">
      <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π</h5>
            <div class="chart-container">
              <canvas id="categoryChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- –ì–æ—Ä–æ–¥–∞ -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">–ü–æ –≥–æ—Ä–æ–¥–∞–º</h5>
            <div class="chart-container">
              <canvas id="cityChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <!-- –†–µ—Å—Ç–æ—Ä–∞–Ω—ã -->
      <div class="col-md-12">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">–ü–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º (—Ç–æ–ø-10)</h5>
            <div class="chart-container">
              <canvas id="restaurantChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
      </div>

      <div class="tab-pane fade" id="reports-managers" role="tabpanel">
        <div class="card mb-3">
          <div class="card-body">
            <div class="row g-3 align-items-end">
              <div class="col-md-6">
                <label for="managerDateRange" class="form-label">–ü–µ—Ä–∏–æ–¥ –æ—Ç—á—ë—Ç–∞</label>
                <input type="text" id="managerDateRange" class="form-control" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥">
              </div>
              <div class="col-md-3">
                <button class="btn btn-primary w-100" id="applyManagerFilters">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø–µ—Ä–∏–æ–¥</button>
              </div>
              <div class="col-md-3">
                <button class="btn btn-outline-secondary w-100" id="resetManagerFilters">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</button>
              </div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">–°—Ä–µ–∑ –ø–æ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è–º —É–ø—Ä–∞–≤–ª—è—é—â–∏—Ö</h5>
            <div id="supervisorSummary" class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
          </div>
        </div>
        <div class="accordion mt-3" id="managerAccordion"></div>
      </div>

      <div class="tab-pane fade" id="reports-olap" role="tabpanel">
        <div class="card">
          <div class="card-body">
            <div class="row g-3 align-items-end">
              <div class="col-md-4">
                <label class="form-label">–ò–∑–º–µ—Ä–µ–Ω–∏–µ</label>
                <select class="form-select" id="olapDimension">
                  <option value="location">–õ–æ–∫–∞—Ü–∏—è</option>
                  <option value="city">–ì–æ—Ä–æ–¥</option>
                  <option value="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</option>
                  <option value="responsible">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label d-block">–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö</label>
                <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="olapAppeals" checked><label class="form-check-label" for="olapAppeals">–û–±—Ä–∞—â–µ–Ω–∏—è</label></div>
                <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="olapTasks" checked><label class="form-check-label" for="olapTasks">–ó–∞–¥–∞—á–∏</label></div>
                <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="olapChanges" checked><label class="form-check-label" for="olapChanges">–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã</label></div>
              </div>
              <div class="col-md-2">
                <button class="btn btn-primary w-100" id="buildOlap">–°–æ–±—Ä–∞—Ç—å</button>
              </div>
            </div>
            <div class="table-responsive mt-3">
              <table class="table table-sm table-striped">
                <thead><tr><th>–ò–∑–º–µ—Ä–µ–Ω–∏–µ</th><th>–û–±—Ä–∞—â–µ–Ω–∏—è</th><th>–ó–∞–¥–∞—á–∏</th><th>–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã</th></tr></thead>
                <tbody id="olapTableBody"><tr><td colspan="4" class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
  <div class="notification-container" id="notificationContainer"></div>

<script>
    let charts = {};
    const inactiveByChart = {}; // { [canvasId]: Set<number> }

    function withAlpha(color, alpha) {
      if (!color) return `rgba(0,0,0,${alpha})`;
      const s = color.toString().trim();
      if (s.startsWith('rgb')) {
        const parts = s.replace(/rgba?\(|\)|\s/g,'').split(',');
        const [r,g,b] = parts.map(Number);
        return `rgba(${r||0},${g||0},${b||0},${alpha})`;
      }
      if (s[0] === '#') {
        let r,g,b;
        if (s.length === 4) { r=parseInt(s[1]+s[1],16); g=parseInt(s[2]+s[2],16); b=parseInt(s[3]+s[3],16); }
        else { r=parseInt(s.slice(1,3),16); g=parseInt(s.slice(3,5),16); b=parseInt(s.slice(5,7),16); }
        return `rgba(${r},${g},${b},${alpha})`;
      }
      return color;
    }
    let currentFilters = {
      startDate: null,
      endDate: null,
      restaurants: []
    };
    let managerFilters = {
      startDate: null,
      endDate: null
    };

    function getCurrentMonthRange() {
      const now = new Date();
      return {
        startDate: new Date(now.getFullYear(), now.getMonth(), 1),
        endDate: new Date(now.getFullYear(), now.getMonth() + 1, 0)
      };
    }

    function applyManagerMonthDefaults() {
      const range = getCurrentMonthRange();
      managerFilters.startDate = range.startDate.toISOString().split('T')[0];
      managerFilters.endDate = range.endDate.toISOString().split('T')[0];
      const picker = document.querySelector('#managerDateRange')?._flatpickr;
      if (picker) {
        picker.setDate([range.startDate, range.endDate], true);
      }
    }

    // –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –ª–µ–≥–µ–Ω–¥
    const legendData = {
      businessChart: { labels: [], values: [], total: 0 },
      networkChart: { labels: [], values: [], total: 0 }
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
    document.addEventListener('DOMContentLoaded', function() {
      // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      const monthRange = getCurrentMonthRange();
      const firstDay = monthRange.startDate;
      const lastDay = monthRange.endDate;

      currentFilters.startDate = firstDay.toISOString().split('T')[0];
      currentFilters.endDate = lastDay.toISOString().split('T')[0];
      managerFilters.startDate = currentFilters.startDate;
      managerFilters.endDate = currentFilters.endDate;

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è datepicker
      flatpickr("#dateRange", {
        mode: "range",
        locale: "ru",
        dateFormat: "d.m.Y",
        defaultDate: [firstDay, lastDay],
        onChange: function(selectedDates, dateStr, instance) {
          if (selectedDates.length === 2) {
            currentFilters.startDate = selectedDates[0].toISOString().split('T')[0];
            currentFilters.endDate = selectedDates[1].toISOString().split('T')[0];
            // –°–±—Ä–æ—Å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–µ—Å–µ—Ç–∞ –ø—Ä–∏ —Ä—É—á–Ω–æ–º –≤—ã–±–æ—Ä–µ –¥–∞—Ç
            document.querySelectorAll('.period-preset-btn').forEach(btn => {
              btn.classList.remove('active');
            });
          }
        }
      });

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è select2 –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
      $('#restaurantFilter').select2({
        placeholder: "–í—Å–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã",
        allowClear: true,
        width: '100%'
      });

      flatpickr("#managerDateRange", {
        mode: "range",
        locale: "ru",
        dateFormat: "d.m.Y",
        defaultDate: [firstDay, lastDay],
        onChange: function(selectedDates) {
          if (selectedDates.length === 2) {
            managerFilters.startDate = selectedDates[0].toISOString().split('T')[0];
            managerFilters.endDate = selectedDates[1].toISOString().split('T')[0];
          }
        }
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –ø—Ä–µ—Å–µ—Ç–æ–≤ –ø–µ—Ä–∏–æ–¥–∞
      document.querySelectorAll('.period-preset-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const preset = this.dataset.preset;
          setPeriodPreset(preset);

          // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–µ—Å–µ—Ç
          document.querySelectorAll('.period-preset-btn').forEach(b => {
            b.classList.remove('active');
          });
          this.classList.add('active');
        });
      });

      // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø—Ä–µ—Å–µ—Ç —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      document.querySelector('[data-preset="month"]').classList.add('active');

      // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
      loadDashboardData();
      loadManagerReport();

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
      document.getElementById('applyFilters').addEventListener('click', () => {
        loadDashboardData();
        loadManagerReport();
      });
      document.getElementById('resetFilters').addEventListener('click', function() {
        $('#restaurantFilter').val(null).trigger('change');
        setPeriodPreset('month'); // –°–±—Ä–æ—Å –∫ —Ç–µ–∫—É—â–µ–º—É –º–µ—Å—è—Ü—É
        currentFilters.restaurants = [];
        loadDashboardData();
        loadManagerReport();
      });

      document.getElementById('applyManagerFilters')?.addEventListener('click', () => loadManagerReport(true));
      document.getElementById('resetManagerFilters')?.addEventListener('click', () => {
        applyManagerMonthDefaults();
        loadManagerReport(true);
      });
      document.getElementById('buildOlap')?.addEventListener('click', buildOlapReport);
      document.getElementById('tab-managers')?.addEventListener('shown.bs.tab', () => loadManagerReport(true));
      document.getElementById('tab-olap')?.addEventListener('shown.bs.tab', buildOlapReport);
    });

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–∏–æ–¥–∞ –ø–æ –ø—Ä–µ—Å–µ—Ç—É
    function setPeriodPreset(preset) {
      const now = new Date();
      let startDate, endDate;

      switch(preset) {
        case 'week':
          // –ù–∞—á–∞–ª–æ —Ç–µ–∫—É—á–Ω–æ–π –Ω–µ–¥–µ–ª–∏ (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫)
          const monday = new Date(now);
          monday.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1));
          startDate = new Date(monday);
          endDate = new Date(now);
          break;

        case 'month':
          // –¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
          break;

        case 'quarter':
          // –¢–µ–∫—É—â–∏–π –∫–≤–∞—Ä—Ç–∞–ª
          const currentQuarter = Math.floor(now.getMonth() / 3);
          startDate = new Date(now.getFullYear(), currentQuarter * 3, 1);
          endDate = new Date(now.getFullYear(), (currentQuarter + 1) * 3, 0);
          break;

        case 'year':
          // –¢–µ–∫—É—â–∏–π –≥–æ–¥
          startDate = new Date(now.getFullYear(), 0, 1);
          endDate = new Date(now.getFullYear(), 11, 31);
          break;

        case 'all':
          // –ó–∞ –≤—Å—ë –≤—Ä–µ–º—è (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º null)
          startDate = null;
          endDate = null;
          break;
      }

      if (startDate && endDate) {
        currentFilters.startDate = startDate.toISOString().split('T')[0];
        currentFilters.endDate = endDate.toISOString().split('T')[0];
        flatpickr("#dateRange").setDate([startDate, endDate], true);
      } else {
        currentFilters.startDate = null;
        currentFilters.endDate = null;
        flatpickr("#dateRange").clear();
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–∞—à–±–æ—Ä–¥–∞
async function loadManagerReport(showError = false) {
  const accordion = document.getElementById('managerAccordion');
  const supervisor = document.getElementById('supervisorSummary');
  if (!accordion || !supervisor) {
    return;
  }

  try {
    const response = await fetch('/api/dashboard/manager-report', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        startDate: managerFilters.startDate,
        endDate: managerFilters.endDate,
        restaurants: currentFilters.restaurants || []
      })
    });
    const data = await response.json();
    if (!response.ok || data.success === false) {
      throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á—ë—Ç–∞');
    }

    const supervisorRows = Object.entries(data.supervisors || {}).map(([name, total]) => `${name}: ${total}`).join(' ¬∑ ');
    supervisor.textContent = supervisorRows || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
    const managers = Array.isArray(data.managers) ? data.managers : [];
    if (!managers.length) {
      accordion.innerHTML = '<div class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —É–ø—Ä–∞–≤–ª—è—é—â–∏–º –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.</div>';
      return;
    }

    accordion.innerHTML = managers.map((item, idx) => {
      const body = (item.locations || []).map((loc) => `<li class="list-group-item d-flex justify-content-between"><span>${loc.location}</span><strong>${loc.count}</strong></li>`).join('');
      return `<div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button ${idx ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#mgr-${idx}">${item.manager} ¬∑ ${item.total} –æ–±—Ä–∞—â.</button></h2><div id="mgr-${idx}" class="accordion-collapse collapse ${idx ? '' : 'show'}"><div class="accordion-body"><div class="small text-muted mb-2">–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å: ${item.supervisor || '‚Äî'}</div><ul class="list-group">${body}</ul></div></div></div>`;
    }).join('');
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á—ë—Ç–∞ –ø–æ —É–ø—Ä–∞–≤–ª—è—é—â–∏–º:', error);
    accordion.innerHTML = '<div class="text-danger">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç—á—ë—Ç –ø–æ —É–ø—Ä–∞–≤–ª—è—é—â–∏–º.</div>';
    if (showError) {
      showNotification('–û—à–∏–±–∫–∞ –æ—Ç—á—ë—Ç–∞ –ø–æ —É–ø—Ä–∞–≤–ª—è—é—â–∏–º: ' + error.message, 'error');
    }
  }
}

async function buildOlapReport() {
  const response = await fetch('/api/dashboard/olap-preview', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      filters: { startDate: currentFilters.startDate, endDate: currentFilters.endDate, restaurants: currentFilters.restaurants || [] },
      olap: {
        dimension: document.getElementById('olapDimension')?.value || 'location',
        includeAppeals: document.getElementById('olapAppeals')?.checked !== false,
        includeTasks: document.getElementById('olapTasks')?.checked !== false,
        includeSystemChanges: document.getElementById('olapChanges')?.checked !== false,
      }
    })
  });
  const data = await response.json();
  const tbody = document.getElementById('olapTableBody');
  if (!tbody) return;
  if (!response.ok || data.success === false) {
    tbody.innerHTML = '<tr><td colspan="4" class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
    return;
  }
  const rows = Array.isArray(data.rows) ? data.rows : [];
  tbody.innerHTML = rows.map((row) => `<tr><td>${row.dimension}</td><td>${row.appeals ?? 0}</td><td>${row.tasks ?? 0}</td><td>${row.system_changes ?? 0}</td></tr>`).join('');
}

async function loadDashboardData() {
  try {
    showNotification('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...', 'info');

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
    const selectedRestaurants = $('#restaurantFilter').val();
    currentFilters.restaurants = selectedRestaurants ? selectedRestaurants : [];

    // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    const requestData = {
      startDate: currentFilters.startDate,
      endDate: currentFilters.endDate,
      restaurants: currentFilters.restaurants
    };

    console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:', requestData);

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º POST –∑–∞–ø—Ä–æ—Å
    const response = await fetch('/api/dashboard/data', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(requestData)
    });

    if (!response.ok) {
      let errorData;
      try {
        errorData = await response.json();
      } catch (e) {
        errorData = await response.text();
      }
      console.error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', response.status, errorData);
      throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${response.status} ${JSON.stringify(errorData)}`);
    }

    const data = await response.json();
    console.log('–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', data);

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    updateStats(data.stats, data.time_stats, data.staff_time_stats);
    const st = await (await fetch('/stats_data')).json();
    if (st.by_channel) {
      const dataByChannel = {};
      st.by_channel.forEach(x => { dataByChannel[x.name || '‚Äî'] = x.total || 0; });
      updateChart('chartByChannel', 'bar', dataByChannel, '#36a2eb', true);
    }

    // –í—ã–∑–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º
    updateStaffTimeStats(data.staff_time_stats);

    // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
    updateCharts(data.charts);

    showNotification('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');

  } catch (error) {
    console.error('–û—à–∏–±–∫–∞:', error);
    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–∞—à–±–æ—Ä–¥–∞: ' + error.message, 'error');
  }
}

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showNotification(message, type = 'info') {
      const container = document.getElementById('notificationContainer');
      // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      container.innerHTML = '';

      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div>${message}</div>
        <button class="notification-close">&times;</button>
      `;

      const closeButton = notification.querySelector('.notification-close');
      closeButton.addEventListener('click', function() {
        container.removeChild(notification);
      });

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
      setTimeout(() => {
        if (notification.parentNode === container) {
          container.removeChild(notification);
        }
      }, 5000);

      container.appendChild(notification);
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
function updateStats(stats, timeStats, staffTimeStats) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  if (!stats || !stats.current) {
    console.error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', stats);
    showNotification('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏', 'error');
    return;
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞—è–≤–æ–∫
  document.getElementById('totalTickets').textContent = stats.current.total || 0;
  updateComparison('totalTicketsChange', stats.current.total, stats.previous?.total);

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –≤—Ä–µ–º–µ–Ω–∏
  if (timeStats) {
    document.getElementById('totalTime').textContent = timeStats.formatted_total || '0 —á';
    document.getElementById('avgTimePerTicket').textContent = timeStats.formatted_avg || '0 –º–∏–Ω';
    document.getElementById('resolvedCount').textContent = timeStats.resolved_count || '0';
  } else {
    // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–ª–∏
    document.getElementById('totalTime').textContent = '0 —á';
    document.getElementById('avgTimePerTicket').textContent = '0 –º–∏–Ω';
    document.getElementById('resolvedCount').textContent = '0';
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º
function updateStaffTimeStats(staffStats) {
    const container = document.getElementById('staffTimeStats');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ staffStats —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º
    if (!staffStats || !Array.isArray(staffStats) || staffStats.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-3">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
        return;
    }

    let html = '';
    staffStats.forEach(staff => {
        html += `
            <div class="staff-time-item">
                <div class="staff-time-header">
                    <div class="staff-time-name">${staff.name}</div>
                    <div class="staff-time-total">${staff.formatted_total}</div>
                </div>
                <div class="staff-time-details">
                    <div class="staff-time-detail">
                        <div class="staff-time-label">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞—è–≤–æ–∫</div>
                        <div class="staff-time-value staff-time-count">${staff.resolved_count}</div>
                    </div>
                    <div class="staff-time-detail">
                        <div class="staff-time-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –Ω–∞ –∑–∞—è–≤–∫—É</div>
                        <div class="staff-time-value staff-time-avg">${staff.formatted_avg}</div>
                    </div>
                    <div class="staff-time-detail">
                        <div class="staff-time-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞</div>
                        <div class="staff-time-value staff-time-response">${staff.formatted_avg_response}</div>
                    </div>
                    <div class="staff-time-detail">
                        <div class="staff-time-label">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
                        <div class="staff-time-value">${staff.resolved_count > 0 ? Math.round(staff.total_minutes / staff.resolved_count) : 0} –º–∏–Ω/–∑–∞—è–≤–∫–∞</div>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –º–µ—Å—è—Ü-–∫-–º–µ—Å—è—Ü—É
    function updateComparison(elementId, currentValue, previousValue) {
      const element = document.getElementById(elementId);
      if (!previousValue || previousValue === 0) {
        element.innerHTML = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–µ—Ä–∏–æ–¥';
        element.className = 'stats-change';
        return;
      }

      const change = ((currentValue - previousValue) / previousValue) * 100;
      const changeText = `${change >= 0 ? '+' : ''}${change.toFixed(1)}%`;

      element.innerHTML = changeText;
      element.className = `stats-change ${change >= 0 ? 'positive-change' : 'negative-change'}`;
    }

    // –ü–ø–ª–∞–≥–∏–Ω –ø–æ–¥–ø–∏—Å–µ–π –¥–ª—è H-bar
    const BarValueLabels = {
      id: 'BarValueLabels',
      afterDatasetsDraw(chart) {
        const {ctx, chartArea} = chart;
        const ds = chart.data.datasets[0];
        if (!ds) return;
        const meta = chart.getDatasetMeta(0);
        const canvasId = chart.canvas.id;
        const inactive = inactiveByChart[canvasId] || new Set();
        const data = ds.data || [];

        // —Å—É–º–º–∞ —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö (–Ω–µ –≤—ã–∫–ª—é—á–µ–Ω–Ω—ã—Ö)
        const visibleTotal = data.reduce((sum, v, i) => sum + (inactive.has(i) ? 0 : (v||0)), 0);

        ctx.save();
        ctx.font = '12px Arial';
        ctx.textBaseline = 'middle';
        ctx.textAlign = 'left';
        ctx.fillStyle = '#000';

        meta.data.forEach((barEl, i) => {
          if (!barEl) return;
          const val = data[i] ?? 0;
          const pct = visibleTotal > 0 ? ((val / visibleTotal) * 100).toFixed(1) : '0.0';
          const text = `${val} (${pct}%)`;

          const pad = 6;
          const tw = ctx.measureText(text).width;

          // –¥–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ bar: base ‚Äî –ª–µ–≤—ã–π –∫—Ä–∞–π –æ—Å–∏, x ‚Äî –∫–æ–Ω–µ—Ü —Å—Ç–æ–ª–±–∏–∫–∞
          let x = barEl.base + pad; // –ø–æ–ø—Ä–æ–±—É–µ–º –≤–Ω—É—Ç—Ä–∏ ¬´—Å–ª–µ–≤–∞¬ª
          const y = barEl.y;

          // –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è —Å–ø—Ä–∞–≤–∞ ‚Äî –ø–µ—Ä–µ–Ω–æ—Å–∏–º –ø–µ—Ä–µ–¥ –∫–æ–Ω—Ü–æ–º —Å—Ç–æ–ª–±–∏–∫–∞, –Ω–æ –Ω–µ –≤—ã—Ö–æ–¥–∏–º –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã
          const maxX = chartArea.right - pad;
          if (x + tw > maxX) x = Math.max(barEl.x - tw - pad, chartArea.left + pad);

          // —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ ¬´—Å—Ç–æ–ø–æ—Ä—ã¬ª
          if (x < chartArea.left + pad) x = chartArea.left + pad;
          if (x + tw > chartArea.right - pad) x = chartArea.right - pad - tw;

          ctx.fillText(text, x, y);
        });

        ctx.restore();
      }
    };

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
    function updateCharts(chartData) {
        if (!chartData) {
            console.error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤');
            showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤', 'warning');
            return;
        }

        console.log('–î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤:', chartData);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
        Object.keys(chartData).forEach(key => {
            console.log(`–ì—Ä–∞—Ñ–∏–∫ ${key}:`, chartData[key]);
            if (!chartData[key] || Object.keys(chartData[key]).length === 0) {
                console.warn(`–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞: ${key}`);
                showNotification(`–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞: ${key}`, 'warning');
            }
        });

        // –ö—Ä—É–≥–æ–≤—ã–µ –¥–∏–∞–≥—Ä–∞–º–º—ã —Å –æ—Ç–¥–µ–ª—å–Ω–æ–π –ª–µ–≥–µ–Ω–¥–æ–π
        updatePieChartWithLegend('businessChart', 'businessLegend', chartData.business, ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff']);
        updatePieChartWithLegend('networkChart', 'networkLegend', chartData.network, ['#f7ee68', '#f74d4d', '#cfc102', '#ff7a7a']);

        // –°—Ç–æ–ª–±—á–∞—Ç—ã–µ –¥–∏–∞–≥—Ä–∞–º–º—ã
        updateChart('categoryChart', 'bar', chartData.category, '#36a2eb', true);
        updateChart('cityChart', 'bar', chartData.city, '#4bc0c0', true);
        updateChart('restaurantChart', 'bar', chartData.restaurant, '#9966ff', true);
    }

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã —Å –æ—Ç–¥–µ–ª—å–Ω–æ–π –ª–µ–≥–µ–Ω–¥–æ–π
function updatePieChartWithLegend(canvasId, legendId, data, colors) {
  const ctx = document.getElementById(canvasId);
  const legendContainer = document.getElementById(legendId);

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É—é—Ç –ª–∏ —ç–ª–µ–º–µ–Ω—Ç—ã
  if (!ctx || !legendContainer) {
    console.warn(`–≠–ª–µ–º–µ–Ω—Ç—ã —Å ID ${canvasId} –∏–ª–∏ ${legendId} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ`);
    return;
  }

  // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  if (charts[canvasId]) {
    charts[canvasId].destroy();
    delete charts[canvasId];
  }

  // –û—á–∏—â–∞–µ–º –ª–µ–≥–µ–Ω–¥—É
  legendContainer.innerHTML = '';

  if (!data || Object.keys(data).length === 0) {
    console.warn(`–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞: ${canvasId}`);
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö
    if (ctx.parentElement) {
      ctx.style.display = 'none';

      if (!ctx.parentElement.querySelector('.no-data-message')) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'text-center text-muted py-5 no-data-message';
        messageDiv.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è';
        ctx.parentElement.appendChild(messageDiv);
      }
    }
    return;
  }

  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º canvas –µ—Å–ª–∏ –æ–Ω –±—ã–ª —Å–∫—Ä—ã—Ç
  ctx.style.display = 'block';

  // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
  const messageDiv = ctx.parentElement.querySelector('.no-data-message');
  if (messageDiv) {
    ctx.parentElement.removeChild(messageDiv);
  }

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ª–µ–≥–µ–Ω–¥—ã
  const labels = Object.keys(data);
  const values = Object.values(data);
  const total = values.reduce((sum, value) => sum + value, 0);

  legendData[canvasId] = {
    labels: labels,
    values: values,
    total: total
  };

  // –°–æ–∑–¥–∞–µ–º –ª–µ–≥–µ–Ω–¥—É
  labels.forEach((label, index) => {
    const value = values[index];
    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;

    const legendItem = document.createElement('div');
    legendItem.className = 'pie-chart-legend-item';
    legendItem.dataset.index = index;

    const colorBox = document.createElement('div');
    colorBox.className = 'pie-chart-legend-color';
    colorBox.style.backgroundColor = colors[index % colors.length];

    const legendLabel = document.createElement('div');
    legendLabel.className = 'pie-chart-legend-label';
    legendLabel.innerHTML = `
      <span>${label}</span>
      <span class="pie-chart-legend-value">${value} (${percentage}%)</span>
    `;

    legendItem.appendChild(colorBox);
    legendItem.appendChild(legendLabel);
    legendContainer.appendChild(legendItem);

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è/–ø–æ–∫–∞–∑–∞ —ç–ª–µ–º–µ–Ω—Ç–∞
    legendItem.addEventListener('click', function() {
      toggleChartElement(canvasId, parseInt(this.dataset.index));
    });
  });

  // –°–æ–∑–¥–∞–µ–º –∫—Ä—É–≥–æ–≤—É—é –¥–∏–∞–≥—Ä–∞–º–º—É –±–µ–∑ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –ª–µ–≥–µ–Ω–¥—ã
  const chartConfig = {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{
        data: values,
        backgroundColor: colors
      }]
    },
    options: {
      plugins: {
        legend: {
          display: false // –û—Ç–∫–ª—é—á–∞–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –ª–µ–≥–µ–Ω–¥—É
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const percentage = ((context.raw / total) * 100).toFixed(1);
              return `${context.label}: ${context.raw} (${percentage}%)`;
            }
          }
        }
      }
    }
  };

  charts[canvasId] = new Chart(ctx, chartConfig);
setTimeout(() => {
  const chart = charts[canvasId];
  if (chart) {
    const meta = chart.getDatasetMeta(0);
    if (meta && meta.data) {
      meta.data.forEach((dataItem, index) => {
        dataItem.hidden = false;
      });
    }
  }
}, 100);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è/–ø–æ–∫–∞–∑–∞ —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–∞ –∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º–µ
function toggleChartElement(canvasId, index) {
  const chart = charts[canvasId];
  const legendId = canvasId === 'businessChart' ? 'businessLegend' : 'networkLegend';
  const legendContainer = document.getElementById(legendId);
  const legendItem = legendContainer.querySelector(`[data-index="${index}"]`);

  if (!chart || !legendItem) return;

  // –ü–æ–ª—É—á–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º
  const meta = chart.getDatasetMeta(0);
  if (!meta || !meta.data[index]) return;

  // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞
  const currentHidden = meta.data[index].hidden;

  // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å
  meta.data[index].hidden = !currentHidden;
  chart.update();

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å —ç–ª–µ–º–µ–Ω—Ç–∞ –ª–µ–≥–µ–Ω–¥—ã
  if (currentHidden) {
    legendItem.classList.remove('hidden');
  } else {
    legendItem.classList.add('hidden');
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ª–µ–≥–µ–Ω–¥–µ —Å —É—á–µ—Ç–æ–º —Å–∫—Ä—ã—Ç—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  updateLegendValues(canvasId);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –≤ –ª–µ–≥–µ–Ω–¥–µ —Å —É—á–µ—Ç–æ–º —Å–∫—Ä—ã—Ç—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
function updateLegendValues(canvasId) {
  const chart = charts[canvasId];
  const legendId = canvasId === 'businessChart' ? 'businessLegend' : 'networkLegend';
  const legendContainer = document.getElementById(legendId);
  const data = legendData[canvasId];

  if (!chart || !legendContainer || !data) return;

  // –ü–æ–ª—É—á–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º
  const meta = chart.getDatasetMeta(0);
  if (!meta) return;

  // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—É—é —Å—É–º–º—É —Å —É—á–µ—Ç–æ–º —Å–∫—Ä—ã—Ç—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  let visibleTotal = 0;

  data.values.forEach((value, index) => {
    if (!meta.data[index] || !meta.data[index].hidden) {
      visibleTotal += value;
    }
  });

  // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ª–µ–≥–µ–Ω–¥–µ
  const legendItems = legendContainer.querySelectorAll('.pie-chart-legend-item');
  legendItems.forEach(item => {
    const index = parseInt(item.dataset.index);
    const value = data.values[index];

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —ç–ª–µ–º–µ–Ω—Ç –∏ —Å–∫—Ä—ã—Ç –ª–∏ –æ–Ω
    const isHidden = meta.data[index] && meta.data[index].hidden;

    let percentage;
    if (isHidden) {
      percentage = '0.0';
    } else {
      percentage = visibleTotal > 0 ? ((value / visibleTotal) * 100).toFixed(1) : '0.0';
    }

    const valueElement = item.querySelector('.pie-chart-legend-value');
    if (valueElement) {
      valueElement.textContent = `${isHidden ? '‚Äî' : value} (${percentage}%)`;
    }
  });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ (–¥–ª—è bar charts)
function updateChart(canvasId, type, data, backgroundColor, showValues = false) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) { console.warn(`–≠–ª–µ–º–µ–Ω—Ç —Å ID ${canvasId} –Ω–µ –Ω–∞–π–¥–µ–Ω`); return; }

  if (charts[canvasId]) { charts[canvasId].destroy(); delete charts[canvasId]; }

  if (!data || Object.keys(data).length === 0) {
    canvas.style.display = 'none';
    if (!canvas.parentElement.querySelector('.no-data-message')) {
      const m = document.createElement('div');
      m.className = 'text-center text-muted py-5 no-data-message';
      m.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è';
      canvas.parentElement.appendChild(m);
    }
    return;
  }
  canvas.style.display = 'block';
  const msg = canvas.parentElement.querySelector('.no-data-message');
  if (msg) msg.remove();

  const labels = Object.keys(data);
  const values = Object.values(data);
  const baseColors = Array.isArray(backgroundColor) ? backgroundColor : labels.map(() => backgroundColor || '#36a2eb');
  const isBar = type === 'bar';

  // –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è ¬´–≤—ã–∫–ª—é—á–µ–Ω–Ω—ã—Ö¬ª
  if (!inactiveByChart[canvasId]) inactiveByChart[canvasId] = new Set();
  const inactive = inactiveByChart[canvasId];

  charts[canvasId] = new Chart(canvas, {
    type: isBar ? 'bar' : type,
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: (ctx) => {
          const i = ctx.dataIndex;
          const base = baseColors[i % baseColors.length];
          const alpha = inactive.has(i) ? 0.25 : 1;
          return withAlpha(base, alpha);
        }
      }]
    },
    options: {
      indexAxis: isBar ? 'y' : 'x',
      responsive: true,
      maintainAspectRatio: false,
      scales: isBar ? {
        x: { beginAtZero: true, ticks: { callback: v => v } }
      } : {},
      plugins: {
        legend: { display: type === 'pie' }, // –¥–ª—è bar ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º –ª–µ–≥–µ–Ω–¥—É
        tooltip: {
          filter: (tipItem) => tipItem.datasetIndex === 0,
          callbacks: {
            label: (context) => {
              const raw = context.raw ?? 0;
              const ds = context.dataset.data || [];
              const visTotal = ds.reduce((s, v, idx) => s + (inactive.has(idx) ? 0 : (v||0)), 0);
              const pct = visTotal > 0 ? ((raw / visTotal) * 100).toFixed(1) : '0.0';
              return `${context.label}: ${raw} (${pct}%)`;
            }
          }
        }
      },
      animation: false
    },
    plugins: (showValues && isBar) ? [BarValueLabels] : []
  });

  // –∫–ª–∏–∫ –ø–æ —Å—Ç–æ–ª–±–∏–∫—É = –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º ¬´–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å¬ª (–¥–µ–ª–∞–µ–º –±–ª–µ–¥–Ω—ã–º/–Ω–æ—Ä–º–∞–ª—å–Ω—ã–º)
  if (isBar) {
    canvas.onclick = (evt) => {
      const pts = charts[canvasId].getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
      if (!pts || !pts.length) return;
      const i = pts[0].index;
      if (inactive.has(i)) inactive.delete(i); else inactive.add(i);
      charts[canvasId].update();
    };
  }
}

  </script>
 </main>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script th:src="@{/js/sidebar.js}"></script>
  <script th:src="@{/js/modal-transitions.js}"></script>
</body>
</html>
