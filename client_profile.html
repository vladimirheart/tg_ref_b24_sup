<!-- panel/templates/client_profile.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–ª–∏–µ–Ω—Ç {{ client.user_id }} ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .chat-bubble { 
      padding: 8px 12px; 
      border-radius: 8px; 
      margin-bottom: 6px; 
      max-width: 80%; 
      word-wrap: break-word;
    }
    .from-user { background: #e3f2fd; align-self: flex-end; }
    .from-support { background: #d1f7d1; align-self: flex-start; }

    .chat-container { 
      min-height: 300px; 
      max-height: 500px; 
      overflow-y: auto; 
      padding: 10px; 
    }

    /* ‚úÖ –ß—ë—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç */
    .chat-bubble p, .chat-bubble small, .chat-bubble strong {
      color: #000 !important;
    }

    /* ‚úÖ –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫–∞ */
    .input-group-send {
      display: flex;
      align-items: stretch;
      gap: 8px;
    }
    .input-group-send textarea {
      flex: 1;
      resize: both;
      min-height: 60px;
      max-height: 200px;
    }
    .input-group-send .btn {
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="/">üì¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞</a>
      <div class="navbar-nav ms-auto">
		<a class="nav-link" href="/">–ó–∞—è–≤–∫–∏</a>
        <a class="nav-link" href="/analytics">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
		<a class="nav-link" href="/analytics/clients">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤</a>
		<a class="nav-link active" href="/clients">–ö–ª–∏–µ–Ω—Ç—ã</a>
        <a class="nav-link" href="/dashboard">–î–∞—à–±–æ—Ä–¥</a>
        <a class="nav-link" href="/settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
        <a class="nav-link" href="/logout">–í—ã—Ö–æ–¥</a>
      </div>
    </div>
  </nav>

<!-- –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ë–õ–û–ö –í –ù–ê–ß–ê–õ–û –°–¢–†–ê–ù–ò–¶–´ -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title">üìã –°—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞</h5>
    </div>
    <div class="card-body">
        <div class="d-flex align-items-center gap-3">
            <span class="fw-bold">–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:</span>
            <span id="currentStatus" class="badge bg-secondary fs-6">{{ client_status }}</span>
            
            <div class="ms-auto">
                <select id="statusSelect" class="form-select me-2" style="width: 200px; display: inline-block;">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å...</option>
                    {% for status in statuses %}
                    <option value="{{ status }}" {% if status == client_status %}selected{% endif %}>{{ status }}</option>
                    {% endfor %}
                </select>
                <button class="btn btn-primary" onclick="updateClientStatus({{ client.user_id }})">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

  <div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>üë§ –ö–∞—Ä—Ç–æ—á–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞</h2>
      <a href="/clients" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥</a>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h5>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
        <p><strong>ID Telegram:</strong> <code>{{ client.user_id }}</code></p>
        <p><strong>–Æ–∑–µ—Ä–Ω–µ–π–º –≤ Telegram:</strong> {{ client.username or '‚Äî' }}</p>
        <p><strong>–ò–º—è –≤ –ë–î:</strong> <span id="clientNameDisplay">{{ client.client_name or '‚Äî' }}</span></p>
        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editClientNameModal">
          ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–º—è
        </button>
      </div>
    </div>

    <h4>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card text-center">
          <div class="card-body">
            <h5>{{ stats.total }}</h5>
            <p class="text-muted">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card text-center">
          <div class="card-body">
            <h5>{{ stats.resolved }}</h5>
            <p class="text-success">–†–µ—à–µ–Ω–æ</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card text-center">
          <div class="card-body">
            <h5>{{ stats.pending }}</h5>
            <p class="text-warning">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</p>
          </div>
        </div>
      </div>
    </div>

    <!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Ç–µ–º–∞–º –∏ –ª–æ–∫–∞—Ü–∏—è–º -->
    <h4>üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –æ–±—Ä–∞—â–µ–Ω–∏—è–º</h4>
    <div class="card mb-4">
      <div class="card-body">
        <h6>–¢–µ–º—ã –æ–±—Ä–∞—â–µ–Ω–∏–π</h6>
        <ul class="list-group mb-3">
          {% set categories = {} %}
          {% for t in tickets %}
            {% if t.category %}
              {% if t.category not in categories %}
                {% set _ = categories.update({t.category: 1}) %}
              {% else %}
                {% set _ = categories.update({t.category: categories[t.category] + 1}) %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% for cat, cnt in categories.items() %}
          <li class="list-group-item d-flex justify-content-between">
            <span>{{ cat }}</span>
            <span class="badge bg-info">{{ cnt }}</span>
          </li>
          {% endfor %}
        </ul>

        <h6>–õ–æ–∫–∞—Ü–∏–∏</h6>
        <ul class="list-group">
          {% set locations = {} %}
          {% for t in tickets %}
            {% set loc = t.city + ' ‚Äî ' + (t.location_name or '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è') %}
            {% if loc not in locations %}
              {% set _ = locations.update({loc: 1}) %}
            {% else %}
              {% set _ = locations.update({loc: locations[loc] + 1}) %}
            {% endif %}
          {% endfor %}
          {% for loc, cnt in locations.items() %}
          <li class="list-group-item d-flex justify-content-between">
            <span>{{ loc }}</span>
            <span class="badge bg-secondary">{{ cnt }}</span>
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <!-- –û—Ü–µ–Ω–∫–∏ -->
    {% if feedbacks %}
    <h4>‚≠ê –û—Ü–µ–Ω–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤</h4>
    <div class="card mb-4">
      <div class="card-body">
        <ul class="list-group">
          {% for f in feedbacks %}
          <li class="list-group-item feedback-item">
            <strong>{{ f.rating }} –∏–∑ 5</strong> ‚Äî {{ f.timestamp.split('.')[0] }}
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
    {% endif %}

    <!-- –ó–∞—è–≤–∫–∏ -->
    <h4>üìã –ó–∞—è–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞</h4>
    <div class="accordion" id="ticketsAccordion">
      {% for t in tickets %}
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ t.ticket_id }}">
            {{ t.ticket_id }} ‚Äî {{ t.business }} ({{ t.city }})
          </button>
        </h2>
        <div id="collapse-{{ t.ticket_id }}" class="accordion-collapse collapse" data-bs-parent="#ticketsAccordion">
          <div class="accordion-body">
            <p><strong>–ü—Ä–æ–±–ª–µ–º–∞:</strong> {{ t.problem }}</p>
            <p><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> {{ t.category or '‚Äî' }}</p>
            <p><strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong> {{ t.created_date }} {{ t.created_time }}</p>
            {% if t.status == 'resolved' %}
              {% if t.resolved_at %}
				<p><strong>–ó–∞–≤–µ—Ä—à–µ–Ω–∞:</strong> {{ t.resolved_at.split('.')[0] }} <strong>–∫–µ–º:</strong> {{ t.resolved_by or '–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏' }}</p>
					{% else %}
				<p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="badge bg-warning text-dark">‚è≥ –í –æ–±—Ä–∞–±–æ—Ç–∫–µ</span></p>
					{% endif %}
              {% if t.duration_minutes is not none %}
                <p><strong>–í—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:</strong> {{ t.duration_minutes }} –º–∏–Ω</p>
              {% endif %}
            {% else %}
              <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="badge bg-warning text-dark">‚è≥ –í –æ–±—Ä–∞–±–æ—Ç–∫–µ</span></p>
            {% endif %}
            <button class="btn btn-sm btn-outline-secondary" onclick="loadHistory({{ client.user_id }}, '{{ t.ticket_id }}')">
              –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é
            </button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ -->
  <div class="modal fade" id="editClientNameModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="newClientName" class="form-control" value="{{ client.client_name or '' }}" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          <button type="button" class="btn btn-primary" onclick="saveClientName()">
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –∏—Å—Ç–æ—Ä–∏—è -->
  <div class="modal fade resizable-modal" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable modal-lg modal-dialog-centered" style="width: 80%; height: 80%;">
      <div class="modal-content" style="min-height: 400px;">
        <div class="modal-header">
          <h5 class="modal-title" id="historyModalTitle">üí¨ –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ ‚Äî ID –∑–∞—è–≤–∫–∏: <span id="ticketIdDisplay"></span></h5>
          <div class="d-flex align-items-center gap-2">
            <span id="clientDisplayName">‚Äî</span>
            <button type="button" class="btn btn-sm btn-outline-primary" id="editClientBtn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–º—è">
              ‚úèÔ∏è
            </button>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body chat-container" id="historyContent" style="min-height: 300px;"></div>
        <div class="modal-footer">
          <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫–∞ —Ä–µ–∂–∏–º–∞ -->
          <div class="input-group-send w-100">
            <textarea
              id="replyTextInHistory"
              class="form-control"
              placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç..."
            ></textarea>
            <button id="sendKeySettingBtn" class="btn btn-outline-secondary" type="button" style="width: 120px;" data-bs-toggle="dropdown">
              Enter ‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" data-mode="enter">Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</a></li>
              <li><a class="dropdown-item" href="#" data-mode="ctrlEnter">Ctrl+Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</a></li>
              <li><a class="dropdown-item" href="#" data-mode="enterNewline">Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞</a></li>
            </ul>
          </div>
          <div class="mt-2 d-flex justify-content-between w-100">
            <button type="button" id="closeTicketBtn" class="btn btn-danger">–ó–∞–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É</button>
            <button type="button" id="sendReplyInHistory" class="btn btn-primary">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –∑–∞–∫—Ä—ã—Ç–∏–µ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π -->
  <div class="modal fade" id="closeTicketModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">–ó–∞–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label for="categorySelect" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è</label>
          <select id="categorySelect" class="form-select">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>
          </select>
          <div class="form-text">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø–æ–º–æ–∂–µ—Ç –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          <button type="button" id="confirmCloseTicketBtn" class="btn btn-danger">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    window.settings = {
  "categories": {{ settings.categories | tojson if settings and settings.categories else '["–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è"]' | safe }}
};
  </script>
  <script>
    let currentUserId = null;
    let currentTicketId = null;
    let historyPolling = null;
    let clientData = null;

    // === –û—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –æ—Ç–≤–µ—Ç–∞ ===
    function openReplyModal(user_id) {
      currentUserId = user_id;
      document.getElementById('replyText').value = '';
      new bootstrap.Modal(document.getElementById('replyModal')).show();
    }

    // === –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç ===
    async function sendReply() {
      const text = document.getElementById('replyText').value.trim();
      const admin = document.getElementById('adminName').value || '–ü–æ–¥–¥–µ—Ä–∂–∫–∞';
      if (!text) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞');
        return;
      }

      const response = await fetch('/reply', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: currentUserId, text, admin })
      });

      const data = await response.json();
      if (data.success) {
        alert('‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
        location.reload();
      } else {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
      }
    }

    // === –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ ===
    function loadSendSettings() {
      const saved = localStorage.getItem('sendKeySetting') || 'enter';
      const btn = document.getElementById('sendKeySettingBtn');
      updateSendButtonLabel(saved);
      return saved;
    }

    function updateSendButtonLabel(mode) {
      const btn = document.getElementById('sendKeySettingBtn');
      const labels = {
        'enter': 'Enter ‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å',
        'ctrlEnter': 'Ctrl+Enter ‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å',
        'enterNewline': 'Enter ‚Üí –ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞'
      };
      btn.textContent = labels[mode] || 'Enter ‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å';
    }

    // === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ ===
    document.querySelectorAll('#sendKeySettingBtn + .dropdown-menu a').forEach(item => {
      item.addEventListener('click', function (e) {
        e.preventDefault();
        const mode = this.getAttribute('data-mode');
        localStorage.setItem('sendKeySetting', mode);
        updateSendButtonLabel(mode);
      });
    });

    // === –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã ===
    async function autoRefreshTickets() {
      try {
        const responseStats = await fetch('/stats_data');
        const data = await responseStats.json();

        const totalEl = document.getElementById('total');
        const pendingEl = document.getElementById('pending');
        const resolvedEl = document.getElementById('resolved');

        if (totalEl) totalEl.textContent = data.total || 0;
        if (pendingEl) pendingEl.textContent = data.pending || 0;
        if (resolvedEl) resolvedEl.textContent = data.resolved || 0;

        const responseTable = await fetch('/tickets_list');
        const tickets = await responseTable.json();
        console.log("üì© –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏:", tickets);

        const container = document.getElementById('ticketsBody');
        if (container) container.innerHTML = '';

        tickets.forEach(t => {
          const username = t.username ? `@${t.username}` : '–Ω–µ—Ç —é–∑–µ—Ä–Ω–µ–π–º–∞';
          const clientName = t.client_name || '–Ω–µ –∑–∞–¥–∞–Ω–æ';

          const client = `
            <code>${t.user_id}</code><br>
            <small>${username}</small>
          `;

          const statusBadge = t.status === 'resolved'
            ? `<span class="badge bg-success">‚úÖ –†–µ—à–µ–Ω–æ</span><br><small>${t.resolved_by || ''}<br>${t.resolved_at?.slice(11,16) || ''}</small>`
            : `<span class="badge bg-warning text-dark">‚è≥ –í –æ–±—Ä–∞–±–æ—Ç–∫–µ</span>`;

          const actionBtns = t.status !== 'resolved'
            ? `<button class="btn btn-sm btn-primary" onclick="openReplyModal(${t.user_id})">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
               <button class="btn btn-sm btn-danger" onclick="confirmClose(${t.user_id}, '${t.ticket_id}')">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>`
            : '';

          const row = document.createElement('tr');
          row.dataset.search = `${t.user_id} ${t.username} ${clientName} ${t.ticket_id} ${t.business} ${t.city} ${t.location_name} ${t.problem} ${t.status} ${t.responsible} ${t.created_date}`.toLowerCase();
          row.innerHTML = `
  <td>${client}</td>
  <td><code>${t.ticket_id}</code></td>
  <td>${t.business}</td>
  <td>${t.city}<br><small>${t.location_name}</small></td>
  <td><button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#modal-${t.ticket_id}">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å</button></td>
  <td>${t.responsible}</td>
  <td>${statusBadge}</td>
  <td>${t.created_date}</td>
  <td>${t.created_time}</td>
  <td>
    <button class="btn btn-sm btn-outline-secondary" onclick="loadHistory(${t.user_id}, '${t.ticket_id}')">–ò—Å—Ç–æ—Ä–∏—è</button>
    ${actionBtns}
  </td>
`;
          container.appendChild(row);

          if (!document.getElementById(`modal-${t.ticket_id}`)) {
            const modal = document.createElement('div');
            modal.innerHTML = `
              <div class="modal fade" id="modal-${t.ticket_id}" tabindex="-1">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">–ü—Ä–æ–±–ª–µ–º–∞</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                      <p>${t.problem.replace(/\n/g, '<br>')}</p>
                    </div>
                  </div>
                </div>
              </div>
            `;
            document.body.appendChild(modal);
          }
        });

        applyFilters();
      } catch (e) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:", e);
      }
    }

    // === –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è ===
    function applyFilters() {
      const search = document.getElementById('searchInput')?.value.toLowerCase() || '';
      const status = document.getElementById('filterStatus')?.value || '';
      const user = document.getElementById('filterUser')?.value.toLowerCase() || '';
      const ticketId = document.getElementById('filterTicketId')?.value.toLowerCase() || '';
      const business = document.getElementById('filterBusiness')?.value.toLowerCase() || '';
      const location = document.getElementById('filterLocation')?.value.toLowerCase() || '';
      const responsible = document.getElementById('filterResponsible')?.value.toLowerCase() || '';
      const dateFrom = document.getElementById('filterDateFrom')?.value || '';
      const dateTo = document.getElementById('filterDateTo')?.value || '';

      document.querySelectorAll('#ticketsBody tr').forEach(row => {
        const text = row.dataset.search || '';
        const createdDate = text.match(/\d{4}-\d{2}-\d{2}/)?.[0] || '';

        const matches = (!search || text.includes(search)) &&
                       (!status || text.includes(status)) &&
                       (!user || text.includes(user)) &&
                       (!ticketId || text.includes(ticketId)) &&
                       (!business || text.includes(business)) &&
                       (!location || text.includes(location)) &&
                       (!responsible || text.includes(responsible)) &&
                       (!dateFrom || createdDate >= dateFrom) &&
                       (!dateTo || createdDate <= dateTo);

        row.style.display = matches ? '' : 'none';
      });
    }

    // === –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π ===
    document.getElementById('searchInput')?.addEventListener('input', applyFilters);
    document.getElementById('filterStatus')?.addEventListener('change', applyFilters);
    document.getElementById('filterUser')?.addEventListener('input', applyFilters);
    document.getElementById('filterTicketId')?.addEventListener('input', applyFilters);
    document.getElementById('filterBusiness')?.addEventListener('input', applyFilters);
    document.getElementById('filterLocation')?.addEventListener('input', applyFilters);
    document.getElementById('filterDateFrom')?.addEventListener('input', applyFilters);
    document.getElementById('filterDateTo')?.addEventListener('input', applyFilters);
    document.getElementById('filterResponsible')?.addEventListener('input', applyFilters);

    document.addEventListener('DOMContentLoaded', () => {
      loadSendSettings();
      autoRefreshTickets();
      setInterval(autoRefreshTickets, 5000);
    });

    // === –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é ===
    async function loadHistory(user_id, ticket_id) {
      currentUserId = user_id;
      currentTicketId = ticket_id;

      const response = await fetch(`/history?user_id=${user_id}&ticket_id=${ticket_id}`);
      const data = await response.json();
      const container = document.getElementById('historyContent');
      container.innerHTML = '';

      if (data.messages.length === 0) {
        container.innerHTML = '<p class="text-muted">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>';
      } else {
        data.messages.forEach(msg => {
          const cls = msg.sender === 'support' ? 'from-support' : 'from-user';
          let name = msg.sender === 'support' ? 'üõ† –ü–æ–¥–¥–µ—Ä–∂–∫–∞' : 'üë§ –ö–ª–∏–µ–Ω—Ç';

          if (msg.sender === 'user') {
            const clientName = clientData?.client_name;
            const username = clientData?.username;
            if (clientName && clientName !== '–Ω–µ –∑–∞–¥–∞–Ω–æ') {
              name = 'üë§ ' + clientName;
            } else if (username) {
              name = 'üë§ @' + username;
            } else {
              name = 'üë§ –ö–ª–∏–µ–Ω—Ç';
            }
          }

          const time = new Date(msg.timestamp).toLocaleString('ru-RU');
          const bubble = document.createElement('div');
          bubble.className = `chat-bubble ${cls}`;
          bubble.innerHTML = `
            <small>${time}</small><br>
            <strong>${name}</strong>
            <p class="mb-0">${msg.message.replace(/\n/g, '<br>')}</p>
          `;
          container.appendChild(bubble);
        });
      }

      container.scrollTop = container.scrollHeight;

      // –ó–∞–ø–æ–ª–Ω—è–µ–º select –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
      const select = document.getElementById('categorySelect');
      select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>';
      window.settings.categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        select.appendChild(option);
      });

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
      const modal = new bootstrap.Modal(document.getElementById('historyModal'));
      modal.show();

      if (historyPolling) clearInterval(historyPolling);
      historyPolling = setInterval(() => loadHistoryMessagesOnly(user_id, ticket_id), 5000);
    }

    // === –¢–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è ===
    async function loadHistoryMessagesOnly(user_id, ticket_id) {
      if (currentUserId !== user_id) return;
      const response = await fetch(`/history?user_id=${user_id}&ticket_id=${ticket_id}`);
      const data = await response.json();
      const container = document.getElementById('historyContent');
      container.innerHTML = '';
      data.messages.forEach(msg => {
        const cls = msg.sender === 'support' ? 'from-support' : 'from-user';
        let name = msg.sender === 'support' ? 'üõ† –ü–æ–¥–¥–µ—Ä–∂–∫–∞' : 'üë§ –ö–ª–∏–µ–Ω—Ç';

        if (msg.sender === 'user') {
          const clientName = clientData?.client_name;
          const username = clientData?.username;
          if (clientName && clientName !== '–Ω–µ –∑–∞–¥–∞–Ω–æ') {
            name = 'üë§ ' + clientName;
          } else if (username) {
            name = 'üë§ @' + username;
          } else {
            name = 'üë§ –ö–ª–∏–µ–Ω—Ç';
          }
        }

        const time = new Date(msg.timestamp).toLocaleString('ru-RU');
        const bubble = document.createElement('div');
        bubble.className = `chat-bubble ${cls}`;
        bubble.innerHTML = `
          <small>${time}</small><br>
          <strong>${name}</strong>
          <p class="mb-0">${msg.message.replace(/\n/g, '<br>')}</p>
        `;
        container.appendChild(bubble);
      });
      container.scrollTop = container.scrollHeight;
    }

    // === –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ ===
    document.getElementById('sendReplyInHistory').onclick = async function () {
      const text = document.getElementById('replyTextInHistory').value.trim();
      const admin = document.getElementById('adminName').value || '–ü–æ–¥–¥–µ—Ä–∂–∫–∞';
      if (!text) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞');
        return;
      }

      const response = await fetch('/reply', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          user_id: currentUserId, 
          text, 
          admin,
          ticket_id: currentTicketId 
        })
      });

      const data = await response.json();
      if (data.success) {
        document.getElementById('replyTextInHistory').value = '';
        loadHistoryMessagesOnly(currentUserId, currentTicketId);
      } else {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
      }
    };

    // === –ó–∞–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É ===
    document.getElementById('closeTicketBtn').onclick = async function () {
      const select = document.getElementById('categorySelect');
      const category = select.value;
      const admin = prompt("–í–∞—à–µ –∏–º—è –∏–ª–∏ @username:", "–ü–æ–¥–¥–µ—Ä–∂–∫–∞");
      if (!admin) return;

      if (!category) {
        alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
        return;
      }

      const response = await fetch('/close_ticket', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          user_id: currentUserId, 
          admin, 
          category, 
          ticket_id: currentTicketId 
        })
      });

      const data = await response.json();
      if (data.success) {
        alert('‚úÖ –ó–∞—è–≤–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞');
        location.reload();
      } else {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
      }

      bootstrap.Modal.getInstance(document.getElementById('closeTicketModal')).hide();
    };

    // === –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ ===
    function confirmClose(user_id, ticket_id) {
      if (confirm("–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞—è–≤–∫—É?")) {
        loadHistory(user_id, ticket_id);
      }
    }

    // === –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ ===
    async function saveClientName() {
      const newName = document.getElementById('newClientName').value.trim();
      const user_id = {{ client.user_id }};
      if (!newName || newName === '–Ω–µ –∑–∞–¥–∞–Ω–æ') return;

      const response = await fetch('/update_client_name', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id, client_name: newName })
      });

      const data = await response.json();
      if (data.success) {
        document.getElementById('clientNameDisplay').textContent = newName;
        bootstrap.Modal.getInstance(document.getElementById('editClientNameModal')).hide();
        alert('‚úÖ –ò–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
      } else {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
      }
    }
  </script>
  <!-- –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –°–ö–†–ò–ü–¢ –í –ö–û–ù–ï–¶ –§–ê–ô–õ–ê -->
<script>
async function updateClientStatus(userId) {
    const select = document.getElementById('statusSelect');
    const newStatus = select.value;
    
    if (!newStatus) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å');
        return;
    }
    
    try {
        const response = await fetch(`/api/client/${userId}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: newStatus })
        });
        
        const data = await response.json();
        if (data.success) {
            document.getElementById('currentStatus').textContent = newStatus;
            document.getElementById('currentStatus').className = 'badge bg-success fs-6';
            alert('‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω');
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
    }
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –£–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ —à–∞–±–ª–æ–Ω–∞
});
</script>
</body>
</html>