<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .settings-section { margin-bottom: 40px; }
    .settings-section h4 { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="/">üì¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞</a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link" href="/">–ó–∞—è–≤–∫–∏</a>
        <a class="nav-link" href="/analytics">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
		<a class="nav-link" href="/analytics/clients">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤</a>
		<a class="nav-link" href="/clients">–ö–ª–∏–µ–Ω—Ç—ã</a>
        <a class="nav-link" href="/dashboard">–î–∞—à–±–æ—Ä–¥</a>
        <a class="nav-link active" href="/settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
        <a class="nav-link" href="/logout">–í—ã—Ö–æ–¥</a>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</h2>

    <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–∞–Ω–µ–ª–∏ -->
    <div class="settings-section">
      <h4>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–∞–Ω–µ–ª–∏</h4>
      <div id="usersList">
        <!-- –°–ø–∏—Å–æ–∫ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>
      <button class="btn btn-sm btn-success" onclick="addUser()">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
    </div>

    <!-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ -->
    <div class="settings-section">
      <h4>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –¥–∏–∞–ª–æ–≥–æ–≤</h4>
      <div class="mb-3">
        <label for="autoCloseHours" class="form-label">–ó–∞–∫—Ä—ã–≤–∞—Ç—å –∑–∞—è–≤–∫—É –ø—Ä–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (—á–∞—Å—ã)</label>
        <input type="number" class="form-control" id="autoCloseHours" value="{{ settings.auto_close_hours }}" min="1" max="168">
      </div>
    </div>

    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
    <div class="settings-section">
      <h4>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π</h4>
      <div id="categoriesList">
        {% for cat in settings.categories %}
        <div class="input-group mb-2">
          <input type="text" class="form-control" value="{{ cat }}" disabled>
          <button class="btn btn-outline-danger" onclick="removeCategory(this)">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
        {% endfor %}
      </div>
      <button class="btn btn-sm btn-success" onclick="addCategory()">+ –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
    </div>

    <!-- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–æ–∫–∞—Ü–∏–π -->
    <div class="settings-section">
      <h4>üóÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ª–æ–∫–∞—Ü–∏–π</h4>
      <p>–†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –±–∏–∑–Ω–µ—Å ‚Üí —Ç–∏–ø ‚Üí –≥–æ—Ä–æ–¥ ‚Üí –ª–æ–∫–∞—Ü–∏–∏</p>
      <div id="locationsEditor">
        <!-- –î–µ—Ä–µ–≤–æ –±—É–¥–µ—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>
      <button class="btn btn-sm btn-success mt-2" onclick="addBusiness()">+ –î–æ–±–∞–≤–∏—Ç—å –±–∏–∑–Ω–µ—Å</button>
    </div>

<!-- –°—Ç–∞—Ç—É—Å—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
<div class="settings-section">
  <h4>üè∑Ô∏è –°—Ç–∞—Ç—É—Å—ã –∫–ª–∏–µ–Ω—Ç–æ–≤</h4>
  <div id="statusesList">
    {% for status in settings.client_statuses %}
    <div class="input-group mb-2">
      <input type="text" class="form-control" value="{{ status }}" disabled>
      <button class="btn btn-outline-danger" onclick="removeStatus(this)">–£–¥–∞–ª–∏—Ç—å</button>
    </div>
    {% endfor %}
  </div>
  <button class="btn btn-sm btn-success" onclick="addStatus()">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
</div>

    <!-- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å -->
    <button class="btn btn-primary" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  // === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ ===
function addStatus() {
  const container = document.getElementById('statusesList');
  const div = document.createElement('div');
  div.className = 'input-group mb-2';
  div.innerHTML = `
    <input type="text" class="form-control" placeholder="–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å">
    <button class="btn btn-outline-danger" onclick="removeStatus(this)">–£–¥–∞–ª–∏—Ç—å</button>
  `;
  container.appendChild(div);
}

function removeStatus(btn) {
  btn.parentElement.remove();
}

    // === JavaScript –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ ===
    async function loadUsers() {
      const response = await fetch('/users');
      const users = await response.json();
      const container = document.getElementById('usersList');
      container.innerHTML = '';
      users.forEach(u => {
        const div = document.createElement('div');
        div.className = 'input-group mb-2';
        div.innerHTML = `
          <input type="text" class="form-control" value="${u.username}" disabled>
          <select class="form-select" disabled>
            <option ${u.role==='admin'?'selected':''}>admin</option>
            <option ${u.role==='user'?'selected':''}>user</option>
          </select>
          <button class="btn btn-outline-danger" onclick="deleteUser(${u.id}, '${u.username}')">–£–¥–∞–ª–∏—Ç—å</button>
        `;
        container.appendChild(div);
      });
    }

    async function addUser() {
      const username = prompt("–õ–æ–≥–∏–Ω:");
      if (!username) return;
      const password = prompt("–ü–∞—Ä–æ–ª—å:");
      if (!password) return;
      const response = await fetch('/users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password, role: 'user' })
      });
      const data = await response.json();
      if (data.success) {
        alert('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω');
        loadUsers();
      } else {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
      }
    }

    async function deleteUser(id, name) {
      if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${name}?`)) return;
      const response = await fetch(`/users/${id}`, { method: 'DELETE' });
      const data = await response.json();
      if (data.success) {
        loadUsers();
      } else {
        alert('‚ùå –û—à–∏–±–∫–∞');
      }
    }

    // === JavaScript –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ª–æ–∫–∞—Ü–∏–π ===
    let locationsData = {{ locations | tojson }};

    function buildLocationsTree() {
      const container = document.getElementById('locationsEditor');
      container.innerHTML = '';

      Object.keys(locationsData).forEach(business => {
        const bDiv = document.createElement('div');
        bDiv.className = 'mb-3 border p-3 bg-light';
        bDiv.innerHTML = `
          <div class="d-flex">
            <input type="text" class="form-control me-2" value="${business}" onchange="updateBusiness('${business}', this.value)">
            <button class="btn btn-outline-danger" onclick="removeBusiness('${business}')">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        `;
        const typesDiv = document.createElement('div');
        Object.keys(locationsData[business]).forEach(type => {
          const tDiv = document.createElement('div');
          tDiv.className = 'ms-3 mb-2';
          tDiv.innerHTML = `
            <div class="d-flex">
              <input type="text" class="form-control me-2" value="${type}" onchange="updateType('${business}', '${type}', this.value)">
              <button class="btn btn-outline-danger" onclick="removeType('${business}', '${type}')">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          `;
          const citiesDiv = document.createElement('div');
          Object.keys(locationsData[business][type]).forEach(city => {
            const cDiv = document.createElement('div');
            cDiv.className = 'ms-3 mb-2';
            cDiv.innerHTML = `
              <div class="d-flex">
                <input type="text" class="form-control me-2" value="${city}" onchange="updateCity('${business}', '${type}', '${city}', this.value)">
                <button class="btn btn-outline-danger" onclick="removeCity('${business}', '${type}', '${city}')">–£–¥–∞–ª–∏—Ç—å</button>
              </div>
            `;
            const locsDiv = document.createElement('div');
            locationsData[business][type][city].forEach(loc => {
              const lDiv = document.createElement('div');
              lDiv.className = 'ms-4 mb-1 input-group';
              lDiv.innerHTML = `
                <input type="text" class="form-control" value="${loc}" onchange="updateLocation('${business}', '${type}', '${city}', '${loc}', this.value)">
                <button class="btn btn-outline-danger" onclick="removeLocation('${business}', '${type}', '${city}', '${loc}')">–£–¥–∞–ª–∏—Ç—å</button>
              `;
              locsDiv.appendChild(lDiv);
            });
            const addLoc = document.createElement('button');
            addLoc.className = 'btn btn-sm btn-success ms-4';
            addLoc.textContent = '+ –õ–æ–∫–∞—Ü–∏—è';
            addLoc.onclick = () => addLocation(business, type, city);
            cDiv.appendChild(locsDiv);
            cDiv.appendChild(addLoc);
            citiesDiv.appendChild(cDiv);
          });
          const addCity = document.createElement('button');
          addCity.className = 'btn btn-sm btn-success ms-3';
          addCity.textContent = '+ –ì–æ—Ä–æ–¥';
          addCity.onclick = () => addCityToType(business, type);
          tDiv.appendChild(citiesDiv);
          tDiv.appendChild(addCity);
          typesDiv.appendChild(tDiv);
        });
        const addType = document.createElement('button');
        addType.className = 'btn btn-sm btn-success ms-3';
        addType.textContent = '+ –¢–∏–ø';
        addType.onclick = () => addTypeToBusiness(business);
        bDiv.appendChild(typesDiv);
        bDiv.appendChild(addType);
        container.appendChild(bDiv);
      });
    }

    function updateBusiness(oldName, newName) {
      if (newName && newName !== oldName) {
        locationsData[newName] = locationsData[oldName];
        delete locationsData[oldName];
        buildLocationsTree();
      }
    }
    function addBusiness() {
      const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞:");
      if (name && !locationsData[name]) {
        locationsData[name] = { "–ù–æ–≤—ã–π —Ç–∏–ø": { "–ù–æ–≤—ã–π –≥–æ—Ä–æ–¥": [] } };
        buildLocationsTree();
      }
    }
    function removeBusiness(name) {
      if (confirm(`–£–¥–∞–ª–∏—Ç—å –±–∏–∑–Ω–µ—Å "${name}"?`)) {
        delete locationsData[name];
        buildLocationsTree();
      }
    }
    function updateType(b, oldName, newName) {
      if (newName && newName !== oldName) {
        locationsData[b][newName] = locationsData[b][oldName];
        delete locationsData[b][oldName];
        buildLocationsTree();
      }
    }
    function addTypeToBusiness(b) {
      const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–ø–∞:");
      if (name) {
        locationsData[b][name] = { "–ù–æ–≤—ã–π –≥–æ—Ä–æ–¥": [] };
        buildLocationsTree();
      }
    }
    function removeType(b, t) {
      delete locationsData[b][t];
      buildLocationsTree();
    }
    function updateCity(b, t, oldName, newName) {
      if (newName && newName !== oldName) {
        locationsData[b][t][newName] = locationsData[b][t][oldName];
        delete locationsData[b][t][oldName];
        buildLocationsTree();
      }
    }
    function addCityToType(b, t) {
      const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞:");
      if (name) {
        locationsData[b][t][name] = [];
        buildLocationsTree();
      }
    }
    function removeCity(b, t, c) {
      delete locationsData[b][t][c];
      buildLocationsTree();
    }
    function updateLocation(b, t, c, oldName, newName) {
      const idx = locationsData[b][t][c].indexOf(oldName);
      if (idx !== -1) {
        locationsData[b][t][c][idx] = newName;
        buildLocationsTree();
      }
    }
    function addLocation(b, t, c) {
      const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏:");
      if (name) {
        locationsData[b][t][c].push(name);
        buildLocationsTree();
      }
    }
    function removeLocation(b, t, c, loc) {
      const idx = locationsData[b][t][c].indexOf(loc);
      if (idx !== -1) {
        locationsData[b][t][c].splice(idx, 1);
        buildLocationsTree();
      }
    }

    // === –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π ===
    function addCategory() {
      const container = document.getElementById('categoriesList');
      const div = document.createElement('div');
      div.className = 'input-group mb-2';
      div.innerHTML = `
        <input type="text" class="form-control" placeholder="–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è">
        <button class="btn btn-outline-danger" onclick="removeCategory(this)">–£–¥–∞–ª–∏—Ç—å</button>
      `;
      container.appendChild(div);
    }

    function removeCategory(btn) {
      btn.parentElement.remove();
    }

    // === –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ ===
    function saveSettings() {
  const hours = document.getElementById('autoCloseHours').value;
  const categories = Array.from(document.querySelectorAll('#categoriesList input')).map(inp => inp.value).filter(v => v);
  const statuses = Array.from(document.querySelectorAll('#statusesList input')).map(inp => inp.value).filter(v => v);

  fetch('/settings', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      auto_close_hours: parseInt(hours),
      categories: categories,
      client_statuses: statuses,  // ‚Üê –î–æ–±–∞–≤–ª–µ–Ω–æ!
      locations: locationsData
    })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      alert('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
    } else {
      alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    }
  })
  .catch(err => {
    alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message);
  });
}

    // === –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ===
    document.addEventListener('DOMContentLoaded', () => {
      buildLocationsTree();
      loadUsers();
    });
  </script>
</body>
</html>