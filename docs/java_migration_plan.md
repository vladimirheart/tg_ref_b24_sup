# План миграции проекта с Python на Java с кроссплатформенной поддержкой

## Краткий обзор текущего Python-решения
- **Telegram-бот**: библиотека `python-telegram-bot`, множественные фильтры вложений, управление очередями сообщений, фоновые задачи через APScheduler, смешанный доступ к БД (SQLAlchemy + сырой `sqlite3`).
- **Веб-панель**: монолит на Flask, ручное управление сессиями, загрузка и выдача вложений, кэширование аватаров, фоновые планировщики, опора на локальные `tickets.db` / `users.db`.
- **Конфигурации и данные**: JSON-файлы (`settings.json`, `locations.json`, `org_structure.json`) и `.env`; вложения хранятся на локальном диске.

## Требования к целевой Java-архитектуре
1. **Кроссплатформенность (Windows + Linux/Debian)**
   - Использовать контейнеризацию (Docker + multi-stage образы) либо унифицированные Gradle/Maven скрипты без POSIX-зависимостей.
   - Отказ от symlink- и `chmod`-специфичных операций; файловые пути через `java.nio.file.Path` с `Files.createDirectories`.
   - Настроить CI для двух OS (например, GitHub Actions `windows-latest` + `ubuntu-latest`).

2. **Telegram-бот**
   - Библиотека [TelegramBots Java](https://github.com/rubenlagus/TelegramBots) или Spring Boot Starter for Telegram.
   - Реализация конечного автомата диалогов (аналог ConversationHandler) с поддержкой фото, видео, документов, голосовых.
   - Фоновые задачи: Spring Scheduler/Quartz (работают одинаково на Windows и Linux).

3. **Веб-панель**
   - Spring Boot (MVC/REST), Spring Security, шаблоны Thymeleaf или SPA-клиент.
   - Поддержка загрузки файлов через `MultipartFile`, хранение вложений через абстракцию (локальный диск/облако).
   - Кроссплатформенные пути: использовать `Path`/`Resource`, исключить прямые `/tmp` и `\`.

4. **Слой данных**
   - JPA/Hibernate + Flyway/Liquibase.
   - PostgreSQL в качестве основной СУБД, SQLite допускается временно через JDBC (совместимо с Windows/Linux).
   - Подготовить скрипты миграции данных из существующих `.db` файлов.

5. **Конфигурация и секреты**
   - Spring `application.yml` + профили, поддержка `.env` через `spring-dotenv` или `docker compose`.
   - Секреты: использование переменных окружения, совместимых с обоими ОС.

## Этапы миграции
### 1. Портирование логики Telegram-бота
1. Описать текущие сценарии (бот, фильтры, проверки чёрного списка, запросы на разблокировку).
2. Развернуть Java-проект (Gradle/Maven), настроить CI сборку для Windows и Linux.
3. Перенести обработку вложений и сохранение файлов (директории `attachments`, `knowledge_base`).
4. Реализовать JPA-сущности `client_blacklist`, `client_unblock_requests`, фоновые задачи.

### 2. Переписывание панели управления
1. Сформировать карту эндпоинтов Flask (рендеринг страниц, API, загрузка файлов).
2. Настроить Spring Boot: MVC/REST, Security, хранение сессий (Spring Session + JDBC/Redis).
3. Конвертировать шаблоны или разработать SPA; обеспечить кроссплатформенность сборки фронтенда (npm scripts без bash-специфики).
4. Инкапсулировать работу с файлами через сервис, абстрагирующий путь и права доступа.

### 3. Унификация слоя данных
1. Экспортировать схемы `tickets.db`, `users.db` и вспомогательных таблиц.
2. Создать ER-диаграмму и JPA-сущности, покрывающие весь набор таблиц.
3. Написать миграции Flyway/Liquibase, предусмотреть сценарии запуска на Windows (PowerShell) и Linux (Bash).
4. Переписать бизнес-логику на сервисы/репозитории Spring с транзакциями.

### 4. Перенос конфигураций и бизнес-утилит
1. Сконвертировать JSON-настройки в DTO + загрузку через Jackson (`ResourceLoader`).
2. Реализовать сервис пресетов/рейтинга, доступный боту и панели (Spring Boot multi-module).
3. Настроить централизованное управление секретами (Docker secrets, HashiCorp Vault, Kubernetes Secrets).

### 5. Инфраструктура и деплой
- **Windows**: Gradle Wrapper (`gradlew.bat`) / Maven Wrapper (`mvnw.cmd`), Docker Desktop, PowerShell-скрипты.
- **Linux/Debian**: `gradlew`, `mvnw`, systemd services или Docker Compose.
- Обеспечить хранение вложений: S3/MinIO или общий NFS; предусмотреть локальные пути через конфигурацию.
- Настроить мониторинг и логирование (Spring Boot Actuator, Prometheus-compatible metrics).

## Контроль качества
- Автотесты (unit + интеграционные) под двумя ОС в CI.
- Регрессионные тесты диалогов бота (запись сценариев) и UI тесты панели (Selenium/Selenide).
- Проверка миграции данных на тестовой БД, сравнение с исходными SQLite.

## Рекомендации по постепенному переходу
1. Запустить Java-сервисы в параллели с Python, используя общую БД PostgreSQL.
2. Сначала перевести бота, затем панель, минимизируя простой.
3. Организовать кат-off дата: freeze Python, проводить регрессии, переключение DNS/вебхуков после успешного тестирования Java-версии.
