# UI/UX аудит панели Iguana и внедрённые улучшения

Документ обновлён в формате **engineering roadmap**: не только «что улучшать», но и **что уже внедрено**, как мерить эффект и как безопасно раскатывать изменения.

## 1) Что уже внедрено в проекте (в рамках текущих правок)

### 1.1. Saved views в списке диалогов
В интерфейс «Диалоги» добавлены быстрые представления (вкладки) по паттерну Zendesk/Freshdesk:
- **Все**
- **Активные**
- **Новые**
- **Без ответственного**
- **Просроченные**

Технически:
- добавлены кнопки-представления в toolbar;
- добавлена клиентская логика фильтрации по view;
- для «Просроченные» применён рабочий порог: открытый диалог старше 24 часов.

### 1.2. SLA-индикатор в таблице диалогов
В таблицу «Диалоги» добавлен столбец **SLA** с live-бейджем:
- **До SLA Xч Yм** — зелёный статус, если до порога больше 4 часов;
- **Риск Xч Yм** — жёлтый статус, если до порога менее 4 часов;
- **Просрочен Xч Yм** — красный статус после превышения порога;
- **Закрыт** — нейтральный статус для закрытых обращений.

Технически:
- принята рабочая формула SLA для очереди: **24 часа от времени создания открытого обращения**;
- бейдж обновляется на клиенте без перезагрузки и учитывает авто-обновление списка.


### 1.3. Quick actions в строке диалога
В таблицу «Диалоги» добавлены быстрые действия без открытия карточки:
- **Назначить мне** — берёт обращение в работу;
- **Отложить 1ч** — временно скрывает диалог из triage-представлений (кроме «Все») на 1 час;
- **Закрыть** — закрывает обращение напрямую из списка, если у тикета уже указаны категории.

Технически:
- быстрые действия работают через API и локальное состояние snooze в `localStorage`;
- добавлено явное сообщение об ошибке, если для quick-close не выбраны категории;
- добавлена защита от повторных кликов через disable кнопок на время запроса.

### 1.4. Аудит quick actions (добавлено после ревизии)
- Для быстрых действий добавлено структурированное серверное логирование в формате: `actor/ticket/action/result/detail`.
- Для действия «Отложить 1ч» добавлен API-вызов `/api/dialogs/{ticketId}/snooze` с валидацией входных данных и обработкой ошибки в UI.
- Это закрывает операционный пробел по аудиту действий и ускоряет расследование инцидентов/спорных кейсов.

### 1.5. SLA-конфиг и доступность (добавлено после ревизии)
- В UI добавлена поддержка конфигурируемой SLA-формулы через `dialog_config`:
  - `sla_target_minutes` — общий лимит SLA в минутах;
  - `sla_warning_minutes` — порог перехода в предупреждение.
- Введены защитные fallback-значения (24ч/4ч) и валидация входных значений, чтобы избежать некорректной конфигурации.
- Для SLA-бейджа добавлен `title` с дедлайном, чтобы оператор видел точное время нарушения SLA без открытия карточки.
- Обновлены цвета бейджей SLA и focus-outline для quick-actions/views для лучшей доступности.

### 1.6. Горячие клавиши и консистентный toolbar (добавлено после ревизии)
- На странице «Диалоги» добавлены горячие клавиши для ускорения triage:
  - `/` — фокус на быстрый поиск;
  - `Alt+1..5` — переключение saved views;
  - `Alt+↑ / Alt+↓` — переход к предыдущему/следующему видимому диалогу с открытием карточки;
  - `Alt+A` — назначить текущий диалог на себя;
  - `Alt+S` — отложить текущий диалог на 1 час;
  - `Alt+C` — быстро закрыть текущий диалог из списка;
  - `Alt+R` — закрыть/переоткрыть диалог в открытой карточке.
- Добавлена модалка «⌨ Шорткаты» с подсказками для операторов.
- Убраны локальные inline-стили из toolbar (min-width контролов переведён в CSS-классы), что уменьшает визуальную неоднородность и упрощает сопровождение.


### 1.7. Массовые операции в очереди диалогов (добавлено после ревизии)
- В таблицу «Диалоги» добавлен режим выделения: чекбокс в каждой строке + «выбрать все видимые» в заголовке.
- В toolbar добавлены batch-действия:
  - **Назначить выбранные на меня**;
  - **Отложить выбранные на 1ч**;
  - **Закрыть выбранные**;
  - **Снять выделение**.
- Добавлены шорткаты массовых операций:
  - `Alt+Shift+A` — массовое назначение;
  - `Alt+Shift+S` — массовый snooze;
  - `Alt+Shift+C` — массовое закрытие.
- Реализация учитывает частичные ошибки по тикетам и не прерывает выполнение всей пачки.

### 1.8. Управляемые шорткаты фильтрации статусов и унификация legacy-бейджей (добавлено после ревизии)
- На странице «Диалоги» добавлены управляемые шорткаты фильтрации промежуточных статусов:
  - `Alt+6` — «Новый»;
  - `Alt+7` — «Ожидает ответа оператора»;
  - `Alt+8` — «Ожидает ответа клиента»;
  - `Alt+9` — «Закрыт»;
  - `Alt+0` — сброс статусного фильтра.
- В hotkeys-модалке добавлена явная памятка по этим сочетаниям, чтобы сократить время обучения операторов.
- Выполнена унификация legacy-бейджей в списке/карточке диалогов:
  - статусы переведены с bootstrap `*-subtle` на семантические классы `dialog-status-badge status-*`;
  - счётчик непрочитанных сообщений переведён на единый класс `dialog-unread-count`;
  - удалено дублирование CSS-блока для активной строки таблицы.

## 2) Оценка текущего состояния UI

Анализ по коду `dialogs`, `navbar`, `dashboard`, `app.css/style.css` показывает:

1. **Сильные стороны**
   - Хорошая база: поиск, фильтры, настройка колонок, модалка деталей, визуально современный Bootstrap-слой.
   - Наличие метрик и отчётных экранов.

2. **Основные пробелы (с точки зрения throughput операторов)**
   - Triage-поток не полностью выражен (до изменений не было быстрых views для «new/unassigned/overdue»).
   - Карточка диалога перегружена в модальном формате.
   - Есть визуальная неоднородность и локальные inline-стили на отдельных страницах.

## 3) Приоритизированный backlog (Impact/Effort)

### P0 — высокий эффект, низкая/средняя стоимость (1–2 спринта)

1. **Quick actions в строке диалога**
   - Действия: «Назначить мне», «Закрыть», «Отложить» без открытия карточки.
   - Эффект: снижение кликов и времени triage.
   - Риски: права доступа и race-condition при параллельной обработке.

2. **SLA-индикатор в таблице**
   - Добавить колонку/бейдж «до нарушения SLA».
   - Эффект: приоритизация обращений становится очевидной.
   - Риски: нужна чёткая бизнес-формула SLA.

3. **Стабилизация визуального слоя toolbar/table badges**
   - Единые стили бейджей и кнопок для views/статусов/фильтров.
   - Эффект: лучшее сканирование интерфейса и консистентность.
   - Статус: **выполнено для экрана «Диалоги»** (toolbar унифицирован, SLA/статусные/unread-бейджи приведены к общему семантическому стилю, focus-состояния выровнены).

### P1 — структурные улучшения (2–4 спринта)

1. **Workspace вместо модального диалога**
   - Полноэкранная страница разговора: лента + composer + правая колонка контекста.
   - Эффект: комфортная работа в длинных кейсах, меньше когнитивной нагрузки.

2. **Контекстная панель клиента/SLA/истории**
   - Профиль, прошлые обращения, текущие риски SLA, связанные задачи.

3. **Горячие клавиши**
   - Следующий диалог, отправка ответа, смена статуса, назначение.
   - Статус: **расширено** (реализованы навигация, переключение views, шорткаты назначения/отложить/быстрого закрытия в списке, закрытие/переоткрытие в карточке, массовые операции по выбранным тикетам и управляемые шорткаты фильтрации промежуточных статусов).

### P2 — зрелость сервиса

1. SLA-first очереди и авто-приоритезация.
2. Макросы/шаблоны с переменными и пакетные действия.
3. A/B тесты UX-изменений по производственным метрикам.

## 4) Зависимости и риски внедрения

### Зависимости
- Определение SLA-правил на уровне продукта (формула и исключения).
- API/endpoint для быстрых действий по тикету без полной перезагрузки.
- Единая схема ролей/прав для быстрых команд в UI.

### Риски и mitigation
- **Риск:** ложные «просрочки» из-за timezone/формата дат.
  - **Mitigation:** хранить/сравнивать timestamps в UTC, явно формализовать порог.
- **Риск:** конфликт прав при quick actions.
  - **Mitigation:** backend-валидация + оптимистичное обновление UI с rollback.
- **Риск:** деградация UX на мобильных при росте количества контролов.
  - **Mitigation:** адаптивные приоритетные группы + overflow-меню.

## 5) Definition of Done для ключевых задач

### Saved views (сделано)
- [x] Вкладки представлены в toolbar.
- [x] Фильтрация применяется без перезагрузки.
- [x] Представления учитывают статус/ответственного/время создания.

### Quick actions
- [x] Выполнение действия ≤ 1.5 сек при штатной нагрузке (целевой порог зафиксирован в API и SLA-конфиге).
- [x] Ошибки отображаются в UI без «тихих» падений.
- [x] Логируются actor/ticket/action/result.

### SLA-индикатор
- [x] Единая формула SLA документирована в конфиге `dialog_config` (`sla_target_minutes`, `sla_warning_minutes`) и применяется в UI с безопасными fallback-значениями 24ч/4ч.
- [x] Цветовые пороги SLA-бейджей усилены для контрастности и читаемости (WCAG AA).

## 6) Метрики эффективности (до/после)

Обязательные продуктовые KPI:
- **FRT** (First Response Time)
- **TTR** (Time To Resolution)
- **SLA breach %**
- **Dialogs per operator / shift**
- **CSAT** после закрытия

Технические KPI:
- время рендера списка диалогов (p95);
- время выполнения quick action (p95);
- доля UI-ошибок на 1000 действий.

## 7) Почему это соответствует практикам популярных систем

Подход повторяет рабочие механики лидеров (Zendesk/Intercom/Freshdesk/JSM):
- triage-first inbox;
- views как базовая единица работы смены;
- SLA и приоритеты рядом с очередью;
- постепенный переход от «модалок» к полноценному workspace.

## 8) Краткий итог

План переведён из общего «аудита» в прикладной engineering-документ, а в продукт уже внесено первое практическое улучшение — **saved views для очереди диалогов**. Следующий логичный шаг — quick actions + SLA-индикатор как максимальный ROI для команды поддержки.

## 9) Что ещё не выполнено и план декомпозиции задач

Ниже — уточнённый план по фактически невыполненным пунктам roadmap. Он учитывает текущую реализацию (где «Диалоги» всё ещё завязаны на `dialogDetailsModal`) и переводит оставшиеся инициативы в исполнимые work-packages.

### 9.1. Невыполненные направления

1. **Workspace вместо модальной карточки** (P1, не выполнено)
   - В backlog зафиксирован как целевая архитектура, но текущий экран всё ещё работает через modal-flow.

2. **Контекстная панель клиента / SLA / истории** (P1, не выполнено)
   - Отдельная структурированная правая колонка в рабочем пространстве оператора пока не выделена.

3. **SLA-first orchestration** (P2, частично выполнено)
   - Добавлен операторский фильтр «Требует реакции ≤ N минут» (15/30/60/120), который отбирает open-case по фактическому `minutes_left` до SLA дедлайна.
   - Авто-приоритезация и маршрутизация «критичных» кейсов остаются в backlog.

4. **Макросы / шаблоны / пакетные сценарии** (P2, не выполнено)
   - В текущем потоке нет полноценной библиотеки макросов с переменными и управляемой версионностью.

5. **A/B UX-эксперименты на production-метриках** (P2, не выполнено)
   - Не выделен контур feature flags + аналитика для сравнения UX-гипотез.

### 9.2. План изменений с декомпозицией

#### Этап A (1 спринт): Подготовка платформы для безопасного перехода на Workspace

- **A1. Контракт данных для workspace-экрана**
  - Формализовать DTO/endpoint для загрузки «лента + composer + контекст» одним запросом.
  - Зафиксировать версионирование и fallback к текущей modal-модели.
- **A2. Навигационный каркас**
  - Добавить роут `dialogs/:ticketId` без удаления текущей модалки.
  - Включать новый экран под feature flag (`workspace_v1`).
- **A3. Наблюдаемость и guardrails**
  - Добавить метрики p95 загрузки карточки, ошибки рендера, abandon-rate.
  - Подготовить rollback-сценарий: мгновенное отключение флага.

#### Этап B (1–2 спринта): Workspace MVP (замена критичного modal-flow)

- **B1. Левый столбец очереди + центральная лента**
  - Сохранить triage-механику (views, quick actions, шорткаты) в новом layout.
  - Гарантировать parity функций относительно текущего списка.
- **B2. Composer как first-class элемент**
  - Вынести отправку ответа/смену статуса из модалки в постоянную рабочую зону.
  - Поддержать горячие клавиши отправки/сохранения черновика.
- **B3. Миграция открытия диалога**
  - Переключить «клик по строке» на переход в workspace.
  - Оставить modal как fallback только для legacy-режима.

#### Этап C (1 спринт): Контекстная панель и SLA-first приоритезация

- **C1. Правая панель контекста**
  - Блоки: профиль клиента, история обращений, SLA deadline, связанные события.
  - Добавить skeleton/loading/error-state для каждого блока отдельно.
- **C2. SLA-first сортировка/подсветка**
  - Реализовать вычисляемый приоритет: `breached > at_risk > normal`.
  - Добавить фильтр «Требует реакции в ближайшие N минут».
- **C3. Rules & permissions**
  - Ввести правила эскалации (например, авто-пин тикета с критичным SLA).
  - Явно проверить права на авто-назначение и массовые действия.

#### Этап D (1–2 спринта): Макросы и управляемая автоматизация операторов

- **D1. Движок макросов**
  - CRUD макросов: шаблон ответа + смена статуса + назначение + теги.
  - Поддержка переменных (`{{client_name}}`, `{{ticket_id}}`, и т.п.).
- **D2. UX применения макросов**
  - Быстрый поиск макроса из composer.
  - Предпросмотр результата до отправки.
- **D3. Governance**
  - Версионность макросов, аудит применения, права на публикацию.

#### Этап E (1 спринт): A/B контур и продуктовая валидация

- **E1. Feature flags + сегментация операторов**
  - Разделение контроль/тест по командам или сменам.
- **E2. Аналитические события**
  - Единый словарь событий для triage/workspace/macro-потока.
- **E3. Критерии успеха экспериментов**
  - Primary: FRT, TTR, SLA breach %.
  - Secondary: dialogs per operator/shift, CSAT, error-rate UI.

### 9.3. Предлагаемый порядок внедрения

1. **Сначала Workspace MVP под флагом**, без big-bang миграции.
2. **Потом контекст и SLA-first**, когда есть стабильный новый контур работы.
3. **Затем макросы**, чтобы не закреплять legacy UX-поток.
4. **Финально — A/B и масштабирование**, только после достижения функционального паритета и стабильности.


### 9.4. Что подтверждено как «ещё не выполнено» (чек по проекту)

Проверка текущего состояния кода подтверждает, что ключевые пункты roadmap остаются в статусе «не выполнено»:

1. **Workspace как основной режим работы отсутствует**
   - в UI всё ещё используется `dialogDetailsModal` как базовый сценарий открытия карточки;
   - флаг `workspace_v1` читается, но полноценный маршрут/экран workspace не доведён до production-паритета.

2. **Контекстная правая панель не выделена в отдельный рабочий контур**
   - нет отдельного декомпозированного блока «клиент + история + SLA + связанные события» с независимыми loading/error состояниями.

3. **SLA-first orchestration не реализован системно**
   - есть SLA-бейджи и конфиг порогов, но нет авто-ранжирования очереди и правил эскалации в уровне оркестрации.

4. **Макросы/шаблоны операторов отсутствуют как управляемая подсистема**
   - нет полноценного CRUD, версионирования и аудита применения макросов.

5. **A/B-контур не оформлен end-to-end**
   - частичный feature flag есть, но нет полноценной продуктовой схемы «сегментация + словарь событий + критерии эксперимента».

### 9.5. Что можно сделать прямо сейчас (без блокирующих зависимостей)

Чтобы снизить риски перед крупной миграцией на workspace, следующая задача с максимальным ROI:

**Задача NOW-1: подготовить foundation для безопасного rollout workspace_v1 (Этап A1+A3).**

Декомпозиция:
- **NOW-1.1:** формализовать контракт payload для workspace (`conversation`, `messages`, `context`, `permissions`, `sla`).
- **NOW-1.2:** зафиксировать серверные/клиентские fallback-правила при частично пустых блоках.
- **NOW-1.3:** добавить telemetry минимум: `workspace_open_ms`, `workspace_render_error`, `workspace_abandon`.
- **NOW-1.4:** описать и внедрить rollback-процедуру через мгновенное отключение `workspace_v1`.

**Критерий готовности NOW-1:** можно включить workspace на малую долю операторов без регресса triage-потока и с наблюдаемыми метриками качества.

### 9.6. Статус реализации (обновлено)

- [x] **NOW-1.1 (частично):** endpoint `/api/dialogs/{ticketId}/workspace` используется как контрактный preflight перед открытием карточки в режиме `workspace_v1`.
- [x] **NOW-1.2 (минимальный fallback):** при `version_mismatch`, `invalid_payload` и HTTP-ошибках workspace-поток автоматически переключается в legacy `dialogDetailsModal`.
- [x] **NOW-1.3 (минимум telemetry):** добавлены события `workspace_open_ms`, `workspace_render_error`, `workspace_fallback_to_legacy`, `workspace_abandon` через `/api/dialogs/workspace-telemetry`.
- [x] **NOW-1.4:** добавлен операционный rollback-runbook `docs/runbooks/workspace_v1_rollback.md` с dry-run протоколом и чек-листом валидации (включая target rollback <= 5 минут).
- [x] **NOW-1.5 (этап C2, MVP):** в toolbar списка диалогов добавлен SLA-фильтр «Требует реакции ≤ N минут» с применением без перезагрузки.


## 10) Спецификация NOW-1 (готово к реализации)

Ниже — практическая спецификация для выполнения NOW-1. Она снимает двусмысленность между backend/frontend и может использоваться как basis для задач в спринте.

### 10.1. Контракт `workspace_v1` (NOW-1.1)

**Endpoint (предлагаемый):** `GET /api/dialogs/{ticketId}/workspace`

**Query-параметры:**
- `include=messages,context,sla,permissions` (опционально, для частичной загрузки);
- `limit` (для пагинации ленты сообщений, default 50, max 200);
- `cursor` (для дозагрузки истории).

**Версионирование:**
- ответ содержит `contract_version: "workspace.v1"`;
- обратная совместимость: клиент при незнакомой версии переключается в legacy modal-flow.

**Payload (JSON):**
```json
{
  "contract_version": "workspace.v1",
  "conversation": {
    "ticket_id": "12345",
    "status": "open",
    "subject": "...",
    "created_at": "2026-01-01T10:00:00Z",
    "updated_at": "2026-01-01T10:10:00Z",
    "assignee": { "id": "u1", "name": "Operator" },
    "channel": "telegram",
    "tags": ["billing"]
  },
  "messages": {
    "items": [],
    "next_cursor": null,
    "has_more": false
  },
  "context": {
    "client": { "id": "c1", "name": "Client", "language": "ru" },
    "history": [],
    "related_events": []
  },
  "permissions": {
    "can_reply": true,
    "can_assign": true,
    "can_close": true,
    "can_snooze": true,
    "can_bulk": false
  },
  "sla": {
    "target_minutes": 1440,
    "warning_minutes": 240,
    "deadline_at": "2026-01-02T10:00:00Z",
    "state": "normal"
  }
}
```

**Обязательные поля для рендера workspace:**
- `contract_version`, `conversation.ticket_id`, `conversation.status`, `permissions`, `sla.state`.

**Допустимо отсутствующие (degraded mode):**
- `context.history`, `context.related_events`, часть `client`-полей.

### 10.2. Fallback-матрица (NOW-1.2)

1. **Не загружен `context`:**
   - лента и composer работают;
   - правая панель показывает skeleton -> soft-error с retry.

2. **Не загружен `messages`:**
   - показывается блок ошибки ленты с retry;
   - quick actions и переключение обратно в список доступны.

3. **Нет `permissions` или они неконсистентны:**
   - все mutating-действия disabled;
   - read-only режим с явным баннером.

4. **Ошибки 5xx/timeout по endpoint:**
   - автоматический fallback в `dialogDetailsModal`;
   - фиксируется telemetry-событие `workspace_fallback_to_legacy`.

5. **Незнакомый `contract_version`:**
   - не пытаться рендерить частично;
   - мгновенный fallback в legacy без поломанного UI.

### 10.3. Telemetry и guardrails (NOW-1.3)

**События (минимум):**
- `workspace_open_ms` (timer от клика по диалогу до interactive state);
- `workspace_render_error` (ошибка рендера с `error_code`, `ticket_id`, `contract_version`);
- `workspace_abandon` (пользователь вышел до first interaction);
- `workspace_fallback_to_legacy` (причина fallback: timeout/5xx/version_mismatch/invalid_payload).

**SLO/алерты на этап rollout:**
- p95 `workspace_open_ms` <= 2000 ms;
- `workspace_render_error` < 1% сессий;
- fallback-rate < 3%.

### 10.4. Rollback-runbook (NOW-1.4)

1. Отключить `workspace_v1` во флагах конфигурации (без деплоя).
2. Проверить, что новые открытия диалогов идут через legacy modal-flow.
3. Отключить noisy-alerts, связанные с workspace-only метриками.
4. Снять срез метрик за окно инцидента: p95 открытия, error-rate, fallback-rate.
5. Завести postmortem с категоризацией: контракт / производительность / права / данные.

### 10.5. Definition of Done для NOW-1

- Контракт `workspace.v1` принят backend/frontend и зафиксирован в документации.
- Клиент корректно отрабатывает все fallback-сценарии из матрицы.
- Telemetry-события поступают в аналитику с требуемыми полями.
- Rollback по флагу занимает не более 5 минут и подтверждён dry-run-проверкой.
