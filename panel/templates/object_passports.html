<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü–∞—Å–ø–æ—Ä—Ç –æ–±—ä–µ–∫—Ç–æ–≤</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='sidebar.css') }}" rel="stylesheet" />
  <style>
    .filters-card label { font-weight: 600; font-size: 0.85rem; }
    .filters-card .form-control, .filters-card .form-select { font-size: 0.9rem; }
    #passportsTable tbody tr { cursor: pointer; transition: background-color 0.15s ease-in-out; }
    #passportsTable tbody tr:hover { background-color: rgba(13, 110, 253, 0.1); }
    .table-responsive { overflow-x: auto; }
    .status-badge { font-size: 0.8rem; }
  </style>
</head>
<body class="with-sidebar sidebar-pinned">
  {% include "_sidebar.html" %}
  <main class="main-content container-fluid">
    <div class="container-fluid mt-4">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
          <h2 class="mb-0">üìò –ü–∞—Å–ø–æ—Ä—Ç –æ–±—ä–µ–∫—Ç–æ–≤</h2>
          <p class="text-muted mb-0">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Å–ø–æ—Ä—Ç–∞–º–∏ –ª–æ–∫–∞—Ü–∏–π, –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ —Ä–∞–±–æ—Ç—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.</p>
        </div>
        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-outline-secondary" id="exportBtn" type="button">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
          <a class="btn btn-primary" href="/object_passports/new" target="_blank" rel="noopener">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–∞—Å–ø–æ—Ä—Ç</a>
        </div>
      </div>

      <div class="card mt-4 filters-card">
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-md-4 col-lg-3">
              <label for="searchInput" class="form-label">–ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –∫–æ–ª–æ–Ω–∫–∞–º</label>
              <input type="text" id="searchInput" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞" />
            </div>
            <div class="col-md-3 col-lg-2">
              <label for="filterBusiness" class="form-label">–ë–∏–∑–Ω–µ—Å</label>
              <select id="filterBusiness" class="form-select">
                <option value="">–í—Å–µ</option>
                {% for value in parameter_values.get('business', []) %}
                <option value="{{ value }}">{{ value }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3 col-lg-2">
              <label for="filterPartnerType" class="form-label">–¢–∏–ø –ø–∞—Ä—Ç–Ω—ë—Ä–∞</label>
              <select id="filterPartnerType" class="form-select">
                <option value="">–í—Å–µ</option>
                {% for value in parameter_values.get('partner_type', []) %}
                <option value="{{ value }}">{{ value }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3 col-lg-2">
              <label for="filterCountry" class="form-label">–°—Ç—Ä–∞–Ω–∞</label>
              <select id="filterCountry" class="form-select">
                <option value="">–í—Å–µ</option>
                {% for value in parameter_values.get('country', []) %}
                <option value="{{ value }}">{{ value }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3 col-lg-2">
              <label for="filterLegalEntity" class="form-label">–Æ–õ</label>
              <select id="filterLegalEntity" class="form-select">
                <option value="">–í—Å–µ</option>
                {% for value in parameter_values.get('legal_entity', []) %}
                <option value="{{ value }}">{{ value }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3 col-lg-2">
              <label for="filterCity" class="form-label">–ì–æ—Ä–æ–¥</label>
              <select id="filterCity" class="form-select">
                <option value="">–í—Å–µ</option>
                {% for value in cities %}
                <option value="{{ value }}">{{ value }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3 col-lg-2">
              <label for="filterDepartment" class="form-label">–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</label>
              <select id="filterDepartment" class="form-select">
                <option value="">–í—Å–µ</option>
                {% for value in parameter_values.get('department', []) %}
                <option value="{{ value }}">{{ value }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3 col-lg-2">
              <label for="filterStatus" class="form-label">–°—Ç–∞—Ç—É—Å</label>
              <select id="filterStatus" class="form-select">
                <option value="">–í—Å–µ</option>
                {% for value in statuses %}
                <option value="{{ value }}">{{ value }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-between align-items-center mt-3">
        <span class="text-muted">–ù–∞–π–¥–µ–Ω–æ: <strong id="resultsCount">0</strong></span>
      </div>

      <div class="table-responsive mt-2">
        <table class="table table-hover align-middle" id="passportsTable">
          <thead class="table-dark">
            <tr>
              <th scope="col">–ë–∏–∑–Ω–µ—Å</th>
              <th scope="col">–¢–∏–ø –ø–∞—Ä—Ç–Ω—ë—Ä–∞</th>
              <th scope="col">–°—Ç—Ä–∞–Ω–∞</th>
              <th scope="col">–Æ–õ</th>
              <th scope="col">–ì–æ—Ä–æ–¥</th>
              <th scope="col">–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</th>
              <th scope="col">–û–±—â–µ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</th>
              <th scope="col">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="alert alert-info mt-3 d-none" id="emptyState">
        –ü–æ –∑–∞–¥–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –∑–∞–ø—Ä–æ—Å.
      </div>
    </div>
  </main>

  <script>
    const filters = {
      search: document.getElementById('searchInput'),
      business: document.getElementById('filterBusiness'),
      partnerType: document.getElementById('filterPartnerType'),
      country: document.getElementById('filterCountry'),
      legalEntity: document.getElementById('filterLegalEntity'),
      city: document.getElementById('filterCity'),
      department: document.getElementById('filterDepartment'),
      status: document.getElementById('filterStatus'),
    };

    const resultsCountEl = document.getElementById('resultsCount');
    const tableBody = document.querySelector('#passportsTable tbody');
    const emptyState = document.getElementById('emptyState');

    function escapeHtml(value) {
      if (value === null || value === undefined) return '';
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function buildParams() {
      const params = new URLSearchParams();
      const searchValue = filters.search.value.trim();
      if (searchValue) params.set('search', searchValue);
      const mapping = [
        ['business', filters.business.value],
        ['partner_type', filters.partnerType.value],
        ['country', filters.country.value],
        ['legal_entity', filters.legalEntity.value],
        ['city', filters.city.value],
        ['department', filters.department.value],
        ['status', filters.status.value],
      ];
      mapping.forEach(([key, value]) => {
        const trimmed = (value || '').trim();
        if (trimmed) params.set(key, trimmed);
      });
      return params;
    }

    async function loadPassports() {
      const params = buildParams();
      const query = params.toString();
      const url = query ? `/api/object_passports?${query}` : '/api/object_passports';
      tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span></div></td></tr>';
      emptyState.classList.add('d-none');
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        const data = await response.json();
        const items = Array.isArray(data.items) ? data.items : [];
        renderTable(items);
      } catch (error) {
        console.error(error);
        tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger py-4">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</td></tr>';
        resultsCountEl.textContent = '0';
      }
    }

    function renderTable(items) {
      tableBody.innerHTML = '';
      resultsCountEl.textContent = items.length;
      if (!items.length) {
        emptyState.classList.remove('d-none');
        return;
      }
      emptyState.classList.add('d-none');
      items.forEach((item) => {
        const tr = document.createElement('tr');
        tr.dataset.id = item.id;
        tr.innerHTML = `
          <td>${escapeHtml(item.business)}</td>
          <td>${escapeHtml(item.partner_type)}</td>
          <td>${escapeHtml(item.country)}</td>
          <td>${escapeHtml(item.legal_entity)}</td>
          <td>${escapeHtml(item.city)}</td>
          <td>${escapeHtml(item.department)}</td>
          <td>${escapeHtml(item.total_work_time)}</td>
          <td>${escapeHtml(item.schedule_display)}</td>
        `;
        tr.addEventListener('click', () => {
          if (item.id) {
            window.open(`/object_passports/${item.id}`, '_blank');
          }
        });
        tableBody.appendChild(tr);
      });
    }

    let searchTimeout;
    filters.search.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(loadPassports, 300);
    });

    [filters.business, filters.partnerType, filters.country, filters.legalEntity, filters.city, filters.department, filters.status].forEach((select) => {
      select.addEventListener('change', loadPassports);
    });

    document.getElementById('exportBtn').addEventListener('click', () => {
      const params = buildParams();
      const query = params.toString();
      const url = query ? `/object_passports/export?${query}` : '/object_passports/export';
      window.location.href = url;
    });

    loadPassports();
  </script>
  <script src="{{ url_for('static', filename='sidebar.js') }}"></script>
</body>
</html>
