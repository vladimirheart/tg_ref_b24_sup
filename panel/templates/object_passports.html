<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü–∞—Å–ø–æ—Ä—Ç –æ–±—ä–µ–∫—Ç–æ–≤</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='sidebar.css') }}" rel="stylesheet" />
  <style>
    .filters-card label { font-weight: 600; font-size: 0.85rem; }
    .filters-card .form-control,
    .filters-card .form-select {
      font-size: 0.9rem;
    }
    #passportsTable tbody tr {
      cursor: pointer;
      transition: background-color 0.15s ease-in-out;
    }
    #passportsTable tbody tr:hover {
      background-color: rgba(13, 110, 253, 0.1);
    }
    .table-responsive {
      overflow-x: auto;
    }
    .status-badge {
      font-size: 0.8rem;
    }
    .sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    .sortable::after {
      content: " \2195";
      font-size: 0.8em;
      opacity: 0.5;
    }
    .sort-asc::after {
      content: " \2191";
      opacity: 1;
    }
    .sort-desc::after {
      content: " \2193";
      opacity: 1;
    }
    .table-dark th.sortable {
      background-color: #003366 !important;
      color: #fff !important;
      font-weight: bold;
      transition: background-color 0.2s ease;
    }
    .table-dark th.sortable:hover {
      background-color: #cce6ff !important;
      color: #000 !important;
    }
    .filters-trigger {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: flex-end;
    }
    .filters-trigger label {
      font-weight: 600;
      font-size: 0.85rem;
    }
  </style>
</head>
<body class="with-sidebar sidebar-pinned">
  {% include "_sidebar.html" %}
  <main class="main-content container-fluid">
    <div class="container-fluid mt-4">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
          <h2 class="mb-0">üìò –ü–∞—Å–ø–æ—Ä—Ç –æ–±—ä–µ–∫—Ç–æ–≤</h2>
          <p class="text-muted mb-0">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Å–ø–æ—Ä—Ç–∞–º–∏ –ª–æ–∫–∞—Ü–∏–π, –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ —Ä–∞–±–æ—Ç—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.</p>
        </div>
        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-outline-secondary" id="exportBtn" type="button">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
          <a class="btn btn-primary" href="/object_passports/new" target="_blank" rel="noopener">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–∞—Å–ø–æ—Ä—Ç</a>
        </div>
      </div>

      <div class="filters-trigger mt-4">
        <div class="flex-grow-1 flex-sm-grow-0">
          <label for="searchInput" class="form-label">–ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –∫–æ–ª–æ–Ω–∫–∞–º</label>
          <input type="text" id="searchInput" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞" />
        </div>
        <div class="d-flex align-items-end gap-2">
          <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#filtersModal">
            ‚öôÔ∏è –§–∏–ª—å—Ç—Ä—ã
          </button>
          <button class="btn btn-outline-secondary" type="button" id="resetFiltersBtn">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
      </div>

      <div class="modal fade" id="filtersModal" tabindex="-1" aria-labelledby="filtersModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="filtersModalLabel">–§–∏–ª—å—Ç—Ä—ã –ø–∞—Å–ø–æ—Ä—Ç–æ–≤</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
            </div>
            <div class="modal-body">
              <div class="row g-3">
                <div class="col-md-6 col-xl-4">
                  <label for="filterBusiness" class="form-label">–ë–∏–∑–Ω–µ—Å</label>
                  <select id="filterBusiness" class="form-select">
                    <option value="">–í—Å–µ</option>
                    {% for value in parameter_values.get('business', []) %}
                    <option value="{{ value }}">{{ value }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6 col-xl-4">
                  <label for="filterPartnerType" class="form-label">–¢–∏–ø –ø–∞—Ä—Ç–Ω—ë—Ä–∞</label>
                  <select id="filterPartnerType" class="form-select">
                    <option value="">–í—Å–µ</option>
                    {% for value in parameter_values.get('partner_type', []) %}
                    <option value="{{ value }}">{{ value }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6 col-xl-4">
                  <label for="filterCountry" class="form-label">–°—Ç—Ä–∞–Ω–∞</label>
                  <select id="filterCountry" class="form-select">
                    <option value="">–í—Å–µ</option>
                    {% for value in parameter_values.get('country', []) %}
                    <option value="{{ value }}">{{ value }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6 col-xl-4">
                  <label for="filterLegalEntity" class="form-label">–Æ–õ</label>
                  <select id="filterLegalEntity" class="form-select">
                    <option value="">–í—Å–µ</option>
                    {% for value in parameter_values.get('legal_entity', []) %}
                    <option value="{{ value }}">{{ value }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6 col-xl-4">
                  <label for="filterCity" class="form-label">–ì–æ—Ä–æ–¥</label>
                  <select id="filterCity" class="form-select">
                    <option value="">–í—Å–µ</option>
                    {% for value in cities %}
                    <option value="{{ value }}">{{ value }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6 col-xl-4">
                  <label for="filterDepartment" class="form-label">–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</label>
                  <select id="filterDepartment" class="form-select">
                    <option value="">–í—Å–µ</option>
                    {% for value in parameter_values.get('department', []) %}
                    <option value="{{ value }}">{{ value }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6 col-xl-4">
                  <label for="filterStatus" class="form-label">–°—Ç–∞—Ç—É—Å</label>
                  <select id="filterStatus" class="form-select">
                    <option value="">–í—Å–µ</option>
                    {% for value in statuses %}
                    <option value="{{ value }}">{{ value }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6 col-xl-4">
                  <label for="filterContract" class="form-label">–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞</label>
                  <select id="filterContract" class="form-select">
                    <option value="">–í—Å–µ</option>
                    {% for value in contract_numbers %}
                    <option value="{{ value }}">{{ value }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-action="reset-modal-filters">–°–±—Ä–æ—Å–∏—Ç—å</button>
              <button type="button" class="btn btn-primary" id="applyFiltersBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-between align-items-center mt-3">
        <span class="text-muted">–ù–∞–π–¥–µ–Ω–æ: <strong id="resultsCount">0</strong></span>
      </div>

      <div class="table-responsive mt-2">
        <table class="table table-hover align-middle" id="passportsTable">
          <thead class="table-dark">
            <tr>
              <th scope="col" class="sortable" data-sort-key="business">–ë–∏–∑–Ω–µ—Å</th>
              <th scope="col" class="sortable" data-sort-key="partner_type">–¢–∏–ø –ø–∞—Ä—Ç–Ω—ë—Ä–∞</th>
              <th scope="col" class="sortable" data-sort-key="country">–°—Ç—Ä–∞–Ω–∞</th>
              <th scope="col" class="sortable" data-sort-key="legal_entity">–Æ–õ</th>
              <th scope="col" class="sortable" data-sort-key="city">–ì–æ—Ä–æ–¥</th>
              <th scope="col" class="sortable" data-sort-key="department">–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</th>
              <th scope="col" class="sortable" data-sort-key="total_work_time">–û–±—â–µ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</th>
              <th scope="col" class="sortable" data-sort-key="network">–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å–µ—Ç—å</th>
              <th scope="col" class="sortable" data-sort-key="network_provider">–ü—Ä–æ–≤–∞–π–¥–µ—Ä</th>
              <th scope="col" class="sortable" data-sort-key="network_speed">–°–∫–æ—Ä–æ—Å—Ç—å</th>
              <th scope="col" class="sortable" data-sort-key="schedule_display">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="alert alert-info mt-3 d-none" id="emptyState">
        –ü–æ –∑–∞–¥–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –∑–∞–ø—Ä–æ—Å.
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const filters = {
      search: document.getElementById('searchInput'),
      business: document.getElementById('filterBusiness'),
      partnerType: document.getElementById('filterPartnerType'),
      country: document.getElementById('filterCountry'),
      legalEntity: document.getElementById('filterLegalEntity'),
      city: document.getElementById('filterCity'),
      department: document.getElementById('filterDepartment'),
      status: document.getElementById('filterStatus'),
      contract: document.getElementById('filterContract'),
    };

    const resultsCountEl = document.getElementById('resultsCount');
    const tableBody = document.querySelector('#passportsTable tbody');
    const emptyState = document.getElementById('emptyState');
    const filtersModalEl = document.getElementById('filtersModal');
    const filtersModal = filtersModalEl ? new bootstrap.Modal(filtersModalEl) : null;
    const applyFiltersBtn = document.getElementById('applyFiltersBtn');
    const resetFiltersBtn = document.getElementById('resetFiltersBtn');
    const resetModalBtn = filtersModalEl ? filtersModalEl.querySelector('[data-action="reset-modal-filters"]') : null;

    let currentItems = [];
    let sortConfig = { key: null, direction: 'asc' };

    function escapeHtml(value) {
      if (value === null || value === undefined) return '';
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function buildParams() {
      const params = new URLSearchParams();
      const searchValue = (filters.search?.value || '').trim();
      if (searchValue) params.set('search', searchValue);
      const mapping = [
        ['business', filters.business?.value],
        ['partner_type', filters.partnerType?.value],
        ['country', filters.country?.value],
        ['legal_entity', filters.legalEntity?.value],
        ['city', filters.city?.value],
        ['department', filters.department?.value],
        ['status', filters.status?.value],
        ['network_contract_number', filters.contract?.value],
      ];
      mapping.forEach(([key, value]) => {
        const trimmed = (value || '').trim();
        if (trimmed) params.set(key, trimmed);
      });
      return params;
    }

    function parseWorkTime(value) {
      if (!value || value === '‚Äî') return 0;
      const matchLegacy = value.match(/\(([^)]+)\)$/);
      const source = matchLegacy ? matchLegacy[1] : value;
      let total = 0;
      const hours = source.match(/(\d+)\s*—á/i);
      const minutes = source.match(/(\d+)\s*–º–∏–Ω/i);
      if (hours) total += parseInt(hours[1], 10) * 60;
      if (minutes) total += parseInt(minutes[1], 10);
      return total;
    }

    function applySorting(items) {
      if (!sortConfig.key) return items;
      const multiplier = sortConfig.direction === 'asc' ? 1 : -1;
      const key = sortConfig.key;
      items.sort((a, b) => {
        if (key === 'total_work_time') {
          return (parseWorkTime(a[key]) - parseWorkTime(b[key])) * multiplier;
        }
        const valueA = (a[key] ?? '').toString().toLowerCase();
        const valueB = (b[key] ?? '').toString().toLowerCase();
        return valueA.localeCompare(valueB, 'ru') * multiplier;
      });
      return items;
    }

    function updateSortIndicators() {
      document.querySelectorAll('#passportsTable thead th.sortable').forEach((th) => {
        th.classList.remove('sort-asc', 'sort-desc');
        if (th.dataset.sortKey === sortConfig.key) {
          th.classList.add(sortConfig.direction === 'asc' ? 'sort-asc' : 'sort-desc');
        }
      });
    }

    function renderTable(items = currentItems) {
        const data = applySorting(Array.isArray(items) ? items.slice() : []);
      tableBody.innerHTML = '';
      resultsCountEl.textContent = data.length;
      if (!data.length) {
        emptyState.classList.remove('d-none');
        updateSortIndicators();
        return;
      }
      emptyState.classList.add('d-none');
      data.forEach((item) => {
        const tr = document.createElement('tr');
        tr.dataset.id = item.id;
        tr.innerHTML = `
          <td>${escapeHtml(item.business)}</td>
          <td>${escapeHtml(item.partner_type)}</td>
          <td>${escapeHtml(item.country)}</td>
          <td>${escapeHtml(item.legal_entity)}</td>
          <td>${escapeHtml(item.city)}</td>
          <td>${escapeHtml(item.department)}</td>
          <td>${escapeHtml(item.total_work_time)}</td>
          <td>${escapeHtml(item.network)}</td>
          <td>${escapeHtml(item.network_provider) || '‚Äî'}</td>
          <td>${escapeHtml(item.network_speed) || '‚Äî'}</td>
          <td>${escapeHtml(item.schedule_display)}</td>
        `;
        tr.addEventListener('click', () => {
          if (item.id) {
            window.open(`/object_passports/${item.id}`, '_blank');
          }
        });
        tableBody.appendChild(tr);
      });
      updateSortIndicators();
    }

    async function loadPassports() {
      const params = buildParams();
      const query = params.toString();
      const url = query ? `/api/object_passports?${query}` : '/api/object_passports';
      tableBody.innerHTML = '<tr><td colspan="11" class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span></div></td></tr>';
      emptyState.classList.add('d-none');
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        const data = await response.json();
        currentItems = Array.isArray(data.items) ? data.items : [];
        renderTable(currentItems);
      } catch (error) {
        console.error(error);
        currentItems = [];
        tableBody.innerHTML = '<tr><td colspan="11" class="text-center text-danger py-4">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</td></tr>';
        resultsCountEl.textContent = '0';
        updateSortIndicators();
      }
    }

    function toggleSort(key) {
      if (!key) return;
      if (sortConfig.key === key) {
        sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
      } else {
        sortConfig.key = key;
        sortConfig.direction = 'asc';
      }
      renderTable();
    }

    document.querySelectorAll('#passportsTable thead th.sortable').forEach((th) => {
      th.addEventListener('click', () => toggleSort(th.dataset.sortKey));
    });

    let searchTimeout;
    if (filters.search) {
      filters.search.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(loadPassports, 300);
      });
    }

    function resetAllFilters({ includeSearch = false } = {}) {
      Object.values(filters).forEach((element) => {
        if (!element) return;
        if (!includeSearch && element === filters.search) return;
        element.value = '';
      });
    }

    if (applyFiltersBtn) {
      applyFiltersBtn.addEventListener('click', () => {
        loadPassports();
        if (filtersModal) {
          filtersModal.hide();
        }
      });
    }

    if (resetFiltersBtn) {
      resetFiltersBtn.addEventListener('click', () => {
        resetAllFilters({ includeSearch: true });
        loadPassports();
      });
    }

    if (resetModalBtn) {
      resetModalBtn.addEventListener('click', () => {
        resetAllFilters();
      });
    }

    document.getElementById('exportBtn').addEventListener('click', () => {
      const params = buildParams();
      const query = params.toString();
      const url = query ? `/object_passports/export?${query}` : '/object_passports/export';
      window.location.href = url;
    });

    const urlParams = new URLSearchParams(window.location.search);
    if (filters.search) {
      const searchFromUrl = urlParams.get('search');
      if (searchFromUrl) {
        filters.search.value = searchFromUrl;
      }
    }

    const filterParamMapping = {
      business: ['business'],
      partnerType: ['partner_type'],
      country: ['country'],
      legalEntity: ['legal_entity'],
      city: ['city'],
      department: ['department'],
      status: ['status'],
      contract: ['network_contract_number', 'contract_number', 'contract'],
    };

    Object.entries(filterParamMapping).forEach(([key, paramNames]) => {
      const element = filters[key];
      if (!element) return;
      const valueFromUrl = paramNames.map((name) => urlParams.get(name)).find((val) => val !== null && val !== '');
      if (valueFromUrl) {
        element.value = valueFromUrl;
      }
    });

    loadPassports();
  </script>
  <script src="{{ url_for('static', filename='sidebar.js') }}"></script>
</body>
</html>
