<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Пользователи панели</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='sidebar.css') }}" rel="stylesheet" />
</head>
<body class="with-sidebar sidebar-pinned">
  {% include "_sidebar.html" %}
  <main class="main-content container-fluid">

    <div class="d-flex align-items-center justify-content-between mb-3">
      <h3 class="mb-0">Пользователи</h3>
    </div>

    <div class="row g-3">
      <!-- Список -->
      <div class="col-lg-7">
        <div class="card">
          <div class="card-header">Список пользователей</div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle mb-0" id="usersTable">
                <thead class="table-light">
                  <tr>
                    <th style="width:80px;">ID</th>
                    <th>Логин</th>
                    <th style="width:160px;">Роль</th>
                    <th style="width:140px;"></th>
                  </tr>
                </thead>
                <tbody><!-- заполняется JS --></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Добавление -->
      <div class="col-lg-5">
        <div class="card">
          <div class="card-header">Создать пользователя</div>
          <div class="card-body">
            <form id="createForm" class="row g-3">
              <div class="col-12">
                <label class="form-label">Логин</label>
                <input type="text" name="username" class="form-control" required>
              </div>
              <div class="col-12">
                <label class="form-label">Пароль</label>
                <input type="password" name="password" class="form-control" required>
              </div>
              <div class="col-12">
                <label class="form-label">Роль</label>
                <select name="role" class="form-select">
                  <option value="user">user</option>
                  <option value="admin">admin</option>
                </select>
              </div>
              <div class="col-12 d-flex gap-2">
                <button type="submit" class="btn btn-primary">Создать</button>
                <button type="reset" class="btn btn-outline-secondary">Сброс</button>
              </div>
            </form>
            <div id="msg" class="text-danger small mt-2" style="display:none;"></div>
          </div>
        </div>
      </div>
    </div>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{{ url_for('static', filename='sidebar.js') }}"></script>
  <script>
    async function loadUsers(){
      const r = await fetch('/users', {credentials:'same-origin'});
      const data = await r.json();
      const tb = document.querySelector('#usersTable tbody');
      tb.innerHTML = '';
      (data || []).forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${u.id}</td>
          <td>${u.username}</td>
          <td><span class="badge ${u.role==='admin'?'bg-danger':'bg-secondary'}">${u.role}</span></td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-danger" ${u.id===1?'disabled':''} onclick="deleteUser(${u.id})">Удалить</button>
          </td>
        `;
        tb.appendChild(tr);
      });
    }

    async function deleteUser(id){
      if (!confirm('Удалить пользователя #' + id + '?')) return;
      const r = await fetch('/users/'+id, {method:'DELETE', credentials:'same-origin'});
      const data = await r.json();
      if (data && data.success) {
        loadUsers();
      } else {
        alert(data && data.error ? data.error : 'Ошибка удаления');
      }
    }

    document.getElementById('createForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const f = e.currentTarget;
      const payload = {
        username: f.username.value.trim(),
        password: f.password.value,
        role: f.role.value
      };
      const r = await fetch('/users', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'same-origin',
        body: JSON.stringify(payload)
      });
      const data = await r.json();
      const msg = document.getElementById('msg');
      if (data && data.success){
        msg.style.display='none';
        f.reset();
        loadUsers();
      } else {
        msg.textContent = (data && data.error) ? data.error : 'Ошибка создания пользователя';
        msg.style.display='';
      }
    });

    loadUsers();
  </script>
</body>
</html>
