<!-- panel/templates/client_profile.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–ª–∏–µ–Ω—Ç {{ client.user_id }} ‚Äî Bender</title>
  <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='bender-icon.svg') }}" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='sidebar.css', v='2') }}" rel="stylesheet" />
  <style>
    .chat-bubble {
      padding: 8px 12px;
      border-radius: 8px;
      margin-bottom: 6px;
      max-width: 80%;
      word-wrap: break-word;
    }
        /* ‚Üë –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏ —ç–º–æ–¥–∑–∏ –≤ –ø—É–∑—ã—Ä—è—Ö —Å–æ–æ–±—â–µ–Ω–∏–π ~–≤ 1.5 —Ä–∞–∑–∞ */
        .chat-bubble {
          font-size: 1.5em;      /* –±—ã–ª–æ 1em –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Üí —Å—Ç–∞–ª–æ ~1.5x */
          line-height: 1.35;
        }
        .chat-bubble img.emoji {  /* —Ç–≤–µ–º–æ—ò–∏ —Ä–∞—Å—Ç—è–≥–∏–≤–∞—é—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å —Ç–µ–∫—Å—Ç–æ–º */
          height: 1em;
          width: 1em;
          vertical-align: -0.1em;
        }

    .chat-bubble.chat-bubble-with-avatar {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .chat-bubble-with-avatar .chat-bubble-content {
      flex: 1 1 auto;
    }

    .chat-bubble-avatar-btn {
      border: none;
      background: transparent;
      padding: 0;
      cursor: zoom-in;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      overflow: hidden;
      flex: 0 0 auto;
    }

    .chat-bubble-avatar-btn:focus-visible {
      outline: 2px solid rgba(25, 135, 84, 0.6);
      outline-offset: 2px;
    }

    .chat-bubble-avatar-btn img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .from-user { background: #e3f2fd; align-self: flex-end; }
    .from-support { background: #d1f7d1; align-self: flex-start; }

    .chat-container { 
      min-height: 300px; 
      max-height: 500px; 
      overflow-y: auto; 
      padding: 10px; 
      background: #f8f9fa;
      border-radius: 8px;
    }

    /* ‚úÖ –ß—ë—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç */
    .chat-bubble p, .chat-bubble small, .chat-bubble strong {
      color: #000 !important;
    }

    /* ‚úÖ –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫–∞ */
    .input-group-send {
      display: flex;
      align-items: stretch;
      gap: 8px;
    }
    .input-group-send textarea {
      flex: 1;
      resize: both;
      min-height: 60px;
      max-height: 200px;
    }
    .input-group-send .btn {
      white-space: nowrap;
    }
    .modal.small-modal {
      align-items: center;
      justify-content: center;
    }

    .modal.small-modal.show {
      display: flex !important;
    }

    .modal.small-modal .modal-dialog {
      margin: 0;
      position: relative;
      top: 0;
      transform: none;
    }

    .small-modal {
      align-items: center;
      justify-content: center;
    }

    .small-modal.show {
      display: flex !important;
    }

    .small-modal .modal-dialog {
      margin: 0;
      position: relative;
      top: 0;
      transform: none;
    }

    #ticketClosedModal .modal-dialog {
      margin: 0;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      position: fixed;
    }

    /* ‚úÖ –°—Ç–∏–ª–∏ –¥–ª—è –±–∏–∑–Ω–µ—Å–æ–≤ */
    .business-sushi { background-color: #F25F79 !important; color: white !important; }
    .business-blin { background-color: #FFD504 !important; color: black !important; }

    /* ‚úÖ –°—Ç–∏–ª–∏ –¥–ª—è resize —Å—Ç–æ–ª–±—Ü–æ–≤ */
    .table th {
      position: relative;
      user-select: none;
    }
    .resize-handle {
      position: absolute;
      top: 0;
      right: 0;
      width: 5px;
      height: 100%;
      background-color: #ddd;
      cursor: col-resize;
      user-select: none;
    }

    /* ‚úÖ –ö–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç */
    .clickable-client {
      cursor: pointer;
      color: #0d6efd;
      text-decoration: underline;
    }
    .clickable-client:hover {
      text-decoration: none;
      background-color: #f0f8ff;
    }
	
	/* Twemoji: –¥–µ–ª–∞–µ–º —ç–º–æ–¥–∑–∏ —Ä–∞–∑–º–µ—Ä–æ–º —Å —Ç–µ–∫—Å—Ç */
	img.emoji {
	  height: 1em;
	  width: 1em;
	  margin: 0 .05em 0 .1em;
	  vertical-align: -0.1em;
	}
/* Twemoji –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –∫–ª–∏–µ–Ω—Ç–∞ */
#profileModal img.emoji,
#profileModal .msg-text img.emoji,
#profileModal .msg-author img.emoji {
  width: 1.1em;
  height: 1.1em;
  max-width: none;
  max-height: none;
  vertical-align: -0.12em;
  margin: 0 .06em;
  border: 0;
  padding: 0;
  background: transparent;
  box-shadow: none;
}

  </style>
</head>
<body class="with-sidebar sidebar-pinned">
  {% include "_sidebar.html" %}
  <main class="main-content container-fluid">
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
	  <h2>üë§ –ö–∞—Ä—Ç–æ—á–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞</h2>
	  <div class="d-flex align-items-center gap-2">
		<a href="/clients" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥</a>
                <button class="btn btn-sm btn-outline-danger"
                                type="button"
                                onclick="openBlacklistModal('{{ client.user_id }}')">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn btn-sm btn-success"
                                onclick="blacklistRemove('{{ client.user_id }}')">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                {% if client_blacklist and client_blacklist.is_blacklisted and client_blacklist.unblock_requested %}
                <button class="btn btn-sm btn-warning"
                                type="button"
                                onclick="openRejectUnblockModal('{{ client.user_id }}')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
                {% endif %}
          </div>
        </div>

    <div class="card mb-4">
      <div class="card-body">
        <h5>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
		<div class="d-flex align-items-center gap-3 mb-3">
			  <img id="clientAvatarProfile"
				 src="/avatar/{{ client.user_id }}"
				 data-src="{{ client.photo_url or '' }}"
				 data-fullsrc="/avatar/{{ client.user_id }}?full=1"
				 width="72" height="72"
				 class="rounded-circle"
				 style="object-fit:cover;border:1px solid rgba(0,0,0,1);cursor:zoom-in"
				 alt="avatar"
				 onerror="this.onerror=null;this.src='/static/avatar_default.svg';">
			  <div>
				<div><strong>ID Telegram:</strong> <code>{{ client.user_id }}</code></div>
				<div><strong>–Æ–∑–µ—Ä–Ω–µ–π–º:</strong> {{ client.username or '‚Äî' }}</div>
                                <p class="mb-1"><strong>Blacklist:</strong>
                                  {% if client_blacklist and client_blacklist.is_blacklisted %}
                                        <span class="badge text-bg-danger">–î–∞</span>
                                        {% if client_blacklist.unblock_requested %}
                                          <span class="badge text-bg-warning ms-1">–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–Ω—è—Ç–∏–µ</span>
                                        {% endif %}
                                        {% set added_at = client_blacklist.added_at_display or client_blacklist.added_at %}
                                        {% if added_at or client_blacklist.added_by %}
                                          <div class="small text-muted mt-1">
                                            {% if added_at %}
                                              –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: {{ added_at }}
                                            {% endif %}
                                            {% if client_blacklist.added_by %}
                                              {% if added_at %}&nbsp;‚Ä¢ {% endif %}–û–ø–µ—Ä–∞—Ç–æ—Ä: {{ client_blacklist.added_by }}
                                            {% endif %}
                                          </div>
                                        {% endif %}
                                        {% if client_blacklist.reason %}
                                          <div class="small mt-1">–ü—Ä–∏—á–∏–Ω–∞: {{ client_blacklist.reason }}</div>
                                        {% endif %}
                                  {% else %}
                                        <span class="badge text-bg-secondary">–ù–µ—Ç</span>
                                  {% endif %}
                                </p>
			  </div>
		</div>
                <div id="avatarHistory" class="mt-2"></div>
        {% if unblock_requests %}
        <div class="mt-4">
          <h6 class="fw-semibold">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫—É</h6>
          <div class="table-responsive">
            <table class="table table-sm table-striped align-middle">
              <thead>
                <tr>
                  <th scope="col">–î–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞</th>
                  <th scope="col">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫–ª–∏–µ–Ω—Ç–∞</th>
                  <th scope="col">–°—Ç–∞—Ç—É—Å</th>
                  <th scope="col">–†–µ—à–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</th>
                  <th scope="col">–û–ø–µ—Ä–∞—Ç–æ—Ä</th>
                </tr>
              </thead>
              <tbody>
                {% for entry in unblock_requests %}
                <tr>
                  <td>{{ entry.created_at_display or '‚Äî' }}</td>
                  <td>{{ entry.reason or '‚Äî' }}</td>
                  <td>
                    {% if entry.status == 'pending' %}
                      <span class="badge text-bg-warning text-dark">–í –æ–∂–∏–¥–∞–Ω–∏–∏</span>
                    {% elif entry.status == 'approved' %}
                      <span class="badge text-bg-success">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>
                    {% elif entry.status == 'rejected' %}
                      <span class="badge text-bg-danger">–û—Ç–∫–ª–æ–Ω—ë–Ω</span>
                    {% else %}
                      <span class="badge text-bg-secondary">{{ entry.status }}</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if entry.status == 'pending' %}
                      <span class="text-muted">–û–∂–∏–¥–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è</span>
                    {% else %}
                      {{ entry.decision_comment or '‚Äî' }}
                    {% endif %}
                  </td>
                  <td>
                    {% if entry.status == 'pending' %}
                      <span class="text-muted">‚Äî</span>
                    {% else %}
                      <div>{{ entry.decided_by or '‚Äî' }}</div>
                      {% if entry.decided_at_display %}
                        <div class="small text-muted">{{ entry.decided_at_display }}</div>
                      {% endif %}
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endif %}
        <p><strong>ID Telegram:</strong> <code>{{ client.user_id }}</code></p>
        <p><strong>–Æ–∑–µ—Ä–Ω–µ–π–º –≤ Telegram:</strong> {{ client.username or '‚Äî' }}</p>
        <p><strong>–ò–º—è –≤ –ë–î:</strong> <span id="clientNameDisplay">{{ client.client_name or '‚Äî' }}</span></p>
        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editClientNameModal">
          ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–º—è
        </button>

        <hr>

        <p><strong>–°—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞:</strong> <span id="clientStatusDisplay">{{ client_status or '‚Äî' }}</span></p>
        <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#editClientStatusModal">
          üè∑Ô∏è –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å
        </button>
      </div>
    </div>

	<div class="card mb-4">
	  <div class="card-body">
		<h5>üìù –ò—Å—Ç–æ—Ä–∏—è —é–∑–µ—Ä–Ω–µ–π–º–∞</h5>
		{% if username_history and username_history|length > 0 %}
		  <ul class="list-group">
			{% for u in username_history %}
			  <li class="list-group-item d-flex justify-content-between align-items-center">
				<span>
				  {% if loop.first %}
					<span class="badge bg-success me-2">–¢–µ–∫—É—â–∏–π</span>
				  {% endif %}
				  @{{ u.username }}
				</span>
				<small class="text-muted">{{ u.seen_at }}</small>
			  </li>
			{% endfor %}
		  </ul>
		{% else %}
		  <p class="text-muted mb-0">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—é —é–∑–µ—Ä–Ω–µ–π–º–∞</p>
		{% endif %}
	  </div>
	</div>

<div class="card mb-4" id="clientPhonesCard">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span class="fw-semibold">üìû –¢–µ–ª–µ—Ñ–æ–Ω—ã –∫–ª–∏–µ–Ω—Ç–∞</span>
  </div>
  <div class="card-body">

    <h6 class="mt-2">–ò–∑ Telegram (—Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è)</h6>
    {% if phones_telegram and phones_telegram|length > 0 %}
      <ul class="list-group mb-3">
        {% for p in phones_telegram %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span><strong>{{ p.phone }}</strong> <span class="text-muted">({{ p.label or '–∏–∑ Telegram' }})</span></span>
            <small class="text-muted">{{ p.created_at }}</small>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-muted">–ö–ª–∏–µ–Ω—Ç –µ—â—ë –Ω–µ –ø–æ–¥–µ–ª–∏–ª—Å—è –Ω–æ–º–µ—Ä–æ–º —á–µ—Ä–µ–∑ Telegram.</p>
    {% endif %}

    <h6 class="mt-3">–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é</h6>
    <div class="table-responsive">
      <table class="table align-middle">
        <thead><tr><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–ú–µ—Ç–∫–∞</th><th>–î–æ–±–∞–≤–ª–µ–Ω</th><th></th></tr></thead>
        <tbody id="manualPhonesTbody">
          {% for p in phones_manual %}
          <tr data-id="{{ p.id }}">
            <td><strong>{{ p.phone }}</strong></td>
            <td>
              <input class="form-control form-control-sm phone-label-input" value="{{ p.label or '' }}" placeholder="–ª–∏—á–Ω—ã–π/—Ä–∞–±–æ—á–∏–π/‚Ä¶">
            </td>
            <td><small class="text-muted">{{ p.created_at }}</small></td>
            <td class="text-end">
              <button class="btn btn-sm btn-outline-primary" data-edit-mark-dirty onclick="savePhoneLabel({{ client.user_id }}, {{ p.id }}, this)">üíæ</button>
              <button class="btn btn-sm btn-outline-danger" data-edit-mark-dirty onclick="archivePhone({{ client.user_id }}, {{ p.id }}, this)">üóë</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="row g-2 mt-2">
      <div class="col-md-4">
        <input id="newPhoneInput" class="form-control" placeholder="+7‚Ä¶">
      </div>
      <div class="col-md-4">
        <input id="newPhoneLabelInput" class="form-control" placeholder="–ª–∏—á–Ω—ã–π / —Ä–∞–±–æ—á–∏–π / –¥—Ä—É–≥–æ–µ">
      </div>
      <div class="col-md-4 d-flex flex-column flex-sm-row gap-2">
        <button class="btn btn-primary flex-fill" data-edit-mark-dirty onclick="addManualPhone({{ client.user_id }})">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω</button>
        <button class="btn btn-success flex-fill" data-edit-guard-edit-visible data-edit-mark-dirty id="bulkSavePhonesBtn" disabled>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
      </div>
    </div>
  </div>
</div>
	
    <h4>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card text-center">
          <div class="card-body">
            <h5>{{ stats.total }}</h5>
            <p class="text-muted">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card text-center">
          <div class="card-body">
            <h5>{{ stats.resolved }}</h5>
            <p class="text-success">–†–µ—à–µ–Ω–æ</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card text-center">
          <div class="card-body">
            <h5>{{ stats.pending }}</h5>
            <p class="text-warning">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</p>
          </div>
        </div>
      </div>
    </div>

    <!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Ç–µ–º–∞–º –∏ –ª–æ–∫–∞—Ü–∏—è–º -->
    <h4>üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –æ–±—Ä–∞—â–µ–Ω–∏—è–º</h4>
    <div class="card mb-4">
      <div class="card-body">
        <h6>–¢–µ–º—ã –æ–±—Ä–∞—â–µ–Ω–∏–π</h6>
        <ul class="list-group mb-3">
          {% set categories = {} %}
          {% for t in tickets %}
            {% if t.category %}
              {% if t.category not in categories %}
                {% set _ = categories.update({t.category: 1}) %}
              {% else %}
                {% set _ = categories.update({t.category: categories[t.category] + 1}) %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% for cat, cnt in categories.items() %}
          <li class="list-group-item d-flex justify-content-between">
            <span>{{ cat }}</span>
            <span class="badge bg-info">{{ cnt }}</span>
          </li>
          {% endfor %}
        </ul>

        <h6>–õ–æ–∫–∞—Ü–∏–∏</h6>
        <ul class="list-group">
          {% set locations = {} %}
          {% for t in tickets %}
            {% set loc = t.city + ' ‚Äî ' + (t.location_name or '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è') %}
            {% if loc not in locations %}
              {% set _ = locations.update({loc: 1}) %}
            {% else %}
              {% set _ = locations.update({loc: locations[loc] + 1}) %}
            {% endif %}
          {% endfor %}
          {% for loc, cnt in locations.items() %}
          <li class="list-group-item d-flex justify-content-between">
            <span>{{ loc }}</span>
            <span class="badge bg-secondary">{{ cnt }}</span>
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <!-- –û—Ü–µ–Ω–∫–∏ -->
    {% if feedbacks %}
    <h4>‚≠ê –û—Ü–µ–Ω–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤</h4>
    <div class="card mb-4">
      <div class="card-body">
        <ul class="list-group">
          {% for f in feedbacks %}
          <li class="list-group-item feedback-item">
            <strong>{{ f.rating }} –∏–∑ 5</strong> ‚Äî {{ f.timestamp.split('.')[0] }}
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
    {% endif %}

    <!-- –ó–∞—è–≤–∫–∏ -->
    <h4>üìã –ó–∞—è–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞</h4>
    <div class="accordion" id="ticketsAccordion">
      {% for t in tickets %}
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ t.ticket_id }}">
            {{ t.ticket_id }} ‚Äî {{ t.business }} ({{ t.city }})
          </button>
        </h2>
        <div id="collapse-{{ t.ticket_id }}" class="accordion-collapse collapse" data-bs-parent="#ticketsAccordion">
          <div class="accordion-body">
            <p><strong>–ü—Ä–æ–±–ª–µ–º–∞:</strong> {{ t.problem }}</p>
            <p><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> {{ t.category or '‚Äî' }}</p>
            <p><strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong> {{ t.created_date }} {{ t.created_time }}</p>
            {% if t.status == 'resolved' and t.resolved_at %}
              <p><strong>–ó–∞–≤–µ—Ä—à–µ–Ω–∞:</strong> {{ t.resolved_at }} <strong>–∫–µ–º:</strong> {{ t.resolved_by or '–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏' }}</p>
              {% if t.duration_minutes is not none %}
                <p><strong>–í—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:</strong> {{ t.duration_minutes }} –º–∏–Ω</p>
              {% endif %}
            {% else %}
              <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="badge bg-warning text-dark">‚è≥ –í –æ–±—Ä–∞–±–æ—Ç–∫–µ</span></p>
            {% endif %}
            <button class="btn btn-sm btn-outline-secondary" onclick="loadHistory({{ client.user_id }}, '{{ t.ticket_id }}')">
              –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é
            </button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ -->
  <div class="modal fade" id="editClientNameModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="newClientName" class="form-control" value="{{ client.client_name or '' }}" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          <button type="button" class="btn btn-primary" onclick="saveClientName()">
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ -->
  <div class="modal fade" id="editClientStatusModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <select id="newClientStatus" class="form-select">
            <option value="">–ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞</option>
            {% for status in settings.client_statuses %}
            <option value="{{ status }}" {% if client_status == status %}selected{% endif %}>{{ status }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          <button type="button" class="btn btn-primary" onclick="saveClientStatus()">
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –∏—Å—Ç–æ—Ä–∏—è -->
  <div class="modal fade resizable-modal" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable modal-lg modal-dialog-centered" style="width: 80%; height: 80%;">
      <div class="modal-content" style="min-height: 400px;">
        <div class="modal-header">
          <h5 class="modal-title" id="historyModalTitle">üí¨ –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ ‚Äî ID –∑–∞—è–≤–∫–∏: <span id="ticketIdDisplay"></span></h5>
          <div class="d-flex align-items-center gap-2 flex-wrap">
            <span id="clientDisplayName">‚Äî</span>
            <div id="clientStatusBadgeContainer" class="d-flex align-items-center flex-wrap gap-1"></div>
            <button type="button" class="btn btn-sm btn-outline-primary" id="editClientBtn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–º—è">
              ‚úèÔ∏è
            </button>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body chat-container" id="historyContent" style="min-height: 300px;"></div>
        <div class="modal-footer">
          <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫–∞ —Ä–µ–∂–∏–º–∞ -->
          <div class="input-group-send w-100">
            <textarea
              id="replyTextInHistory"
              class="form-control"
              placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç..."
            ></textarea>
            <button id="sendKeySettingBtn" class="btn btn-outline-secondary" type="button" style="width: 120px;" data-bs-toggle="dropdown">
              Enter ‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" data-mode="enter">Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</a></li>
              <li><a class="dropdown-item" href="#" data-mode="ctrlEnter">Ctrl+Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</a></li>
              <li><a class="dropdown-item" href="#" data-mode="enterNewline">Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞</a></li>
            </ul>
          </div>
          <div class="mt-2 d-flex justify-content-between w-100">
            <button type="button" id="closeTicketBtn" class="btn btn-danger">–ó–∞–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É</button>
            <button type="button" id="sendReplyInHistory" class="btn btn-primary">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    window.settings = {{ settings | tojson }};
  </script>
  <script>
      const CURRENT_OPERATOR = {{ (session.get('user_email') or session.get('username') or session.get('user') or '') | tojson }};
      const CURRENT_OPERATOR_PHOTO = {{ (current_operator_photo or '') | tojson }};
      const SUPPORT_AVATAR_FALLBACK = {{ url_for('static', filename='avatar_default.svg') | tojson }};
      const CLIENT_BLACKLIST = {{ (client_blacklist or {}) | tojson }};
      const CLIENT_NAME = {{ (client.client_name or '') | tojson }};
      const CLIENT_USERNAME = {{ (client.username or '') | tojson }};

    function getOperatorName() {
      const name = (typeof CURRENT_OPERATOR === 'string' ? CURRENT_OPERATOR : '').trim();
      return name || '–ü–æ–¥–¥–µ—Ä–∂–∫–∞';
    }
    let currentUserId = null;
    let currentTicketId = null;
    let historyPolling = null;
    let clientData = null;

    function renderClientBlacklistBadges() {
      const container = document.getElementById('clientStatusBadgeContainer');
      if (!container) return;

      const isBlacklisted = !!(CLIENT_BLACKLIST && (Number(CLIENT_BLACKLIST.is_blacklisted) === 1 || CLIENT_BLACKLIST.is_blacklisted === true));
      container.innerHTML = '';
      container.classList.toggle('d-none', !isBlacklisted);
      if (!isBlacklisted) {
        container.removeAttribute('title');
        return;
      }

      const mainBadge = document.createElement('span');
      mainBadge.className = 'badge text-bg-danger';
      mainBadge.textContent = '–í –±–ª—ç–∫–ª–∏—Å—Ç–µ';
      container.appendChild(mainBadge);

      const details = [];
      if (CLIENT_BLACKLIST.added_at_display) {
        details.push(`—Å ${CLIENT_BLACKLIST.added_at_display}`);
      } else if (CLIENT_BLACKLIST.added_at) {
        details.push(`—Å ${CLIENT_BLACKLIST.added_at}`);
      }
      if (CLIENT_BLACKLIST.added_by) {
        details.push(`–æ–ø–µ—Ä–∞—Ç–æ—Ä: ${CLIENT_BLACKLIST.added_by}`);
      }
      if (details.length) {
        const detailBadge = document.createElement('span');
        detailBadge.className = 'badge text-bg-light text-muted border';
        detailBadge.textContent = details.join(' ¬∑ ');
        container.appendChild(detailBadge);
      }

      if (CLIENT_BLACKLIST.unblock_requested) {
        const requestBadge = document.createElement('span');
        requestBadge.className = 'badge text-bg-warning text-dark';
        requestBadge.textContent = '–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–Ω—è—Ç–∏–µ';
        container.appendChild(requestBadge);
      }

      const reason = (CLIENT_BLACKLIST.reason || '').trim();
      if (reason) {
        container.title = `–ü—Ä–∏—á–∏–Ω–∞: ${reason}`;
      } else {
        container.removeAttribute('title');
      }
    }

    document.addEventListener('DOMContentLoaded', renderClientBlacklistBadges);
	// === –ú–µ–¥–∏–∞-—Ö–µ–ª–ø–µ—Ä—ã –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –≤ –º–æ–¥–∞–ª–∫–µ ===
function getMediaUrl(ticket_id, filename) {
  const clean = (filename || '').split('/').pop();
  return `/media/${ticket_id}/${clean}`;
}

function createMediaHtml(ticket_id, mediaInfo) {
  const { message_type, attachment, text } = mediaInfo;
  const filename = (attachment || '').split('/').pop();
  const mediaUrl = getMediaUrl(ticket_id, filename);
  const ext = (filename.split('.').pop() || '').toLowerCase();
  let mediaHtml = '';

  switch (message_type) {
    case 'photo':
      mediaHtml = `
        <div class="mt-2">
          <img src="${mediaUrl}"
               loading="lazy" decoding="async"
               style="max-width: 100%; max-height: 400px; border-radius: 8px;"
               alt="–§–æ—Ç–æ" class="img-thumbnail">
          ${text ? `<div class="small mt-1">${text}</div>` : ''}
        </div>`;
      break;

    case 'video':
      mediaHtml = `
        <div class="mt-2">
          <video controls
                 style="max-width: 100%; max-height: 300px; border-radius: 8px;"
                 class="img-thumbnail">
            <source src="${mediaUrl}">
            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
          </video>
          ${text ? `<div class="small mt-1">${text}</div>` : ''}
        </div>`;
      break;

    case 'animation': // GIF (–∫–∞–∫ mp4)
      mediaHtml = `
        <div class="mt-2">
          <video autoplay loop muted playsinline controls
                 style="max-width: 100%; max-height: 320px; border-radius: 8px;"
                 class="img-thumbnail">
            <source src="${mediaUrl}">
            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
          </video>
          ${text ? `<div class="small mt-1">${text}</div>` : ''}
        </div>`;
      break;

    case 'sticker':
      if (ext === 'webp') {
        mediaHtml = `<div class="mt-2"><img src="${mediaUrl}" alt="–°—Ç–∏–∫–µ—Ä" style="max-width:160px;height:auto;"></div>`;
      } else if (ext === 'webm') {
        mediaHtml = `<div class="mt-2"><video autoplay loop muted playsinline style="max-width:160px;border-radius:8px;"><source src="${mediaUrl}"></video></div>`;
      } else if (ext === 'tgs') {
        mediaHtml = `<div class="mt-2"><a href="${mediaUrl}" target="_blank">–°—Ç–∏–∫–µ—Ä (.tgs) ‚Äî —Å–∫–∞—á–∞—Ç—å</a></div>`;
      } else {
        mediaHtml = `<div class="mt-2"><a href="${mediaUrl}" target="_blank">–°—Ç–∏–∫–µ—Ä</a></div>`;
      }
      if (text) mediaHtml += `<div class="small mt-1">${text}</div>`;
      break;

    case 'document':
      mediaHtml = `
        <div class="mt-2">
          <a href="${mediaUrl}" target="_blank"
             class="btn btn-outline-primary btn-sm d-inline-flex align-items-center">
            üìÑ ${filename}
          </a>
          ${text ? `<div class="small mt-1">${text}</div>` : ''}
        </div>`;
      break;

    case 'voice':
      mediaHtml = `
        <div class="mt-2">
          <audio controls style="width: 100%;" class="mb-2">
            <source src="${mediaUrl}">
            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ.
          </audio>
          ${text ? `<div class="small mt-1">${text}</div>` : ''}
        </div>`;
      break;

    default:
      if (attachment) {
        mediaHtml = `<div class="mt-2"><a href="${mediaUrl}" target="_blank" class="text-muted">[–º–µ–¥–∏–∞]</a>${text ? `<div class="small mt-1">${text}</div>` : ''}</div>`;
      }
  }

  return mediaHtml;
}


    function getSupportAvatarUrl() {
      const raw = typeof CURRENT_OPERATOR_PHOTO === 'string' ? CURRENT_OPERATOR_PHOTO.trim() : '';
      return raw || SUPPORT_AVATAR_FALLBACK;
    }

    function createSupportAvatarButton() {
      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'chat-bubble-avatar-btn';
      button.setAttribute('aria-label', '–û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ç–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞');

      const img = document.createElement('img');
      img.src = getSupportAvatarUrl();
      img.alt = '–§–æ—Ç–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞';
      img.loading = 'lazy';
      img.onerror = () => {
        img.onerror = null;
        img.src = SUPPORT_AVATAR_FALLBACK;
      };

      button.appendChild(img);
      button.addEventListener('click', () => {
        const currentSrc = img.getAttribute('src') || SUPPORT_AVATAR_FALLBACK;
        openAvatarModal(currentSrc, { type: 'support', fallback: SUPPORT_AVATAR_FALLBACK });
      });

      return button;
    }

    function prepareHistoryMessageParts(msg, ticketId) {
      const cls = msg.sender === 'support' ? 'from-support' : 'from-user';
      let name = cls === 'from-support' ? 'üõ† –ü–æ–¥–¥–µ—Ä–∂–∫–∞' : 'üë§ –ö–ª–∏–µ–Ω—Ç';

      if (cls !== 'from-support') {
        const displayName = typeof CLIENT_NAME === 'string' ? CLIENT_NAME.trim() : '';
        const username = typeof CLIENT_USERNAME === 'string' ? CLIENT_USERNAME.trim() : '';
        if (displayName && displayName !== '–Ω–µ –∑–∞–¥–∞–Ω–æ') {
          name = 'üë§ ' + displayName;
        } else if (username) {
          name = 'üë§ @' + username;
        }
      }

      const time = msg.timestamp ? new Date(msg.timestamp).toLocaleString('ru-RU') : '';

      const isTextMessage = msg.message && (!msg.message_type || msg.message_type === 'text');
      const textHtml = isTextMessage ? `<p class="mb-0">${msg.message.replace(/\n/g,'<br>')}</p>` : '';
      const hasMedia = msg.message_type && msg.message_type !== 'text' && msg.attachment;
      const mediaHtml = hasMedia
        ? createMediaHtml(ticketId, { message_type: msg.message_type, attachment: msg.attachment, text: msg.message || '' })
        : '';

      return { cls, name, time, textHtml, mediaHtml };
    }

    function buildHistoryBubble(msg, ticketId) {
      const { cls, name, time, textHtml, mediaHtml } = prepareHistoryMessageParts(msg, ticketId);
      const bubble = document.createElement('div');
      bubble.className = `chat-bubble ${cls}`;

      const contentHtml = `
        <small>${time}</small><br>
        <strong>${name}</strong>
        ${textHtml}
        ${mediaHtml}
      `;

      if (cls === 'from-support') {
        bubble.classList.add('chat-bubble-with-avatar');
        const avatarButton = createSupportAvatarButton();
        const content = document.createElement('div');
        content.className = 'chat-bubble-content';
        content.innerHTML = contentHtml;
        bubble.appendChild(avatarButton);
        bubble.appendChild(content);
      } else {
        bubble.innerHTML = contentHtml;
      }

      return bubble;
    }

    function renderHistoryMessages(container, messages, ticketId) {
      if (!container) return;
      container.innerHTML = '';
      (messages || []).forEach((msg) => {
        const bubble = buildHistoryBubble(msg, ticketId);
        if (bubble) {
          container.appendChild(bubble);
        }
      });
    }


    const HISTORY_ERROR_SNIPPET_LIMIT = 200;

    async function fetchJsonWithAuth(url, options = {}) {
      const fetchOptions = { ...options };
      if (!('credentials' in fetchOptions)) {
        fetchOptions.credentials = 'same-origin';
      }
      const response = await fetch(url, fetchOptions);
      const rawText = await response.text();
      if (!response.ok) {
        const snippet = rawText ? `: ${rawText.slice(0, HISTORY_ERROR_SNIPPET_LIMIT)}` : '';
        throw new Error(`–ó–∞–ø—Ä–æ—Å ${url} –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π ${response.status}${snippet}`);
      }
      if (!rawText.trim()) {
        return null;
      }
      try {
        return JSON.parse(rawText);
      } catch (parseError) {
        const snippet = rawText.slice(0, HISTORY_ERROR_SNIPPET_LIMIT);
        throw new Error(`–û—Ç–≤–µ—Ç ${url} –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º JSON: ${parseError.message}. –§—Ä–∞–≥–º–µ–Ω—Ç: ${snippet}`);
      }
    }

    // === –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é ===
    async function loadHistory(user_id, ticket_id) {
      currentUserId = user_id;
      currentTicketId = ticket_id;

      let data;
      try {
        data = await fetchJsonWithAuth(`/history?user_id=${user_id}&ticket_id=${ticket_id}`, { cache: 'no-store' }) || {};
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏:', error);
        const reason = error && error.message ? `: ${error.message}` : '';
        alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∑–∞—è–≤–∫–∏${reason}`);
        return;
      }

      const container = document.getElementById('historyContent');

      if (!container) {
        console.error("‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω");
        return;
      }

      renderClientBlacklistBadges();

      container.innerHTML = '';

      const messages = Array.isArray(data.messages) ? data.messages : [];

      if (messages.length === 0) {
        container.innerHTML = '<p class="text-muted">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>';
      } else {
        renderHistoryMessages(container, messages, ticket_id);
      }

      container.scrollTop = container.scrollHeight;
	  parseEmojis(container);

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
      const modal = new bootstrap.Modal(document.getElementById('historyModal'));
      modal.show();

      if (historyPolling) clearInterval(historyPolling);
      historyPolling = setInterval(() => loadHistoryMessagesOnly(user_id, ticket_id), 5000);
    }

    // === –¢–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è ===
    async function loadHistoryMessagesOnly(user_id, ticket_id) {
      if (currentUserId !== user_id) return;

      let data;
      try {
        data = await fetchJsonWithAuth(`/history?user_id=${user_id}&ticket_id=${ticket_id}`, { cache: 'no-store' }) || {};
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
        return;
      }

      const container = document.getElementById('historyContent');

      if (!container) return;

      container.innerHTML = '';

      const messages = Array.isArray(data.messages) ? data.messages : [];

      renderHistoryMessages(container, messages, ticket_id);

      container.scrollTop = container.scrollHeight;
          parseEmojis(container);
    }

    // === –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ ===
    document.addEventListener('DOMContentLoaded', function() {
      const sendButton = document.getElementById('sendReplyInHistory');
      if (sendButton) {
        sendButton.onclick = async function () {
          const textElement = document.getElementById('replyTextInHistory');
          if (!textElement) return;
          
          const text = textElement.value.trim();
          const admin = "{{ session.user or '–ü–æ–¥–¥–µ—Ä–∂–∫–∞' }}";
          
          if (!text) {
            alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞');
            return;
          }

          const response = await fetch('/reply', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              user_id: currentUserId, 
              text, 
              admin,
              ticket_id: currentTicketId 
            })
          });

          const data = await response.json();
          if (data.success) {
			  textElement.value = '';
			  // –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
			  loadHistoryMessagesOnly(currentUserId, currentTicketId);

			  // –µ—Å–ª–∏ —Ç–∏–∫–µ—Ç –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç ‚Äî –æ–±–Ω–æ–≤–∏–º —Å—Ç–∞—Ç—É—Å –∏ –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è
			  try {
				const resp = await fetch(`/tickets/${currentTicketId}`);
				const t = await resp.json();
				const closeButton = document.getElementById('closeTicketBtn');
				const isResolved = t?.status === 'resolved';
				if (closeButton) {
				  closeButton.disabled = !!isResolved;
				  closeButton.classList.toggle('disabled', !!isResolved);
				  closeButton.title = isResolved ? '–ó–∞—è–≤–∫–∞ —É–∂–µ –∑–∞–∫—Ä—ã—Ç–∞' : '';
				}
			  } catch (e) {
				console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ç–∏–∫–µ—Ç–∞ –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞', e);
			  }

			  // –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä —Å–æ–æ–±—â–∏–ª, —á—Ç–æ –±—ã–ª–æ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏–µ ‚Äî –º–æ–∂–Ω–æ –Ω–µ–Ω–∞–≤—è–∑—á–∏–≤–æ –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å
			  if (data.reopened) {
				// –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–∫–∞–∑–∞—Ç—å –∫—Ä–∞—Ç–∫–∏–π toast/alert –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏
				console.debug('–ó–∞—è–≤–∫–∞ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∞');
			  }
			} else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
          }
        };
      }

      // === –ó–∞–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É ===
      const closeButton = document.getElementById('closeTicketBtn');
      if (closeButton) {
        closeButton.onclick = function () {
          const modal = new bootstrap.Modal(document.getElementById('closeTicketModal'));
          const select = document.getElementById('categorySelect');
          
          if (select) {
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>';
            window.settings.categories.forEach(cat => {
              const option = document.createElement('option');
              option.value = cat;
              option.textContent = cat;
              select.appendChild(option);
            });
          }
          
          modal.show();
        };
      }

      // === –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ ===
      const confirmButton = document.getElementById('confirmCloseTicketBtn');
      if (confirmButton) {
        confirmButton.onclick = async function () {
          const select = document.getElementById('categorySelect');
          if (!select) return;
          
          const category = select.value;
          if (!category) {
            alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
            return;
          }

          const admin = getOperatorName();

          let completed = false;
          try {
            confirmButton.disabled = true;

            const response = await fetch('/close_ticket', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                user_id: currentUserId,
                admin,
                category,
                ticket_id: currentTicketId
              })
            });

          const data = await response.json();
            if (!data.success) {
              alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É'));
              return;
            }

          completed = true;

            const closeModal = document.getElementById('closeTicketModal');
            if (closeModal) {
              const instance = bootstrap.Modal.getInstance(closeModal);
              instance?.hide();
            }

            const successModal = document.getElementById('ticketClosedModal');
            if (successModal) {
              bootstrap.Modal.getOrCreateInstance(successModal).show();
            } else {
              alert('‚úÖ –ó–∞—è–≤–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞');
              location.reload();
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –∑–∞—è–≤–∫–∏:', error);
            alert('‚ùå –û—à–∏–±–∫–∞: ' + (error?.message || error));
          } finally {
            if (!completed) {
              confirmButton.disabled = false;
            }
          }
        };
      }
    });

    // === –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ ===
    async function saveClientName() {
      const newNameInput = document.getElementById('newClientName');
      if (!newNameInput) return;
      
      const newName = newNameInput.value.trim();
      const user_id = {{ client.user_id }};
      
      if (!newName || newName === '–Ω–µ –∑–∞–¥–∞–Ω–æ') return;

      const response = await fetch('/update_client_name', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id, client_name: newName })
      });

      const data = await response.json();
      if (data.success) {
        const nameDisplay = document.getElementById('clientNameDisplay');
        if (nameDisplay) {
          nameDisplay.textContent = newName;
        }
        bootstrap.Modal.getInstance(document.getElementById('editClientNameModal')).hide();
        alert('‚úÖ –ò–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
      } else {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
      }
    }

    // === –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞ ===
    async function saveClientStatus() {
      const statusSelect = document.getElementById('newClientStatus');
      if (!statusSelect) return;
      
      const newStatus = statusSelect.value;
      const user_id = {{ client.user_id }};
      
      if (!newStatus || newStatus === '–Ω–µ –∑–∞–¥–∞–Ω–æ') return;

      const response = await fetch('/client/' + user_id + '/status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ client_status: newStatus })
      });

      const data = await response.json();
      if (data.success) {
        const statusDisplay = document.getElementById('clientStatusDisplay');
        if (statusDisplay) {
          statusDisplay.textContent = newStatus;
        }
        bootstrap.Modal.getInstance(document.getElementById('editClientStatusModal')).hide();
        alert('‚úÖ –°—Ç–∞—Ç—É—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
      } else {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
      }
    }
</script>
<script src="{{ url_for('static', filename='edit-guard.js') }}"></script>
<script>
	async function addManualPhone(userId){
	  const phone = (document.getElementById('newPhoneInput')?.value || '').trim();
	  const label = (document.getElementById('newPhoneLabelInput')?.value || '').trim();
	  if(!phone){ alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω'); return; }
	  const r = await fetch(`/client/${userId}/phones`, {
		method:'POST', headers:{'Content-Type':'application/json'},
		body: JSON.stringify({phone, label})
	  });
	  const j = await r.json();
	  if(!j.success){ alert('–û—à–∏–±–∫–∞: '+(j.error||'–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')); return; }
	  location.reload();
	}

        async function savePhoneLabel(userId, phoneId, btn){
          const tr = btn.closest('tr');
          const inp = tr.querySelector('.phone-label-input');
          const label = inp ? inp.value.trim() : '';
          const r = await fetch(`/client/${userId}/phones/${phoneId}`, {
                method:'PATCH', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({label})
          });
          const j = await r.json();
          if(!j.success){ alert('–û—à–∏–±–∫–∞: '+(j.error||'–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')); return; }
          if (inp) {
            inp.dataset.originalLabel = label;
          }
          updateBulkSaveButtonState();
          const card = document.getElementById('clientPhonesCard');
          if (card && window.EditGuard) {
            window.EditGuard.refreshBlockSnapshot(card);
          }
          btn.classList.remove('btn-outline-primary');
          btn.classList.add('btn-success');
          setTimeout(()=>{ btn.classList.remove('btn-success'); btn.classList.add('btn-outline-primary'); }, 700);
        }

        async function archivePhone(userId, phoneId, btn){
          if(!confirm('–£–±—Ä–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö?')) return;
          const r = await fetch(`/client/${userId}/phones/${phoneId}`, {
                method:'PATCH', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({is_active:false})
          });
          const j = await r.json();
          if(!j.success){ alert('–û—à–∏–±–∫–∞: '+(j.error||'–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')); return; }
          btn.closest('tr')?.remove();
          updateBulkSaveButtonState();
          const card = document.getElementById('clientPhonesCard');
          if (card && window.EditGuard) {
            window.EditGuard.refreshBlockSnapshot(card);
          }
        }

        function collectManualPhoneUpdates() {
          const rows = Array.from(document.querySelectorAll('#manualPhonesTbody tr[data-id]'));
          return rows
            .map((row) => {
              const input = row.querySelector('.phone-label-input');
              if (!input) return null;
              const phoneId = Number(row.dataset.id);
              if (!Number.isFinite(phoneId)) return null;
              const original = (input.dataset.originalLabel || '').trim();
              const current = (input.value || '').trim();
              if (original === current) return null;
              return { id: phoneId, label: current, input };
            })
            .filter(Boolean);
        }

        function updateBulkSaveButtonState() {
          const bulkBtn = document.getElementById('bulkSavePhonesBtn');
          if (!bulkBtn) return;
          const hasChanges = collectManualPhoneUpdates().length > 0;
          bulkBtn.disabled = !hasChanges;
        }

        async function bulkSaveManualPhoneLabels(options = {}) {
          const keepEditing = options.keepEditing === true;
          const silent = options.silent === true;
          const card = document.getElementById('clientPhonesCard');
          const bulkBtn = document.getElementById('bulkSavePhonesBtn');
          const updates = collectManualPhoneUpdates();

          if (!updates.length) {
            if (card && window.EditGuard) {
              window.EditGuard.refreshBlockSnapshot(card);
            }
            updateBulkSaveButtonState();
            return true;
          }

          let originalHtml = '';
          if (bulkBtn) {
            originalHtml = bulkBtn.innerHTML;
            bulkBtn.disabled = true;
            bulkBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶';
          }

          try {
            for (const entry of updates) {
              const response = await fetch(`/client/{{ client.user_id }}/phones/${entry.id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ label: entry.label })
              });
              const data = await response.json();
              if (!data.success) {
                throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è');
              }
              if (entry.input) {
                entry.input.dataset.originalLabel = entry.label;
              }
            }

            if (!silent) {
              alert('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
            }

            if (card && window.EditGuard) {
              if (keepEditing) {
                window.EditGuard.refreshBlockSnapshot(card);
              } else {
                window.EditGuard.markBlockSaved(card);
              }
            }

            return true;
          } catch (error) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤: ' + (error?.message || error));
            return false;
          } finally {
            if (bulkBtn) {
              bulkBtn.innerHTML = originalHtml || 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
              updateBulkSaveButtonState();
            }
          }
        }

        document.addEventListener('DOMContentLoaded', () => {
          const phoneCard = document.getElementById('clientPhonesCard');
          const bulkBtn = document.getElementById('bulkSavePhonesBtn');

          document.querySelectorAll('#manualPhonesTbody .phone-label-input').forEach((input) => {
            input.dataset.originalLabel = (input.value || '').trim();
            input.addEventListener('input', updateBulkSaveButtonState);
            input.addEventListener('change', updateBulkSaveButtonState);
          });

          updateBulkSaveButtonState();

          if (phoneCard && window.EditGuard) {
            window.EditGuard.registerBlock(phoneCard, {
              onSave: () => bulkSaveManualPhoneLabels({ keepEditing: false, silent: true }),
              onDirtyChange: () => updateBulkSaveButtonState()
            });

            if (bulkBtn) {
              bulkBtn.addEventListener('click', async () => {
                const success = await bulkSaveManualPhoneLabels({ keepEditing: true });
                if (success && phoneCard && window.EditGuard) {
                  window.EditGuard.refreshBlockSnapshot(phoneCard);
                }
              });
            }
          }
        });
</script>
<script>
        (function () {
          const modalEl  = document.getElementById('avatarModal');
          const modalImg = document.getElementById('avatarModalImg');
          const modalTitle = document.getElementById('avatarModalTitle');
          const fallbackImage = SUPPORT_AVATAR_FALLBACK;

          function applyAvatarModalState(src, type) {
            if (!modalImg) return;
            const viewType = type === 'support' ? 'support' : 'client';
            modalImg.src = src;
            modalImg.alt = viewType === 'support' ? '–§–æ—Ç–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞' : '–§–æ—Ç–æ –∫–ª–∏–µ–Ω—Ç–∞';
            if (modalTitle) {
              modalTitle.textContent = viewType === 'support' ? '–§–æ—Ç–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞' : '–§–æ—Ç–æ –∫–ª–∏–µ–Ω—Ç–∞';
            }
          }

          window.openAvatarModal = function (src, options = {}) {
            if (!modalEl || !modalImg) return;
            const type = options.type === 'support' ? 'support' : 'client';
            const fallback = (options.fallback && typeof options.fallback === 'string')
              ? options.fallback
              : fallbackImage;
            const displaySrc = (typeof src === 'string' && src.trim()) ? src : fallback;
            applyAvatarModalState(displaySrc, type);
            bootstrap.Modal.getOrCreateInstance(modalEl).show();
          };

          const profileAva = document.getElementById('clientAvatarProfile');
          if (profileAva) {
            profileAva.style.cursor = 'zoom-in';
            profileAva.addEventListener('click', () => {
              openAvatarModal(profileAva.dataset.fullsrc || profileAva.src, {
                type: 'client',
                fallback: profileAva.dataset.fallback || fallbackImage,
              });
            });
          }
        })();
</script>

<!-- Twemoji -->
<script src="{{ url_for('static', filename='vendor/twemoji/twemoji.min.js') }}"></script>
<script>
	  function parseEmojis(root) {
		try {
		  if (!window.twemoji) return;
		  twemoji.parse(root || document.body, {
			folder: 'svg',
			ext: '.svg',
			base: "{{ url_for('static', filename='vendor/twemoji/') }}",
			className: 'emoji'
		  });
		} catch (e) {}
	  }
	  document.addEventListener('DOMContentLoaded', function () { parseEmojis(document.body); });

	(function(){
	  const img = document.getElementById('clientAvatarProfile');
	  if (!img) return;
	  const srcHint = img.getAttribute('data-src');
	  if (srcHint) {
		// –¥–µ—Ä–≥–∞–µ–º /avatar/<id>?src=<url>, —á—Ç–æ–±—ã –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é
		const url = new URL(img.src, location.origin);
		url.searchParams.set('src', srcHint);
		fetch(url.toString()).catch(()=>{});
	  }

	  // –ø–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é (–ø—Ä–∏–º–µ—Ä)
	  const historyBox = document.getElementById('avatarHistory');
	  if (historyBox) {
		fetch(`/api/client/{{ client.user_id }}/avatar_history`)
		  .then(r => r.ok ? r.json() : [])
		  .then(list => {
			if (!Array.isArray(list) || !list.length) return;
			historyBox.innerHTML = list.map(x => `
			  <div class="small text-muted">${x.at}: ${x.url}</div>
			`).join('');
		  }).catch(()=>{});
	  }
	})();
</script>

<script>
	  function parseEmojis(root) {
		try {
		  twemoji.parse(root || document.body, { folder: 'svg', ext: '.svg', className: 'emoji' });
		} catch (e) {}
	  }
	  document.addEventListener('DOMContentLoaded', function () { parseEmojis(document.body); });
</script>
<script>
        document.addEventListener('DOMContentLoaded', () => {
          const blacklistModalEl = document.getElementById('blacklistModal');
          const blacklistForm = document.getElementById('blacklistForm');
          const reasonInput = document.getElementById('blacklistReason');
          const userIdPlaceholder = blacklistModalEl?.querySelector('[data-blacklist-user-id]');
          const submitButton = blacklistModalEl?.querySelector('[data-blacklist-submit]');
          const submitText = blacklistModalEl?.querySelector('[data-blacklist-submit-text]');
          const loadingSpinner = blacklistModalEl?.querySelector('[data-blacklist-loading]');
          const feedbackError = blacklistModalEl?.querySelector('[data-blacklist-feedback="error"]');
          const feedbackSuccess = blacklistModalEl?.querySelector('[data-blacklist-feedback="success"]');
          let blacklistModalInstance = null;

          function getModalInstance() {
            if (!blacklistModalEl || typeof bootstrap === 'undefined' || !bootstrap.Modal) {
              return null;
            }
            if (!blacklistModalInstance) {
              blacklistModalInstance = new bootstrap.Modal(blacklistModalEl);
            }
            return blacklistModalInstance;
          }

          function resetFeedback() {
            [feedbackError, feedbackSuccess].forEach((node) => {
              if (!node) return;
              node.classList.add('d-none');
              node.textContent = '';
            });
          }

          function showFeedback(type, message) {
            resetFeedback();
            const target = type === 'success' ? feedbackSuccess : feedbackError;
            if (!target) return;
            target.textContent = message;
            target.classList.remove('d-none');
          }

          function setLoading(isLoading) {
            if (!submitButton) return;
            submitButton.disabled = isLoading;
            if (submitText) {
              submitText.classList.toggle('d-none', isLoading);
            }
            if (loadingSpinner) {
              loadingSpinner.classList.toggle('d-none', !isLoading);
            }
          }

          window.openBlacklistModal = function (userId) {
            const modal = getModalInstance();
            if (!modal) return;
            blacklistModalEl.dataset.userId = userId || '';
            if (userIdPlaceholder) {
              userIdPlaceholder.textContent = userId || '‚Äî';
            }
            if (reasonInput) {
              reasonInput.value = '';
              reasonInput.classList.remove('is-invalid');
            }
            resetFeedback();
            setLoading(false);
            modal.show();
            setTimeout(() => {
              reasonInput?.focus();
            }, 150);
          };

          if (blacklistForm) {
            blacklistForm.addEventListener('submit', async (event) => {
              event.preventDefault();
              resetFeedback();
              if (!blacklistModalEl) return;
              const userId = blacklistModalEl.dataset.userId;
              const reason = (reasonInput?.value || '').trim();

              if (reasonInput) {
                if (!reason) {
                  reasonInput.classList.add('is-invalid');
                  return;
                }
                reasonInput.classList.remove('is-invalid');
              }

              if (!userId) {
                showFeedback('error', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.');
                return;
              }

              setLoading(true);
              try {
                const response = await fetch('/api/blacklist/add', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ user_id: userId, reason })
                });
                let payload = {};
                try {
                  payload = await response.json();
                } catch (jsonError) {
                  payload = {};
                }

                if (!response.ok || !payload.ok) {
                  const errorMessage = payload.error || `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ (–∫–æ–¥ ${response.status}).`;
                  throw new Error(errorMessage);
                }

                showFeedback('success', '–ö–ª–∏–µ–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∞.');
                setTimeout(() => {
                  getModalInstance()?.hide();
                  location.reload();
                }, 900);
              } catch (error) {
                showFeedback('error', error?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞.');
              } finally {
                setLoading(false);
              }
            });
          }

          window.blacklistRemove = async function (userId) {
            if (!userId) {
              alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.');
              return;
            }

            try {
              const response = await fetch('/api/blacklist/remove', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId })
              });
              let payload = {};
              try {
                payload = await response.json();
              } catch (jsonError) {
                payload = {};
              }

              if (!response.ok || !payload.ok) {
                const errorMessage = payload.error || `–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ (–∫–æ–¥ ${response.status}).`;
                throw new Error(errorMessage);
              }

              alert('–ö–ª–∏–µ–Ω—Ç —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
              location.reload();
            } catch (error) {
              alert('–û—à–∏–±–∫–∞: ' + (error?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞.'));
            }
          };

          const rejectModalEl = document.getElementById('rejectUnblockModal');
          const rejectForm = document.getElementById('rejectUnblockForm');
          const rejectUserPlaceholder = rejectModalEl?.querySelector('[data-reject-user-id]');
          const rejectCommentInput = rejectModalEl?.querySelector('[data-reject-comment]');
          const rejectSubmitButton = rejectModalEl?.querySelector('[data-reject-submit]');
          const rejectSubmitText = rejectModalEl?.querySelector('[data-reject-submit-text]');
          const rejectLoadingSpinner = rejectModalEl?.querySelector('[data-reject-loading]');
          const rejectFeedbackError = rejectModalEl?.querySelector('[data-reject-feedback="error"]');
          const rejectFeedbackSuccess = rejectModalEl?.querySelector('[data-reject-feedback="success"]');
          let rejectModalInstance = null;

          function getRejectModalInstance() {
            if (!rejectModalEl || typeof bootstrap === 'undefined' || !bootstrap.Modal) {
              return null;
            }
            if (!rejectModalInstance) {
              rejectModalInstance = new bootstrap.Modal(rejectModalEl);
            }
            return rejectModalInstance;
          }

          function resetRejectFeedback() {
            if (rejectFeedbackError) {
              rejectFeedbackError.classList.add('d-none');
              rejectFeedbackError.textContent = '';
            }
            if (rejectFeedbackSuccess) {
              rejectFeedbackSuccess.classList.add('d-none');
              rejectFeedbackSuccess.textContent = '';
            }
          }

          function setRejectLoading(isLoading) {
            if (rejectSubmitButton) {
              rejectSubmitButton.disabled = isLoading;
            }
            if (rejectSubmitText) {
              rejectSubmitText.classList.toggle('d-none', isLoading);
            }
            if (rejectLoadingSpinner) {
              rejectLoadingSpinner.classList.toggle('d-none', !isLoading);
            }
          }

          window.openRejectUnblockModal = function (userId) {
            const modal = getRejectModalInstance();
            if (!modal) return;
            rejectModalEl.dataset.userId = userId || '';
            if (rejectUserPlaceholder) {
              rejectUserPlaceholder.textContent = userId || '‚Äî';
            }
            if (rejectCommentInput) {
              rejectCommentInput.value = '';
            }
            resetRejectFeedback();
            setRejectLoading(false);
            modal.show();
            setTimeout(() => {
              rejectCommentInput?.focus();
            }, 150);
          };

          if (rejectForm) {
            rejectForm.addEventListener('submit', async (event) => {
              event.preventDefault();
              resetRejectFeedback();
              if (!rejectModalEl) return;
              const userId = rejectModalEl.dataset.userId;
              const comment = (rejectCommentInput?.value || '').trim();

              if (!userId) {
                if (rejectFeedbackError) {
                  rejectFeedbackError.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –æ—Ç–∫–∞–∑–∞.';
                  rejectFeedbackError.classList.remove('d-none');
                }
                return;
              }

              setRejectLoading(true);
              try {
                const response = await fetch('/api/blacklist/reject-request', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ user_id: userId, comment })
                });
                let payload = {};
                try {
                  payload = await response.json();
                } catch (jsonError) {
                  payload = {};
                }

                if (!response.ok || !payload.ok) {
                  const errorMessage = payload.error || `–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å (–∫–æ–¥ ${response.status}).`;
                  throw new Error(errorMessage);
                }

                if (rejectFeedbackSuccess) {
                  rejectFeedbackSuccess.textContent = '–†–µ—à–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∞.';
                  rejectFeedbackSuccess.classList.remove('d-none');
                }
                setTimeout(() => {
                  getRejectModalInstance()?.hide();
                  location.reload();
                }, 900);
              } catch (error) {
                if (rejectFeedbackError) {
                  rejectFeedbackError.textContent = error?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å.';
                  rejectFeedbackError.classList.remove('d-none');
                }
              } finally {
                setRejectLoading(false);
              }
            });
          }

          const ticketClosedModalEl = document.getElementById('ticketClosedModal');
          if (ticketClosedModalEl) {
            ticketClosedModalEl.addEventListener('hidden.bs.modal', () => {
              location.reload();
            });
          }
        });

        window.currentUser = CURRENT_OPERATOR;
</script>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ -->
        <div class="modal fade" id="blacklistModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog">
                <form class="modal-content" id="blacklistForm" novalidate>
                  <div class="modal-header">
                        <h5 class="modal-title">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                  </div>
                  <div class="modal-body">
                        <p class="mb-3">
                          –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ <code data-blacklist-user-id>{{ client.user_id }}</code>.
                        </p>
                        <div class="mb-3">
                          <label for="blacklistReason" class="form-label">–ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏</label>
                          <textarea class="form-control" id="blacklistReason" name="reason" rows="3" required></textarea>
                          <div class="invalid-feedback">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.</div>
                        </div>
                        <div class="alert alert-danger d-none" role="alert" data-blacklist-feedback="error"></div>
                        <div class="alert alert-success d-none" role="alert" data-blacklist-feedback="success"></div>
                  </div>
                  <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-danger" data-blacklist-submit>
                          <span data-blacklist-submit-text>–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</span>
                          <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true" data-blacklist-loading></span>
                        </button>
                  </div>
                </form>
          </div>
        </div>

        <div class="modal fade" id="rejectUnblockModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog">
            <form class="modal-content" id="rejectUnblockForm" novalidate>
              <div class="modal-header">
                <h5 class="modal-title">–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫—É</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
              </div>
              <div class="modal-body">
                <p class="mb-3">
                  –£–∫–∞–∂–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ <code data-reject-user-id>{{ client.user_id }}</code> (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ).
                </p>
                <div class="mb-3">
                  <label for="rejectUnblockComment" class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</label>
                  <textarea class="form-control" id="rejectUnblockComment" name="comment" rows="3" data-reject-comment></textarea>
                  <div class="form-text">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏ –∏ –±—É–¥–µ—Ç –≤–∏–¥–µ–Ω –∫–æ–ª–ª–µ–≥–∞–º.</div>
                </div>
                <div class="alert alert-danger d-none" role="alert" data-reject-feedback="error"></div>
                <div class="alert alert-success d-none" role="alert" data-reject-feedback="success"></div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-warning" data-reject-submit>
                  <span data-reject-submit-text>–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å</span>
                  <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true" data-reject-loading></span>
                </button>
              </div>
            </form>
          </div>
        </div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è -->
        <div class="modal fade small-modal" id="ticketClosedModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content text-center p-4">
                  <div class="modal-body">
                        <h5 class="mb-2">–ó–∞—è–≤–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞</h5>
                        <p class="text-muted mb-0">–û–±—Ä–∞—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ –≤ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.</p>
                  </div>
                  <div class="modal-footer justify-content-center border-0">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">–û–∫</button>
                  </div>
                </div>
          </div>
        </div>
<!-- Modal: —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞ -->
        <div class="modal fade" id="avatarModal" tabindex="-1" aria-hidden="true" aria-labelledby="avatarModalTitle">
          <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content bg-dark text-white border-0">
                  <div class="modal-header border-0 justify-content-between align-items-start">
                        <h5 class="modal-title text-white mb-0" id="avatarModalTitle">–§–æ—Ç–æ –∫–ª–∏–µ–Ω—Ç–∞</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                  </div>
                  <div class="modal-body p-0 text-center">
                        <img id="avatarModalImg" src="" class="img-fluid rounded" alt="–§–æ—Ç–æ –∫–ª–∏–µ–Ω—Ç–∞">
                  </div>
                  <div class="modal-footer border-0 justify-content-center">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                  </div>
                </div>
          </div>
        </div>
  </main>
  <script src="{{ url_for('static', filename='sidebar.js') }}"></script>
  <script src="{{ url_for('static', filename='modal-transitions.js') }}"></script>
</body>
</html>
