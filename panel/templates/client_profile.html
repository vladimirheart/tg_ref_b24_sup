<!-- panel/templates/client_profile.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–ª–∏–µ–Ω—Ç {{ client.user_id }} ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='sidebar.css') }}" rel="stylesheet" />
  <style>
    .chat-bubble { 
      padding: 8px 12px; 
      border-radius: 8px; 
      margin-bottom: 6px; 
      max-width: 80%; 
      word-wrap: break-word;
    }
	/* ‚Üë –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏ —ç–º–æ–¥–∑–∏ –≤ –ø—É–∑—ã—Ä—è—Ö —Å–æ–æ–±—â–µ–Ω–∏–π ~–≤ 1.5 —Ä–∞–∑–∞ */
	.chat-bubble { 
	  font-size: 1.5em;      /* –±—ã–ª–æ 1em –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Üí —Å—Ç–∞–ª–æ ~1.5x */
	  line-height: 1.35;
	}
	.chat-bubble img.emoji {  /* —Ç–≤–µ–º–æ—ò–∏ —Ä–∞—Å—Ç—è–≥–∏–≤–∞—é—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å —Ç–µ–∫—Å—Ç–æ–º */
	  height: 1em;
	  width: 1em;
	  vertical-align: -0.1em;
	}

    .from-user { background: #e3f2fd; align-self: flex-end; }
    .from-support { background: #d1f7d1; align-self: flex-start; }

    .chat-container { 
      min-height: 300px; 
      max-height: 500px; 
      overflow-y: auto; 
      padding: 10px; 
      background: #f8f9fa;
      border-radius: 8px;
    }

    /* ‚úÖ –ß—ë—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç */
    .chat-bubble p, .chat-bubble small, .chat-bubble strong {
      color: #000 !important;
    }

    /* ‚úÖ –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫–∞ */
    .input-group-send {
      display: flex;
      align-items: stretch;
      gap: 8px;
    }
    .input-group-send textarea {
      flex: 1;
      resize: both;
      min-height: 60px;
      max-height: 200px;
    }
    .input-group-send .btn {
      white-space: nowrap;
    }
    .modal.small-modal {
      align-items: center;
      justify-content: center;
    }

    .modal.small-modal.show {
      display: flex !important;
    }

    .modal.small-modal .modal-dialog {
      margin: 0;
      position: relative;
      top: 0;
      transform: none;
    }

    .small-modal {
      align-items: center;
      justify-content: center;
    }

    .small-modal.show {
      display: flex !important;
    }

    .small-modal .modal-dialog {
      margin: 0;
      position: relative;
      top: 0;
      transform: none;
    }

    #ticketClosedModal .modal-dialog {
      margin: 0;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      position: fixed;
    }

    /* ‚úÖ –°—Ç–∏–ª–∏ –¥–ª—è –±–∏–∑–Ω–µ—Å–æ–≤ */
    .business-sushi { background-color: #F25F79 !important; color: white !important; }
    .business-blin { background-color: #FFD504 !important; color: black !important; }

    /* ‚úÖ –°—Ç–∏–ª–∏ –¥–ª—è resize —Å—Ç–æ–ª–±—Ü–æ–≤ */
    .table th {
      position: relative;
      user-select: none;
    }
    .resize-handle {
      position: absolute;
      top: 0;
      right: 0;
      width: 5px;
      height: 100%;
      background-color: #ddd;
      cursor: col-resize;
      user-select: none;
    }

    /* ‚úÖ –ö–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç */
    .clickable-client {
      cursor: pointer;
      color: #0d6efd;
      text-decoration: underline;
    }
    .clickable-client:hover {
      text-decoration: none;
      background-color: #f0f8ff;
    }
	
	/* Twemoji: –¥–µ–ª–∞–µ–º —ç–º–æ–¥–∑–∏ —Ä–∞–∑–º–µ—Ä–æ–º —Å —Ç–µ–∫—Å—Ç */
	img.emoji {
	  height: 1em;
	  width: 1em;
	  margin: 0 .05em 0 .1em;
	  vertical-align: -0.1em;
	}
/* Twemoji –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –∫–ª–∏–µ–Ω—Ç–∞ */
#profileModal img.emoji,
#profileModal .msg-text img.emoji,
#profileModal .msg-author img.emoji {
  width: 1.1em;
  height: 1.1em;
  max-width: none;
  max-height: none;
  vertical-align: -0.12em;
  margin: 0 .06em;
  border: 0;
  padding: 0;
  background: transparent;
  box-shadow: none;
}

  </style>
</head>
<body class="with-sidebar sidebar-pinned">
  {% include "_sidebar.html" %}
  <main class="main-content container-fluid">
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
	  <h2>üë§ –ö–∞—Ä—Ç–æ—á–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞</h2>
	  <div class="d-flex align-items-center gap-2">
		<a href="/clients" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥</a>
		<button class="btn btn-sm btn-outline-danger"
				onclick="blacklistAdd('{{ client.user_id }}')">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
		<button class="btn btn-sm btn-success"
				onclick="blacklistRemove('{{ client.user_id }}')">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
	  </div>
	</div>

    <div class="card mb-4">
      <div class="card-body">
        <h5>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
		<div class="d-flex align-items-center gap-3 mb-3">
			  <img id="clientAvatarProfile"
				 src="/avatar/{{ client.user_id }}"
				 data-src="{{ client.photo_url or '' }}"
				 data-fullsrc="/avatar/{{ client.user_id }}?full=1"
				 width="72" height="72"
				 class="rounded-circle"
				 style="object-fit:cover;border:1px solid rgba(0,0,0,1);cursor:zoom-in"
				 alt="avatar"
				 onerror="this.onerror=null;this.src='/static/avatar_default.svg';">
			  <div>
				<div><strong>ID Telegram:</strong> <code>{{ client.user_id }}</code></div>
				<div><strong>–Æ–∑–µ—Ä–Ω–µ–π–º:</strong> {{ client.username or '‚Äî' }}</div>
				<p class="mb-1"><strong>Blacklist:</strong>
				  {% if client_blacklist and client_blacklist.is_blacklisted %}
					<span class="badge text-bg-danger">–î–∞</span>
					{% if client_blacklist.unblock_requested %}
					  <span class="badge text-bg-warning ms-1">–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–Ω—è—Ç–∏–µ</span>
					{% endif %}
				  {% else %}
					<span class="badge text-bg-secondary">–ù–µ—Ç</span>
				  {% endif %}
				</p>
			  </div>
		</div>
		<div id="avatarHistory" class="mt-2"></div>
        <p><strong>ID Telegram:</strong> <code>{{ client.user_id }}</code></p>
        <p><strong>–Æ–∑–µ—Ä–Ω–µ–π–º –≤ Telegram:</strong> {{ client.username or '‚Äî' }}</p>
        <p><strong>–ò–º—è –≤ –ë–î:</strong> <span id="clientNameDisplay">{{ client.client_name or '‚Äî' }}</span></p>
        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editClientNameModal">
          ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–º—è
        </button>

        <hr>

        <p><strong>–°—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞:</strong> <span id="clientStatusDisplay">{{ client_status or '‚Äî' }}</span></p>
        <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#editClientStatusModal">
          üè∑Ô∏è –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å
        </button>
      </div>
    </div>

	<div class="card mb-4">
	  <div class="card-body">
		<h5>üìù –ò—Å—Ç–æ—Ä–∏—è —é–∑–µ—Ä–Ω–µ–π–º–∞</h5>
		{% if username_history and username_history|length > 0 %}
		  <ul class="list-group">
			{% for u in username_history %}
			  <li class="list-group-item d-flex justify-content-between align-items-center">
				<span>
				  {% if loop.first %}
					<span class="badge bg-success me-2">–¢–µ–∫—É—â–∏–π</span>
				  {% endif %}
				  @{{ u.username }}
				</span>
				<small class="text-muted">{{ u.seen_at }}</small>
			  </li>
			{% endfor %}
		  </ul>
		{% else %}
		  <p class="text-muted mb-0">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—é —é–∑–µ—Ä–Ω–µ–π–º–∞</p>
		{% endif %}
	  </div>
	</div>

<div class="card mb-4">
  <div class="card-body">
    <h5>üìû –¢–µ–ª–µ—Ñ–æ–Ω—ã –∫–ª–∏–µ–Ω—Ç–∞</h5>

    <h6 class="mt-2">–ò–∑ Telegram (—Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è)</h6>
    {% if phones_telegram and phones_telegram|length > 0 %}
      <ul class="list-group mb-3">
        {% for p in phones_telegram %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span><strong>{{ p.phone }}</strong> <span class="text-muted">({{ p.label or '–∏–∑ Telegram' }})</span></span>
            <small class="text-muted">{{ p.created_at }}</small>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-muted">–ö–ª–∏–µ–Ω—Ç –µ—â—ë –Ω–µ –ø–æ–¥–µ–ª–∏–ª—Å—è –Ω–æ–º–µ—Ä–æ–º —á–µ—Ä–µ–∑ Telegram.</p>
    {% endif %}

    <h6 class="mt-3">–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é</h6>
    <div class="table-responsive">
      <table class="table align-middle">
        <thead><tr><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–ú–µ—Ç–∫–∞</th><th>–î–æ–±–∞–≤–ª–µ–Ω</th><th></th></tr></thead>
        <tbody id="manualPhonesTbody">
          {% for p in phones_manual %}
          <tr data-id="{{ p.id }}">
            <td><strong>{{ p.phone }}</strong></td>
            <td>
              <input class="form-control form-control-sm phone-label-input" value="{{ p.label or '' }}" placeholder="–ª–∏—á–Ω—ã–π/—Ä–∞–±–æ—á–∏–π/‚Ä¶">
            </td>
            <td><small class="text-muted">{{ p.created_at }}</small></td>
            <td class="text-end">
              <button class="btn btn-sm btn-outline-primary" onclick="savePhoneLabel({{ client.user_id }}, {{ p.id }}, this)">üíæ</button>
              <button class="btn btn-sm btn-outline-danger" onclick="archivePhone({{ client.user_id }}, {{ p.id }}, this)">üóë</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="row g-2 mt-2">
      <div class="col-md-4">
        <input id="newPhoneInput" class="form-control" placeholder="+7‚Ä¶">
      </div>
      <div class="col-md-4">
        <input id="newPhoneLabelInput" class="form-control" placeholder="–ª–∏—á–Ω—ã–π / —Ä–∞–±–æ—á–∏–π / –¥—Ä—É–≥–æ–µ">
      </div>
      <div class="col-md-4">
        <button class="btn btn-primary w-100" onclick="addManualPhone({{ client.user_id }})">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω</button>
      </div>
    </div>
  </div>
</div>
	
    <h4>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card text-center">
          <div class="card-body">
            <h5>{{ stats.total }}</h5>
            <p class="text-muted">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card text-center">
          <div class="card-body">
            <h5>{{ stats.resolved }}</h5>
            <p class="text-success">–†–µ—à–µ–Ω–æ</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card text-center">
          <div class="card-body">
            <h5>{{ stats.pending }}</h5>
            <p class="text-warning">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</p>
          </div>
        </div>
      </div>
    </div>

    <!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Ç–µ–º–∞–º –∏ –ª–æ–∫–∞—Ü–∏—è–º -->
    <h4>üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –æ–±—Ä–∞—â–µ–Ω–∏—è–º</h4>
    <div class="card mb-4">
      <div class="card-body">
        <h6>–¢–µ–º—ã –æ–±—Ä–∞—â–µ–Ω–∏–π</h6>
        <ul class="list-group mb-3">
          {% set categories = {} %}
          {% for t in tickets %}
            {% if t.category %}
              {% if t.category not in categories %}
                {% set _ = categories.update({t.category: 1}) %}
              {% else %}
                {% set _ = categories.update({t.category: categories[t.category] + 1}) %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% for cat, cnt in categories.items() %}
          <li class="list-group-item d-flex justify-content-between">
            <span>{{ cat }}</span>
            <span class="badge bg-info">{{ cnt }}</span>
          </li>
          {% endfor %}
        </ul>

        <h6>–õ–æ–∫–∞—Ü–∏–∏</h6>
        <ul class="list-group">
          {% set locations = {} %}
          {% for t in tickets %}
            {% set loc = t.city + ' ‚Äî ' + (t.location_name or '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è') %}
            {% if loc not in locations %}
              {% set _ = locations.update({loc: 1}) %}
            {% else %}
              {% set _ = locations.update({loc: locations[loc] + 1}) %}
            {% endif %}
          {% endfor %}
          {% for loc, cnt in locations.items() %}
          <li class="list-group-item d-flex justify-content-between">
            <span>{{ loc }}</span>
            <span class="badge bg-secondary">{{ cnt }}</span>
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <!-- –û—Ü–µ–Ω–∫–∏ -->
    {% if feedbacks %}
    <h4>‚≠ê –û—Ü–µ–Ω–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤</h4>
    <div class="card mb-4">
      <div class="card-body">
        <ul class="list-group">
          {% for f in feedbacks %}
          <li class="list-group-item feedback-item">
            <strong>{{ f.rating }} –∏–∑ 5</strong> ‚Äî {{ f.timestamp.split('.')[0] }}
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
    {% endif %}

    <!-- –ó–∞—è–≤–∫–∏ -->
    <h4>üìã –ó–∞—è–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞</h4>
    <div class="accordion" id="ticketsAccordion">
      {% for t in tickets %}
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ t.ticket_id }}">
            {{ t.ticket_id }} ‚Äî {{ t.business }} ({{ t.city }})
          </button>
        </h2>
        <div id="collapse-{{ t.ticket_id }}" class="accordion-collapse collapse" data-bs-parent="#ticketsAccordion">
          <div class="accordion-body">
            <p><strong>–ü—Ä–æ–±–ª–µ–º–∞:</strong> {{ t.problem }}</p>
            <p><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> {{ t.category or '‚Äî' }}</p>
            <p><strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong> {{ t.created_date }} {{ t.created_time }}</p>
            {% if t.status == 'resolved' and t.resolved_at %}
              <p><strong>–ó–∞–≤–µ—Ä—à–µ–Ω–∞:</strong> {{ t.resolved_at }} <strong>–∫–µ–º:</strong> {{ t.resolved_by or '–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏' }}</p>
              {% if t.duration_minutes is not none %}
                <p><strong>–í—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:</strong> {{ t.duration_minutes }} –º–∏–Ω</p>
              {% endif %}
            {% else %}
              <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="badge bg-warning text-dark">‚è≥ –í –æ–±—Ä–∞–±–æ—Ç–∫–µ</span></p>
            {% endif %}
            <button class="btn btn-sm btn-outline-secondary" onclick="loadHistory({{ client.user_id }}, '{{ t.ticket_id }}')">
              –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é
            </button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ -->
  <div class="modal fade" id="editClientNameModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="newClientName" class="form-control" value="{{ client.client_name or '' }}" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          <button type="button" class="btn btn-primary" onclick="saveClientName()">
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ -->
  <div class="modal fade" id="editClientStatusModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <select id="newClientStatus" class="form-select">
            <option value="">–ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞</option>
            {% for status in settings.client_statuses %}
            <option value="{{ status }}" {% if client_status == status %}selected{% endif %}>{{ status }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          <button type="button" class="btn btn-primary" onclick="saveClientStatus()">
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –∏—Å—Ç–æ—Ä–∏—è -->
  <div class="modal fade resizable-modal" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable modal-lg modal-dialog-centered" style="width: 80%; height: 80%;">
      <div class="modal-content" style="min-height: 400px;">
        <div class="modal-header">
          <h5 class="modal-title" id="historyModalTitle">üí¨ –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ ‚Äî ID –∑–∞—è–≤–∫–∏: <span id="ticketIdDisplay"></span></h5>
          <div class="d-flex align-items-center gap-2">
            <span id="clientDisplayName">‚Äî</span>
            <button type="button" class="btn btn-sm btn-outline-primary" id="editClientBtn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–º—è">
              ‚úèÔ∏è
            </button>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body chat-container" id="historyContent" style="min-height: 300px;"></div>
        <div class="modal-footer">
          <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫–∞ —Ä–µ–∂–∏–º–∞ -->
          <div class="input-group-send w-100">
            <textarea
              id="replyTextInHistory"
              class="form-control"
              placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç..."
            ></textarea>
            <button id="sendKeySettingBtn" class="btn btn-outline-secondary" type="button" style="width: 120px;" data-bs-toggle="dropdown">
              Enter ‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" data-mode="enter">Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</a></li>
              <li><a class="dropdown-item" href="#" data-mode="ctrlEnter">Ctrl+Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</a></li>
              <li><a class="dropdown-item" href="#" data-mode="enterNewline">Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞</a></li>
            </ul>
          </div>
          <div class="mt-2 d-flex justify-content-between w-100">
            <button type="button" id="closeTicketBtn" class="btn btn-danger">–ó–∞–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É</button>
            <button type="button" id="sendReplyInHistory" class="btn btn-primary">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    window.settings = {{ settings | tojson }};
  </script>
  <script>
      const CURRENT_OPERATOR = {{ (session.get('user_email') or session.get('username') or session.get('user') or '') | tojson }};

    function getOperatorName() {
      const name = (typeof CURRENT_OPERATOR === 'string' ? CURRENT_OPERATOR : '').trim();
      return name || '–ü–æ–¥–¥–µ—Ä–∂–∫–∞';
    }
    let currentUserId = null;
    let currentTicketId = null;
    let historyPolling = null;
    let clientData = null;
	// === –ú–µ–¥–∏–∞-—Ö–µ–ª–ø–µ—Ä—ã –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –≤ –º–æ–¥–∞–ª–∫–µ ===
function getMediaUrl(ticket_id, filename) {
  const clean = (filename || '').split('/').pop();
  return `/media/${ticket_id}/${clean}`;
}

function createMediaHtml(ticket_id, mediaInfo) {
  const { message_type, attachment, text } = mediaInfo;
  const filename = (attachment || '').split('/').pop();
  const mediaUrl = getMediaUrl(ticket_id, filename);
  const ext = (filename.split('.').pop() || '').toLowerCase();
  let mediaHtml = '';

  switch (message_type) {
    case 'photo':
      mediaHtml = `
        <div class="mt-2">
          <img src="${mediaUrl}"
               loading="lazy" decoding="async"
               style="max-width: 100%; max-height: 400px; border-radius: 8px;"
               alt="–§–æ—Ç–æ" class="img-thumbnail">
          ${text ? `<div class="small mt-1">${text}</div>` : ''}
        </div>`;
      break;

    case 'video':
      mediaHtml = `
        <div class="mt-2">
          <video controls
                 style="max-width: 100%; max-height: 300px; border-radius: 8px;"
                 class="img-thumbnail">
            <source src="${mediaUrl}">
            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
          </video>
          ${text ? `<div class="small mt-1">${text}</div>` : ''}
        </div>`;
      break;

    case 'animation': // GIF (–∫–∞–∫ mp4)
      mediaHtml = `
        <div class="mt-2">
          <video autoplay loop muted playsinline controls
                 style="max-width: 100%; max-height: 320px; border-radius: 8px;"
                 class="img-thumbnail">
            <source src="${mediaUrl}">
            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
          </video>
          ${text ? `<div class="small mt-1">${text}</div>` : ''}
        </div>`;
      break;

    case 'sticker':
      if (ext === 'webp') {
        mediaHtml = `<div class="mt-2"><img src="${mediaUrl}" alt="–°—Ç–∏–∫–µ—Ä" style="max-width:160px;height:auto;"></div>`;
      } else if (ext === 'webm') {
        mediaHtml = `<div class="mt-2"><video autoplay loop muted playsinline style="max-width:160px;border-radius:8px;"><source src="${mediaUrl}"></video></div>`;
      } else if (ext === 'tgs') {
        mediaHtml = `<div class="mt-2"><a href="${mediaUrl}" target="_blank">–°—Ç–∏–∫–µ—Ä (.tgs) ‚Äî —Å–∫–∞—á–∞—Ç—å</a></div>`;
      } else {
        mediaHtml = `<div class="mt-2"><a href="${mediaUrl}" target="_blank">–°—Ç–∏–∫–µ—Ä</a></div>`;
      }
      if (text) mediaHtml += `<div class="small mt-1">${text}</div>`;
      break;

    case 'document':
      mediaHtml = `
        <div class="mt-2">
          <a href="${mediaUrl}" target="_blank"
             class="btn btn-outline-primary btn-sm d-inline-flex align-items-center">
            üìÑ ${filename}
          </a>
          ${text ? `<div class="small mt-1">${text}</div>` : ''}
        </div>`;
      break;

    case 'voice':
      mediaHtml = `
        <div class="mt-2">
          <audio controls style="width: 100%;" class="mb-2">
            <source src="${mediaUrl}">
            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ.
          </audio>
          ${text ? `<div class="small mt-1">${text}</div>` : ''}
        </div>`;
      break;

    default:
      if (attachment) {
        mediaHtml = `<div class="mt-2"><a href="${mediaUrl}" target="_blank" class="text-muted">[–º–µ–¥–∏–∞]</a>${text ? `<div class="small mt-1">${text}</div>` : ''}</div>`;
      }
  }

  return mediaHtml;
}


    const HISTORY_ERROR_SNIPPET_LIMIT = 200;

    async function fetchJsonWithAuth(url, options = {}) {
      const fetchOptions = { ...options };
      if (!('credentials' in fetchOptions)) {
        fetchOptions.credentials = 'same-origin';
      }
      const response = await fetch(url, fetchOptions);
      const rawText = await response.text();
      if (!response.ok) {
        const snippet = rawText ? `: ${rawText.slice(0, HISTORY_ERROR_SNIPPET_LIMIT)}` : '';
        throw new Error(`–ó–∞–ø—Ä–æ—Å ${url} –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π ${response.status}${snippet}`);
      }
      if (!rawText.trim()) {
        return null;
      }
      try {
        return JSON.parse(rawText);
      } catch (parseError) {
        const snippet = rawText.slice(0, HISTORY_ERROR_SNIPPET_LIMIT);
        throw new Error(`–û—Ç–≤–µ—Ç ${url} –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º JSON: ${parseError.message}. –§—Ä–∞–≥–º–µ–Ω—Ç: ${snippet}`);
      }
    }

    // === –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é ===
    async function loadHistory(user_id, ticket_id) {
      currentUserId = user_id;
      currentTicketId = ticket_id;

      let data;
      try {
        data = await fetchJsonWithAuth(`/history?user_id=${user_id}&ticket_id=${ticket_id}`, { cache: 'no-store' }) || {};
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏:', error);
        const reason = error && error.message ? `: ${error.message}` : '';
        alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∑–∞—è–≤–∫–∏${reason}`);
        return;
      }

      const container = document.getElementById('historyContent');
      
      if (!container) {
        console.error("‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω");
        return;
      }
      
      container.innerHTML = '';

      const messages = Array.isArray(data.messages) ? data.messages : [];

      if (messages.length === 0) {
        container.innerHTML = '<p class="text-muted">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>';
      } else {
        messages.forEach(msg => {
          const cls = msg.sender === 'support' ? 'from-support' : 'from-user';
          let name = msg.sender === 'support' ? 'üõ† –ü–æ–¥–¥–µ—Ä–∂–∫–∞' : 'üë§ –ö–ª–∏–µ–Ω—Ç';

          if (msg.sender === 'user') {
            const clientName = "{{ client.client_name or '' }}";
            const username = "{{ client.username or '' }}";
            if (clientName && clientName !== '–Ω–µ –∑–∞–¥–∞–Ω–æ') {
              name = 'üë§ ' + clientName;
            } else if (username) {
              name = 'üë§ @' + username;
            } else {
              name = 'üë§ –ö–ª–∏–µ–Ω—Ç';
            }
          }

          const time = new Date(msg.timestamp).toLocaleString('ru-RU');
          const bubble = document.createElement('div');
          bubble.className = `chat-bubble ${cls}`;
          const textHtml  = (msg.message && (!msg.message_type || msg.message_type === 'text'))
			  ? `<p class="mb-0">${msg.message.replace(/\n/g,'<br>')}</p>`
			  : '';
			const mediaHtml = (msg.message_type && msg.message_type !== 'text' && msg.attachment)
			  ? createMediaHtml(ticket_id, { message_type: msg.message_type, attachment: msg.attachment, text: msg.message || '' })
			  : '';

			bubble.innerHTML = `
			  <small>${time}</small><br>
			  <strong>${name}</strong>
			  ${textHtml}
			  ${mediaHtml}
			`;

          container.appendChild(bubble);
        });
      }

      container.scrollTop = container.scrollHeight;
	  parseEmojis(container);

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
      const modal = new bootstrap.Modal(document.getElementById('historyModal'));
      modal.show();

      if (historyPolling) clearInterval(historyPolling);
      historyPolling = setInterval(() => loadHistoryMessagesOnly(user_id, ticket_id), 5000);
    }

    // === –¢–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è ===
    async function loadHistoryMessagesOnly(user_id, ticket_id) {
      if (currentUserId !== user_id) return;

      let data;
      try {
        data = await fetchJsonWithAuth(`/history?user_id=${user_id}&ticket_id=${ticket_id}`, { cache: 'no-store' }) || {};
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
        return;
      }

      const container = document.getElementById('historyContent');

      if (!container) return;

      container.innerHTML = '';

      const messages = Array.isArray(data.messages) ? data.messages : [];

      messages.forEach(msg => {
        const cls = msg.sender === 'support' ? 'from-support' : 'from-user';
        let name = msg.sender === 'support' ? 'üõ† –ü–æ–¥–¥–µ—Ä–∂–∫–∞' : 'üë§ –ö–ª–∏–µ–Ω—Ç';

        if (msg.sender === 'user') {
          const clientName = "{{ client.client_name or '' }}";
          const username = "{{ client.username or '' }}";
          if (clientName && clientName !== '–Ω–µ –∑–∞–¥–∞–Ω–æ') {
            name = 'üë§ ' + clientName;
          } else if (username) {
            name = 'üë§ @' + username;
          } else {
            name = 'üë§ –ö–ª–∏–µ–Ω—Ç';
          }
        }

        const time = new Date(msg.timestamp).toLocaleString('ru-RU');
        const bubble = document.createElement('div');
        bubble.className = `chat-bubble ${cls}`;
        const textHtml  = (msg.message && (!msg.message_type || msg.message_type === 'text'))
		  ? `<p class="mb-0">${msg.message.replace(/\n/g,'<br>')}</p>`
		  : '';
		const mediaHtml = (msg.message_type && msg.message_type !== 'text' && msg.attachment)
		  ? createMediaHtml(ticket_id, { message_type: msg.message_type, attachment: msg.attachment, text: msg.message || '' })
		  : '';

		bubble.innerHTML = `
		  <small>${time}</small><br>
		  <strong>${name}</strong>
		  ${textHtml}
		  ${mediaHtml}
		`;

        container.appendChild(bubble);
      });
      
      container.scrollTop = container.scrollHeight;
	  parseEmojis(container);
    }

    // === –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ ===
    document.addEventListener('DOMContentLoaded', function() {
      const sendButton = document.getElementById('sendReplyInHistory');
      if (sendButton) {
        sendButton.onclick = async function () {
          const textElement = document.getElementById('replyTextInHistory');
          if (!textElement) return;
          
          const text = textElement.value.trim();
          const admin = "{{ session.user or '–ü–æ–¥–¥–µ—Ä–∂–∫–∞' }}";
          
          if (!text) {
            alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞');
            return;
          }

          const response = await fetch('/reply', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              user_id: currentUserId, 
              text, 
              admin,
              ticket_id: currentTicketId 
            })
          });

          const data = await response.json();
          if (data.success) {
			  textElement.value = '';
			  // –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
			  loadHistoryMessagesOnly(currentUserId, currentTicketId);

			  // –µ—Å–ª–∏ —Ç–∏–∫–µ—Ç –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç ‚Äî –æ–±–Ω–æ–≤–∏–º —Å—Ç–∞—Ç—É—Å –∏ –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è
			  try {
				const resp = await fetch(`/tickets/${currentTicketId}`);
				const t = await resp.json();
				const closeButton = document.getElementById('closeTicketBtn');
				const isResolved = t?.status === 'resolved';
				if (closeButton) {
				  closeButton.disabled = !!isResolved;
				  closeButton.classList.toggle('disabled', !!isResolved);
				  closeButton.title = isResolved ? '–ó–∞—è–≤–∫–∞ —É–∂–µ –∑–∞–∫—Ä—ã—Ç–∞' : '';
				}
			  } catch (e) {
				console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ç–∏–∫–µ—Ç–∞ –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞', e);
			  }

			  // –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä —Å–æ–æ–±—â–∏–ª, —á—Ç–æ –±—ã–ª–æ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏–µ ‚Äî –º–æ–∂–Ω–æ –Ω–µ–Ω–∞–≤—è–∑—á–∏–≤–æ –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å
			  if (data.reopened) {
				// –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–∫–∞–∑–∞—Ç—å –∫—Ä–∞—Ç–∫–∏–π toast/alert –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏
				console.debug('–ó–∞—è–≤–∫–∞ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∞');
			  }
			} else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
          }
        };
      }

      // === –ó–∞–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É ===
      const closeButton = document.getElementById('closeTicketBtn');
      if (closeButton) {
        closeButton.onclick = function () {
          const modal = new bootstrap.Modal(document.getElementById('closeTicketModal'));
          const select = document.getElementById('categorySelect');
          
          if (select) {
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>';
            window.settings.categories.forEach(cat => {
              const option = document.createElement('option');
              option.value = cat;
              option.textContent = cat;
              select.appendChild(option);
            });
          }
          
          modal.show();
        };
      }

      // === –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ ===
      const confirmButton = document.getElementById('confirmCloseTicketBtn');
      if (confirmButton) {
        confirmButton.onclick = async function () {
          const select = document.getElementById('categorySelect');
          if (!select) return;
          
          const category = select.value;
          if (!category) {
            alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
            return;
          }

          const admin = getOperatorName();

          let completed = false;
          try {
            confirmButton.disabled = true;

            const response = await fetch('/close_ticket', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                user_id: currentUserId,
                admin,
                category,
                ticket_id: currentTicketId
              })
            });

          const data = await response.json();
            if (!data.success) {
              alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É'));
              return;
            }

          completed = true;

            const closeModal = document.getElementById('closeTicketModal');
            if (closeModal) {
              const instance = bootstrap.Modal.getInstance(closeModal);
              instance?.hide();
            }

            const successModal = document.getElementById('ticketClosedModal');
            if (successModal) {
              bootstrap.Modal.getOrCreateInstance(successModal).show();
            } else {
              alert('‚úÖ –ó–∞—è–≤–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞');
              location.reload();
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –∑–∞—è–≤–∫–∏:', error);
            alert('‚ùå –û—à–∏–±–∫–∞: ' + (error?.message || error));
          } finally {
            if (!completed) {
              confirmButton.disabled = false;
            }
          }
        };
      }
    });

    // === –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ ===
    async function saveClientName() {
      const newNameInput = document.getElementById('newClientName');
      if (!newNameInput) return;
      
      const newName = newNameInput.value.trim();
      const user_id = {{ client.user_id }};
      
      if (!newName || newName === '–Ω–µ –∑–∞–¥–∞–Ω–æ') return;

      const response = await fetch('/update_client_name', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id, client_name: newName })
      });

      const data = await response.json();
      if (data.success) {
        const nameDisplay = document.getElementById('clientNameDisplay');
        if (nameDisplay) {
          nameDisplay.textContent = newName;
        }
        bootstrap.Modal.getInstance(document.getElementById('editClientNameModal')).hide();
        alert('‚úÖ –ò–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
      } else {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
      }
    }

    // === –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞ ===
    async function saveClientStatus() {
      const statusSelect = document.getElementById('newClientStatus');
      if (!statusSelect) return;
      
      const newStatus = statusSelect.value;
      const user_id = {{ client.user_id }};
      
      if (!newStatus || newStatus === '–Ω–µ –∑–∞–¥–∞–Ω–æ') return;

      const response = await fetch('/client/' + user_id + '/status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ client_status: newStatus })
      });

      const data = await response.json();
      if (data.success) {
        const statusDisplay = document.getElementById('clientStatusDisplay');
        if (statusDisplay) {
          statusDisplay.textContent = newStatus;
        }
        bootstrap.Modal.getInstance(document.getElementById('editClientStatusModal')).hide();
        alert('‚úÖ –°—Ç–∞—Ç—É—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
      } else {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
      }
    }
</script>
<script>
	async function addManualPhone(userId){
	  const phone = (document.getElementById('newPhoneInput')?.value || '').trim();
	  const label = (document.getElementById('newPhoneLabelInput')?.value || '').trim();
	  if(!phone){ alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω'); return; }
	  const r = await fetch(`/client/${userId}/phones`, {
		method:'POST', headers:{'Content-Type':'application/json'},
		body: JSON.stringify({phone, label})
	  });
	  const j = await r.json();
	  if(!j.success){ alert('–û—à–∏–±–∫–∞: '+(j.error||'–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')); return; }
	  location.reload();
	}

	async function savePhoneLabel(userId, phoneId, btn){
	  const tr = btn.closest('tr');
	  const inp = tr.querySelector('.phone-label-input');
	  const label = inp ? inp.value.trim() : '';
	  const r = await fetch(`/client/${userId}/phones/${phoneId}`, {
		method:'PATCH', headers:{'Content-Type':'application/json'},
		body: JSON.stringify({label})
	  });
	  const j = await r.json();
	  if(!j.success){ alert('–û—à–∏–±–∫–∞: '+(j.error||'–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')); return; }
	  btn.classList.remove('btn-outline-primary');
	  btn.classList.add('btn-success');
	  setTimeout(()=>{ btn.classList.remove('btn-success'); btn.classList.add('btn-outline-primary'); }, 700);
	}

	async function archivePhone(userId, phoneId, btn){
	  if(!confirm('–£–±—Ä–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö?')) return;
	  const r = await fetch(`/client/${userId}/phones/${phoneId}`, {
		method:'PATCH', headers:{'Content-Type':'application/json'},
		body: JSON.stringify({is_active:false})
	  });
	  const j = await r.json();
	  if(!j.success){ alert('–û—à–∏–±–∫–∞: '+(j.error||'–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')); return; }
	  btn.closest('tr')?.remove();
	}
</script>
<script>
	async function addManualPhone() {
	  const phone = document.getElementById('newPhone').value.trim();
	  const label = document.getElementById('newPhoneLabel').value.trim();
	  if (!phone) { alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω'); return; }
	  const resp = await fetch('/client/{{ client.user_id }}/phones', {
		method: 'POST',
		headers: {'Content-Type':'application/json'},
		body: JSON.stringify({ phone, label })
	  });
	  const data = await resp.json();
	  if (data.success) location.reload(); else alert('–û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'));
	}

	async function deactivatePhone(id) {
	  const resp = await fetch(`/client/{{ client.user_id }}/phones/${id}/deactivate`, { method: 'POST' });
	  const data = await resp.json();
	  if (data.success) location.reload(); else alert('–û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'));
	}
</script>
<script>
	(function () {
	  function showAvatar(src) {
		// –ë–µ—Ä—ë–º —ç–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª–∫–∏ –≤ –º–æ–º–µ–Ω—Ç –∫–ª–∏–∫–∞, –∫–æ–≥–¥–∞ DOM —É–∂–µ –≥–æ—Ç–æ–≤
		const modalEl  = document.getElementById('avatarModal');
		const modalImg = document.getElementById('avatarModalImg');
		if (!modalEl || !modalImg) return;
		modalImg.src = src;
		bootstrap.Modal.getOrCreateInstance(modalEl).show();
	  }
	  const profileAva = document.getElementById('clientAvatarProfile');
	  if (profileAva) {
		profileAva.style.cursor = 'zoom-in';
		profileAva.addEventListener('click', () => {
		  showAvatar(profileAva.dataset.fullsrc || profileAva.src);
		});
	  }
	})();
</script>

<!-- Twemoji -->
<script src="{{ url_for('static', filename='vendor/twemoji/twemoji.min.js') }}"></script>
<script>
	  function parseEmojis(root) {
		try {
		  if (!window.twemoji) return;
		  twemoji.parse(root || document.body, {
			folder: 'svg',
			ext: '.svg',
			base: "{{ url_for('static', filename='vendor/twemoji/') }}",
			className: 'emoji'
		  });
		} catch (e) {}
	  }
	  document.addEventListener('DOMContentLoaded', function () { parseEmojis(document.body); });

	(function(){
	  const img = document.getElementById('clientAvatarProfile');
	  if (!img) return;
	  const srcHint = img.getAttribute('data-src');
	  if (srcHint) {
		// –¥–µ—Ä–≥–∞–µ–º /avatar/<id>?src=<url>, —á—Ç–æ–±—ã –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é
		const url = new URL(img.src, location.origin);
		url.searchParams.set('src', srcHint);
		fetch(url.toString()).catch(()=>{});
	  }

	  // –ø–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é (–ø—Ä–∏–º–µ—Ä)
	  const historyBox = document.getElementById('avatarHistory');
	  if (historyBox) {
		fetch(`/api/client/{{ client.user_id }}/avatar_history`)
		  .then(r => r.ok ? r.json() : [])
		  .then(list => {
			if (!Array.isArray(list) || !list.length) return;
			historyBox.innerHTML = list.map(x => `
			  <div class="small text-muted">${x.at}: ${x.url}</div>
			`).join('');
		  }).catch(()=>{});
	  }
	})();
</script>

<script>
	  function parseEmojis(root) {
		try {
		  twemoji.parse(root || document.body, { folder: 'svg', ext: '.svg', className: 'emoji' });
		} catch (e) {}
	  }
	  document.addEventListener('DOMContentLoaded', function () { parseEmojis(document.body); });
</script>
<script>
	async function blacklistAdd(userId) {
	  const reason = prompt('–ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):') || '';
	  const r = await fetch('/api/blacklist/add', {
		method: 'POST',
		headers: {'Content-Type':'application/json'},
		body: JSON.stringify({user_id: userId, reason})
	  });
	  const j = await r.json();
	  alert(j.ok ? '–ö–ª–∏–µ–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : ('–û—à–∏–±–∫–∞: '+(j.error||'unknown')));
	  if (j.ok) location.reload();
	}

	async function blacklistRemove(userId) {
	  const r = await fetch('/api/blacklist/remove', {
			method: 'POST',
			headers: {'Content-Type':'application/json'},
			body: JSON.stringify({user_id: userId})
	  });
	  const j = await r.json();
	  alert(j.ok ? '–ö–ª–∏–µ–Ω—Ç —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : ('–û—à–∏–±–∫–∞: '+(j.error||'unknown')));
	  if (j.ok) location.reload();
	}

	const ticketClosedModalEl = document.getElementById('ticketClosedModal');
	if (ticketClosedModalEl) {
	  ticketClosedModalEl.addEventListener('hidden.bs.modal', () => {
		location.reload();
	  });
	}

	window.currentUser = CURRENT_OPERATOR;
</script>
	
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è -->
        <div class="modal fade small-modal" id="ticketClosedModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content text-center p-4">
                  <div class="modal-body">
                        <h5 class="mb-2">–ó–∞—è–≤–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞</h5>
                        <p class="text-muted mb-0">–û–±—Ä–∞—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ –≤ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.</p>
                  </div>
                  <div class="modal-footer justify-content-center border-0">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">–û–∫</button>
                  </div>
                </div>
          </div>
        </div>
<!-- Modal: —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞ -->
	<div class="modal fade" id="avatarModal" tabindex="-1" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-centered">
		<div class="modal-content bg-transparent border-0 shadow-none">
		  <div class="modal-body p-0">
			<img id="avatarModalImg" src="" class="img-fluid rounded" alt="–§–æ—Ç–æ –∫–ª–∏–µ–Ω—Ç–∞">
		  </div>
		</div>
	  </div>
	</div>
  </main>
  <script src="{{ url_for('static', filename='sidebar.js') }}"></script>
  <script src="{{ url_for('static', filename='modal-transitions.js') }}"></script>
</body>
</html>
