<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–°—Ç–∞—Ç—å—è –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π ‚Äî Bender</title>
  <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='bender-icon.svg') }}" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='sidebar.css') }}" rel="stylesheet" />
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
  <style>
    .article-meta-card label {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .article-meta-card input,
    .article-meta-card select,
    .article-meta-card textarea {
      font-size: 0.95rem;
    }

    .kb-editor-wrapper {
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 0.75rem;
      overflow: hidden;
      box-shadow: 0 0.75rem 1.5rem rgba(18, 38, 63, 0.05);
    }

    .kb-type-dropdown .dropdown-toggle {
      text-align: left;
      justify-content: space-between;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 500;
    }

    .kb-type-dropdown .dropdown-menu {
      width: 100%;
      max-height: 320px;
      overflow-y: auto;
      box-shadow: 0 1rem 2rem rgba(15, 23, 42, 0.15);
    }

    .kb-type-options .dropdown-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      white-space: normal;
    }

    .kb-type-options .form-check-input {
      margin: 0;
      flex-shrink: 0;
    }

    .kb-type-empty-text {
      padding: 0.35rem 0.5rem;
    }

    .kb-dropzone {
      border: 2px dashed #cfd4da;
      border-radius: 0.75rem;
      padding: 1.75rem;
      transition: border-color 0.2s ease, background-color 0.2s ease;
      background: #f8f9fa;
      cursor: pointer;
    }

    .kb-dropzone.dragover {
      border-color: #3b5bdb;
      background: rgba(59, 91, 219, 0.08);
    }

    .kb-attachment-actions .btn {
      font-size: 0.8rem;
    }

    .kb-attachment-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .kb-attachment-thumb {
      width: 72px;
      height: 56px;
      object-fit: cover;
      border-radius: 0.5rem;
      box-shadow: 0 0.35rem 0.9rem rgba(15, 23, 42, 0.12);
      border: 1px solid rgba(0, 0, 0, 0.05);
      cursor: zoom-in;
    }

    .kb-attachment-thumb + .fw-semibold {
      margin-bottom: 0;
    }

    .kb-status-message {
      min-height: 1.5rem;
    }

    .kb-status-message .alert {
      padding: 0.5rem 0.75rem;
      margin-bottom: 0;
    }

    .toastui-editor-defaultUI {
      border: none;
    }

    .kb-image-modal img {
      transition: transform 0.15s ease;
      transform-origin: center center;
    }

    .kb-meta-summary-row {
      gap: 1rem;
    }

    .kb-meta-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .kb-meta-summary-item {
      display: inline-flex;
      gap: 0.35rem;
      align-items: baseline;
      font-size: 0.85rem;
    }

    .kb-meta-summary-label {
      color: #6c757d;
    }

    .kb-card-toggle {
      border: none;
      box-shadow: none;
      padding: 0;
    }

    .kb-card-toggle:focus {
      box-shadow: none;
    }

    .kb-card-toggle .kb-collapse-indicator {
      transition: transform 0.2s ease;
    }

    .kb-card-toggle[aria-expanded='true'] .kb-collapse-indicator {
      transform: rotate(180deg);
    }
  </style>
</head>
<body class="with-sidebar sidebar-pinned">
  {% include "_sidebar.html" %}
  <main class="main-content container-fluid">
    <div class="container-fluid mt-4">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <div class="flex-grow-1">
          <a href="{{ url_for('knowledge_base_page') }}" class="text-decoration-none small">‚Üê –ö —Å–ø–∏—Å–∫—É —Å—Ç–∞—Ç–µ–π</a>
          <h2 class="mb-0 mt-2">{{ '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏' if article.id else '–ù–æ–≤–∞—è —Å—Ç–∞—Ç—å—è' }}</h2>
          <div class="text-muted small d-flex flex-wrap align-items-center kb-meta-summary-row" id="kbArticleSummaryRow">
            <div id="kbArticleIdBadge" {% if not article.id %}style="display: none;"{% endif %}>
              ID —Å—Ç–∞—Ç—å–∏: <span id="kbArticleIdValue">{{ article.id }}</span>
            </div>
            <div class="kb-meta-summary" id="kbMetaSummary">
              <span class="kb-meta-summary-item">
                <span class="kb-meta-summary-label">–ù–∞–∑–≤–∞–Ω–∏–µ:</span>
                <span id="kbMetaSummaryTitle">‚Äî</span>
              </span>
              <span class="kb-meta-summary-item">
                <span class="kb-meta-summary-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</span>
                <span id="kbMetaSummaryDirection">‚Äî</span>
              </span>
              <span class="kb-meta-summary-item">
                <span class="kb-meta-summary-label">–ü–æ–¥—Ç–∏–ø –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è:</span>
                <span id="kbMetaSummarySubDirection">‚Äî</span>
              </span>
              <span class="kb-meta-summary-item">
                <span class="kb-meta-summary-label">–û—Ç–¥–µ–ª:</span>
                <span id="kbMetaSummaryDepartment">‚Äî</span>
              </span>
              <span class="kb-meta-summary-item">
                <span class="kb-meta-summary-label">–¢–∏–ø:</span>
                <span id="kbMetaSummaryTypes">‚Äî</span>
              </span>
              <span class="kb-meta-summary-item">
                <span class="kb-meta-summary-label">–°—Ç–∞—Ç—É—Å:</span>
                <span id="kbMetaSummaryStatus">‚Äî</span>
              </span>
              <span class="kb-meta-summary-item">
                <span class="kb-meta-summary-label">–ê–≤—Ç–æ—Ä:</span>
                <span id="kbMetaSummaryAuthor">‚Äî</span>
              </span>
              <span class="kb-meta-summary-item">
                <span class="kb-meta-summary-label">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</span>
                <span id="kbMetaSummaryDescription">‚Äî</span>
              </span>
            </div>
          </div>
        </div>
        <div class="d-flex flex-wrap gap-2">
          <div class="kb-status-message" id="kbStatusMessage"></div>
          <button class="btn btn-primary" id="kbSaveButton" type="button">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>

      <div class="card shadow-sm border-0 mb-4 article-meta-card">
        <div class="card-header d-flex justify-content-between align-items-center gap-3">
          <button
            class="kb-card-toggle btn btn-link text-decoration-none text-reset flex-grow-1 text-start d-flex justify-content-between align-items-center"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#kbMetaCollapse"
            aria-expanded="{{ 'true' if not article.id else 'false' }}"
            aria-controls="kbMetaCollapse"
          >
            <span class="fw-semibold">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</span>
            <span class="kb-collapse-indicator" aria-hidden="true">‚ñæ</span>
          </button>
        </div>
        <div class="collapse{% if not article.id %} show{% endif %}" id="kbMetaCollapse">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-12">
                <label for="kbTitle" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                <input type="text" id="kbTitle" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏" />
              </div>
              <div class="col-md-6 col-lg-4">
                <label for="kbDirection" class="form-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
                <select id="kbDirection" class="form-select">
                  <option value="">–ë–µ–∑ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è</option>
                </select>
              </div>
              <div class="col-md-6 col-lg-4">
                <label for="kbSubDirection" class="form-label">–ü–æ–¥—Ç–∏–ø –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è</label>
                <select id="kbSubDirection" class="form-select" disabled>
                  <option value="">–ë–µ–∑ –ø–æ–¥—Ç–∏–ø–∞</option>
                </select>
              </div>
              <div class="col-md-6 col-lg-4">
                <label for="kbDepartment" class="form-label">–û—Ç–¥–µ–ª</label>
                <select id="kbDepartment" class="form-select">
                  <option value="">–ë–µ–∑ –æ—Ç–¥–µ–ª–∞</option>
                </select>
              </div>
              <div class="col-md-6 col-lg-4">
                <label for="kbTypeDropdownButton" class="form-label">–¢–∏–ø</label>
                <div class="kb-type-dropdown dropdown">
                  <button
                    class="btn btn-outline-secondary dropdown-toggle w-100 text-start"
                    type="button"
                    id="kbTypeDropdownButton"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                  >
                    –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø—ã
                  </button>
                  <div class="dropdown-menu kb-type-menu p-2" aria-labelledby="kbTypeDropdownButton" id="kbTypeDropdownMenu">
                    <div class="kb-type-empty-text text-muted small" id="kbTypeEmptyState">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–∏–ø–æ–≤</div>
                    <div id="kbTypeOptions" class="kb-type-options"></div>
                    <div class="mt-2" id="kbTypeCustomWrapper">
                      <label class="form-label small mb-1" for="kbTypeCustomInput">–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–∏–ø</label>
                      <div class="input-group input-group-sm">
                        <input type="text" class="form-control" id="kbTypeCustomInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, FAQ" />
                        <button class="btn btn-outline-primary" type="button" id="kbTypeCustomAdd">–î–æ–±–∞–≤–∏—Ç—å</button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="form-text">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏–π</div>
              </div>
              <div class="col-md-6 col-lg-4">
                <label for="kbStatus" class="form-label">–°—Ç–∞—Ç—É—Å</label>
                <select id="kbStatus" class="form-select">
                  <option value="">–ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞</option>
                </select>
              </div>
              <div class="col-md-6 col-lg-4">
                <label for="kbAuthor" class="form-label">–ê–≤—Ç–æ—Ä</label>
                <select id="kbAuthor" class="form-select">
                  <option value="">–ù–µ —É–∫–∞–∑–∞–Ω</option>
                </select>
              </div>
              <div class="col-12">
                <label for="kbSummary" class="form-label">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="kbSummary" class="form-control" rows="3" placeholder="–û–ø–∏—à–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—É—é –º—ã—Å–ª—å —Å—Ç–∞—Ç—å–∏"></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header d-flex justify-content-between align-items-center gap-3">
          <button
            class="kb-card-toggle btn btn-link text-decoration-none text-reset flex-grow-1 text-start d-flex justify-content-between align-items-center"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#kbAttachmentsCollapse"
            aria-expanded="false"
            aria-controls="kbAttachmentsCollapse"
          >
            <span class="fw-semibold">–§–∞–π–ª—ã –∏ –≤–ª–æ–∂–µ–Ω–∏—è</span>
            <span class="kb-collapse-indicator" aria-hidden="true">‚ñæ</span>
          </button>
          <button class="btn btn-outline-primary btn-sm" type="button" id="kbUploadButton">üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª—ã</button>
        </div>
        <div class="collapse" id="kbAttachmentsCollapse">
          <div class="card-body">
            <div id="kbAttachmentDropzone" class="kb-dropzone text-center">
              <div class="fw-semibold">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å¬ª</div>
              <div class="text-muted small">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è drag&amp;drop, –≤—Å—Ç–∞–≤–∫–∞ –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞</div>
            </div>
            <input type="file" id="kbAttachmentInput" class="d-none" multiple />
            <ul class="list-group list-group-flush mt-3" id="kbAttachmentList"></ul>
          </div>
        </div>
      </div>

      <div class="card shadow-sm border-0">
        <div class="card-header fw-semibold">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç–∞—Ç—å–∏</div>
        <div class="card-body">
          <div id="kbEditor" class="kb-editor-wrapper"></div>
        </div>
      </div>
    </div>
  </main>

  <input type="hidden" id="kbDraftToken" value="{{ draft_token }}" />
  <input type="hidden" id="kbSuggestedTitle" value="{{ suggested_title or '' }}" />

  <div class="modal fade kb-image-modal" id="kbImagePreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header flex-wrap gap-2">
          <h5 class="modal-title me-auto">–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h5>
          <div class="btn-group me-2" role="group" aria-label="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–æ–º">
            <button type="button" class="btn btn-outline-secondary btn-sm" id="kbImageZoomOut">‚àí</button>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="kbImageZoomReset">100%</button>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="kbImageZoomIn">+</button>
          </div>
          <a class="btn btn-outline-secondary btn-sm" id="kbImageDownload" href="#" download target="_blank" rel="noopener">
            ‚¨á –°–∫–∞—á–∞—Ç—å
          </a>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
        </div>
        <div class="modal-body text-center">
          <img src="" alt="" id="kbImagePreviewTarget" class="img-fluid" />
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
  <script>
    (function () {
      const articleData = {{ article | tojson | safe }} || {};
      const kbMeta = {{ kb_meta | tojson | safe }} || {};
      const draftToken = document.getElementById('kbDraftToken').value;
      const suggestedTitle = document.getElementById('kbSuggestedTitle').value;
      let currentArticleId = articleData.id || null;
      let attachments = Array.isArray(articleData.files) ? articleData.files.slice() : [];
      let hasUnsavedChanges = false;
      let dirtyTrackingPaused = true;

      const titleInput = document.getElementById('kbTitle');
      const directionInput = document.getElementById('kbDirection');
      const subDirectionInput = document.getElementById('kbSubDirection');
      const departmentInput = document.getElementById('kbDepartment');
      const typeDropdownButton = document.getElementById('kbTypeDropdownButton');
      const typeOptionsContainer = document.getElementById('kbTypeOptions');
      const typeEmptyState = document.getElementById('kbTypeEmptyState');
      const typeCustomInput = document.getElementById('kbTypeCustomInput');
      const typeCustomAddButton = document.getElementById('kbTypeCustomAdd');
      const statusInput = document.getElementById('kbStatus');
      const authorInput = document.getElementById('kbAuthor');
      const summaryInput = document.getElementById('kbSummary');
      const saveButton = document.getElementById('kbSaveButton');
      const statusBox = document.getElementById('kbStatusMessage');
      const attachmentInput = document.getElementById('kbAttachmentInput');
      const attachmentDropzone = document.getElementById('kbAttachmentDropzone');
      const attachmentList = document.getElementById('kbAttachmentList');
      const uploadButton = document.getElementById('kbUploadButton');
      const articleIdBadge = document.getElementById('kbArticleIdBadge');
      const articleIdValue = document.getElementById('kbArticleIdValue');
      const metaSummaryFields = {
        title: document.getElementById('kbMetaSummaryTitle'),
        direction: document.getElementById('kbMetaSummaryDirection'),
        subDirection: document.getElementById('kbMetaSummarySubDirection'),
        department: document.getElementById('kbMetaSummaryDepartment'),
        types: document.getElementById('kbMetaSummaryTypes'),
        status: document.getElementById('kbMetaSummaryStatus'),
        author: document.getElementById('kbMetaSummaryAuthor'),
        summary: document.getElementById('kbMetaSummaryDescription'),
      };
      const imageModalEl = document.getElementById('kbImagePreviewModal');
      const imageModal = imageModalEl ? new bootstrap.Modal(imageModalEl) : null;
      const imagePreviewTarget = document.getElementById('kbImagePreviewTarget');
      const imageDownloadButton = document.getElementById('kbImageDownload');
      const zoomControls = {
        in: document.getElementById('kbImageZoomIn'),
        out: document.getElementById('kbImageZoomOut'),
        reset: document.getElementById('kbImageZoomReset'),
      };
      let imageZoom = 1;
      const selectedTypes = new Set();
      const customTypeValues = new Set();
      const typeOptionMap = new Map();

      function handleBeforeUnload(event) {
        if (!hasUnsavedChanges) return;
        event.preventDefault();
        event.returnValue = '–£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.';
      }

      function syncBeforeUnload() {
        if (hasUnsavedChanges) {
          window.addEventListener('beforeunload', handleBeforeUnload);
        } else {
          window.removeEventListener('beforeunload', handleBeforeUnload);
        }
      }

      function markDirty() {
        if (dirtyTrackingPaused || hasUnsavedChanges) return;
        hasUnsavedChanges = true;
        syncBeforeUnload();
      }

      function resetDirtyState() {
        if (!hasUnsavedChanges) {
          syncBeforeUnload();
          return;
        }
        hasUnsavedChanges = false;
        syncBeforeUnload();
      }

      function pauseDirtyTracking() {
        dirtyTrackingPaused = true;
      }

      function resumeDirtyTracking() {
        dirtyTrackingPaused = false;
      }

      function isImageFile(file) {
        const mime = String(file?.mime_type || '').toLowerCase();
        if (mime.startsWith('image/')) return true;
        const name = String(file?.name || '').toLowerCase();
        return /\.(png|jpe?g|gif|webp|bmp|svg)$/.test(name);
      }

      function updateImageZoom() {
        if (!imagePreviewTarget) return;
        imagePreviewTarget.style.transform = `scale(${imageZoom})`;
      }

      function openImagePreview(url, title) {
        if (!imageModal || !imagePreviewTarget) return;
        imagePreviewTarget.src = url;
        imagePreviewTarget.alt = title || '';
        if (imageDownloadButton) {
          if (url) {
            imageDownloadButton.style.display = '';
            imageDownloadButton.href = url;
            if (title) {
              imageDownloadButton.setAttribute('download', title);
            } else {
              imageDownloadButton.setAttribute('download', '');
            }
          } else {
            imageDownloadButton.style.display = 'none';
          }
        }
        imageZoom = 1;
        updateImageZoom();
        imageModal.show();
      }

      if (zoomControls.in) {
        zoomControls.in.addEventListener('click', () => {
          imageZoom = Math.min(3, imageZoom + 0.2);
          updateImageZoom();
        });
      }
      if (zoomControls.out) {
        zoomControls.out.addEventListener('click', () => {
          imageZoom = Math.max(0.2, imageZoom - 0.2);
          updateImageZoom();
        });
      }
      if (zoomControls.reset) {
        zoomControls.reset.addEventListener('click', () => {
          imageZoom = 1;
          updateImageZoom();
        });
      }

      function populateDirectionOptions() {
        const directions = Array.isArray(kbMeta.directions) ? kbMeta.directions : [];
        directionInput.innerHTML = '';
        directionInput.appendChild(new Option('–ë–µ–∑ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è', ''));
        directions.forEach((item) => {
          if (!item?.value) return;
          const option = new Option(item.value, item.value);
          option.dataset.id = item.id || '';
          directionInput.appendChild(option);
        });
      }

      function findDirectionEntry(value) {
        const directions = Array.isArray(kbMeta.directions) ? kbMeta.directions : [];
        return directions.find((entry) => (entry?.value || '').toLowerCase() === String(value || '').toLowerCase());
      }

      function populateSubDirectionOptions(selectedValue) {
        const matched = findDirectionEntry(selectedValue);
        subDirectionInput.innerHTML = '';
        subDirectionInput.appendChild(new Option('–ë–µ–∑ –ø–æ–¥—Ç–∏–ø–∞', ''));
        const items = matched && Array.isArray(matched.subtypes) ? matched.subtypes : [];
        if (!items.length) {
          subDirectionInput.disabled = true;
          return;
        }
        subDirectionInput.disabled = false;
        items.forEach((item) => {
          if (!item?.value) return;
          const option = new Option(item.value, item.value);
          subDirectionInput.appendChild(option);
        });
      }

      function ensureOption(select, value, label) {
        if (!value) return;
        const exists = Array.from(select.options).some((opt) => opt.value === value);
        if (exists) return;
        const option = new Option(label || value, value);
        option.dataset.custom = '1';
        select.appendChild(option);
      }

      function populateDepartmentOptions() {
        const departments = Array.isArray(kbMeta.departments) ? kbMeta.departments : [];
        departmentInput.innerHTML = '';
        departmentInput.appendChild(new Option('–ë–µ–∑ –æ—Ç–¥–µ–ª–∞', ''));
        departments.forEach((dept) => {
          if (!dept?.label) return;
          departmentInput.appendChild(new Option(dept.label, dept.label));
        });
      }

      function populateStatusOptions() {
        const statuses = Array.isArray(kbMeta.statuses) ? kbMeta.statuses : [];
        statusInput.innerHTML = '';
        statusInput.appendChild(new Option('–ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞', ''));
        statuses.forEach((status) => {
          if (!status?.value) return;
          statusInput.appendChild(new Option(status.value, status.value));
        });
      }

      function populateAuthorOptions() {
        const authors = Array.isArray(kbMeta.authors) ? kbMeta.authors : [];
        authorInput.innerHTML = '';
        authorInput.appendChild(new Option('–ù–µ —É–∫–∞–∑–∞–Ω', ''));
        authors.forEach((author) => {
          if (!author?.label) return;
          authorInput.appendChild(new Option(author.label, author.label));
        });
      }

      function normalizeTypeValue(value) {
        return String(value || '').trim();
      }

      function metaTypeExists(value) {
        const normalized = normalizeTypeValue(value);
        const types = Array.isArray(kbMeta.types) ? kbMeta.types : [];
        return types.some((type) => normalizeTypeValue(type?.value) === normalized);
      }

      function ensureCustomTypeValue(value) {
        const normalized = normalizeTypeValue(value);
        if (!normalized || metaTypeExists(normalized) || customTypeValues.has(normalized)) {
          return false;
        }
        customTypeValues.add(normalized);
        return true;
      }

      function updateTypeButtonLabel() {
        if (!typeDropdownButton) return;
        const values = Array.from(selectedTypes);
        if (!values.length) {
          typeDropdownButton.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø—ã';
          return;
        }
        if (values.length <= 2) {
          typeDropdownButton.textContent = values.join(', ');
          return;
        }
        const [first, second] = values;
        typeDropdownButton.textContent = `${first}, ${second} +${values.length - 2}`;
      }

      function toggleTypeSelection(value, shouldSelect, { emitChange = false } = {}) {
        const normalized = normalizeTypeValue(value);
        if (!normalized) return;
        const beforeState = selectedTypes.has(normalized);
        if (shouldSelect) {
          selectedTypes.add(normalized);
        } else {
          selectedTypes.delete(normalized);
        }
        const entry = typeOptionMap.get(normalized);
        if (entry?.checkbox) {
          entry.checkbox.checked = selectedTypes.has(normalized);
        }
        updateTypeButtonLabel();
        if (beforeState !== selectedTypes.has(normalized)) {
          if (emitChange) {
            markDirty();
          }
          refreshMetaSummary();
        }
      }

      function addTypeOption(value, { isCustom = false } = {}) {
        if (!typeOptionsContainer) return;
        const normalized = normalizeTypeValue(value);
        if (!normalized || typeOptionMap.has(normalized)) return;
        const item = document.createElement('label');
        item.className = 'dropdown-item form-check align-items-center';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'form-check-input';
        checkbox.value = normalized;
        checkbox.checked = selectedTypes.has(normalized);
        checkbox.addEventListener('change', () => {
          toggleTypeSelection(normalized, checkbox.checked, { emitChange: true });
        });
        const text = document.createElement('span');
        text.className = 'form-check-label flex-grow-1';
        text.textContent = isCustom ? `${normalized} (–Ω–µ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ)` : value;
        item.appendChild(checkbox);
        item.appendChild(text);
        typeOptionsContainer.appendChild(item);
        typeOptionMap.set(normalized, { checkbox, element: item });
      }

      function rebuildTypeOptions() {
        typeOptionMap.clear();
        if (typeOptionsContainer) {
          typeOptionsContainer.innerHTML = '';
        }
        const types = Array.isArray(kbMeta.types) ? kbMeta.types : [];
        types.forEach((type) => {
          if (!type?.value) return;
          addTypeOption(type.value, { isCustom: false });
        });
        customTypeValues.forEach((value) => addTypeOption(value, { isCustom: true }));
        if (typeEmptyState) {
          const hasItems = Boolean(typeOptionsContainer?.children.length);
          typeEmptyState.style.display = hasItems ? 'none' : '';
        }
        updateTypeButtonLabel();
      }

      function setSelectedTypes(values) {
        selectedTypes.clear();
        customTypeValues.clear();
        const normalized = Array.isArray(values)
          ? values.map((value) => normalizeTypeValue(value)).filter(Boolean)
          : [];
        normalized.forEach((value) => {
          selectedTypes.add(value);
          if (!metaTypeExists(value)) {
            customTypeValues.add(value);
          }
        });
        rebuildTypeOptions();
        refreshMetaSummary();
      }

      function getSelectedTypes() {
        return Array.from(selectedTypes);
      }

      function handleCustomTypeAdd() {
        const value = normalizeTypeValue(typeCustomInput?.value || '');
        if (!value) {
          if (typeCustomInput) {
            typeCustomInput.focus();
          }
          return;
        }
        if (selectedTypes.has(value)) {
          setStatus(`–¢–∏–ø ¬´${value}¬ª —É–∂–µ –≤—ã–±—Ä–∞–Ω`, 'warning', 4000);
          return;
        }
        if (!metaTypeExists(value)) {
          ensureCustomTypeValue(value);
        }
        selectedTypes.add(value);
        rebuildTypeOptions();
        updateTypeButtonLabel();
        if (typeCustomInput) {
          typeCustomInput.value = '';
        }
        markDirty();
        refreshMetaSummary();
      }

      function extractArticleTypes(data) {
        if (Array.isArray(data.article_types)) {
          return data.article_types.filter((value) => typeof value === 'string' && value.trim()).map((value) => value.trim());
        }
        if (typeof data.article_type === 'string' && data.article_type.trim()) {
          return data.article_type.split(',').map((value) => value.trim()).filter(Boolean);
        }
        return [];
      }

      function populateMetadataControls() {
        populateDirectionOptions();
        populateDepartmentOptions();
        rebuildTypeOptions();
        populateStatusOptions();
        populateAuthorOptions();
      }

      function setStatus(message, type = 'success', timeout = 4000) {
        if (!message) {
          statusBox.innerHTML = '';
          return;
        }
        statusBox.innerHTML = `<div class="alert alert-${type} mb-0">${message}</div>`;
        if (timeout) {
          setTimeout(() => {
            statusBox.innerHTML = '';
          }, timeout);
        }
      }

      function populateForm() {
        titleInput.value = articleData.title || '';
        if (!currentArticleId && !titleInput.value && suggestedTitle) {
          titleInput.value = suggestedTitle;
        }

        const currentDirection = articleData.direction || '';
        ensureOption(directionInput, currentDirection, currentDirection);
        directionInput.value = currentDirection;
        populateSubDirectionOptions(currentDirection);

        const currentSubDirection = articleData.direction_subtype || '';
        if (currentSubDirection) {
          ensureOption(subDirectionInput, currentSubDirection, currentSubDirection);
          subDirectionInput.disabled = false;
        }
        subDirectionInput.value = currentSubDirection;

        const currentDepartment = articleData.department || '';
        ensureOption(departmentInput, currentDepartment, currentDepartment);
        departmentInput.value = currentDepartment;

        setSelectedTypes(extractArticleTypes(articleData));

        const currentStatus = articleData.status || '';
        ensureOption(statusInput, currentStatus, currentStatus);
        statusInput.value = currentStatus;

        const currentAuthor = articleData.author || '';
        ensureOption(authorInput, currentAuthor, currentAuthor);
        authorInput.value = currentAuthor;

        summaryInput.value = articleData.summary || '';
        if (currentArticleId) {
          articleIdBadge.style.display = '';
          articleIdValue.textContent = currentArticleId;
        }
        refreshMetaSummary();
      }

      function formatSummaryValue(value, { fallback = '‚Äî', maxLength = 0 } = {}) {
        const text = typeof value === 'string' ? value.trim() : '';
        if (!text) {
          return fallback;
        }
        if (maxLength && text.length > maxLength) {
          return `${text.slice(0, maxLength - 1)}‚Ä¶`;
        }
        return text;
      }

      function refreshMetaSummary() {
        if (!metaSummaryFields.title) return;
        metaSummaryFields.title.textContent = formatSummaryValue(titleInput.value);
        metaSummaryFields.direction.textContent = formatSummaryValue(directionInput.value);
        metaSummaryFields.subDirection.textContent = formatSummaryValue(subDirectionInput.value);
        metaSummaryFields.department.textContent = formatSummaryValue(departmentInput.value);
        metaSummaryFields.types.textContent = formatSummaryValue(getSelectedTypes().join(', '));
        metaSummaryFields.status.textContent = formatSummaryValue(statusInput.value);
        metaSummaryFields.author.textContent = formatSummaryValue(authorInput.value);
        metaSummaryFields.summary.textContent = formatSummaryValue(summaryInput.value, { maxLength: 160 });
      }

      function formatSize(bytes) {
        if (!bytes && bytes !== 0) return '';
        const sizes = ['–ë', '–ö–ë', '–ú–ë', '–ì–ë'];
        let index = 0;
        let size = bytes;
        while (size >= 1024 && index < sizes.length - 1) {
          size /= 1024;
          index++;
        }
        return `${size.toFixed(size >= 10 || index === 0 ? 0 : 1)} ${sizes[index]}`;
      }

      function insertAttachmentReference(file, { preferImageInline = true } = {}) {
        if (!file) return;
        const link = file.download_url || file.inline_url;
        if (!link) return;
        const name = file.name || '–§–∞–π–ª';
        if (preferImageInline && isImageFile(file) && file.inline_url) {
          editor.insertText(`![${name}](${file.inline_url})`);
        } else {
          editor.insertText(`[${name}](${link})`);
        }
      }

      function getAttachmentKey(file) {
        if (!file) return null;
        return (
          file.id ??
          file.inline_url ??
          file.download_url ??
          (file.name ? `${file.name}-${file.size || 0}` : null)
        );
      }

      function upsertAttachment(file, { silent = false } = {}) {
        if (!file) return null;
        const key = getAttachmentKey(file);
        let index = -1;
        if (key) {
          index = attachments.findIndex((item) => getAttachmentKey(item) === key);
        }
        if (index >= 0) {
          attachments[index] = file;
        } else {
          attachments.push(file);
        }
        if (!silent) {
          renderAttachments();
          markDirty();
        }
        return file;
      }

      function renderAttachments() {
        attachmentList.innerHTML = '';
        if (!attachments.length) {
          const empty = document.createElement('li');
          empty.className = 'list-group-item text-muted small text-center';
          empty.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –≤–ª–æ–∂–µ–Ω–∏–π';
          attachmentList.appendChild(empty);
          return;
        }
        attachments.forEach((file) => {
          const item = document.createElement('li');
          item.className = 'list-group-item d-flex justify-content-between align-items-center flex-wrap gap-2';
          const info = document.createElement('div');
          info.className = 'kb-attachment-info';
          if (isImageFile(file) && file.inline_url) {
            const thumb = document.createElement('img');
            thumb.src = file.inline_url;
            thumb.alt = file.name || '';
            thumb.className = 'kb-attachment-thumb';
            thumb.addEventListener('click', () => openImagePreview(file.inline_url, file.name));
            info.appendChild(thumb);
          }
          const textWrap = document.createElement('div');
          textWrap.innerHTML = `<div class="fw-semibold">${file.name}</div><div class="text-muted small">${formatSize(file.size)}</div>`;
          info.appendChild(textWrap);
          const actions = document.createElement('div');
          actions.className = 'kb-attachment-actions btn-group';
          if (file.download_url) {
            const downloadBtn = document.createElement('a');
            downloadBtn.className = 'btn btn-outline-secondary btn-sm';
            downloadBtn.href = file.download_url;
            downloadBtn.target = '_blank';
            downloadBtn.rel = 'noopener';
            downloadBtn.textContent = '–°–∫–∞—á–∞—Ç—å';
            actions.appendChild(downloadBtn);
          }
          if (file.download_url || file.inline_url) {
            const insertBtn = document.createElement('button');
            insertBtn.type = 'button';
            insertBtn.className = 'btn btn-outline-secondary btn-sm';
            insertBtn.textContent = '–í—Å—Ç–∞–≤–∏—Ç—å –≤ —Ç–µ–∫—Å—Ç';
            insertBtn.addEventListener('click', () => insertAttachmentReference(file));
            actions.appendChild(insertBtn);
          }
          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'btn btn-outline-danger btn-sm';
          removeBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
          removeBtn.addEventListener('click', async () => {
            await deleteAttachment(file.id);
          });
          actions.appendChild(removeBtn);
          item.appendChild(info);
          item.appendChild(actions);
          attachmentList.appendChild(item);
        });
      }

      async function deleteAttachment(id) {
        if (!id) return;
        try {
          await fetch(`/api/knowledge_base/uploads/${id}`, {
            method: 'DELETE',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
          });
        } catch (error) {
          console.error(error);
        }
        attachments = attachments.filter((item) => item.id !== id);
        renderAttachments();
        markDirty();
      }

      async function processFilesQueue(files, { insertIntoEditor = false } = {}) {
        const queue = Array.from(files || []);
        if (!queue.length) return;
        setStatus('–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...', 'info', 0);
        for (const file of queue) {
          try {
            const uploaded = await uploadAttachment(file);
            if (insertIntoEditor && uploaded) {
              insertAttachmentReference(uploaded);
            }
          } catch (error) {
            console.error(error);
            setStatus(error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª', 'danger', 6000);
          }
        }
        attachmentInput.value = '';
        setStatus('–§–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
      }

      async function uploadAttachment(file) {
        const formData = new FormData();
        formData.append('file', file, file.name || `file-${Date.now()}`);
        if (currentArticleId) {
          formData.append('article_id', currentArticleId);
        } else if (draftToken) {
          formData.append('draft_token', draftToken);
        }
        const response = await fetch('/api/knowledge_base/uploads', {
          method: 'POST',
          body: formData,
        });
        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª');
        }
        const data = await response.json();
        if (!data.success || !data.file) {
          throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª');
        }
        return upsertAttachment(data.file);
      }

      attachmentInput.addEventListener('change', async (event) => {
        const files = Array.from(event.target.files || []);
        if (!files.length) return;
        await processFilesQueue(files);
      });

      uploadButton.addEventListener('click', () => attachmentInput.click());

      ['dragenter', 'dragover'].forEach((eventName) => {
        attachmentDropzone.addEventListener(eventName, (event) => {
          event.preventDefault();
          event.stopPropagation();
          attachmentDropzone.classList.add('dragover');
        });
      });
      ['dragleave', 'drop'].forEach((eventName) => {
        attachmentDropzone.addEventListener(eventName, (event) => {
          event.preventDefault();
          event.stopPropagation();
          if (eventName === 'drop') {
            const files = Array.from(event.dataTransfer.files || []);
            if (files.length) {
              processFilesQueue(files);
            }
          }
          attachmentDropzone.classList.remove('dragover');
        });
      });

      function isNodeInsideEditor(node) {
        if (!node) return false;
        if (node.closest) {
          if (node.closest('.toastui-editor-defaultUI')) {
            return true;
          }
        }
        const parent = node.parentElement || node.parentNode;
        if (parent && parent !== node) {
          return isNodeInsideEditor(parent);
        }
        return false;
      }

      document.addEventListener('paste', (event) => {
        const files = Array.from((event.clipboardData && event.clipboardData.files) || []);
        if (!files.length) return;
        const insideEditor = isNodeInsideEditor(event.target);
        if (insideEditor) {
          return;
        }
        event.preventDefault();
        processFilesQueue(files);
      });

      const editor = new toastui.Editor({
        el: document.getElementById('kbEditor'),
        height: '600px',
        initialEditType: 'wysiwyg',
        previewStyle: 'vertical',
        usageStatistics: false,
        language: 'ru',
        toolbarItems: [
          ['heading', 'bold', 'italic', 'strike'],
          ['hr', 'quote', 'code', 'codeblock'],
          ['ul', 'ol', 'task'],
          ['table', 'link'],
          ['image'],
        ],
        hooks: {
          addImageBlobHook: async (blob, callback) => {
            try {
              const file = new File([blob], blob.name || `image-${Date.now()}.png`, { type: blob.type || 'image/png' });
              const uploaded = await uploadAttachment(file);
              callback(uploaded.inline_url || uploaded.download_url, uploaded.name);
            } catch (error) {
              console.error(error);
              setStatus(error.message, 'danger', 6000);
            }
          },
        },
      });

      function setupTaskListExitHelper() {
        const wwContents = document.querySelector('.toastui-editor-ww-container .toastui-editor-contents');
        if (!wwContents) return;
        wwContents.addEventListener(
          'keydown',
          (event) => {
            if (event.key !== 'Enter' || event.shiftKey || event.altKey || event.metaKey || event.ctrlKey) {
              return;
            }
            const selection = window.getSelection();
            if (!selection || selection.rangeCount === 0) return;
            let node = selection.anchorNode;
            if (node && node.nodeType === Node.TEXT_NODE) {
              node = node.parentElement;
            }
            const listItem = node?.closest ? node.closest('li') : null;
            if (!listItem) return;
            const textContent = listItem.textContent.replace(/\u200B/g, '').trim();
            if (textContent) return;
            event.preventDefault();
            editor.exec('taskList');
            setTimeout(() => {
              editor.insertText('\n');
            }, 0);
          },
          true
        );
      }

      function setupEditorImagePreview() {
        const containers = document.querySelectorAll(
          '.toastui-editor-ww-container .toastui-editor-contents, .toastui-editor-md-preview'
        );
        containers.forEach((container) => {
          container.addEventListener('click', (event) => {
            const target = event.target;
            if (!(target instanceof Element) || target.tagName !== 'IMG') {
              return;
            }
            const src = target.getAttribute('src');
            if (!src) return;
            event.preventDefault();
            openImagePreview(src, target.getAttribute('alt') || '');
          });
        });
      }

      if (articleData.content) {
        editor.setHTML(articleData.content);
      }

      setTimeout(() => {
        setupTaskListExitHelper();
        setupEditorImagePreview();
      }, 400);

      pauseDirtyTracking();
      populateMetadataControls();
      populateForm();
      renderAttachments();
      resetDirtyState();
      resumeDirtyTracking();

      directionInput.addEventListener('change', () => {
        const nextValue = directionInput.value;
        populateSubDirectionOptions(nextValue);
        subDirectionInput.value = '';
        refreshMetaSummary();
      });

      [titleInput, directionInput, subDirectionInput, departmentInput, statusInput, authorInput, summaryInput].forEach((input) => {
        if (!input) return;
        const handler = () => {
          markDirty();
          refreshMetaSummary();
        };
        input.addEventListener('input', handler);
        input.addEventListener('change', handler);
      });

      if (typeCustomAddButton) {
        typeCustomAddButton.addEventListener('click', handleCustomTypeAdd);
      }
      if (typeCustomInput) {
        typeCustomInput.addEventListener('keydown', (event) => {
          if (event.key === 'Enter') {
            event.preventDefault();
            handleCustomTypeAdd();
          }
        });
      }

      if (editor) {
        editor.on('change', markDirty);
      }

      async function saveArticle() {
        const selectedTypeValues = getSelectedTypes();
        const payload = {
          title: titleInput.value.trim(),
          direction: directionInput.value.trim(),
          direction_subtype: subDirectionInput.value.trim(),
          department: departmentInput.value.trim(),
          article_type: selectedTypeValues.join(', '),
          article_types: selectedTypeValues,
          status: statusInput.value.trim(),
          author: authorInput.value.trim(),
          summary: summaryInput.value.trim(),
          content: editor.getHTML(),
          attachments: attachments.map((file) => file.id),
        };
        if (!payload.title) {
          setStatus('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏', 'danger', 5000);
          titleInput.focus();
          return;
        }
        saveButton.disabled = true;
        setStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...', 'info', 0);
        const url = currentArticleId ? `/api/knowledge_base/articles/${currentArticleId}` : '/api/knowledge_base/articles';
        const method = currentArticleId ? 'PUT' : 'POST';
        try {
          const response = await fetch(url, {
            method,
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify(payload),
          });
          const data = await response.json();
          if (!response.ok || !data.success) {
            throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç—å—é');
          }
          currentArticleId = data.item.id;
          attachments = Array.isArray(data.item.files) ? data.item.files.slice() : [];
          renderAttachments();
          articleIdBadge.style.display = '';
          articleIdValue.textContent = currentArticleId;
          setStatus('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
          resetDirtyState();
          if (!articleData.id) {
            history.replaceState({}, '', `/knowledge_base/${currentArticleId}`);
          }
          articleData.id = currentArticleId;
        } catch (error) {
          console.error(error);
          setStatus(error.message, 'danger', 6000);
        } finally {
          saveButton.disabled = false;
        }
      }

      saveButton.addEventListener('click', saveArticle);
    })();
  </script>
</body>
</html>
