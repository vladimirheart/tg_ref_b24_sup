<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ù–æ–≤—ã–π –ø–∞—Å–ø–æ—Ä—Ç –æ–±—ä–µ–∫—Ç–∞</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='sidebar.css') }}" rel="stylesheet" />
  <style>
    body.with-sidebar .main-content {
      background-color: #f4f6fb;
      min-height: 100vh;
    }
    .passport-container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .passport-overview,
    .passport-card {
      border: 0;
      border-radius: 1rem;
      background: #ffffff;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
    }
    .passport-card {
      box-shadow: 0 14px 32px rgba(15, 23, 42, 0.05);
    }
    .passport-overview .card-body {
      padding: 1.75rem 2rem;
    }
    .passport-card .card-header {
      background: linear-gradient(135deg, rgba(13, 110, 253, 0.08), rgba(32, 201, 151, 0.08));
      border: 0;
      border-radius: 1rem 1rem 0 0;
      padding: 1rem 1.5rem;
      font-weight: 600;
      color: #0f172a;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .passport-card .card-body {
      padding: 1.5rem;
    }
    .passport-card .card-body .row.g-3,
    .passport-card .card-body .row.g-4 {
      --bs-gutter-y: 0.75rem;
      --bs-gutter-x: 0.75rem;
    }
    .card h5 { margin-bottom: 0; }
    .schedule-table input[type="time"] { max-width: 120px; }
    .photo-card img { object-fit: cover; height: 180px; }
    .photo-card .card-body { font-size: 0.9rem; }
    .equipment-card textarea { min-height: 80px; }
    .equipment-card .card-header { flex-wrap: wrap; gap: 0.75rem; }
    .equipment-card .equipment-actions { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .equipment-card .equipment-header-toggle {
      border: 0;
      background: transparent;
      padding: 0;
      margin: -0.25rem 0;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: inherit;
      text-align: left;
      flex: 1;
      cursor: pointer;
    }
    .equipment-card .equipment-header-toggle:focus {
      outline: none;
      box-shadow: none;
    }
    .equipment-card .equipment-header-summary { display: flex; flex-direction: column; gap: 0.35rem; flex: 1; min-width: 0; }
    .equipment-card .equipment-header-title {
      font-weight: 600;
      color: #0f172a;
      white-space: normal;
      word-break: break-word;
    }
    .equipment-card .equipment-header-meta { display: flex; flex-wrap: wrap; gap: 0.75rem; font-size: 0.85rem; color: #475569; }
    .equipment-card .equipment-header-meta strong { color: #334155; font-weight: 600; }
    .equipment-card .equipment-header-meta span { display: inline-flex; gap: 0.35rem; align-items: baseline; min-width: 0; }
    .equipment-card .equipment-header-meta span span { white-space: normal; word-break: break-word; }
    .equipment-card .equipment-header-icon { font-size: 0.65rem; transition: transform 0.2s ease; }
    .equipment-card .equipment-header-toggle.collapsed .equipment-header-icon { transform: rotate(-90deg); }
    .equipment-photo img { object-fit: cover; height: 150px; }
    .equipment-photo .card-body { font-size: 0.85rem; }
    .form-control-plaintext { padding-left: 0; }
    .object-title { font-size: 1.15rem; }
    .title-photo-preview { width: 180px; height: 120px; border-radius: 0.75rem; overflow: hidden; background: #f1f5f9; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(15, 23, 42, 0.08); }
    .title-photo-preview img { width: 100%; height: 100%; object-fit: cover; }
    .section-collapse { display: none; }
    .section-collapse.show { display: block; }
    .card-toggle-btn { white-space: nowrap; border-radius: 999px; }
    .table-row-link { cursor: pointer; }
    .passport-card .card-body .form-label { font-weight: 600; font-size: 0.85rem; color: #2f3b52; }
     #itBlock { border-top: 1px solid rgba(15, 23, 42, 0.08); padding-top: 1.5rem; }
    .it-equipment-list { border: 1px solid rgba(15, 23, 42, 0.08); border-radius: 0.75rem; padding: 0.75rem 1rem; background-color: #f8fafc; }
    .it-equipment-item { display: flex; justify-content: space-between; gap: 1rem; font-size: 0.9rem; padding: 0.25rem 0; }
    .it-equipment-item + .it-equipment-item { border-top: 1px dashed rgba(15, 23, 42, 0.12); }
    .it-equipment-name { font-weight: 600; color: #0f172a; }
    .it-equipment-ip { font-family: 'SFMono-Regular', Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; color: #475569; }
    .it-equipment-empty { color: #64748b; font-size: 0.9rem; }
    .network-equipment-summary { border: 1px solid rgba(15, 23, 42, 0.08); border-radius: 0.75rem; padding: 0.75rem 1rem; background-color: #f8fafc; min-height: 3rem; display: flex; align-items: center; }
    .network-equipment-list { width: 100%; display: flex; flex-direction: column; gap: 0.35rem; }
    .network-equipment-entry { display: flex; justify-content: space-between; gap: 0.5rem; font-size: 0.9rem; }
    .network-equipment-name { font-weight: 600; color: #0f172a; }
    .network-equipment-ip { font-family: 'SFMono-Regular', Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; color: #475569; }
    .network-equipment-separator { color: #94a3b8; font-weight: 600; }
    .network-equipment-empty { font-size: 0.9rem; }
    .passport-card .form-control,
    .passport-card .form-select { font-size: 0.9rem; }
    .searchable-select.dropdown { width: 100%; }
    .searchable-select .dropdown-toggle { text-align: left; display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; }
    .searchable-select .dropdown-toggle .searchable-select-label { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .searchable-select .dropdown-menu { width: 100%; max-height: 320px; overflow: hidden; }
    .searchable-select .searchable-select-options { max-height: 240px; overflow-y: auto; }
    .searchable-select .dropdown-item.active { background-color: rgba(13, 110, 253, 0.15); color: #0d6efd; }
    .searchable-select .dropdown-item.active:hover { background-color: rgba(13, 110, 253, 0.25); }
    .searchable-select .dropdown-item { white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
    .select-search-wrapper { display: flex; flex-direction: column; gap: 0.25rem; }
    .select-search-wrapper .input-group { flex-wrap: nowrap; }
    .select-search-input { font-size: 0.85rem; }
    .status-history-list { display: flex; flex-direction: column; gap: 0.75rem; }
    .status-history-entry { padding: 0.75rem 1rem; border: 1px solid rgba(15, 23, 42, 0.08); border-radius: 0.75rem; background: #f8fafc; }
    .status-history-entry .history-dates { font-weight: 600; }
    .status-history-entry .history-duration { font-size: 0.85rem; color: #64748b; }
    .title-photo-preview { cursor: zoom-in; }
    .photo-card { position: relative; overflow: hidden; }
    .photo-card .card-img-top { cursor: zoom-in; border-radius: 0.75rem 0.75rem 0 0; }
    .photo-card .photo-toolbar { position: absolute; top: 0.5rem; right: 0.5rem; z-index: 2; }
    .photo-card .title-indicator { position: absolute; top: 0.5rem; left: 0.5rem; z-index: 2; display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 50%; background: rgba(25, 135, 84, 0.9); color: #fff; font-size: 1rem; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.35); }
    .photo-card .photo-caption-text { white-space: pre-wrap; word-break: break-word; }
    .photo-card .photo-meta { font-size: 0.8rem; color: #6b7280; }
    .photo-card .photo-edit-form { background-color: #f8fafc; border-radius: 0.75rem; padding: 0.75rem; }
    .passport-photo { cursor: zoom-in; }
    .equipment-photo img { cursor: zoom-in; }
    .equipment-photos-toggle::after { content: '‚ñº'; margin-left: 0.35rem; transition: transform 0.2s ease; font-size: 0.75rem; }
    .equipment-photos-toggle.collapsed::after { transform: rotate(-90deg); }
    @media (max-width: 576px) {
      .title-photo-preview { width: 140px; height: 90px; }
      .passport-overview .card-body { padding: 1.25rem; }
      .passport-card .card-header { padding: 0.75rem 1rem; }
      .passport-card .card-body { padding: 1rem; }
    }
  </style>
</head>
<body class="with-sidebar sidebar-pinned">
  {% include "_sidebar.html" %}
  <main class="main-content container-fluid">
    <div class="passport-container container-xxl mt-4">
      <div class="card passport-overview mb-4">
        <div class="card-body">
          <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
            <div class="d-flex flex-wrap align-items-start gap-3">
              <div>
                <h2 class="mb-1">üóÇ –ü–∞—Å–ø–æ—Ä—Ç –æ–±—ä–µ–∫—Ç–∞</h2>
                <div class="text-muted object-title" id="objectTitle">‚Äî</div>
                <div class="d-flex flex-wrap align-items-center gap-2 mt-2">
                  <span class="badge bg-secondary status-badge" id="statusBadge">‚Äî</span>
                  <span class="badge bg-secondary status-badge" id="networkBadge">–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å–µ—Ç—å: ‚Äî</span>
                </div>
              </div>
              <div class="title-photo-preview d-none" id="titlePhotoPreview">
                <img src="" alt="–¢–∏—Ç—É–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ" id="titlePhotoImage" />
              </div>
            </div>
            <div class="d-flex flex-wrap gap-2">
              <a class="btn btn-outline-secondary" href="/object_passports" target="_self">‚Üê –ö —Å–ø–∏—Å–∫—É</a>
              <button class="btn btn-primary" id="savePassportBtn" type="button">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
          </div>
          <div class="alert d-none mt-3 mb-0" role="alert" id="saveStatus"></div>
        </div>
      </div>

      <div class="card passport-card mb-4" id="basicInfoCard">
        <div class="card-header d-flex justify-content-between align-items-center" data-section-header data-target="#basicInfoBody">
          <span>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</span>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary card-toggle-btn" type="button" id="toggleItBlockBtn" aria-expanded="false">–†–∞—Å–∫—Ä—ã—Ç—å IT-–±–ª–æ–∫</button>
            <button class="btn btn-sm btn-outline-secondary card-toggle-btn" type="button" data-section-toggle data-target="#basicInfoBody" aria-expanded="true">–°–≤–µ—Ä–Ω—É—Ç—å ‚ñ≤</button>
          </div>
        </div>
        <div class="section-collapse show" id="basicInfoBody">
          <div class="card-body">
          <div class="row g-3">
            <div class="col-sm-6 col-xl-4">
              <label class="form-label">–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç<span class="text-danger">*</span></label>
              <div class="searchable-select dropdown" data-select-id="departmentSelect" data-force-custom-dropdown>
                <select class="form-select d-none" id="departmentSelect">
                  <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                  {% for value in parameter_values.get('department', []) %}
                  <option value="{{ value }}">{{ value }}</option>
                  {% endfor %}
                </select>
                <div class="input-group input-group-sm">
                  <button class="btn btn-outline-secondary dropdown-toggle flex-grow-1 text-start" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside">
                    <span class="searchable-select-label">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</span>
                  </button>
                  <button class="btn btn-outline-secondary" type="button" data-action="add-parameter" data-param-type="department" data-target="departmentSelect">+</button>
                </div>
                <div class="dropdown-menu p-2 shadow-sm">
                  <input type="text" class="form-control form-control-sm mb-2 searchable-select-search" placeholder="–ü–æ–∏—Å–∫..." />
                  <div class="searchable-select-options" role="listbox"></div>
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-xl-4">
              <label class="form-label">–ë–∏–∑–Ω–µ—Å</label>
              <div class="searchable-select dropdown" data-select-id="businessSelect" data-force-custom-dropdown>
                <select class="form-select d-none" id="businessSelect">
                  <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                  {% for value in parameter_values.get('business', []) %}
                  <option value="{{ value }}">{{ value }}</option>
                  {% endfor %}
                </select>
                <div class="input-group input-group-sm">
                  <button class="btn btn-outline-secondary dropdown-toggle flex-grow-1 text-start" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside">
                    <span class="searchable-select-label">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</span>
                  </button>
                  <button class="btn btn-outline-secondary" type="button" data-action="add-parameter" data-param-type="business" data-target="businessSelect">+</button>
                </div>
                <div class="dropdown-menu p-2 shadow-sm">
                  <input type="text" class="form-control form-control-sm mb-2 searchable-select-search" placeholder="–ü–æ–∏—Å–∫..." />
                  <div class="searchable-select-options" role="listbox"></div>
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-xl-4">
              <label class="form-label">–¢–∏–ø –ø–∞—Ä—Ç–Ω—ë—Ä–∞</label>
              <div class="searchable-select dropdown" data-select-id="partnerTypeSelect" data-force-custom-dropdown>
                <select class="form-select d-none" id="partnerTypeSelect">
                  <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                  {% for value in parameter_values.get('partner_type', []) %}
                  <option value="{{ value }}">{{ value }}</option>
                  {% endfor %}
                </select>
                <div class="input-group input-group-sm">
                  <button class="btn btn-outline-secondary dropdown-toggle flex-grow-1 text-start" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside">
                    <span class="searchable-select-label">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</span>
                  </button>
                  <button class="btn btn-outline-secondary" type="button" data-action="add-parameter" data-param-type="partner_type" data-target="partnerTypeSelect">+</button>
                </div>
                <div class="dropdown-menu p-2 shadow-sm">
                  <input type="text" class="form-control form-control-sm mb-2 searchable-select-search" placeholder="–ü–æ–∏—Å–∫..." />
                  <div class="searchable-select-options" role="listbox"></div>
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-xl-4">
              <label class="form-label">–°—Ç—Ä–∞–Ω–∞</label>
              <div class="searchable-select dropdown" data-select-id="countrySelect" data-force-custom-dropdown>
                <select class="form-select d-none" id="countrySelect">
                  <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                  {% for value in parameter_values.get('country', []) %}
                  <option value="{{ value }}">{{ value }}</option>
                  {% endfor %}
                </select>
                <div class="input-group input-group-sm">
                  <button class="btn btn-outline-secondary dropdown-toggle flex-grow-1 text-start" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside">
                    <span class="searchable-select-label">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</span>
                  </button>
                  <button class="btn btn-outline-secondary" type="button" data-action="add-parameter" data-param-type="country" data-target="countrySelect">+</button>
                </div>
                <div class="dropdown-menu p-2 shadow-sm">
                  <input type="text" class="form-control form-control-sm mb-2 searchable-select-search" placeholder="–ü–æ–∏—Å–∫..." />
                  <div class="searchable-select-options" role="listbox"></div>
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-xl-4">
              <label class="form-label">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ</label>
              <div class="searchable-select dropdown" data-select-id="legalEntitySelect" data-force-custom-dropdown>
                <select class="form-select d-none" id="legalEntitySelect">
                  <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                  {% for value in parameter_values.get('legal_entity', []) %}
                  <option value="{{ value }}">{{ value }}</option>
                  {% endfor %}
                </select>
                <div class="input-group input-group-sm">
                  <button class="btn btn-outline-secondary dropdown-toggle flex-grow-1 text-start" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside">
                    <span class="searchable-select-label">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</span>
                  </button>
                  <button class="btn btn-outline-secondary" type="button" data-action="add-parameter" data-param-type="legal_entity" data-target="legalEntitySelect">+</button>
                </div>
                <div class="dropdown-menu p-2 shadow-sm">
                  <input type="text" class="form-control form-control-sm mb-2 searchable-select-search" placeholder="–ü–æ–∏—Å–∫..." />
                  <div class="searchable-select-options" role="listbox"></div>
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-xl-4">
              <label class="form-label">–ì–æ—Ä–æ–¥</label>
              <input type="text" id="cityInput" class="form-control form-control-sm" list="citiesList" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ú–æ—Å–∫–≤–∞" />
              <datalist id="citiesList">
                {% for value in cities %}
                <option value="{{ value }}"></option>
                {% endfor %}
              </datalist>
            </div>
            <div class="col-12">
              <label class="form-label">–ê–¥—Ä–µ—Å –ª–æ–∫–∞—Ü–∏–∏</label>
              <input type="text" class="form-control form-control-sm" id="locationAddressInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –≥. –í–æ–ª–≥–æ–≥—Ä–∞–¥ —É–ª. –õ–µ–Ω–∏–Ω–∞, 1" data-no-auto-expand="true" />
            </div>
            <div class="col-sm-6 col-xl-4">
              <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
              <div class="searchable-select dropdown" data-select-id="statusSelect" data-force-custom-dropdown>
                <select class="form-select d-none" id="statusSelect">
                  {% for value in statuses %}
                  <option value="{{ value }}">{{ value }}</option>
                  {% endfor %}
                </select>
                <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside">
                  <span class="searchable-select-label">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</span>
                </button>
                <div class="dropdown-menu p-2 shadow-sm">
                  <input type="text" class="form-control form-control-sm mb-2 searchable-select-search" placeholder="–ü–æ–∏—Å–∫..." />
                  <div class="searchable-select-options" role="listbox"></div>
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-xl-4">
              <label class="form-label">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –æ–±—ä–µ–∫—Ç–∞</label>
              <input type="text" class="form-control form-control-sm" id="itObjectPhoneInput" placeholder="+7..." />
            </div>
            <div class="col-sm-6 col-xl-4">
              <label class="form-label">–£–ø—Ä–∞–≤–ª—è—é—â–∏–π</label>
              <input type="text" class="form-control form-control-sm" id="itManagerNameInput" placeholder="–§–ò–û —É–ø—Ä–∞–≤–ª—è—é—â–µ–≥–æ" />
            </div>
            <div class="col-sm-6 col-xl-4">
              <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω —É–ø—Ä–∞–≤–ª—è—é—â–µ–≥–æ</label>
              <input type="text" class="form-control form-control-sm" id="itManagerPhoneInput" placeholder="+7..." />
            </div>
            <div class="col-sm-6 col-xl-4">
              <label class="form-label">–î–∞—Ç–∞ –∑–∞–ø—É—Å–∫–∞</label>
              <input type="date" class="form-control form-control-sm" id="startDateInput" />
            </div>
            <div class="col-sm-6 col-xl-4">
              <label class="form-label">–î–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è</label>
              <input type="date" class="form-control form-control-sm" id="endDateInput" />
            </div>
            <div class="col-sm-6 col-xl-4">
              <label class="form-label">–î–∞—Ç–∞ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∏</label>
              <input type="date" class="form-control form-control-sm" id="suspensionDateInput" />
            </div>
            <div class="col-sm-6 col-xl-4">
              <label class="form-label">–î–∞—Ç–∞ —Ä–∞–∑–º–æ—Ä–æ–∑–∫–∏</label>
              <input type="date" class="form-control form-control-sm" id="resumeDateInput" />
            </div>
            <div class="col-sm-6 col-xl-4">
              <label class="form-label">–û–±—â–µ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</label>
              <div class="form-control-plaintext fw-semibold" id="totalTimeDisplay">‚Äî</div>
            </div>
            <div class="col-sm-6 col-xl-4">
              <label class="form-label">–í—Ä–µ–º—è –≤ —Å—Ç–∞—Ç—É—Å–∞—Ö –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∏</label>
              <div class="form-control-plaintext fw-semibold" id="statusHistoryTotal">‚Äî</div>
            </div>
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label mb-0" for="statusHistoryCollapse">–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–æ–∫</label>
                <button class="btn btn-sm btn-outline-secondary d-none" type="button" id="statusHistoryToggle" data-bs-toggle="collapse" data-bs-target="#statusHistoryCollapse" aria-expanded="false">–ü–æ–∫–∞–∑–∞—Ç—å ‚ñº</button>
              </div>
              <div class="text-muted small" id="statusHistoryEmpty">–ò—Å—Ç–æ—Ä–∏—è –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞.</div>
              <div class="collapse mt-2" id="statusHistoryCollapse">
                <div class="status-history-list" id="statusHistoryList"></div>
              </div>
            </div>
            <div class="col-12 col-lg-6 d-none" id="statusTaskContainer">
              <label class="form-label">–°–≤—è–∑–∞–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞<span class="text-danger">*</span></label>
              <div class="select-search-wrapper">
                <input type="text" class="form-control form-control-sm mb-2 select-search-input" data-select-target="statusTaskSelect" id="statusTaskSearchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é" autocomplete="off" />
                <select class="form-select form-select-sm" id="statusTaskSelect">
                  <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                </select>
              </div>
              <div class="form-text" id="statusTaskHint">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É, –æ—Ç—Ä–∞–∂–∞—é—â—É—é —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞.</div>
              <div class="small mt-2 text-muted" id="statusTaskInfo"></div>
            </div>
          </div>
          <div class="mt-4 it-block d-none" id="itBlock" data-user-collapsed="true">
            <h6 class="text-uppercase text-muted small mb-3">IT-–±–ª–æ–∫</h6>
            <div class="row g-3">
            <div class="col-12">
              <label class="form-label">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏ IP-–∞–¥—Ä–µ—Å–∞</label>
              <div class="it-equipment-list" id="itEquipmentList">
                <div class="it-equipment-empty">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ.</div>
              </div>
            </div>
              <div class="col-12 col-lg-6">
                <label class="form-label">–ê–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ iiko</label>
                <select class="form-select form-select-sm" id="iikoServerSelect">
                  <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                  {% for option in iiko_server_options %}
                  <option value="{{ option }}">{{ option }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">–ó–∞—Ç—Ä–∞—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ –æ–±—Ä–∞—â–µ–Ω–∏—è–º</label>
                <div class="form-control-plaintext fw-semibold" id="caseTimeDisplay">‚Äî</div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">–ó–∞—Ç—Ä–∞—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ –∑–∞–¥–∞—á–∞–º</label>
                <div class="form-control-plaintext fw-semibold" id="taskTimeDisplay">‚Äî</div>
              </div>
            </div>
          </div>
          </div>
        </div>
      </div>
      </div>

      <div class="card passport-card mb-4" id="networkCard">
      <div class="card-header d-flex justify-content-between align-items-center" data-section-header data-target="#networkBody">
          <span>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ç–∏</span>
          <button class="btn btn-sm btn-outline-secondary card-toggle-btn" type="button" data-section-toggle data-target="#networkBody" aria-expanded="false">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å ‚ñº</button>
        </div>
        <div class="section-collapse" id="networkBody">
          <div class="card-body network-info">
            <div class="row g-4">
              <div class="col-12 col-xl-6">
                <h6 class="text-uppercase text-muted small mb-3">–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å–µ—Ç—å</h6>
                <div class="row g-3">
                  <div class="col-12">
                    <label class="form-label">–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å–µ—Ç—å</label>
                    <input type="text" class="form-control form-control-sm" id="internalNetworkInput" list="internalNetworkOptions" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, CorpLAN" />
                  </div>
                  <div class="col-12">
                    <label class="form-label">–¢—É–Ω–Ω–µ–ª—å</label>
                    <input type="text" class="form-control form-control-sm" id="networkTunnelInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, VPN-01" />
                  </div>
                  <div class="col-12">
                    <label class="form-label">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ (–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ ¬∑ IP)</label>
                    <div class="network-equipment-summary" id="networkEquipmentSummary">
                      <div class="network-equipment-empty text-muted">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ.</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-xl-6">
                <h6 class="text-uppercase text-muted small mb-3">–ü—Ä–æ–≤–∞–π–¥–µ—Ä</h6>
                <div class="row g-3">
                  <div class="col-12">
                    <label class="form-label">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞</label>
                    <input type="text" class="form-control form-control-sm" id="networkProviderInput" list="networkProviderOptions" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –†–æ—Å—Ç–µ–ª–µ–∫–æ–º" />
                  </div>
                  <div class="col-sm-6 col-xl-6">
                    <label class="form-label">–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞</label>
                    <input type="text" class="form-control form-control-sm" id="networkContractInput" list="networkContractOptions" placeholder="‚Ññ –¥–æ–≥–æ–≤–æ—Ä–∞" />
                  </div>
                  <div class="col-sm-6 col-xl-6">
                    <label class="form-label">–Æ–õ</label>
                    <input type="text" class="form-control form-control-sm" id="networkLegalEntityInput" list="networkLegalEntityOptions" placeholder="–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ" />
                  </div>
                  <div class="col-sm-6 col-xl-6">
                    <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω –¢–ü –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞</label>
                    <input type="text" class="form-control form-control-sm" id="networkSupportPhoneInput" list="networkSupportPhoneOptions" placeholder="–ö–æ–Ω—Ç–∞–∫—Ç –¢–ü" />
                  </div>
                  <div class="col-sm-6 col-xl-6">
                    <label class="form-label">–°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</label>
                    <input type="text" class="form-control form-control-sm" id="networkSpeedInput" list="networkSpeedOptions" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 100 –ú–±–∏—Ç/—Å" />
                  </div>
                </div>
              </div>
              <div class="col-12">
                <label class="form-label">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ç–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç</label>
                <textarea class="form-control form-control-sm" id="networkParamsInput" rows="3" placeholder="IP, VLAN, –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –∏ —Ç.–¥."></textarea>
              </div>
              <div class="col-12">
                <label class="form-label">–§–∞–π–ª—ã</label>
                <form class="row g-2 align-items-end" id="networkFilesForm">
                  <div class="col-md-6 col-lg-4">
                    <input type="file" class="form-control form-control-sm" name="file" required />
                  </div>
                  <div class="col-md-2 col-lg-2">
                    <button class="btn btn-outline-primary btn-sm w-100" type="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                  </div>
                </form>
                <div class="list-group list-group-flush mt-3" id="networkFilesList"></div>
                <div class="text-muted small" id="networkFilesEmptyText">–§–∞–π–ª—ã –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</div>
              </div>
            </div>
            <datalist id="internalNetworkOptions">
              {% for value in parameter_values.get('network', []) %}
              {% if value %}
              <option value="{{ value }}"></option>
              {% endif %}
              {% endfor %}
            </datalist>
            <datalist id="networkProviderOptions">
              {% for value in network_provider_options %}
              {% if value %}
              <option value="{{ value }}"></option>
              {% endif %}
              {% endfor %}
            </datalist>
            <datalist id="networkContractOptions">
              {% for value in network_contract_options %}
              {% if value %}
              <option value="{{ value }}"></option>
              {% endif %}
              {% endfor %}
            </datalist>
            <datalist id="networkSupportPhoneOptions">
              {% for value in network_support_phone_options %}
              {% if value %}
              <option value="{{ value }}"></option>
              {% endif %}
              {% endfor %}
            </datalist>
            <datalist id="networkSpeedOptions">
              {% for value in network_speed_options %}
              {% if value %}
              <option value="{{ value }}"></option>
              {% endif %}
              {% endfor %}
            </datalist>
            <datalist id="networkLegalEntityOptions">
              {% for value in network_legal_entity_options %}
              {% if value %}
              <option value="{{ value }}"></option>
              {% endif %}
              {% endfor %}
            </datalist>
          </div>
        </div>
      </div>

      <div class="card passport-card mb-4" id="scheduleCard">
        <div class="card-header d-flex justify-content-between align-items-center" data-section-header data-target="#scheduleBody">
          <span>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</span>
          <button class="btn btn-sm btn-outline-secondary card-toggle-btn" type="button" data-section-toggle data-target="#scheduleBody" aria-expanded="false">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å ‚ñº</button>
        </div>
        <div class="section-collapse" id="scheduleBody">
          <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm align-middle schedule-table" id="scheduleTable">
              <thead>
                <tr>
                  <th>–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏</th>
                  <th>–°</th>
                  <th>–ü–æ</th>
                  <th>24 —á–∞—Å–∞</th>
                </tr>
              </thead>
              <tbody>
                {% for key, full, short in day_labels %}
                <tr data-day="{{ key }}">
                  <td>{{ full }}</td>
                  <td><input type="time" class="form-control form-control-sm schedule-from" /></td>
                  <td><input type="time" class="form-control form-control-sm schedule-to" /></td>
                  <td>
                    <div class="form-check">
                      <input class="form-check-input schedule-24" type="checkbox" id="schedule24_{{ key }}" />
                      <label class="form-check-label" for="schedule24_{{ key }}">–ö—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ</label>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
		  </div>
        </div>
      </div>

      <div class="card passport-card mb-4" id="casesCard">
        <div class="card-header d-flex justify-content-between align-items-center" data-section-header data-target="#casesBody">
          <span>–û–±—Ä–∞—â–µ–Ω–∏—è –ø–æ –ª–æ–∫–∞—Ü–∏–∏</span>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-secondary card-toggle-btn" type="button" data-section-toggle data-target="#casesBody" aria-expanded="false">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å ‚ñº</button>
            <button class="btn btn-sm btn-outline-primary" id="refreshCasesBtn" type="button">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
          </div>
        </div>
        <div class="section-collapse" id="casesBody">
          <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>ID –∑–∞—è–≤–∫–∏</th>
                  <th>–ë–∏–∑–Ω–µ—Å</th>
                  <th>–ì–æ—Ä–æ–¥</th>
                  <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                  <th>–°–æ–∑–¥–∞–Ω–æ</th>
                </tr>
              </thead>
              <tbody id="casesTableBody"></tbody>
            </table>
          </div>
          <div class="text-muted" id="casesEmptyText">–û–±—Ä–∞—â–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</div>
		  </div>
        </div>
      </div>

      <div class="card passport-card mb-4" id="tasksCard">
        <div class="card-header d-flex justify-content-between align-items-center" data-section-header data-target="#tasksBody">
          <span>–ó–∞–¥–∞—á–∏ –ø–æ –ª–æ–∫–∞—Ü–∏–∏</span>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-secondary card-toggle-btn" type="button" data-section-toggle data-target="#tasksBody" aria-expanded="false">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å ‚ñº</button>
            <button class="btn btn-sm btn-outline-primary" id="refreshTasksBtn" type="button">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
          </div>
        </div>
        <div class="section-collapse" id="tasksBody">
          <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm table-striped align-middle">
              <thead>
                <tr>
                  <th>‚Ññ –∑–∞–¥–∞—á–∏</th>
                  <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                  <th>–°—Ç–∞—Ç—É—Å</th>
                  <th>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</th>
                  <th>–î–µ–¥–ª–∞–π–Ω</th>
                  <th>–û–±–Ω–æ–≤–ª–µ–Ω–æ</th>
                </tr>
              </thead>
              <tbody id="tasksTableBody"></tbody>
            </table>
          </div>
          <div class="text-muted" id="tasksEmptyText">–ó–∞–¥–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</div>
                  </div>
        </div>
      </div>

      <div class="card passport-card mb-4" id="photosSection">
        <div class="card-header d-flex justify-content-between align-items-center" data-section-header data-target="#photosBody">
          <span>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –æ–±—ä–µ–∫—Ç–∞</span>
          <button class="btn btn-sm btn-outline-secondary card-toggle-btn" type="button" data-section-toggle data-target="#photosBody" aria-expanded="false">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å ‚ñº</button>
        </div>
        <div class="section-collapse" id="photosBody">
          <div class="card-body">
          <div class="alert alert-warning d-none" id="photosDisabledHint">–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–ª—è—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏.</div>
          <form class="row g-3 align-items-end mb-3" id="photoUploadForm">
            <div class="col-md-3">
              <label class="form-label">–¢–∏–ø —Ñ–æ—Ç–æ</label>
              <select class="form-select form-select-sm" name="category" required>
                <option value="title">–¢–∏—Ç—É–ª—å–Ω–æ–µ</option>
                <option value="archive">–ê—Ä—Ö–∏–≤–Ω–æ–µ</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">–ü–æ–¥–ø–∏—Å—å</label>
              <input type="text" class="form-control form-control-sm" name="caption" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" />
            </div>
            <div class="col-md-4">
              <label class="form-label">–§–∞–π–ª</label>
              <input type="file" class="form-control form-control-sm" name="file" accept="image/*" required />
            </div>
            <div class="col-md-1">
              <button class="btn btn-outline-primary btn-sm w-100" type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
          </form>
          <div class="row g-3" id="photosContainer"></div>
          <div class="text-muted" id="photosEmptyText">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</div>
		  </div>
        </div>
      </div>

      <div class="card passport-card mb-5" id="equipmentSection">
        <div class="card-header d-flex justify-content-between align-items-center" data-section-header data-target="#equipmentBody">
          <span>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</span>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-secondary card-toggle-btn" type="button" data-section-toggle data-target="#equipmentBody" aria-expanded="false">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å ‚ñº</button>
            <button class="btn btn-sm btn-outline-success" id="addEquipmentBtn" type="button">‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</button>
          </div>
        </div>
        <div class="section-collapse" id="equipmentBody">
          <div class="card-body">
          <div class="alert alert-warning d-none" id="equipmentDisabledHint">–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç, —á—Ç–æ–±—ã —É–ø—Ä–∞–≤–ª—è—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º.</div>
          <div id="equipmentContainer"></div>
          <div class="text-muted" id="equipmentEmptyText">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ.</div>
		  </div>
        </div>
      </div>
    </div>
  </main>

  <div class="modal fade" id="photoPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-body">
          <div id="photoPreviewCarousel" class="carousel slide">
            <div class="carousel-inner" id="photoPreviewCarouselInner"></div>
            <button class="carousel-control-prev d-none" type="button" id="photoPreviewPrev" data-bs-target="#photoPreviewCarousel" data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">–ü—Ä–µ–¥—ã–¥—É—â–µ–µ</span>
            </button>
            <button class="carousel-control-next d-none" type="button" id="photoPreviewNext" data-bs-target="#photoPreviewCarousel" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">–°–ª–µ–¥—É—é—â–µ–µ</span>
            </button>
          </div>
          <div class="mt-3" id="photoPreviewMeta">
            <div class="text-muted small">–ü–æ–¥–ø–∏—Å—å</div>
            <div id="photoPreviewCaption" class="fw-semibold"></div>
          </div>
        </div>
        <div class="modal-footer">
          <a href="#" class="btn btn-primary" id="photoPreviewDownload" download>–°–∫–∞—á–∞—Ç—å</a>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script id="passportData" type="application/json">{{ passport_payload | safe }}</script>
  <script>
    function escapeHtml(value) {
      if (value === null || value === undefined) return '';
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function setupAutoExpandTextarea(textarea) {
      if (!textarea) return;
      const storedMinHeight = textarea.dataset.autoExpandMinHeight
        ? Number(textarea.dataset.autoExpandMinHeight)
        : null;
      const minHeight = storedMinHeight || Math.max(textarea.clientHeight || textarea.scrollHeight, 80);
      const adjustHeight = () => {
        const shouldExpand = (textarea.value || '').length > 50;
        textarea.style.height = shouldExpand ? 'auto' : `${minHeight}px`;
        if (shouldExpand) {
          textarea.style.height = `${Math.max(minHeight, textarea.scrollHeight)}px`;
        }
      };
      if (textarea.dataset.autoExpandInitialized !== 'true') {
        textarea.dataset.autoExpandInitialized = 'true';
        textarea.dataset.autoExpandMinHeight = String(minHeight);
        textarea.style.overflowY = 'hidden';
        textarea.addEventListener('input', adjustHeight);
        textarea.addEventListener('change', adjustHeight);
      }
      adjustHeight();
    }

    function initializeAutoExpandTextareas(root = document) {
      const scope = root instanceof Element ? root : document;
      scope.querySelectorAll('textarea.form-control.form-control-sm').forEach((textarea) => {
        if (textarea.dataset.noAutoExpand === 'true') return;
        setupAutoExpandTextarea(textarea);
      });
    }

    const parameterValuesInitial = {{ parameter_values | tojson }};
    const statuses = {{ statuses | tojson }};
    const dayLabels = {{ day_labels | tojson }};
    const networkProfilesRaw = {{ network_profiles | tojson }};
    const networkProfiles = Array.isArray(networkProfilesRaw) ? networkProfilesRaw : [];
    const equipmentOptionSetsRaw = {{ it_equipment_options | tojson }};
    const equipmentOptionSets = {
      types: Array.isArray(equipmentOptionSetsRaw && equipmentOptionSetsRaw.types)
        ? equipmentOptionSetsRaw.types
        : [],
      vendors: Array.isArray(equipmentOptionSetsRaw && equipmentOptionSetsRaw.vendors)
        ? equipmentOptionSetsRaw.vendors
        : [],
      models: Array.isArray(equipmentOptionSetsRaw && equipmentOptionSetsRaw.models)
        ? equipmentOptionSetsRaw.models
        : [],
      serials: Array.isArray(equipmentOptionSetsRaw && equipmentOptionSetsRaw.serials)
        ? equipmentOptionSetsRaw.serials
        : [],
      statuses: Array.isArray(equipmentOptionSetsRaw && equipmentOptionSetsRaw.statuses)
        ? equipmentOptionSetsRaw.statuses
        : [],
    };
    const itEquipmentCatalogRaw = {{ it_equipment_catalog | tojson }};
    const equipmentCatalog = Array.isArray(itEquipmentCatalogRaw)
      ? itEquipmentCatalogRaw
          .filter((item) => item && typeof item === 'object')
          .map((item) => ({
            equipment_type: normalizeCatalogValue(item.equipment_type),
            equipment_vendor: normalizeCatalogValue(item.equipment_vendor),
            equipment_model: normalizeCatalogValue(item.equipment_model),
            serial_number: normalizeCatalogValue(item.serial_number),
            accessories: typeof item.accessories === 'string' ? item.accessories.trim() : '',
            photo_url: typeof item.photo_url === 'string' ? item.photo_url.trim() : '',
          }))
      : [];
    equipmentCatalog.forEach((item) => {
      addUniqueOption(equipmentOptionSets.types, item.equipment_type);
      addUniqueOption(equipmentOptionSets.vendors, item.equipment_vendor);
      addUniqueOption(equipmentOptionSets.models, item.equipment_model);
      addUniqueOption(equipmentOptionSets.serials, item.serial_number);
    });
    const itConnectionChoicesRaw = {{ it_connection_options | tojson }};
    const itConnectionChoices = Array.isArray(itConnectionChoicesRaw) ? itConnectionChoicesRaw : [];

    const passportIdFromUrlMatch = window.location.pathname.match(/object_passports\/(\d+)/);
    const passportIdFromUrl = passportIdFromUrlMatch ? Number(passportIdFromUrlMatch[1]) : null;
    const hasValidPassportIdInUrl = Number.isFinite(passportIdFromUrl) && passportIdFromUrl > 0;
    const passportDataElement = document.getElementById('passportData');
    let initialPassportParseFailed = false;
    let passportDataRaw = passportDataElement ? passportDataElement.textContent : '';
    if (!passportDataRaw || !passportDataRaw.trim()) {
      passportDataRaw = '{}';
      if (hasValidPassportIdInUrl) {
        initialPassportParseFailed = true;
      }
    }
    let passportData = {};
    try {
      passportData = JSON.parse(passportDataRaw);
    } catch (error) {
      console.error('Failed to parse initial passport payload:', error);
      initialPassportParseFailed = true;
      passportData = {};
    }
    if (!passportData || typeof passportData !== 'object') {
      passportData = {};
    }
    if (hasValidPassportIdInUrl) {
      if (!passportData.id) {
        passportData.id = passportIdFromUrl;
      }
      passportData.is_new = false;
    } else if (typeof passportData.is_new !== 'boolean') {
      passportData.is_new = true;
    }

    enrichEquipmentOptionSetsFromEquipment(passportData.equipment);

    let parameterValues = (typeof structuredClone === 'function')
      ? structuredClone(parameterValuesInitial)
      : JSON.parse(JSON.stringify(parameterValuesInitial));
    const parameterKeys = Object.keys(parameterValuesInitial || {});

    function normalizeParameterResponse(source) {
      const data = source && typeof source === 'object' ? source : {};
      const result = {};
      parameterKeys.forEach((key) => {
        const items = Array.isArray(data[key]) ? data[key] : [];
        const values = items
          .filter((item) => item && !item.is_deleted && typeof item.value === 'string' && item.value.trim())
          .map((item) => item.value.trim());
        result[key] = Array.from(new Set(values));
      });
      return result;
    }

    function buildSelectOptions(values, currentValue) {
      const list = Array.isArray(values) ? values.filter(Boolean) : [];
      const normalizedCurrent = (currentValue || '').trim();
      const unique = [];
      list.forEach((item) => {
        const value = typeof item === 'string' ? item.trim() : '';
        if (value && !unique.includes(value)) {
          unique.push(value);
        }
      });
      if (normalizedCurrent && !unique.includes(normalizedCurrent)) {
        unique.push(normalizedCurrent);
      }
      const options = ['<option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>'];
      unique.forEach((item) => {
        const escaped = escapeHtml(item);
        const selected = item === normalizedCurrent ? ' selected' : '';
        options.push(`<option value="${escaped}"${selected}>${escaped}</option>`);
      });
      return options.join('');
    }

    function normalizeCatalogValue(value) {
      return typeof value === 'string' ? value.trim() : '';
    }

    function addUniqueOption(list, value) {
      if (!Array.isArray(list)) return;
      const normalized = normalizeCatalogValue(value);
      if (!normalized || list.includes(normalized)) return;
      list.push(normalized);
    }

    function buildDatalistOptions(values, currentValue) {
      const list = Array.isArray(values) ? values.filter(Boolean) : [];
      const normalizedCurrent = normalizeCatalogValue(currentValue || '');
      const unique = [];
      list.forEach((item) => {
        const normalized = normalizeCatalogValue(item);
        if (normalized && !unique.includes(normalized)) {
          unique.push(normalized);
        }
      });
      if (normalizedCurrent && !unique.includes(normalizedCurrent)) {
        unique.push(normalizedCurrent);
      }
      return unique.map((item) => `<option value="${escapeHtml(item)}"></option>`).join('');
    }

    function enrichEquipmentOptionSetsFromEquipment(list) {
      if (!Array.isArray(list)) return;
      list.forEach((item) => {
        if (!item || typeof item !== 'object') return;
        addUniqueOption(equipmentOptionSets.types, item.equipment_type);
        addUniqueOption(equipmentOptionSets.vendors, item.vendor);
        addUniqueOption(equipmentOptionSets.models, item.model);
        addUniqueOption(equipmentOptionSets.serials, item.serial_number);
        addUniqueOption(equipmentOptionSets.statuses, item.status);
      });
    }

    function collectCatalogValues(field, filters = {}) {
      if (!Array.isArray(equipmentCatalog) || !equipmentCatalog.length) {
        return [];
      }
      const normalizedFilters = {
        equipment_type: normalizeCatalogValue(filters.equipment_type || filters.type),
        equipment_vendor: normalizeCatalogValue(filters.equipment_vendor || filters.vendor),
        equipment_model: normalizeCatalogValue(filters.equipment_model || filters.model),
        serial_number: normalizeCatalogValue(filters.serial_number || filters.serial),
      };
      const result = new Set();
      equipmentCatalog.forEach((item) => {
        if (!item || typeof item !== 'object') return;
        const typeValue = normalizeCatalogValue(item.equipment_type);
        const vendorValue = normalizeCatalogValue(item.equipment_vendor);
        const modelValue = normalizeCatalogValue(item.equipment_model);
        const serialValue = normalizeCatalogValue(item.serial_number);
        if (field !== 'equipment_type' && normalizedFilters.equipment_type && typeValue !== normalizedFilters.equipment_type) {
          return;
        }
        if (field !== 'equipment_vendor' && normalizedFilters.equipment_vendor && vendorValue !== normalizedFilters.equipment_vendor) {
          return;
        }
        if (field !== 'equipment_model' && normalizedFilters.equipment_model && modelValue !== normalizedFilters.equipment_model) {
          return;
        }
        if (field !== 'serial_number' && normalizedFilters.serial_number && serialValue !== normalizedFilters.serial_number) {
          return;
        }
        let valueToAdd = '';
        if (field === 'equipment_type') {
          valueToAdd = typeValue;
        } else if (field === 'equipment_vendor') {
          valueToAdd = vendorValue;
        } else if (field === 'equipment_model') {
          valueToAdd = modelValue;
        } else if (field === 'serial_number') {
          valueToAdd = serialValue;
        }
        if (valueToAdd) {
          result.add(valueToAdd);
        }
      });
      return Array.from(result).sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
    }

    function getCombinedCatalogOptions(field, filters = {}) {
      const normalizedFilters = {
        equipment_type: normalizeCatalogValue(filters.equipment_type || filters.type),
        equipment_vendor: normalizeCatalogValue(filters.equipment_vendor || filters.vendor),
        equipment_model: normalizeCatalogValue(filters.equipment_model || filters.model),
        serial_number: normalizeCatalogValue(filters.serial_number || filters.serial),
      };
      let baseList = [];
      if (field === 'equipment_type') {
        baseList = equipmentOptionSets.types || [];
      } else if (field === 'equipment_vendor') {
        baseList = equipmentOptionSets.vendors || [];
      } else if (field === 'equipment_model') {
        baseList = equipmentOptionSets.models || [];
      } else if (field === 'serial_number') {
        baseList = equipmentOptionSets.serials || [];
      }
      const values = new Set();
      baseList.forEach((item) => {
        const normalized = normalizeCatalogValue(item);
        if (normalized) {
          values.add(normalized);
        }
      });
      collectCatalogValues(field, normalizedFilters).forEach((value) => {
        const normalized = normalizeCatalogValue(value);
        if (normalized) {
          values.add(normalized);
        }
      });
      return Array.from(values).sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
    }

    function rebuildEquipmentSelect(select, options, currentValue) {
      if (!select) return;
      const normalizedCurrent = normalizeCatalogValue(currentValue || select.value);
      const fragment = document.createDocumentFragment();
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = '–ù–µ –≤—ã–±—Ä–∞–Ω–æ';
      fragment.appendChild(placeholder);
      const seen = new Set();
      options.forEach((value) => {
        const normalized = normalizeCatalogValue(value);
        if (!normalized || seen.has(normalized)) return;
        const option = document.createElement('option');
        option.value = normalized;
        option.textContent = normalized;
        if (normalized === normalizedCurrent) {
          option.selected = true;
        }
        fragment.appendChild(option);
        seen.add(normalized);
      });
      if (normalizedCurrent && !seen.has(normalizedCurrent)) {
        const option = document.createElement('option');
        option.value = normalizedCurrent;
        option.textContent = normalizedCurrent;
        option.selected = true;
        fragment.appendChild(option);
      }
      select.innerHTML = '';
      select.appendChild(fragment);
      if (normalizedCurrent) {
        select.value = normalizedCurrent;
      } else {
        select.value = '';
      }
    }

    function rebuildEquipmentSerialOptions(datalist, options, currentValue) {
      if (!datalist) return;
      const normalizedCurrent = normalizeCatalogValue(currentValue);
      const fragment = document.createDocumentFragment();
      const seen = new Set();
      options.forEach((value) => {
        const normalized = normalizeCatalogValue(value);
        if (!normalized || seen.has(normalized)) return;
        const option = document.createElement('option');
        option.value = normalized;
        fragment.appendChild(option);
        seen.add(normalized);
      });
      if (normalizedCurrent && !seen.has(normalizedCurrent)) {
        const option = document.createElement('option');
        option.value = normalizedCurrent;
        fragment.appendChild(option);
      }
      datalist.innerHTML = '';
      datalist.appendChild(fragment);
    }

    function findCatalogMatches(filters = {}) {
      if (!Array.isArray(equipmentCatalog) || !equipmentCatalog.length) {
        return [];
      }
      const normalizedFilters = {
        equipment_type: normalizeCatalogValue(filters.equipment_type || filters.type),
        equipment_vendor: normalizeCatalogValue(filters.equipment_vendor || filters.vendor),
        equipment_model: normalizeCatalogValue(filters.equipment_model || filters.model),
        serial_number: normalizeCatalogValue(filters.serial_number || filters.serial),
      };
      return equipmentCatalog.filter((item) => {
        if (!item || typeof item !== 'object') return false;
        if (normalizedFilters.equipment_type && normalizeCatalogValue(item.equipment_type) !== normalizedFilters.equipment_type) {
          return false;
        }
        if (normalizedFilters.equipment_vendor && normalizeCatalogValue(item.equipment_vendor) !== normalizedFilters.equipment_vendor) {
          return false;
        }
        if (normalizedFilters.equipment_model && normalizeCatalogValue(item.equipment_model) !== normalizedFilters.equipment_model) {
          return false;
        }
        if (normalizedFilters.serial_number && normalizeCatalogValue(item.serial_number) !== normalizedFilters.serial_number) {
          return false;
        }
        return true;
      });
    }

    function applyCatalogMatchToCard(card, changedField) {
      if (!card) return;
      const typeSelect = card.querySelector('.equipment-type');
      const vendorSelect = card.querySelector('.equipment-vendor');
      const modelSelect = card.querySelector('.equipment-model');
      const serialInput = card.querySelector('.equipment-serial');
      if (!typeSelect || !vendorSelect || !modelSelect || !serialInput) return;
      const state = {
        equipment_type: normalizeCatalogValue(typeSelect.value),
        equipment_vendor: normalizeCatalogValue(vendorSelect.value),
        equipment_model: normalizeCatalogValue(modelSelect.value),
        serial_number: normalizeCatalogValue(serialInput.value),
      };
      const attempts = [];
      attempts.push(state);
      attempts.push({
        equipment_type: state.equipment_type,
        equipment_vendor: state.equipment_vendor,
        equipment_model: state.equipment_model,
      });
      attempts.push({ equipment_type: state.equipment_type, equipment_vendor: state.equipment_vendor });
      attempts.push({ equipment_type: state.equipment_type, equipment_model: state.equipment_model });
      attempts.push({ equipment_vendor: state.equipment_vendor, equipment_model: state.equipment_model });
      if (state.serial_number) {
        attempts.push({ serial_number: state.serial_number });
      }
      let matches = [];
      for (const candidate of attempts) {
        if (!candidate) continue;
        const hasValue = Object.values(candidate).some((value) => normalizeCatalogValue(value));
        if (!hasValue) continue;
        matches = findCatalogMatches(candidate);
        if (matches.length) {
          break;
        }
      }
      if (!matches.length) {
        card.dataset.catalogMatched = '';
        return;
      }

      const selectedFieldMap = {
        equipment_type: 'equipment_type',
        equipment_vendor: 'equipment_vendor',
        equipment_model: 'equipment_model',
        serial_number: 'serial_number',
      };

      let matchToApply = null;
      const selectedFieldKey = changedField ? selectedFieldMap[changedField] : null;
      const selectedValue = selectedFieldKey ? state[selectedFieldKey] : '';
      if (selectedFieldKey && selectedValue) {
        matchToApply = matches.find((match) => {
          const catalogValue = normalizeCatalogValue(match[selectedFieldKey]);
          return catalogValue && catalogValue === selectedValue;
        });
      }
      if (!matchToApply) {
        if (selectedFieldKey && selectedValue) {
          card.dataset.catalogMatched = '';
          return;
        }
        matchToApply = matches[0];
      }

      const fieldsToApply = [
        { select: typeSelect, key: 'equipment_type' },
        { select: vendorSelect, key: 'equipment_vendor' },
        { select: modelSelect, key: 'equipment_model' },
      ];
      fieldsToApply.forEach(({ select, key }) => {
        if (!select) return;
        const valueFromMatch = matchToApply ? normalizeCatalogValue(matchToApply[key]) : '';
        const shouldApplyValue = valueFromMatch || !state[key] || !matches.some((match) => normalizeCatalogValue(match[key]) === state[key]);
        if (shouldApplyValue) {
          if (valueFromMatch) {
            ensureSelectHasOption(select, valueFromMatch);
            select.value = valueFromMatch;
            state[key] = valueFromMatch;
          } else {
            select.value = '';
            state[key] = '';
          }
        }
      });

      const serialValueFromMatch = matchToApply ? normalizeCatalogValue(matchToApply.serial_number) : '';
      const shouldApplySerial =
        serialValueFromMatch ||
        !state.serial_number ||
        !matches.some((match) => normalizeCatalogValue(match.serial_number) === state.serial_number);
      if (shouldApplySerial) {
        serialInput.value = serialValueFromMatch || '';
        state.serial_number = serialValueFromMatch || '';
      }

      const nameInput = card.querySelector('.equipment-name');
      if (nameInput && !nameInput.value.trim() && matchToApply) {
        const pieces = [matchToApply.equipment_vendor, matchToApply.equipment_model]
          .map((value) => normalizeCatalogValue(value))
          .filter(Boolean);
        if (pieces.length) {
          nameInput.value = pieces.join(' ');
        }
      }

      card.dataset.catalogMatched = matches.length === 1 ? 'true' : 'partial';
    }

    function updateEquipmentCardOptions(card) {
      if (!card) return;
      const typeSelect = card.querySelector('.equipment-type');
      const vendorSelect = card.querySelector('.equipment-vendor');
      const modelSelect = card.querySelector('.equipment-model');
      const serialInput = card.querySelector('.equipment-serial');
      const serialDatalist = card.querySelector('.equipment-serial-options');
      if (!typeSelect || !vendorSelect || !modelSelect || !serialInput) return;
      const typeValue = normalizeCatalogValue(typeSelect.value);
      const vendorValue = normalizeCatalogValue(vendorSelect.value);
      const modelValue = normalizeCatalogValue(modelSelect.value);
      const serialValue = normalizeCatalogValue(serialInput.value);
      const typeOptions = getCombinedCatalogOptions('equipment_type', {
        equipment_vendor: vendorValue,
        equipment_model: modelValue,
        serial_number: serialValue,
      });
      rebuildEquipmentSelect(typeSelect, typeOptions, typeValue);
      const vendorOptions = getCombinedCatalogOptions('equipment_vendor', {
        equipment_type: typeValue,
        equipment_model: modelValue,
        serial_number: serialValue,
      });
      rebuildEquipmentSelect(vendorSelect, vendorOptions, vendorValue);
      const modelOptions = getCombinedCatalogOptions('equipment_model', {
        equipment_type: typeValue,
        equipment_vendor: vendorValue,
        serial_number: serialValue,
      });
      rebuildEquipmentSelect(modelSelect, modelOptions, modelValue);
      const serialOptions = getCombinedCatalogOptions('serial_number', {
        equipment_type: typeValue,
        equipment_vendor: vendorValue,
        equipment_model: modelValue,
      });
      rebuildEquipmentSerialOptions(serialDatalist, serialOptions, serialValue);
    }

    function initializeEquipmentCard(card) {
      if (!card) return;
      const typeSelect = card.querySelector('.equipment-type');
      const vendorSelect = card.querySelector('.equipment-vendor');
      const modelSelect = card.querySelector('.equipment-model');
      const serialInput = card.querySelector('.equipment-serial');
      const nameInput = card.querySelector('.equipment-name');
      const ipInput = card.querySelector('.equipment-ip');
      const statusSelect = card.querySelector('.equipment-status')
      const headerTitle = card.querySelector('.equipment-header-title');
      const headerModelValue = card.querySelector('[data-role="equipment-header-model"]');
      const headerIpValue = card.querySelector('[data-role="equipment-header-ip"]');
      const headerStatusValue = card.querySelector('[data-role="equipment-header-status"]');
      if (!typeSelect || !vendorSelect || !modelSelect || !serialInput) return;
      const headerToggle = card.querySelector('.equipment-header-toggle');
      const detailsActionToggle = card.querySelector('.equipment-details-toggle');
      const cardHeader = card.querySelector('.card-header');
      const collapseTargetSelector =
        (headerToggle && headerToggle.getAttribute('data-bs-target')) ||
        (detailsActionToggle && detailsActionToggle.getAttribute('data-bs-target'));
      const collapseElement = collapseTargetSelector
        ? (card.querySelector(collapseTargetSelector) || document.querySelector(collapseTargetSelector))
        : null;
      const syncDetailsCollapseState = (expanded) => {
        if (headerToggle) {
          headerToggle.classList.toggle('collapsed', !expanded);
          headerToggle.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        }
        if (detailsActionToggle) {
          detailsActionToggle.classList.toggle('collapsed', !expanded);
          detailsActionToggle.setAttribute('aria-expanded', expanded ? 'true' : 'false');
          detailsActionToggle.textContent = expanded ? '–°–≤–µ—Ä–Ω—É—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É' : '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É';
        }
      };
      if (collapseElement) {
        const initialExpanded = collapseElement.classList.contains('show');
        syncDetailsCollapseState(initialExpanded);
        const useBootstrapCollapse = typeof bootstrap !== 'undefined' && bootstrap.Collapse;
        let collapseInstance = null;
        const getCollapseInstance = () => {
          if (!useBootstrapCollapse) return null;
          if (!collapseInstance) {
            collapseInstance = bootstrap.Collapse.getOrCreateInstance(collapseElement, { toggle: false });
          }
          return collapseInstance;
        };
        if (useBootstrapCollapse && collapseElement.dataset.collapseEventsBound !== 'true') {
          collapseElement.addEventListener('shown.bs.collapse', () => syncDetailsCollapseState(true));
          collapseElement.addEventListener('hidden.bs.collapse', () => syncDetailsCollapseState(false));
          collapseElement.dataset.collapseEventsBound = 'true';
        }
        const getCurrentExpandedState = () => {
          if (headerToggle && headerToggle.hasAttribute('aria-expanded')) {
            return headerToggle.getAttribute('aria-expanded') === 'true';
          }
          if (detailsActionToggle && detailsActionToggle.hasAttribute('aria-expanded')) {
            return detailsActionToggle.getAttribute('aria-expanded') === 'true';
          }
          return collapseElement.classList.contains('show');
        };
        const applyCollapseState = (shouldExpand) => {
          const expanded = getCurrentExpandedState();
          const targetState = typeof shouldExpand === 'boolean' ? shouldExpand : !expanded;
          if (targetState === expanded) return;
          if (useBootstrapCollapse) {
            const instance = getCollapseInstance();
            if (!instance) {
              collapseElement.classList.toggle('show', targetState);
              syncDetailsCollapseState(targetState);
              return;
            }
            if (targetState) {
              instance.show();
            } else {
              instance.hide();
            }
          } else {
            collapseElement.classList.toggle('show', targetState);
            syncDetailsCollapseState(targetState);
          }
        };
        const attachToggleHandler = (button) => {
          if (!button || button.dataset.collapseInitialized === 'true') return;
          button.addEventListener('click', (event) => {
            event.preventDefault();
            event.stopPropagation();
            applyCollapseState();
          });
          button.dataset.collapseInitialized = 'true';
        };
        attachToggleHandler(headerToggle);
        attachToggleHandler(detailsActionToggle);
        if (cardHeader && cardHeader.dataset.collapseHeaderInitialized !== 'true') {
          cardHeader.addEventListener('click', (event) => {
            if (!headerToggle) return;
            if (event.target.closest('.equipment-header-toggle')) return;
            if (event.target.closest('.equipment-actions')) return;
            applyCollapseState();
          });
          cardHeader.dataset.collapseHeaderInitialized = 'true';
        }
      }
      const updateHeaderSummary = () => {
        if (headerTitle && nameInput) {
          const value = nameInput.value.trim();
          headerTitle.textContent = value || '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ';
        }
        if (headerModelValue && modelSelect) {
          const option = modelSelect.options[modelSelect.selectedIndex];
          const text = option ? option.text : modelSelect.value;
          headerModelValue.textContent = (text || modelSelect.value || '‚Äî').trim() || '‚Äî';
        }
        if (headerIpValue && ipInput) {
          const value = ipInput.value.trim();
          headerIpValue.textContent = value || '‚Äî';
        }
        if (headerStatusValue && statusSelect) {
          const option = statusSelect.options[statusSelect.selectedIndex];
          const text = option ? option.text : statusSelect.value;
          headerStatusValue.textContent = (text || statusSelect.value || '‚Äî').trim() || '‚Äî';
        }
      };
      typeSelect.addEventListener('change', () => {
        applyCatalogMatchToCard(card, 'equipment_type');
        updateEquipmentCardOptions(card);
        updateHeaderSummary();
      });
      vendorSelect.addEventListener('change', () => {
        applyCatalogMatchToCard(card, 'equipment_vendor');
        updateEquipmentCardOptions(card);
        updateHeaderSummary();
      });
      modelSelect.addEventListener('change', () => {
        applyCatalogMatchToCard(card, 'equipment_model');
        updateEquipmentCardOptions(card);
        updateHeaderSummary();
      });
      serialInput.addEventListener('change', () => {
        applyCatalogMatchToCard(card, 'serial_number');
        updateEquipmentCardOptions(card);
        updateHeaderSummary();
      });
      serialInput.addEventListener('input', () => {
        updateEquipmentCardOptions(card);
        updateHeaderSummary();
      });
      if (nameInput) {
        nameInput.addEventListener('input', updateHeaderSummary);
        nameInput.addEventListener('change', updateHeaderSummary);
      }
      if (ipInput) {
        ipInput.addEventListener('input', updateHeaderSummary);
        ipInput.addEventListener('change', updateHeaderSummary);
      }
      if (statusSelect) {
        statusSelect.addEventListener('change', () => {
          addUniqueOption(equipmentOptionSets.statuses, statusSelect.value);
          updateHeaderSummary();
        });
      }
      updateEquipmentCardOptions(card);
      applyCatalogMatchToCard(card);
      updateEquipmentCardOptions(card);
      updateHeaderSummary();
    }

    const departmentSelect = document.getElementById('departmentSelect');
    const businessSelect = document.getElementById('businessSelect');
    const partnerTypeSelect = document.getElementById('partnerTypeSelect');
    const countrySelect = document.getElementById('countrySelect');
    const legalEntitySelect = document.getElementById('legalEntitySelect');
    const cityInput = document.getElementById('cityInput');
    const locationAddressInput = document.getElementById('locationAddressInput');
    const statusSelect = document.getElementById('statusSelect');
    const internalNetworkInput = document.getElementById('internalNetworkInput');
    const networkTunnelInput = document.getElementById('networkTunnelInput');
    const networkProviderInput = document.getElementById('networkProviderInput');
    const networkContractInput = document.getElementById('networkContractInput');
    const networkLegalEntityInput = document.getElementById('networkLegalEntityInput');
    const networkSupportPhoneInput = document.getElementById('networkSupportPhoneInput');
    const networkSpeedInput = document.getElementById('networkSpeedInput');
    const networkParamsInput = document.getElementById('networkParamsInput');
    const networkEquipmentSummary = document.getElementById('networkEquipmentSummary');
    const itBlock = document.getElementById('itBlock');
    const toggleItBlockBtn = document.getElementById('toggleItBlockBtn');
    const itEquipmentList = document.getElementById('itEquipmentList');
    const itObjectPhoneInput = document.getElementById('itObjectPhoneInput');
    const itManagerNameInput = document.getElementById('itManagerNameInput');
    const itManagerPhoneInput = document.getElementById('itManagerPhoneInput');
    const iikoServerSelect = document.getElementById('iikoServerSelect');
    const caseTimeDisplay = document.getElementById('caseTimeDisplay');
    const taskTimeDisplay = document.getElementById('taskTimeDisplay');
    const networkFilesForm = document.getElementById('networkFilesForm');
    const networkFilesList = document.getElementById('networkFilesList');
    const networkFilesEmptyText = document.getElementById('networkFilesEmptyText');
    const startDateInput = document.getElementById('startDateInput');
    const endDateInput = document.getElementById('endDateInput');
    const suspensionDateInput = document.getElementById('suspensionDateInput');
    const resumeDateInput = document.getElementById('resumeDateInput');
    const totalTimeDisplay = document.getElementById('totalTimeDisplay');
    const statusHistoryTotal = document.getElementById('statusHistoryTotal');
    const statusHistoryList = document.getElementById('statusHistoryList');
    const statusHistoryCollapse = document.getElementById('statusHistoryCollapse');
    const statusHistoryToggle = document.getElementById('statusHistoryToggle');
    const statusHistoryEmpty = document.getElementById('statusHistoryEmpty');
    const saveStatusAlert = document.getElementById('saveStatus');
    const statusBadge = document.getElementById('statusBadge');
    const networkBadge = document.getElementById('networkBadge');
    const objectTitle = document.getElementById('objectTitle');
    const titlePhotoPreview = document.getElementById('titlePhotoPreview');
    const titlePhotoImage = document.getElementById('titlePhotoImage');
    const photoUploadForm = document.getElementById('photoUploadForm');
    const photosContainer = document.getElementById('photosContainer');
    const photosEmptyText = document.getElementById('photosEmptyText');
    const photosDisabledHint = document.getElementById('photosDisabledHint');
    const equipmentContainer = document.getElementById('equipmentContainer');
    const equipmentEmptyText = document.getElementById('equipmentEmptyText');
    const equipmentDisabledHint = document.getElementById('equipmentDisabledHint');
    const addEquipmentBtn = document.getElementById('addEquipmentBtn');
    initializeAutoExpandTextareas();
    const casesTableBody = document.getElementById('casesTableBody');
    const casesEmptyText = document.getElementById('casesEmptyText');
    const refreshCasesBtn = document.getElementById('refreshCasesBtn');
    const tasksTableBody = document.getElementById('tasksTableBody');
    const tasksEmptyText = document.getElementById('tasksEmptyText');
    const refreshTasksBtn = document.getElementById('refreshTasksBtn');
    const statusTaskContainer = document.getElementById('statusTaskContainer');
    const statusTaskSelect = document.getElementById('statusTaskSelect');
    const statusTaskInfo = document.getElementById('statusTaskInfo');
    const statusTaskSearchInput = document.getElementById('statusTaskSearchInput');
    const statusTaskHint = document.getElementById('statusTaskHint');
    const photoPreviewModalEl = document.getElementById('photoPreviewModal');
    const photoPreviewCarouselEl = document.getElementById('photoPreviewCarousel');
    const photoPreviewCarouselInner = document.getElementById('photoPreviewCarouselInner');
    const photoPreviewPrev = document.getElementById('photoPreviewPrev');
    const photoPreviewNext = document.getElementById('photoPreviewNext');
    const photoPreviewCaption = document.getElementById('photoPreviewCaption');
    const photoPreviewDownload = document.getElementById('photoPreviewDownload');
    let photoPreviewModalInstance = null;
    let photoPreviewCarouselInstance = null;
    let currentPhotoPreviewList = [];
    let statusHistoryCollapseInstance = null;
    const searchableSelectRegistry = new Map();

    function closeOtherSearchableSelects(exceptId) {
      searchableSelectRegistry.forEach((state, id) => {
        if (id === exceptId || !state || typeof state.hide !== 'function') return;
        state.hide();
      });
    }
    const savePassportBtn = document.getElementById('savePassportBtn');

    const statusesRequiringTask = new Set(['–ó–∞–∫—Ä—ã—Ç', '–†–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è', '–ó–∞–º–æ—Ä–æ–∂–µ–Ω', '–î—Ä—É–≥–æ–µ']);

    function ensureStatusHistoryCollapse() {
      if (!statusHistoryCollapse || typeof bootstrap === 'undefined') return null;
      if (!statusHistoryCollapseInstance) {
        statusHistoryCollapseInstance = bootstrap.Collapse.getOrCreateInstance(statusHistoryCollapse, {
          toggle: false,
        });
      }
      return statusHistoryCollapseInstance;
    }

    function updateStatusHistoryToggleLabel(isExpanded) {
      if (!statusHistoryToggle) return;
      statusHistoryToggle.textContent = isExpanded ? '–°–∫—Ä—ã—Ç—å ‚ñ≤' : '–ü–æ–∫–∞–∑–∞—Ç—å ‚ñº';
      statusHistoryToggle.setAttribute('aria-expanded', isExpanded ? 'true' : 'false');
    }

    function refreshSearchableSelect(select) {
      if (!select) return;
      const state = searchableSelectRegistry.get(select.id);
      if (state && typeof state.refresh === 'function') {
        state.refresh();
      }
    }

    function registerSearchableSelect(wrapper) {
      if (!wrapper) return;
      const selectId = wrapper.dataset.selectId;
      if (!selectId) return;
      const select = document.getElementById(selectId);
      if (!select) return;

      const dropdownToggle = wrapper.querySelector('[data-bs-toggle="dropdown"]');
      const labelEl = wrapper.querySelector('.searchable-select-label');
      const searchInput = wrapper.querySelector('.searchable-select-search');
      const optionsContainer = wrapper.querySelector('.searchable-select-options');
      const dropdownMenu = wrapper.querySelector('.dropdown-menu');
      if (!dropdownToggle || !labelEl || !searchInput || !optionsContainer || !dropdownMenu) return;

      const shouldUseBootstrapDropdown =
        typeof bootstrap !== 'undefined' && !wrapper.hasAttribute('data-force-custom-dropdown');

      const dropdownInstance = shouldUseBootstrapDropdown
        ? bootstrap.Dropdown.getOrCreateInstance(dropdownToggle, { autoClose: false })
        : null;

      const showMenu = () => {
        if (dropdownInstance) {
          dropdownInstance.show();
          return;
        }
        wrapper.classList.add('show');
        dropdownMenu.classList.add('show');
        dropdownMenu.style.display = 'block';
        dropdownToggle.setAttribute('aria-expanded', 'true');
      };

      const hideMenu = () => {
        if (dropdownInstance) {
          dropdownInstance.hide();
          return;
        }
        wrapper.classList.remove('show');
        dropdownMenu.classList.remove('show');
        dropdownMenu.style.display = '';
        dropdownToggle.setAttribute('aria-expanded', 'false');
      };

      const handleDropdownShown = () => {
        searchInput.value = '';
        filterOptions('');
        setTimeout(() => searchInput.focus(), 50);
      };

      const handleDropdownHidden = () => {
        searchInput.value = '';
        filterOptions('');
      };

      const isMenuShown = () =>
        dropdownInstance
          ? dropdownToggle.getAttribute('aria-expanded') === 'true'
          : dropdownMenu.classList.contains('show');

      function buildOptions() {
        optionsContainer.innerHTML = '';
        Array.from(select.options).forEach((option) => {
          const item = document.createElement('button');
          item.type = 'button';
          item.className = 'dropdown-item text-start';
          item.dataset.value = option.value;
          item.dataset.label = option.text;
          item.textContent = option.text || '‚Äî';
          if (option.selected) {
            item.classList.add('active');
          }
          optionsContainer.appendChild(item);
        });
      }

      function updateLabel() {
        const option = select.options[select.selectedIndex];
        labelEl.textContent = option ? option.text : '–ù–µ –≤—ã–±—Ä–∞–Ω–æ';
      }

      function filterOptions(value) {
        const normalized = (value || '').trim().toLowerCase();
        optionsContainer.querySelectorAll('.dropdown-item').forEach((item) => {
          const label = (item.dataset.label || item.textContent || '').toLowerCase();
          item.classList.toggle('d-none', Boolean(normalized) && !label.includes(normalized));
        });
      }

      optionsContainer.addEventListener('click', (event) => {
        const button = event.target.closest('.dropdown-item');
        if (!button) return;
        const value = button.dataset.value || '';
        if (select.value !== value) {
          select.value = value;
          select.dispatchEvent(new Event('change', { bubbles: true }));
        } else {
          select.dispatchEvent(new Event('change', { bubbles: true }));
        }
        updateLabel();
        optionsContainer.querySelectorAll('.dropdown-item').forEach((item) => {
          item.classList.toggle('active', item === button);
        });
        hideMenu();
        handleDropdownHidden();
      });

      searchInput.addEventListener('input', () => filterOptions(searchInput.value));

      const refreshState = () => {
        buildOptions();
        updateLabel();
        filterOptions(searchInput.value);
      };

      const state = {
        refresh: refreshState,
        select,
        labelEl,
        hide: () => {
          if (!isMenuShown()) return;
          hideMenu();
          if (!dropdownInstance) {
            handleDropdownHidden();
          }
        },
        isShown: isMenuShown,
      };

      searchableSelectRegistry.set(selectId, state);

      if (dropdownInstance) {
        wrapper.addEventListener('show.bs.dropdown', () => closeOtherSearchableSelects(selectId));
        wrapper.addEventListener('shown.bs.dropdown', handleDropdownShown);
        wrapper.addEventListener('hidden.bs.dropdown', handleDropdownHidden);
      } else {
        dropdownToggle.addEventListener('click', (event) => {
          event.preventDefault();
          event.stopPropagation();
          if (isMenuShown()) {
            state.hide();
          } else {
            closeOtherSearchableSelects(selectId);
            showMenu();
            handleDropdownShown();
          }
        });

        document.addEventListener('click', (event) => {
          if (!wrapper.contains(event.target)) {
            state.hide();
          }
        });
      }

      state.refresh();

      select.addEventListener('change', () => {
        updateLabel();
        optionsContainer.querySelectorAll('.dropdown-item').forEach((item) => {
          item.classList.toggle('active', item.dataset.value === select.value);
        });
      });
    }

    function initializeSearchableSelects() {
      document.querySelectorAll('.searchable-select').forEach((wrapper) => registerSearchableSelect(wrapper));
    }

    function ensureSelectHasOption(select, value) {
      if (!select) return;
      const normalized = typeof value === 'string' ? value.trim() : '';
      if (!normalized) return;
      const hasOption = Array.from(select.options).some(
        (option) => (option.value || '').trim() === normalized,
      );
      if (!hasOption) {
        const option = document.createElement('option');
        option.value = normalized;
        option.textContent = normalized;
        select.appendChild(option);
      }
    }

    function syncSelectSearchInput(select) {
      if (!select) return;
      const input = document.querySelector(`.select-search-input[data-select-target="${select.id}"]`);
      if (!input) return;
      const option = select.options[select.selectedIndex];
      input.value = option ? option.text : '';
    }

    function filterSelectOptions(select, value) {
      if (!select) return;
      const normalized = (value || '').trim().toLowerCase();
      Array.from(select.options).forEach((option) => {
        if (!option.value) {
          option.hidden = false;
          return;
        }
        const match = option.text.toLowerCase().includes(normalized);
        option.hidden = Boolean(normalized) && !match && !option.selected;
      });
    }

    function showSaveMessage(type, text) {
      saveStatusAlert.classList.remove('d-none', 'alert-success', 'alert-danger');
      saveStatusAlert.classList.add(type === 'error' ? 'alert-danger' : 'alert-success');
      saveStatusAlert.textContent = text;
      if (type !== 'error') {
        setTimeout(() => saveStatusAlert.classList.add('d-none'), 4000);
      }
    }

    function updateStatusBadge() {
      const value = statusSelect.value || '‚Äî';
      statusBadge.textContent = value || '‚Äî';
      statusBadge.classList.remove('bg-success', 'bg-warning', 'bg-secondary', 'bg-dark', 'bg-info', 'text-dark');
      if (value === '–û—Ç–∫—Ä—ã—Ç') {
        statusBadge.classList.add('bg-success');
      } else if (value === '–°—Ç—Ä–æ–π–∫–∞') {
        statusBadge.classList.add('bg-warning', 'text-dark');
      } else if (value === '–ó–∞–∫—Ä—ã—Ç') {
        statusBadge.classList.add('bg-dark');
      } else if (value === '–†–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è') {
        statusBadge.classList.add('bg-info', 'text-dark');
      } else if (value === '–ó–∞–º–æ—Ä–æ–∂–µ–Ω') {
        statusBadge.classList.add('bg-warning', 'text-dark');
      } else {
        statusBadge.classList.add('bg-secondary');
      }
    }
    function updateNetworkBadge() {
      const value = internalNetworkInput ? internalNetworkInput.value.trim() : '';
      const display = value || '‚Äî';
      networkBadge.textContent = `–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å–µ—Ç—å: ${display}`;
      networkBadge.classList.remove('bg-info', 'bg-secondary', 'text-dark');
      if (value) {
        networkBadge.classList.add('bg-info', 'text-dark');
      } else {
        networkBadge.classList.add('bg-secondary');
      }
    }

    function updatePageTitle() {
      const departmentName = departmentSelect ? (departmentSelect.value || '').trim() : '';
      document.title = departmentName ? `–ü–∞—Å–ø–æ—Ä—Ç ${departmentName}` : '–ù–æ–≤—ã–π –ø–∞—Å–ø–æ—Ä—Ç –æ–±—ä–µ–∫—Ç–∞';
    }

    function updateObjectTitle() {
      const parts = [businessSelect.value, cityInput.value, departmentSelect.value]
        .map((part) => (part || '').trim())
        .filter(Boolean);
      objectTitle.textContent = parts.length ? parts.join(' ¬∑ ') : '‚Äî';
      updatePageTitle();
    }

    function hasItBlockContent(data) {
      if (!data || typeof data !== 'object') return false;
      const equipmentList = Array.isArray(data.equipment) ? data.equipment : [];
      if (
        equipmentList.some((item) => {
          if (!item) return false;
          const name = typeof item.name === 'string' ? item.name.trim() : '';
          const ip = typeof item.ip_address === 'string' ? item.ip_address.trim() : '';
          return Boolean(name || ip);
        })
      ) {
        return true;
      }
      const textFields = [data.it_iiko_server];
      if (textFields.some((value) => typeof value === 'string' && value.trim())) {
        return true;
      }
      const numericFields = [data.case_time_minutes, data.task_time_minutes];
      if (numericFields.some((value) => typeof value === 'number' && value > 0)) {
        return true;
      }
      return false;
    }

    function syncItBlockToggleButton() {
      if (!toggleItBlockBtn || !itBlock) return;
      const hidden = itBlock.classList.contains('d-none');
      toggleItBlockBtn.textContent = hidden ? '–†–∞—Å–∫—Ä—ã—Ç—å IT-–±–ª–æ–∫' : '–°–≤–µ—Ä–Ω—É—Ç—å IT-–±–ª–æ–∫';
      toggleItBlockBtn.setAttribute('aria-expanded', String(!hidden));
    }

    function refreshItBlockState(data) {
      if (!itBlock) return;
      const hasContent = hasItBlockContent(data);
      if (!hasContent) {
        itBlock.classList.add('d-none');
        itBlock.dataset.userCollapsed = 'true';
      } else if (itBlock.dataset.userCollapsed !== 'true') {
        itBlock.classList.remove('d-none');
      }
      syncItBlockToggleButton();
    }

    function updateItEquipmentList(equipmentList) {
      if (!itEquipmentList) return;
      const list = Array.isArray(equipmentList) ? equipmentList.filter(Boolean) : [];
      if (!list.length) {
        itEquipmentList.innerHTML = '<div class="it-equipment-empty">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ.</div>';
        return;
      }
      itEquipmentList.innerHTML = '';
      list.forEach((item) => {
        const row = document.createElement('div');
        row.className = 'it-equipment-item';
        const name = escapeHtml((item && item.name) || '‚Äî');
        const ip = escapeHtml((item && item.ip_address) || '‚Äî');
        row.innerHTML = `<span class="it-equipment-name">${name}</span><span class="it-equipment-ip">${ip}</span>`;
        itEquipmentList.appendChild(row);
      });
      refreshItBlockState(passportData);
    }

    function updateNetworkEquipmentSummary(equipmentList) {
      if (!networkEquipmentSummary) return;
      const list = Array.isArray(equipmentList) ? equipmentList : [];
      const items = list
        .map((item) => {
          if (!item) return null;
          const name = typeof item.name === 'string' ? item.name.trim() : '';
          const ip = typeof item.ip_address === 'string' ? item.ip_address.trim() : '';
          if (!name && !ip) return null;
          const nameHtml = escapeHtml(name || '‚Äî');
          const ipHtml = escapeHtml(ip || '‚Äî');
          return `<li class="network-equipment-entry"><span class="network-equipment-name">${nameHtml}</span><span class="network-equipment-separator">¬∑</span><span class="network-equipment-ip">${ipHtml}</span></li>`;
        })
        .filter(Boolean);
      if (!items.length) {
        networkEquipmentSummary.innerHTML = '<div class="network-equipment-empty text-muted">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ.</div>';
        return;
      }
      networkEquipmentSummary.innerHTML = `<ul class="list-unstyled mb-0 network-equipment-list">${items.join('')}</ul>`;
    }

    function updateItMetrics(metrics = {}) {
      if (!passportData || typeof passportData !== 'object') {
        passportData = {};
      }
      if (typeof metrics.caseMinutes === 'number' && !Number.isNaN(metrics.caseMinutes)) {
        passportData.case_time_minutes = metrics.caseMinutes;
      }
      if (typeof metrics.caseDisplay === 'string') {
        passportData.case_time_display = metrics.caseDisplay;
      }
      if (caseTimeDisplay) {
        caseTimeDisplay.textContent = passportData.case_time_display || '‚Äî';
      }
      if (typeof metrics.taskMinutes === 'number' && !Number.isNaN(metrics.taskMinutes)) {
        passportData.task_time_minutes = metrics.taskMinutes;
      }
      if (typeof metrics.taskDisplay === 'string') {
        passportData.task_time_display = metrics.taskDisplay;
      }
      if (taskTimeDisplay) {
        taskTimeDisplay.textContent = passportData.task_time_display || '‚Äî';
      }
      refreshItBlockState(passportData);
    }

    function updateTitlePhotoPreview(photos) {
      if (!titlePhotoPreview || !titlePhotoImage) return;
      const list = Array.isArray(photos) ? photos : [];
      const titlePhoto = list.find((photo) => photo && photo.category === 'title' && photo.url);
      if (titlePhoto) {
        titlePhotoImage.src = titlePhoto.url;
        titlePhotoImage.dataset.photoId = titlePhoto.id != null ? String(titlePhoto.id) : '';
        titlePhotoPreview.dataset.photoId = titlePhotoImage.dataset.photoId;
        titlePhotoPreview.classList.remove('d-none');
      } else {
        titlePhotoImage.src = '';
        delete titlePhotoImage.dataset.photoId;
        delete titlePhotoPreview.dataset.photoId;
        titlePhotoPreview.classList.add('d-none');
      }
    }

    function formatNetworkSpeedValue(value) {
      const raw = (value || '').trim();
      if (!raw) return '';

      const normalized = raw.replace(/\s+/g, ' ');
      const numericFrom = (source) => {
        const cleaned = source.replace(/[\s,]/g, (match) => (match === ',' ? '.' : ''));
        const numeric = cleaned.replace(/[^0-9.]/g, '');
        return /^\d+(?:\.\d+)?$/.test(numeric) ? numeric : '';
      };

      const ensureSuffix = (base) => {
        const trimmed = base.trim();
        const numeric = numericFrom(trimmed);
        return `${numeric || trimmed} –ú–±–∏—Ç/—Å`.trim();
      };

      if (/–º–±–∏—Ç\s*\/\s*—Å$/i.test(normalized)) {
        const base = normalized.replace(/–º–±–∏—Ç\s*\/\s*—Å$/i, '');
        return ensureSuffix(base);
      }

      if (/–±–∏—Ç\s*\/\s*—Å$/i.test(normalized)) {
        const base = normalized.replace(/–±–∏—Ç\s*\/\s*—Å$/i, '');
        return ensureSuffix(base);
      }

      const numeric = numericFrom(normalized);
      if (numeric) {
        return `${numeric} –ú–±–∏—Ç/—Å`;
      }
      return normalized;
    }

    const handleSpeedFormatting = () => {
      if (!networkSpeedInput) return;
      networkSpeedInput.value = formatNetworkSpeedValue(networkSpeedInput.value);
    };

    const networkProfileFieldMapping = {
      provider: networkProviderInput,
      contract_number: networkContractInput,
      support_phone: networkSupportPhoneInput,
      legal_entity: networkLegalEntityInput,
    };

    function normalizeNetworkProfileValue(value) {
      return (value || '').trim().toLowerCase();
    }

    let suppressNetworkProfileSync = false;

    function findNetworkProfileByField(field, value) {
      const normalized = normalizeNetworkProfileValue(value);
      if (!normalized) return null;
      return networkProfiles.find((profile) => {
        if (!profile) return false;
        const candidate = profile[field];
        return normalizeNetworkProfileValue(candidate) === normalized;
      }) || null;
    }

    function fillNetworkProfileFields(profile) {
      if (!profile) return;
      suppressNetworkProfileSync = true;
      Object.entries(networkProfileFieldMapping).forEach(([key, input]) => {
        if (!input) return;
        input.value = profile[key] || '';
      });
      suppressNetworkProfileSync = false;
    }

    function handleNetworkProfileSelection(field, value) {
      if (suppressNetworkProfileSync) return;
      const profile = findNetworkProfileByField(field, value);
      if (profile) {
        fillNetworkProfileFields(profile);
      }
    }

    function toggleScheduleInputs(row, is24) {
      const fromInput = row.querySelector('.schedule-from');
      const toInput = row.querySelector('.schedule-to');
      fromInput.disabled = is24;
      toInput.disabled = is24;
      if (is24) {
        fromInput.value = '';
        toInput.value = '';
      }
    }

    function populateSchedule(schedule) {
      const mapping = {};
      (schedule || []).forEach((entry) => {
        if (entry && entry.day) {
          mapping[entry.day] = entry;
        }
      });
      document.querySelectorAll('#scheduleTable tbody tr').forEach((row) => {
        const day = row.dataset.day;
        const data = mapping[day] || {};
        const is24 = Boolean(data.is_24);
        row.querySelector('.schedule-24').checked = is24;
        row.querySelector('.schedule-from').value = is24 ? '' : (data.from || '');
        row.querySelector('.schedule-to').value = is24 ? '' : (data.to || '');
        toggleScheduleInputs(row, is24);
      });
    }

    function collectSchedule() {
      return Array.from(document.querySelectorAll('#scheduleTable tbody tr')).map((row) => {
        const day = row.dataset.day;
        const is24 = row.querySelector('.schedule-24').checked;
        const fromInput = row.querySelector('.schedule-from').value;
        const toInput = row.querySelector('.schedule-to').value;
        return {
          day,
          from: is24 ? '' : fromInput,
          to: is24 ? '' : toInput,
          is_24: is24,
        };
      });
    }

    function toggleSectionsAvailability() {
      const disabled = Boolean(passportData.is_new);
      photoUploadForm.querySelectorAll('input, select, button').forEach((el) => {
        el.disabled = disabled;
      });
      if (networkFilesForm) {
        networkFilesForm.querySelectorAll('input, button').forEach((el) => {
          el.disabled = disabled;
        });
      }
      addEquipmentBtn.disabled = disabled;
      if (refreshTasksBtn) {
        refreshTasksBtn.disabled = disabled;
      }
      photosDisabledHint.classList.toggle('d-none', !disabled);
      equipmentDisabledHint.classList.toggle('d-none', !disabled);
    }

    function populateForm() {
      const data = passportData || {};
      ensureSelectHasOption(departmentSelect, data.department || '');
      departmentSelect.value = data.department || '';
      refreshSearchableSelect(departmentSelect);
      ensureSelectHasOption(businessSelect, data.business || '');
      businessSelect.value = data.business || '';
      refreshSearchableSelect(businessSelect);
      ensureSelectHasOption(partnerTypeSelect, data.partner_type || '');
      partnerTypeSelect.value = data.partner_type || '';
      refreshSearchableSelect(partnerTypeSelect);
      ensureSelectHasOption(countrySelect, data.country || '');
      countrySelect.value = data.country || '';
      refreshSearchableSelect(countrySelect);
      ensureSelectHasOption(legalEntitySelect, data.legal_entity || '');
      legalEntitySelect.value = data.legal_entity || '';
      refreshSearchableSelect(legalEntitySelect);
      cityInput.value = data.city || '';
      if (locationAddressInput) {
        locationAddressInput.value = data.location_address || '';
      }
      ensureSelectHasOption(statusSelect, data.status || (statuses[0] || ''));
      statusSelect.value = data.status || (statuses[0] || '');
      refreshSearchableSelect(statusSelect);
      internalNetworkInput.value = data.network || '';
      networkTunnelInput.value = data.network_tunnel || '';
      networkProviderInput.value = data.network_provider || '';
      networkContractInput.value = data.network_contract_number || '';
      networkLegalEntityInput.value = data.network_legal_entity || '';
      networkSupportPhoneInput.value = data.network_support_phone || '';
      networkSpeedInput.value = formatNetworkSpeedValue(data.network_speed || '');
      networkParamsInput.value = data.network_connection_params || '';
      setupAutoExpandTextarea(networkParamsInput);
      startDateInput.value = data.start_date || '';
      endDateInput.value = data.end_date || '';
      suspensionDateInput.value = data.suspension_date || '';
      resumeDateInput.value = data.resume_date || '';
      if (itObjectPhoneInput) itObjectPhoneInput.value = data.it_object_phone || '';
      if (itManagerNameInput) itManagerNameInput.value = data.it_manager_name || '';
      if (itManagerPhoneInput) itManagerPhoneInput.value = data.it_manager_phone || '';
      if (iikoServerSelect) iikoServerSelect.value = data.it_iiko_server || '';
      passportData.status_task_id = data.status_task_id != null ? data.status_task_id : null;
      passportData.status_task = data.status_task || null;
      totalTimeDisplay.textContent = data.total_work_time || '‚Äî';
      statusHistoryTotal.textContent = data.status_history_total || '‚Äî';
      passportData.status_history_total = data.status_history_total || '‚Äî';
      refreshItBlockState(data);
      updateItMetrics({
        caseMinutes: typeof data.case_time_minutes === 'number' ? data.case_time_minutes : undefined,
        caseDisplay: data.case_time_display,
        taskMinutes: typeof data.task_time_minutes === 'number' ? data.task_time_minutes : undefined,
        taskDisplay: data.task_time_display,
      });
      renderStatusHistory(data.status_history || []);
      updateStatusBadge();
      updateNetworkBadge();
      updateObjectTitle();
      populateSchedule(data.schedule || []);
      renderPhotos(data.photos || []);
      renderNetworkFiles(data.network_files || []);
      renderEquipment(data.equipment || []);
      renderTasks(data.tasks || [], {
        totalMinutes: typeof data.task_time_minutes === 'number' ? data.task_time_minutes : undefined,
        totalDisplay: data.task_time_display,
      });
      renderCases(data.cases || [], {
        totalMinutes: typeof data.case_time_minutes === 'number' ? data.case_time_minutes : undefined,
        totalDisplay: data.case_time_display,
      });
      toggleSectionsAvailability();
      updateStatusTaskRequirement();
    }

    function collectFormData() {
      return {
        department: departmentSelect.value.trim(),
        business: businessSelect.value.trim(),
        partner_type: partnerTypeSelect.value.trim(),
        country: countrySelect.value.trim(),
        legal_entity: legalEntitySelect.value.trim(),
        city: cityInput.value.trim(),
        location_address: locationAddressInput ? locationAddressInput.value.trim() : '',
        status: statusSelect.value.trim(),
        network: internalNetworkInput.value.trim(),
        network_provider: networkProviderInput.value.trim(),
        network_contract_number: networkContractInput.value.trim(),
        network_legal_entity: networkLegalEntityInput.value.trim(),
        network_support_phone: networkSupportPhoneInput.value.trim(),
        network_speed: formatNetworkSpeedValue(networkSpeedInput.value),
        network_tunnel: networkTunnelInput.value.trim(),
        network_connection_params: networkParamsInput.value.trim(),
        it_connection_type: passportData.it_connection_type || '',
        it_connection_id: passportData.it_connection_id || '',
        it_connection_password: passportData.it_connection_password || '',
        it_object_phone: itObjectPhoneInput ? itObjectPhoneInput.value.trim() : '',
        it_manager_name: itManagerNameInput ? itManagerNameInput.value.trim() : '',
        it_manager_phone: itManagerPhoneInput ? itManagerPhoneInput.value.trim() : '',
        it_iiko_server: iikoServerSelect ? iikoServerSelect.value.trim() : '',
        start_date: startDateInput.value || '',
        end_date: endDateInput.value || '',
        suspension_date: suspensionDateInput.value || '',
        resume_date: resumeDateInput.value || '',
        status_task_id: statusTaskSelect ? statusTaskSelect.value : '',
        schedule: collectSchedule(),
      };
    }

    async function savePassport() {
      const payload = collectFormData();
      if (!payload.department) {
        showSaveMessage('error', '–ü–æ–ª–µ ¬´–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç¬ª –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è.');
        return;
      }
      if (statusesRequiringTask.has(payload.status) && !payload.status_task_id) {
        showSaveMessage('error', '–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –∑–∞–¥–∞—á—É.');
        return;
      }
      const isNew = Boolean(passportData.is_new);
      const url = isNew ? '/api/object_passports' : `/api/object_passports/${passportData.id}`;
      const method = isNew ? 'POST' : 'PUT';
      savePassportBtn.disabled = true;
      savePassportBtn.innerText = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
      try {
        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await response.json();
        if (!response.ok || data.success === false) {
          throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Å–ø–æ—Ä—Ç');
        }
        if (isNew && data.id) {
          window.location.href = `/object_passports/${data.id}`;
          return;
        }
        passportData = data.passport || passportData;
        passportData.is_new = false;
        populateForm();
        if (payload.resume_date) {
          resumeDateInput.value = '';
          passportData.resume_date = '';
        }
        showSaveMessage('success', '–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.');
      } catch (error) {
        console.error(error);
        showSaveMessage('error', error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.');
      } finally {
        savePassportBtn.disabled = false;
        savePassportBtn.innerText = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
      }
    }

    async function addParameter(paramType, selectId) {
      const select = document.getElementById(selectId);
      if (!select) return;
      const value = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:');
      if (!value || !value.trim()) return;
      try {
        const response = await fetch('/api/settings/parameters', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ param_type: paramType, value: value.trim() }),
        });
        const data = await response.json();
        if (!response.ok || data.success === false) {
          throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ');
        }
        parameterValues = normalizeParameterResponse((data && data.data) || parameterValues);
        updateSelectOptions();
        select.value = value.trim();
        refreshSearchableSelect(select);
        if (select === businessSelect || select === departmentSelect) {
          updateObjectTitle();
        }
        showSaveMessage('success', '–ó–Ω–∞—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ.');
      } catch (error) {
        console.error(error);
        showSaveMessage('error', error.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–Ω–∞—á–µ–Ω–∏—è.');
      }
    }

    function updateSelectOptions() {
      const mapping = [
        { select: departmentSelect, key: 'department' },
        { select: businessSelect, key: 'business' },
        { select: partnerTypeSelect, key: 'partner_type' },
        { select: countrySelect, key: 'country' },
        { select: legalEntitySelect, key: 'legal_entity' },
      ];
      mapping.forEach(({ select, key }) => {
        const current = (select.value || '').trim();
        const options = parameterValues[key] || [];
        select.innerHTML = '<option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>' + options.map((val) => `<option value="${escapeHtml(val)}">${escapeHtml(val)}</option>`).join('');
        if (current) {
          ensureSelectHasOption(select, current);
          select.value = current;
        } else {
          select.value = '';
        }
        refreshSearchableSelect(select);
      });
      updateObjectTitle();
    }

    function renderCases(cases, summary) {
      const items = Array.isArray(cases) ? cases : [];
      passportData.cases = items;
      const summaryData = summary && typeof summary === 'object' ? summary : {};
      const summaryMinutesRaw = summaryData.totalMinutes ?? summaryData.total_minutes;
      const summaryDisplayRaw = summaryData.formattedTotal || summaryData.totalDisplay || summaryData.total_display;
      if (typeof summaryMinutesRaw === 'number' && !Number.isNaN(summaryMinutesRaw)) {
        passportData.case_time_minutes = summaryMinutesRaw;
      }
      if (typeof summaryDisplayRaw === 'string') {
        passportData.case_time_display = summaryDisplayRaw;
      }
      const caseMinutesValue =
        typeof summaryMinutesRaw === 'number' && !Number.isNaN(summaryMinutesRaw)
          ? summaryMinutesRaw
          : passportData.case_time_minutes;
      const caseDisplayValue =
        typeof summaryDisplayRaw === 'string' && summaryDisplayRaw
          ? summaryDisplayRaw
          : passportData.case_time_display;
      updateItMetrics({
        caseMinutes: typeof caseMinutesValue === 'number' && !Number.isNaN(caseMinutesValue)
          ? caseMinutesValue
          : undefined,
        caseDisplay: caseDisplayValue,
      });
      casesTableBody.innerHTML = '';
      if (!items.length) {
        casesEmptyText.classList.remove('d-none');
        return;
      }
      casesEmptyText.classList.add('d-none');
      items.forEach((item) => {
        const tr = document.createElement('tr');
        const ticketId = item.ticket_id || '';
        const ticketLink = ticketId ? `/tickets/${encodeURIComponent(ticketId)}` : '';
        const ticketCell = ticketLink
          ? `<a href="${ticketLink}" target="_blank" class="link-primary text-decoration-none">${escapeHtml(ticketId)}</a>`
          : `<span>${escapeHtml(ticketId)}</span>`;
        tr.innerHTML = `
          <td>${ticketCell}</td>
          <td>${escapeHtml(item.business || '')}</td>
          <td>${escapeHtml(item.city || '')}</td>
          <td>${escapeHtml(item.problem || '')}</td>
          <td>${escapeHtml(item.created_at_display || item.created_at || '')}</td>
        `;
        if (ticketLink) {
          tr.classList.add('table-row-link');
          tr.addEventListener('click', (event) => {
            if (event.target.closest('a')) return;
            window.open(ticketLink, '_blank');
          });
        }
        casesTableBody.appendChild(tr);
      });
    }

    async function refreshCases() {
      if (passportData.is_new) return;
      try {
        const response = await fetch(`/api/object_passports/${passportData.id}/cases`);
        const data = await response.json();
        if (!response.ok || data.success === false) {
          throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–±—Ä–∞—â–µ–Ω–∏–π');
        }
        renderCases(data.items || [], {
          totalMinutes: typeof data.total_minutes === 'number' ? data.total_minutes : undefined,
          totalDisplay: data.total_display,
        });
      } catch (error) {
        console.error(error);
        showSaveMessage('error', error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏—è.');
      }
    }

    function renderTasks(tasks, summary) {
      if (!tasksTableBody || !tasksEmptyText) return;
      const list = Array.isArray(tasks) ? tasks : [];
      passportData.tasks = list;
      if (passportData.status_task_id != null) {
        const matchedTask = list.find((task) => String(task.id) === String(passportData.status_task_id));
        if (matchedTask) {
          passportData.status_task = matchedTask;
        }
      }
      const summaryData = summary && typeof summary === 'object' ? summary : {};
      const taskMinutesRaw = summaryData.totalMinutes ?? summaryData.total_minutes;
      const taskDisplayRaw = summaryData.formattedTotal || summaryData.totalDisplay || summaryData.total_display;
      if (typeof taskMinutesRaw === 'number' && !Number.isNaN(taskMinutesRaw)) {
        passportData.task_time_minutes = taskMinutesRaw;
      }
      if (typeof taskDisplayRaw === 'string') {
        passportData.task_time_display = taskDisplayRaw;
      }
      const taskMinutesValue =
        typeof taskMinutesRaw === 'number' && !Number.isNaN(taskMinutesRaw)
          ? taskMinutesRaw
          : passportData.task_time_minutes;
      const taskDisplayValue =
        typeof taskDisplayRaw === 'string' && taskDisplayRaw
          ? taskDisplayRaw
          : passportData.task_time_display;
      updateItMetrics({
        taskMinutes: typeof taskMinutesValue === 'number' && !Number.isNaN(taskMinutesValue)
          ? taskMinutesValue
          : undefined,
        taskDisplay: taskDisplayValue,
      });
      tasksTableBody.innerHTML = '';
      if (!list.length) {
        tasksEmptyText.classList.remove('d-none');
      } else {
        tasksEmptyText.classList.add('d-none');
        list.forEach((task) => {
          const tr = document.createElement('tr');
          const displayNo = escapeHtml(task.display_no || (task.id != null ? String(task.id) : ''));
          const title = escapeHtml(task.title || '');
          const status = escapeHtml(task.status || '');
          const assignee = escapeHtml(task.assignee || '');
          const due = escapeHtml(task.due_at_display || task.due_at || '‚Äî');
          const updated = escapeHtml(task.last_activity_display || task.last_activity || '‚Äî');
          tr.innerHTML = `
            <td>${displayNo || '‚Äî'}</td>
            <td>${title || '‚Äî'}</td>
            <td>${status || '‚Äî'}</td>
            <td>${assignee || '‚Äî'}</td>
            <td>${due}</td>
            <td>${updated}</td>
          `;
          if (task.id) {
            tr.classList.add('table-row-link');
            tr.addEventListener('click', () => {
              window.open(`/tasks#task=${encodeURIComponent(task.id)}`, '_blank');
            });
          }
          tasksTableBody.appendChild(tr);
        });
      }
      renderStatusTaskOptions(list);
    }

    async function refreshTasks() {
      if (passportData.is_new) return;
      if (!passportData.id) return;
      try {
        const response = await fetch(`/api/object_passports/${passportData.id}/tasks`);
        const data = await response.json();
        if (!response.ok || data.success === false) {
          throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–¥–∞—á');
        }
        renderTasks(data.items || [], {
          totalMinutes: typeof data.total_minutes === 'number' ? data.total_minutes : undefined,
          totalDisplay: data.total_display,
        });
      } catch (error) {
        console.error(error);
        showSaveMessage('error', error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á–∏.');
      }
    }

    function renderStatusTaskOptions(tasks) {
      if (!statusTaskSelect) return;
      const list = Array.isArray(tasks) ? tasks : [];
      const preservedValue = passportData.status_task_id != null ? String(passportData.status_task_id) : (statusTaskSelect.value || '');
      const options = ['<option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>'];
      list.forEach((task) => {
        const descriptor = [task.display_no || (task.id != null ? String(task.id) : ''), task.title || '']
          .filter(Boolean)
          .join(' ¬∑ ');
        options.push(`<option value="${task.id}">${escapeHtml(descriptor || String(task.id || ''))}</option>`);
      });
      if (passportData.status_task && passportData.status_task.id && !list.some((task) => String(task.id) === String(passportData.status_task.id))) {
        const descriptor = [passportData.status_task.display_no || String(passportData.status_task.id), passportData.status_task.title || '']
          .filter(Boolean)
          .join(' ¬∑ ');
        options.push(`<option value="${passportData.status_task.id}">${escapeHtml(descriptor)}</option>`);
      }
      statusTaskSelect.innerHTML = options.join('');
      if (preservedValue) {
        statusTaskSelect.value = preservedValue;
      }
      if (!statusTaskSelect.value && preservedValue) {
        statusTaskSelect.value = preservedValue;
      }
      if (statusTaskSearchInput) {
        filterSelectOptions(statusTaskSelect, statusTaskSearchInput.value);
        if (document.activeElement !== statusTaskSearchInput) {
          syncSelectSearchInput(statusTaskSelect);
        }
      } else {
        syncSelectSearchInput(statusTaskSelect);
      }
      updateStatusTaskInfo();
    }

    function updateStatusTaskRequirement() {
      if (!statusTaskContainer || !statusTaskSelect) return;
      const requiresTask = statusesRequiringTask.has(statusSelect.value);
      statusTaskContainer.classList.toggle('d-none', !requiresTask);
      if (statusTaskHint) {
        statusTaskHint.textContent = passportData.is_new
          ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∑–∞–¥–∞—á—É.'
          : '–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É, –æ—Ç—Ä–∞–∂–∞—é—â—É—é —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞.';
      }
      if (requiresTask) {
        if (!Array.isArray(passportData.tasks) || !passportData.tasks.length) {
          if (!passportData.is_new) {
            refreshTasks();
          }
        } else {
          renderStatusTaskOptions(passportData.tasks);
        }
      } else if (statusTaskInfo) {
        statusTaskInfo.textContent = '';
      }
    }

    function updateStatusTaskInfo() {
      if (!statusTaskInfo || !statusTaskSelect) return;
      const selectedValue = statusTaskSelect.value;
      if (!selectedValue) {
        statusTaskInfo.textContent = '';
        return;
      }
      let task = (passportData.tasks || []).find((item) => String(item.id) === selectedValue);
      if (!task && passportData.status_task && String(passportData.status_task.id) === selectedValue) {
        task = passportData.status_task;
      }
      if (!task) {
        statusTaskInfo.textContent = '';
        return;
      }
      const parts = [];
      if (task.status) parts.push(`–°—Ç–∞—Ç—É—Å: ${task.status}`);
      if (task.assignee) parts.push(`–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: ${task.assignee}`);
      if (task.due_at_display || task.due_at) parts.push(`–î–µ–¥–ª–∞–π–Ω: ${task.due_at_display || task.due_at}`);
      if (task.last_activity_display || task.last_activity) parts.push(`–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${task.last_activity_display || task.last_activity}`);
      statusTaskInfo.textContent = parts.join(' ¬∑ ');
    }

    function renderStatusHistory(history) {
      if (!statusHistoryList) return;
      const items = Array.isArray(history) ? history : [];
      passportData.status_history = items;
      if (!items.length) {
        statusHistoryList.innerHTML = '';
        if (statusHistoryEmpty) {
          statusHistoryEmpty.classList.remove('d-none');
        }
        if (statusHistoryToggle) {
          statusHistoryToggle.classList.add('d-none');
        }
        if (statusHistoryCollapse) {
          statusHistoryCollapse.classList.remove('show');
        }
        updateStatusHistoryToggleLabel(false);
        return;
      }
      statusHistoryList.innerHTML = '';
      items.forEach((item) => {
        const entry = document.createElement('div');
        entry.className = 'status-history-entry';
        const statusLabel = escapeHtml(item.status || '‚Äî');
        const startDisplay = escapeHtml(item.started_display || item.started_at || '‚Äî');
        const endRaw = item.ended_display || item.ended_at || '';
        const endDisplay = escapeHtml(endRaw || '');
        const durationDisplay = escapeHtml(item.duration_display || '‚Äî');
        const isActive = Boolean(item.is_active) || !endRaw;
        const periodText = endDisplay ? `—Å ${startDisplay} –ø–æ ${endDisplay}` : `—Å ${startDisplay}`;
        entry.innerHTML = `
          <div class="d-flex align-items-center gap-2 mb-2">
            <span class="badge bg-light text-dark">${statusLabel}</span>
            ${isActive ? '<span class="badge bg-warning text-dark">–ê–∫—Ç–∏–≤–Ω–æ</span>' : ''}
          </div>
          <div class="history-dates">${periodText}</div>
          <div class="history-duration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${durationDisplay}</div>
        `;
        statusHistoryList.appendChild(entry);
      });
      if (statusHistoryEmpty) {
        statusHistoryEmpty.classList.add('d-none');
      }
      if (statusHistoryToggle) {
        statusHistoryToggle.classList.remove('d-none');
      }
      const collapseInstance = ensureStatusHistoryCollapse();
      if (collapseInstance) {
        collapseInstance.hide();
      } else if (statusHistoryCollapse) {
        statusHistoryCollapse.classList.remove('show');
      }
      updateStatusHistoryToggleLabel(false);
    }

    function renderPhotos(photos) {
      const list = Array.isArray(photos) ? photos : [];
      const sorted = list.slice().sort((a, b) => {
        const aIsTitle = ((a && a.category) || '').toLowerCase() === 'title';
        const bIsTitle = ((b && b.category) || '').toLowerCase() === 'title';
        if (aIsTitle === bIsTitle) return 0;
        return aIsTitle ? -1 : 1;
      });
      passportData.photos = sorted;
      photosContainer.innerHTML = '';
      updateTitlePhotoPreview(sorted);
      if (!sorted.length) {
        photosEmptyText.classList.remove('d-none');
        return;
      }
      photosEmptyText.classList.add('d-none');
      sorted.forEach((photo) => {
        const col = document.createElement('div');
        col.className = 'col-md-4';
        const captionRaw = photo.caption || '';
        const captionHtml = escapeHtml(captionRaw).replace(/\n/g, '<br>');
        const categoryValue = ((photo && photo.category) || '').toLowerCase();
        const isTitleCategory = categoryValue === 'title';
        const categoryLabel = isTitleCategory ? '–¢–∏—Ç—É–ª—å–Ω–æ–µ' : '–ê—Ä—Ö–∏–≤–Ω–æ–µ';
        col.innerHTML = `
          <div class="card h-100 photo-card" data-id="${photo.id != null ? photo.id : ''}">
            <div class="position-relative">
              ${isTitleCategory ? '<span class="title-indicator">‚úî</span>' : ''}
              <div class="dropdown photo-toolbar">
                <button class="btn btn-sm btn-light border dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">‚ãÆ</button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item" href="#" data-action="toggle-photo-edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a></li>
                  <li><a class="dropdown-item" href="${escapeHtml(photo.url)}" download>–°–∫–∞—á–∞—Ç—å</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item text-danger" href="#" data-action="delete-photo">–£–¥–∞–ª–∏—Ç—å</a></li>
                </ul>
              </div>
              <img src="${escapeHtml(photo.url)}" class="card-img-top passport-photo" alt="–§–æ—Ç–æ" data-photo-id="${photo.id != null ? photo.id : ''}" />
            </div>
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <span class="badge bg-light text-dark">${categoryLabel}</span>
              </div>
              <div class="photo-caption-text">${captionHtml || '‚Äî'}</div>
              <form class="photo-edit-form mt-3 d-none">
                <div class="mb-2">
                  <label class="form-label">–ü–æ–¥–ø–∏—Å—å</label>
                  <input type="text" class="form-control form-control-sm photo-caption" value="${escapeHtml(photo.caption || '')}" />
                </div>
                <div class="mb-3">
                  <label class="form-label">–¢–∏–ø</label>
                  <select class="form-select form-select-sm photo-category">
                    <option value="title" ${isTitleCategory ? 'selected' : ''}>–¢–∏—Ç—É–ª—å–Ω–æ–µ</option>
                    <option value="archive" ${isTitleCategory ? '' : 'selected'}>–ê—Ä—Ö–∏–≤–Ω–æ–µ</option>
                  </select>
                </div>
                <div class="d-flex gap-2">
                  <button class="btn btn-sm btn-primary" type="button" data-action="save-photo">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                  <button class="btn btn-sm btn-outline-secondary" type="button" data-action="cancel-photo-edit">–û—Ç–º–µ–Ω–∞</button>
                </div>
              </form>
            </div>
          </div>
        `;
        photosContainer.appendChild(col);
      });
    }

    function updatePhotoPreviewMeta(activeIndex) {
      if (!Array.isArray(currentPhotoPreviewList) || !currentPhotoPreviewList.length) return;
      const index = typeof activeIndex === 'number' ? activeIndex : 0;
      const boundedIndex = Math.max(0, Math.min(index, currentPhotoPreviewList.length - 1));
      const photo = currentPhotoPreviewList[boundedIndex];
      if (!photo) return;
      const captionHtml = escapeHtml(photo.caption || '').replace(/\n/g, '<br>');
      if (photoPreviewCaption) {
        photoPreviewCaption.innerHTML = captionHtml || '‚Äî';
      }
      if (photoPreviewDownload) {
        if (photo.url) {
          photoPreviewDownload.href = photo.url;
          photoPreviewDownload.classList.remove('disabled');
        } else {
          photoPreviewDownload.href = '#';
          photoPreviewDownload.classList.add('disabled');
        }
      }
    }

    function buildPhotoPreviewCarousel(photos, activeIndex) {
      if (!photoPreviewCarouselInner) return;
      photoPreviewCarouselInner.innerHTML = '';
      photos.forEach((photo, index) => {
        const item = document.createElement('div');
        item.className = `carousel-item${index === activeIndex ? ' active' : ''}`;
        item.innerHTML = `<img src="${escapeHtml(photo.url)}" class="d-block w-100 rounded" alt="–§–æ—Ç–æ" data-photo-id="${photo.id != null ? photo.id : ''}" />`;
        photoPreviewCarouselInner.appendChild(item);
      });
      const hasMultiple = photos.length > 1;
      if (photoPreviewPrev) {
        photoPreviewPrev.classList.toggle('d-none', !hasMultiple);
      }
      if (photoPreviewNext) {
        photoPreviewNext.classList.toggle('d-none', !hasMultiple);
      }
    }

    function openPhotoPreviewById(photoId) {
      if (!photoPreviewModalEl || !photoPreviewCarouselEl) return;
      const photos = Array.isArray(passportData.photos) ? passportData.photos : [];
      if (!photos.length) return;
      currentPhotoPreviewList = photos;
      let activeIndex = photos.findIndex((photo) => String(photo.id) === String(photoId));
      if (activeIndex < 0) {
        activeIndex = 0;
      }
      buildPhotoPreviewCarousel(currentPhotoPreviewList, activeIndex);
      if (typeof bootstrap !== 'undefined') {
        const existingCarousel = bootstrap.Carousel.getInstance(photoPreviewCarouselEl);
        if (existingCarousel) {
          existingCarousel.dispose();
        }
        photoPreviewCarouselInstance = bootstrap.Carousel.getOrCreateInstance(photoPreviewCarouselEl, {
          interval: false,
          ride: false,
          wrap: true,
        });
        if (typeof photoPreviewCarouselInstance.to === 'function') {
          photoPreviewCarouselInstance.to(activeIndex);
        }
        updatePhotoPreviewMeta(activeIndex);
        if (!photoPreviewModalInstance) {
          photoPreviewModalInstance = new bootstrap.Modal(photoPreviewModalEl);
        }
        photoPreviewModalInstance.show();
      } else {
        updatePhotoPreviewMeta(activeIndex);
      }
    }

    function openSinglePhotoPreview(url, caption) {
      if (!photoPreviewModalEl || !photoPreviewCarouselEl) return;
      const safeUrl = url || '';
      if (!safeUrl) return;
      let decodedCaption = '';
      if (caption) {
        try {
          decodedCaption = decodeURIComponent(caption);
        } catch (error) {
          decodedCaption = caption;
        }
      }
      currentPhotoPreviewList = [
        {
          id: '__single__',
          url: safeUrl,
          caption: decodedCaption,
        },
      ];
      buildPhotoPreviewCarousel(currentPhotoPreviewList, 0);
      if (typeof bootstrap !== 'undefined') {
        const existingCarousel = bootstrap.Carousel.getInstance(photoPreviewCarouselEl);
        if (existingCarousel) {
          existingCarousel.dispose();
        }
        photoPreviewCarouselInstance = bootstrap.Carousel.getOrCreateInstance(photoPreviewCarouselEl, {
          interval: false,
          ride: false,
          wrap: false,
        });
        if (typeof photoPreviewCarouselInstance.to === 'function') {
          photoPreviewCarouselInstance.to(0);
        }
        updatePhotoPreviewMeta(0);
        if (!photoPreviewModalInstance) {
          photoPreviewModalInstance = new bootstrap.Modal(photoPreviewModalEl);
        }
        photoPreviewModalInstance.show();
      } else {
        updatePhotoPreviewMeta(0);
      }
    }

    if (photoPreviewCarouselEl) {
      photoPreviewCarouselEl.addEventListener('slid.bs.carousel', (event) => {
        const nextIndex = typeof event.to === 'number' ? event.to : 0;
        updatePhotoPreviewMeta(nextIndex);
      });
    }

    function renderNetworkFiles(files) {
      const list = Array.isArray(files) ? files : [];
      passportData.network_files = list;
      if (networkFilesList) {
        networkFilesList.innerHTML = '';
      }
      if (!list.length) {
        if (networkFilesEmptyText) {
          networkFilesEmptyText.classList.remove('d-none');
        }
        return;
      }
      if (networkFilesEmptyText) {
        networkFilesEmptyText.classList.add('d-none');
      }
      list.forEach((file) => {
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex justify-content-between align-items-center flex-wrap gap-2';
        item.dataset.id = file.id;
        const sizePart = file.size_display ? escapeHtml(file.size_display) : '';
        const createdPart = file.created_at_display ? escapeHtml(file.created_at_display) : '';
        const metaParts = [sizePart, createdPart].filter(Boolean).join(' ¬∑ ');
        const downloadUrl = escapeHtml(file.download_url || file.url || '#');
        const viewUrl = escapeHtml(file.url || downloadUrl);
        item.innerHTML = `
          <div class="me-auto">
            <a href="${viewUrl}" target="_blank" rel="noopener" class="fw-semibold text-decoration-none">${escapeHtml(file.original_name || '–§–∞–π–ª')}</a>
            ${metaParts ? `<div class="text-muted small">${metaParts}</div>` : ''}
          </div>
          <div class="btn-group btn-group-sm" role="group">
            <a class="btn btn-outline-primary" href="${downloadUrl}" download>
              ‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å
            </a>
            <button class="btn btn-outline-danger" type="button" data-action="delete-network-file">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        `;
        if (networkFilesList) {
          networkFilesList.appendChild(item);
        }
      });
    }

    async function handlePhotoSave(card) {
      const photoId = card.dataset.id;
      const caption = card.querySelector('.photo-caption').value;
      const category = card.querySelector('.photo-category').value;
      try {
        const response = await fetch(`/api/object_passports/photos/${photoId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ caption, category }),
        });
        const data = await response.json();
        if (!response.ok || data.success === false) {
          throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ñ–æ—Ç–æ');
        }
        renderPhotos(data.photos || []);
        showSaveMessage('success', '–§–æ—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ.');
      } catch (error) {
        console.error(error);
        showSaveMessage('error', error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ñ–æ—Ç–æ.');
      }
    }

    async function handlePhotoDelete(card) {
      const photoId = card.dataset.id;
      if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ?')) return;
      try {
        const response = await fetch(`/api/object_passports/photos/${photoId}`, { method: 'DELETE' });
        const data = await response.json();
        if (!response.ok || data.success === false) {
          throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ');
        }
        renderPhotos(data.photos || []);
        showSaveMessage('success', '–§–æ—Ç–æ —É–¥–∞–ª–µ–Ω–æ.');
      } catch (error) {
        console.error(error);
        showSaveMessage('error', error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ.');
      }
    }

    function togglePhotoEdit(card, forceState) {
      if (!card) return;
      const form = card.querySelector('.photo-edit-form');
      if (!form) return;
      let show;
      if (typeof forceState === 'boolean') {
        show = forceState;
      } else {
        show = form.classList.contains('d-none');
      }
      if (show) {
        const photoId = card.dataset.id;
        const currentPhoto = (passportData.photos || []).find((item) => String(item.id) === String(photoId));
        if (currentPhoto) {
          const captionInput = form.querySelector('.photo-caption');
          const categorySelect = form.querySelector('.photo-category');
          if (captionInput) captionInput.value = currentPhoto.caption || '';
          if (categorySelect) categorySelect.value = currentPhoto.category || 'archive';
        }
        form.classList.remove('d-none');
      } else {
        form.classList.add('d-none');
      }
    }

    photosContainer.addEventListener('click', (event) => {
      const actionEl = event.target.closest('[data-action]');
      if (!actionEl) {
        const previewTarget = event.target.closest('.passport-photo');
        if (previewTarget) {
          openPhotoPreviewById(previewTarget.dataset.photoId);
        }
        return;
      }
      event.preventDefault();
      const card = actionEl.closest('.photo-card');
      if (!card) return;
      const action = actionEl.dataset.action;
      if (action === 'save-photo') {
        handlePhotoSave(card);
      } else if (action === 'delete-photo') {
        handlePhotoDelete(card);
      } else if (action === 'toggle-photo-edit') {
        togglePhotoEdit(card);
      } else if (action === 'cancel-photo-edit') {
        togglePhotoEdit(card, false);
      }
    });

    function showPhotoPreview(url, caption) {
      openSinglePhotoPreview(url, caption);
    }

    photoUploadForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (passportData.is_new) {
        showSaveMessage('error', '–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç.');
        return;
      }
      const formData = new FormData(photoUploadForm);
      try {
        const response = await fetch(`/api/object_passports/${passportData.id}/photos`, {
          method: 'POST',
          body: formData,
        });
        const data = await response.json();
        if (!response.ok || data.success === false) {
          throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ');
        }
        photoUploadForm.reset();
        renderPhotos(data.photos || []);
        showSaveMessage('success', '–§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ.');
      } catch (error) {
        console.error(error);
        showSaveMessage('error', error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ.');
      }
    });

     if (networkFilesForm) {
      networkFilesForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (passportData.is_new) {
          showSaveMessage('error', '–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç.');
          return;
        }
        const formData = new FormData(networkFilesForm);
        const uploadedFile = formData.get('file');
        if (!uploadedFile || !uploadedFile.name) {
          showSaveMessage('error', '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏.');
          return;
        }
        try {
          const response = await fetch(`/api/object_passports/${passportData.id}/network_files`, {
            method: 'POST',
            body: formData,
          });
          const data = await response.json();
          if (!response.ok || data.success === false) {
            throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞');
          }
          networkFilesForm.reset();
          renderNetworkFiles(data.files || []);
          showSaveMessage('success', '–§–∞–π–ª –¥–æ–±–∞–≤–ª–µ–Ω.');
        } catch (error) {
          console.error(error);
          showSaveMessage('error', error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª.');
        }
      });
    }

    if (networkFilesList) {
      networkFilesList.addEventListener('click', async (event) => {
        const button = event.target.closest('[data-action="delete-network-file"]');
        if (!button) return;
        const item = button.closest('.list-group-item');
        if (!item) return;
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª?')) return;
        const fileId = item.dataset.id;
        try {
          const response = await fetch(`/api/object_passports/network_files/${fileId}`, { method: 'DELETE' });
          const data = await response.json();
          if (!response.ok || data.success === false) {
            throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞');
          }
          renderNetworkFiles(data.files || []);
          showSaveMessage('success', '–§–∞–π–ª —É–¥–∞–ª—ë–Ω.');
        } catch (error) {
          console.error(error);
          showSaveMessage('error', error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª.');
        }
      });
    }

    function renderEquipment(equipmentList) {
      const list = Array.isArray(equipmentList) ? equipmentList : [];
      passportData.equipment = list;
      enrichEquipmentOptionSetsFromEquipment(list);
      equipmentContainer.innerHTML = '';
      if (!list.length) {
        equipmentEmptyText.classList.remove('d-none');
      } else {
        equipmentEmptyText.classList.add('d-none');
      }
      updateItEquipmentList(list);
      list.forEach((item, index) => {
        const isNew = item.id === null || typeof item.id === 'undefined';
        const card = document.createElement('div');
        card.className = 'card mb-4 equipment-card';
        card.dataset.id = isNew ? `new-${index}` : item.id;
        const typeValues = getCombinedCatalogOptions('equipment_type', {
          equipment_vendor: item.vendor,
          equipment_model: item.model,
          serial_number: item.serial_number,
        });
        const vendorValues = getCombinedCatalogOptions('equipment_vendor', {
          equipment_type: item.equipment_type,
          equipment_model: item.model,
          serial_number: item.serial_number,
        });
        const modelValues = getCombinedCatalogOptions('equipment_model', {
          equipment_type: item.equipment_type,
          equipment_vendor: item.vendor,
          serial_number: item.serial_number,
        });
        const typeOptions = buildSelectOptions(typeValues, item.equipment_type || '');
        const vendorOptions = buildSelectOptions(vendorValues, item.vendor || '');
        const modelOptions = buildSelectOptions(modelValues, item.model || '');
        const statusOptions = buildSelectOptions(equipmentOptionSets.statuses, item.status || '');
        const connectionOptions = buildSelectOptions(itConnectionChoices, item.connection_type || '');
        const collapseId = `equipmentPhotos-${isNew ? `new-${index}` : item.id}`;
        const detailsCollapseId = `equipmentDetails-${isNew ? `new-${index}` : item.id}`;
        const hasPhotos = Array.isArray(item.photos) && item.photos.length > 0;
        const collapseShowClass = hasPhotos ? ' show' : '';
        const collapseButtonClass = hasPhotos ? '' : ' collapsed';
        const collapseExpanded = hasPhotos ? 'true' : 'false';
        const detailsShowClass = isNew ? ' show' : '';
        const detailsToggleClass = isNew ? '' : ' collapsed';
        const detailsExpanded = isNew ? 'true' : 'false';
        const detailsActionToggleClass = isNew ? '' : ' collapsed';
        const detailsActionToggleLabel = isNew ? '–°–≤–µ—Ä–Ω—É—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É' : '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É';
        const headerName = escapeHtml(item.name || '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ');
        const headerModel = escapeHtml(item.model || '‚Äî');
        const headerIp = escapeHtml(item.ip_address || '‚Äî');
        const headerStatus = escapeHtml(item.status || '‚Äî');
        const serialOptionsId = `equipmentSerialOptions-${isNew ? `new-${index}` : item.id}`;
        const serialOptions = buildDatalistOptions(equipmentOptionSets.serials, item.serial_number || '');
        card.innerHTML = `
          <div class="card-header d-flex justify-content-between align-items-center">
            <button class="equipment-header-toggle${detailsToggleClass}" type="button" data-bs-toggle="collapse" data-bs-target="#${detailsCollapseId}" aria-expanded="${detailsExpanded}" aria-controls="${detailsCollapseId}">
              <div class="equipment-header-summary">
                <div class="equipment-header-title">${headerName}</div>
                <div class="equipment-header-meta">
                  <span><strong>–ú–æ–¥–µ–ª—å:</strong> <span data-role="equipment-header-model">${headerModel}</span></span>
                  <span><strong>IP-–∞–¥—Ä–µ—Å:</strong> <span data-role="equipment-header-ip">${headerIp}</span></span>
                  <span><strong>–°—Ç–∞—Ç—É—Å:</strong> <span data-role="equipment-header-status">${headerStatus}</span></span>
                </div>
              </div>
              <span class="equipment-header-icon">‚ñº</span>
            </button>
            <div class="equipment-actions">
              <button class="btn btn-sm btn-outline-secondary equipment-details-toggle${detailsActionToggleClass}" type="button" data-bs-target="#${detailsCollapseId}" aria-expanded="${detailsExpanded}">${detailsActionToggleLabel}</button>
              <button class="btn btn-sm btn-success" data-action="save-equipment">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              ${isNew ? '<button class="btn btn-sm btn-outline-secondary" data-action="cancel-equipment">–û—Ç–º–µ–Ω–∏—Ç—å</button>' : '<button class="btn btn-sm btn-outline-danger" data-action="delete-equipment">–£–¥–∞–ª–∏—Ç—å</button>'}
            </div>
          </div>
          <div class="collapse${detailsShowClass}" id="${detailsCollapseId}">
            <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">–¢–∏–ø</label>
                <select class="form-select form-select-sm equipment-type">${typeOptions}</select>
              </div>
              <div class="col-md-4">
                <label class="form-label">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</label>
                <select class="form-select form-select-sm equipment-vendor">${vendorOptions}</select>
              </div>
              <div class="col-md-4">
                <label class="form-label">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</label>
                <input type="text" class="form-control form-control-sm equipment-name" value="${escapeHtml(item.name || '')}" />
              </div>
              <div class="col-md-3">
                <label class="form-label">–ú–æ–¥–µ–ª—å</label>
                <select class="form-select form-select-sm equipment-model">${modelOptions}</select>
              </div>
              <div class="col-md-3">
                <label class="form-label">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</label>
                <input type="text" class="form-control form-control-sm equipment-serial" value="${escapeHtml(item.serial_number || '')}" list="${serialOptionsId}" placeholder="SN..." />
                <datalist id="${serialOptionsId}" class="equipment-serial-options">${serialOptions}</datalist>
              </div>
              <div class="col-md-3">
                <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                <select class="form-select form-select-sm equipment-status">${statusOptions}</select>
              </div>
              <div class="col-md-3">
                <label class="form-label">IP-–∞–¥—Ä–µ—Å</label>
                <input type="text" class="form-control form-control-sm equipment-ip" value="${escapeHtml(item.ip_address || '')}" />
              </div>
              <div class="col-12">
                <div class="row g-2">
                  <div class="col-md-4">
                    <label class="form-label">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</label>
                    <select class="form-select form-select-sm equipment-connection-type">${connectionOptions}</select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">ID –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</label>
                    <input type="text" class="form-control form-control-sm equipment-connection-id" value="${escapeHtml(item.connection_id || '')}" placeholder="–≤–≤–µ–¥–∏—Ç–µ id" />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">–ü–∞—Ä–æ–ª—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</label>
                    <input type="text" class="form-control form-control-sm equipment-connection-password" value="${escapeHtml(item.connection_password || '')}" placeholder="–≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" />
                  </div>
                </div>
              </div>
              <div class="col-12">
                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea class="form-control form-control-sm equipment-description">${escapeHtml(item.description || '')}</textarea>
              </div>
            </div>
            ${isNew
              ? '<div class="alert alert-info mt-3 mb-0">–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∑–∞–ø–∏—Å—å, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.</div>'
              : `
            <hr>
            <div class="mt-3">
              <button class="btn btn-sm btn-outline-secondary equipment-photos-toggle${collapseButtonClass}" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="${collapseExpanded}" aria-controls="${collapseId}">
                –û–±—â–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
              </button>
              <div class="collapse${collapseShowClass}" id="${collapseId}">
                <form class="row g-2 align-items-end equipment-photo-form mt-3" data-id="${item.id}">
                  <div class="col-md-6">
                    <label class="form-label">–ü–æ–¥–ø–∏—Å—å</label>
                    <input type="text" class="form-control form-control-sm" name="caption" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">–§–∞–π–ª</label>
                    <input type="file" class="form-control form-control-sm" name="file" accept="image/*" required />
                  </div>
                  <div class="col-md-2">
                    <button class="btn btn-outline-primary btn-sm w-100" type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
                  </div>
                </form>
                <div class="row g-3 equipment-photos" data-id="${item.id}"></div>
                <div class="text-muted small" data-empty-photos="${item.id}">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</div>
            </div>
          `}
            </div>
          </div>
        `;
        equipmentContainer.appendChild(card);
        initializeAutoExpandTextareas(card);
        initializeEquipmentCard(card);
        if (!isNew) {
          renderEquipmentPhotos(item.id, item.photos || []);
        }
      });
      updateNetworkEquipmentSummary(list);
    }

    function renderEquipmentPhotos(equipmentId, photos) {
      const container = equipmentContainer.querySelector(`.equipment-photos[data-id="${equipmentId}"]`);
      const emptyText = equipmentContainer.querySelector(`[data-empty-photos="${equipmentId}"]`);
      if (!container) return;
      container.innerHTML = '';
      const list = Array.isArray(photos) ? photos : [];
      if (!list.length) {
        if (emptyText) {
          emptyText.classList.remove('d-none');
        }
        return;
      }
      if (emptyText) {
        emptyText.classList.add('d-none');
      }
      list.forEach((photo) => {
        const col = document.createElement('div');
        col.className = 'col-md-4';
        const captionRaw = photo.caption || '';
        const captionData = encodeURIComponent(captionRaw);
        col.innerHTML = `
          <div class="card equipment-photo h-100" data-id="${photo.id}" data-equipment="${equipmentId}">
            <img src="${escapeHtml(photo.url)}" class="card-img-top passport-photo" alt="–§–æ—Ç–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è" data-photo-url="${escapeHtml(photo.url)}" data-photo-caption="${captionData}" />
            <div class="card-body">
              <div class="mb-2">
                <label class="form-label">–ü–æ–¥–ø–∏—Å—å</label>
                <input type="text" class="form-control form-control-sm equipment-photo-caption" value="${escapeHtml(photo.caption || '')}" />
              </div>
              <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-sm btn-success" data-action="save-equipment-photo">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn btn-sm btn-outline-danger" data-action="delete-equipment-photo">–£–¥–∞–ª–∏—Ç—å</button>
                <a class="btn btn-sm btn-outline-secondary" href="${escapeHtml(photo.url)}" download>–°–∫–∞—á–∞—Ç—å</a>
              </div>
            </div>
          </div>
        `;
        container.appendChild(col);
      });
    }

    equipmentContainer.addEventListener('click', async (event) => {
      const previewTarget = event.target.closest('.passport-photo');
      if (previewTarget) {
        showPhotoPreview(previewTarget.dataset.photoUrl, previewTarget.dataset.photoCaption || '');
        return;
      }
      const card = event.target.closest('.equipment-card');
      const photosToggle = event.target.closest('.equipment-photos-toggle');
      if (photosToggle) {
        event.preventDefault();
        event.stopPropagation();
        const targetSelector = photosToggle.getAttribute('data-bs-target');
        const collapseElement = targetSelector
          ? (card ? card.querySelector(targetSelector) : document.querySelector(targetSelector))
          : null;
        if (collapseElement) {
          const isShown = collapseElement.classList.contains('show');
          if (typeof bootstrap !== 'undefined' && bootstrap.Collapse) {
            const collapseInstance = bootstrap.Collapse.getOrCreateInstance(collapseElement, {
              toggle: false,
            });
            if (isShown) {
              collapseInstance.hide();
            } else {
              collapseInstance.show();
            }
          } else {
            collapseElement.classList.toggle('show');
          }
          photosToggle.classList.toggle('collapsed', isShown);
          photosToggle.setAttribute('aria-expanded', (!isShown).toString());
        }
        return;
      }
      if (!card) return;
      const button = event.target.closest('button[data-action]');
      if (!button) return;
      const action = button.dataset.action;
      if (action === 'save-equipment') {
        handleEquipmentSave(card);
      } else if (action === 'delete-equipment') {
        handleEquipmentDelete(card);
      } else if (action === 'cancel-equipment') {
        handleEquipmentCancel(card);
      } else if (action === 'save-equipment-photo') {
        handleEquipmentPhotoSave(button.closest('.equipment-photo'));
      } else if (action === 'delete-equipment-photo') {
        handleEquipmentPhotoDelete(button.closest('.equipment-photo'));
      }
    });

    equipmentContainer.addEventListener('submit', async (event) => {
      if (!event.target.classList.contains('equipment-photo-form')) return;
      event.preventDefault();
      if (passportData.is_new) {
        showSaveMessage('error', '–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç.');
        return;
      }
      const equipmentId = event.target.dataset.id;
      const formData = new FormData(event.target);
      try {
        const response = await fetch(`/api/object_passports/equipment/${equipmentId}/photos`, {
          method: 'POST',
          body: formData,
        });
        const data = await response.json();
        if (!response.ok || data.success === false) {
          throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è');
        }
        passportData.equipment = data.equipment || passportData.equipment;
        renderEquipment(passportData.equipment);
        showSaveMessage('success', '–§–æ—Ç–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–æ.');
      } catch (error) {
        console.error(error);
        showSaveMessage('error', error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.');
      }
    });
    function handleEquipmentCancel(card) {
      const id = card.dataset.id;
      passportData.equipment = passportData.equipment.filter((item, index) => `new-${index}` !== id);
      renderEquipment(passportData.equipment);
    }

    async function handleEquipmentSave(card) {
      const id = card.dataset.id;
      const payload = {
        equipment_type: card.querySelector('.equipment-type').value.trim(),
        vendor: card.querySelector('.equipment-vendor').value.trim(),
        name: card.querySelector('.equipment-name').value.trim(),
        model: card.querySelector('.equipment-model').value.trim(),
        serial_number: card.querySelector('.equipment-serial').value.trim(),
        status: card.querySelector('.equipment-status').value.trim(),
        ip_address: card.querySelector('.equipment-ip').value.trim(),
        connection_type: card.querySelector('.equipment-connection-type').value.trim(),
        connection_id: card.querySelector('.equipment-connection-id').value.trim(),
        connection_password: card.querySelector('.equipment-connection-password').value.trim(),
        description: card.querySelector('.equipment-description').value.trim(),
      };
      if (passportData.is_new) {
        showSaveMessage('error', '–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç.');
        return;
      }
      try {
        let response;
        if (id && id.startsWith('new-')) {
          response = await fetch(`/api/object_passports/${passportData.id}/equipment`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
        } else {
          response = await fetch(`/api/object_passports/equipment/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
        }
        const data = await response.json();
        if (!response.ok || data.success === false) {
          throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ');
        }
        passportData.equipment = data.equipment || passportData.equipment;
        renderEquipment(passportData.equipment);
        showSaveMessage('success', '–î–∞–Ω–Ω—ã–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.');
      } catch (error) {
        console.error(error);
        showSaveMessage('error', error.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.');
      }
    }

    async function handleEquipmentDelete(card) {
      const id = card.dataset.id;
      if (id && id.startsWith('new-')) {
        handleEquipmentCancel(card);
        return;
      }
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ?')) return;
      try {
        const response = await fetch(`/api/object_passports/equipment/${id}`, { method: 'DELETE' });
        const data = await response.json();
        if (!response.ok || data.success === false) {
          throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ');
        }
        passportData.equipment = data.equipment || passportData.equipment.filter((item) => item.id !== id);
        renderEquipment(passportData.equipment);
        showSaveMessage('success', '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ.');
      } catch (error) {
        console.error(error);
        showSaveMessage('error', error.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.');
      }
    }

    async function handleEquipmentPhotoSave(card) {
      if (!card) return;
      const photoId = card.dataset.id;
      const caption = card.querySelector('.equipment-photo-caption').value;
      try {
        const response = await fetch(`/api/object_passports/equipment/photos/${photoId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ caption }),
        });
        const data = await response.json();
        if (!response.ok || data.success === false) {
          throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è');
        }
        passportData.equipment = data.equipment || passportData.equipment;
        renderEquipment(passportData.equipment);
        showSaveMessage('success', '–§–æ—Ç–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ.');
      } catch (error) {
        console.error(error);
        showSaveMessage('error', error.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.');
      }
    }

    async function handleEquipmentPhotoDelete(card) {
      if (!card) return;
      if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è?')) return;
      const photoId = card.dataset.id;
      try {
        const response = await fetch(`/api/object_passports/equipment/photos/${photoId}`, { method: 'DELETE' });
        const data = await response.json();
        if (!response.ok || data.success === false) {
          throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è');
        }
        passportData.equipment = data.equipment || passportData.equipment;
        renderEquipment(passportData.equipment);
        showSaveMessage('success', '–§–æ—Ç–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —É–¥–∞–ª–µ–Ω–æ.');
      } catch (error) {
        console.error(error);
        showSaveMessage('error', error.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.');
      }
    }

    async function ensurePassportDataLoaded() {
      if (!initialPassportParseFailed || passportData.is_new || !passportData.id) {
        populateForm();
        return;
      }

      try {
        const response = await fetch(`/api/object_passports/${passportData.id}`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();
        if (data && data.passport) {
          passportData = data.passport;
          passportData.is_new = false;
        }
      } catch (error) {
        console.error('Failed to fetch passport data:', error);
        showSaveMessage('error', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞—Å–ø–æ—Ä—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
      }

      populateForm();
    }

    document.querySelectorAll('[data-action="add-parameter"]').forEach((button) => {
      button.addEventListener('click', () => addParameter(button.dataset.paramType, button.dataset.target));
    });

    document.querySelectorAll('#scheduleTable .schedule-24').forEach((checkbox) => {
      checkbox.addEventListener('change', () => {
        toggleScheduleInputs(checkbox.closest('tr'), checkbox.checked);
      });
    });

    initializeSearchableSelects();

    if (statusHistoryCollapse) {
      statusHistoryCollapse.addEventListener('shown.bs.collapse', () => updateStatusHistoryToggleLabel(true));
      statusHistoryCollapse.addEventListener('hidden.bs.collapse', () => updateStatusHistoryToggleLabel(false));
    }
    updateStatusHistoryToggleLabel(false);

    function handleTitlePhotoClick() {
      if (!titlePhotoPreview || !titlePhotoImage) return;
      const photoId = titlePhotoPreview.dataset.photoId || titlePhotoImage.dataset.photoId;
      if (photoId) {
        openPhotoPreviewById(photoId);
      } else if (titlePhotoImage.src) {
        openSinglePhotoPreview(titlePhotoImage.src, '');
      }
    }

    if (titlePhotoPreview) {
      titlePhotoPreview.addEventListener('click', handleTitlePhotoClick);
    }
    if (titlePhotoImage) {
      titlePhotoImage.addEventListener('click', handleTitlePhotoClick);
    }

    statusSelect.addEventListener('change', () => {
      updateStatusBadge();
      updateStatusTaskRequirement();
    });
    internalNetworkInput.addEventListener('input', updateNetworkBadge);
    internalNetworkInput.addEventListener('change', updateNetworkBadge);
    networkProviderInput.addEventListener('change', () => handleNetworkProfileSelection('provider', networkProviderInput.value));
    networkContractInput.addEventListener('change', () => handleNetworkProfileSelection('contract_number', networkContractInput.value));
    networkSupportPhoneInput.addEventListener('change', () => handleNetworkProfileSelection('support_phone', networkSupportPhoneInput.value));
    networkSpeedInput.addEventListener('change', handleSpeedFormatting);
    networkSpeedInput.addEventListener('blur', handleSpeedFormatting);
    networkLegalEntityInput.addEventListener('change', () => handleNetworkProfileSelection('legal_entity', networkLegalEntityInput.value));
    [businessSelect, departmentSelect].forEach((select) => {
      select.addEventListener('change', updateObjectTitle);
    });
    cityInput.addEventListener('input', updateObjectTitle);
    if (toggleItBlockBtn && itBlock) {
      toggleItBlockBtn.addEventListener('click', () => {
        const hiddenNow = itBlock.classList.toggle('d-none');
        itBlock.dataset.userCollapsed = hiddenNow ? 'true' : 'false';
        syncItBlockToggleButton();
      });
      syncItBlockToggleButton();
    }
    refreshCasesBtn.addEventListener('click', refreshCases);
    if (refreshTasksBtn) {
      refreshTasksBtn.addEventListener('click', refreshTasks);
    }
    if (statusTaskSelect) {
      statusTaskSelect.addEventListener('change', () => {
        const rawValue = statusTaskSelect.value;
        const numericValue = rawValue ? Number(rawValue) : null;
        passportData.status_task_id = Number.isNaN(numericValue) ? null : numericValue;
        if (rawValue) {
          const selectedTask = (passportData.tasks || []).find((task) => String(task.id) === rawValue);
          passportData.status_task = selectedTask || passportData.status_task;
        } else {
          passportData.status_task = null;
        }
        syncSelectSearchInput(statusTaskSelect);
        updateStatusTaskInfo();
      });
    }
    if (statusTaskSearchInput && statusTaskSelect) {
      statusTaskSearchInput.addEventListener('input', () => filterSelectOptions(statusTaskSelect, statusTaskSearchInput.value));
      statusTaskSearchInput.addEventListener('focus', () => filterSelectOptions(statusTaskSelect, statusTaskSearchInput.value));
    }
    savePassportBtn.addEventListener('click', savePassport);

    document.querySelectorAll('[data-section-toggle]').forEach((button) => {
      const targetSelector = button.dataset.target;
      const target = targetSelector ? document.querySelector(targetSelector) : null;
      if (!target) return;
      const updateState = () => {
        const expanded = target.classList.contains('show');
        button.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        button.textContent = expanded ? '–°–≤–µ—Ä–Ω—É—Ç—å ‚ñ≤' : '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å ‚ñº';
      };
      updateState();
      button.addEventListener('click', () => {
        target.classList.toggle('show');
        updateState();
      });
    });

    document.querySelectorAll('[data-section-header]').forEach((header) => {
      header.addEventListener('click', (event) => {
        const interactiveTarget = event.target.closest(
          'button, a, input, select, textarea, [data-bs-toggle], [data-no-header-toggle]'
        );
        if (interactiveTarget) {
          return;
        }
        const toggleButton = header.querySelector('[data-section-toggle]');
        if (toggleButton) {
          toggleButton.click();
        }
      });
    });

    addEquipmentBtn.addEventListener('click', () => {
      if (passportData.is_new) {
        showSaveMessage('error', '–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç.');
        return;
      }
      passportData.equipment = Array.isArray(passportData.equipment) ? passportData.equipment : [];
      passportData.equipment.push({
        id: null,
        equipment_type: '',
        vendor: '',
        name: '',
        model: '',
        serial_number: '',
        status: '',
        ip_address: '',
        connection_type: '',
        connection_id: '',
        connection_password: '',
        description: '',
        photos: [],
      });
      renderEquipment(passportData.equipment);
    });

    ensurePassportDataLoaded();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{{ url_for('static', filename='sidebar.js') }}"></script>
  <script src="{{ url_for('static', filename='modal-transitions.js') }}"></script>
</body>
</html>
