<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Каналы и рассылки</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='bender-icon.svg') }}" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet" />
    <link href="{{ url_for('static', filename='sidebar.css', v='2') }}" rel="stylesheet" />
  </head>
  <body class="bg-light">
    {% include '_sidebar.html' %}

    <main class="main-content">
      <div class="container-fluid py-4">
        <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-4">
          <div>
            <h1 class="h3 mb-1">Управление каналами</h1>
            <p class="text-muted mb-0">Настройка токенов, каналов и мониторинг отправок.</p>
          </div>
          <div class="d-flex gap-2 mt-3 mt-md-0">
            <button id="refreshAllBtn" class="btn btn-outline-secondary btn-sm">Обновить данные</button>
          </div>
        </div>

        <section class="mb-5">
          <div class="d-flex align-items-center gap-2 mb-3">
            <h2 class="h5 mb-0">Учётные данные ботов</h2>
            <span class="badge bg-secondary" id="credentialsCount">0</span>
          </div>
          <form id="credentialForm" class="row g-3 align-items-end bg-white border rounded-3 p-3 shadow-sm">
            <div class="col-12 col-md-4">
              <label class="form-label" for="credentialName">Название</label>
              <input id="credentialName" class="form-control" placeholder="Например: Telegram Support" required />
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label" for="credentialPlatform">Платформа</label>
              <select id="credentialPlatform" class="form-select">
                <option value="telegram" selected>Telegram</option>
                <option value="vk">VK</option>
              </select>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label" for="credentialToken">Токен</label>
              <input id="credentialToken" class="form-control" placeholder="Токен из BotFather" required />
            </div>
            <div class="col-6 col-md-1 form-check mt-4">
              <input class="form-check-input" type="checkbox" id="credentialActive" checked />
              <label class="form-check-label" for="credentialActive">Активно</label>
            </div>
            <div class="col-12 text-end">
              <button class="btn btn-primary" type="submit">Сохранить учётные данные</button>
            </div>
          </form>
          <div class="table-responsive bg-white border rounded-3 shadow-sm mt-3">
            <table class="table align-middle mb-0" id="credentialsTable">
              <thead class="table-light">
                <tr>
                  <th scope="col">Название</th>
                  <th scope="col">Платформа</th>
                  <th scope="col">Токен</th>
                  <th scope="col" class="text-center">Активность</th>
                  <th scope="col" class="text-end">Действия</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <section class="mb-5">
          <div class="d-flex align-items-center gap-2 mb-3">
            <h2 class="h5 mb-0">Каналы</h2>
            <span class="badge bg-secondary" id="channelsCount">0</span>
          </div>
          <form id="channelForm" class="row g-3 align-items-end bg-white border rounded-3 p-3 shadow-sm">
            <div class="col-12 col-lg-3">
              <label class="form-label" for="channelName">Название канала</label>
              <input id="channelName" class="form-control" placeholder="Например: Поддержка" required />
            </div>
            <div class="col-12 col-lg-3">
              <label class="form-label" for="channelDescription">Описание</label>
              <input id="channelDescription" class="form-control" placeholder="Отображается в панели" />
            </div>
            <div class="col-6 col-lg-2">
              <label class="form-label" for="channelPlatform">Платформа</label>
              <select id="channelPlatform" class="form-select">
                <option value="telegram" selected>Telegram</option>
                <option value="vk">VK</option>
              </select>
            </div>
            <div class="col-6 col-lg-2">
              <label class="form-label" for="channelCredential">Учётные данные</label>
              <select id="channelCredential" class="form-select" required></select>
            </div>
            <div class="col-6 col-lg-1 form-check mt-4">
              <input class="form-check-input" type="checkbox" id="channelActive" checked />
              <label class="form-check-label" for="channelActive">Активен</label>
            </div>
            <div class="col-6 col-lg-1">
              <label class="form-label" for="channelMaxQuestions">Лимит FAQ</label>
              <input id="channelMaxQuestions" type="number" min="0" class="form-control" value="0" />
            </div>
            <div class="col-12 text-end">
              <button class="btn btn-primary" type="submit">Создать канал</button>
            </div>
          </form>

          <div class="table-responsive bg-white border rounded-3 shadow-sm mt-3">
            <table class="table align-middle mb-0" id="channelsTable">
              <thead class="table-light">
                <tr>
                  <th scope="col">Название</th>
                  <th scope="col">Платформа</th>
                  <th scope="col">Учётные данные</th>
                  <th scope="col">Токен</th>
                  <th scope="col" class="text-center">Статус</th>
                  <th scope="col" class="text-end">Действия</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="bg-white border rounded-3 shadow-sm mt-4 p-3">
            <h3 class="h6">Тестовое сообщение</h3>
            <form id="testMessageForm" class="row g-3 align-items-end">
              <div class="col-12 col-lg-4">
                <label class="form-label" for="testChannel">Канал</label>
                <select id="testChannel" class="form-select" required></select>
              </div>
              <div class="col-12 col-lg-3">
                <label class="form-label" for="testRecipient">Получатель</label>
                <input id="testRecipient" class="form-control" placeholder="chat_id или peer_id" required />
              </div>
              <div class="col-12 col-lg-4">
                <label class="form-label" for="testMessage">Сообщение</label>
                <input id="testMessage" class="form-control" placeholder="Текст тестового сообщения" required />
              </div>
              <div class="col-12 col-lg-1 text-end">
                <button class="btn btn-outline-primary w-100" type="submit">Отправить</button>
              </div>
            </form>
            <div id="testMessageAlert" class="alert mt-3 d-none" role="alert"></div>
          </div>
        </section>

        <section>
          <div class="d-flex align-items-center gap-2 mb-3">
            <h2 class="h5 mb-0">Журнал уведомлений</h2>
            <span class="badge bg-secondary" id="notificationsCount">0</span>
          </div>
          <div class="row g-3 align-items-end mb-3">
            <div class="col-12 col-md-4">
              <label class="form-label" for="filterNotificationChannel">Канал</label>
              <select id="filterNotificationChannel" class="form-select">
                <option value="">Все каналы</option>
              </select>
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label" for="filterNotificationStatus">Статус</label>
              <select id="filterNotificationStatus" class="form-select">
                <option value="">Все</option>
                <option value="pending">Ожидает</option>
                <option value="in_progress">В работе</option>
                <option value="done">Отправлено</option>
                <option value="failed">Ошибка</option>
              </select>
            </div>
            <div class="col-6 col-md-2">
              <label class="form-label" for="filterNotificationLimit">Лимит</label>
              <input id="filterNotificationLimit" type="number" min="1" max="500" value="50" class="form-control" />
            </div>
            <div class="col-12 col-md-3 text-end">
              <button id="reloadNotifications" class="btn btn-outline-secondary">Обновить журнал</button>
            </div>
          </div>

          <div class="table-responsive bg-white border rounded-3 shadow-sm">
            <table class="table align-middle mb-0" id="notificationsTable">
              <thead class="table-light">
                <tr>
                  <th scope="col">ID</th>
                  <th scope="col">Канал</th>
                  <th scope="col">Получатель</th>
                  <th scope="col">Статус</th>
                  <th scope="col">Сообщение</th>
                  <th scope="col">Создано</th>
                  <th scope="col">Результат</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='common.js') }}" defer></script>
    <script src="{{ url_for('static', filename='sidebar.js') }}"></script>
    <script src="{{ url_for('static', filename='channels.js') }}" defer></script>
  </body>
</html>
