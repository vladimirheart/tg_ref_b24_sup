<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ ‚Äî Bender</title>
  <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='bender-icon.svg') }}" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='sidebar.css') }}" rel="stylesheet" />
  <style>
    .analytics-nav .nav-link { font-weight: 600; }
    .analytics-nav .nav-link .tab-icon { margin-right: 0.25rem; }
    .analytics-section { padding-top: 1.5rem; }
    .filter-section { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    .filter-row { margin-bottom: 10px; }
    .filter-badge { margin-right: 5px; margin-bottom: 5px; display: inline-block; }
    .select2-container { width: 100% !important; }
    .stats-card { transition: transform 0.2s; }
    .stats-card:hover { transform: translateY(-2px); }
    .table-container-wrapper { border: 1px solid #dee2e6; border-radius: 0.5rem; overflow: hidden; margin-top: 1rem; }
    .table-container-wrapper .table-header { max-height: 52px; overflow: hidden; }
    .table-container-wrapper .table-body { max-height: 600px; overflow-y: auto; }
    .sortable { cursor: pointer; position: relative; }
    .table-dark th.sortable { background-color: #003366 !important; color: #fff !important; font-weight: bold; transition: background-color 0.2s ease; }
    .table-dark th.sortable:hover { background-color: #cce6ff !important; color: #000 !important; }
    .table-dark th.sortable .sort-arrow { margin-left: 5px; }
    .ticket-stats-card .card-body { padding: 0.75rem 1rem; }
    .ticket-stats-card .card-text { font-size: 0.85rem; }
    .clients-counter { margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 5px; font-weight: bold; }
    .ticket-pagination { margin-top: 1rem; }
    .ticket-pagination select { min-width: 120px; }
    .client-table-container { max-height: calc(100vh - 320px); overflow-y: auto; scrollbar-gutter: stable both-edges; }
    .client-table-container thead th { position: sticky; top: 0; z-index: 2; background: #212529; color: #fff; }
    .client-table-container thead th.sortable { box-shadow: 0 2px 0 rgba(0, 0, 0, 0.05); }
    .client-row:hover { background-color: #f8f9fa; cursor: pointer; }
    .name-block { font-size: 0.95em; }
    .name-block .db-name { color: #007bff; font-weight: 500; }
    .name-block .tg-name { color: #6c757d; }
    .custom-ticket-filter { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
    .custom-ticket-input { width: 100px; }
    .ticket-count-total { font-weight: bold; background-color: #f8f9fa; }
    .spinner-border-sm { width: 1rem; height: 1rem; }
    @media (max-width: 768px) {
      .analytics-nav { flex-wrap: wrap; }
      .analytics-nav .nav-link { width: 100%; text-align: left; }
    }
  </style>
</head>
<body class="with-sidebar sidebar-pinned">
  {% include "_sidebar.html" %}
  <main class="main-content container-fluid">
    <div class="container-fluid mt-4">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
        <h2 class="mb-0">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
      </div>
      <ul class="nav nav-tabs analytics-nav" id="analyticsTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link {% if active_tab != 'clients' %}active{% endif %}" id="tickets-tab" data-bs-toggle="tab" data-bs-target="#ticketsPane" type="button" role="tab" aria-controls="ticketsPane" aria-selected="{% if active_tab == 'clients' %}false{% else %}true{% endif %}">
            <span class="tab-icon">üóÉÔ∏è</span>–ó–∞—è–≤–∫–∏
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link {% if active_tab == 'clients' %}active{% endif %}" id="clients-tab" data-bs-toggle="tab" data-bs-target="#clientsPane" type="button" role="tab" aria-controls="clientsPane" aria-selected="{% if active_tab == 'clients' %}true{% else %}false{% endif %}">
            <span class="tab-icon">üë•</span>–ö–ª–∏–µ–Ω—Ç—ã
          </button>
        </li>
      </ul>
      <div class="tab-content analytics-section">
        <div class="tab-pane fade {% if active_tab != 'clients' %}show active{% endif %}" id="ticketsPane" role="tabpanel" aria-labelledby="tickets-tab">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
            <p class="mb-0 text-muted">–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –±–∏–∑–Ω–µ—Å—É, —Ç–∏–ø—É, –≥–æ—Ä–æ–¥—É, –ª–æ–∫–∞—Ü–∏–∏, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Å—Ç–∞—Ç—É—Å—É.</p>
            <div class="d-flex gap-2">
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#ticketFiltersModal"><i class="bi bi-funnel"></i> –§–∏–ª—å—Ç—Ä—ã</button>
              <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#ticketExportModal"><i class="bi bi-file-earmark-excel"></i> –≠–∫—Å–ø–æ—Ä—Ç</button>
            </div>
          </div>
          <div class="active-filters-container" id="ticketActiveFiltersBadges"></div>
          <div class="row row-cols-1 row-cols-md-4 g-3">
            <div class="col">
              <div class="card stats-card ticket-stats-card" data-ticket-stats="total-records">
                <div class="card-body d-flex justify-content-between align-items-center">
                  <div>
                    <p class="card-text mb-0">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</p>
                  </div>
                  <h5 class="card-title mb-0">{{ ticket_stats | length }}</h5>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card stats-card ticket-stats-card" data-ticket-stats="total-tickets">
                <div class="card-body d-flex justify-content-between align-items-center">
                  <div>
                    <p class="card-text mb-0">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</p>
                  </div>
                  <h5 class="card-title mb-0">{{ ticket_total }}</h5>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card stats-card ticket-stats-card" data-ticket-stats="filtered-records">
                <div class="card-body d-flex justify-content-between align-items-center">
                  <div>
                    <p class="card-text mb-0">–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π</p>
                  </div>
                  <h5 class="card-title mb-0" id="ticketFilteredRecordsCount">{{ ticket_stats | length }}</h5>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card stats-card ticket-stats-card" data-ticket-stats="filtered-tickets">
                <div class="card-body d-flex justify-content-between align-items-center">
                  <div>
                    <p class="card-text mb-0">–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –∑–∞—è–≤–æ–∫</p>
                  </div>
                  <h5 class="card-title mb-0" id="ticketFilteredTicketsCount">{{ ticket_total }}</h5>
                </div>
              </div>
            </div>
          </div>
          <div class="table-container-wrapper">
            <div class="table-header">
              <table class="table table-striped table-hover mb-0" style="width: 100%; table-layout: fixed;">
                <thead class="table-dark">
                  <tr>
                    <th class="sortable" data-ticket-sort="business" style="width: 15%;">–ë–∏–∑–Ω–µ—Å ‚Üï</th>
                    <th class="sortable" data-ticket-sort="location_type" style="width: 15%;">–¢–∏–ø ‚Üï</th>
                    <th class="sortable" data-ticket-sort="city" style="width: 12%;">–ì–æ—Ä–æ–¥ ‚Üï</th>
                    <th class="sortable" data-ticket-sort="location_name" style="width: 25%;">–õ–æ–∫–∞—Ü–∏—è ‚Üï</th>
                    <th class="sortable" data-ticket-sort="category" style="width: 18%;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è ‚Üï</th>
                    <th class="sortable" data-ticket-sort="status" style="width: 15%;">–°—Ç–∞—Ç—É—Å ‚Üï</th>
                    <th class="sortable" data-ticket-sort="cnt" style="width: 10%;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ ‚Üï</th>
                  </tr>
                </thead>
              </table>
            </div>
            <div class="table-body">
              <table class="table table-striped table-hover" id="ticketAnalyticsTable" style="width: 100%; table-layout: fixed;">
                <tbody>
                  {% for s in ticket_stats %}
                  <tr
                    data-ticket-business="{{ s.business or '' }}"
                    data-ticket-location-type="{{ s.location_type or '' }}"
                    data-ticket-city="{{ s.city or '' }}"
                    data-ticket-location="{{ s.location_name or '' }}"
                    data-ticket-category="{{ s.category or '' }}"
                    data-ticket-status="{{ s.status or '' }}"
                    data-ticket-count="{{ s.cnt }}"
                  >
                    <td style="width: 15%;">{{ s.business or '‚Äî' }}</td>
                    <td style="width: 15%;">{{ s.location_type or '‚Äî' }}</td>
                    <td style="width: 12%;">{{ s.city or '‚Äî' }}</td>
                    <td style="width: 25%;">{{ s.location_name or '‚Äî' }}</td>
                    <td style="width: 18%;">{{ s.category or '‚Äî' }}</td>
                    <td style="width: 15%;">{{ s.status or '‚Äî' }}</td>
                    <td style="width: 10%;"><strong>{{ s.cnt }}</strong></td>
                  </tr>
                  {% endfor %}
                  <tr class="ticket-count-total">
                    <td colspan="6" class="text-end" style="width: 70%;"><strong>–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫:</strong></td>
                    <td style="width: 10%;"><strong id="ticketTotalTicketsCount">{{ ticket_total }}</strong></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="d-flex justify-content-between align-items-center ticket-pagination">
            <div class="text-muted">
              –ü–æ–∫–∞–∑–∞–Ω–æ: <span id="ticketVisibleRecordsCount">{{ ticket_stats | length }}</span>
              –∏–∑ <span id="ticketTotalRecordsCount">{{ ticket_stats | length }}</span> –∑–∞–ø–∏—Å–µ–π
            </div>
            <div class="d-flex align-items-center gap-2">
              <label for="ticketPageSizeSelect" class="form-label mb-0">–ó–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:</label>
              <select class="form-select form-select-sm" id="ticketPageSizeSelect">
                <option value="20">20</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="200">200</option>
                <option value="500">500</option>
              </select>
            </div>
          </div>
        </div>
        <div class="tab-pane fade {% if active_tab == 'clients' %}show active{% endif %}" id="clientsPane" role="tabpanel" aria-labelledby="clients-tab">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
            <p class="mb-0 text-muted">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ –æ–±—Ä–∞—â–µ–Ω–∏—è–º.</p>
            <div class="d-flex gap-2">
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#clientFiltersModal"><i class="bi bi-funnel"></i> –§–∏–ª—å—Ç—Ä—ã</button>
              <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#clientExportModal"><i class="bi bi-file-earmark-excel"></i> –≠–∫—Å–ø–æ—Ä—Ç</button>
            </div>
          </div>
          <div class="active-filters-container" id="clientActiveFiltersBadges"></div>
          <div class="client-table-container border rounded">
            <table class="table table-striped table-hover mb-0" id="clientAnalyticsTable">
              <thead class="table-dark">
                <tr>
                  <th class="sortable" data-client-sort="client_name">–ö–ª–∏–µ–Ω—Ç ‚Üï</th>
                  <th class="sortable" data-client-sort="username">Telegram ‚Üï</th>
                  <th class="sortable" data-client-sort="business">–ë–∏–∑–Ω–µ—Å ‚Üï</th>
                  <th class="sortable" data-client-sort="location_type">–¢–∏–ø –ª–æ–∫–∞—Ü–∏–∏ ‚Üï</th>
                  <th class="sortable" data-client-sort="city">–ì–æ—Ä–æ–¥ ‚Üï</th>
                  <th class="sortable" data-client-sort="location_name">–õ–æ–∫–∞—Ü–∏—è ‚Üï</th>
                  <th class="sortable" data-client-sort="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è ‚Üï</th>
                  <th class="sortable" data-client-sort="status">–°—Ç–∞—Ç—É—Å ‚Üï</th>
                  <th class="sortable" data-client-sort="tickets">–ó–∞—è–≤–æ–∫ ‚Üï</th>
                </tr>
              </thead>
              <tbody>
                {% for c in client_stats %}
                <tr class="client-row"
                  data-client-id="{{ c.user_id }}"
                  data-client-name="{{ c.client_name or '' }}"
                  data-client-username="{{ c.username or '' }}"
                  data-client-business="{{ c.business or '' }}"
                  data-client-location-type="{{ c.location_type or '' }}"
                  data-client-city="{{ c.city or '' }}"
                  data-client-location="{{ c.location_name or '' }}"
                  data-client-category="{{ c.category or '' }}"
                  data-client-status="{{ c.status or '' }}"
                  data-client-tickets="{{ c.tickets }}"
                >
                  <td>
                    <div class="name-block">
                      <div class="db-name">{{ c.client_name or '‚Äî' }}</div>
                    </div>
                  </td>
                  <td>{{ c.username or '‚Äî' }}</td>
                  <td>{{ c.business or '‚Äî' }}</td>
                  <td>{{ c.location_type or '‚Äî' }}</td>
                  <td>{{ c.city or '‚Äî' }}</td>
                  <td>{{ c.location_name or '‚Äî' }}</td>
                  <td>{{ c.category or '‚Äî' }}</td>
                  <td>
                    {% if c.status %}
                    <span class="badge bg-secondary">{{ c.status }}</span>
                    {% else %}
                    <span class="badge bg-light text-muted">‚Äî</span>
                    {% endif %}
                  </td>
                  <td><strong>{{ c.tickets }}</strong></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="clients-counter" id="clientRecordsCounter">
            –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: <span id="clientTotalRecordsCount">{{ client_stats | length }}</span>, –ø–æ–∫–∞–∑–∞–Ω–æ <span id="clientVisibleRecordsCount">{{ client_stats | length }}</span>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Ticket Filters Modal -->
  <div class="modal fade" id="ticketFiltersModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">–§–∏–ª—å—Ç—Ä—ã –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∑–∞—è–≤–æ–∫</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
        </div>
        <div class="modal-body">
          <div class="row filter-row">
            <div class="col-md-4 mb-3">
              <label>–ë–∏–∑–Ω–µ—Å</label>
              <select class="form-select ticket-filter-select" id="ticketFilterBusiness" multiple>
                {% for value in ticket_filters.businesses %}
                <option value="{{ value }}">{{ value }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label>–¢–∏–ø –ª–æ–∫–∞—Ü–∏–∏</label>
              <select class="form-select ticket-filter-select" id="ticketFilterLocationType" multiple>
                {% for value in ticket_filters.location_types %}
                <option value="{{ value }}">{{ value }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label>–ì–æ—Ä–æ–¥</label>
              <select class="form-select ticket-filter-select" id="ticketFilterCity" multiple>
                {% for value in ticket_filters.cities %}
                <option value="{{ value }}">{{ value }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label>–õ–æ–∫–∞—Ü–∏—è</label>
              <select class="form-select ticket-filter-select" id="ticketFilterLocation" multiple>
                {% for value in ticket_filters.locations %}
                <option value="{{ value }}">{{ value }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
              <select class="form-select ticket-filter-select" id="ticketFilterCategory" multiple>
                {% for value in ticket_filters.categories %}
                <option value="{{ value }}">{{ value }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label>–°—Ç–∞—Ç—É—Å</label>
              <select class="form-select ticket-filter-select" id="ticketFilterStatus" multiple>
                {% for value in ticket_filters.statuses %}
                <option value="{{ value }}">{{ value }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—è–≤–æ–∫</label>
              <select class="form-select" id="ticketFilterCountSelect">
                <option value="">–í—Å–µ</option>
                <option value="1">1 –∑–∞—è–≤–∫–∞</option>
                <option value="2">2+ –∑–∞—è–≤–∫–∏</option>
                <option value="5">5+ –∑–∞—è–≤–æ–∫</option>
                <option value="10">10+ –∑–∞—è–≤–æ–∫</option>
                <option value="custom">–°–≤–æ—ë –∑–Ω–∞—á–µ–Ω–∏–µ</option>
              </select>
              <div class="custom-ticket-filter" id="ticketCustomCountWrapper" style="display: none;">
                <input type="number" min="1" class="form-control custom-ticket-input" id="ticketCustomCountValue" placeholder="–ß–∏—Å–ª–æ" />
                <select class="form-select" id="ticketCustomCountOperator">
                  <option value=">=">>= (–º–∏–Ω–∏–º—É–º)</option>
                  <option value="==">== (—Ç–æ—á–Ω–æ)</option>
                  <option value="<="><= (–º–∞–∫—Å–∏–º—É–º)</option>
                </select>
              </div>
            </div>
          </div>
          <div class="mt-3" id="ticketActiveFilters" style="display: none;">
            <h6>–ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:</h6>
            <div id="ticketFilterBadges"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="ticketResetFiltersBtn">–°–±—Ä–æ—Å–∏—Ç—å</button>
          <button type="button" class="btn btn-primary" id="ticketApplyFiltersBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="ticketExportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">–§–æ—Ä–º–∞—Ç:</label>
            <select class="form-select" id="ticketExportFormat">
              <option value="xlsx">Excel (.xlsx)</option>
              <option value="csv">CSV</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">–í–∫–ª—é—á–∏—Ç—å:</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="ticketExportAll" checked />
              <label class="form-check-label" for="ticketExportAll">–í—Å–µ –¥–∞–Ω–Ω—ã–µ</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="ticketExportFiltered" />
              <label class="form-check-label" for="ticketExportFiltered">–¢–æ–ª—å–∫–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          <button type="button" class="btn btn-success" id="ticketExportSubmit">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Client Filters Modal -->
  <div class="modal fade" id="clientFiltersModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">–§–∏–ª—å—Ç—Ä—ã –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
        </div>
        <div class="modal-body">
          <div class="row filter-row">
            <div class="col-md-4 mb-3">
              <label>–ë–∏–∑–Ω–µ—Å</label>
              <select class="form-select client-filter-select" id="clientFilterBusiness" multiple>
                {% for value in client_filters.businesses %}
                <option value="{{ value }}">{{ value }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label>–¢–∏–ø –ª–æ–∫–∞—Ü–∏–∏</label>
              <select class="form-select client-filter-select" id="clientFilterLocationType" multiple>
                {% for value in client_filters.location_types %}
                <option value="{{ value }}">{{ value }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label>–ì–æ—Ä–æ–¥</label>
              <select class="form-select client-filter-select" id="clientFilterCity" multiple>
                {% for value in client_filters.cities %}
                <option value="{{ value }}">{{ value }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label>–õ–æ–∫–∞—Ü–∏—è</label>
              <select class="form-select client-filter-select" id="clientFilterLocation" multiple>
                {% for value in client_filters.locations %}
                <option value="{{ value }}">{{ value }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
              <select class="form-select client-filter-select" id="clientFilterCategory" multiple>
                {% for value in client_filters.categories %}
                <option value="{{ value }}">{{ value }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label>–°—Ç–∞—Ç—É—Å</label>
              <select class="form-select client-filter-select" id="clientFilterStatus" multiple>
                {% for value in client_filters.statuses %}
                <option value="{{ value }}">{{ value }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="clientResetFiltersBtn">–°–±—Ä–æ—Å–∏—Ç—å</button>
          <button type="button" class="btn btn-primary" id="clientApplyFiltersBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="clientExportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">–≠–∫—Å–ø–æ—Ä—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">–§–æ—Ä–º–∞—Ç:</label>
            <select class="form-select" id="clientExportFormat">
              <option value="xlsx">Excel (.xlsx)</option>
              <option value="csv">CSV</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">–í–∫–ª—é—á–∏—Ç—å:</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="clientExportAll" checked />
              <label class="form-check-label" for="clientExportAll">–í—Å–µ –¥–∞–Ω–Ω—ã–µ</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="clientExportFiltered" />
              <label class="form-check-label" for="clientExportFiltered">–¢–æ–ª—å–∫–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          <button type="button" class="btn btn-success" id="clientExportSubmit">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/ru.js"></script>
  <script src="{{ url_for('static', filename='common.js') }}"></script>
  <script>
    (function setupTicketAnalytics() {
      const table = document.getElementById('ticketAnalyticsTable');
      if (!table) return;
      const rows = Array.from(table.querySelectorAll('tbody tr')).filter((row) => !row.classList.contains('ticket-count-total'));
      let filteredRows = Array.from(rows);
      let currentPage = 1;
      let pageSize = 20;
      const modalElement = document.getElementById('ticketFiltersModal');
      const exportModal = document.getElementById('ticketExportModal');
      const filterSelects = $('.ticket-filter-select');
      const filterCountSelect = document.getElementById('ticketFilterCountSelect');
      const customCountWrapper = document.getElementById('ticketCustomCountWrapper');
      const customCountValue = document.getElementById('ticketCustomCountValue');
      const customCountOperator = document.getElementById('ticketCustomCountOperator');
      const badgesContainer = document.getElementById('ticketFilterBadges');
      const activeFiltersBlock = document.getElementById('ticketActiveFilters');
      const activeBadgesContainer = document.getElementById('ticketActiveFiltersBadges');
      const visibleRecords = document.getElementById('ticketVisibleRecordsCount');
      const totalRecords = document.getElementById('ticketTotalRecordsCount');
      const totalTicketsCount = document.getElementById('ticketTotalTicketsCount');
      const filteredRecordsCount = document.getElementById('ticketFilteredRecordsCount');
      const filteredTicketsCount = document.getElementById('ticketFilteredTicketsCount');
      const pageSizeSelect = document.getElementById('ticketPageSizeSelect');
      const exportAllCheckbox = document.getElementById('ticketExportAll');
      const exportFilteredCheckbox = document.getElementById('ticketExportFiltered');
      const exportFormatSelect = document.getElementById('ticketExportFormat');

      if (exportAllCheckbox) {
        exportAllCheckbox.addEventListener('change', () => {
          if (exportAllCheckbox.checked && exportFilteredCheckbox) {
            exportFilteredCheckbox.checked = false;
          } else if (!exportAllCheckbox.checked && exportFilteredCheckbox && !exportFilteredCheckbox.checked) {
            exportAllCheckbox.checked = true;
          }
        });
      }
      if (exportFilteredCheckbox) {
        exportFilteredCheckbox.addEventListener('change', () => {
          if (exportFilteredCheckbox.checked && exportAllCheckbox) {
            exportAllCheckbox.checked = false;
          } else if (!exportFilteredCheckbox.checked && exportAllCheckbox) {
            exportAllCheckbox.checked = true;
          }
        });
      }

      const filterState = {
        business: [],
        location_type: [],
        city: [],
        location: [],
        category: [],
        status: [],
        ticket_count: null,
        ticket_operator: '>=',
      };

      function updateStats() {
        if (visibleRecords) visibleRecords.textContent = filteredRows.length;
        if (totalRecords) totalRecords.textContent = rows.length;
        const tickets = filteredRows.reduce((acc, row) => acc + Number(row.dataset.ticketCount || 0), 0);
        if (filteredTicketsCount) filteredTicketsCount.textContent = tickets;
        if (totalTicketsCount) totalTicketsCount.textContent = '{{ ticket_total }}';
      }

      function applyPagination() {
        const totalPages = Math.ceil(filteredRows.length / pageSize) || 1;
        currentPage = Math.min(currentPage, totalPages);
        filteredRows.forEach((row) => (row.style.display = 'none'));
        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        filteredRows.slice(start, end).forEach((row) => (row.style.display = ''));
        updateStats();
      }

      function buildBadge(label, values) {
        if (!values || !values.length) return '';
        return `<span class="badge text-bg-secondary filter-badge">${label}: ${values.join(', ')}</span>`;
      }

      function refreshBadges() {
        const fragments = [];
        fragments.push(buildBadge('–ë–∏–∑–Ω–µ—Å', filterState.business));
        fragments.push(buildBadge('–¢–∏–ø –ª–æ–∫–∞—Ü–∏–∏', filterState.location_type));
        fragments.push(buildBadge('–ì–æ—Ä–æ–¥', filterState.city));
        fragments.push(buildBadge('–õ–æ–∫–∞—Ü–∏—è', filterState.location));
        fragments.push(buildBadge('–ö–∞—Ç–µ–≥–æ—Ä–∏—è', filterState.category));
        fragments.push(buildBadge('–°—Ç–∞—Ç—É—Å', filterState.status));
        if (filterState.ticket_count) {
          fragments.push(`<span class="badge text-bg-primary filter-badge">–ó–∞—è–≤–æ–∫ ${filterState.ticket_operator} ${filterState.ticket_count}</span>`);
        }
        const html = fragments.filter(Boolean).join('');
        if (badgesContainer) badgesContainer.innerHTML = html;
        if (activeBadgesContainer) activeBadgesContainer.innerHTML = html;
        const hasFilters = html.trim().length > 0;
        if (activeFiltersBlock) activeFiltersBlock.style.display = hasFilters ? '' : 'none';
        if (activeBadgesContainer) activeBadgesContainer.style.display = hasFilters ? '' : 'none';
      }

      function normalize(value) {
        return typeof value === 'string' ? value.trim().toLowerCase() : '';
      }

      function passesFilter(row) {
        const checks = [
          { key: 'business', attr: 'ticketBusiness' },
          { key: 'location_type', attr: 'ticketLocationType' },
          { key: 'city', attr: 'ticketCity' },
          { key: 'location', attr: 'ticketLocation' },
          { key: 'category', attr: 'ticketCategory' },
          { key: 'status', attr: 'ticketStatus' },
        ];
        for (const check of checks) {
          const values = filterState[check.key];
          if (values && values.length) {
            const value = normalize(row.dataset[check.attr] || '');
            if (!values.some((item) => normalize(item) === value)) {
              return false;
            }
          }
        }
        if (filterState.ticket_count) {
          const count = Number(row.dataset.ticketCount || 0);
          const threshold = Number(filterState.ticket_count);
          if (filterState.ticket_operator === '>=') {
            if (!(count >= threshold)) return false;
          } else if (filterState.ticket_operator === '<=') {
            if (!(count <= threshold)) return false;
          } else if (filterState.ticket_operator === '==') {
            if (!(count === threshold)) return false;
          }
        }
        return true;
      }

      function applyFilters() {
        filteredRows = rows.filter(passesFilter);
        currentPage = 1;
        applyPagination();
      }

      function resetFilters() {
        Object.keys(filterState).forEach((key) => {
          if (Array.isArray(filterState[key])) {
            filterState[key] = [];
          } else {
            filterState[key] = null;
          }
        });
        filterState.ticket_operator = '>=';
        filterSelects.val(null).trigger('change');
        if (filterCountSelect) filterCountSelect.value = '';
        if (customCountWrapper) customCountWrapper.style.display = 'none';
        if (customCountValue) customCountValue.value = '';
        refreshBadges();
        applyFilters();
      }

      function initSorting() {
        const headers = document.querySelectorAll('[data-ticket-sort]');
        const datasetMap = {
          business: 'ticketBusiness',
          location_type: 'ticketLocationType',
          city: 'ticketCity',
          location_name: 'ticketLocation',
          category: 'ticketCategory',
          status: 'ticketStatus',
          cnt: 'ticketCount',
        };
        let currentSort = { field: null, direction: 'asc' };
        headers.forEach((header) => {
          header.addEventListener('click', () => {
            const field = header.dataset.ticketSort;
            const datasetKey = datasetMap[field];
            if (!field || !datasetKey) return;
            if (currentSort.field === field) {
              currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
              currentSort = { field, direction: 'asc' };
            }
            const sorted = [...filteredRows].sort((a, b) => {
              if (field === 'cnt') {
                const valueA = Number(a.dataset.ticketCount || 0);
                const valueB = Number(b.dataset.ticketCount || 0);
                return currentSort.direction === 'asc' ? valueA - valueB : valueB - valueA;
              }
              const valueA = (a.dataset[datasetKey] || '').toLowerCase();
              const valueB = (b.dataset[datasetKey] || '').toLowerCase();
              if (valueA < valueB) return currentSort.direction === 'asc' ? -1 : 1;
              if (valueA > valueB) return currentSort.direction === 'asc' ? 1 : -1;
              return 0;
            });
            filteredRows = sorted;
            currentPage = 1;
            applyPagination();
          });
        });
      }

      function collectSelectedValues(select) {
        return $(select).val() || [];
      }

      function syncFilterState() {
        filterState.business = collectSelectedValues('#ticketFilterBusiness');
        filterState.location_type = collectSelectedValues('#ticketFilterLocationType');
        filterState.city = collectSelectedValues('#ticketFilterCity');
        filterState.location = collectSelectedValues('#ticketFilterLocation');
        filterState.category = collectSelectedValues('#ticketFilterCategory');
        filterState.status = collectSelectedValues('#ticketFilterStatus');
        const countValue = filterCountSelect ? filterCountSelect.value : '';
        if (countValue === 'custom') {
          const customValue = customCountValue ? Number(customCountValue.value || 0) : 0;
          filterState.ticket_count = customValue > 0 ? customValue : null;
          filterState.ticket_operator = customCountOperator ? customCountOperator.value : '>=';
        } else if (countValue) {
          filterState.ticket_count = Number(countValue);
          filterState.ticket_operator = '>=';
        } else {
          filterState.ticket_count = null;
        }
      }

      function exportData() {
        const exportFiltered = exportFilteredCheckbox && exportFilteredCheckbox.checked;
        const payload = {
          format: exportFormatSelect ? exportFormatSelect.value : 'xlsx',
          filters: filterState,
          exportFiltered,
        };
        fetch('/analytics/export', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data && data.success && data.url) {
              window.open(data.url, '_blank');
            } else {
              alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —ç–∫—Å–ø–æ—Ä—Ç.');
            }
          })
          .catch(() => alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö.'));
      }

      $(filterSelects).select2({ placeholder: '–í—ã–±–µ—Ä–∏—Ç–µ...', allowClear: true, language: 'ru', dropdownParent: $(modalElement) });

      if (filterCountSelect) {
        filterCountSelect.addEventListener('change', () => {
          if (filterCountSelect.value === 'custom') {
            if (customCountWrapper) customCountWrapper.style.display = '';
          } else {
            if (customCountWrapper) customCountWrapper.style.display = 'none';
            if (customCountValue) customCountValue.value = '';
          }
        });
      }

      if (document.getElementById('ticketApplyFiltersBtn')) {
        document.getElementById('ticketApplyFiltersBtn').addEventListener('click', () => {
          syncFilterState();
          refreshBadges();
          applyFilters();
          const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
          modal.hide();
        });
      }

      if (document.getElementById('ticketResetFiltersBtn')) {
        document.getElementById('ticketResetFiltersBtn').addEventListener('click', () => {
          resetFilters();
        });
      }

      if (pageSizeSelect) {
        pageSizeSelect.addEventListener('change', () => {
          pageSize = Number(pageSizeSelect.value || 20);
          currentPage = 1;
          applyPagination();
        });
      }

      if (document.getElementById('ticketExportSubmit')) {
        document.getElementById('ticketExportSubmit').addEventListener('click', () => {
          exportData();
          const modal = bootstrap.Modal.getOrCreateInstance(exportModal);
          modal.hide();
        });
      }

      initSorting();
      refreshBadges();
      applyPagination();
    })();

    (function setupClientAnalytics() {
      const table = document.getElementById('clientAnalyticsTable');
      if (!table) return;
      let rows = Array.from(table.querySelectorAll('tbody tr'));
      let filteredRows = Array.from(rows);
      const filterSelects = $('.client-filter-select');
      const filterModal = document.getElementById('clientFiltersModal');
      const badgesContainer = document.getElementById('clientActiveFiltersBadges');
      const visibleCounter = document.getElementById('clientVisibleRecordsCount');
      const totalCounter = document.getElementById('clientTotalRecordsCount');
      const filterState = {
        business: [],
        location_type: [],
        city: [],
        location: [],
        category: [],
        status: [],
      };

      function normalize(value) {
        return typeof value === 'string' ? value.trim().toLowerCase() : '';
      }

      function passes(row) {
        const checks = [
          { key: 'business', attr: 'clientBusiness' },
          { key: 'location_type', attr: 'clientLocationType' },
          { key: 'city', attr: 'clientCity' },
          { key: 'location', attr: 'clientLocation' },
          { key: 'category', attr: 'clientCategory' },
          { key: 'status', attr: 'clientStatus' },
        ];
        for (const check of checks) {
          const values = filterState[check.key];
          if (values && values.length) {
            const value = normalize(row.dataset[check.attr] || '');
            if (!values.some((item) => normalize(item) === value)) return false;
          }
        }
        return true;
      }

      function updateCounters() {
        if (visibleCounter) visibleCounter.textContent = filteredRows.length;
        if (totalCounter) totalCounter.textContent = rows.length;
      }

      function applyFilters() {
        filteredRows = rows.filter(passes);
        rows.forEach((row) => (row.style.display = 'none'));
        filteredRows.forEach((row) => (row.style.display = ''));
        updateCounters();
      }

      function buildBadge(label, values) {
        if (!values || !values.length) return '';
        return `<span class="badge text-bg-secondary filter-badge">${label}: ${values.join(', ')}</span>`;
      }

      function refreshBadges() {
        const parts = [];
        parts.push(buildBadge('–ë–∏–∑–Ω–µ—Å', filterState.business));
        parts.push(buildBadge('–¢–∏–ø –ª–æ–∫–∞—Ü–∏–∏', filterState.location_type));
        parts.push(buildBadge('–ì–æ—Ä–æ–¥', filterState.city));
        parts.push(buildBadge('–õ–æ–∫–∞—Ü–∏—è', filterState.location));
        parts.push(buildBadge('–ö–∞—Ç–µ–≥–æ—Ä–∏—è', filterState.category));
        parts.push(buildBadge('–°—Ç–∞—Ç—É—Å', filterState.status));
        if (badgesContainer) badgesContainer.innerHTML = parts.filter(Boolean).join('');
      }

      function collect(selector) {
        return $(selector).val() || [];
      }

      function syncState() {
        filterState.business = collect('#clientFilterBusiness');
        filterState.location_type = collect('#clientFilterLocationType');
        filterState.city = collect('#clientFilterCity');
        filterState.location = collect('#clientFilterLocation');
        filterState.category = collect('#clientFilterCategory');
        filterState.status = collect('#clientFilterStatus');
      }

      function resetFilters() {
        Object.keys(filterState).forEach((key) => (filterState[key] = []));
        filterSelects.val(null).trigger('change');
        refreshBadges();
        applyFilters();
      }

      $(filterSelects).select2({ placeholder: '–í—ã–±–µ—Ä–∏—Ç–µ...', allowClear: true, language: 'ru', dropdownParent: $(filterModal) });

      if (document.getElementById('clientApplyFiltersBtn')) {
        document.getElementById('clientApplyFiltersBtn').addEventListener('click', () => {
          syncState();
          refreshBadges();
          applyFilters();
          const modal = bootstrap.Modal.getOrCreateInstance(filterModal);
          modal.hide();
        });
      }

      if (document.getElementById('clientResetFiltersBtn')) {
        document.getElementById('clientResetFiltersBtn').addEventListener('click', () => {
          resetFilters();
        });
      }

      const clientExportAll = document.getElementById('clientExportAll');
      const clientExportFiltered = document.getElementById('clientExportFiltered');
      if (clientExportAll) {
        clientExportAll.addEventListener('change', () => {
          if (clientExportAll.checked && clientExportFiltered) {
            clientExportFiltered.checked = false;
          } else if (!clientExportAll.checked && clientExportFiltered && !clientExportFiltered.checked) {
            clientExportAll.checked = true;
          }
        });
      }
      if (clientExportFiltered) {
        clientExportFiltered.addEventListener('change', () => {
          if (clientExportFiltered.checked && clientExportAll) {
            clientExportAll.checked = false;
          } else if (!clientExportFiltered.checked && clientExportAll) {
            clientExportAll.checked = true;
          }
        });
      }

      if (document.getElementById('clientExportSubmit')) {
        document.getElementById('clientExportSubmit').addEventListener('click', () => {
          const formatSelect = document.getElementById('clientExportFormat');
          const exportFiltered = clientExportFiltered ? clientExportFiltered.checked : false;
          const payload = {
            format: formatSelect ? formatSelect.value : 'xlsx',
            filters: filterState,
            exportFiltered,
          };
          fetch('/analytics/clients/export', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data && data.success && data.url) {
                window.open(data.url, '_blank');
              } else {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —ç–∫—Å–ø–æ—Ä—Ç.');
              }
            })
            .catch(() => alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö.'));
          const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('clientExportModal'));
          modal.hide();
        });
      }

      const headers = document.querySelectorAll('[data-client-sort]');
      const datasetMap = {
        client_name: 'clientName',
        username: 'clientUsername',
        business: 'clientBusiness',
        location_type: 'clientLocationType',
        city: 'clientCity',
        location_name: 'clientLocation',
        category: 'clientCategory',
        status: 'clientStatus',
        tickets: 'clientTickets',
      };
      let currentSort = { field: null, direction: 'asc' };
      headers.forEach((header) => {
        header.addEventListener('click', () => {
          const field = header.dataset.clientSort;
          const datasetKey = datasetMap[field];
          if (!field || !datasetKey) return;
          if (currentSort.field === field) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
          } else {
            currentSort = { field, direction: 'asc' };
          }
          const sorted = [...filteredRows].sort((a, b) => {
            if (field === 'tickets') {
              const valueA = Number(a.dataset.clientTickets || 0);
              const valueB = Number(b.dataset.clientTickets || 0);
              return currentSort.direction === 'asc' ? valueA - valueB : valueB - valueA;
            }
            const valueA = (a.dataset[datasetKey] || '').toLowerCase();
            const valueB = (b.dataset[datasetKey] || '').toLowerCase();
            if (valueA < valueB) return currentSort.direction === 'asc' ? -1 : 1;
            if (valueA > valueB) return currentSort.direction === 'asc' ? 1 : -1;
            return 0;
          });
          filteredRows = sorted;
          filteredRows.forEach((row) => (row.style.display = 'none'));
          filteredRows.forEach((row) => (row.style.display = ''));
          updateCounters();
        });
      });

      refreshBadges();
      applyFilters();
    })();
  </script>
</body>
</html>
