<!-- panel/templates/analytics.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='sidebar.css') }}" rel="stylesheet" />
  <style>
    /* ‚úÖ –¶–≤–µ—Ç–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Ç–∞–±–ª–∏—Ü—ã */
    .table-dark th.sortable {
      background-color: #003366 !important; /* –¢—ë–º–Ω–æ-—Å–∏–Ω–∏–π */
      color: #fff !important; /* –ë–µ–ª—ã–π —Ç–µ–∫—Å—Ç */
      font-weight: bold;
      cursor: pointer;
      position: relative;
      transition: background-color 0.2s ease;
    }
    .table-dark th.sortable:hover {
      background-color: #cce6ff !important; /* –°–≤–µ—Ç–ª–æ-–≥–æ–ª—É–±–æ–π –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
      color: #000 !important; /* –ß—ë—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç */
    }
    .sort-arrow {
      margin-left: 5px;
      color: #fff; /* –ë–µ–ª–∞—è —Å—Ç—Ä–µ–ª–∫–∞ */
    }
    .table-dark th.sortable:hover .sort-arrow {
      color: #000; /* –ß—ë—Ä–Ω–∞—è —Å—Ç—Ä–µ–ª–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
    }
    /* ‚úÖ –§–∏–ª—å—Ç—Ä—ã */
    .filter-section {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .filter-row {
      margin-bottom: 10px;
    }
    .table-container {
      max-height: 600px;
      overflow-y: auto;
    }
    .filter-badge {
      margin-right: 5px;
      margin-bottom: 5px;
      display: inline-block;
    }
    .select2-container {
      width: 100% !important;
    }
    .stats-card {
      transition: transform 0.2s;
    }
    .stats-card:hover {
      transform: translateY(-2px);
    }
    .active-filters-container {
      margin-bottom: 15px;
    }
    .export-btn {
      margin-left: 10px;
    }
    .spinner-border-sm {
      width: 1rem;
      height: 1rem;
    }
	
	/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ */
	.stats-card-compact .card-body {
		padding: 0.5rem 1rem; /* –£–º–µ–Ω—å—à–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
		font-size: 0.85rem; /* –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
	}
	.stats-card-compact .card-text {
		margin-bottom: 0.1rem !important;
		font-size: 0.8rem;
	}
	.stats-card-compact .card-title {
		margin-bottom: 0 !important;
		font-size: 1.1rem;
	}
  </style>
</head>
<body class="with-sidebar sidebar-pinned">
  {% include "_sidebar.html" %}
  <main class="main-content container-fluid">
  <div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center">
      <h2>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –∑–∞—è–≤–∫–∞–º</h2>
      <div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#filtersModal">
          <i class="bi bi-funnel"></i> –§–∏–ª—å—Ç—Ä—ã
        </button>
        <button class="btn btn-success export-btn" data-bs-toggle="modal" data-bs-target="#exportModal">
          <i class="bi bi-file-earmark-excel"></i> –≠–∫—Å–ø–æ—Ä—Ç
        </button>
      </div>
    </div>
    <p>–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –±–∏–∑–Ω–µ—Å—É, —Ç–∏–ø—É, –≥–æ—Ä–æ–¥—É, –ª–æ–∫–∞—Ü–∏–∏, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Å—Ç–∞—Ç—É—Å—É.</p>
    <!-- –ö–Ω–æ–ø–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
    <div class="active-filters-container" id="activeFiltersBadges"></div>
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="row mb-4">
  <div class="col-md-3 mb-3"> <!-- –î–æ–±–∞–≤–∏–ª mb-3 –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
    <div class="card stats-card stats-card-compact" data-stats-card="total-records">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <p class="card-text mb-0">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</p>
        </div>
        <h5 class="card-title mb-0">{{ stats | length }}</h5>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card stats-card stats-card-compact" data-stats-card="total-tickets">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <p class="card-text mb-0">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</p>
        </div>
        <h5 class="card-title mb-0">{{ total_tickets }}</h5>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card stats-card stats-card-compact" data-stats-card="filtered-records">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <p class="card-text mb-0">–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π</p>
        </div>
        <h5 class="card-title mb-0" id="filteredRecordsCount">{{ stats | length }}</h5>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card stats-card stats-card-compact" data-stats-card="filtered-tickets">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <p class="card-text mb-0">–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –∑–∞—è–≤–æ–∫</p>
        </div>
        <h5 class="card-title mb-0" id="filteredTicketsCount">{{ total_tickets }}</h5>
      </div>
    </div>
  </div>
</div>
    <!-- –¢–∞–±–ª–∏—Ü–∞ -->
      <!-- –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ -->
 <div class="table-container-wrapper">
  <div class="table-header">
    <table class="table table-striped table-hover mb-0" style="width: 100%; table-layout: fixed;">
      <thead class="table-dark">
        <tr>
          <!-- –ó–∞–¥–∞–µ–º —è–≤–Ω–æ —à–∏—Ä–∏–Ω—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ -->
          <th class="sortable" data-sort="business" style="width: 15%;">–ë–∏–∑–Ω–µ—Å ‚Üï</th>
          <th class="sortable" data-sort="location_type" style="width: 15%;">–¢–∏–ø ‚Üï</th>
          <th class="sortable" data-sort="city" style="width: 12%;">–ì–æ—Ä–æ–¥ ‚Üï</th>
          <th class="sortable" data-sort="location_name" style="width: 25%;">–õ–æ–∫–∞—Ü–∏—è ‚Üï</th>
          <th class="sortable" data-sort="category" style="width: 18%;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è ‚Üï</th>
          <th class="sortable" data-sort="status" style="width: 15%;">–°—Ç–∞—Ç—É—Å ‚Üï</th>
          <th class="sortable" data-sort="cnt" style="width: 10%;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ ‚Üï</th>
        </tr>
      </thead>
    </table>
  </div>
  <div class="table-body">
    <table class="table table-striped table-hover" id="analyticsTable" style="width: 100%; table-layout: fixed;">
      <tbody>
        {% for s in stats %}
        <tr data-business="{{ s.business or '' }}" 
            data-location-type="{{ s.location_type or '' }}" 
            data-city="{{ s.city or '' }}" 
            data-location="{{ s.location_name or '' }}" 
            data-category="{{ s.category or '' }}" 
            data-status="{{ s.status or '' }}"
            data-cnt="{{ s.cnt }}">
          <td style="width: 15%;">{{ s.business or '‚Äî' }}</td>
          <td style="width: 15%;">{{ s.location_type or '‚Äî' }}</td>
          <td style="width: 12%;">{{ s.city or '‚Äî' }}</td>
          <td style="width: 25%;">{{ s.location_name or '‚Äî' }}</td>
          <td style="width: 18%;">{{ s.category or '‚Äî' }}</td>
          <td style="width: 15%;">{{ s.status or '‚Äî' }}</td>
          <td style="width: 10%;"><strong>{{ s.cnt }}</strong></td>
        </tr>
        {% endfor %}
        <!-- –°—Ç—Ä–æ–∫–∞ —Å –∏—Ç–æ–≥–æ–≤—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∑–∞—è–≤–æ–∫ -->
        <tr class="ticket-count-total">
          <td colspan="6" class="text-end" style="width: 70%;"><strong>–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫:</strong></td>
          <td style="width: 10%;"><strong id="totalTicketsCount">{{ total_tickets }}</strong></td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –∏ —Å—á–µ—Ç—á–∏–∫ -->
    <div class="d-flex justify-content-between align-items-center mt-3">
      <div class="clients-counter" id="recordsCounter">
        –ü–æ–∫–∞–∑–∞–Ω–æ: <span id="visibleRecordsCount">{{ stats | length }}</span> –∏–∑ <span id="totalRecordsCount">{{ stats | length }}</span> –∑–∞–ø–∏—Å–µ–π
      </div>
      <div class="pagination-controls">
        <label>–ó–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:</label>
        <select class="form-select form-select-sm d-inline-block w-auto" id="pageSizeSelect">
          <option value="20">20</option>
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="200">200</option>
          <option value="500">500</option>
        </select>
      </div>
    </div>
  </div>
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: —Ñ–∏–ª—å—Ç—Ä—ã -->
  <div class="modal fade" id="filtersModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">–§–∏–ª—å—Ç—Ä—ã –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row filter-row">
            <div class="col-md-4 mb-3">
              <label>–ë–∏–∑–Ω–µ—Å</label>
              <select class="form-select filter-select" id="filterBusiness" multiple>
                {% for business in businesses %}
                <option value="{{ business }}">{{ business }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label>–¢–∏–ø –ª–æ–∫–∞—Ü–∏–∏</label>
              <select class="form-select filter-select" id="filterLocationType" multiple>
                {% for type in location_types %}
                <option value="{{ type }}">{{ type }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label>–ì–æ—Ä–æ–¥</label>
              <select class="form-select filter-select" id="filterCity" multiple>
                {% for city in cities %}
                <option value="{{ city }}">{{ city }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label>–õ–æ–∫–∞—Ü–∏—è</label>
              <select class="form-select filter-select" id="filterLocation" multiple>
                {% for location in locations %}
                <option value="{{ location }}">{{ location }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
              <select class="form-select filter-select" id="filterCategory" multiple>
                {% for category in categories %}
                <option value="{{ category }}">{{ category }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label>–°—Ç–∞—Ç—É—Å</label>
              <select class="form-select filter-select" id="filterStatus" multiple>
                {% for status in statuses %}
                <option value="{{ status }}">{{ status }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—è–≤–æ–∫</label>
              <select class="form-select" id="filterTicketCount">
                <option value="">–í—Å–µ</option>
                <option value="1">1 –∑–∞—è–≤–∫–∞</option>
                <option value="2">2+ –∑–∞—è–≤–∫–∏</option>
                <option value="5">5+ –∑–∞—è–≤–æ–∫</option>
                <option value="10">10+ –∑–∞—è–≤–æ–∫</option>
                <option value="custom">–°–≤–æ—ë –∑–Ω–∞—á–µ–Ω–∏–µ</option>
              </select>
              <!-- –ü–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ —Å–≤–æ–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è -->
              <div class="custom-ticket-filter" id="customTicketFilter" style="display: none;">
                <input type="number" min="1" class="form-control custom-ticket-input" id="customTicketValue" placeholder="–ß–∏—Å–ª–æ">
                <select class="form-select" id="customTicketOperator">
                  <option value=">=">>= (–º–∏–Ω–∏–º—É–º)</option>
                  <option value="==">== (—Ç–æ—á–Ω–æ)</option>
                  <option value="<="><= (–º–∞–∫—Å–∏–º—É–º)</option>
                </select>
              </div>
            </div>
          </div>
          <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
          <div class="mt-3" id="activeFilters" style="display: none;">
            <h6>–ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:</h6>
            <div id="filterBadges"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="resetFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
          <button type="button" class="btn btn-primary" onclick="applyFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: —ç–∫—Å–ø–æ—Ä—Ç -->
  <div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">–§–æ—Ä–º–∞—Ç:</label>
            <select class="form-select" id="exportFormat">
              <option value="xlsx">Excel (.xlsx)</option>
              <option value="csv">CSV</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">–í–∫–ª—é—á–∏—Ç—å:</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="exportAllData" checked>
              <label class="form-check-label" for="exportAllData">–í—Å–µ –¥–∞–Ω–Ω—ã–µ</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="exportFilteredData">
              <label class="form-check-label" for="exportFilteredData">–¢–æ–ª—å–∫–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          <button type="button" class="btn btn-success" onclick="exportData()">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </div>
    </div>
  </div>
  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/ru.js"></script>
  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞—à–µ–≥–æ –æ–±—â–µ–≥–æ JS —Ñ–∞–π–ª–∞ -->
  <script src="{{ url_for('static', filename='common.js') }}"></script>
  <script>
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
    let customFilter = {
      value: null,
      operator: '>='
    };
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    let currentPage = 1; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ window.analyticsCurrentPage
    let pageSize = 20;
    let filteredRecords = [];
    let originalRecords = [];
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    $(document).ready(function() {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Select2 —Å –ø–æ–º–æ—â—å—é —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ common.js
	  $('.filter-select').select2({
    placeholder: "–í—ã–±–µ—Ä–∏—Ç–µ...",
    allowClear: true,
    language: "ru",
    dropdownParent: $('#filtersModal')
  });
      CommonUtils.initializeSelect2('.filter-select');

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      filteredRecords = Array.from(document.querySelectorAll('#analyticsTable tbody tr:not(.ticket-count-total)'));
      originalRecords = Array.from(filteredRecords);
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
      $('#filterTicketCount').on('change', function() {
        if ($('#filterTicketCount').val() === 'custom') {
          $('#customTicketFilter').show();
        } else {
          $('#customTicketFilter').hide();
          customFilter.value = null;
        }
      });
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
      $('#pageSizeSelect').on('change', function() {
        pageSize = parseInt(this.value);
        applyPagination(); // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ applyPagination –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –Ω–∏–∂–µ
      });
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
      initSorting(); // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ initSorting –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –Ω–∏–∂–µ
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      CommonUtils.updateAnalyticsStatsCards(originalRecords, filteredRecords);
    });

    // --- –§—É–Ω–∫—Ü–∏–∏, –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–∫—Ä–∏–ø—Ç–µ ---
    
    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä
    function applyCustomFilter() {
      const value = parseInt($('#customTicketValue').val());
      const operator = $('#customTicketOperator').val();
      if (isNaN(value) || value < 1) {
        CommonUtils.showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ (–º–∏–Ω–∏–º—É–º 1)', 'warning');
        return false; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º false –ø—Ä–∏ –æ—à–∏–±–∫–µ
      }
      customFilter.value = value;
      customFilter.operator = operator;
      return true; // –£—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω
    }

    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function applyFilters() {
        const filters = {
            business: $('#filterBusiness').val() || [],
            location_type: $('#filterLocationType').val() || [],
            city: $('#filterCity').val() || [],
            location: $('#filterLocation').val() || [],
            category: $('#filterCategory').val() || [],
            status: $('#filterStatus').val() || [],
            ticketCount: $('#filterTicketCount').val()
        };

        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä, –ø—Ä–∏–º–µ–Ω—è–µ–º –µ–≥–æ
        if (filters.ticketCount === 'custom') {
            if (!applyCustomFilter()) {
                return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
        showActiveFilters(filters);

        // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∫ –¥–∞–Ω–Ω—ã–º
        filteredRecords = originalRecords.filter(row => {
            // ... (–ª–æ–≥–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–æ–π –∂–µ) ...
            const business = row.getAttribute('data-business') || '';
            const locationType = row.getAttribute('data-location-type') || '';
            const city = row.getAttribute('data-city') || '';
            const location = row.getAttribute('data-location') || '';
            const category = row.getAttribute('data-category') || '';
            const status = row.getAttribute('data-status') || '';
            const ticketCount = parseInt(row.getAttribute('data-cnt'));

            let show = true;

            if (filters.business.length > 0 && !filters.business.includes(business)) show = false;
            if (filters.location_type.length > 0 && !filters.location_type.includes(locationType)) show = false;
            if (filters.city.length > 0 && !filters.city.includes(city)) show = false;
            if (filters.location.length > 0 && !filters.location.includes(location)) show = false;
            if (filters.category.length > 0 && !filters.category.includes(category)) show = false;
            if (filters.status.length > 0 && !filters.status.includes(status)) show = false;

            if (filters.ticketCount) {
                if (filters.ticketCount === 'custom' && customFilter.value !== null) {
                    if (customFilter.operator === '>=' && ticketCount < customFilter.value) show = false;
                    else if (customFilter.operator === '==' && ticketCount !== customFilter.value) show = false;
                    else if (customFilter.operator === '<=' && ticketCount > customFilter.value) show = false;
                } else {
                    const minCount = parseInt(filters.ticketCount);
                    if (minCount === 1 && ticketCount !== 1) show = false;
                    else if (minCount === 2 && ticketCount < 2) show = false;
                    else if (minCount === 5 && ticketCount < 5) show = false;
                    else if (minCount === 10 && ticketCount < 10) show = false;
                }
            }
            return show;
        });

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º
        currentPage = 1;
        window.analyticsCurrentPage = currentPage; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ window –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ common.js
        applyPagination();
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        CommonUtils.updateAnalyticsStatsCards(originalRecords, filteredRecords);
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modalElement = document.getElementById('filtersModal');
        if (modalElement) {
            bootstrap.Modal.getInstance(modalElement)?.hide();
        }
    }


    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ (–ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–µ–π, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç window.analyticsCurrentPage)
    function applyPagination() {
        const tbody = document.querySelector('#analyticsTable tbody');
        const totalRow = tbody.querySelector('.ticket-count-total');
        Array.from(tbody.querySelectorAll('tr:not(.ticket-count-total)')).forEach(row => row.remove());

        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, filteredRecords.length);

        for (let i = startIndex; i < endIndex; i++) {
            tbody.insertBefore(filteredRecords[i].cloneNode(true), totalRow);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤–∏–¥–∏–º—ã—Ö –∑–∞–ø–∏—Å–µ–π —á–µ—Ä–µ–∑ –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é
        // –õ–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ —Ç–µ–ø–µ—Ä—å –≤–Ω—É—Ç—Ä–∏ updateAnalyticsStatsCards
        // –ù–æ –º–æ–∂–Ω–æ –∏ –æ—Ç–¥–µ–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –∫–æ–Ω—Ç—Ä–æ–ª—è
        // CommonUtils.updateRecordsCounter(endIndex - startIndex, 'totalRecordsCount'); 
        // –õ—É—á—à–µ –æ–±–Ω–æ–≤–ª—è—Ç—å –≤—Å–µ –≤–º–µ—Å—Ç–µ
         CommonUtils.updateAnalyticsStatsCards(originalRecords, filteredRecords);
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã (—á–∞—Å—Ç–∏—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç common.js)
    function showActiveFilters(filters) {
        const badgesContainer = document.getElementById('filterBadges');
        const activeBadgesContainer = document.getElementById('activeFiltersBadges');
        if (!badgesContainer || !activeBadgesContainer) return;

        badgesContainer.innerHTML = '';
        activeBadgesContainer.innerHTML = '';
        let hasActiveFilters = false;

        const multiSelectFilters = [
            { key: 'business', label: '–ë–∏–∑–Ω–µ—Å' },
            { key: 'location_type', label: '–¢–∏–ø –ª–æ–∫–∞—Ü–∏–∏' },
            { key: 'city', label: '–ì–æ—Ä–æ–¥' },
            { key: 'location', label: '–õ–æ–∫–∞—Ü–∏—è' },
            { key: 'category', label: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è' },
            { key: 'status', label: '–°—Ç–∞—Ç—É—Å' }
        ];

        multiSelectFilters.forEach(filter => {
            if (filters[filter.key] && filters[filter.key].length > 0) {
                hasActiveFilters = true;
                filters[filter.key].forEach(value => {
                    if (value) {
                        const badge = CommonUtils.createFilterBadge(filter.label, value, filter.key, value);
                        badgesContainer.appendChild(badge);
                        activeBadgesContainer.appendChild(badge.cloneNode(true));
                    }
                });
            }
        });

        if (filters.ticketCount) {
            hasActiveFilters = true;
            let label;
            if (filters.ticketCount === 'custom' && customFilter.value !== null) {
                const operatorSymbols = { '>=': '‚â•', '==': '=', '<=': '‚â§' };
                label = `${operatorSymbols[customFilter.operator]} ${customFilter.value} –∑–∞—è–≤–æ–∫`;
            } else {
                label = CommonUtils.getTicketCountLabel(filters.ticketCount);
            }
            const badge = CommonUtils.createFilterBadge('–ó–∞—è–≤–æ–∫', label, 'ticketCount');
            badgesContainer.appendChild(badge);
            activeBadgesContainer.appendChild(badge.cloneNode(true));
        }

        document.getElementById('activeFilters').style.display = hasActiveFilters ? 'block' : 'none';
        activeBadgesContainer.style.display = hasActiveFilters ? 'block' : 'none';
    }

    // –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä
    function removeFilter(filterKey, value = null) {
        if (filterKey === 'ticketCount') {
            $('#filterTicketCount').val('').trigger('change'); // –ò—Å–ø–æ–ª—å–∑—É–µ–º trigger –¥–ª—è Select2
            $('#customTicketFilter').hide();
            $('#customTicketValue').val('');
            customFilter.value = null;
        } else if (value) {
            const selectId = `#filter${filterKey.charAt(0).toUpperCase() + filterKey.slice(1)}`;
            const select = $(selectId);
            const currentValues = select.val() || [];
            const newValues = currentValues.filter(v => v !== value);
            select.val(newValues).trigger('change'); // –ò—Å–ø–æ–ª—å–∑—É–µ–º trigger –¥–ª—è Select2
        }
        applyFilters();
    }

    // –°–±—Ä–æ—Å –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function resetFilters() {
        $('.filter-select').val(null).trigger('change'); // –ò—Å–ø–æ–ª—å–∑—É–µ–º trigger –¥–ª—è Select2
        $('#filterTicketCount').val('').trigger('change');
        $('#customTicketFilter').hide();
        $('#customTicketValue').val('');
        customFilter.value = null;

        filteredRecords = Array.from(originalRecords);
        
        currentPage = 1;
        window.analyticsCurrentPage = currentPage;
        applyPagination();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        CommonUtils.updateAnalyticsStatsCards(originalRecords, filteredRecords);

        document.getElementById('filterBadges').innerHTML = '';
        document.getElementById('activeFiltersBadges').innerHTML = '';
        document.getElementById('activeFilters').style.display = 'none';

        const tbody = document.querySelector('#analyticsTable tbody');
        const totalRow = tbody.querySelector('.ticket-count-total');
        Array.from(tbody.querySelectorAll('tr:not(.ticket-count-total)')).forEach(row => row.remove());
        filteredRecords.forEach(row => {
            tbody.insertBefore(row.cloneNode(true), totalRow);
        });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (–ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–µ–π)
    function initSorting() {
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', function() {
                const column = this.getAttribute('data-sort');
                const currentOrder = this.getAttribute('data-order') || 'asc';
                const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';

                document.querySelectorAll('.sortable').forEach(h => {
                    h.innerHTML = h.innerHTML.replace(' ‚Üë', '').replace(' ‚Üì', '').replace(' ‚Üï', ' ‚Üï');
                    h.setAttribute('data-order', '');
                });

                this.setAttribute('data-order', newOrder);
                this.innerHTML = this.innerHTML.replace(' ‚Üï', '') + (newOrder === 'asc' ? ' ‚Üë' : ' ‚Üì');

                sortTable(column, newOrder);
            });
        });
    }

    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã (–ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–µ–π)
    function sortTable(column, order) {
        filteredRecords.sort((a, b) => {
            let aValue, bValue;
            if (column === 'cnt') {
                aValue = parseInt(a.getAttribute('data-cnt'));
                bValue = parseInt(b.getAttribute('data-cnt'));
            } else {
                const colIndex = ['business', 'location_type', 'city', 'location_name', 'category', 'status'].indexOf(column);
                const cellA = a.querySelector(`td:nth-child(${colIndex + 1})`);
                const cellB = b.querySelector(`td:nth-child(${colIndex + 1})`);
                aValue = cellA ? cellA.textContent.toLowerCase() : '';
                bValue = cellB ? cellB.textContent.toLowerCase() : '';
            }
            if (aValue === '‚Äî') aValue = '';
            if (bValue === '‚Äî') bValue = '';
            if (order === 'asc') {
                return aValue > bValue ? 1 : aValue < bValue ? -1 : 0;
            } else {
                return aValue < bValue ? 1 : aValue > bValue ? -1 : 0;
            }
        });
        currentPage = 1;
        window.analyticsCurrentPage = currentPage;
        applyPagination();
    }

    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ (–ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–µ–π)
    function prepareFiltersForExport() {
        const filters = {
            business: $('#filterBusiness').val() || [],
            location_type: $('#filterLocationType').val() || [],
            city: $('#filterCity').val() || [],
            location: $('#filterLocation').val() || [],
            category: $('#filterCategory').val() || [],
            status: $('#filterStatus').val() || [],
            ticketCount: $('#filterTicketCount').val()
        };
        if (filters.ticketCount === 'custom' && customFilter.value !== null) {
            filters.customTicketValue = customFilter.value;
            filters.customTicketOperator = customFilter.operator;
        }
        return filters;
    }

    // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç common.js)
    async function exportData() {
        const format = document.getElementById('exportFormat')?.value || 'xlsx';
        const exportFiltered = document.getElementById('exportFilteredData')?.checked || false;
        
        const filters = exportFiltered ? prepareFiltersForExport() : {};
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏–∑ common.js
        // URL '/analytics/export' –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è –∫–∞–∫ endpoint –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        await CommonUtils.exportDataGeneric('/analytics/export', format, filters, exportFiltered, 'analytics');
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ—Å–ª–µ —ç–∫—Å–ø–æ—Ä—Ç–∞
        const exportModalElement = document.getElementById('exportModal');
        if (exportModalElement) {
            bootstrap.Modal.getInstance(exportModalElement)?.hide();
        }
    }
  </script>
  </main>
  <script src="{{ url_for('static', filename='sidebar.js') }}"></script>
</body>
</html>
