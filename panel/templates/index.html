<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü–∞–Ω–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.22.1/dist/bootstrap-table.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='sidebar.css') }}" rel="stylesheet" />
  <style>
  /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–≤—ã–π ¬´–ø—Ä—ã–∂–æ–∫¬ª –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ —Å—Ç–æ–ª–±—Ü–æ–≤ */
#ticketsTable {
  table-layout: fixed;   /* —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ—Ä–∞—Å—á—ë—Ç —à–∏—Ä–∏–Ω */
  width: 100%;
}
#ticketsTable th, 
#ticketsTable td {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
/* –§–∏–∫—Å —Ä—ã–≤–∫–∞ –≤ –º–æ–º–µ–Ω—Ç —Å—Ç–∞—Ä—Ç–∞ —Ä–µ—Å–∞–π–∑–∞ */
#ticketsTable th, #ticketsTable td { box-sizing: border-box; }
#ticketsTable th { will-change: width; }

/* –æ—Ç–∫–ª—é—á–∏–º –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –Ω–∞ —à–∏—Ä–∏–Ω—É */
#ticketsTable th, #ticketsTable td { transition: none !important; }

/* –§–∏–∫—Å –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, —á—Ç–æ–±—ã –Ω–µ —Ç—è–Ω—É–ª –≤—Å—é —à–∏—Ä–∏–Ω—É —ç–∫—Ä–∞–Ω–∞ –≤–æ –≤—Ä–µ–º—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è */
.table-responsive {
  overflow: auto;
  contain: content;      /* –∏–∑–æ–ª—è—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–æ–∫ */
}

  /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü */
  @media (max-width: 1024px) {
    .container {
      padding-left: 10px;
      padding-right: 10px;
    }

    .navbar-nav {
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: center;
    }

    .navbar-nav .nav-link {
      padding: 0.5rem;
      font-size: 0.9rem;
    }

    .table-responsive {
      font-size: 0.85rem;
    }

    .chat-bubble {
      max-width: 90%;
    }

    .input-group-send {
      flex-direction: column;
    }

    .input-group-send textarea {
      min-height: 80px;
    }
	/* –ú–∞—Ä–∫—ë—Ä –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞ –≤ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ */
	.dropdown-menu .dropdown-item .check {
	  display: inline-block;
	  width: 1.2em;
	}
	.dropdown-menu .dropdown-item.active .check::before {
	  content: "‚úî";
	}

    .modal-dialog {
      margin: 10px;
    }

    .btn-sm {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
  }

  @media (max-width: 576px) {
    h2 {
      font-size: 1.5rem;
    }

    .badge {
      font-size: 0.7rem;
      margin-bottom: 5px;
    }

    .form-select, .form-control {
      font-size: 0.9rem;
    }

    .pagination {
      flex-wrap: wrap;
    }

    .page-link { padding: 0.3rem 0.6rem; font-size: 0.85rem; }
  }

  .category-selector {
    background-color: #f8f9fa;
    border-left: 4px solid #6f42c1;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 4px;
  }

  .chat-bubble {
    padding: 8px 12px;
    border-radius: 8px;
    margin-bottom: 6px;
    max-width: 80%;
    word-wrap: break-word;
    transition: opacity 0.3s ease;
  }
  /* –ò–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è - –¥–µ–ª–∞–µ–º –Ω–µ–º–Ω–æ–≥–æ –∫—Ä—É–ø–Ω–µ–µ */
  .chat-bubble strong {
    font-size: 1.1em;      /* —Ä–∞–∑–º–µ—Ä –¥–ª—è –∏–º–µ–Ω–∏ */
    font-weight: 600;
  }

  /* –°–æ–æ–±—â–µ–Ω–∏–µ - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–∞–∑–º–µ—Ä */
  .chat-bubble p {
    font-size: 1em;        /* —Ä–∞–∑–º–µ—Ä –¥–ª—è —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è */
    margin-bottom: 4px;
    line-height: 1.4;
  }

  /* –í—Ä–µ–º—è - –¥–µ–ª–∞–µ–º –º–µ–ª—å—á–µ */
  .chat-bubble small {
    font-size: 0.85em;     /* —Ä–∞–∑–º–µ—Ä –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ */
    color: #666 !important;
    opacity: 0.8;
  }
  /* ‚Üë –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏ —ç–º–æ–¥–∑–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –∏—Å—Ç–æ—Ä–∏–∏ ~–≤ 1.5 —Ä–∞–∑–∞ */
  .chat-bubble {
	  font-size: 1.5em;      /* –±—ã–ª–æ 1em ‚Üí —Å—Ç–∞–ª–æ ~1.5x */
	  line-height: 1.35;
	}
	.chat-bubble img.emoji {
	  height: 1em;
	  width: 1em;
	  vertical-align: -0.1em;
	}
  @media (max-width: 768px) {
    .chat-bubble strong {
        font-size: 1.1em;
    }
    
    .chat-bubble p {
        font-size: 0.95em;
    }
    
    .chat-bubble small {
        font-size: 0.75em;
    }
  }
  .from-user {
    background: #e3f2fd;
    align-self: flex-start;
	margin-right: auto;
  }

  .from-support {
    background: #d1f7d1;
    align-self: flex-end;
	margin-left: auto;
  }

  .chat-container {
  flex: 1;
  min-height: 0;
  overflow-y: auto;
}

#historyModal .input-group-send {
  flex: 0 0 auto;
  margin-top: 0;
  border-top: 1px solid #dee2e6;
}

/* —Ñ–∏–∫—Å–∏—Ä—É–µ–º —à–∏—Ä–∏–Ω—É –ø–æ–ª–æ—Å—ã ‚Äî –∫–æ–Ω—Ç–µ–Ω—Ç –±–æ–ª—å—à–µ –Ω–µ ¬´—Å–∂–∏–º–∞–µ—Ç—Å—è¬ª –ø—Ä–∏ —Ö–æ–≤–µ—Ä–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
#historyContent::-webkit-scrollbar {
  width: 12px;
}
#historyContent { scrollbar-width: thin; scrollbar-color: rgba(0,0,0,.55) transparent; }

/* –∂–µ–ª–æ–± (—Ç—Ä–µ–∫) */
#historyContent::-webkit-scrollbar-track {
  background: transparent;
}
#historyContent::-webkit-scrollbar-track:hover {
  background: rgba(0,0,0,.04); /* –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ */
}

/* –ø–æ–ª–∑—É–Ω–æ–∫ */
#historyContent::-webkit-scrollbar-thumb {
  background-color: rgba(0,0,0,.40);
  border-radius: 8px;
  border: 2px solid transparent;     /* –≤–∏–∑—É–∞–ª—å–Ω–æ —Ç–æ–Ω—å—à–µ */
  background-clip: content-box;
  transition: background-color .15s ease;
}
#historyContent::-webkit-scrollbar-thumb:hover {
  background-color: rgba(0,0,0,.85);  /* –º–µ–Ω—è–µ–º ¬´–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å¬ª —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–∞–º–æ–º –ø–æ–ª–∑—É–Ω–∫–µ */
}

/* –æ—Å—Ç–∞–≤–ª—è–µ–º, —á—Ç–æ–±—ã —à–∏—Ä–∏–Ω–∞ –ø–æ–¥ –ø–æ–ª–æ—Å—É –±—ã–ª–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –∏ –Ω–µ –¥—ë—Ä–≥–∞–ª–∞—Å—å –≤–µ—Ä—Å—Ç–∫–∞ */
#historyContent { scrollbar-gutter: stable both-edges; }

#historyContent {
  scrollbar-gutter: stable both-edges;
}

/* Firefox: —Ü–≤–µ—Ç –∏ —Ç–æ–ª—â–∏–Ω–∞ (—Ç–æ–Ω–∫–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, ¬´–∞–≤—Ç–æ¬ª –ø—Ä–∏ —Ö–æ–≤–µ—Ä–µ) */
#historyContent { scrollbar-width: thin; scrollbar-color: rgba(0,0,0,.4) transparent; }
#historyContent.hovering { scrollbar-width: auto; scrollbar-color: rgba(0,0,0,.95) transparent; }
  
.history-viewport { position: relative; }
  
.history-scroll-btn {
  position: absolute;
  right: 6px;                /* —Ä—è–¥–æ–º —Å–æ —Å–∫—Ä–æ–ª–ª-–±–∞—Ä–æ–º */
  width: 34px;
  height: 34px;
  border-radius: 50%;
  border: 1px solid rgba(0,0,0,.15);
  background: var(--bs-body-bg);
  box-shadow: 0 2px 6px rgba(0,0,0,.15);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  opacity: .2;               /* ‚âà80% –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ */
  z-index: 3;
  user-select: none;
}

/* –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ */
.history-scroll-btn:hover { opacity: .9; }
.history-scroll-btn.top    { top: 6px; }
.history-scroll-btn.bottom { bottom: 6px; }

  .chat-bubble p, .chat-bubble small, .chat-bubble strong {
    color: #000 !important;
  }

  .input-group-send {
    display: flex;
    align-items: stretch;
    gap: 8px;
  }

  .input-group-send textarea {
    flex: 1;
    resize: vertical;
    min-height: 60px;
    max-height: 200px;
  }

  .input-group-send .btn {
    white-space: nowrap;
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è –±–∏–∑–Ω–µ—Å–æ–≤ */
  .business-sushi {
    background-color: #F25F79 !important;
    color: white !important;
  }

  .business-blin {
    background-color: #FFD504 !important;
    color: black !important;
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è resize —Å—Ç–æ–ª–±—Ü–æ–≤ */
  .table th {
    position: relative;
    user-select: none;
  }

  .resize-handle {
    position: absolute;
    top: 0;
    right: 0;
    width: 5px;
    height: 100%;
    background-color: #ddd;
    cursor: col-resize;
    user-select: none;
  }

  .clickable-client {
    cursor: pointer;
    color: #0d6efd;
    text-decoration: underline;
  }

  .clickable-client:hover {
    color: #0a58ca;
  }

  .column-toggle {
    max-height: 300px;
    overflow-y: auto;
  }

  .problem-info {
    background-color: #f8f9fa;
    border-left: 4px solid #0d6efd;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 4px;
  }

  .resizing {
    cursor: col-resize;
    user-select: none;
  }

  .table-column-hidden {
    display: none;
  }

  /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã */
  .table th, .table td {
    word-break: break-word;
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ –º–µ–Ω—é –∫–∞—Ç–µ–≥–æ—Ä–∏–π */
  .category-selector .dropdown-menu {
    margin-left: 10px !important;
    min-width: 1000px !important;
    padding: 0.5rem;
  }

  .category-selector .form-check {
    margin: 0;
    padding: 0.25rem 1.5rem;
    white-space: nowrap;
  }

  .category-selector .form-check-input {
    margin-right: 0.5rem;
  }

  .category-selector .form-check-label {
    cursor: pointer;
    user-select: none;
    display: inline-block;
    width: calc(100% - 1.5rem);
  }

  .selected-categories {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
    align-items: center;
  }

  .selected-categories .selected-label {
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    margin-right: 0.25rem;
  }

  .category-chip {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.65rem;
    border-radius: 999px;
    font-weight: 600;
    font-size: 0.85rem;
    line-height: 1;
    color: #fff;
    background: var(--chip-color, #0d6efd);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.16);
  }
.min-height-0 {
  min-height: 0 !important;
}
/* === –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏: –≤—ã—Å–æ—Ç–∞ –∏ —Ä–∞—Å–∫–ª–∞–¥–∫–∞ === */
#historyModal .modal-dialog {
  width: 80vw !important;
  height: 90vh !important;
  max-width: 90vw;
  max-height: 90vh;
  margin: 5vh auto;
  display: flex;
}

#historyModal .modal-content {
  height: 100%;
  display: flex !important;
  flex-direction: column;
  flex: 1 1 auto;
  gap: 0;
}

#historyModal .modal-body {
  display: flex;
  flex-direction: column;
  flex: 1 1 auto;
  min-height: 0;
  gap: 0;
}

.resizable-modal .modal-dialog {
  resize: both;
  overflow: auto;
  min-width: 400px;
  min-height: 300px;
}

#historyModal .modal-header{ flex: 0 0 auto; }

/* –¢–µ–ª–æ –º–æ–¥–∞–ª–∫–∏ ‚Äî –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π flex-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –∑–∞–Ω–∏–º–∞—é—Ç 1fr —Å—Ç—Ä–æ–∫–∏ –≥—Ä–∏–¥–∞ */
#historyModal .modal-body {
  padding: 0 !important;
  flex: 1;
  min-height: 0;
}

#historyModal .modal-footer{ flex: 0 0 auto; }

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –¥–≤—É–º—è –∫–æ–ª–æ–Ω–∫–∞–º–∏ */
#historyModal .container-fluid {
  height: 100%;
  min-height: 0;
}

#historyModal .row {
  height: 100%;
  min-height: 0;
  margin: 0 !important;
  --bs-gutter-x: 0;
}

//* –í–Ω—É—Ç—Ä–∏ —Ç–µ–ª–∞ –≤—Å—ë —Ç—è–Ω–µ–º –ø–æ flex-—Ü–µ–ø–æ—á–∫–µ –±–µ–∑ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ */
#historyModal .modal-body > .container-fluid{
  display: flex;
  flex: 1 1 auto;
  min-height: 0;
  padding: 0 !important;
}

#historyModal .modal-body > .container-fluid > .row{
  display: flex;
  flex: 1 1 auto;
  min-height: 0;
  align-items: stretch;
  margin: 0 !important;
  --bs-gutter-x: 0;
  --bs-gutter-y: 0;
}

/* –£–±–∏—Ä–∞–µ–º padding —É –∫–æ–ª–æ–Ω–æ–∫ –≤ –º–æ–¥–∞–ª–∫–µ –∏—Å—Ç–æ—Ä–∏–∏ */
#historyModal .modal-body .col-md-4,
#historyModal .modal-body .col-md-8 {
  padding-left: 0 !important;
  padding-right: 0 !important;
}

/* –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ */
#historyModal .sidebar-pane {
  position: relative;
  display: flex;
  flex-direction: column;
  min-height: 0;
  min-width: 300px;
  max-width: 70%;
  width: 400px; /* –Ω–∞—á–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
  background: #f8f9fa;
  border-right: 1px solid #dee2e6;
  overflow-y: auto;
}

#historyModal .history-avatar-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
}

#historyModal .history-avatar {
  width: 100%;
  max-width: 192px;
  aspect-ratio: 1 / 1;
  object-fit: cover;
  border: 1px solid rgba(0, 0, 0, .1);
  cursor: zoom-in;
  margin-inline: auto;
  transition: transform .2s ease;
}

#historyModal .history-avatar:hover {
  transform: scale(1.03);
}

/* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (–∏—Å—Ç–æ—Ä–∏—è) */
#historyModal .history-pane {
  position: relative;
  z-index: 1;
  display: flex;
  flex-direction: column;
  flex: 1 1 auto;
  min-height: 0;
  height: 100%;
}

/* –£–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–∂–∞—Ç–∏—è –ø—Ä–∞–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏ */
#historyModal .col-md-8 {
  flex: 1 1 0%;
  min-width: 400px;
}

#historyModal .history-pane > .d-flex.flex-column {
  display: flex !important;
  flex: 1 1 auto !important;
  min-height: 0 !important;
  gap: 0;
  height: 100%;
}

/* –°–∞–º–∞ –ª–µ–Ω—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π */
#historyModal .chat-container {
  flex: 1 1 auto;
  min-height: 0;
  overflow-y: auto;
  padding: 16px 16px 0px;
  display: flex;
  flex-direction: column;
   gap: 12px;
  justify-content: flex-start;
  margin-bottom: 0;
  background-color: #f8f9fa !important;
}

/* –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—É–∑—ã—Ä–µ–π –Ω–∞ —Ñ–æ–Ω–µ */
#historyModal .chat-bubble.from-user {
  background: #e3f2fd;
  border: 1px solid #bbdefb;
}

#historyModal .chat-bubble.from-support {
  background: #d1f7d1;
  border: 1px solid #a5d6a7;
}

#historyModal .input-group-send {
  margin-top: 0 !important;
  flex: 0 0 auto;
}

#historyModal .input-group-send {
  margin-top: 0 !important;
}

/* === –ò—Å—Ç–æ—Ä–∏—è: —Ä–∞–∑–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏, –∞–≤—Ç–æ—Ä–∞ –∏ —Ç–µ–∫—Å—Ç–∞ === */
#historyModal .chat-bubble .msg-time {
  /* –º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π ‚Äî –ª—É—á—à–µ —á–∏—Ç–∞—é—Ç—Å—è —Ü–∏—Ñ—Ä—ã –≤—Ä–µ–º–µ–Ω–∏ */
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  font-size: 0.80rem;          /* —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä, –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç .chat-bubble {font-size} */
  line-height: 1.2;
  color: #6c757d !important;
  letter-spacing: .01em;
  display: inline-block;
  margin-bottom: .15rem;
}

#historyModal .chat-bubble .msg-author {
  /* –ø–ª–æ—Ç–Ω—ã–π —Å–∞–Ω—Å-—Å–µ—Ä–∏—Ñ –¥–ª—è –∏–º–µ–Ω–∏ */
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", sans-serif;
  font-weight: 700;
  font-size: 0.95rem;
  line-height: 1.25;
  display: inline-block;
  margin-bottom: .15rem;
}

#historyModal .chat-bubble .msg-text {
  /* –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —á–∏—Ç–∞–±–µ–ª—å–Ω—ã–π —Å–∞–Ω—Å-—Å–µ—Ä–∏—Ñ –¥–ª—è —Ç–µ–ª–∞ —Å–æ–æ–±—â–µ–Ω–∏—è */
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", sans-serif;
  font-size: 1.50rem;
  line-height: 1.45;
  color: #000 !important;
}

/* –ù–∞ –æ—á–µ–Ω—å —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö ‚Äî —á—É—Ç–∫–∞ —É–∂–º—ë–º */
@media (max-width: 768px) {
  #historyModal .chat-bubble .msg-time   { font-size: .75rem; }
  #historyModal .chat-bubble .msg-author { font-size: .90rem; }
  #historyModal .chat-bubble .msg-text   { font-size: .95rem; }
}
/* –°—Ç–µ–∫: –≤—Ä–µ–º—è —Å–≤–µ—Ä—Ö—É, –Ω–∏–∂–µ ‚Äî –∏–º—è —Å –∑–∞–∑–æ—Ä–æ–º 3px */
#historyModal .chat-bubble .msg-time {
  display: block;
  margin: 0;                 /* –±–µ–∑ –ª–∏—à–Ω–∏—Ö –æ—Ç—Å—Ç—É–ø–æ–≤ */
}
#historyModal .chat-bubble .msg-author {
  display: block;
  margin: 3px 0 6px 0;       /* 3px –º–µ–∂–¥—É –≤—Ä–µ–º–µ–Ω–µ–º –∏ –∏–º–µ–Ω–µ–º */
}

/* –û–±—ë—Ä—Ç–∫–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–≤—å—é –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∫–æ–Ω–∫–∏ */
#historyModal .chat-bubble .media-wrap {
  position: relative;
}

/* –ö–Ω–æ–ø–∫–∞-–∏–∫–æ–Ω–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É –ø—Ä–µ–≤—å—é */
#historyModal .chat-bubble .media-download {
  position: absolute;
  top: 6px;
  right: 6px;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: rgba(255,255,255,.9);
  border: 1px solid rgba(13,110,253,.25);
  text-decoration: none;
  font-size: 1rem;
  line-height: 1;
  color: #0d6efd !important;
  box-shadow: 0 2px 6px rgba(0,0,0,.15);
  opacity: .85;
  transition: transform .15s ease, opacity .15s ease;
}
#historyModal .chat-bubble .media-download:hover {
  opacity: 1;
  transform: translateY(-1px);
}

/* –ü–æ–¥–ø–∏—Å—å —Ç–∏–ø–∞ –º–µ–¥–∏–∞: –º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π, –º–µ–ª–∫–∏–π, ¬´—Å–∏—Å—Ç–µ–º–Ω—ã–π¬ª */
#historyModal .chat-bubble .media-type {
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  font-size: .78rem;
  line-height: 1.2;
  letter-spacing: .03em;
  text-transform: uppercase;
  color: #495057;
}

/* –ü–æ–¥–ø–∏—Å—å –∫ –º–µ–¥–∏–∞ (–µ—Å–ª–∏ –±—ã–ª–∞) ‚Äî –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç */
#historyModal .chat-bubble .media-caption {
  font-size: .95rem;
  line-height: 1.35;
}
/* === Twemoji: –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∏ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ === */
#historyModal img.emoji,
#historyModal .msg-text img.emoji,
#historyModal .msg-author img.emoji {
  width: 1.1em !important;
  height: 1.1em !important;
  max-width: none !important;
  max-height: none !important;
  vertical-align: -0.12em;         /* —á—É—Ç—å –æ–ø—É—Å–∫–∞–µ–º, —á—Ç–æ–±—ã —Å–∏–¥–µ–ª–∏ –Ω–∞ –±–∞–∑–æ–≤–æ–π –ª–∏–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ */
  margin: 0 .06em;
  border: 0 !important;
  padding: 0 !important;
  background: transparent !important;
  box-shadow: none !important;
}

/* –ù–∞ –º–µ–ª–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö —á—É—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ */
@media (max-width: 768px) {
  #historyModal img.emoji,
  #historyModal .msg-text img.emoji,
  #historyModal .msg-author img.emoji {
    width: 1.0em !important;
    height: 1.0em !important;
    vertical-align: -0.1em;
  }
}
/* –ø—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ */
.send-actions .btn { white-space: nowrap; }
#replyTextInHistory { padding-bottom: 48px; } /* –º–µ—Å—Ç–æ –ø–æ–¥ ¬´–¥–æ–∫¬ª –≤–Ω—É—Ç—Ä–∏ –ø–æ–ª—è */
#composerDock .btn { line-height: 1; }

/* –Ω–∞ —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö –≤—Å—ë –∫–∞–∫ —Ä–∞–Ω—å—à–µ ‚Äî –ø–æ–¥ –ø–æ–ª–µ–º */
@media (max-width: 1024px) {
  .send-actions { width: 100% !important; }
}
/* –ö–Ω–æ–ø–∫–∞ –ø–∏–∫–µ—Ä–∞ ‚Äî –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è, –ø–æ–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞ */
.dock-btn { opacity:.45; transition:opacity .15s ease; }
.dock-btn:hover, .dock-btn.active { opacity:1; }

/* –ò—Å—Ç–æ—Ä–∏—è: –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ –∑–∞–∑–æ—Ä –º–µ–∂–¥—É —Ç–µ–∫—Å—Ç–æ–º –∏ –∫–Ω–æ–ø–∫–∞–º–∏ –¥–µ–π—Å—Ç–≤–∏–π */
#historyModal .chat-bubble .msg-text { margin-bottom: 2px !important; }
#historyModal .chat-bubble p { margin-bottom: 2px !important; }

/* –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Ü–µ–ª–µ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∏–∑ ¬´—á–∏–ø–∞¬ª */
.reply-preview {
  border-left: 3px solid #007bff;
  background: #f0f8ff;
  padding: 6px 8px;
  border-radius: 6px;
  margin-bottom: 6px;
}
/* –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –≤ –ø—Ä–µ–≤—å—é –æ—Ç–≤–µ—Ç–∞ */
.reply-preview .rp-box {
  color: #2c3e50; /* –¢–µ–º–Ω–æ-—Å–∏–Ω–∏–π —Ç–µ–∫—Å—Ç */
  font-style: italic;
}

/* –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –ø—Ä–µ–≤—å—é –æ—Ç–≤–µ—Ç–∞ */
.reply-preview:hover {
  background: #e3f2fd; /* –ë–æ–ª–µ–µ —è—Ä–∫–∏–π –≥–æ–ª—É–±–æ–π –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
  border-left-color: #0056b3; /* –¢–µ–º–Ω–µ–µ —Å–∏–Ω–∏–π –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
}
.chat-bubble.reply-target {
  outline: 2px solid #9ad;
  outline-offset: 2px;
  transition: outline-color .8s ease;
}

/* –≠–∫—à–µ–Ω-–±–∞—Ä –≤–Ω—É—Ç—Ä–∏ –ø—É–∑—ã—Ä—è */
#historyModal .chat-bubble {
  position: relative;
  padding: 12px 14px 10px;
  overflow: visible;
}

#historyModal .bubble-meta {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.5rem;
  margin-bottom: 0.35rem;
}

#historyModal .bubble-meta .msg-time {
  margin-bottom: 0 !important;
}

#historyModal .chat-bubble .bubble-actions {
  position: static;
  display: flex;
  align-items: center;
  margin: 0 !important;
  opacity: .95;
  transition: opacity .15s ease;
}

#historyModal .chat-bubble .bubble-actions .btn {
  font-size: .85rem;
  line-height: 1;
  padding: 0 4px;
}

#historyModal .chat-bubble:hover .bubble-actions {
  opacity: 1;
}

/* –¢–µ–∫—Å—Ç –∏ –æ—Ç—Å—Ç—É–ø—ã ‚Äî —á—Ç–æ–±—ã –Ω–∏—á–µ–≥–æ –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª–æ—Å—å */
#historyModal .chat-bubble .msg-time   { margin-bottom: .15rem; }
#historyModal .chat-bubble .msg-author { margin: 3px 0 6px 0; }
#historyModal .chat-bubble .msg-text   { margin-bottom: 0 !important; }

/* –ú–æ–±–∏–ª—å–Ω—ã–π —Ñ–æ–ª–ª–±–µ–∫ */
@media (max-width: 768px){
  #historyModal .bubble-meta {
    flex-wrap: wrap;
    row-gap: 0.25rem;
  }
  #historyModal .chat-bubble {
    padding: 12px;
  }
  #historyModal .chat-bubble .bubble-actions{
    width: 100%;
    justify-content: flex-end;
  }
}

.reply-preview .reply-text {
  font-size: 0.9em;
  color: #6c757d;
}

.reply-preview .btn-close {
  position: absolute;
  top: 5px;
  right: 5px;
  padding: 4px;
}
* === –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ / —É–¥–∞–ª–µ–Ω–∏–µ === *
.chat-bubble.is-editing { outline: 2px dashed #6c757d; outline-offset: 2px; }
.chat-bubble.deleted    { opacity: .55; }
.badge-meta { font-weight: 500; border: 1px solid rgba(0,0,0,.08); }


.reply-target {
  outline: 2px dashed #0d6efd;
  outline-offset: 3px;
  animation: rt-blink 1.2s ease-in-out 1;
}

.chat-bubble.editing {
  box-shadow: 0 0 0 2px rgba(13,110,253,.35) inset;
}

@keyframes rt-blink {
  0% { background-color: rgba(13,110,253,.08); }
  100% { background-color: transparent; }
}
/* –°—Ç–∏–ª–∏ –¥–ª—è —Å—á—ë—Ç—á–∏–∫–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ –∑–∞—è–≤–æ–∫ */
#ticketsTable .unread-badge {
  font-size: 0.75rem;
  min-width: 20px;
  height: 20px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border: 2px solid #fff;
  box-shadow: 0 0 0 1px #dc3545;
}
.filter-badge {
  margin-right: 5px;
  margin-bottom: 5px;
  display: inline-block;
  font-size: 0.8em;
  padding: 4px 8px;
}

/* === –†–µ—Å–∞–π–∑–µ—Ä –¥–ª—è –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –∏—Å—Ç–æ—Ä–∏–∏ === */
.history-pane-resizer {
  position: absolute;
  top: 0;
  right: -4px;
  width: 8px;
  height: 100%;
  background: transparent;
  cursor: col-resize;
  z-index: 10;
}

.history-pane-resizer:hover,
.history-pane-resizer.resizing {
  background: rgba(0, 123, 255, 0.3);
}

.history-pane-resizer::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 2px;
  width: 4px;
  height: 40px;
  background: #6c757d;
  border-radius: 2px;
  transform: translateY(-50%);
  opacity: 0;
  transition: opacity 0.2s;
}

.history-pane-resizer:hover::after {
  opacity: 0.7;
}

.history-pane-resizer.resizing::after {
  opacity: 1;
}

/* –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–µ—Å–∞–π–∑–∞ */
.sidebar-pane {
  position: relative;
  min-width: 300px; /* –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
  max-width: 70%; /* –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
  resize: horizontal;
  overflow: auto;
}

.history-pane {
  position: relative;
  flex: 1;
  min-width: 400px; /* –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –ø—Ä–∞–≤–æ–π —á–∞—Å—Ç–∏ */
}

/* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∞–≤–∞—Ç–∞—Ä–∞ */
#avatarModal {
  z-index: 99999 !important;
}

#avatarModal .modal-dialog {
  max-width: 90vw;
  width: auto;
  z-index: 99999;
}

#avatarModal .modal-content {
  z-index: 99999;
  display: flex;
  flex-direction: column;
}

#avatarModal .modal-footer {
  background: transparent;
}

/* –ì–∞—Ä–∞–Ω—Ç–∏—è, —á—Ç–æ –º–æ–¥–∞–ª–∫–∞ –±—É–¥–µ—Ç –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
.modal-backdrop {
  z-index: 99998;
}

/* –î–ª—è —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ –º–æ–¥–∞–ª–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –≤–Ω—É—Ç—Ä–∏ –¥—Ä—É–≥–æ–π –º–æ–¥–∞–ª–∫–∏ */
.modal {
  z-index: 99999;
}

.modal.small-modal {
    align-items: center;
    justify-content: center;
  }

/* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞–ª–µ–Ω—å–∫–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏—è */
.modal.small-modal.show {
    display: flex !important;
  }

  .modal.small-modal .modal-dialog {
    margin: 0;
    position: relative;
    top: 0;
    transform: none;
  }

/* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–∫–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –∑–∞—è–≤–∫–∏ */
#closeTicketModal .modal-dialog {
  margin: 0;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  position: fixed;
}

/* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–∫–Ω–∞ "–ó–∞—è–≤–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞" */
#ticketClosedModal .modal-dialog {
  margin: 0;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  position: fixed;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞ –≤ –º–æ–¥–∞–ª–∫–µ */
#avatarModalImg {
  transition: opacity 0.3s ease;
  opacity: 0;
}

#avatarModalImg.loaded {
  opacity: 1;
}

  /* === DEBUG: —Ü–≤–µ—Ç–Ω—ã–µ –∫–æ–Ω—Ç—É—Ä—ã –≤ –º–æ–¥–∞–ª–∫–µ –∏—Å—Ç–æ—Ä–∏–∏ === */
#historyModal.debug { --dbg-alpha: .12; }
#historyModal.debug * { box-sizing: border-box; }

/* –∫–∞—Ä–∫–∞—Å –º–æ–¥–∞–ª–∫–∏ */
#historyModal.debug .modal-content   { outline: 3px solid #ff1744;    background-image: none; }
#historyModal.debug .modal-header    { outline: 2px dashed #ff9100; }
#historyModal.debug .modal-body      { outline: 2px solid #ffea00;   }

/* —Å–µ—Ç–∫–∞ –≤–Ω—É—Ç—Ä–∏ */
#historyModal.debug .container-fluid { outline: 3px solid #aa00ff; }
#historyModal.debug .row             { outline: 3px solid #00b0ff; }

/* –∫–æ–ª–æ–Ω–∫–∏ */
#historyModal.debug .sidebar-pane    { outline: 3px solid #e91e63; }
#historyModal.debug .history-pane    { outline: 3px solid #4caf50; }

/* –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ–±—ë—Ä—Ç–∫–∞ —Å–ø—Ä–∞–≤–∞ (grid: 1fr auto) */
#historyModal.debug .history-pane > .d-flex.flex-column { outline: 3px solid #1de9b6; }

/* –∫–æ–Ω—Ç–µ–Ω—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∏ –∑–æ–Ω–∞ –≤–≤–æ–¥–∞ */
#historyModal.debug #historyContent  { outline: 3px solid #3f51b5;
  background-image: repeating-linear-gradient(45deg, rgba(63,81,181,var(--dbg-alpha)) 0 8px, transparent 8px 16px);
}
#historyModal.debug .input-group-send{ outline: 3px solid #ff9800; }

/* –±–ª–æ–∫–∏ —Å–ª–µ–≤–∞ */
#historyModal.debug .problem-info    { outline: 3px solid #9e9e9e; }
#historyModal.debug .category-selector { outline: 3px solid #607d8b; }
#historyModal.debug .time-counter    { outline: 3px solid #9c27b0; }

/* Twemoji: –¥–µ–ª–∞–µ–º —ç–º–æ–¥–∑–∏ —Ä–∞–∑–º–µ—Ä–æ–º —Å —Ç–µ–∫—Å—Ç */
img.emoji {
  height: 1em;
  width: 1em;
  margin: 0 .05em 0 .1em;
  vertical-align: -0.1em;
}

</style>
<script>
const CURRENT_OPERATOR = {{ (session.get('user_email') or session.get('username') or session.get('user') or '') | tojson }};

function getOperatorName() {
  const name = (typeof CURRENT_OPERATOR === 'string' ? CURRENT_OPERATOR : '').trim();
  return name || '–ü–æ–¥–¥–µ—Ä–∂–∫–∞';
}

function markTicketReopenedLocally() {
  // 1) –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É ¬´–ó–∞–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É¬ª
  const btn = document.getElementById('closeTicketBtn');
  if (btn) btn.removeAttribute('disabled');

  // 2) –ß–∏–Ω–∏–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å, —á—Ç–æ–±—ã –¥—Ä—É–≥–æ–π –∫–æ–¥ –Ω–µ ¬´–ø–µ—Ä–µ–æ—Ç–∫–ª—é—á–∏–ª¬ª –∫–Ω–æ–ø–∫—É
  window.currentTicketStatus = 'open';

  // 3) –ï—Å–ª–∏ —É –Ω–∞—Å –µ—Å—Ç—å –∫—ç—à —Å–ø–∏—Å–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤ ‚Äî –æ–±–Ω–æ–≤–∏–º —Ç–∞–º —Å—Ç–∞—Ç—É—Å
  if (Array.isArray(window.allTickets)) {
    const i = window.allTickets.findIndex(t => String(t.ticket_id) === String(window.currentTicketId));
    if (i >= 0) window.allTickets[i].status = 'open';
  }

  // 4) (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –≤–∏–∑—É–∞–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏–º –±–µ–π–¥–∂ —Å—Ç–∞—Ç—É—Å–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
  const st = document.getElementById('ticketStatusBadge');
  if (st) { st.textContent = '–û—Ç–∫—Ä—ã—Ç–∞'; st.classList.remove('bg-secondary'); st.classList.add('bg-success'); }

  // 5) (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ—Å—Ç
  if (typeof showToast === 'function') showToast('–ó–∞—è–≤–∫–∞ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∞');
}
</script>

</head>
<body class="with-sidebar sidebar-pinned">
  {% include "_sidebar.html" %}
  <main class="main-content container-fluid">

  <div class="container-fluid mt-4">
    <!-- –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –§–∏–ª—å—Ç—Ä—ã –∏ –ø–µ—Ä–µ–º–µ—â–∞–µ–º –ü–æ–∏—Å–∫ -->
	<div class="d-flex justify-content-between align-items-center mb-3">
	  <h2>–°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫</h2>
	  <div class="d-flex align-items-center">
		<!-- –ü–æ–∏—Å–∫ - —Ç–µ–ø–µ—Ä—å —Å–ª–µ–≤–∞ –æ—Ç –∫–Ω–æ–ø–∫–∏ –§–∏–ª—å—Ç—Ä—ã -->
		<div class="input-group me-2" style="width: 250px;">
		  <span class="input-group-text">üîç</span>
		  <input type="text" id="searchInput" class="form-control" placeholder="–ü–æ–∏—Å–∫...">
		</div>

		<!-- –ö–Ω–æ–ø–∫–∞ –§–∏–ª—å—Ç—Ä—ã -->
		<button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#filtersModal">
		  <i class="bi bi-funnel"></i> –§–∏–ª—å—Ç—Ä—ã
		</button>

		<!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
		<button class="btn btn-outline-secondary me-2" onclick="resetFilters()" title="–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã">
		  üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å
		</button>

		<!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ -->
		<button class="btn btn-outline-secondary me-2" onclick="toggleColumnSettings()">
		  ‚öôÔ∏è –°—Ç–æ–ª–±—Ü—ã
		</button>

		<select id="tzSelect" class="form-select ms-2" style="width: 220px; display: inline-block;">
		  <option value="browser">–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –±—Ä–∞—É–∑–µ—Ä–∞</option>
		  <option value="Europe/Moscow">Europe/Moscow (GMT+3)</option>
		  <option value="Asia/Almaty">Asia/Almaty (GMT+6)</option>
		  <option value="Asia/Novosibirsk">Asia/Novosibirsk (GMT+7)</option>
		  <option value="Asia/Yekaterinburg">Asia/Yekaterinburg (GMT+5)</option>
		  <option value="Europe/Samara">Europe/Samara (GMT+4)</option>
		</select>

		<select id="pageSize" class="form-select ms-2" style="width: 120px; display: inline-block;">
		  <option value="5">5 –∑–∞—è–≤–æ–∫</option>
		  <option value="20" selected>20 –∑–∞—è–≤–æ–∫</option>
		  <option value="50">50 –∑–∞—è–≤–æ–∫</option>
		  <option value="100">100 –∑–∞—è–≤–æ–∫</option>
		  <option value="500">500 –∑–∞—è–≤–æ–∫</option>
		</select>
	  </div>
	</div>

	<!-- –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–π –±–ª–æ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ –∑–∞–º–µ–Ω—è–µ–º –µ–≥–æ –Ω–∞ –±–æ–ª–µ–µ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π -->
	<div class="filter-grid mb-3" style="display: none;" id="compactFilters">
	  <!-- –≠—Ç–æ—Ç –±–ª–æ–∫ –º–æ–∂–Ω–æ —Å–∫—Ä—ã—Ç—å, —Ç–∞–∫ –∫–∞–∫ —Ñ–∏–ª—å—Ç—Ä—ã —Ç–µ–ø–µ—Ä—å –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ -->
	</div>

	<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è –∑–∞—è–≤–æ–∫ -->
	<div class="modal fade" id="filtersModal" tabindex="-1">
	  <div class="modal-dialog modal-lg">
		<div class="modal-content">
		  <div class="modal-header">
			<h5 class="modal-title">–§–∏–ª—å—Ç—Ä—ã –∑–∞—è–≤–æ–∫</h5>
			<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
		  </div>
		  <div class="modal-body">
			<div class="row filter-row">
			  <div class="col-md-6 mb-3">
				<label>–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏</label>
				<select class="form-select" id="filterStatusModal">
				  <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
				  <option value="pending">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
				  <option value="resolved">–†–µ—à–µ–Ω–æ</option>
				  <option value="–ù–æ–≤–∞—è">–ù–æ–≤–∞—è</option>
				  <option value="–û–∂–∏–¥–∞–µ—Ç —Ä–µ–∞–∫—Ü–∏–∏">–û–∂–∏–¥–∞–µ—Ç —Ä–µ–∞–∫—Ü–∏–∏</option>
				  <option value="–û–∂–∏–¥–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞">–û–∂–∏–¥–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞</option>
				</select>
			  </div>
			  <div class="col-md-6 mb-3">
				<label>ID –∫–ª–∏–µ–Ω—Ç–∞</label>
				<input type="text" class="form-control" id="filterUserModal" placeholder="–í–≤–µ–¥–∏—Ç–µ ID">
			  </div>
			  <div class="col-md-6 mb-3">
				<label>ID –∑–∞—è–≤–∫–∏</label>
				<input type="text" class="form-control" id="filterTicketIdModal" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∑–∞—è–≤–∫–∏">
			  </div>
			  <div class="col-md-6 mb-3">
				<label>–ë–∏–∑–Ω–µ—Å</label>
				<input type="text" class="form-control" id="filterBusinessModal" placeholder="–í–≤–µ–¥–∏—Ç–µ –±–∏–∑–Ω–µ—Å">
			  </div>
			  <div class="col-md-6 mb-3">
				<label>–õ–æ–∫–∞—Ü–∏—è</label>
				<input type="text" class="form-control" id="filterLocationModal" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é">
			  </div>
			  <div class="col-md-6 mb-3">
				<label>–°—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞</label>
				<input type="text" class="form-control" id="filterClientStatusModal" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞">
			  </div>
			  <div class="col-md-6 mb-3">
				<label>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</label>
				<input type="text" class="form-control" id="filterResponsibleModal" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ">
			  </div>
			  <div class="col-md-6 mb-3">
				<label>–î–∞—Ç–∞ –æ—Ç</label>
				<input type="date" class="form-control" id="filterDateFromModal">
			  </div>
			  <div class="col-md-6 mb-3">
				<label>–î–∞—Ç–∞ –¥–æ</label>
				<input type="date" class="form-control" id="filterDateToModal">
			  </div>
			</div>
			
			<!-- –ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
			<div class="mt-3" id="activeFiltersModal" style="display: none;">
			  <h6>–ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:</h6>
			  <div id="filterBadgesModal"></div>
			</div>
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-secondary" onclick="resetFiltersModal()">–°–±—Ä–æ—Å–∏—Ç—å</button>
			<button type="button" class="btn btn-primary" onclick="applyFiltersModal()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
		  </div>
		</div>
	  </div>
	</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å—Ç–æ–ª–±—Ü–æ–≤ -->
<div class="modal fade" id="columnSettingsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="column-toggle">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="toggleClient" checked>
            <label class="form-check-label" for="toggleClient">–ö–ª–∏–µ–Ω—Ç</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="toggleClientStatus" checked>
            <label class="form-check-label" for="toggleClientStatus">–°—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="toggleChannel" checked>
            <label class="form-check-label" for="toggleChannel">–ò–º—è –∫–∞–Ω–∞–ª–∞</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="toggleTicketId" checked>
            <label class="form-check-label" for="toggleTicketId">ID –∑–∞—è–≤–∫–∏</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="toggleBusiness" checked>
            <label class="form-check-label" for="toggleBusiness">–ë–∏–∑–Ω–µ—Å</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="toggleLocation" checked>
            <label class="form-check-label" for="toggleLocation">–õ–æ–∫–∞—Ü–∏—è</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="toggleProblem" checked>
            <label class="form-check-label" for="toggleProblem">–ü—Ä–æ–±–ª–µ–º–∞</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="toggleResponsible" checked>
            <label class="form-check-label" for="toggleResponsible">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="toggleStatus" checked>
            <label class="form-check-label" for="toggleStatus">–°—Ç–∞—Ç—É—Å</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="toggleDate" checked>
            <label class="form-check-label" for="toggleDate">–î–∞—Ç–∞</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="toggleTime" checked>
            <label class="form-check-label" for="toggleTime">–í—Ä–µ–º—è</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="toggleActions" checked>
            <label class="form-check-label" for="toggleActions">–î–µ–π—Å—Ç–≤–∏—è</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-primary" onclick="applyColumnSettings()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

    <div class="table-responsive">
      <table class="table table-striped" id="ticketsTable">
        <thead>
          <tr>
            <th data-column="client" data-field="client" data-resizable="true">–ö–ª–∏–µ–Ω—Ç</th>
            <th data-column="clientStatus" data-field="clientStatus" data-resizable="true">–°—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞</th>
			<th data-column="channel" data-field="channel" data-resizable="true">–ò–º—è –∫–∞–Ω–∞–ª–∞</th>
            <th data-column="ticketId" data-field="ticketId" data-resizable="true">ID –∑–∞—è–≤–∫–∏</th>
            <th data-column="business" data-field="business" data-resizable="true">–ë–∏–∑–Ω–µ—Å</th>
            <th data-column="location" data-field="location" data-resizable="true">–õ–æ–∫–∞—Ü–∏—è</th>
            <th data-column="problem" data-field="problem" data-resizable="true">–ü—Ä–æ–±–ª–µ–º–∞</th>
            <th data-column="responsible" data-field="responsible" data-resizable="true">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th>
            <th data-column="status" data-field="status" data-resizable="true">
			  <span class="me-1">–°—Ç–∞—Ç—É—Å</span>
			</th>
            <th data-column="date" data-field="date" data-resizable="true">–î–∞—Ç–∞</th>
            <th data-column="time" data-field="time" data-resizable="true">–í—Ä–µ–º—è</th>
            <th data-column="actions" data-field="actions" data-resizable="true">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody id="ticketsBody">
        </tbody>
      </table>
    </div>

    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center" id="pagination">
      </ul>
    </nav>
  </div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –∏—Å—Ç–æ—Ä–∏—è -->
<div class="modal fade resizable-modal" id="historyModal" tabindex="-1">
  <div class="modal-dialog modal-xl" style="max-width: 60vw; height: 95vh; resize: both;">
    <div class="modal-content">
		<div class="modal-header flex-wrap">
		  <h5 class="modal-title d-flex align-items-center flex-wrap" id="historyModalTitle">
			üí¨ –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ ‚Äî ID –∑–∞—è–≤–∫–∏: &nbsp;<span id="ticketIdDisplay"></span>&nbsp;&nbsp;
			<span id="clientDisplayName">‚Äî</span>
			<span class="badge bg-info ms-2" id="clientStatusDisplay"></span>
			<span id="unreadBadge" class="badge bg-danger ms-2 d-none">0</span>
			<button type="button" class="btn btn-sm btn-outline-primary ms-2" id="editClientBtn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–º—è">‚úèÔ∏è</button>
		  </h5>
		  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
		</div>
      <div class="modal-body p-0 flex-grow-1">
        <div class="container-fluid p-0 d-flex flex-column flex-fill min-height-0">
          <div class="row g-0 flex-fill min-height-0">
            <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–±–ª–µ–º–µ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
            <div class="col-md-4 sidebar-pane border-end">
              <div class="d-flex flex-column flex-fill min-height-0">
                <!-- –ü—Ä–æ–±–ª–µ–º–∞ -->
                <div class="problem-info p-3 sidebar-info">
                  <strong>–ü—Ä–æ–±–ª–µ–º–∞:</strong>
                  <span id="problemText" class="ellipsis-100ch" title=""></span>
                </div>
                
                <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è -->
                <div class="category-selector p-3 sidebar-info">
                  <label for="ticketCategorySelect" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è:</label>
                  <div class="selected-categories mt-2 ellipsis-100ch" id="selectedCategories" style="font-size: 0.9rem;" title=""></div>
                  <select id="ticketCategorySelect" class="form-select" multiple style="display: none;">
                    {% for cat in settings.categories %}
                      <option value="{{ cat }}">{{ cat }}</option>
                    {% endfor %}
                  </select>
                  <div class="dropdown" data-bs-auto-close="outside">
                    <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="categoryDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                      –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏...
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="categoryDropdown" style="max-height: 300px; overflow-y: auto;">
                      {% for cat in settings.categories %}
                        <li>
                          <div class="form-check dropdown-item">
                            <input class="form-check-input category-checkbox" type="checkbox" value="{{ cat }}" id="cat{{ loop.index }}">
                            <label class="form-check-label w-100" for="cat{{ loop.index }}">{{ cat }}</label>
                          </div>
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                  <div class="form-text">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</div>
                  <button type="button" class="btn btn-outline-primary mt-2 w-100" onclick="saveTicketCategory()">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                  </button>
                </div>
				
                <!-- –§–æ—Ç–æ –∫–ª–∏–µ–Ω—Ç–∞ -->
                <div class="p-3 text-center history-avatar-wrapper">
                  <img id="clientAvatarInHistory" src="" alt="–ê–≤–∞—Ç–∞—Ä" class="rounded-circle history-avatar">
                  <div class="small text-muted mt-2">–§–æ—Ç–æ –∫–ª–∏–µ–Ω—Ç–∞</div>
                </div>

                <!-- –¢–∞–π–º–µ—Ä/—Å—á—ë—Ç—á–∏–∫ –≤—Ä–µ–º–µ–Ω–∏ -->
                <div class="time-counter p-3 sidebar-info mt-auto">
                  <label class="form-label">–í—Ä–µ–º—è –æ–±—Ä–∞—â–µ–Ω–∏—è:</label>
                  <div class="time-info bg-light p-3 rounded" id="timeInfo" title="">
                    <div id="timeCounter">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div id="timeDetails" class="small text-muted mt-1"></div>
                  </div>
					<button type="button" id="closeTicketBtn" class="btn btn-danger w-100 mt-3">
						–ó–∞–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É
					</button>
                </div>
              </div>
            </div>
			<div class="history-pane-resizer" id="historyPaneResizer"></div>

            <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å - –∏—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ -->
            <div class="col-md-8 history-pane">
              <div class="d-flex flex-column flex-fill min-height-0">
                <!-- –ë–ª–æ–∫ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ -->
                <div class="chat-container flex-grow-1 min-height-0" id="historyContent"></div>

                <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∫–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                <div class="input-group-send border-top bg-light w-100 px-3 pt-3 pb-0">
                  <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: textarea + ¬´–¥–æ–∫¬ª —Å —ç–º–æ–¥–∑–∏/—Å—Ç–∏–∫–µ—Ä–∞–º–∏/GIF –í–ù–£–¢–†–ò –ø–æ–ª—è -->
                  <div class="flex-grow-1 position-relative">
                    <div class="w-100">
                      <div class="d-flex gap-2 mb-1 flex-wrap">
                        <button type="button" class="btn btn-light btn-sm fmt" data-tag="b" title="–ñ–∏—Ä–Ω—ã–π">B</button>
                        <button type="button" class="btn btn-light btn-sm fmt" data-tag="i" title="–ö—É—Ä—Å–∏–≤"><em>I</em></button>
                        <button type="button" class="btn btn-light btn-sm fmt" data-tag="u" title="–ü–æ–¥—á—ë—Ä–∫–Ω—É—Ç—ã–π"><u>U</u></button>
                        <button type="button" class="btn btn-light btn-sm fmt" data-tag="s" title="–ó–∞—á—ë—Ä–∫–Ω—É—Ç—ã–π"><s>S</s></button>
                        <button type="button" class="btn btn-light btn-sm fmt" data-tag="code" title="–ú–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π">code</button>
                        <button type="button" class="btn btn-light btn-sm fmt" data-tag="blockquote" title="–¶–∏—Ç–∞—Ç–∞">‚ùù ‚ùû</button>
                        <button type="button" class="btn btn-light btn-sm" id="fmtLink" title="–°—Å—ã–ª–∫–∞">üîó</button>
                      </div>
                      <textarea id="replyTextInHistory" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç." rows="2"></textarea>
                    </div>

                    <!-- –ï–î–ò–ù–ê–Ø –∫–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ (—ç–º–æ–¥–∑–∏/—Å—Ç–∏–∫–µ—Ä—ã/GIF) -->
                    <div id="composerDock" class="position-absolute" style="right:10px; bottom:15px;">
                      <button type="button"
                              id="btnPicker"
                              class="btn btn-sm btn-light px-3 dock-btn"
                              title="–≠–º–æ–¥–∑–∏/–°—Ç–∏–∫–µ—Ä—ã/GIF"
                              aria-expanded="false">üòÄ</button>
                    </div>

                    <!-- –ü–∞–Ω–µ–ª—å –ø–∏–∫–µ—Ä–∞ (–æ–¥–Ω–æ –æ–∫–Ω–æ —Å –≤–∫–ª–∞–¥–∫–∞–º–∏) -->
                    <div id="pickerPanel" class="card shadow-sm"
                         style="position:absolute; right:10px; bottom:56px; width:360px; max-height:380px; display:none; z-index:5;">
                      <div class="card-header py-1 px-2">
                        <ul class="nav nav-tabs card-header-tabs" id="pickerTabs" role="tablist">
                          <li class="nav-item"><button class="nav-link active" id="tab-emoji" data-bs-toggle="tab" data-bs-target="#pane-emoji" type="button" role="tab">–≠–º–æ–¥–∑–∏</button></li>
                          <li class="nav-item"><button class="nav-link" id="tab-sticker" data-bs-toggle="tab" data-bs-target="#pane-sticker" type="button" role="tab">–°—Ç–∏–∫–µ—Ä—ã</button></li>
                          <li class="nav-item"><button class="nav-link" id="tab-gif" data-bs-toggle="tab" data-bs-target="#pane-gif" type="button" role="tab">GIF</button></li>
                        </ul>
                      </div>
                      <div class="card-body p-2 tab-content" style="overflow:auto;">
                        <!-- –≠–º–æ–¥–∑–∏ -->
                        <div class="tab-pane fade show active" id="pane-emoji" role="tabpanel">
                          <input id="emojiSearch" class="form-control form-control-sm mb-2" placeholder="–ü–æ–∏—Å–∫ —ç–º–æ–¥–∑–∏">
                          <div class="small text-muted" id="emojiRecentWrap" style="display:none;">–ù–µ–¥–∞–≤–Ω–∏–µ:</div>
                          <div id="emojiRecent" class="d-flex flex-wrap gap-1 mb-2"></div>
                          <div id="emojiGrid" class="d-flex flex-wrap gap-1"></div>
                        </div>
                        <!-- –°—Ç–∏–∫–µ—Ä—ã -->
                        <div class="tab-pane fade" id="pane-sticker" role="tabpanel">
                          <div class="small text-muted mb-2">–ù–µ–¥–∞–≤–Ω–∏–µ</div>
                          <div id="stickerRecent" class="d-flex flex-wrap gap-2 mb-2"></div>
                          <label class="btn btn-sm btn-outline-secondary">
                            –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∏–∫–µ—Ä
                            <input id="fileSticker" type="file" class="d-none" accept=".webp,.webm,.tgs">
                          </label>
                        </div>
                        <!-- GIF -->
                        <div class="tab-pane fade" id="pane-gif" role="tabpanel">
                          <div class="small text-muted mb-2">–ó–∞–≥—Ä—É–∑–∏—Ç—å GIF</div>
                          <input id="fileGif" type="file" accept=".gif" class="form-control form-control-sm" />
                          <div id="gifPreview" class="mt-2 d-flex flex-wrap gap-2"></div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- –ü–†–ê–í–ê–Ø –∫–æ–ª–æ–Ω–∫–∞: ¬´–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å¬ª + ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å¬ª -->
                  <div class="send-actions d-flex flex-column ms-2" style="width:160px;">
                    <input type="file" id="replyFiles" class="d-none" multiple>
                    <label for="replyFiles" id="replyFilesBtn" class="btn btn-outline-secondary w-100 mb-2">
                      üìé
                    </label>
                    <button type="button" id="sendReplyInHistory" class="btn btn-primary w-100">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
  </div>
</div>

     </div>
  </div>
</div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –æ—Ç–≤–µ—Ç -->
  <div class="modal fade" id="replyModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">–û—Ç–≤–µ—Ç–∏—Ç—å</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <textarea id="replyText" class="form-control" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç..."></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          <button type="button" class="btn btn-success" onclick="sendReply()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>
	
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –∑–∞–∫—Ä—ã—Ç–∏–µ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π -->
<div class="modal fade" id="closeTicketModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ó–∞–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="category-selector mb-3">
          <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è:</label>
          <select id="closeCategorySelect" class="form-select" multiple style="display: none;">
            {% for cat in settings.categories %}
            <option value="{{ cat }}">{{ cat }}</option>
            {% endfor %}
          </select>
          <div class="dropdown" data-bs-auto-close="outside">
            <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="closeCategoryDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏...
            </button>
            <ul class="dropdown-menu" aria-labelledby="closeCategoryDropdown" style="max-height: 300px; overflow-y: auto;">
              {% for cat in settings.categories %}
              <li>
                <div class="form-check dropdown-item">
                  <input class="form-check-input close-category-checkbox" type="checkbox" value="{{ cat }}" id="closeCat{{ loop.index }}">
                  <label class="form-check-label w-100" for="closeCat{{ loop.index }}">{{ cat }}</label>
                </div>
              </li>
              {% endfor %}
            </ul>
          </div>
          <div class="selected-categories mt-2" id="closeSelectedCategories" style="font-size: 0.9rem;"></div>
          <div class="form-text">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" id="confirmCloseTicketBtn" class="btn btn-danger">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è -->
<div class="modal fade small-modal" id="ticketClosedModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4">
      <div class="modal-body">
        <h5 class="mb-2">–ó–∞—è–≤–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞</h5>
        <p class="text-muted mb-0">–û–±—Ä–∞—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ –≤ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.</p>
      </div>
      <div class="modal-footer justify-content-center border-0">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">–û–∫</button>
      </div>
    </div>
  </div>
</div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∞ -->
  <div class="modal fade" id="editClientNameModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∞</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="clientNameInput" class="form-label">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
            <input type="text" class="form-control" id="clientNameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞">
          </div>
          <div class="mb-3">
            <label for="clientUsernameInput" class="form-label">Username</label>
            <input type="text" class="form-control" id="clientUsernameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ username">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          <button type="button" class="btn btn-primary" onclick="saveClientName()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    window.settings = {
  "categories": {{ settings.categories | tojson if settings and settings.categories else '["–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è"]' | safe }}
};
  </script>

  <script>
	const savedPage = parseInt(localStorage.getItem('ticketsCurrentPage') || '1', 10);
	let currentPage = Number.isFinite(savedPage) && savedPage > 0 ? savedPage : 1;
	let totalPages = 1;
	let allTickets = [];
    let currentUserId = null;
    let currentTicketId = null;
    let historyPolling = null;
	window.lastReadAtByTicket = JSON.parse(localStorage.getItem('lastReadAtByTicket') || '{}');
    let currentPageSize = 20;
	        function persistCurrentPageIfUnfiltered() {
          if (!window.filteredTickets) {
                localStorage.setItem('ticketsCurrentPage', String(currentPage));
          }
        }

        function ensureCurrentPageBounds(totalItems) {
          const maxPage = Math.max(1, Math.ceil(totalItems / currentPageSize) || 1);
          if (currentPage > maxPage) currentPage = maxPage;
          if (currentPage < 1) currentPage = 1;
          return maxPage;
        }
	let unreadCount = 0;
		function setUnread(n) {
		  unreadCount = Math.max(0, n|0);
		  const b = document.getElementById('unreadBadge');
		  if (!b) return;
		  if (unreadCount > 0) {
			b.textContent = String(unreadCount);
			b.classList.remove('d-none');
		  } else {
			b.textContent = '0';
			b.classList.add('d-none');
		  }
		}
	let renderedMsgIds = new Set();

	function safeId(msg) {
	  // –ë–µ—Ä—ë–º –ª—é–±–æ–π –¥–æ—Å—Ç—É–ø–Ω—ã–π ¬´—Ç–µ–ª–µ–≥—Ä–∞–º–Ω—ã–π¬ª/—Å–∫–≤–æ–∑–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
	  return (msg.tg_message_id ?? msg.message_id ?? msg.tg_id ?? msg.id ?? null);
	}

	function msgKey(msg) {
	  const sid = safeId(msg);
	  if (sid != null && sid !== '') return 'tg:' + String(sid);

	  const ts = Date.parse(msg.timestamp ?? msg.date ?? msg.created_at ?? '') || 0;
	  const s  = (msg.sender || '').toLowerCase();

	  // –í–ê–ñ–ù–û: —É—á–∏—Ç—ã–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—è —Ç–µ–∫—Å—Ç–∞, –∏–Ω–∞—á–µ —Ä–∞–∑–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
	  // –±—É–¥—É—Ç –∏–º–µ—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –∫–ª—é—á –∏ ¬´—Ç–µ—Ä—è—Ç—å—Å—è¬ª
	  const h  = (msg.message ?? msg.text ?? msg.body ?? '').toString().slice(0, 160);

	  return `${s}|${ts}|${h}`;
	}
	
	function telegramMid(msg) {
	  // –ë–µ—Ä—ë–º –¢–û–õ–¨–ö–û —Ä–µ–∞–ª—å–Ω—ã–µ ID —Ç–µ–ª–µ–≥—Ä–∞–º-—Å–æ–æ–±—â–µ–Ω–∏–π
	  return (msg.tg_message_id ?? msg.message_id ?? null);
	}

        // –§–ª–∞–≥ ¬´—ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞?¬ª
        function isSupportMsg(msg) {
          const raw = String(msg.sender || '').toLowerCase().trim();
          return (
                ['support','operator','admin','–ø–æ–¥–¥–µ—Ä–∂–∫–∞','–æ–ø–µ—Ä–∞—Ç–æ—Ä','staff','agent'].includes(raw) ||
                msg.is_support === true ||
                msg.from_support === true ||
                msg.is_outgoing === true ||
                msg.sender_type === 'support' ||
                msg.direction === 'out' ||
                msg.sender === 'support'
          );
        }

        function isSupportSenderLabel(label) {
          const raw = String(label || '').toLowerCase().trim();
          if (!raw) return false;
          return (
            raw.includes('support') ||
            ['support','operator','admin','–ø–æ–¥–¥–µ—Ä–∂–∫–∞','–æ–ø–µ—Ä–∞—Ç–æ—Ä','staff','agent','system','bot','manager'].includes(raw)
          );
        }

        function isUserSenderLabel(label) {
          const raw = String(label || '').toLowerCase().trim();
          if (!raw) return false;
          return ['user','client','customer','–∫–ª–∏–µ–Ω—Ç','–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å','telegram_user','customer'].includes(raw);
        }

	// –ï–¥–∏–Ω—ã–π UTC-timestamp (ms) –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
	function sortTsMs(msg) {
	  const tsRaw = (msg.timestamp ?? msg.date ?? msg.created_at ?? msg.createdAt ?? msg.tg_date ?? null);
	  const iso   = normalizeToISO(tsRaw);      // —É–∂–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ISO –≤ UTC
	  return Date.parse(iso) || 0;
	}

        function wrapSelection(tag, before='', after=''){
          const ta = document.getElementById('replyTextInHistory');
          const [start, end] = [ta.selectionStart, ta.selectionEnd];
          const sel = ta.value.substring(start, end) || '—Ç–µ–∫—Å—Ç';
          const open = `<${tag}${before}>`;
          const close = `</${tag.split(' ')[0]}>${after}`;
          ta.setRangeText(open + sel + close, start, end, 'end');
          ta.focus();
        }

        function normalizeAvatarUrl(src) {
          if (!src) return '';
          let value = String(src).trim();
          if (!value) return '';
          if (value.toLowerCase() === 'null' || value.toLowerCase() === 'undefined') return '';
          if (value.startsWith('data:')) return value;
          if (value.startsWith('http://') || value.startsWith('https://')) return value;
          if (value.startsWith('//')) return window.location.protocol + value;
          if (!value.startsWith('/')) value = '/' + value.replace(/^\/+/, '');
          return value;
        }

        function ensureFullAvatarUrl(src) {
          const normalized = normalizeAvatarUrl(src);
          if (!normalized) return '';
          if (!normalized.startsWith('/')) return normalized;
          if (normalized.includes('?full=1')) return normalized;
          return normalized.includes('?') ? `${normalized}&full=1` : `${normalized}?full=1`;
        }
	document.querySelectorAll('.fmt').forEach(btn=>{
	  btn.addEventListener('click', ()=>{
		const tag = btn.dataset.tag;
		if (tag === 'blockquote') wrapSelection('blockquote');
		else wrapSelection(tag);
	  });
	});
	document.getElementById('fmtLink')?.addEventListener('click', ()=>{
	  const url = prompt('–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É (https://)‚Ä¶','https://');
	  if (!url) return;
	  wrapSelection(`a href="${escapeHtml(url)}"`);
	});

	// –ú–∏–Ω–∏ –Ω–∞–±–æ—Ä —ç–º–æ–¥–∑–∏ (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å)
	const EMOJI_LIST = window.EMOJI_LIST || Array.from("üòÄüòÅüòÇü§£üòÖüòäüôÇüòâüòçüòòüòãüòéü§©ü§îüò¥üò∑ü§íü§ïü§ëü§Øü§óü§ùüëçüëéüëèüôèüí™üî•‚ú®üí•üéâ‚ù§Ô∏èüß°üíõüíöüíôüíúü§çü§éüñ§üëåüôåü§åü§û‚úåÔ∏èü§üüëãü§ôü§òü´∂");
	const RECENT_KEY = "its_recent_emoji_v1";

	(function initEmojiUI(){
	  const ta         = document.getElementById('replyTextInHistory');
	  const panel      = document.getElementById('pickerPanel');
	  const grid       = document.getElementById('emojiGrid');
	  const recentWrap = document.getElementById('emojiRecentWrap');
	  const recentBox  = document.getElementById('emojiRecent');
	  const search     = document.getElementById('emojiSearch');

	  if (!ta || !panel || !grid) return; // —Ç–∏—Ö–æ –≤—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ —Å–µ–∫—Ü–∏–∏ –Ω–µ—Ç

	  function renderEmoji(list){
		grid.innerHTML = "";
		list.forEach(ch => {
		  const b = document.createElement('button');
		  b.type = "button";
		  b.className = "btn btn-sm btn-light";
		  b.textContent = ch;
		  b.dataset.emoji = ch;          // –¥–ª—è –¥–µ–ª–µ–≥–∞—Ü–∏–∏ –∫–ª–∏–∫–æ–≤
		  grid.appendChild(b);
		});
	  }

	  function getRecent(){
		try { return JSON.parse(localStorage.getItem(RECENT_KEY) || "[]"); }
          catch (error) { return []; }
	  }
	  function pushRecent(ch){
		const arr = getRecent().filter(x => x !== ch);
		arr.unshift(ch);
		localStorage.setItem(RECENT_KEY, JSON.stringify(arr.slice(0, 16)));
	  }
	  function updateRecent(){
		const arr = getRecent();
		recentBox.innerHTML = "";
		recentWrap && (recentWrap.style.display = arr.length ? "" : "none");
		arr.forEach(ch => {
		  const b = document.createElement('button');
		  b.type = "button";
		  b.className = "btn btn-sm btn-outline-secondary";
		  b.textContent = ch;
		  b.addEventListener('click', () => {
			insertAtCaret(ta, ch + " ");
			pushRecent(ch);
			updateRecent();
		  });
		  recentBox.appendChild(b);
		});
	  }
	  function insertAtCaret(el, text){
		const start = el.selectionStart ?? el.value.length;
		const end   = el.selectionEnd ?? el.value.length;
		el.value = el.value.slice(0, start) + text + el.value.slice(end);
		el.focus();
		el.selectionStart = el.selectionEnd = start + text.length;
	  }

	  // –î–µ–ª–µ–≥–∞—Ü–∏—è –∫–ª–∏–∫–æ–≤ –ø–æ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ç–∫–µ —ç–º–æ–¥–∑–∏
	  grid.addEventListener('click', (e)=>{
		const btn = e.target.closest('button[data-emoji]');
		if (!btn) return;
		const ch = btn.dataset.emoji;
		insertAtCaret(ta, ch + " ");
		pushRecent(ch);
		updateRecent();
	  });

	  // –ü–æ–∏—Å–∫ –ø–æ —ç–º–æ–¥–∑–∏
	  search?.addEventListener('input', () => {
		const q = (search.value || "").trim();
		renderEmoji(q ? EMOJI_LIST.filter(ch => ch.includes(q)) : EMOJI_LIST);
	  });

	  // –ü–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä
	  renderEmoji(EMOJI_LIST);
	  updateRecent();
	})();

	/* –ï–î–ò–ù–ê–Ø –∫–Ω–æ–ø–∫–∞ (üòÄ) ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å/—Å–ø—Ä—è—Ç–∞—Ç—å –ø–∞–Ω–µ–ª—å —Å –≤–∫–ª–∞–¥–∫–∞–º–∏ –≠–º–æ–¥–∑–∏/–°—Ç–∏–∫–µ—Ä—ã/GIF */
	(function initUnifiedPicker(){
	  const dock   = document.getElementById('composerDock');
	  const btn    = document.getElementById('btnPicker');
	  const panel  = document.getElementById('pickerPanel');

	  const tabEmoji   = document.getElementById('tab-emoji');
	  const tabSticker = document.getElementById('tab-sticker');
	  const tabGif     = document.getElementById('tab-gif');

	  if (!dock || !btn || !panel) return;

	  let lastTab = localStorage.getItem('pickerLastTab') || 'emoji';

	  function open(tab = lastTab){
		panel.style.display = 'block';
		btn.classList.add('active');
		(tab === 'sticker' ? tabSticker :
		 tab === 'gif'     ? tabGif     : tabEmoji)?.click();
	  }
	  function close(){
		panel.style.display = 'none';
		btn.classList.remove('active');
	  }

	  btn.addEventListener('click', () => {
		(panel.style.display === 'block') ? close() : open();
	  });

	  // –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É (—á–µ—Ä–µ–∑ bootstrap tab)
	  [['emoji', tabEmoji], ['sticker', tabSticker], ['gif', tabGif]].forEach(([name, el])=>{
		el?.addEventListener('shown.bs.tab', () => {
		  lastTab = name;
		  localStorage.setItem('pickerLastTab', name);
		});
	  });

	  // –∫–ª–∏–∫ –≤–Ω–µ –ø–∞–Ω–µ–ª–∏/–∫–Ω–æ–ø–∫–∏ ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ–º; ESC ‚Äî —Ç–æ–∂–µ
	  document.addEventListener('click', (e)=>{
		if (!panel.contains(e.target) && !dock.contains(e.target)) close();
	  }, true);
	  document.addEventListener('keydown', (e)=>{
		if (e.key === 'Escape') close();
	  });
	})();

	async function uploadOneFile(file) {
	  const fd = new FormData();
	  fd.append('user_id', String(currentUserId));
	  fd.append('ticket_id', String(currentTicketId));
	  fd.append('admin', getOperatorName());
	  fd.append('file', file);

	  const tmp = document.createElement('div');
	  tmp.className = 'chat-bubble from-support opacity-75';
	  tmp.dataset.temp = '1';
	  tmp.innerHTML = '<small>–û—Ç–ø—Ä–∞–≤–∫–∞‚Ä¶</small><br><strong>üõ† –ü–æ–¥–¥–µ—Ä–∂–∫–∞</strong>';
	  historyContent.appendChild(tmp);
	  scrollToBottom(historyContent);
	  const resp = await fetch('/reply_file', { method: 'POST', body: fd });
	  const data = await resp.json();
	if (!data.success) throw new Error(data.error || 'upload failed');

	if (data.reopened) {
	  markTicketReopenedLocally();
	  try { await autoRefreshTickets(); } catch (e) {}
	}

	// ‚¨áÔ∏è –≤–º–µ—Å—Ç–æ –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞ ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–∑ API
	if (typeof updateHistory === 'function') {
	  await updateHistory();
	  const c = document.getElementById('historyContent');
	  if (c) c.scrollTop = c.scrollHeight;
	}
	document.querySelectorAll('#historyContent .chat-bubble[data-temp="1"]').forEach(n => n.remove());
	}

// –°—Ç–∏–∫–µ—Ä—ã
document.getElementById('fileSticker')?.addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if (!f) return;
  try { await uploadOneFile(f); } catch(err){ alert('‚ùå ' + err.message); } finally { e.target.value=''; }
});

// GIF
document.getElementById('fileGif')?.addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if (!f) return;
  try { await uploadOneFile(f); } catch(err){ alert('‚ùå ' + err.message); } finally { e.target.value=''; }
});

		// –ù–∞ –ø–µ—Ä–µ—Ö–æ–¥–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (—á—Ç–æ–±—ã –Ω–µ –≤—ã–ª–∞–≤–ª–∏–≤–∞—Ç—å –≤—Å–µ –≤—ã–∑–æ–≤—ã —Å—Ä–∞–∑—É)
		function updateUnreadBadge(n) { setUnread(n ?? unreadCount); }
	let lastSeenAt = null;
    let columnSettings = {
		client: true,
		clientStatus: true,
		channel: true,
		ticketId: true,
		business: true,
		location: true,
		problem: true,
		responsible: true,
		status: true,
		date: true,
		time: true,
		actions: true
    };
	let lastRenderedAt = null;     // ISO-–≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
	let unreadCountValue = 0;           // —Å—á—ë—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –≤–æ –≤—Ä–µ–º—è –æ—Ç–∫—Ä—ã—Ç–æ–π –º–æ–¥–∞–ª–∫–∏
	let historyModalIsOpen = false;
	    let historyHasFocus = true;    // —Ñ–æ–∫—É—Å –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏
        let unreadCountByTicket = JSON.parse(localStorage.getItem('unreadCountByTicket') || '{}');     // { [ticketId]: number }
        function getTicketById(ticketId) {
          const id = String(ticketId);
          return window.allTickets?.find(t => String(t.ticket_id) === id)
                || window.filteredTickets?.find(t => String(t.ticket_id) === id)
                || null;
        }
		        function shouldDisplayUnreadBadge(ticket, overrideStatus) {
          if (!ticket) return true;
          const resolvedBy = String(ticket.resolved_by || '').toLowerCase();
          const autoClosed = resolvedBy.includes('–∞–≤—Ç–æ') || resolvedBy.includes('auto');
          if (autoClosed) return true;

          const rawStatus = String(ticket.raw_status || '').toLowerCase();
          const humanStatus = String(overrideStatus || ticket.status || '').toLowerCase();
          const resolvedStatuses = ['resolved', 'closed'];
          const isResolvedRaw = resolvedStatuses.includes(rawStatus);
          const isResolvedHuman = humanStatus.includes('—Ä–µ—à–µ–Ω–æ') || humanStatus.includes('–∑–∞–∫—Ä—ã—Ç') || humanStatus.includes('resolved') || humanStatus.includes('closed');
          return !(isResolvedRaw || isResolvedHuman);
        }
        const unreadFetchQueue = [];
        const unreadFetchInFlight = new Map();
        const unreadFetchTimestamps = new Map();
        const MAX_CONCURRENT_UNREAD_FETCHES = 2;
                function setTicketUnread(ticketId, n) {
          const key = String(ticketId);
          // –û–±–Ω–æ–≤–ª—è–µ–º –≤ —Ç–∞–±–ª–∏—Ü–µ –∑–∞—è–≤–æ–∫
          const badgeInTable = document.querySelector(`.unread-badge[data-ticket="${key}"]`);
          if (badgeInTable) {
                n = Math.max(0, n | 0);
                badgeInTable.textContent = String(n);
                const ticketData = getTicketById(ticketId);
                const canShowUnread = shouldDisplayUnreadBadge(ticketData);
                badgeInTable.style.display = (n > 0 && canShowUnread) ? 'inline-flex' : 'none';
          }

          // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –∏—Å—Ç–æ—Ä–∏–∏ (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ)
          const badgeInHistory = document.getElementById('unreadBadge');
          if (badgeInHistory && String(currentTicketId) === key) {
                badgeInHistory.textContent = String(n);
                badgeInHistory.classList.toggle('d-none', n === 0);
          }

          unreadCountByTicket[key] = Math.max(0, n | 0);
          // üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                localStorage.setItem('unreadCountByTicket', JSON.stringify(unreadCountByTicket));
        }
        function recalcTicketUnreadFromDOM(ticketId) {
          const lastRead = lastReadAtByTicket[ticketId] || 0;
          let count = 0;

          // –ï—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏—è –æ—Ç–∫—Ä—ã—Ç–∞ ‚Äî —Å—á–∏—Ç–∞–µ–º –ø–æ DOM
	  if (currentTicketId == ticketId) {
		const content = document.getElementById('historyContent');
		if (content) {
		  content.querySelectorAll('.chat-bubble.from-user').forEach(b => {
			const ts = Number(b.dataset.ts) || 0;
			if (ts > lastRead) count++;
		  });
		}
	  } else {
		// –ï—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏—è –Ω–µ –æ—Ç–∫—Ä—ã—Ç–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
		count = unreadCountByTicket[ticketId] || 0;
	  }

	  setTicketUnread(ticketId, count);
	  
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ
          localStorage.setItem('unreadCountByTicket', JSON.stringify(unreadCountByTicket));
        }

        function refreshUnreadIndicators(scheduleFetch = true) {
          allTickets.forEach(ticket => {
                if (!ticket || ticket.ticket_id == null) return;
                const ticketId = String(ticket.ticket_id);

                if (String(currentTicketId) === ticketId) {
                  recalcTicketUnreadFromDOM(ticketId);
                } else {
                  const saved = unreadCountByTicket[ticketId];
                  setTicketUnread(ticketId, saved == null ? 0 : saved);
                }

                if (scheduleFetch) {
                  scheduleUnreadUpdate(ticket);
                }
          });
        }

	// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤
function saveColumnWidths() {
  const widths = {};
  document.querySelectorAll('th[data-column]').forEach(th => {
    const column = th.getAttribute('data-column');
    widths[column] = th.style.width || getComputedStyle(th).width;
  });
  localStorage.setItem('columnWidths', JSON.stringify(widths));
}

function isAtBottom(el) {
  return (el.scrollHeight - el.scrollTop - el.clientHeight) < 4;
}

function scrollToBottom(el) {
  el.scrollTop = el.scrollHeight;
}

// === –ü–ª–∞–≤–∞—é—â–∏–µ –∫–Ω–æ–ø–∫–∏ —Å–∫—Ä–æ–ª–ª–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏ ===
function ensureHistoryScrollButtons() {
  const content = document.getElementById('historyContent');
  if (!content) return;

  // –†–æ–¥–∏—Ç–µ–ª—å ‚Äî —Ö–æ—Å—Ç –¥–ª—è –æ–≤–µ—Ä–ª–µ—è (–Ω–µ —Å–∫—Ä–æ–ª–ª–∏—Ç—Å—è)
  const host = content.closest('.history-pane') || content.parentElement;
  if (!host) return;

  // –î–µ–ª–∞–µ–º –µ–≥–æ —è–∫–æ—Ä–µ–º –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
  host.classList.add('history-viewport');
  if (getComputedStyle(host).position === 'static') {
    host.style.position = 'relative';
  }

  // –ï—Å–ª–∏ –∫–Ω–æ–ø–æ–∫ –µ—â—ë –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º –∏—Ö –≤ host (–∞ –Ω–µ –≤ content!)
  if (!host.querySelector('.history-scroll-btn.top')) {
    const topBtn = document.createElement('button');
    topBtn.type = 'button';
    topBtn.className = 'history-scroll-btn top';
    topBtn.title = '–í–≤–µ—Ä—Ö —Å–ø–∏—Å–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π';
    topBtn.innerText = '‚¨ÜÔ∏è';
    topBtn.addEventListener('click', () => {
      content.scrollTo({ top: 0, behavior: 'smooth' });
    });
    host.appendChild(topBtn);
  }

  if (!host.querySelector('.history-scroll-btn.bottom')) {
    const bottomBtn = document.createElement('button');
    bottomBtn.type = 'button';
    bottomBtn.className = 'history-scroll-btn bottom';
    bottomBtn.title = '–í–Ω–∏–∑ —Å–ø–∏—Å–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π';
    bottomBtn.innerText = '‚¨áÔ∏è';
    bottomBtn.addEventListener('click', () => {
	  content.scrollTo({ top: content.scrollHeight, behavior: 'smooth' });
	  // —Ñ–∏–∫—Å–∏—Ä—É–µ–º ¬´–ø—Ä–æ—á–∏—Ç–∞–Ω–æ¬ª
	  lastSeenAt = new Date();
	  lastReadAtByTicket[currentTicketId] = Date.now();
	  localStorage.setItem('lastReadAtByTicket', JSON.stringify(lastReadAtByTicket));
	  setUnread(0);
	  setTicketUnread(currentTicketId, 0);
	});
    host.appendChild(bottomBtn);
  }

  // –û–±–Ω–æ–≤–ª—è—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ–ª–æ–∂–µ–Ω–∏—è —Å–∫—Ä–æ–ª–ª–∞
	const updateBtns = () => {
		const topBtn = host.querySelector('.history-scroll-btn.top');
		const bottomBtn = host.querySelector('.history-scroll-btn.bottom');
		if (!topBtn || !bottomBtn) return;

		const atTop = content.scrollTop <= 0;
		const atBottom = content.scrollHeight - content.clientHeight - content.scrollTop <= 10;

		topBtn.style.visibility = atTop ? 'hidden' : 'visible';
		bottomBtn.style.visibility = atBottom ? 'hidden' : 'visible';
		// –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∑–∞–∑–æ—Ä –æ—Ç –∑–æ–Ω—ã –≤–≤–æ–¥–∞
		const sendArea = host.querySelector('.input-group-send');
		// --- –°–æ–æ–±—â–∞–µ–º CSS —Ñ–∞–∫—Ç–∏—á–µ—Å–∫—É—é –≤—ã—Å–æ—Ç—É –ø–∞–Ω–µ–ª–∏ –≤–≤–æ–¥–∞ (–¥–ª—è padding-bottom –∏—Å—Ç–æ—Ä–∏–∏)
			if (sendArea) {
			  const updateSendH = () => host.style.setProperty('--send-h', sendArea.offsetHeight + 'px');
			  updateSendH();

			  // –°–ª–µ–¥–∏–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤—ã—Å–æ—Ç—ã (–ø–µ—Ä–µ—Ä–∞–∑–º–µ—Ä textarea, –∞–¥–∞–ø—Ç–∏–≤ –∏ —Ç.–ø.)
			  try {
				const ro = new ResizeObserver(updateSendH);
				ro.observe(sendArea);
			  } catch (e) {
				// Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
				window.addEventListener('resize', updateSendH);
			  }
			}
		const pad = (sendArea?.offsetHeight || 0) + 9; // 6px –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ
		bottomBtn.style.bottom = pad + 'px';
	};

	  // –Ω–∞–≤–µ—à–∏–≤–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑
	  if (!content._scrollBtnsBound) {
		content.addEventListener('scroll', updateBtns, { passive: true });
		content._scrollBtnsBound = true;
	  }
	  updateBtns();
	}

	// –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å —á—Ç–µ–Ω–∏—è
	let io;                          // IntersectionObserver
	const observedBubbles = new WeakSet();

	function setupReadObserver() {
	  const chatEl = document.getElementById('historyContent');
	  if (!chatEl) return;
	  if (io) io.disconnect();

	  io = new IntersectionObserver((entries) => {
		let maxTs = lastReadAtByTicket[currentTicketId] || 0;
		let changed = false;

		entries.forEach(e => {
		  if (!e.isIntersecting) return;
		  const el = e.target;
		  // –ù–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç —Ç–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –ø—É–∑—ã—Ä–∏
		  if (!el.classList.contains('from-user')) return;

		  const ts = Number(el.dataset.ts) || 0;
		  if (ts > maxTs) { maxTs = ts; changed = true; }
		});

		if (changed) {
		  // –û–±–Ω–æ–≤–ª—è–µ–º ¬´–ø—Ä–æ—á–∏—Ç–∞–Ω–æ –¥–æ¬ª –ø–æ —Ç–∏–∫–µ—Ç—É
		  lastReadAtByTicket[currentTicketId] = maxTs;
		  localStorage.setItem('lastReadAtByTicket', JSON.stringify(lastReadAtByTicket));

		  // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ: –≤—Å–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —Å ts > maxTs
		  const chatEl = document.getElementById('historyContent');
		  let count = 0;
		  chatEl.querySelectorAll('.chat-bubble.from-user').forEach(b => {
			const ts = Number(b.dataset.ts) || 0;
			if (ts > maxTs) count++;
		  });
		  setUnread(count);
		}
	  }, { root: document.getElementById('historyContent'), threshold: 0.7 });
	}

	function watchUserBubbles() {
	  const chatEl = document.getElementById('historyContent');
	  if (!chatEl || !io) return;
	  chatEl.querySelectorAll('.chat-bubble.from-user').forEach(b => {
		if (!observedBubbles.has(b)) {
		  io.observe(b);
		  observedBubbles.add(b);
		}
	  });
	}

	function tzOffsetMinutes(tz, at = new Date()) {
	  try {
		const parts = new Intl.DateTimeFormat('en-US', {
		  timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit',
		  hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false
		}).formatToParts(at).reduce((o,p)=>{o[p.type]=p.value; return o;}, {});
		const asUTC = Date.UTC(+parts.year, +parts.month - 1, +parts.day, +parts.hour, +parts.minute, +parts.second);
		return Math.round((asUTC - at.getTime()) / 60000);
    } catch (error) { return 0; }
	}

		
	function normalizeToISO(x) {
	  if (x == null) return new Date().toISOString();
	  if (typeof x === 'number') {
		const ms = x < 1e12 ? x * 1000 : x;
		return new Date(ms).toISOString();
	  }
	  if (typeof x === 'string') {
		const s = x.trim();
		// –£–∂–µ ISO —Å Z –∏–ª–∏ —Å–º–µ—â–µ–Ω–∏–µ–º ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –µ—Å—Ç—å
		if (/[zZ]$/.test(s) || /[+-]\d{2}:\d{2}$/.test(s)) {
		  const d = new Date(s);
		  return isNaN(d) ? new Date().toISOString() : d.toISOString();
		}
		// –ë–µ–∑ —Ç–∞–π–º–∑–æ–Ω—ã ‚Äî —Å—á–∏—Ç–∞–µ–º UTC (–≤—Å–µ –≤—Ä–µ–º–µ–Ω–∞ –≤ –ë–î —Ö—Ä–∞–Ω—è—Ç—Å—è –∫–∞–∫ UTC)
		if (/^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}$/.test(s)) {
		  const norm = s.replace(' ', 'T') + 'Z';
		  const d = new Date(norm);
		  return isNaN(d) ? new Date().toISOString() : d.toISOString();
		}
		// –ò–Ω–æ–µ ‚Äî –¥–∞—ë–º JS —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å
		const d = new Date(s);
		return isNaN(d) ? new Date().toISOString() : d.toISOString();
	  }
	  return new Date().toISOString();
	}

        function sortMessagesStable(arr) {
          return arr.sort((a, b) => {
                const ta = sortTsMs(a), tb = sortTsMs(b);
                if (ta !== tb) return ta - tb;

                // –¥–∞–ª—å—à–µ ‚Äî –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–æ–≥–æ–Ω—è—é—â–∏–µ –∫–ª—é—á–∏
                const ma = Number(telegramMid(a) ?? 0);
                const mb = Number(telegramMid(b) ?? 0);
                if (ma && mb && ma !== mb) return ma - mb;

                const ka = msgKey(a);
                const kb = msgKey(b);
                return ka.localeCompare(kb);
          });
        }

        function scheduleUnreadUpdate(ticket) {
          if (!ticket || ticket.ticket_id == null) return;

          const ticketId = String(ticket.ticket_id);
          if (historyModalIsOpen && String(currentTicketId) === ticketId) return;

          const lastSenderRaw = ticket.last_sender ?? ticket.last_sender_type ?? ticket.last_message_sender ?? ticket.last_message_from ?? ticket.last_author ?? '';
          const lastSender = String(lastSenderRaw || '').toLowerCase().trim();
          const direction = String(ticket.last_message_direction || ticket.direction || ticket.last_direction || ticket.last_message_side || '').toLowerCase().trim();

          const fromSupport = isSupportSenderLabel(lastSenderRaw) || ['out','outgoing','support','operator'].includes(direction);
          if (fromSupport) return;

          const fromUser = isUserSenderLabel(lastSenderRaw) || ['in','incoming','user','client','customer'].includes(direction);
          if (!fromUser && !lastSender && !direction) {
            // –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è ‚Äî –≤—Å—ë —Ä–∞–≤–Ω–æ –¥–µ–ª–∞–µ–º –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å
          }

          const now = Date.now();
          if (unreadFetchInFlight.has(ticketId)) return;
          if (unreadFetchQueue.some(item => String(item.ticket.ticket_id) === ticketId)) return;

          const lastFetch = unreadFetchTimestamps.get(ticketId) || 0;
          if (now - lastFetch < 5000) return;

          unreadFetchQueue.push({ ticket });
          processUnreadFetchQueue();
        }

        function processUnreadFetchQueue() {
          if (unreadFetchInFlight.size >= MAX_CONCURRENT_UNREAD_FETCHES) return;

          const next = unreadFetchQueue.shift();
          if (!next) return;

          const ticketId = String(next.ticket.ticket_id);
          const promise = requestUnreadCountForTicket(next.ticket)
            .catch(err => {
              console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞—è–≤–∫–∏', ticketId, err);
            })
            .finally(() => {
              unreadFetchInFlight.delete(ticketId);
              unreadFetchTimestamps.set(ticketId, Date.now());
              processUnreadFetchQueue();
            });

          unreadFetchInFlight.set(ticketId, promise);
        }

        async function requestUnreadCountForTicket(ticket) {
          const ticketId = String(ticket.ticket_id);
          const params = new URLSearchParams({
            ticket_id: ticketId,
            _: String(Date.now())
          });

          if (ticket.channel_id != null && ticket.channel_id !== '' && ticket.channel_id !== 'null') {
            params.set('channel_id', String(ticket.channel_id));
          }

          const resp = await fetch(`/history?${params.toString()}`, { cache: 'no-store' });
          if (!resp.ok) {
            throw new Error(`HTTP ${resp.status}`);
          }

          const data = await resp.json();
          if (data && data.success === false) {
            throw new Error(data.error || 'history response error');
          }
          const messages = Array.isArray(data.messages) ? data.messages : [];
          const lastRead = lastReadAtByTicket[ticketId] || 0;

          let count = 0;

          for (const msg of messages) {
            const sender = String(msg.sender || '').toLowerCase();
            if (sender !== 'user') continue;

            const ts = Date.parse(normalizeToISO(msg.timestamp));
            if (!Number.isFinite(ts)) continue;

            if (ts > lastRead) count += 1;
          }

          setTicketUnread(ticketId, count);
        }

        function scheduleUnreadUpdate(ticket) {
          if (!ticket || ticket.ticket_id == null) return;

          const ticketId = String(ticket.ticket_id);
          if (historyModalIsOpen && String(currentTicketId) === ticketId) return;

          const lastSender = String(ticket.last_sender || '').toLowerCase();
          if (lastSender !== 'user') return;

          const now = Date.now();
          if (unreadFetchInFlight.has(ticketId)) return;
          if (unreadFetchQueue.some(item => String(item.ticket.ticket_id) === ticketId)) return;

          const lastFetch = unreadFetchTimestamps.get(ticketId) || 0;
          if (now - lastFetch < 5000) return;

          unreadFetchQueue.push({ ticket });
          processUnreadFetchQueue();
        }

        function processUnreadFetchQueue() {
          if (unreadFetchInFlight.size >= MAX_CONCURRENT_UNREAD_FETCHES) return;

          const next = unreadFetchQueue.shift();
          if (!next) return;

          const ticketId = String(next.ticket.ticket_id);
          const promise = requestUnreadCountForTicket(next.ticket)
            .catch(err => {
              console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞—è–≤–∫–∏', ticketId, err);
            })
            .finally(() => {
              unreadFetchInFlight.delete(ticketId);
              unreadFetchTimestamps.set(ticketId, Date.now());
              processUnreadFetchQueue();
            });

          unreadFetchInFlight.set(ticketId, promise);
        }

        async function requestUnreadCountForTicket(ticket) {
          const ticketId = String(ticket.ticket_id);
          const params = new URLSearchParams({
            ticket_id: ticketId,
            _: String(Date.now())
          });

          if (ticket.channel_id != null && ticket.channel_id !== '' && ticket.channel_id !== 'null') {
            params.set('channel_id', String(ticket.channel_id));
          }

          const resp = await fetch(`/history?${params.toString()}`, { cache: 'no-store' });
          if (!resp.ok) {
            throw new Error(`HTTP ${resp.status}`);
          }

          const data = await resp.json();
          if (data && data.success === false) {
            throw new Error(data.error || 'history response error');
          }
          const messages = Array.isArray(data.messages) ? data.messages : [];
          const lastRead = lastReadAtByTicket[ticketId] || 0;

          let count = 0;

          for (const msg of messages) {
            const sender = String(msg.sender || '').toLowerCase();
            if (sender !== 'user') continue;

            const ts = Date.parse(normalizeToISO(msg.timestamp));
            if (!Number.isFinite(ts)) continue;

            if (ts > lastRead) count += 1;
          }

          setTicketUnread(ticketId, count);
        }

function displayTicketDateTime(t) {
  // –±–µ—Ä—ë–º –ø–∞—Ä—É –ø–æ–ª–µ–π, –∫–∞–∫ —Å–µ–π—á–∞—Å —Ä–∏—Å—É–µ—à—å —Ç–∞–±–ª–∏—Ü—É; –µ—Å–ª–∏ –µ—Å—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã ‚Äî —Ç–æ–∂–µ –ø—Ä–æ–±—É–µ–º
  const base = (t.created_date && t.created_time)
    ? `${t.created_date} ${t.created_time}`
    : (t.created_at || t.updated_at || t.last_message_at || null);

  if (!base) return { date: '‚Äî', time: '‚Äî' };

  const iso = normalizeToISO(base);   // —É—á—Ç—ë—Ç –ª–æ–∫–∞–ª—å —Å–µ—Ä–≤–µ—Ä–∞ –∏ –≤–µ—Ä–Ω—ë—Ç UTC ISO
  const formatted = fmtTsISO(iso);    // —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ø–æ–¥ –≤—ã–±—Ä–∞–Ω–Ω—É—é TZ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞, –Ω–∞–ø—Ä. "26.09.2025, 13:45:12"
  const [date, time] = formatted.split(',').map(s => s.trim());
  return { date: date || '‚Äî', time: time || '‚Äî' };
}

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
function renderMessagesHTML(ticket_id, messages, clientData) {
  return (messages || []).map(msg => {
    const rawSender = String(msg.sender || '').toLowerCase().trim();
    const isSupport =
      ['support','operator','admin','–ø–æ–¥–¥–µ—Ä–∂–∫–∞','–æ–ø–µ—Ä–∞—Ç–æ—Ä','staff','agent'].includes(rawSender) ||
      msg.is_support === true ||
      msg.from_support === true ||
      msg.is_outgoing === true ||
      msg.sender_type === 'support' ||
      msg.direction === 'out' ||
      msg.sender === 'support';

    const cls  = isSupport ? 'from-support' : 'from-user';
    let name   = isSupport ? 'üõ† –ü–æ–¥–¥–µ—Ä–∂–∫–∞' : 'üë§ –ö–ª–∏–µ–Ω—Ç';

	const tsRaw = (msg.timestamp ?? msg.date ?? msg.created_at ?? msg.createdAt ?? null);
	const isMedia = !!(msg.message_type && msg.message_type !== 'text' && msg.attachment);
	const iso   = normalizeToISO(tsRaw, isMedia);
	const time  = fmtTsISO(iso);                 // –ø—Ä–∏–º–µ–Ω–∏—Ç —Ç–µ–∫—É—â—É—é TZ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
	const tsMs  = Date.parse(iso);               // –¥–ª—è data-ts

    const bodyText = (msg.message ?? msg.text ?? msg.body ?? '').toString();

    // –ò–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
    if (!isSupport) {
      const clientName = clientData?.client_name;
      const username   = clientData?.username;
      if (clientName && clientName !== '–Ω–µ –∑–∞–¥–∞–Ω–æ') name = 'üë§ ' + clientName;
      else if (username) name = 'üë§ @' + username;
      else name = 'üë§ –ö–ª–∏–µ–Ω—Ç';
    } else {
      name = msg.sender_name || 'üõ† –ü–æ–¥–¥–µ—Ä–∂–∫–∞';
    }

    let mediaHtml = '';
    if (msg.message_type && msg.message_type !== 'text' && msg.attachment) {
      mediaHtml = createMediaHtml(ticket_id, {
        message_type: msg.message_type,
        attachment: msg.attachment,
        text: bodyText
      });
    }

    return `
      <div class="chat-bubble ${cls} ${msg.deleted_at ? 'opacity-50' : ''}"
         data-sender="${isSupport ? 'support' : 'user'}"
         data-ts="${tsMs}"
         data-tg-id="${safeId(msg) ?? ''}"
         data-mid="${telegramMid(msg) ?? ''}">
        <div class="bubble-meta">
          <small class="msg-time" data-iso="${iso}">${fmtTsISO(iso)}</small>
          <div class="bubble-actions dropdown">
            <button class="btn btn-sm btn-light p-1 px-2" data-bs-toggle="dropdown" aria-expanded="false"
                    title="–î–µ–π—Å—Ç–≤–∏—è" style="line-height:1">‚ãØ</button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><button class="dropdown-item action-reply">‚Ü© –û—Ç–≤–µ—Ç–∏—Ç—å</button></li>
              ${isSupport ? `
                <li><button class="dropdown-item action-edit">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button></li>
                <li><button class="dropdown-item text-danger action-delete">üóë –£–¥–∞–ª–∏—Ç—å</button></li>
                <li><hr class="dropdown-divider"></li>
                <li><button class="dropdown-item action-download">‚§ì –°–∫–∞—á–∞—Ç—å –≤–ª–æ–∂–µ–Ω–∏–µ</button></li>
              ` : `
                <li><button class="dropdown-item action-download">‚§ì –°–∫–∞—á–∞—Ç—å –≤–ª–æ–∂–µ–Ω–∏–µ</button></li>
              `}
            </ul>
          </div>
        </div>
        <strong class="msg-author">${name}</strong>
                ${msg.edited_at ? `<span class="badge-meta">–∏–∑–º–µ–Ω–µ–Ω–æ</span>` : ``}
                ${msg.deleted_at ? `<span class="badge-meta">—É–¥–∞–ª–µ–Ω–æ —É –∫–ª–∏–µ–Ω—Ç–∞</span>` : ``}

        ${(msg.reply_preview || msg.reply_to_tg_id) ? `
		  <div
			class="reply-preview rp-jump"
			data-target="${msg.reply_to_tg_id || ''}"
			title="–ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"
			style="cursor:pointer"
		  >
			<div class="rp-box">${escapeHtml(msg.reply_preview || '').replace(/\n/g,'<br>')}</div>
		  </div>
		` : ''}
	
        ${bodyText && (!msg.message_type || msg.message_type === 'text')
          ? `<p class="msg-text mb-1">${escapeHtml(bodyText).replace(/\n/g,'<br>')}</p>`
          : ''}

        ${mediaHtml}

      </div>
    `;
  }).join('');
}

function escapeHtml(s=''){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));}

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤
function restoreColumnWidths() {
  const savedWidths = localStorage.getItem('columnWidths');
  if (savedWidths) {
    const widths = JSON.parse(savedWidths);
    Object.keys(widths).forEach(column => {
      const th = document.querySelector(`th[data-column="${column}"]`);
      if (th && widths[column]) {
        th.style.width = widths[column];
        const index = Array.from(th.parentNode.children).indexOf(th);
        document.querySelectorAll('#ticketsBody tr').forEach(row => {
          const cell = row.children[index];
          if (cell) cell.style.width = widths[column];
        });
      }
    });
  }
}
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å—Ç–æ–ª–±—Ü–æ–≤
    const savedColumnSettings = localStorage.getItem('columnSettings');
    if (savedColumnSettings) {
      columnSettings = JSON.parse(savedColumnSettings);
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    const savedPageSize = localStorage.getItem('pageSize');
    if (savedPageSize) {
      currentPageSize = parseInt(savedPageSize);
      document.getElementById('pageSize').value = currentPageSize;
    }

    // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è resize —Å—Ç–æ–ª–±—Ü–æ–≤ ===
function initColumnResize() {
  const headers = document.querySelectorAll('th[data-resizable="true"]');
  headers.forEach(header => {
    const oldHandle = header.querySelector('.resize-handle');
    if (oldHandle) {
      oldHandle.remove();
    }
    
    const handle = document.createElement('div');
    handle.className = 'resize-handle';
    header.appendChild(handle);
    
    let startX, startWidth;
    
    handle.addEventListener('mousedown', function(e) {
  // 1) –ñ—ë—Å—Ç–∫–æ —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é —à–∏—Ä–∏–Ω—É –≤ –ø–∏–∫—Å–µ–ª—è—Ö, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø–µ—Ä–µ—Å—á—ë—Ç–∞ –∏ ¬´—Å–∫–∞—á–∫–∞¬ª
  const computed = getComputedStyle(header).width;
  header.style.width = computed;

  // 2) –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∫–ª–µ—Ç–∫–∏ tbody
  const index = Array.from(header.parentNode.children).indexOf(header);
  document.querySelectorAll('#ticketsBody tr').forEach(row => {
    const cell = row.children[index];
    if (cell) cell.style.width = computed;
  });

  startX = e.pageX;
  startWidth = parseFloat(computed);
  document.documentElement.classList.add('resizing');

  function onMouseMove(e) {
    const width = startWidth + (e.pageX - startX);
    if (width > 50) {
      header.style.width = width + 'px';
      const idx = Array.from(header.parentNode.children).indexOf(header);
      document.querySelectorAll('#ticketsBody tr').forEach(row => {
        const cell = row.children[idx];
        if (cell) cell.style.width = width + 'px';
      });
    }
  }

  function onMouseUp() {
    document.removeEventListener('mousemove', onMouseMove);
    document.removeEventListener('mouseup', onMouseUp);
    document.documentElement.classList.remove('resizing');
    saveColumnWidths();
  }

  document.addEventListener('mousemove', onMouseMove);
  document.addEventListener('mouseup', onMouseUp);
  e.preventDefault();
});

  });

    }

    // === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ ===
    function toggleColumnSettings() {
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤
      Object.keys(columnSettings).forEach(key => {
        const checkbox = document.getElementById(`toggle${key.charAt(0).toUpperCase() + key.slice(1)}`);
        if (checkbox) {
          checkbox.checked = columnSettings[key];
        }
      });
      new bootstrap.Modal(document.getElementById('columnSettingsModal')).show();
    }

    function applyColumnSettings() {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    Object.keys(columnSettings).forEach(key => {
        const checkbox = document.getElementById(`toggle${key.charAt(0).toUpperCase() + key.slice(1)}`);
        if (checkbox) {
            columnSettings[key] = checkbox.checked;
        }
    });
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ localStorage
    localStorage.setItem('columnSettings', JSON.stringify(columnSettings));
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ —Ç–∞–±–ª–∏—Ü–µ
    document.querySelectorAll('th[data-column]').forEach(th => {
        const column = th.getAttribute('data-column');
        const index = Array.from(th.parentNode.children).indexOf(th);
        
        if (columnSettings[column]) {
            th.classList.remove('table-column-hidden');
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫—É –≤ —Ç–µ–ª–µ —Ç–∞–±–ª–∏—Ü—ã
            document.querySelectorAll('#ticketsBody tr').forEach(row => {
                if (row.children[index]) {
                    row.children[index].classList.remove('table-column-hidden');
                }
            });
        } else {
            th.classList.add('table-column-hidden');
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫—É –≤ —Ç–µ–ª–µ —Ç–∞–±–ª–∏—Ü—ã
            document.querySelectorAll('#ticketsBody tr').forEach(row => {
                if (row.children[index]) {
                    row.children[index].classList.add('table-column-hidden');
                }
            });
        }
    });
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    const modalElement = document.getElementById('columnSettingsModal');
    if (modalElement) {
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
        }
    }
}
    function applyColumnSettingsFromState() {
  // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ —à–∞–ø–∫–µ
  document.querySelectorAll('th[data-column]').forEach(th => {
    const column = th.getAttribute('data-column');
    const show = !!columnSettings[column];
    th.classList.toggle('table-column-hidden', !show);
  });

  // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫ —Ç–µ–ª—É —Ç–∞–±–ª–∏—Ü—ã
  const ths = Array.from(document.querySelectorAll('th[data-column]'));
  document.querySelectorAll('#ticketsBody tr').forEach(tr => {
    ths.forEach((th, idx) => {
      const column = th.getAttribute('data-column');
      const td = tr.children[idx];
      if (td) td.classList.toggle('table-column-hidden', !columnSettings[column]);
    });
  });
}

    // === –û—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –æ—Ç–≤–µ—Ç–∞ ===
    function openReplyModal(user_id) {
      currentUserId = user_id;
      document.getElementById('replyText').value = '';
      new bootstrap.Modal(document.getElementById('replyModal')).show();
    }

    // === –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π reply/edit) ===
		async function sendReply() {
		  const ta    = document.getElementById('replyText');
		  const text  = (ta?.value || '').trim();
		  const admin = getOperatorName();
		  if (!text) { alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞'); return; }

		  try {
			const resp = await fetch('/reply', {
			  method: 'POST',
			  headers: { 'Content-Type':'application/json' },
			  body: JSON.stringify({
				user_id:   currentUserId,
				ticket_id: currentTicketId,
				admin,
				text,
				reply_to_tg_id: (window.currentReplyToTgId || null)
			  })
			});

			const data = await resp.json();
			if (!data.success) {
			  if (typeof data.retry_after === 'number' && data.retry_after > 0) {
				alert(`‚è≥ –õ–∏–º–∏—Ç Telegram. –ü–æ–¥–æ–∂–¥–∏—Ç–µ ${data.retry_after} —Å–µ–∫ –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∫—É.`);
				return;
			  }
			  throw new Error(data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
			}

			if (data.reopened) {
			  markTicketReopenedLocally();
			  try { await autoRefreshTickets(); } catch(e) {}
			  document.getElementById('closeTicketBtn')?.removeAttribute('disabled');
			  if (typeof showToast === 'function') showToast('–ó–∞—è–≤–∫–∞ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∞');
			}

			window.currentReplyToTgId = null;
			window.currentEditTgId = null;
			if (typeof updateHistory === 'function') {
			  await updateHistory();
			  const container = document.getElementById('historyContent');
			  if (container) container.scrollTop = container.scrollHeight;
			}
			if (ta) ta.value = '';
		  } catch (e) {
			alert('‚ùå ' + e.message);
		  }
		}

	// === –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: —Ö—Ä–∞–Ω–µ–Ω–∏–µ, –æ—Ç—Ä–∏—Å–æ–≤–∫–∞, –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ===
		function getSendMode() {
		  return localStorage.getItem('sendKeySetting') || 'enter';
		}
		function setSendMode(mode) {
		  localStorage.setItem('sendKeySetting', mode);
		  syncSendUI(mode);
		}

		// –û–±–Ω–æ–≤–ª—è–µ—Ç –±–µ–π–¥–∂ –Ω–∞ –∫–Ω–æ–ø–∫–µ –∏ –∞–∫—Ç–∏–≤–Ω—ã–π –ø—É–Ω–∫—Ç –º–µ–Ω—é
		function syncSendUI(mode) {
		  const labelMap = {
			enter: 'Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å',
			ctrlEnter: 'Ctrl+Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å',
			enterNewline: 'Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞'
		  };
		  const shortMap = {
			enter: 'Enter',
			ctrlEnter: 'Ctrl+Enter',
			enterNewline: 'Enter‚Üµ'
		  };
			const hint = document.getElementById('sendKeySettingCurrent');
			if (hint) hint.textContent = labelMap[mode] || '‚Äî';

		  document.querySelectorAll('#sendKeySetting .dropdown-menu .dropdown-item')
			.forEach(a => {
			  const m = a.getAttribute('data-mode');
			  a.classList.toggle('active', m === mode);
			  // –û–±–Ω–æ–≤–∏–º –ø–æ–¥–ø–∏—Å–∏ –Ω–∞ —Å–ª—É—á–∞–π –±—É–¥—É—â–∏—Ö –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–π
			  if (labelMap[m]) a.lastChild.nodeValue = ' ' + labelMap[m];
			});
		}

		// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∫—Ä–∏–ø—Ç–∞
		(function initSendKeySettings() {
		  const mode = getSendMode();
		  syncSendUI(mode);

		  // –ö–ª–∏–∫ –ø–æ –ø—É–Ω–∫—Ç–∞–º –º–µ–Ω—é
		  document.querySelectorAll('#sendKeySetting .dropdown-menu .dropdown-item')
			.forEach(a => {
			  a.addEventListener('click', (e) => {
				e.preventDefault();
				const nextMode = a.getAttribute('data-mode');
				setSendMode(nextMode);
			  });
			});

		  // –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –¥—Ä–æ–ø–¥–∞—É–Ω–∞ ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
		  const btn = document.getElementById('sendKeySettingBtn');
		  if (btn) {
			btn.addEventListener('show.bs.dropdown', () => syncSendUI(getSendMode()));
		  }

		  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à –≤ textarea –∏—Å—Ç–æ—Ä–∏–∏
		  const ta = document.getElementById('replyTextInHistory');
		  const sendBtn = document.getElementById('sendReplyInHistory');
			if (ta && sendBtn) {
				ta.addEventListener('keydown', (e) => {
				  const m = getSendMode();
				  const isEnter = (e.key === 'Enter');
				  const isCtrl = (e.ctrlKey || e.metaKey); // –ø–æ–¥–¥–µ—Ä–∂–∏–º Cmd –Ω–∞ Mac

				  if (m === 'enter' && isEnter && !isCtrl) {
					// Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
					e.preventDefault();
					sendBtn.click();
				  } else if (m === 'ctrlEnter' && isEnter && isCtrl) {
					// Ctrl+Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
					e.preventDefault();
					sendBtn.click();
				  } else if (m === 'enterNewline' && isEnter && !isCtrl) {
					// Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ (–Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–Ω–æ—Å)
					// –ù–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º ¬´–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é¬ª –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
					// e.preventDefault();  // –Ω–µ —Ç—Ä–æ–≥–∞–µ–º, –ø—É—Å—Ç—å –≤—Å—Ç–∞–≤–ª—è–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å
				  }
				});
			}
		})();

    
    // === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ ===
    document.querySelectorAll('#sendKeySettingBtn + .dropdown-menu a').forEach(item => {
      item.addEventListener('click', function (e) {
        e.preventDefault();
        const mode = this.getAttribute('data-mode');
        localStorage.setItem('sendKeySetting', mode);
        setSendMode(mode);
      });
    });

	// === –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü–∞ ===
	async function autoRefreshTickets() {
		try {
			const responseStats = await fetch('/stats_data');
			const data = await responseStats.json();

			const totalEl = document.getElementById('total');
			const pendingEl = document.getElementById('pending');
			const resolvedEl = document.getElementById('resolved');

			if (totalEl) totalEl.textContent = data.total || 0;
			if (pendingEl) pendingEl.textContent = data.pending || 0;
			if (resolvedEl) resolvedEl.textContent = data.resolved || 0;

			const responseTable = await fetch('/tickets_list');
			let tickets = await responseTable.json(); // ‚Üê –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è tickets –æ–±—ä—è–≤–ª–µ–Ω–∞ –∑–¥–µ—Å—å

			// –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã –∫–ª–∏–µ–Ω—Ç–æ–≤
			const statuses = await loadClientStatuses();
			tickets = tickets.map(t => ({
				...t,
				client_status: (statuses?.[t.user_id] ?? t.client_status ?? '‚Äî')
			}));

			console.log("üì© –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏:", tickets);

                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –∑–∞—è–≤–∫–∏ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
                        allTickets = tickets;

                        // –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã - –ø—Ä–∏–º–µ–Ω—è–µ–º –∏—Ö –∫–æ –≤—Å–µ–º –¥–∞–Ω–Ω—ã–º
                        if (window.filteredTickets) {
                                applyFilters(); // –ü–µ—Ä–µ–ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∫ –Ω–æ–≤—ã–º –¥–∞–Ω–Ω—ã–º
                        } else {
                                // –ò–Ω–∞—á–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ –∑–∞—è–≤–∫–∏ –∫–∞–∫ –æ–±—ã—á–Ω–æ
                                totalPages = Math.ceil(allTickets.length / currentPageSize);
                                displayTicketsForCurrentPage();
                                updatePagination();
                        }

                        refreshUnreadIndicators();

                } catch (e) {
                        console.error("‚ùå –û—à–∏–±–∫–∞ –≤ autoRefreshTickets:", e);
                }
        }

// === –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã ===
function displayTicketsForCurrentPage() {
  const container = document.getElementById('ticketsBody');
  if (!container) return;

  container.innerHTML = '';

  totalPages = ensureCurrentPageBounds(allTickets.length);
  persistCurrentPageIfUnfiltered();

  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  const startIndex = (currentPage - 1) * currentPageSize;
  const endIndex = Math.min(startIndex + currentPageSize, allTickets.length);
  
  // –ü–æ–ª—É—á–∞–µ–º –∑–∞—è–≤–∫–∏ –¥–ª—è —Ç–µ–∫—É—á–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  const pageTickets = allTickets.slice(startIndex, endIndex);
  
  if (pageTickets.length === 0) {
    container.innerHTML = '<tr><td colspan="12" class="text-center text-muted py-3">–ù–µ—Ç –∑–∞—è–≤–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td></tr>';
    return;
  }
  
  pageTickets.forEach(t => {
  const username = t.username ? `@${t.username}` : '–Ω–µ—Ç —é–∑–µ—Ä–Ω–µ–π–º–∞';
  const clientName = t.client_name || '–Ω–µ –∑–∞–¥–∞–Ω–æ';

  // –°–û–ó–î–ê–Å–ú –°–¢–†–û–ö–£
  const row = document.createElement('tr');

  // –ò–Ω–¥–µ–∫—Å –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (—Ç–æ, –ø–æ —á–µ–º—É —Ä–∞–±–æ—Ç–∞–µ—Ç applyFilters)
  const searchIndex = [
    String(t.user_id || ''),
    String(t.ticket_id || ''),
    String(t.client_status || ''),
    String(t.channel_name || ''),
    String(t.business || ''),
    String(t.city || ''),
    String(t.location_name || ''),
    String(t.problem || ''),
    String(t.responsible || ''),
    String(t.raw_status || ''),
    String(t.status || ''),
    String(t.created_date || ''),
    String(t.created_time || ''),
    String(t.username || ''),
    String(clientName || '')
  ].join(' ').toLowerCase();
  row.dataset.search = searchIndex;

  const clientCell = `
  <div class="d-flex align-items-center gap-2">
    <img src="${t.avatar_url || '/static/default-avatar.png'}" 
         alt="" 
         width="36" 
         height="36" 
         class="rounded-circle" 
         style="object-fit:cover; border:1px solid rgba(0,0,0,.08)"
         onerror="this.src='/static/default-avatar.png'">
    <span class="clickable-client" data-user-id="${t.user_id}" onclick="window.open('/client/${t.user_id}', '_blank')">${
      (t.client_name && t.client_name !== '–Ω–µ –∑–∞–¥–∞–Ω–æ') ? t.client_name :
      (t.username ? '@' + t.username : '–ö–ª–∏–µ–Ω—Ç ' + t.user_id)
    }</span>
  </div>`;

	let statusBadge;

	if (t.raw_status === 'resolved') {
	  statusBadge = `<span class="badge bg-success">‚úÖ –†–µ—à–µ–Ω–æ</span>`;
	} else {
	  if (t.status === '–ù–æ–≤–∞—è') {
		statusBadge = `<span class="badge bg-secondary">üÜï –ù–æ–≤–∞—è</span>`;
	  } else if (t.status === '–û–∂–∏–¥–∞–µ—Ç —Ä–µ–∞–∫—Ü–∏–∏') {
		statusBadge = `<span class="badge bg-danger">‚è≥ –û–∂–∏–¥–∞–µ—Ç —Ä–µ–∞–∫—Ü–∏–∏</span>`;
	  } else {
		statusBadge = `<span class="badge bg-info text-dark">‚è≥ –û–∂–∏–¥–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞</span>`;
	  }
	}

	// –°—á—ë—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö (—Å–ª–µ–≤–∞ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞)
		const unreadBadge = `<span class="badge bg-danger me-1 unread-badge" data-ticket="${t.ticket_id}" style="display:none;">0</span>`;
		statusBadge = unreadBadge + statusBadge;

  let businessClass = '';
  if (t.business === '–°—É—à–∏–í–µ—Å–ª–∞') businessClass = 'business-sushi';
  else if (t.business === '–ë–ª–∏–Ω–ë–µ—Ä–∏') businessClass = 'business-blin';

  // –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ (–±–µ–∑–æ–ø–∞—Å–Ω–æ –ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ JSON.stringify, —á—Ç–æ–±—ã –Ω–µ –ø–∞—Ä–∏—Ç—å—Å—è —Å –∫–∞–≤—ã—á–∫–∞–º–∏)
	const createTaskBtn = (t.linked_task_id)
	  ? `<button class="btn btn-sm btn-outline-primary open-task-btn" data-task-id="${t.linked_task_id}">
		   ‚ÑñDL_${t.linked_task_id}
		 </button>`
	  : `<button class="btn btn-sm btn-outline-primary create-task-btn"
		   data-problem="${(t.problem||'').replace(/"/g,'&quot;')}"
		   data-location="${(t.location_name||t.city||'').replace(/"/g,'&quot;')}"
		   data-ticket="${t.ticket_id}">
		   –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
		 </button>`;

	const actionBtns = (t.raw_status !== 'resolved')
	  ? `<button class="btn btn-sm btn-outline-secondary" onclick="loadHistory(${t.user_id}, '${t.ticket_id}')">–ò—Å—Ç–æ—Ä–∏—è</button>
		 ${createTaskBtn}
		 <button class="btn btn-sm btn-danger" onclick="confirmClose(${t.user_id}, '${t.ticket_id}')">–ó–∞–∫—Ä—ã—Ç—å</button>`
	  : `<button class="btn btn-sm btn-outline-secondary" onclick="loadHistory(${t.user_id}, '${t.ticket_id}')">–ò—Å—Ç–æ—Ä–∏—è</button>
		 ${createTaskBtn}`;

  let rowHTML = '';
	rowHTML += `<td>${clientCell}</td>`;
	rowHTML += `<td>${t.client_status || '‚Äî'}</td>`;
	rowHTML += `<td>${t.channel_name || '‚Äî'}</td>`;
	rowHTML += `<td><code>${t.ticket_id}</code></td>`;
	rowHTML += `<td class="${businessClass}">${t.business}</td>`;
	rowHTML += `<td>${t.city}<br><small>${t.location_name}</small></td>`;
	rowHTML += `<td>${t.problem}</td>`;
	rowHTML += `<td>${t.responsible}</td>`;
	rowHTML += `<td>${statusBadge}</td>`;
	const dt = displayTicketDateTime(t);
		rowHTML += `<td>${dt.date}</td>`;
		rowHTML += `<td>${dt.time}</td>`;
	rowHTML += `<td>${actionBtns}</td>`;
	row.innerHTML = rowHTML;
	container.appendChild(row);
		// --- –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –°–ß–Å–¢–ß–ò–ö–ê –ù–ï–ü–†–û–ß–ò–¢–ê–ù–ù–´–• –ü–†–ò –û–¢–†–ò–°–û–í–ö–ï ---
		let unread = 0;
		const lastRead = lastReadAtByTicket[t.ticket_id] || 0;
		if (unreadCountByTicket[t.ticket_id] !== undefined) {
		  unread = unreadCountByTicket[t.ticket_id];
		} else {
		  // –ï—Å–ª–∏ –≤–æ–æ–±—â–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö ‚Äî —Å—á–∏—Ç–∞–µ–º 0
		  unread = 0;
		}

                setTicketUnread(t.ticket_id, unread);
                scheduleUnreadUpdate(t);
                });
	parseEmojis(document.getElementById('ticketsBody'));
		applyColumnSettingsFromState();
		applyFilters();
		initColumnResize(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º resize –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
		}


	// === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ ===
	function updatePagination() {
	  const paginationContainer = document.getElementById('pagination');
	  if (!paginationContainer) return;
	  
	  paginationContainer.innerHTML = '';
	  
	  if (totalPages <= 1) return;
	  
	  // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
	  const prevLi = document.createElement('li');
	  prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
	  prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">&laquo;</a>`;
	  paginationContainer.appendChild(prevLi);
	  
	  // –ù—É–º–µ—Ä–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü
		const startPage = Math.max(1, currentPage - 2);
		const endPage = Math.min(totalPages, startPage + 4);
	  
		for (let i = startPage; i <= endPage; i++) {
			const pageLi = document.createElement('li');
			pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
			pageLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
			paginationContainer.appendChild(pageLi);
			}
			  
			  // –ö–Ω–æ–ø–∫–∞ "–í–ø–µ—Ä–µ–¥"
			  const nextLi = document.createElement('li');
			  nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
			  nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">&raquo;</a>`;
			  paginationContainer.appendChild(nextLi);
			}

			// === –°–º–µ–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ===
			function changePage(page) {
                          if (page < 1 || page > totalPages) return;

                          currentPage = page;
                          persistCurrentPageIfUnfiltered();
                          displayTicketsForCurrentPage();
                          updatePagination();
			  
			  // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –≤–µ—Ä—Ö—É —Ç–∞–±–ª–∏—Ü—ã
			  document.querySelector('.table-responsive').scrollIntoView({ behavior: 'smooth' });
			}

			// === –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –∑–∞—è–≤–æ–∫ ===
                                document.getElementById('pageSize')?.addEventListener('change', function() {
                                  currentPageSize = parseInt(this.value);
                                  localStorage.setItem('pageSize', currentPageSize);
                                  currentPage = 1; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                                  const sourceLength = window.filteredTickets ? window.filteredTickets.length : allTickets.length;
                                  totalPages = ensureCurrentPageBounds(sourceLength);
                                  persistCurrentPageIfUnfiltered();
                                  if (window.filteredTickets) {
                                        displayTicketsForCurrentPageFiltered();
                                        updatePaginationFiltered();
                                  } else {
                                        displayTicketsForCurrentPage();
                                        updatePagination();
                                  }
                                });
					// –ù–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å –¥—Ä–æ–ø–¥–∞—É–Ω—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ –ª–µ–π–±–ª—É/—á–µ–∫–±–æ–∫—Å—É (–∏—Å—Ç–æ—Ä–∏—è –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ)
						document.addEventListener('click', function(e) {
								  const menu = e.target.closest('.dropdown-menu');
								  if (!menu) return;
							
							// –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª–∏–∫ –ø–æ –º–∏–Ω–∏–∞—Ç—é—Ä–∞–º (—É —Ç–µ–±—è –∫–ª–∞—Å—Å .js-preview —É–∂–µ –ø—Ä–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è)
								document.addEventListener('click', (e) => {
								  const target = e.target.closest('.js-preview');
								  if (!target) return;
								  const full = target.getAttribute('data-fullsrc') || target.src;
								  const img = document.getElementById('imageViewerImg');
								  img.src = full;
								  new bootstrap.Modal(document.getElementById('imageViewerModal')).show();
								});
								document.addEventListener('click', function (e) {
								  const img = e.target.closest('.js-preview');
								  if (!img) return;	
								});
							// –ö–ª–∏–∫ –ø–æ –±–ª–æ–∫—É "–û—Ç–≤–µ—Ç –Ω–∞" ‚Äî –ø–µ—Ä–µ–π—Ç–∏ –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
							document.addEventListener('click', function (e) {
							  const box = e.target.closest('.reply-preview.rp-jump');
							  if (!box) return;

							  const targetTgId = box.getAttribute('data-target');
							  if (!targetTgId) return;

							  const target = document.querySelector(`.chat-bubble[data-tg-id="${targetTgId}"]`);
							  if (target) {
								target.scrollIntoView({ behavior: 'smooth', block: 'center' });
								target.classList.add('reply-target');
								setTimeout(() => target.classList.remove('reply-target'), 1200);
							  }
							});

						  // –ö–ª–∏–∫ –±—ã–ª –≤–Ω—É—Ç—Ä–∏ –º–µ–Ω—é –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏—Å—Ç–æ—Ä–∏–∏?
							if (menu.closest('#historyModal')) {
								const item = e.target.closest('.form-check');
								if (item) {
								  e.preventDefault();
								  e.stopPropagation();
								  const input = item.querySelector('input[type="checkbox"]');
								  if (input && e.target !== input) {
									input.checked = !input.checked;
								  }
								  if (typeof syncCategorySelection === 'function') {
									syncCategorySelection();
								  }
								}
							}

						  // –ö–ª–∏–∫ –±—ã–ª –≤–Ω—É—Ç—Ä–∏ –º–µ–Ω—é –∫–∞—Ç–µ–≥–æ—Ä–∏–π –º–æ–¥–∞–ª–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è?
							if (menu.closest('#closeTicketModal')) {
								const item = e.target.closest('.form-check');
								if (item) {
								  e.preventDefault();
								  e.stopPropagation();
								  const input = item.querySelector('input[type="checkbox"]');
								  if (input && e.target !== input) {
									input.checked = !input.checked;
								  }
								  if (typeof syncCloseCategorySelection === 'function') {
									syncCloseCategorySelection();
								  }
								}
								if (selectedCategory) {
								  // –∫–∞—Ç–µ–≥–æ—Ä–∏—è –≤—ã–±—Ä–∞–Ω–∞ ‚Üí –∑–∞–∫—Ä—ã–≤–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é –±–µ–∑ –≤—Ç–æ—Ä–æ–≥–æ –æ–∫–Ω–∞
								  closeTicketDirectly(ticketId, selectedCategory);
								  return;
								}
							}
						}, true);

			  // === –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –∫–ª–∏–µ–Ω—Ç–æ–≤ ===
						async function loadClientStatuses() {
							try {
								const response = await fetch('/client_statuses');
								if (response.ok) {
									return await response.json();
								}
							} catch (e) {
								console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ –∫–ª–∏–µ–Ω—Ç–æ–≤:", e);
							}
							return {};
						}
			

					// === –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è ===
					// === –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è (–ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º –¥–∞–Ω–Ω—ã–º) ===
						function applyFilters() {
							const search = document.getElementById('searchInput')?.value.toLowerCase() || '';
							const status = document.getElementById('filterStatus')?.value || '';
							const user = document.getElementById('filterUser')?.value.toLowerCase() || '';
							const ticketId = document.getElementById('filterTicketId')?.value.toLowerCase() || '';
							const business = document.getElementById('filterBusiness')?.value.toLowerCase() || '';
							const location = document.getElementById('filterLocation')?.value.toLowerCase() || '';
							const responsible = document.getElementById('filterResponsible')?.value.toLowerCase() || '';
							const clientStatus = document.getElementById('filterClientStatus')?.value.toLowerCase() || '';
							const dateFrom = document.getElementById('filterDateFrom')?.value || '';
							const dateTo = document.getElementById('filterDateTo')?.value || '';

							// –§–∏–ª—å—Ç—Ä—É–µ–º –í–°–ï –∑–∞—è–≤–∫–∏
							const filteredTickets = allTickets.filter(t => {
								const searchIndex = [
									String(t.user_id || ''),
									String(t.ticket_id || ''),
									String(t.client_status || ''),
									String(t.channel_name || ''),
									String(t.business || ''),
									String(t.city || ''),
									String(t.location_name || ''),
									String(t.problem || ''),
									String(t.responsible || ''),
									String(t.raw_status || ''),
									String(t.status || ''),
									String(t.created_date || ''),
									String(t.created_time || ''),
									String(t.username || ''),
									String(t.client_name || '')
								].join(' ').toLowerCase();

								const createdDate = t.created_date || '';
								
								const matches = (!search || searchIndex.includes(search)) &&
											  (!status || searchIndex.includes(status)) &&
											  (!user || searchIndex.includes(user)) &&
											  (!ticketId || searchIndex.includes(ticketId)) &&
											  (!business || searchIndex.includes(business)) &&
											  (!location || searchIndex.includes(location)) &&
											  (!responsible || searchIndex.includes(responsible)) &&
											  (!clientStatus || searchIndex.includes(clientStatus)) &&
											  (!dateFrom || createdDate >= dateFrom) &&
											  (!dateTo || createdDate <= dateTo);

								return matches;
							});

							// –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ
							displayFilteredTickets(filteredTickets);
						}

						// === –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫ ===
						function displayFilteredTickets(filteredTickets) {
							// –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                                                        currentPage = 1;

                                                        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü –¥–ª—è –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                                                        totalPages = ensureCurrentPageBounds(filteredTickets.length);

                                                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
                                                        window.filteredTickets = filteredTickets;
							
							// –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞—è–≤–∫–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
							displayTicketsForCurrentPageFiltered();
							
							// –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
							updatePaginationFiltered();
						}

						// === –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–¥–ª—è –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö) ===
                                                function displayTicketsForCurrentPageFiltered() {
                                                        const container = document.getElementById('ticketsBody');
                                                        if (!container) return;

                                                        container.innerHTML = '';

                                                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                                                        const ticketsToDisplay = window.filteredTickets || allTickets;

                                                        totalPages = ensureCurrentPageBounds(ticketsToDisplay.length);

                                                        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                                                        const startIndex = (currentPage - 1) * currentPageSize;
                                                        const endIndex = Math.min(startIndex + currentPageSize, ticketsToDisplay.length);
							
							// –ü–æ–ª—É—á–∞–µ–º –∑–∞—è–≤–∫–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
							const pageTickets = ticketsToDisplay.slice(startIndex, endIndex);
							
							if (pageTickets.length === 0) {
								container.innerHTML = '<tr><td colspan="12" class="text-center text-muted py-3">–ù–µ—Ç –∑–∞—è–≤–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td></tr>';
								return;
							}
							
							// –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∑–∞—è–≤–∫–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É –æ—Ç—Ä–∏—Å–æ–≤–∫–∏)
							pageTickets.forEach(t => {
								const username = t.username ? `@${t.username}` : '–Ω–µ—Ç —é–∑–µ—Ä–Ω–µ–π–º–∞';
								const clientName = t.client_name || '–Ω–µ –∑–∞–¥–∞–Ω–æ';

								const row = document.createElement('tr');
								
								// –ò–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ (–µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è)
								const searchIndex = [
									String(t.user_id || ''),
									String(t.ticket_id || ''),
									String(t.client_status || ''),
									String(t.channel_name || ''),
									String(t.business || ''),
									String(t.city || ''),
									String(t.location_name || ''),
									String(t.problem || ''),
									String(t.responsible || ''),
									String(t.raw_status || ''),
									String(t.status || ''),
									String(t.created_date || ''),
									String(t.created_time || ''),
									String(t.username || ''),
									String(clientName || '')
								].join(' ').toLowerCase();
								row.dataset.search = searchIndex;

								// –û—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–æ–π –∂–µ, –∫–∞–∫ –≤ displayTicketsForCurrentPage()
								const clientCell = `
								<div class="d-flex align-items-center gap-2">
									<img src="${t.avatar_url || '/static/default-avatar.png'}" 
										 alt="" 
										 width="36" 
										 height="36" 
										 class="rounded-circle" 
										 style="object-fit:cover; border:1px solid rgba(0,0,0,.08)"
										 onerror="this.src='/static/default-avatar.png'">
									<span class="clickable-client" data-user-id="${t.user_id}" onclick="window.open('/client/${t.user_id}', '_blank')">${
									(t.client_name && t.client_name !== '–Ω–µ –∑–∞–¥–∞–Ω–æ') ? t.client_name :
									(t.username ? '@' + t.username : '–ö–ª–∏–µ–Ω—Ç ' + t.user_id)
									}</span>
								</div>`;

								let statusBadge;
								if (t.raw_status === 'resolved') {
									statusBadge = `<span class="badge bg-success">‚úÖ –†–µ—à–µ–Ω–æ</span>`;
								} else {
									if (t.status === '–ù–æ–≤–∞—è') {
										statusBadge = `<span class="badge bg-secondary">üÜï –ù–æ–≤–∞—è</span>`;
									} else if (t.status === '–û–∂–∏–¥–∞–µ—Ç —Ä–µ–∞–∫—Ü–∏–∏') {
										statusBadge = `<span class="badge bg-danger">‚è≥ –û–∂–∏–¥–∞–µ—Ç —Ä–µ–∞–∫—Ü–∏–∏</span>`;
									} else {
										statusBadge = `<span class="badge bg-info text-dark">‚è≥ –û–∂–∏–¥–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞</span>`;
									}
								}

								const unreadBadge = `<span class="badge bg-danger me-1 unread-badge" data-ticket="${t.ticket_id}" style="display:none;">0</span>`;
								statusBadge = unreadBadge + statusBadge;

								let businessClass = '';
								if (t.business === '–°—É—à–∏–í–µ—Å–ª–∞') businessClass = 'business-sushi';
								else if (t.business === '–ë–ª–∏–Ω–ë–µ—Ä–∏') businessClass = 'business-blin';

								const createTaskBtn = (t.linked_task_id)
									? `<button class="btn btn-sm btn-outline-primary open-task-btn" data-task-id="${t.linked_task_id}">
									   ‚ÑñDL_${t.linked_task_id}
									 </button>`
									: `<button class="btn btn-sm btn-outline-primary create-task-btn"
									   data-problem="${(t.problem||'').replace(/"/g,'&quot;')}"
									   data-location="${(t.location_name||t.city||'').replace(/"/g,'&quot;')}"
									   data-ticket="${t.ticket_id}">
									   –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
									 </button>`;

								const actionBtns = (t.raw_status !== 'resolved')
									? `<button class="btn btn-sm btn-outline-secondary" onclick="loadHistory(${t.user_id}, '${t.ticket_id}')">–ò—Å—Ç–æ—Ä–∏—è</button>
									 ${createTaskBtn}
									 <button class="btn btn-sm btn-danger" onclick="confirmClose(${t.user_id}, '${t.ticket_id}')">–ó–∞–∫—Ä—ã—Ç—å</button>`
									: `<button class="btn btn-sm btn-outline-secondary" onclick="loadHistory(${t.user_id}, '${t.ticket_id}')">–ò—Å—Ç–æ—Ä–∏—è</button>
									 ${createTaskBtn}`;

								let rowHTML = '';
								rowHTML += `<td>${clientCell}</td>`;
								rowHTML += `<td>${t.client_status || '‚Äî'}</td>`;
								rowHTML += `<td>${t.channel_name || '‚Äî'}</td>`;
								rowHTML += `<td><code>${t.ticket_id}</code></td>`;
								rowHTML += `<td class="${businessClass}">${t.business}</td>`;
								rowHTML += `<td>${t.city}<br><small>${t.location_name}</small></td>`;
								rowHTML += `<td>${t.problem}</td>`;
								rowHTML += `<td>${t.responsible}</td>`;
								rowHTML += `<td>${statusBadge}</td>`;
								const dt = displayTicketDateTime(t);
									rowHTML += `<td>${dt.date}</td>`;
									rowHTML += `<td>${dt.time}</td>`;
								rowHTML += `<td>${actionBtns}</td>`;
								row.innerHTML = rowHTML;
								container.appendChild(row);

								// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
								let unread = 0;
								const lastRead = lastReadAtByTicket[t.ticket_id] || 0;
								if (unreadCountByTicket[t.ticket_id] !== undefined) {
									unread = unreadCountByTicket[t.ticket_id];
								} else {
									unread = 0;
								}
								setTicketUnread(t.ticket_id, unread);
							});
							
							parseEmojis(document.getElementById('ticketsBody'));
							applyColumnSettingsFromState();
							initColumnResize();
						}

						// === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –¥–ª—è –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö ===
						function updatePaginationFiltered() {
							const paginationContainer = document.getElementById('pagination');
							if (!paginationContainer) return;
							
							paginationContainer.innerHTML = '';
							
                                                        const ticketsToDisplay = window.filteredTickets || allTickets;
                                                        totalPages = ensureCurrentPageBounds(ticketsToDisplay.length);
							
							if (totalPages <= 1) return;
							
							// –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
							const prevLi = document.createElement('li');
							prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
							prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePageFiltered(${currentPage - 1})">&laquo;</a>`;
							paginationContainer.appendChild(prevLi);
							
							// –ù—É–º–µ—Ä–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü
							const startPage = Math.max(1, currentPage - 2);
							const endPage = Math.min(totalPages, startPage + 4);
							
							for (let i = startPage; i <= endPage; i++) {
								const pageLi = document.createElement('li');
								pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
								pageLi.innerHTML = `<a class="page-link" href="#" onclick="changePageFiltered(${i})">${i}</a>`;
								paginationContainer.appendChild(pageLi);
							}
							
							// –ö–Ω–æ–ø–∫–∞ "–í–ø–µ—Ä–µ–¥"
							const nextLi = document.createElement('li');
							nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
							nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePageFiltered(${currentPage + 1})">&raquo;</a>`;
							paginationContainer.appendChild(nextLi);
						}

						// === –°–º–µ–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö ===
						function changePageFiltered(page) {
							if (page < 1 || page > totalPages) return;
							
							currentPage = page;
							displayTicketsForCurrentPageFiltered();
							updatePaginationFiltered();
							
							// –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –≤–µ—Ä—Ö—É —Ç–∞–±–ª–∏—Ü—ã
							document.querySelector('.table-responsive').scrollIntoView({ behavior: 'smooth' });
						}

						// === –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤ ===
						function resetFilters() {
							  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ (—Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã)
							  const filterIds = [
								'searchInput', 'filterStatus', 'filterUser', 'filterTicketId', 
								'filterBusiness', 'filterLocation', 'filterClientStatus', 
								'filterResponsible', 'filterDateFrom', 'filterDateTo'
							  ];
							  
							  filterIds.forEach(id => {
								const element = document.getElementById(id);
								if (element) {
								  element.value = '';
								}
							  });
							  
							  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—é –≤—Å–µ—Ö –∑–∞—è–≤–æ–∫
                                                          currentPage = 1;
                                                          window.filteredTickets = null;
                                                          totalPages = ensureCurrentPageBounds(allTickets.length);
                                                          persistCurrentPageIfUnfiltered();
                                                          displayTicketsForCurrentPage();
                                                          updatePagination();
                                                }

   // === –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ===
		document.addEventListener('DOMContentLoaded', function() {
		  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ (—Ç–µ–ø–µ—Ä—å –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫–æ –≤—Å–µ–º –¥–∞–Ω–Ω—ã–º)
		  const searchInput = document.getElementById('searchInput');
		  if (searchInput) searchInput.addEventListener('input', applyFilters);
		  
		  // –î–æ–±–∞–≤—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ
		  const filterStatus = document.getElementById('filterStatus');
		  if (filterStatus) filterStatus.addEventListener('change', applyFilters);
		  
		  const filterUser = document.getElementById('filterUser');
		  if (filterUser) filterUser.addEventListener('input', applyFilters);
		  
		  const filterTicketId = document.getElementById('filterTicketId');
		  if (filterTicketId) filterTicketId.addEventListener('input', applyFilters);
		  
		  const filterBusiness = document.getElementById('filterBusiness');
		  if (filterBusiness) filterBusiness.addEventListener('input', applyFilters);
		  
		  const filterLocation = document.getElementById('filterLocation');
		  if (filterLocation) filterLocation.addEventListener('input', applyFilters);
		  
		  const filterClientStatus = document.getElementById('filterClientStatus');
		  if (filterClientStatus) filterClientStatus.addEventListener('input', applyFilters);
		  
		  const filterDateFrom = document.getElementById('filterDateFrom');
		  if (filterDateFrom) filterDateFrom.addEventListener('input', applyFilters);
		  
		  const filterDateTo = document.getElementById('filterDateTo');
		  if (filterDateTo) filterDateTo.addEventListener('input', applyFilters);
		  
		  const filterResponsible = document.getElementById('filterResponsible');
		  if (filterResponsible) filterResponsible.addEventListener('input', applyFilters);
		});

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –∑–∞—è–≤–æ–∫
		document.addEventListener('DOMContentLoaded', () => {
		  // initSendKeySettings —É–∂–µ –≤—ã–ø–æ–ª–Ω–∏–ª—Å—è —á–µ—Ä–µ–∑ IIFE, –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤ –Ω–µ –Ω—É–∂–µ–Ω
		  autoRefreshTickets();
		  setInterval(autoRefreshTickets, 5000);

		const chat = document.getElementById('historyContent');
		chat.addEventListener('click', async (e) => {
		  const bubble = e.target.closest('.chat-bubble');
		  
		  if (!bubble) return;
		  const tgId = bubble.getAttribute('data-tg-id');
		  const isSupport = bubble.getAttribute('data-sender') === 'support';

		  // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é (–∏–∑ –ø—Ä–µ–≤—å—é)
			// –ö–ª–∏–∫ –ø–æ –±–ª–æ–∫—É –ø—Ä–µ–≤—å—é –æ—Ç–≤–µ—Ç–∞ ‚Äî –ø–ª–∞–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—É
				const rpEl = e.target.closest('.reply-preview.rp-jump');
				if (rpEl) {
				  e.preventDefault();
				  const targetId = rpEl.getAttribute('data-target');
				  if (targetId) {
					const target = document.querySelector(`.chat-bubble[data-tg-id="${CSS.escape(targetId)}"]`);
					if (target) {
					  target.scrollIntoView({ behavior: 'smooth', block: 'center' });
					  target.classList.add('reply-target');
					  setTimeout(() => target.classList.remove('reply-target'), 1500);
					} else {
					  alert('–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∏—Å—Ç–æ—Ä–∏–∏');
					}
				  }
				  return;
				}

		   // –û—Ç–≤–µ—Ç–∏—Ç—å (–∂—ë—Å—Ç–∫–æ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º—Å—è –∫ Telegram message_id)
			if (e.target.classList.contains('action-reply')) {
					   const midAttr = bubble.getAttribute('data-mid');   // <= –¢–û–õ–¨–ö–û —ç—Ç–æ –ø–æ–ª–µ
					   const mid = midAttr ? parseInt(midAttr, 10) : NaN;
					   window.currentReplyToTgId = Number.isFinite(mid) ? mid : null;
					   const ta = document.getElementById('replyTextInHistory');
					   ta.focus();
					   showReplyChip(
						 bubble.querySelector('.msg-text')?.innerText || '—Å–æ–æ–±—â–µ–Ω–∏–µ',
						 window.currentReplyToTgId
					   );
						showReplyPreview(bubble.querySelector('.msg-text')?.textContent || '', window.currentReplyToTgId);
					 }

				  // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
				  if (e.target.classList.contains('action-edit') && isSupport && tgId) {
					window.currentEditTgId = parseInt(tgId, 10);
					// –ü–æ–¥—Å–≤–µ—Ç–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π –ø—É–∑—ã—Ä—å
					document.querySelector('.chat-bubble.editing')?.classList.remove('editing');
					bubble.classList.add('editing');
					window.currentReplyToTgId = null;
					const ta = document.getElementById('replyTextInHistory');
					ta.value = bubble.querySelector('.msg-text')?.innerText || '';
					ta.focus();
					showEditChip();
				  }
					  // –°–∫–∞—á–∞—Ç—å –≤–ª–æ–∂–µ–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
					  if (e.target.classList.contains('action-download')) {
						const link = bubble.querySelector('.media-download');
						if (link) link.click();
					  }

				  // –£–¥–∞–ª–∏—Ç—å
				  if (e.target.classList.contains('action-delete') && isSupport && tgId) {
					if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) return;
					const fd = new FormData();
						fd.append('user_id',       String(currentUserId));
						fd.append('ticket_id',     String(currentTicketId));
						fd.append('tg_message_id', String(parseInt(tgId, 10)));

						const resp = await fetch('/message_delete', {
						  method: 'POST',
						  body: fd
						});
					const data = await resp.json();
					if (!data.success) return alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å: '+(data.error||''));
					if (data.deleted_on_client) {
					  bubble.insertAdjacentHTML('beforeend', `<div class="badge-meta">—É–¥–∞–ª–µ–Ω–æ —É –∫–ª–∏–µ–Ω—Ç–∞</div>`);
					}
					bubble.classList.add('opacity-50');
					bubble.querySelector('.bubble-actions')?.remove();
				  }
				});

				// ¬´—á–∏–ø—ã¬ª –Ω–∞–¥ textarea
				window.showReplyChip = function showReplyChip(title, targetTgId){
				  setChip(`‚Ü© –û—Ç–≤–µ—Ç –Ω–∞: <a href="#" id="chipJump">¬´${title.slice(0,60)}‚Ä¶¬ª</a>`, true, targetTgId);
			}
		window.showEditChip = function showEditChip(){
		  setChip(`‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è`, false, null);
		}
		window.clearChip = function clearChip(){
		  const chip = document.getElementById('composeChip');
		  if (chip) chip.remove();
		  // –°–Ω—è—Ç—å —Å–ø–µ—Ü-–ø–æ–¥—Å–≤–µ—Ç–∫—É —Å —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ –ø—É–∑—ã—Ä—è (–µ—Å–ª–∏ –æ—Å—Ç–∞–ª–∞—Å—å)
		  document.querySelector('.chat-bubble.editing')?.classList.remove('editing');
		};
		window.setChip = function setChip(html, isReply, targetTgId){
		  clearChip();
		  const wrap = document.querySelector('.input-group-send');
		  const chip = document.createElement('div');
		  chip.id = 'composeChip';
		  chip.className = 'small text-muted px-2';
		  chip.innerHTML = `${html} <button class="btn btn-link btn-sm p-0">‚úñ</button>`;
		  chip.querySelector('button').onclick = ()=>{
			window.currentReplyToTgId = null;
			window.currentEditTgId = null;
			clearChip();
		  };

		  // –∫–ª–∏–∫ –ø–æ —Å—Å—ã–ª–∫–µ –≤ —á–∏–ø–µ ‚Äî –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
		  const jump = chip.querySelector('#chipJump');
		  if (jump && targetTgId) {
			jump.addEventListener('click', (ev)=>{
			  ev.preventDefault();
			  const target = document.querySelector(`.chat-bubble[data-tg-id="${targetTgId}"]`);
			  if (target) {
				target.scrollIntoView({behavior:'smooth', block:'center'});
				target.classList.add('reply-target');
				setTimeout(()=>target.classList.remove('reply-target'), 1200);
			  }
			});
		  }
		  wrap.prepend(chip);
		}
		  
		// –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤
		setTimeout(() => {
		  applyColumnSettingsFromState(); // –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–º–µ–Ω—è–µ–º –∏–∑ columnSettings
		  restoreColumnWidths();
		}, 100);
  
		window.addEventListener('beforeunload', saveColumnWidths);
  
		let resizeTimer;
		window.addEventListener('resize', () => {
			clearTimeout(resizeTimer);
			resizeTimer = setTimeout(() => {
				applyColumnSettings();
				initColumnResize();
			}, 250);
		});
	});

	// === –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ ===	
	async function updateHistory() {
		try {
			const qs = new URLSearchParams({
				user_id: String(currentUserId),
				ticket_id: String(currentTicketId),
				_: String(Date.now())
			});
			
			if (window.currentChannelId != null && window.currentChannelId !== '' && window.currentChannelId !== 'null') {
				qs.set('channel_id', String(window.currentChannelId));
			}

			const resp = await fetch(`/history?${qs.toString()}`, { cache: 'no-store' });
			const data = await resp.json();

			const container = document.getElementById('historyContent');
			const clientData = window.currentClientData || allTickets.find(
				t => t.user_id == currentUserId && t.ticket_id == currentTicketId
			);

			// 1) –±–µ—Ä–µ–º –º–∞—Å—Å–∏–≤ –∏–∑ –æ—Ç–≤–µ—Ç–∞
			const msgs = (data.messages || []).slice();

			// 2) —Å—Ç–∞–±–∏–ª—å–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Å —Ç–µ–º –∂–µ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–º, —á—Ç–æ –∏ –≤ loadHistory
			msgs.sort((a, b) => {
				const ta = sortTsMs(a);
				const tb = sortTsMs(b);
				
				if (ta !== tb) return ta - tb;

				const am = Number(telegramMid(a) || 0);
				const bm = Number(telegramMid(b) || 0);
				if (am !== bm) return am - bm;

				const as = isSupportMsg(a) ? 1 : 0;
				const bs = isSupportMsg(b) ? 1 : 0;
				return as - bs;
			});

			// 3) –í–ê–ñ–ù–û: –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º –∏ –ø–µ—Ä–µ–∑–∞–ø–æ–ª–Ω—è–µ–º renderedMsgIds
			renderedMsgIds.clear();
			msgs.forEach(m => renderedMsgIds.add(msgKey(m)));

			// 4) —Ä–µ–Ω–¥–µ—Ä —Å—Ç—Ä–æ–≥–æ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞
			container.innerHTML = renderMessagesHTML(currentTicketId, msgs, clientData);
			parseEmojis(container);

			// 5) –æ–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫–∏ –∏ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–∏
			if (msgs.length > 0) {
				lastRenderedAt = msgs[msgs.length - 1].timestamp;
			} else {
				lastRenderedAt = null;
			}
			
			setupReadObserver();
			watchUserBubbles();
			recalcTicketUnreadFromDOM(currentTicketId);

		} catch (error) {
			console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
		}
	}

	
	// –î–µ–ª–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ
	window.updateHistory = updateHistory;

	// === –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é ===
		async function loadHistory(user_id, ticket_id) {
			try { 
				await fetch(`/api/tickets/${ticket_id}/active`, {method:'POST', credentials:'same-origin'}); 
			} catch(e){}

			try {
				// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ö–û–ù–ö–†–ï–¢–ù–û–ô –∑–∞—è–≤–∫–∏
				const [ticketsResp, ticketResp] = await Promise.all([
					fetch('/tickets_list'),
					fetch(`/tickets/${ticket_id}`)
				]);

				const [allTickets, ticketFull] = await Promise.all([
					ticketsResp.json(),
					ticketResp.json()
				]);

				const qs = new URLSearchParams({
					user_id: String(user_id),
					ticket_id: String(ticket_id),
					_: String(Date.now())
				});
				
				if (window.currentChannelId && Number(window.currentChannelId) > 0) {
					qs.set('channel_id', Number(window.currentChannelId));
				}

				const historyResp = await fetch(`/history?${qs.toString()}`, { cache: 'no-store' });
				const historyData = await historyResp.json();

				currentUserId = user_id;
				currentTicketId = ticket_id;

				// –ò—â–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –≤ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö —Ç–∏–∫–µ—Ç–∞—Ö
				const clientData = allTickets.find(t => t.user_id == user_id && t.ticket_id == ticket_id);
				if (clientData && ticketFull) {
						if (!clientData.client_name && ticketFull.client_name) clientData.client_name = ticketFull.client_name;
						if (!clientData.username && ticketFull.username) clientData.username = ticketFull.username;
				}
				window.currentClientData = clientData || {};
				window.currentChannelId = clientData?.channel_id ?? null;

				const avaEl = document.getElementById('clientAvatarInHistory');
				if (avaEl) {
						const fallbackAvatar = '/static/default-avatar.png';
						const avatarCandidates = [
								clientData?.avatar_full_url,
								clientData?.avatar_url,
								ticketFull?.avatar_full_url,
								ticketFull?.avatar_url,
								clientData?.avatar,
								ticketFull?.avatar,
								`/avatar/${currentUserId}`
						];

						let avatarSrc = '';
						for (const candidate of avatarCandidates) {
								const normalized = normalizeAvatarUrl(candidate);
								if (normalized) { avatarSrc = normalized; break; }
						}
						if (!avatarSrc) avatarSrc = fallbackAvatar;

						let fullSrc = '';
						const fullCandidates = [
								clientData?.avatar_full_url,
								ticketFull?.avatar_full_url,
								avatarSrc === fallbackAvatar ? '' : avatarSrc
						];
						for (const candidate of fullCandidates) {
								const normalized = ensureFullAvatarUrl(candidate);
								if (normalized) { fullSrc = normalized; break; }
						}
						if (!fullSrc) fullSrc = avatarSrc;

						avaEl.src = avatarSrc;
						avaEl.dataset.fullsrc = fullSrc;
						avaEl.alt = '–ê–≤–∞—Ç–∞—Ä –∫–ª–∏–µ–Ω—Ç–∞';
						avaEl.onerror = () => {
								avaEl.onerror = null;
								avaEl.src = fallbackAvatar;
								avaEl.dataset.fullsrc = fallbackAvatar;
						};
				}

				const messages = historyData.messages || [];
				
				// –í–ê–ñ–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º renderedMsgIds –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –Ω–æ–≤–æ–π –∏—Å—Ç–æ—Ä–∏–∏
				renderedMsgIds.clear();
				
				// –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫
				const msgs = messages.slice();
				msgs.sort((a, b) => {
					const ta = sortTsMs(a);
					const tb = sortTsMs(b);
					
					// –°–Ω–∞—á–∞–ª–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–æ—Å–Ω–æ–≤–Ω–æ–π –∫—Ä–∏—Ç–µ—Ä–∏–π)
					if (ta !== tb) return ta - tb;
					
					// –ü—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–º –≤—Ä–µ–º–µ–Ω–∏ - –ø–æ ID —Ç–µ–ª–µ–≥—Ä–∞–º —Å–æ–æ–±—â–µ–Ω–∏—è
					const am = Number(telegramMid(a) || 0);
					const bm = Number(telegramMid(b) || 0);
					if (am !== bm) return am - bm;
					
					// –ü—Ä–∏ –ø–æ–ª–Ω–æ–π –Ω–∏—á—å–µ–π - –∫–ª–∏–µ–Ω—Ç —Ä–∞–Ω—å—à–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
					const as = isSupportMsg(a) ? 1 : 0;
					const bs = isSupportMsg(b) ? 1 : 0;
					return as - bs;
				});

				// –ó–∞–ø–æ–ª–Ω—è–µ–º renderedMsgIds –û–¢–°–û–†–¢–ò–†–û–í–ê–ù–ù–´–ú–ò —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
				msgs.forEach(m => {
					renderedMsgIds.add(msgKey(m));
				});
				
				// –ò —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
				lastSeenAt = new Date();

				// –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–æ–±–ª–µ–º—É (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 100ch + –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ title)
				const problem = clientData?.problem || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
				const problemEl = document.getElementById('problemText');
				problemEl.textContent = problem;
				problemEl.title = problem;

				// –ß–∏—Ç–∞–µ–º—ã–π —Å—Ç–∞—Ç—É—Å –¥–ª—è –ø—Ä–∞–≤–æ–≥–æ –±–ª–æ–∫–∞
				const statusText =
					ticketFull.status === 'resolved' ? '–†–µ—à–µ–Ω–æ' :
					(ticketFull.status === 'pending' || ticketFull.status === 'in_progress') ? '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ' :
					(ticketFull.status || '‚Äî');

				// === –í–†–ï–ú–ï–ù–ù–´–ï –ú–ï–¢–†–ò–ö–ò (–°–û–û–¢–í–ï–¢–°–¢–í–£–Æ–¢ –í–ê–®–ï–ô –õ–û–ì–ò–ö–ï) ===
				// "–°–æ–∑–¥–∞–Ω–∞" ‚Äî –∫–æ–≥–¥–∞ –∑–∞—è–≤–∫–∞ –ø–æ–ø–∞–ª–∞ –≤ —Å–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫.
				// 1) –ü—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å ticket.created_at (–æ—Ç –±—ç–∫–∞); 2) –∏–Ω–∞—á–µ ‚Äî –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞.
                                let createdAt = parseDateFromAny(ticketFull.created_at || ticketFull.createdAt);
                                if (!createdAt) {
                                        const firstUserMsg = messages.find(m => !isSupportMsg(m) && messageDate(m));
                                        createdAt = firstUserMsg ? messageDate(firstUserMsg) : null;
                                }

                                // "–ü–µ—Ä–≤—ã–π –æ—Ç–≤–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞" ‚Äî –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ support
                                const firstSupportMsg = messages.find(m => isSupportMsg(m) && messageDate(m));
                                const firstReply = firstSupportMsg ? messageDate(firstSupportMsg) : null;

                                // "–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ" ‚Äî resolved_at –æ—Ç –±—ç–∫–∞
                                const resolvedAt = parseDateFromAny(ticketFull.resolved_at || ticketFull.resolvedAt);

				// "–í—Ä–µ–º—è –¥–æ –æ—Ç–≤–µ—Ç–∞" ‚Äî –æ—Ç —Å–æ–∑–¥–∞–Ω–∏—è (createdAt) –¥–æ –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (firstReply)
				const timeToFirstReply = (createdAt && firstReply) ? diffHMin(createdAt, firstReply) : '‚Äî';

				// "–û–±—â–µ–µ –≤—Ä–µ–º—è" ‚Äî –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞: –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
				const totalWorkTime = (firstReply && resolvedAt) ? diffHMin(firstReply, resolvedAt) : '‚Äî';

				// –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è –±–ª–æ–∫–∞ "–í—Ä–µ–º—è –æ–±—Ä–∞—â–µ–Ω–∏—è"
				const info = document.getElementById('timeInfo');
				info.innerHTML = `
					<div id="timeCounter" style="font-size: 1.2em; font-weight: bold; margin-bottom: 8px;"></div>
					<div id="timeDetails" style="font-size: 0.95em; line-height: 1.6;">
						<div><strong>–°—Ç–∞—Ç—É—Å:</strong> ${statusText}</div>
						<div><strong>–°–æ–∑–¥–∞–Ω–∞:</strong> ${formatRuDate(createdAt)}</div>
						<div><strong>–ü–µ—Ä–≤—ã–π –æ—Ç–≤–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:</strong> ${formatRuDate(firstReply)}</div>
						<div><strong>–í—Ä–µ–º—è –¥–æ –æ—Ç–≤–µ—Ç–∞:</strong> ${timeToFirstReply}</div>
						<div><strong>–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ:</strong> ${formatRuDate(resolvedAt)}</div>
						<div><strong>–û–±—â–µ–µ –≤—Ä–µ–º—è:</strong> ${totalWorkTime}</div>
					</div>
				`;
				
				// –ø–µ—Ä–≤–∏—á–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä –≤—Å–µ–π –ª–µ–Ω—Ç—ã (–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞, –∏ –∫–ª–∏–µ–Ω—Ç–∞)
				const container = document.getElementById('historyContent');
				const html = renderMessagesHTML(ticket_id, msgs, clientData);
				window.currentChannelId = clientData?.channel_id ?? null;
				container.innerHTML = html || '<p class="text-muted">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>';
				container.scrollTop = container.scrollHeight;
				parseEmojis(container);

				ensureHistoryScrollButtons();

				// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º lastRenderedAt –Ω–∞ –æ—Å–Ω–æ–≤–µ –û–¢–°–û–†–¢–ò–†–û–í–ê–ù–ù–û–ì–û –º–∞—Å—Å–∏–≤–∞
				lastRenderedAt = msgs.length ? msgs[msgs.length - 1].timestamp : null;

				setupReadObserver();
				watchUserBubbles();
				recalcTicketUnreadFromDOM(currentTicketId);

				// –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è —Ö–æ–≤–µ—Ä–∞ –Ω–∞ –±–ª–æ–∫–µ "–í—Ä–µ–º—è –æ–±—Ä–∞—â–µ–Ω–∏—è"
				const timeInfo = document.getElementById('timeInfo');
				const tooltipText = [
					`–°—Ç–∞—Ç—É—Å: ${statusText}`,
					`–°–æ–∑–¥–∞–Ω–∞: ${formatRuDate(createdAt)}`,
					`–ü–µ—Ä–≤—ã–π –æ—Ç–≤–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞: ${formatRuDate(firstReply)}`,
					`–í—Ä–µ–º—è –¥–æ –æ—Ç–≤–µ—Ç–∞: ${timeToFirstReply}`,
					`–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ: ${formatRuDate(resolvedAt)}`,
					`–û–±—â–µ–µ –≤—Ä–µ–º—è: ${totalWorkTime}`
				].join('\n');
				timeInfo.title = tooltipText;

				// === –ñ–ò–í–û–ô –¢–ê–ô–ú–ï–† (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞—è–≤–∫–∞ –ù–ï –∑–∞–∫—Ä—ã—Ç–∞): –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, —Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—à–ª–æ —Å –º–æ–º–µ–Ω—Ç–∞ "–°–æ–∑–¥–∞–Ω–∞" –¥–æ —Å–µ–π—á–∞—Å
				if (ticketFull.status !== 'resolved' && createdAt) {
					const timerEl = info.querySelector('#timeCounter');
					const updateTimer = () => {
						const now = new Date();
						timerEl.textContent = diffHMin(createdAt, now);
					};
					updateTimer(); // –ø–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤
					if (window.timeUpdateInterval) clearInterval(window.timeUpdateInterval);
					window.timeUpdateInterval = setInterval(updateTimer, 60000);
				} else {
					const timerEl = info.querySelector('#timeCounter');
					if (timerEl) timerEl.textContent = '';
					if (window.timeUpdateInterval) clearInterval(window.timeUpdateInterval);
				}

				// –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
				const closeButton = document.getElementById('closeTicketBtn');
				const isResolved = ticketFull.status === 'resolved';
				if (closeButton) {
					if (isResolved) {
						closeButton.disabled = true;
						closeButton.classList.add('disabled');
						closeButton.title = '–ó–∞—è–≤–∫–∞ —É–∂–µ –∑–∞–∫—Ä—ã—Ç–∞';
					} else {
						closeButton.disabled = false;
						closeButton.classList.remove('disabled');
						closeButton.title = '';
					}
				}

				// –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∑–∞—è–≤–∫–∏
				try {
					const respCat = await fetch(`/tickets/${ticket_id}/category`);
					const dataCat = await respCat.json();
					if (dataCat.category) setCategorySelection(dataCat.category);
				} catch (error) {
					console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:", error);
				}

				// –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫: ID –∑–∞—è–≤–∫–∏
				document.getElementById('ticketIdDisplay').textContent = ticket_id;

				// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∞ –∏ —Å—Ç–∞—Ç—É—Å–∞
				const displayName = clientData?.client_name || clientData?.username || '–ö–ª–∏–µ–Ω—Ç';
				document.getElementById('clientDisplayName').textContent = displayName;
				document.getElementById('clientStatusDisplay').textContent = clientData?.client_status || '‚Äî';

				// –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–æ–±–ª–µ–º—É (–µ—â—ë —Ä–∞–∑ ‚Äî –≤–¥—Ä—É–≥ –æ–±–Ω–æ–≤–∏–ª–∞—Å—å)
				document.getElementById('problemText').textContent = clientData?.problem || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';

				// –ö–ª–∏–∫ –ø–æ –∫–∞—Ä–∞–Ω–¥–∞—à—É ‚Üí —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏
				document.getElementById('editClientBtn').onclick = function () {
					document.getElementById('clientNameInput').value = clientData?.client_name || '';
					document.getElementById('clientUsernameInput').value = clientData?.username || '';
					new bootstrap.Modal(document.getElementById('editClientNameModal')).show();
				};

				// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
				lastRenderedAt = messages.length ? messages[messages.length - 1].timestamp : null;
				
				// –æ–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ –ø—Ä–∏—Ö–æ–¥–∞ —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö
				const lastRead = lastReadAtByTicket[currentTicketId] || 0;
				const unread = (historyData.messages || []).filter(
					m => m.sender === 'user' && new Date(m.timestamp).getTime() > lastRead
				).length;
				setUnread(unread);

				// –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                                const modal = new bootstrap.Modal(document.getElementById('historyModal'));
                                historyModalIsOpen = true;
                                modal.show();

				// –ø–æ—Å–ª–µ –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏:
					const chatEl = document.getElementById('historyContent');

				// –µ—Å–ª–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä –¥–æ—Å–∫—Ä–æ–ª–ª–∏–ª –¥–æ –Ω–∏–∑–∞ ‚Äî –æ–±–Ω—É–ª—è–µ–º –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
				chatEl.addEventListener('scroll', () => {
				  if (isAtBottom(chatEl)) {
					lastSeenAt = new Date();
					lastReadAtByTicket[currentTicketId] = Date.now();
					localStorage.setItem('lastReadAtByTicket', JSON.stringify(lastReadAtByTicket));
					setUnread(0);
					setTicketUnread(currentTicketId, 0);
				  }
				}, { passive: true });

                                document.getElementById('historyModal').addEventListener('hidden.bs.modal', () => {
                                  historyModalIsOpen = false;
                                  // –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫–∏ ‚Äî —Ç–æ–ª—å–∫–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª–ª–∏–Ω–≥
                                  if (window.timeUpdateInterval) {
                                        clearInterval(window.timeUpdateInterval);
					window.timeUpdateInterval = null;
				  }
				  if (historyPolling) {
					clearInterval(historyPolling);
					historyPolling = null;
				  }
				});

				// === –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ (–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ) ===
				if (historyPolling) clearInterval(historyPolling);
					historyPolling = setInterval(async () => {
					  try {
						const resp = await fetch(`/history?user_id=${currentUserId}&ticket_id=${currentTicketId}&channel_id=${window.currentChannelId ?? ''}&_=${Date.now()}`, { cache: 'no-store' });
						const dataUp = await resp.json();
						const container = document.getElementById('historyContent');
						const msgs = dataUp.messages || [];

						const newOnes = msgs.filter(m => !renderedMsgIds.has(msgKey(m)));
						if (!newOnes.length) return;

						const wasAtBottom = isAtBottom(container);

						const html = renderMessagesHTML(currentTicketId, newOnes, window.currentClientData || null);
						container.insertAdjacentHTML('beforeend', html);
						parseEmojis(container);
						watchUserBubbles();
						recalcTicketUnreadFromDOM(currentTicketId);
						ensureHistoryScrollButtons();

						newOnes.forEach(m => renderedMsgIds.add(msgKey(m)));
						lastRenderedAt = newOnes[newOnes.length - 1].timestamp;

						if (wasAtBottom) {
						  scrollToBottom(container);
						  lastSeenAt = new Date();
						  lastReadAtByTicket[currentTicketId] = Date.now();
						  localStorage.setItem('lastReadAtByTicket', JSON.stringify(lastReadAtByTicket));
						  setUnread(0);
						} else {
						  const inc = newOnes.filter(m => String(m.sender).toLowerCase() === 'user').length;
						  if (inc) setUnread(unreadCount + inc);
						}
					  } catch (e) {
						console.error(e);
					  }
					}, 3000);

			} catch (error) {
				console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏:", error);
				alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∑–∞—è–≤–∫–∏");
			}
		}
	function _sizeHistoryHeights() {
		  const modal = document.getElementById('historyModal');
		  if (!modal) return;
		  const hdr = modal.querySelector('.modal-header');
		  const ftr = modal.querySelector('.modal-footer');
		  modal.style.setProperty('--hdr-h', (hdr?.offsetHeight || 0) + 'px');
		  modal.style.setProperty('--ftr-h', (ftr?.offsetHeight || 0) + 'px');
		}

                document.getElementById('historyModal').addEventListener('shown.bs.modal', () => {
                  historyModalIsOpen = true;
                  _sizeHistoryHeights();
                  // –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—ã—Å–æ—Ç—ã —Ñ—É—Ç–µ—Ä–∞ (textarea —Ä–∞—Å—Ç—ë—Ç)
                  new ResizeObserver(_sizeHistoryHeights).observe(document.getElementById('historyModal'));
		  window.addEventListener('resize', _sizeHistoryHeights, { passive: true });
		});

		// –û—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ –∫–ª–∏–∫—É –Ω–∞ –º–∏–Ω–∏–∞—Ç—é—Ä—É .js-preview
		  document.addEventListener('click', function (e) {
			const img = e.target.closest('.js-preview');
			if (!img) return;

			const full = img.getAttribute('data-fullsrc') || img.src;
			const modalEl = document.getElementById('imagePreviewModal');
			document.getElementById('imagePreviewFull').src = full;
			document.getElementById('imageDownloadLink').href = full;

			const bsModal = bootstrap.Modal.getOrCreateInstance(modalEl);
			bsModal.show();
		  });
			// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è —Å–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                                document.getElementById('historyModal').addEventListener('hidden.bs.modal', function () {
                                        historyModalIsOpen = false;
                                        if (window.timeUpdateInterval) {
                                                clearInterval(window.timeUpdateInterval);
                                                window.timeUpdateInterval = null;
					}
					if (historyPolling) {
						clearInterval(historyPolling);
						historyPolling = null;
					}
				});

		// === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ ===
			function updateTimeCounter(ticketData) {
				if (!ticketData || !ticketData.created_date || !ticketData.created_time) {
					document.getElementById('timeCounter').textContent = '–î–∞–Ω–Ω—ã–µ –æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç';
					document.getElementById('timeDetails').textContent = '';
					return;
				}

				try {
					// –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏
					const [year, month, day] = ticketData.created_date.split('-');
					const [hours, minutes, seconds] = ticketData.created_time.split(':');
					const createdDate = new Date(year, month - 1, day, hours, minutes, seconds);
		
					const now = new Date();
					const diffMs = now - createdDate;
					const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
					const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
					const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
		
					// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è
					let timeText = '';
					if (diffDays > 0) timeText += `${diffDays}–¥ `;
					if (diffHours > 0) timeText += `${diffHours}—á `;
					timeText += `${diffMinutes}–º`;
		
					document.getElementById('timeCounter').textContent = timeText;
		
					// –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
					const createdFormatted = createdDate.toLocaleString('ru-RU');
					const nowFormatted = now.toLocaleString('ru-RU');
					document.getElementById('timeDetails').innerHTML = `
					–°–æ–∑–¥–∞–Ω–∞: ${createdFormatted}<br>
					–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: ${nowFormatted}
					`;
		
				} catch (error) {
					console.error("–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏:", error);
					document.getElementById('timeCounter').textContent = '–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞';
					document.getElementById('timeDetails').textContent = '';
				}
			}
	// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ URL –º–µ–¥–∏–∞—Ñ–∞–π–ª–∞
		// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ URL –º–µ–¥–∏–∞—Ñ–∞–π–ª–∞
	function getMediaUrl(ticket_id, filename) {
		// –£–±–∏—Ä–∞–µ–º –ø—É—Ç—å –∏–∑ filename, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
		const cleanFilename = filename.split('/').pop();
		return `/media/${ticket_id}/${cleanFilename}`;
	}

	// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è HTML –º–µ–¥–∏–∞—Ñ–∞–π–ª–∞ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º (–¥–æ–±–∞–≤–ª–µ–Ω—ã animation –∏ sticker)
		function createMediaHtml(ticket_id, mediaInfo) {
			  const { message_type, attachment, text } = mediaInfo;
			  const filename = (attachment || '').split('/').pop();
			  const mediaUrl = getMediaUrl(ticket_id, filename);
			  const ext = (filename.split('.').pop() || '').toLowerCase();

			  // –ò–∫–æ–Ω–∫–∞ + –ª–µ–π–±–ª —Ç–∏–ø–∞ –º–µ–¥–∏–∞
			  const typeLabel = {
				photo:     'üñº –§–û–¢–û',
				video:     'üé• –í–ò–î–ï–û',
				animation: 'üéû –ê–ù–ò–ú–ê–¶–ò–Ø',
				sticker:   'üß© –°–¢–ò–ö–ï–†',
				document:  'üìÑ –î–û–ö–£–ú–ï–ù–¢',
				voice:     'üé§ –ì–û–õ–û–°–û–í–û–ï'
			  }[message_type] || 'üìé –ú–ï–î–ò–ê';

			  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞: –∏–∫–æ–Ω–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É
			  const wrap = (inner) => `
				<div class="mt-2 media-wrap">
				  <a class="media-download" href="${mediaUrl}" download title="–°–∫–∞—á–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª">‚§ì</a>
				  ${inner}
				  <div class="media-type mt-1">${typeLabel}</div>
				  ${text ? `<div class="media-caption mt-1">${text}</div>` : ''}
				</div>
			  `;

			  if (message_type === 'photo') {
				return wrap(`
				  <img src="${mediaUrl}"
					   data-fullsrc="${mediaUrl}"
					   loading="lazy" decoding="async"
					   class="img-thumbnail js-preview"
					   style="max-width: 100%; max-height: 400px; border-radius: 8px; cursor: zoom-in;"
					   alt="–§–æ—Ç–æ">
				`);
			  }

			  if (message_type === 'video') {
				return wrap(`
				  <video controls
						 class="img-thumbnail"
						 style="max-width: 100%; max-height: 300px; border-radius: 8px;">
					<source src="${mediaUrl}">
					–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
				  </video>
				`);
			  }

			  if (message_type === 'animation') {
				return wrap(`
				  <video autoplay loop muted playsinline controls
						 class="img-thumbnail"
						 style="max-width: 100%; max-height: 320px; border-radius: 8px;">
					<source src="${mediaUrl}">
					–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
				  </video>
				`);
			  }

			  if (message_type === 'sticker') {
				if (ext === 'webp') {
				  return wrap(`<img src="${mediaUrl}" alt="–°—Ç–∏–∫–µ—Ä" style="max-width:160px; height:auto;">`);
				} else if (ext === 'webm') {
				  return wrap(`
					<video autoplay loop muted playsinline style="max-width:160px; border-radius:8px;">
					  <source src="${mediaUrl}">
					</video>
				  `);
				} else {
				  return wrap(`<a href="${mediaUrl}" target="_blank">–°—Ç–∏–∫–µ—Ä</a>`);
				}
			  }

			  if (message_type === 'document') {
				return wrap(`
				  <div class="d-flex align-items-center gap-2">
					<span class="small text-muted">${filename}</span>
				  </div>
				`);
			  }

			  if (message_type === 'voice') {
				return wrap(`
				  <audio controls style="width: 100%;" class="mb-1">
					<source src="${mediaUrl}">
					–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ.
				  </audio>
				`);
			  }

			  // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî —Å—Å—ã–ª–∫–∞
			  if (attachment) {
				return wrap(`<a href="${mediaUrl}" target="_blank" class="text-muted">[–º–µ–¥–∏–∞]</a>`);
			  }
			  return '';
		}


        // === –•–ï–õ–ü–ï–†–´ –î–õ–Ø –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø –î–ê–¢ –ò –†–ê–ó–ù–ò–¶ ===
        function parseDateFromAny(value) {
                if (!value) return null;
                const iso = normalizeToISO(value);
                const d = new Date(iso);
                return isNaN(d) ? null : d;
        }

        function messageDate(msg) {
                if (!msg) return null;
                return parseDateFromAny(msg.timestamp ?? msg.date ?? msg.created_at ?? msg.createdAt ?? null);
        }

        function formatRuDate(d) {
                if (!(d instanceof Date) || isNaN(d)) return '‚Äî';
		const dd = String(d.getDate()).padStart(2,'0');
		const mm = String(d.getMonth()+1).padStart(2,'0');
		const yyyy = d.getFullYear();
		const hh = String(d.getHours()).padStart(2,'0');
		const mi = String(d.getMinutes()).padStart(2,'0');
		const ss = String(d.getSeconds()).padStart(2,'0');
		return `${dd}.${mm}.${yyyy}, ${hh}:${mi}:${ss}`;
	}

	function diffHMin(from, to) {
		if (!(from instanceof Date) || isNaN(from) || !(to instanceof Date) || isNaN(to)) return '‚Äî';
		const mins = Math.max(0, Math.round((to - from) / 60000));
		const h = Math.floor(mins / 60);
		const m = mins % 60;
		return `${h} —á ${m} –º–∏–Ω`;
	}

	function safeParseISO(s) {
		if (!s) return null;
		const d = new Date(s);
		return isNaN(d) ? null : d;
	}
		
        const CATEGORY_COLOR_PALETTE = [
          '#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#dc3545',
          '#fd7e14', '#20c997', '#198754', '#0dcaf0', '#343a40'
        ];

        function categoryColor(name = '') {
          if (!name) return CATEGORY_COLOR_PALETTE[0];
          let hash = 0;
          for (let i = 0; i < name.length; i++) {
            hash = (hash << 5) - hash + name.charCodeAt(i);
            hash |= 0;
          }
          const index = Math.abs(hash) % CATEGORY_COLOR_PALETTE.length;
          return CATEGORY_COLOR_PALETTE[index];
        }

        function renderCategoryBadges(container, categories, label = '–í—ã–±—Ä–∞–Ω–æ:') {
          if (!container) return;
          if (!Array.isArray(categories) || categories.length === 0) {
            container.innerHTML = '';
            container.removeAttribute('title');
            container.classList.remove('has-categories');
            return;
          }

          const chips = categories.map(cat => {
            const rawCat = String(cat || '');
            const safeCat = escapeHtml(rawCat);
            const color = categoryColor(rawCat);
            return `<span class="category-chip" style="--chip-color:${color}">${safeCat}</span>`;
          }).join('');

          const labelHtml = label ? `<span class="selected-label text-muted me-2">${label}</span>` : '';
          container.innerHTML = `${labelHtml}${chips}`;
          container.title = categories.join(', ');
          container.classList.add('has-categories');
        }

// === –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –≤ –æ–∫–Ω–æ –∑–∞–∫—Ä—ã—Ç–∏—è ===
		function syncCloseCategoriesFromHistory() {
			// –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
				const historyCheckboxes = document.querySelectorAll('.category-checkbox:checked');
				const selectedValues = Array.from(historyCheckboxes).map(cb => cb.value);
	  
			// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ –∂–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ –æ–∫–Ω–µ –∑–∞–∫—Ä—ã—Ç–∏—è
				document.querySelectorAll('.close-category-checkbox').forEach(checkbox => {
					checkbox.checked = selectedValues.includes(checkbox.value);
				});
	  
			// –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
				syncCloseCategorySelection();
		}

		// === –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –∑–∞–∫—Ä—ã—Ç–∏—è ===
		function syncCloseCategorySelection() {
			const checkboxes = document.querySelectorAll('.close-category-checkbox:checked');
			const select = document.getElementById('closeCategorySelect');
			const selectedContainer = document.getElementById('closeSelectedCategories');
	  
			// –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–π –≤—ã–±–æ—Ä
				Array.from(select.options).forEach(option => {
					option.selected = false;
				});
	  
			// –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
				const selectedValues = [];
				checkboxes.forEach(checkbox => {
					const value = checkbox.value;
					const option = Array.from(select.options).find(opt => opt.value === value);
					if (option) {
						option.selected = true;
						selectedValues.push(value);
					}
				});
	  
			// –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
                                renderCategoryBadges(selectedContainer, selectedValues);
                                const closeDropdown = document.getElementById('closeCategoryDropdown');
                                if (closeDropdown) {
                                        closeDropdown.textContent = selectedValues.length > 0
                                          ? `–í—ã–±—Ä–∞–Ω–æ: ${selectedValues.length} –∫–∞—Ç–µ–≥–æ—Ä–∏–π`
                                          : '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏...';
                                }
	  
			return selectedValues;
		}

		// === –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ (–¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ select) ===
		function syncCategorySelection() {
			const checkboxes = document.querySelectorAll('.category-checkbox:checked');
			const select = document.getElementById('ticketCategorySelect');
			const selectedContainer = document.getElementById('selectedCategories');
	  
			// –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–π –≤—ã–±–æ—Ä
				Array.from(select.options).forEach(option => {
					option.selected = false;
				});
	  
			// –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
				const selectedValues = [];
				checkboxes.forEach(checkbox => {
					const value = checkbox.value;
					const option = Array.from(select.options).find(opt => opt.value === value);
					if (option) {
						option.selected = true;
						selectedValues.push(value);
					}
				});
	  
			// –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
                                renderCategoryBadges(selectedContainer, selectedValues);
                                const historyDropdown = document.getElementById('categoryDropdown');
                                if (historyDropdown) {
                                        historyDropdown.textContent = selectedValues.length > 0
                                          ? `–í—ã–±—Ä–∞–Ω–æ: ${selectedValues.length} –∫–∞—Ç–µ–≥–æ—Ä–∏–π`
                                          : '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏...';
                                }
	  
			return selectedValues;
		}

		// === –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π ===
		function setCategorySelection(categories) {
			if (!categories) return;
	  
			const categoryArray = Array.isArray(categories) ? categories : categories.split(',').map(cat => cat.trim());
	  
			// –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã
				document.querySelectorAll('.category-checkbox').forEach(checkbox => {
					checkbox.checked = false;
				});
	  
			// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
				categoryArray.forEach(cat => {
					const checkbox = document.querySelector(`.category-checkbox[value="${cat}"]`);
					if (checkbox) {
						checkbox.checked = true;
					}
				});
	  
			// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
				syncCategorySelection();
		}

		// === –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—á–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞—è–≤–∫–∏ ===
		async function loadTicketCategory(ticket_id) {
			try {
				const response = await fetch('/tickets_list');
				const tickets = await response.json();
				const ticket = tickets.find(t => t.ticket_id == ticket_id);
		
				if (ticket && ticket.category) {
					const categories = ticket.category.split(',').map(cat => cat.trim());
					const select = document.getElementById('ticketCategorySelect');
		  
					// –°–Ω–∏–º–∞–µ–º –≤—Å–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è
					Array.from(select.options).forEach(option => {
						option.selected = categories.includes(option.value);
					});
				}
			}
			catch (error) {
				console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:", error);
			}
		}

		// === –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞—è–≤–∫–∏ ===
		async function saveTicketCategory() {
			// –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —á–µ–∫–±–æ–∫—Å—ã
			const checkboxes = document.querySelectorAll('.category-checkbox:checked');
			const selectedCategories = Array.from(checkboxes).map(checkbox => checkbox.value);
	  
			if (selectedCategories.length === 0) {
				alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
				return;
			}

			try {
				const response = await fetch('/update_ticket_category', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						ticket_id: currentTicketId,
						category: selectedCategories.join(', ')
					})
				});

				const data = await response.json();
				if (data.success) {
					alert('‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
				} 
				else {
					alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
				}
			} 
			catch (error) {
				console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', error);
				alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
			}
		}

		// === –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter/Ctrl+Enter ===
		document.getElementById('replyTextInHistory').addEventListener('keydown', function (e) {
		  const mode = localStorage.getItem('sendKeySetting') || 'enter';

			if (e.key === 'Enter') {
				if (mode === 'enter' && !e.shiftKey && !e.ctrlKey) {
					e.preventDefault();
					document.getElementById('sendReplyInHistory').click();
				} 
				else if (mode === 'ctrlEnter' && (e.ctrlKey || e.metaKey)) {
					e.preventDefault();
					document.getElementById('sendReplyInHistory').click();
				} 
				else if (mode === 'enterNewline' && (e.ctrlKey || e.metaKey)) {
					e.preventDefault();
					document.getElementById('sendReplyInHistory').click();
				}
			}
		});

	// === –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ ===
	const sendReplyInHistoryBtn = document.getElementById('sendReplyInHistory');
	if (sendReplyInHistoryBtn) {
	  sendReplyInHistoryBtn.onclick = async function () {
		const ta = document.getElementById('replyTextInHistory');
		const text = ta.value.trim();
		if (!text) return;
		const admin = getOperatorName();
		const container = document.getElementById('historyContent');
		const wasAtBottom = isAtBottom(container);
		this.disabled = true;
		// === –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–ï–†–ï–î –û–¢–ü–†–ê–í–ö–û–ô ===
		console.log('=== –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–ï–†–ï–î –û–¢–ü–†–ê–í–ö–û–ô –°–û–û–ë–©–ï–ù–ò–Ø ===');
		console.log('–¢–µ–∫—É—â–∏–π ticket_id:', currentTicketId);
		console.log('–¢–µ–∫—É—â–∏–π user_id:', currentUserId);
		
		const currentTicket = window.allTickets?.find(t => String(t.ticket_id) === String(currentTicketId));
		if (currentTicket) {
		  console.log('–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏:', currentTicket.status);
		  console.log('Raw —Å—Ç–∞—Ç—É—Å:', currentTicket.raw_status);
		  console.log('–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:', currentTicket.created_date);
		  console.log('–í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è:', currentTicket.created_time);
		} else {
		  console.log('–ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ allTickets');
		}
		console.log('==============================');
		try {
		  let resp, data;
		  if (window.currentEditTgId) {
			// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
			const fd = new FormData();
			fd.append('user_id', String(currentUserId));
			fd.append('ticket_id', String(currentTicketId));
			fd.append('tg_message_id', String(window.currentEditTgId));
			fd.append('text', text);
			resp = await fetch('/message_edit', { method: 'POST', body: fd });
			data = await resp.json();
			if (!data.success) throw new Error(data.error || '–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
			window.currentEditTgId = null;
			if (window.clearChip) window.clearChip();
		  } else {
			// –û–±—ã—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
                        resp = await fetch('/reply', {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({
                                user_id: currentUserId,
                                text,
                                admin,
                                ticket_id: currentTicketId,
                                reply_to_tg_id: (window.currentReplyToTgId || null)
                          })
                        });
                        data = await resp.json();
                                if (!data.success) throw new Error(data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');

                                updateTicketStatus(currentTicketId, '–û–∂–∏–¥–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞');

                                try {
                                  await autoRefreshTickets();
                                } catch (e) {
                                  console.debug('Auto-refresh failed:', e);

                                }

                        window.currentReplyToTgId = null;
                        if (window.clearChip) window.clearChip();
		  }
		  
		  // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
		  ta.value = '';
		  
		  // === –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–°–¢–û–†–ò–ò ===
		  await updateHistory();
		  
		  const freshContainer = document.getElementById('historyContent');
		  if (freshContainer) {
			if (wasAtBottom) {
			  freshContainer.scrollTop = freshContainer.scrollHeight;
			}
			lastReadAtByTicket[currentTicketId] = Date.now();
			setUnread(0);
		  }
		  
		} catch (error) {
		  console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
		  alert('‚ùå ' + error.message);
		} finally {
		  this.disabled = false;
		}
	  };
	}
	// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ
	function updateTicketStatus(ticketId, newStatus) {
	  console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–∫–∏:', ticketId, '->', newStatus);
	  
	  const found = findTicketEverywhere(ticketId);
	  if (!found) {
		console.log('‚ùå –ù–µ –º–æ–≥—É –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å: –∑–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
		return false;
	  }
	  
	  const { source, ticket } = found;
	  
	  // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞
	  if (source === 'allTickets' || source === 'filteredTickets') {
		// –û–±–Ω–æ–≤–ª—è–µ–º –≤ allTickets
		if (Array.isArray(window.allTickets)) {
		  const ticketIndex = window.allTickets.findIndex(t => String(t.ticket_id) === String(ticketId));
		  if (ticketIndex >= 0) {
                        const ticket = window.allTickets[ticketIndex];
                        ticket.status = newStatus;
                        if (newStatus === '–û–∂–∏–¥–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞') ticket.raw_status = 'pending';
                        else if (newStatus === '–û—Ç–∫—Ä—ã—Ç–∞') ticket.raw_status = 'open';
                        else if (newStatus === '–ó–∞–∫—Ä—ã—Ç–∞') ticket.raw_status = 'closed';
                        else if (newStatus === '–û–∂–∏–¥–∞–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞') ticket.raw_status = 'active';
                        else if (newStatus === '–†–µ—à–µ–Ω–æ') ticket.raw_status = 'resolved';
                        else ticket.raw_status = 'pending';
                        const statusLower = String(newStatus || '').toLowerCase();
                        const isResolvedLike = statusLower.includes('—Ä–µ—à–µ–Ω') || statusLower.includes('–∑–∞–∫—Ä—ã');
                        ticket.resolved_by = isResolvedLike ? ticket.resolved_by : null;
                        console.log('‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω –≤ allTickets');
		  }
		}
		
		// –û–±–Ω–æ–≤–ª—è–µ–º –≤ filteredTickets
		if (Array.isArray(window.filteredTickets)) {
		  const filteredIndex = window.filteredTickets.findIndex(t => String(t.ticket_id) === String(ticketId));
		  if (filteredIndex >= 0) {
                        const filteredTicket = window.filteredTickets[filteredIndex];
                        filteredTicket.status = newStatus;
                        if (newStatus === '–û–∂–∏–¥–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞') filteredTicket.raw_status = 'pending';
                        else if (newStatus === '–û—Ç–∫—Ä—ã—Ç–∞') filteredTicket.raw_status = 'open';
                        else if (newStatus === '–ó–∞–∫—Ä—ã—Ç–∞') filteredTicket.raw_status = 'closed';
                        else if (newStatus === '–û–∂–∏–¥–∞–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞') filteredTicket.raw_status = 'active';
                        else if (newStatus === '–†–µ—à–µ–Ω–æ') filteredTicket.raw_status = 'resolved';
                        else filteredTicket.raw_status = 'pending';
                        const statusLower = String(newStatus || '').toLowerCase();
                        const isResolvedLike = statusLower.includes('—Ä–µ—à–µ–Ω') || statusLower.includes('–∑–∞–∫—Ä—ã');
                        filteredTicket.resolved_by = isResolvedLike ? filteredTicket.resolved_by : null;
                        console.log('‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω –≤ filteredTickets');
		  }
		}
		// === –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –° ALLTICKETS ===
		try {
		  const fullTicket = allTickets?.find(t => String(t.ticket_id) === String(ticketId));
		  if (fullTicket) {
                        fullTicket.status = newStatus;
                        // –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞: –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º raw_status –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                        if (newStatus === '–û–∂–∏–¥–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞') fullTicket.raw_status = 'pending';
                        else if (newStatus === '–û—Ç–∫—Ä—ã—Ç–∞') fullTicket.raw_status = 'open';
                        else if (newStatus === '–ó–∞–∫—Ä—ã—Ç–∞') fullTicket.raw_status = 'closed';
                        else if (newStatus === '–û–∂–∏–¥–∞–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞') fullTicket.raw_status = 'active';
                        else if (newStatus === '–†–µ—à–µ–Ω–æ') fullTicket.raw_status = 'resolved';
                        else fullTicket.raw_status = 'pending';
                        const statusLower = String(newStatus || '').toLowerCase();
                        const isResolvedLike = statusLower.includes('—Ä–µ—à–µ–Ω') || statusLower.includes('–∑–∞–∫—Ä—ã');
                        fullTicket.resolved_by = isResolvedLike ? fullTicket.resolved_by : null;
                        console.log(`‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω –≤ allTickets: ${newStatus}`);
		  }
		} catch (e) {
		  console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤ allTickets:', e);
		}
	  }
	  
	  // –í—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º DOM
	  updateTicketStatusInTable(ticketId, newStatus);
	  
	  return true;
	}

	// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
	function forceUpdateTicketStatus(ticketId, expectedNewStatus = '–û–∂–∏–¥–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞') {
	  console.log('=== –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê ===');
	  console.log('ticketId:', ticketId);
	  console.log('expectedNewStatus:', expectedNewStatus);
	  
	  // –û–±–Ω–æ–≤–ª—è–µ–º –≤ allTickets
	  if (Array.isArray(window.allTickets)) {
		const ticketIndex = window.allTickets.findIndex(t => String(t.ticket_id) === String(ticketId));
		if (ticketIndex >= 0) {
		  console.log('–°—Ç–∞—Ä—ã–π —Å—Ç–∞—Ç—É—Å:', window.allTickets[ticketIndex].status);
		  window.allTickets[ticketIndex].status = expectedNewStatus;
		  window.allTickets[ticketIndex].raw_status = (expectedNewStatus === '–†–µ—à–µ–Ω–æ') ? 'resolved' : 'pending';
		  console.log('–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –≤ allTickets:', window.allTickets[ticketIndex].status);
		}
	  }
	  
	  // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
	  updateTicketStatusInTable(ticketId, expectedNewStatus);
	  
	  // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
	  setTimeout(() => {
		if (window.filteredTickets && typeof displayTicketsForCurrentPageFiltered === 'function') {
		  displayTicketsForCurrentPageFiltered();
		} else if (typeof displayTicketsForCurrentPage === 'function') {
		  displayTicketsForCurrentPage();
		}
	  }, 100);
	}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –∑–∞—è–≤–∫–∏ –≤–æ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
function findTicketEverywhere(ticketId) {
  console.log('üîç –ü–æ–∏—Å–∫ –∑–∞—è–≤–∫–∏', ticketId, '–≤–æ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö...');
  
  // –ò—â–µ–º –≤ allTickets
  let ticket = window.allTickets?.find(t => String(t.ticket_id) === String(ticketId));
  if (ticket) {
    console.log('‚úÖ –ù–∞–π–¥–µ–Ω–∞ –≤ allTickets');
    return { source: 'allTickets', ticket };
  }
  
  // –ò—â–µ–º –≤ filteredTickets
  ticket = window.filteredTickets?.find(t => String(t.ticket_id) === String(ticketId));
  if (ticket) {
    console.log('‚úÖ –ù–∞–π–¥–µ–Ω–∞ –≤ filteredTickets');
    return { source: 'filteredTickets', ticket };
  }
  
  // –ò—â–µ–º –≤ DOM —Ç–∞–±–ª–∏—Ü—ã
  const rows = document.querySelectorAll('#ticketsBody tr');
  for (const row of rows) {
    const ticketIdCell = row.querySelector('code');
    if (ticketIdCell && ticketIdCell.textContent === String(ticketId)) {
      console.log('‚úÖ –ù–∞–π–¥–µ–Ω–∞ –≤ DOM —Ç–∞–±–ª–∏—Ü—ã');
      
      // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ DOM
      const ticketData = {
        ticket_id: ticketId,
        status: row.querySelector('.badge')?.textContent?.trim() || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
        user_id: row.querySelector('.clickable-client')?.dataset?.userId || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
      };
      return { source: 'DOM', ticket: ticketData };
    }
  }
  
  console.log('‚ùå –ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∏ –≤ –æ–¥–Ω–æ–º –∏—Å—Ç–æ—á–Ω–∏–∫–µ');
  return null;
}

	// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ
	function updateTicketStatusInTable(ticketId, newStatus) {
	  console.log('üîç –ü–æ–∏—Å–∫ –∑–∞—è–≤–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ DOM:', ticketId);
	  
	  const rows = document.querySelectorAll('#ticketsBody tr');
	  let found = false;
	  
	  rows.forEach(row => {
		const ticketIdCell = row.querySelector('code');
		if (ticketIdCell && ticketIdCell.textContent === String(ticketId)) {
		  found = true;
		  const statusCell = row.querySelector('td:nth-child(9)'); // 9-—è –∫–æ–ª–æ–Ω–∫–∞ - —Å—Ç–∞—Ç—É—Å
		  
		  if (statusCell) {
                        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –±–µ–π–¥–∂ —Å—Ç–∞—Ç—É—Å–∞
                        let statusBadge = '';
                        if (newStatus === '–û–∂–∏–¥–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞') {
                          statusBadge = '<span class="badge bg-info text-dark">‚è≥ –û–∂–∏–¥–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞</span>';
                        } else if (newStatus === '–û–∂–∏–¥–∞–µ—Ç —Ä–µ–∞–∫—Ü–∏–∏') {
                          statusBadge = '<span class="badge bg-danger">‚è≥ –û–∂–∏–¥–∞–µ—Ç —Ä–µ–∞–∫—Ü–∏–∏</span>';
                        } else if (newStatus === '–ù–æ–≤–∞—è') {
                          statusBadge = '<span class="badge bg-secondary">üÜï –ù–æ–≤–∞—è</span>';
                        } else if (newStatus === '–†–µ—à–µ–Ω–æ') {
                          statusBadge = '<span class="badge bg-success">‚úÖ –†–µ—à–µ–Ω–æ</span>';
                        } else {
                          statusBadge = `<span class="badge bg-warning">${newStatus}</span>`;
                        }

                        let unreadBadge = statusCell.querySelector('.unread-badge');
                        if (!unreadBadge) {
                          unreadBadge = document.createElement('span');
                          unreadBadge.className = 'badge bg-danger me-1 unread-badge';
                          unreadBadge.dataset.ticket = String(ticketId);
                          unreadBadge.style.display = 'none';
                          unreadBadge.textContent = '0';
                        }

                        const unreadValue = parseInt(unreadBadge.textContent, 10) || 0;
                        const ticketData = getTicketById(ticketId);
                        const canShowUnread = shouldDisplayUnreadBadge(ticketData, newStatus);

                        statusCell.innerHTML = '';
                        statusCell.insertAdjacentElement('afterbegin', unreadBadge);
                        statusCell.insertAdjacentHTML('beforeend', statusBadge);

                        unreadBadge.style.display = (unreadValue > 0 && canShowUnread) ? 'inline-flex' : 'none';
                        console.log('‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω –≤ DOM:', newStatus);
                  }
                }
          });

	  if (!found) {
		console.log('‚ùå –ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ DOM —Ç–∞–±–ª–∏—Ü—ã');
		
		// –ü—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É —Ç–∞–±–ª–∏—Ü—ã
		setTimeout(() => {
		  console.log('üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã...');
		  if (window.filteredTickets && typeof displayTicketsForCurrentPageFiltered === 'function') {
			displayTicketsForCurrentPageFiltered();
		  } else if (typeof displayTicketsForCurrentPage === 'function') {
			displayTicketsForCurrentPage();
		  }
		}, 500);
	  }
	}
	// === –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ ===
	document.getElementById('replyFiles')?.addEventListener('change', async (e) => {
	  const files = Array.from(e.target.files || []);
	  if (!files.length) return;

	  // === –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–ï–†–ï–î –û–¢–ü–†–ê–í–ö–û–ô –§–ê–ô–õ–ê ===
	  console.log('=== –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–ï–†–ï–î –û–¢–ü–†–ê–í–ö–û–ô –§–ê–ô–õ–ê ===');
	  console.log('–¢–µ–∫—É—â–∏–π ticket_id:', currentTicketId);
	  
	  const currentTicket = window.allTickets?.find(t => String(t.ticket_id) === String(currentTicketId));
	  if (currentTicket) {
		console.log('–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏:', currentTicket.status);
		console.log('Raw —Å—Ç–∞—Ç—É—Å:', currentTicket.raw_status);
	  }
	  console.log('==============================');
	  for (const file of files) {
		const fd = new FormData();
		fd.append('user_id', currentUserId);
		fd.append('ticket_id', currentTicketId);
		fd.append('admin', getOperatorName());
		fd.append('file', file);

		try {
		  if (window.currentReplyToTgId) {
			fd.append('reply_to_tg_id', String(window.currentReplyToTgId));
		  }
		  
		  const resp = await fetch('/reply_file', { method: 'POST', body: fd });
		  const j = await resp.json();
		  
		  if (!j.success) {
			alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + (j.error || ''));
			continue;
		  }

		  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º
		  if (j.success) {
			updateTicketStatus(currentTicketId, '–û–∂–∏–¥–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞');
			try { 
			  await autoRefreshTickets(); 
			} catch(e) { 
			  console.debug('Auto-refresh failed:', e);
			}
		  }

		  // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
		  lastRenderedAt = null;
		  await updateHistory();
		  
		  // –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª
		  const container = document.getElementById('historyContent');
		  scrollToBottom(container);

		  lastReadAtByTicket[currentTicketId] = Date.now();
		  setUnread(0);
		  
		} catch (err) {
		  console.error('upload error', err);
		  alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
		}
	  }

	  // —Å–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä
	  e.target.value = '';
	});

	// === –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ ===
		async function saveClientName() {
			const newName = document.getElementById('clientNameInput').value.trim();
			const newUsername = document.getElementById('clientUsernameInput').value.trim();
			
			// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –∑–∞–Ω–æ–≤–æ
			try {
				const response = await fetch('/tickets_list');
				const allTickets = await response.json();
				const clientData = allTickets.find(t => t.user_id == currentUserId && t.ticket_id == currentTicketId);

				if (!newName && !newUsername) {
					alert('–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ');
					return;
				}

				try {
					const response = await fetch('/update_client', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({
							user_id: currentUserId,
							client_name: newName,
							username: newUsername
						})
					});

					const data = await response.json();
					if (data.success) {
						alert('‚úÖ –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
						
						// –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –∏—Å—Ç–æ—Ä–∏–∏
						const displayName = newName || newUsername || '–ö–ª–∏–µ–Ω—Ç';
						document.getElementById('clientDisplayName').textContent = displayName;
						
						// –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
						bootstrap.Modal.getInstance(document.getElementById('editClientNameModal')).hide();
						
						// –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ (–µ—Å–ª–∏ –æ–Ω–∞ –≤–∏–¥–∏–º–∞)
						if (window.refreshTicketsTable) {
							window.refreshTicketsTable();
						}
					} else {
						alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
					}
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–º–µ–Ω–∏:', error);
					alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–º–µ–Ω–∏');
				}
			} catch (error) {
				console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞:', error);
				alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞');
			}
		}

	// === –ó–∞–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É (—á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –æ–∫–Ω–æ) ===
	function getHistorySelectedCategories() {
                return Array.from(document.querySelectorAll('.category-checkbox:checked')).map(cb => cb.value);
        }

	async function performTicketClose(selectedCategories, triggerButton) {
                if (!Array.isArray(selectedCategories) || selectedCategories.length === 0) {
                        alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
                        return;
                }

		const admin = getOperatorName();
                try {
                        triggerButton?.setAttribute('disabled', 'disabled');

                        const response = await fetch('/close_ticket', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                        user_id: currentUserId,
                                        admin,
                                        category: selectedCategories.join(', '),
                                        ticket_id: currentTicketId
                                })
                        });

                        const data = await response.json();
                        if (!data.success) {
                                alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É'));
                                return;
                        }

                        const closeModalEl = document.getElementById('closeTicketModal');
                        if (closeModalEl) {
                                const instance = bootstrap.Modal.getInstance(closeModalEl);
                                instance?.hide();
                        }

                        const successModalEl = document.getElementById('ticketClosedModal');
                        if (successModalEl) {
                                bootstrap.Modal.getOrCreateInstance(successModalEl).show();
                        } else {
                                alert('‚úÖ –ó–∞—è–≤–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞');
                                location.reload();
                        }
                } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –∑–∞—è–≤–∫–∏:', error);
                        alert('‚ùå –û—à–∏–±–∫–∞: ' + (error?.message || error));
                } finally {
                        triggerButton?.removeAttribute('disabled');
                }
        }

		document.getElementById('closeTicketBtn').onclick = function () {
                const historySelected = getHistorySelectedCategories();
                if (historySelected.length > 0) {
                        performTicketClose(historySelected, this);
                        return;
                }

                syncCloseCategoriesFromHistory();
                const modal = new bootstrap.Modal(document.getElementById('closeTicketModal'));
                modal.show();
        };

        // === –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ ===
        document.getElementById('confirmCloseTicketBtn').onclick = async function() {
                const selectedCategories = syncCloseCategorySelection();
                await performTicketClose(selectedCategories, this);
        };

	// === –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π ===
	function syncCategorySelection() {
		const checkboxes = document.querySelectorAll('.category-checkbox:checked');
		const selectedContainer = document.getElementById('selectedCategories');
  
		// –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
			const selectedValues = Array.from(checkboxes).map(cb => cb.value);
  
			if (selectedValues.length > 0) {
				selectedContainer.textContent = '–í—ã–±—Ä–∞–Ω–æ: ' + selectedValues.join(', ');
				document.getElementById('categoryDropdown').textContent = `–í—ã–±—Ä–∞–Ω–æ: ${selectedValues.length} –∫–∞—Ç–µ–≥–æ—Ä–∏–π`;
			} 
			else {
				selectedContainer.textContent = '';
				document.getElementById('categoryDropdown').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏...';
			}
  
		return selectedValues;
	}


	// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤
		document.addEventListener('DOMContentLoaded', function() {
			document.querySelectorAll('.close-category-checkbox').forEach(checkbox => {
				checkbox.addEventListener('change', syncCloseCategorySelection);
			});
		});
	// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
		document.querySelectorAll('.category-checkbox').forEach(checkbox => {
			checkbox.addEventListener('change', syncCategorySelection);
		});
  
		document.querySelectorAll('.close-category-checkbox').forEach(checkbox => {
			checkbox.addEventListener('change', syncCloseCategorySelection);
		});
	
		// === –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ (–∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ–∫–Ω–∞) ===
		function confirmClose(user_id, ticket_id) {
			if (confirm("–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞—è–≤–∫—É?")) {
				loadHistory(user_id, ticket_id);
			}
		}
		// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
		document.addEventListener('DOMContentLoaded', function() {
			document.body.addEventListener('error', function(e) {
				if (e.target.tagName === 'IMG' && e.target.classList.contains('img-thumbnail')) {
					const img = e.target;
					const fallback = img.nextElementSibling;
					if (fallback && fallback.classList.contains('text-muted')) {
						img.style.display = 'none';
						fallback.style.display = 'block';
					}
				}
			}, true);
		});
		
	// —Å–ø–∏—Å–æ–∫ –±–∞–∑–æ–≤—ã—Ö —Ç–∞–π–º–∑–æ–Ω (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å)
  const DEFAULT_TZ = localStorage.getItem('its_operator_tz') || Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';

	function fmtTsISO(iso, tz = getOperatorTZ()) {
	  const d = new Date(iso);
	  if (isNaN(d.getTime())) return iso;
	  return new Intl.DateTimeFormat('ru-RU', {
		timeZone: tz,
		year: 'numeric', month: '2-digit', day: '2-digit',
		hour: '2-digit', minute: '2-digit', second: '2-digit'
	  }).format(d);
	}

	function getOperatorTZ() {
	  const saved = localStorage.getItem('its_operator_tz') || 'UTC';
	  return saved === 'browser' ? 'UTC' : saved;
	}

	function setOperatorTZ(value) {
	  localStorage.setItem('its_operator_tz', value);
	  const tz = value === 'browser' ? 'UTC' : value;
	  // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –≤—Å–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
	  document.querySelectorAll('.msg-time[data-iso]').forEach(el => {
		el.textContent = fmtTsISO(el.dataset.iso, tz);
	  });
	  // –û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É
	  if (window.filteredTickets && typeof displayTicketsForCurrentPageFiltered === 'function') {
		displayTicketsForCurrentPageFiltered();
		if (typeof updatePaginationFiltered === 'function') updatePaginationFiltered();
	  } else if (typeof displayTicketsForCurrentPage === 'function') {
		displayTicketsForCurrentPage();
		if (typeof updatePagination === 'function') updatePagination();
	  }
	}

  (function(){
    const sel = document.getElementById('tzSelect');
    if (!sel) return;
    // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–µ–º –∏–∑ localStorage (–∏–ª–∏ 'browser')
    const stored = localStorage.getItem('its_operator_tz') || 'browser';
    // –µ—Å–ª–∏ —Ç–∞–∫–æ–≥–æ option –Ω–µ—Ç ‚Äî –Ω–µ —Å—Ç—Ä–∞—à–Ω–æ
    if ([...sel.options].some(o => o.value === stored)) sel.value = stored;
    // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    sel.addEventListener('change', (e) => setOperatorTZ(e.target.value));
  })();
  async function createTaskFromDialog(problem, location) {
    try {
      const r = await fetch('/api/tasks/from_dialog', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ problem, location })
      });
      if (!r.ok) {
        const txt = await r.text();
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É: ' + txt);
        return;
      }
      // –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è ‚Äî –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∑–∞–¥–∞—á
      window.location.href = '/tasks';
    } catch (e) {
      alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
    }
  }
	</script>
<div class="modal fade" id="imageModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content bg-dark">
      <div class="modal-body p-0">
        <img id="imageModalImg" class="w-100" alt="–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="imageViewerModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content bg-dark">
      <div class="modal-body p-0 text-center">
        <img id="imageViewerImg" src="" alt="media" style="max-width:100%; max-height:85vh;">
      </div>
    </div>
  </div>
</div>
<!-- –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-body p-0">
        <img id="imagePreviewFull" src="" alt="preview" style="width:100%; height:auto; display:block;">
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
        <a id="imageDownloadLink" class="btn btn-primary btn-sm" href="#" download>–°–∫–∞—á–∞—Ç—å</a>
      </div>
    </div>
  </div>
</div>
<!-- Twemoji -->
<script src="{{ url_for('static', filename='vendor/twemoji/twemoji.min.js') }}"></script>
<script>
  function parseEmojis(root) {
    if (!window.twemoji) return;
    twemoji.parse(root || document.body, {
      folder: 'svg',
      ext: '.svg',
      base: "{{ url_for('static', filename='vendor/twemoji/') }}",
      className: 'emoji',
      // ‚Üê –∫—Ä–∏—Ç–∏—á–Ω–æ: –∏–Ω–ª–∞–π–Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã/–≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã Firefox –Ω–µ ¬´—Å–∂–∏–º–∞–ª¬ª
      attributes: function () {
        return {
          draggable: 'false',
          style: [
            'display:inline-block',
            'width:1em',
            'height:1em',
            'max-width:none',
            'max-height:none',
            'vertical-align:-0.12em',
            'border:0',
            'padding:0',
            'background:transparent'
          ].join(';')
        };
      }
    });
  }
</script>

<script>
  // –ü–∞—Ä—Å–∏–º —ç–º–æ–¥–∑–∏ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ (–∏–ª–∏ –≤–æ –≤—Å—ë–º –¥–æ–∫—É–º–µ–Ω—Ç–µ)
  function parseEmojis(root) {
    try {
      twemoji.parse(root || document.body, { folder: 'svg', ext: '.svg', className: 'emoji' });
    } catch (e) { /* no-op */ }
  }
  // –ü–µ—Ä–≤–∏—á–Ω—ã–π –ø—Ä–æ—Ö–æ–¥ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
  document.addEventListener('DOMContentLoaded', function () { parseEmojis(document.body); });
</script>
<script>
(function () {
  function showAvatar(src) {
    const fallbackSrc = '/static/default-avatar.png';
    let prepared = ensureFullAvatarUrl(src);
    if (!prepared) {
      const normalized = normalizeAvatarUrl(src);
      prepared = normalized || fallbackSrc;
    }

    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –º–æ–¥–∞–ª–∫—É –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞
    const modalEl = document.getElementById('avatarModal');
    const modalImg = document.getElementById('avatarModalImg');
    const downloadLink = document.getElementById('avatarDownloadLink');

    if (!modalEl || !modalImg) {
      console.error('Modal elements not found');
      return;
    }

    const updateDownloadLink = (nextSrc) => {
      if (!downloadLink) return;
      downloadLink.href = nextSrc;
      downloadLink.download = 'avatar.jpg';
    };

    const currentSrc = modalImg.getAttribute('src') || '';
    const isSameSrc = currentSrc === prepared;

    if (!isSameSrc) {
      modalImg.style.opacity = '0';
    }

    modalImg.alt = '–§–æ—Ç–æ –∫–ª–∏–µ–Ω—Ç–∞';

    modalImg.onload = () => {
      modalImg.style.opacity = '1';
      modalImg.onload = null;
      modalImg.onerror = null;
    };

    modalImg.onerror = () => {
      if (!modalImg.src.includes(fallbackSrc)) {
        modalImg.src = fallbackSrc;
        updateDownloadLink(fallbackSrc);
        return;
      }

      modalImg.style.opacity = '1';
      modalImg.onerror = null;
    };

    if (isSameSrc) {
      if (modalImg.complete && modalImg.naturalWidth > 0) {
        modalImg.style.opacity = '1';
        modalImg.onload = null;
        modalImg.onerror = null;
      } else {
        modalImg.src = '';
        modalImg.src = prepared;
      }
    } else {
      modalImg.src = prepared;
    }

    updateDownloadLink(prepared);

    if (modalImg.complete && modalImg.naturalWidth > 0) {
      modalImg.style.opacity = '1';
      modalImg.onload = null;
      modalImg.onerror = null;
    }

    modalImg.dataset.currentSrc = prepared;

    const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
    modalInstance.show();
  }

  const avaInHistory = document.getElementById('clientAvatarInHistory');
  if (avaInHistory) {
    avaInHistory.style.cursor = 'zoom-in';
    avaInHistory.addEventListener('click', function () {
      const fullSrc = this.dataset.fullsrc || this.src;
      showAvatar(fullSrc);
    });
  }
})();

document.addEventListener('click', async (e)=>{
  const btn = e.target.closest('.create-task-btn');
  if (!btn) return;
  const payload = {
    problem: btn.dataset.problem || '',
    location: btn.dataset.location || ''
  };
  try {
    const r = await fetch('/api/tasks/from_dialog', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'same-origin',
      body: JSON.stringify(payload)
    });
    if (r.status === 401) { alert('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.'); window.location.href='/login'; return; }
    const data = await r.json();
    if (data && data.ok) { window.location.href = '/tasks'; }
    else { alert(data && data.error ? data.error : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É'); }
  } catch (error) {
      console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É –∏–∑ –¥–∏–∞–ª–æ–≥–∞:', error);
      alert('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
  }
});

document.addEventListener('click', async (e)=>{
  // –æ—Ç–∫—Ä—ã—Ç—å –∑–∞–¥–∞—á—É –ø–æ –∫–Ω–æ–ø–∫–µ ‚ÑñDL_id
  const btnOpen = e.target.closest('.open-task-btn');
  if (btnOpen) {
    const taskId = btnOpen.dataset.taskId;
    window.location.href = `/tasks#task=${taskId}`;
    return;
  }

  // —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É –∏–∑ –¥–∏–∞–ª–æ–≥–∞
  const btn = e.target.closest('.create-task-btn');
  if (!btn) return;
  const payload = {
    problem: btn.dataset.problem || '',
    location: btn.dataset.location || '',
    ticket_id: btn.dataset.ticket || ''
  };
  try {
    const r = await fetch('/api/tasks/from_dialog', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'same-origin',
      body: JSON.stringify(payload)
    });
    if (r.status === 401) { alert('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.'); window.location.href='/login'; return; }
    const data = await r.json();
    if (data && data.ok) {
      // –º–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –Ω–æ–º–µ—Ä –∑–∞–¥–∞—á–∏
      btn.outerHTML = `<button class="btn btn-sm btn-outline-primary open-task-btn" data-task-id="${data.id}">‚ÑñDL_${data.id}</button>`;
      // –ø–æ–º–µ—á–∞–µ–º —Ç–∏–∫–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–º –∑–∞ —Ç–µ–∫—É—â–∏–º —é–∑–µ—Ä–æ–º
      try { await fetch(`/api/tickets/${payload.ticket_id}/active`, {method:'POST', credentials:'same-origin'}); } catch(_){}
    } else {
      alert(data && data.error ? data.error : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É');
    }
  } catch (error) {
      console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∑–∞–¥–∞—á—É –ø–æ –Ω–æ–º–µ—Ä—É:', error);
      alert('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
  }
});

  (function(){
    function openFromHash(){
      const h = location.hash || '';
      // —Ñ–æ—Ä–º–∞—Ç: #open=ticket:<id>
      const m = h.match(/#open=ticket:([^&]+)/);
      if (m) {
        const ticketId = decodeURIComponent(m[1]);
        // user_id –Ω–µ –∑–Ω–∞–µ–º ‚Äî —É —Ç–µ–±—è loadHistory(user_id, ticket_id) –ø—Ä–∏–Ω–∏–º–∞–µ—Ç user_id,
        // –ø–æ–¥—Å—Ç–∞–≤–∏–º 0: —Å–µ—Ä–≤–µ—Ä –≤—Å—ë —Ä–∞–≤–Ω–æ –≥—Ä—É–∑–∏—Ç –ø–æ ticket_id.
        loadHistory(0, ticketId);
      }
    }
    window.addEventListener('hashchange', openFromHash);
    openFromHash();
  })();

  document.addEventListener('DOMContentLoaded', function () {
    const sel = document.getElementById('tzSelect');
    if (!sel) return; // ‚Üê –∑–∞—â–∏—Ç–∞: –µ—Å–ª–∏ —Å–µ–ª–µ–∫—Ç–∞ –Ω–µ—Ç, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º

    // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
    const stored = localStorage.getItem('its_operator_tz') || 'browser';
    if ([...sel.options].some(o => o.value === stored)) {
      sel.value = stored;
    }

    // —Ä–µ–∞–≥–∏—Ä—É–µ–º –Ω–∞ —Å–º–µ–Ω—É TZ
    sel.addEventListener('change', (e) => {
      const tz = e.target.value;
      // –µ—Å–ª–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ –µ—Å—Ç—å —Ç–≤–æ—è —Ñ—É–Ω–∫—Ü–∏—è ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë,
      // –∏–Ω–∞—á–µ –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º.
      if (typeof setOperatorTZ === 'function') {
        setOperatorTZ(tz);
      } else {
        localStorage.setItem('its_operator_tz', tz);
        location.reload();
      }
    });
  });

	// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª—å–Ω—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
	function applyFiltersModal() {
		  // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
		  const status = document.getElementById('filterStatusModal')?.value || '';
		  const user = document.getElementById('filterUserModal')?.value.toLowerCase() || '';
		  const ticketId = document.getElementById('filterTicketIdModal')?.value.toLowerCase() || '';
		  const business = document.getElementById('filterBusinessModal')?.value.toLowerCase() || '';
		  const location = document.getElementById('filterLocationModal')?.value.toLowerCase() || '';
		  const clientStatus = document.getElementById('filterClientStatusModal')?.value.toLowerCase() || '';
		  const responsible = document.getElementById('filterResponsibleModal')?.value.toLowerCase() || '';
		  const dateFrom = document.getElementById('filterDateFromModal')?.value || '';
		  const dateTo = document.getElementById('filterDateToModal')?.value || '';

		  // –§–∏–ª—å—Ç—Ä—É–µ–º –í–°–ï –∑–∞—è–≤–∫–∏
		  const filteredTickets = allTickets.filter(t => {
			const searchIndex = [
			  String(t.user_id || ''),
			  String(t.ticket_id || ''),
			  String(t.client_status || ''),
			  String(t.channel_name || ''),
			  String(t.business || ''),
			  String(t.city || ''),
			  String(t.location_name || ''),
			  String(t.problem || ''),
			  String(t.responsible || ''),
			  String(t.raw_status || ''),
			  String(t.status || ''),
			  String(t.created_date || ''),
			  String(t.created_time || ''),
			  String(t.username || ''),
			  String(t.client_name || '')
			].join(' ').toLowerCase();

			const createdDate = t.created_date || '';
			
			const matches = (!status || searchIndex.includes(status)) &&
						  (!user || searchIndex.includes(user)) &&
						  (!ticketId || searchIndex.includes(ticketId)) &&
						  (!business || searchIndex.includes(business)) &&
						  (!location || searchIndex.includes(location)) &&
						  (!responsible || searchIndex.includes(responsible)) &&
						  (!clientStatus || searchIndex.includes(clientStatus)) &&
						  (!dateFrom || createdDate >= dateFrom) &&
						  (!dateTo || createdDate <= dateTo);

			return matches;
		  });

		  // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ
		  displayFilteredTickets(filteredTickets);
		  
		  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
		  showActiveFiltersModal();
		  
		  // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
		  const modalInstance = bootstrap.Modal.getInstance(document.getElementById('filtersModal'));
		  if (modalInstance) {
			modalInstance.hide();
		  }
	}

	function resetFiltersModal() {
	  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
	  const modalFilterIds = [
		'filterStatusModal', 'filterUserModal', 'filterTicketIdModal', 
		'filterBusinessModal', 'filterLocationModal', 'filterClientStatusModal', 
		'filterResponsibleModal', 'filterDateFromModal', 'filterDateToModal'
	  ];
	  
	  modalFilterIds.forEach(id => {
		const element = document.getElementById(id);
		if (element) {
		  element.value = '';
		}
	  });
	  
	  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
	  resetFilters();
	  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
	  showActiveFiltersModal();
	  // –°–∫—Ä—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
	  const activeContainer = document.getElementById('activeFiltersModal');
	  if (activeContainer) {
		activeContainer.style.display = 'none';
	  }
	}

	function showActiveFiltersModal() {
	  const badgesContainer = document.getElementById('filterBadgesModal');
	  const activeContainer = document.getElementById('activeFiltersModal');
	  
	  if (!badgesContainer || !activeContainer) return;
	  
	  badgesContainer.innerHTML = '';
	  let hasActiveFilters = false;
	  
	  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π —Ñ–∏–ª—å—Ç—Ä –∏ –¥–æ–±–∞–≤–ª—è–µ–º –±–µ–π–¥–∂, –µ—Å–ª–∏ –µ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ
	  const filters = [
		{ id: 'filterStatusModal', label: '–°—Ç–∞—Ç—É—Å' },
		{ id: 'filterUserModal', label: 'ID –∫–ª–∏–µ–Ω—Ç–∞' },
		{ id: 'filterTicketIdModal', label: 'ID –∑–∞—è–≤–∫–∏' },
		{ id: 'filterBusinessModal', label: '–ë–∏–∑–Ω–µ—Å' },
		{ id: 'filterLocationModal', label: '–õ–æ–∫–∞—Ü–∏—è' },
		{ id: 'filterClientStatusModal', label: '–°—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞' },
		{ id: 'filterResponsibleModal', label: '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π' },
		{ id: 'filterDateFromModal', label: '–î–∞—Ç–∞ –æ—Ç' },
		{ id: 'filterDateToModal', label: '–î–∞—Ç–∞ –¥–æ' }
	  ];
	  
	  filters.forEach(filter => {
		const element = document.getElementById(filter.id);
		if (element && element.value) {
		  hasActiveFilters = true;
		  const badge = document.createElement('span');
		  badge.className = 'badge bg-primary filter-badge';
		  badge.innerHTML = `${filter.label}: ${element.value} 
			<span style="cursor:pointer; margin-left:5px;" onclick="removeFilterModal('${filter.id}')">√ó</span>`;
		  badgesContainer.appendChild(badge);
		}
	  });
	  
	  activeContainer.style.display = hasActiveFilters ? 'block' : 'none';
	}

	function removeFilterModal(filterId) {
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
	  const modalElement = document.getElementById(filterId);
	  if (modalElement) {
		modalElement.value = '';
	  }
	  
	  // –ï—Å–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ, –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
	  if (document.getElementById('filtersModal').classList.contains('show')) {
		showActiveFiltersModal();
	  } else {
		// –ï—Å–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–∫—Ä—ã—Ç–æ, –ø—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
		applyFiltersModal();
	  }
	}

	// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
		document.addEventListener('DOMContentLoaded', function() {
		  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
		  document.getElementById('filtersModal').addEventListener('show.bs.modal', function() {
			// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤ –º–æ–¥–∞–ª—å–Ω—ã–µ
			const mainFilters = [
			  'filterStatus', 'filterUser', 'filterTicketId', 'filterBusiness', 
			  'filterLocation', 'filterClientStatus', 'filterResponsible', 
			  'filterDateFrom', 'filterDateTo'
			];
			
			mainFilters.forEach(filterId => {
			  const mainEl = document.getElementById(filterId);
			  const modalEl = document.getElementById(filterId + 'Modal');
			  
			  if (mainEl && modalEl) {
				modalEl.value = mainEl.value;
			  }
			});
			
			showActiveFiltersModal();
		  });
		});


// === –†–µ—Å–∞–π–∑–µ—Ä –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ ===
function initHistoryPaneResizer() {
  const resizer = document.getElementById('historyPaneResizer');
  const sidebarPane = document.querySelector('.sidebar-pane');
  const historyPane = document.querySelector('.history-pane');
  
  if (!resizer || !sidebarPane || !historyPane) return;

  let isResizing = false;
  let startX, startWidth;

  resizer.addEventListener('mousedown', function(e) {
    isResizing = true;
    startX = e.clientX;
    startWidth = sidebarPane.getBoundingClientRect().width;
    
    document.documentElement.classList.add('resizing');
    resizer.classList.add('resizing');
    
    // –î–æ–±–∞–≤–ª—è–µ–º overlay –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
    const overlay = document.createElement('div');
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      z-index: 9999;
      cursor: col-resize;
    `;
    overlay.id = 'resizeOverlay';
    document.body.appendChild(overlay);
    
    e.preventDefault();
  });

  function onMouseMove(e) {
    if (!isResizing) return;
    
    const width = startWidth + (e.clientX - startX);
    const minWidth = 300;
    const maxWidth = window.innerWidth * 0.7;
    
    if (width >= minWidth && width <= maxWidth) {
      sidebarPane.style.width = width + 'px';
      sidebarPane.style.flex = '0 0 auto';
      
      // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π reflow –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è layout
      sidebarPane.offsetHeight;
    }
  }

  function onMouseUp() {
    if (!isResizing) return;
    
    isResizing = false;
    document.documentElement.classList.remove('resizing');
    resizer.classList.remove('resizing');
    
    // –£–¥–∞–ª—è–µ–º overlay
    const overlay = document.getElementById('resizeOverlay');
    if (overlay) overlay.remove();
    
    document.removeEventListener('mousemove', onMouseMove);
    document.removeEventListener('mouseup', onMouseUp);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —à–∏—Ä–∏–Ω—É –≤ localStorage
    const width = sidebarPane.getBoundingClientRect().width;
    localStorage.setItem('historySidebarWidth', width);
  }

  document.addEventListener('mousemove', onMouseMove);
  document.addEventListener('mouseup', onMouseUp);
}

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —à–∏—Ä–∏–Ω—ã
function restoreSidebarWidth() {
  const savedWidth = localStorage.getItem('historySidebarWidth');
  const sidebarPane = document.querySelector('.sidebar-pane');
  
  if (savedWidth && sidebarPane) {
    sidebarPane.style.width = savedWidth + 'px';
    sidebarPane.style.flex = '0 0 auto';
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
	document.getElementById('historyModal').addEventListener('shown.bs.modal', function() {
		historyModalIsOpen = true;
		  restoreSidebarWidth();
		  initHistoryPaneResizer();
	});

const ticketClosedModalEl = document.getElementById('ticketClosedModal');
if (ticketClosedModalEl) {
  ticketClosedModalEl.addEventListener('hidden.bs.modal', () => {
    location.reload();
  });
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
window.addEventListener('resize', function() {
  const sidebarPane = document.querySelector('.sidebar-pane');
  if (sidebarPane) {
    const currentWidth = sidebarPane.getBoundingClientRect().width;
    const maxWidth = window.innerWidth * 0.7;
    
    if (currentWidth > maxWidth) {
      sidebarPane.style.width = maxWidth + 'px';
    }
  }
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–æ–≤ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
  const savedUnread = localStorage.getItem('unreadCountByTicket');
  if (savedUnread) {
    unreadCountByTicket = JSON.parse(savedUnread);
  }

  // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ
  setTimeout(() => {
    refreshUnreadIndicators();
  }, 1000);
});
window.currentUser = CURRENT_OPERATOR;
</script>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞–≤–∞—Ç–∞—Ä–∞ -->
<div class="modal fade" id="avatarModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark">
      <div class="modal-header border-0">
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <div class="modal-body p-0 text-center">
        <img id="avatarModalImg" src="" alt="–ê–≤–∞—Ç–∞—Ä –∫–ª–∏–µ–Ω—Ç–∞" style="max-width: 100%; max-height: 80vh; object-fit: contain;">
      </div>
      <div class="modal-footer border-0 justify-content-center">
        <a id="avatarDownloadLink" class="btn btn-primary" href="#" download="avatar.jpg">
          <i class="bi bi-download"></i> –°–∫–∞—á–∞—Ç—å
        </a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>
</div>
  </main>
  <script src="{{ url_for('static', filename='sidebar.js') }}"></script>
</body>
</html>
