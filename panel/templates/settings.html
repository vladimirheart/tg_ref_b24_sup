<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Äî Bender</title>
  <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='bender-icon.svg') }}" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='sidebar.css') }}" rel="stylesheet" />
  <style>
    .settings-tiles .settings-tile {
      border: 1px solid #e9ecef;
      border-radius: 1rem;
      background: linear-gradient(135deg, #f8f9fa, #ffffff);
      box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.08);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .settings-tiles .settings-tile--accent {
      background: linear-gradient(135deg, rgba(13, 110, 253, 0.12), #ffffff);
      border-color: rgba(13, 110, 253, 0.2);
      box-shadow: 0 0.25rem 0.75rem rgba(13, 110, 253, 0.15);
    }

    .settings-tiles .settings-tile.is-active {
      border-color: rgba(13, 110, 253, 0.45);
      box-shadow: 0 0.75rem 1.5rem rgba(13, 110, 253, 0.2);
      background: linear-gradient(135deg, rgba(13, 110, 253, 0.18), #ffffff);
    }

    .settings-tiles .settings-tile:hover {
      transform: translateY(-4px);
      box-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.12);
    }

    .settings-tiles .settings-tile .tile-icon {
      width: 3rem;
      height: 3rem;
      border-radius: 0.75rem;
      background: rgba(13, 110, 253, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }

    .settings-tiles .settings-tile--accent .tile-icon {
      background: rgba(13, 110, 253, 0.18);
      color: #0d6efd;
    }

    .settings-tiles .settings-tile .card-title {
      text-align: center;
      color: #0d6efd;
      font-weight: 600;
    }

    .settings-tiles .settings-tile--accent .card-text {
      color: #495057;
    }

    .it-section-accordion .accordion-button {
      background: linear-gradient(135deg, rgba(13, 110, 253, 0.12), rgba(13, 110, 253, 0.04));
      color: #0d6efd;
      font-weight: 600;
    }

    .it-section-accordion .accordion-button.collapsed {
      background: linear-gradient(135deg, rgba(13, 110, 253, 0.05), #ffffff);
      color: #0d6efd;
    }

    .it-section-accordion .accordion-button:focus {
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    .it-section-accordion .accordion-body {
      background-color: #fdfdfd;
    }

    .it-section-accordion .table thead th {
      background: rgba(13, 110, 253, 0.1);
      color: #0d6efd;
      border-bottom: 0;
    }

    .it-section-accordion--nested .accordion-item {
      border: 1px solid rgba(13, 110, 253, 0.15);
      border-radius: 0.75rem;
      overflow: hidden;
    }

    .it-section-accordion--nested .accordion-item + .accordion-item {
      margin-top: 0.75rem;
    }

    .it-section-accordion--nested .accordion-button {
      background: linear-gradient(135deg, rgba(13, 110, 253, 0.15), rgba(13, 110, 253, 0.05));
    }

    .it-section-accordion--nested .accordion-button.collapsed {
      background: linear-gradient(135deg, rgba(13, 110, 253, 0.08), rgba(13, 110, 253, 0.02));
    }

    .modal .card-header {
      background: linear-gradient(135deg, rgba(13, 110, 253, 0.12), rgba(13, 110, 253, 0.05));
      color: #0d6efd;
      font-weight: 600;
    }

    .modal .card-header:not(.d-flex) {
      text-align: center;
    }

    .parameter-card .param-items { min-height: 2.5rem; }
    .parameter-card .param-item .btn { min-width: 2.5rem; }
    .parameter-card .param-item input { min-width: 0; }
    .parameter-card .param-items .empty-placeholder { font-size: 0.9rem; color: #6c757d; }
    .parameter-card .card-header button[data-param-toggle] {
      border: 0;
      background: transparent;
      padding: 0;
      font-weight: 600;
      text-align: left;
      color: inherit;
    }
    .parameter-card.is-expanded .card-header {
      background-color: #f8f9fa;
    }
    .param-entry--deleted .form-control {
      text-decoration: line-through;
    }
    .parameter-card .param-items a.btn,
    .parameter-card .param-items .btn {
      min-width: 3rem;
    }
    .parameter-card .param-items .form-select {
      max-width: 10rem;
    }
    .partner-contact-card {
      transition: box-shadow 0.2s ease;
    }
    .partner-contact-card__title {
      color: #0d6efd;
    }
    .partner-contact-card__subtitle {
      color: #6c757d;
    }
    .partner-contact-card__header--state-active {
      background-color: #e8f5e9;
      border-bottom-color: #c7e8ce;
    }
    .partner-contact-card__header--state-active .partner-contact-card__title {
      color: #1b5e20;
    }
    .partner-contact-card__header--state-active .partner-contact-card__subtitle {
      color: #2e7d32;
    }
    .partner-contact-card__header--state-pending {
      background-color: #fff4d6;
      border-bottom-color: #ffe09f;
    }
    .partner-contact-card__header--state-pending .partner-contact-card__title {
      color: #9a6700;
    }
    .partner-contact-card__header--state-pending .partner-contact-card__subtitle {
      color: #b8860b;
    }
    .partner-contact-card__header--state-blocked,
    .partner-contact-card__header--state-blacklist {
      background-color: #fde2e4;
      border-bottom-color: #f5b5bb;
    }
    .partner-contact-card__header--state-blocked .partner-contact-card__title,
    .partner-contact-card__header--state-blacklist .partner-contact-card__title {
      color: #a4133c;
    }
    .partner-contact-card__header--state-blocked .partner-contact-card__subtitle,
    .partner-contact-card__header--state-blacklist .partner-contact-card__subtitle {
      color: #c9184a;
    }
    .partner-contact-card__header--state-closed {
      background-color: #f1f3f5;
      border-bottom-color: #d0d5db;
    }
    .partner-contact-card__header--state-closed .partner-contact-card__title {
      color: #495057;
    }
    .partner-contact-card__header--state-closed .partner-contact-card__subtitle {
      color: #6c757d;
    }
    .partner-contact-details {
      border: 1px solid #e9ecef;
      border-radius: 0.75rem;
      background-color: #fdfdfd;
    }

    .auth-user-modal-dialog {
      width: auto;
      max-width: min(100vw - 2rem, 1280px);
    }

    @media (max-width: 575.98px) {
      .auth-user-modal-dialog {
        margin: 0.5rem auto;
      }
    }

    .auth-user-overview {
      gap: 1.5rem;
    }

    .auth-user-overview .auth-user-main {
      flex: 1 1 auto;
    }

    .auth-user-overview .auth-user-photo {
      flex: 0 0 auto;
      max-width: 340px;
      width: 100%;
    }

    @media (max-width: 1199.98px) {
      .auth-user-overview .auth-user-photo {
        max-width: none;
      }
    }

    .auth-user-photo-wrapper {
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .auth-user-photo-dropzone {
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .auth-user-fullname-field {
      max-width: 26rem;
    }

    .auth-user-registration-input {
      min-width: 200px;
      max-width: 240px;
    }

    .auth-user-registration-relative {
      min-width: 160px;
    }

    .auth-user-block-status.badge {
      font-size: 0.85rem;
      padding: 0.4rem 0.75rem;
    }

    .org-tree-wrapper {
      border: 1px solid #e9ecef;
      border-radius: 0.75rem;
      background: #ffffff;
      padding: 1rem;
      min-height: 6rem;
    }

    .org-tree {
      margin: 0;
      padding-left: 0;
      list-style: none;
    }

    .org-tree__item {
      list-style: none;
      margin-bottom: 0.75rem;
    }

    .org-tree__item:last-child {
      margin-bottom: 0;
    }

    .org-tree__children {
      margin-top: 0.75rem;
      margin-left: 1.5rem;
      padding-left: 0.75rem;
      border-left: 2px solid #e9ecef;
    }

    .org-node {
      border: 1px solid #e9ecef;
      border-radius: 0.75rem;
      padding: 0.75rem;
      background: linear-gradient(135deg, rgba(13, 110, 253, 0.08), #ffffff);
      box-shadow: 0 0.25rem 0.75rem rgba(13, 110, 253, 0.08);
    }

    .org-node__header {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      gap: 0.5rem;
    }

    .org-node__title {
      font-weight: 600;
      color: #0d6efd;
    }

    .org-node__meta {
      font-size: 0.75rem;
      color: #6c757d;
    }

    .org-node__members {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin-top: 0.5rem;
    }

    .org-node__badge {
      background: #f1f3f5;
      border: 1px solid #dee2e6;
      border-radius: 9999px;
      padding: 0.15rem 0.5rem;
      font-size: 0.75rem;
      color: #495057;
    }

    .org-node__actions .btn {
      font-size: 0.75rem;
      padding: 0.25rem 0.6rem;
    }

    .org-members-list {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      max-height: 320px;
      overflow-y: auto;
    }

    .org-members-list .form-check {
      padding: 0.35rem 0.5rem;
      border-radius: 0.5rem;
      border: 1px solid transparent;
      transition: background-color 0.2s ease, border-color 0.2s ease;
    }

    .org-members-list .form-check:hover {
      background-color: #f8f9fa;
      border-color: #e9ecef;
    }
    .dialog-time-metrics-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }
    .dialog-time-metrics-preview__chip {
      border-radius: 0.75rem;
      padding: 0.5rem 0.9rem;
      font-size: 0.9rem;
      font-weight: 500;
      border: 1px solid rgba(0, 0, 0, 0.12);
      box-shadow: 0 0.15rem 0.4rem rgba(0, 0, 0, 0.06);
      min-width: 9rem;
      text-align: center;
      color: #212529;
    }
    .partner-contact-details__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem;
    }
    .partner-contact-details__toggle {
      border: 0;
      background: transparent;
      padding: 0;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-weight: 600;
      color: #0d6efd;
      text-align: left;
    }
    .partner-contact-details__toggle:focus {
      outline: none;
      box-shadow: none;
    }
    .partner-contact-details__title {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .partner-contact-details__body {
      padding: 0.75rem;
      border-top: 1px solid #e9ecef;
    }
    .partner-contact-details__chevron {
      transition: transform 0.2s ease;
    }
    .partner-contact-details.is-collapsed .partner-contact-details__body {
      display: none;
    }
    .partner-contact-details.is-collapsed .partner-contact-details__chevron {
      transform: rotate(-90deg);
    }
    .partner-contact-details.is-expanded .partner-contact-details__chevron {
      transform: rotate(0deg);
    }
    .partner-contact-person {
      border: 1px solid #dee2e6;
      border-radius: 0.75rem;
      background: linear-gradient(135deg, #ffffff, #f8f9fa);
      padding: 0.75rem;
    }
    .partner-contact-person + .partner-contact-person {
      margin-top: 0.75rem;
    }
    .partner-contact-person__actions {
      text-align: right;
    }
    .partner-contact-person-card__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 0.75rem;
    }
    .partner-contact-person-card__title {
      font-weight: 600;
    }
    .partner-contact-person-card__subtitle {
      font-size: 0.9rem;
      color: #6c757d;
    }
    .partner-contact-person-card__body .form-label {
      font-weight: 500;
    }
    .partner-contact-card--summary {
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      border: 1px solid #e9ecef;
      border-radius: 0.75rem;
      background: linear-gradient(135deg, #ffffff, #f8f9fa);
    }
    .partner-contact-card--summary:hover {
      transform: translateY(-4px);
      box-shadow: 0 0.75rem 1.5rem rgba(13, 110, 253, 0.15);
    }
    .partner-contact-card--summary .card-body {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      height: 100%;
    }
    .partner-contact-card--summary .partner-contact-summary-head {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      align-items: flex-start;
    }
    .partner-contact-card--summary .partner-contact-summary-title {
      font-weight: 600;
      color: #0d6efd;
    }
    .partner-contact-card--summary .partner-contact-summary-meta {
      font-size: 0.9rem;
      color: #6c757d;
    }
    .partner-contact-card--summary .partner-contact-summary-label {
      letter-spacing: 0.08em;
      font-weight: 600;
    }
    .partner-contact-card--summary .partner-contact-summary-value {
      font-size: 1rem;
    }
    .partner-contact-summary-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .partner-contact-summary-contact-title {
      font-weight: 600;
    }
    .partner-contact-summary-contact-meta {
      font-size: 0.85rem;
      color: #6c757d;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }
    .partner-contact-summary-empty {
      font-size: 0.9rem;
      color: #adb5bd;
    }
    .partner-contact-served-summary {
      font-size: 0.85rem;
      color: #6c757d;
      margin-top: 0.25rem;
    }
    .partner-contact-served-summary:empty {
      display: none;
    }
    .partner-contact-served-select {
      min-height: 6.5rem;
    }
    .partner-contact-card--modal {
      border: 0;
      box-shadow: none;
      height: auto !important;
      background: transparent;
    }
    .partner-contact-card--modal .card-header {
      border-bottom: 1px solid #e9ecef;
    }
    .partner-contact-card--modal .card-body {
      max-height: 65vh;
      overflow-y: auto;
    }
    .client-status-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .status-count-link {
      text-decoration: none;
      min-width: 3rem;
      text-align: center;
      font-weight: 600;
      border: 1px solid #ced4da;
      padding: 0.35rem 0.65rem;
      border-radius: 2rem;
      background-color: #f8f9fa;
      color: #0d6efd;
      transition: background-color 0.2s ease, color 0.2s ease;
    }
    .status-count-link:hover {
      background-color: #0d6efd;
      color: #fff;
    }
    .status-count-link.disabled {
      pointer-events: none;
      opacity: 0.65;
      color: #6c757d;
      background-color: #f1f3f5;
      border-color: #dee2e6;
    }
    .status-row {
      align-items: center;
    }
    .status-row-main {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex: 1 1 auto;
      min-width: 0;
    }
    .status-color-preview {
      width: 1.75rem;
      height: 1.75rem;
      border-radius: 50%;
      border: 1px solid rgba(0, 0, 0, 0.1);
      background: var(--status-color, #0d6efd);
      box-shadow: inset 0 0 0 2px #fff;
      flex: 0 0 auto;
    }
    .status-color-input {
      width: 2.75rem;
      height: 2.75rem;
      padding: 0;
      border: none;
      background: transparent;
      flex: 0 0 auto;
    }
    .status-color-input:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .status-row .status-input[disabled] {
      background-color: #f8f9fa;
    }
    .location-tree-business .card-body { background: #fdfdfd; }
    .location-type-header { background: #f1f3f5; border-radius: 0.75rem; padding: 0.5rem 0.75rem; }
    .location-type-header .btn[data-bs-toggle="collapse"] { min-width: 7rem; }
    .location-type-body { padding: 0.75rem 0.25rem 0.25rem 2.25rem; }
    .location-city-block { background: #ffffff; border: 1px solid #e9ecef; border-radius: 0.75rem; padding: 0.75rem; }
    .location-city-block .input-group > .btn { min-width: 5.5rem; }
    .location-city-collapse { padding-top: 0.5rem; }
    .location-section-header { cursor: pointer; }
    .location-section-header .form-control[disabled],
    .location-city-block input[disabled],
    .location-entry-row input[disabled] {
      background-color: #f8f9fa;
    }
    .location-structure-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border-radius: 0.75rem;
      border: 1px solid transparent;
      transition: background-color 0.2s ease, border-color 0.2s ease;
      background-color: #fff;
    }
    .location-structure-row.location-entry-row {
      padding-right: 0.5rem;
    }
    .location-structure-row .location-name-input {
      flex: 1 1 auto;
      min-width: 12rem;
    }
    .location-status-select {
      min-width: 10rem;
      width: 100%;
      flex: 0 0 auto;
    }
    .location-actions {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .location-actions .btn-icon {
      width: 2.25rem;
      height: 2.25rem;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.5rem;
    }
    .location-actions .btn-icon i {
      pointer-events: none;
      font-size: 1rem;
    }
    .location-actions .btn-icon:disabled {
      opacity: 0.5;
    }
    .location-tree-wrapper {
      border: 1px solid #e9ecef;
      border-radius: 0.75rem;
      background-color: #ffffff;
      padding: 1rem;
    }
    .location-tree {
      margin: 0;
      padding-left: 0;
      list-style: none;
    }
    .location-tree__item {
      list-style: none;
      margin-bottom: 1rem;
    }
    .location-tree__item:last-child {
      margin-bottom: 0;
    }
    .location-tree__children {
      margin-top: 0.75rem;
      margin-left: 1.5rem;
      padding-left: 0.75rem;
      border-left: 2px solid #e9ecef;
    }
    .location-tree-card {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .location-tree-row {
      display: flex;
      align-items: stretch;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .location-tree-toggle {
      align-self: center;
      width: 2.25rem;
      height: 2.25rem;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.5rem;
    }
    .location-tree-toggle i {
      pointer-events: none;
    }
    .location-tree-bubble {
      flex: 1 1 auto;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      box-shadow: 0 0.35rem 1rem rgba(13, 110, 253, 0.08);
    }
    .location-tree-controls {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.35rem;
      flex: 0 0 auto;
      min-width: 9.5rem;
    }
    .location-tree-controls .location-status-wrapper {
      width: 100%;
    }
    .location-tree-controls .location-actions {
      width: 100%;
    }
    .location-tree-row .location-name-input {
      min-width: 12rem;
    }
    .location-node-meta {
      font-size: 0.75rem;
      color: #6c757d;
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin-left: 0.25rem;
    }
    .location-node-meta .badge {
      font-weight: 500;
    }
    .location-structure-row.status-default {
      background-color: #f8f9fa;
      border-color: #e9ecef;
    }
    .location-structure-row.status-active {
      background-color: #e8f5e9;
      border-color: #c7e8ce;
    }
    .location-structure-row.status-closed {
      background-color: #fde2e4;
      border-color: #f5b5bb;
    }
    .location-structure-row.status-prelaunch {
      background-color: #fff4d6;
      border-color: #ffe09f;
    }
    .location-structure-row.status-paused {
      background-color: #f1f3f5;
      border-color: #d3d7dc;
    }
    .location-structure-row.status-frozen {
      background-color: #e3f2ff;
      border-color: #b6dcff;
    }
    .location-tree__children.is-collapsed {
      display: none;
    }
    @media (max-width: 768px) {
      .location-tree-row {
        flex-direction: column;
        align-items: stretch;
      }
      .location-tree-controls {
        width: 100%;
        align-items: stretch;
      }
      .location-tree-controls .location-actions {
        justify-content: flex-start;
      }
      .location-tree-toggle {
        align-self: flex-start;
      }
    }
    .location-wizard-step .form-select.is-invalid { border-color: #dc3545; }
    .channel-questions-list .question-item { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 0.75rem; padding: 0.75rem; }
    .dialog-template-card .btn-group .btn { white-space: nowrap; }
    .dialog-template-summary { font-size: 0.9rem; }
    .template-card {
      border-radius: 1rem;
      border: 1px solid #e9ecef;
    }
    .template-card-header {
      background: linear-gradient(135deg, rgba(13, 110, 253, 0.18), rgba(13, 110, 253, 0.05));
      border-radius: 0.75rem;
      padding: 1rem;
      text-align: center;
    }
    .template-card-header h6 {
      color: #0d6efd;
      font-weight: 600;
    }
    .template-card-header p,
    .template-card-header .small {
      margin-bottom: 0;
      color: #495057;
      text-align: center;
    }
    .template-card-header p + .small,
    .template-card-header .small + .small {
      margin-top: 0.25rem;
    }
    .template-card-actions {
      justify-content: center;
    }
    .dialog-template-editor {
      border: 1px dashed #ced4da;
      border-radius: 0.75rem;
      padding: 1rem;
      background-color: #f8f9fa;
    }
    .dialog-template-editor .form-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #6c757d;
    }
    .dialog-template-editor .input-group > .btn,
    .dialog-template-editor .btn-sm {
      min-width: 2.5rem;
    }
    .bot-question-option {
      transition: background-color 0.2s ease, box-shadow 0.2s ease;
      border-radius: 0.5rem;
      padding: 0.25rem 0.5rem;
      margin: -0.125rem 0;
    }
    .bot-question-option.is-active {
      background-color: rgba(13, 110, 253, 0.12);
      box-shadow: inset 0 0 0 1px rgba(13, 110, 253, 0.25);
    }
    .bot-question-option .form-check-input {
      margin-top: 0.35rem;
    }
    .bot-question-option .btn-link {
      white-space: nowrap;
    }
    .bot-question-dependencies {
      border-radius: 0.75rem;
      border: 1px solid rgba(13, 110, 253, 0.15);
      background: linear-gradient(135deg, rgba(13, 110, 253, 0.08), #ffffff);
    }
    .bot-question-dependencies__title {
      color: #0d6efd;
      font-weight: 600;
    }
    .modal-dialog {
      width: auto;
      max-width: min(90vw, var(--bs-modal-width, 500px));
      max-height: 90vh;
      margin-left: auto;
      margin-right: auto;
      overflow: auto;
      resize: both;
    }
    .modal-dialog.modal-lg {
      --bs-modal-width: 1000px;
    }
    .modal-dialog.modal-xl {
      --bs-modal-width: 1440px;
    }
    .modal-content {
      min-height: 100%;
      max-height: 100%;
      display: flex;
      flex-direction: column;
    }
    .modal-body {
      overflow-y: auto;
    }
  </style>
</head>
<body class="with-sidebar sidebar-pinned">
  {% include "_sidebar.html" %}
  <main class="main-content container-fluid">

  <div class="container mt-4">
    <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</h2>

    <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 settings-tiles">
      <div class="col">
        <div class="card settings-tile h-100" role="button" data-bs-toggle="modal" data-bs-target="#channelsModal">
          <div class="card-body">
            <div class="tile-icon">ü§ñ</div>
            <h5 class="card-title">–ö–∞–Ω–∞–ª—ã (–±–æ—Ç—ã)</h5>
            <p class="card-text text-muted">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–º–∏ Telegram-–±–æ—Ç–∞–º–∏.</p>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card settings-tile settings-tile--accent h-100" role="button" data-bs-toggle="modal" data-bs-target="#categoriesModal">
          <div class="card-body">
            <div class="tile-icon">üóÇÔ∏è</div>
            <h5 class="card-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤</h5>
            <p class="card-text text-muted">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ —à–∞–±–ª–æ–Ω–∞–º–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π, –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –¥–µ–π—Å—Ç–≤–∏–π.</p>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card settings-tile settings-tile--accent h-100" role="button" data-bs-toggle="modal" data-bs-target="#parametersModal">
          <div class="card-body">
            <div class="tile-icon">üß©</div>
            <h5 class="card-title">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤</h5>
            <p class="card-text text-muted">–û–±–Ω–æ–≤–ª—è–π—Ç–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –∏ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Ñ–æ—Ä–º.</p>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card settings-tile settings-tile--accent h-100" role="button" data-bs-toggle="modal" data-bs-target="#itConnectionsModal">
          <div class="card-body">
            <div class="tile-icon">üñß</div>
            <h5 class="card-title">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è IT-–±–ª–æ–∫–∞</h5>
            <p class="card-text text-muted">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏ –∏ –ø—Ä–æ—Ñ–∏–ª—è–º–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤.</p>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card settings-tile settings-tile--accent h-100" role="button" data-bs-toggle="modal" data-bs-target="#usersModal">
          <div class="card-body">
            <div class="tile-icon">üë•</div>
            <h5 class="card-title">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–∞–Ω–µ–ª–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–∞</h5>
            <p class="card-text text-muted">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ä–æ–ª–∏, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–π—Ç–µ –ø—Ä–∞–≤–∞ –∏ —É–ø—Ä–∞–≤–ª—è–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.</p>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card settings-tile settings-tile--accent h-100" role="button" data-bs-toggle="modal" data-bs-target="#statusesModal">
          <div class="card-body">
            <div class="tile-icon">üè∑Ô∏è</div>
            <h5 class="card-title">–°—Ç–∞—Ç—É—Å—ã –∫–ª–∏–µ–Ω—Ç–æ–≤</h5>
            <p class="card-text text-muted">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Å—Ç–∞—Ç—É—Å—ã –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤.</p>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card settings-tile settings-tile--accent h-100" role="button" data-bs-toggle="modal" data-bs-target="#locationsModal">
          <div class="card-body">
            <div class="tile-icon">üß≠</div>
            <h5 class="card-title">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–æ–∫–∞—Ü–∏–π</h5>
            <p class="card-text text-muted">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –¥–µ—Ä–µ–≤–æ–º –±–∏–∑–Ω–µ—Å–æ–≤, —Ç–∏–ø–æ–≤ –∏ –ª–æ–∫–∞—Ü–∏–π.</p>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card settings-tile settings-tile--accent h-100" role="button" data-bs-toggle="modal" data-bs-target="#legalEntitiesModal">
          <div class="card-body">
            <div class="tile-icon">üè¢</div>
            <h5 class="card-title">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –ª–∏—Ü–∞</h5>
            <p class="card-text text-muted">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏ –∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤.</p>
          </div>
        </div>
      </div>

      <div class="col">
        <div
          class="card settings-tile settings-tile--accent h-100"
          role="button"
          data-bs-toggle="modal"
          data-bs-target="#inputFormattingModal"
        >
          <div class="card-body">
            <div class="tile-icon"><i class="bi bi-input-cursor-text"></i></div>
            <h5 class="card-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–≤–æ–¥–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö</h5>
            <p class="card-text text-muted">
              –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑—É–π—Ç–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤, e-mail –∏ –∞–¥—Ä–µ—Å–æ–≤.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–≤–æ–¥–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö -->
    <div class="modal fade" id="inputFormattingModal" tabindex="-1" aria-labelledby="inputFormattingModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="inputFormattingModalLabel">üßæ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–≤–æ–¥–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-light border mb-4" role="alert">
              –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –µ–¥–∏–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤, —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤ –∏ –ø–æ—á—Ç–æ–≤—ã—Ö –∞–¥—Ä–µ—Å–æ–≤. –≠—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ñ–æ—Ä–º–∞–º–∏ –ø–æ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º–µ.
            </div>

            <div class="card mb-4 shadow-sm border-0">
              <div class="card-header bg-primary bg-opacity-10 border-primary border-opacity-25">
                <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-2">
                  <div>
                    <h5 class="mb-1">üìû –¢–µ–ª–µ—Ñ–æ–Ω</h5>
                    <p class="mb-0 text-muted small">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç—ã –ø–æ —Å—Ç—Ä–∞–Ω–∞–º, —Å–ø–∏—Å–æ–∫ —Ç–∏–ø–æ–≤ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.</p>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div class="row g-4">
                  <div class="col-lg-4">
                    <label class="form-label" for="inputPhoneCountry">–§–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                    <select class="form-select" id="inputPhoneCountry" data-phone-country>
                      <option value="ru" data-prefix="+7 " data-pattern="(###) ###-##-##" data-example="+7 (900) 123-45-67">–†–æ—Å—Å–∏—è (+7)</option>
                      <option value="kz" data-prefix="+7 " data-pattern="(###) ###-##-##" data-example="+7 (701) 123-45-67">–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω (+7)</option>
                      <option value="by" data-prefix="+375 " data-pattern="(##) ###-##-##" data-example="+375 (29) 123-45-67">–ë–µ–ª–∞—Ä—É—Å—å (+375)</option>
                      <option value="us" data-prefix="+1 " data-pattern="(###) ###-####" data-example="+1 (415) 555-1234">–°–®–ê (+1)</option>
                      <option value="de" data-prefix="+49 " data-pattern="(####) ########" data-example="+49 (030) 12345678">–ì–µ—Ä–º–∞–Ω–∏—è (+49)</option>
                    </select>
                    <div class="form-text">–ü—Ä–∏–º–µ—Ä: <span data-phone-format-example>+7 (900) 123-45-67</span></div>
                  </div>

                  <div class="col-lg-4">
                    <label class="form-label" for="inputPhoneTypeAdd">–¢–∏–ø—ã —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                    <div class="d-flex flex-column gap-2">
                      <div class="input-group">
                        <input type="text" class="form-control" id="inputPhoneTypeAdd" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –†–∞–±–æ—á–∏–π" data-phone-type-input>
                        <button class="btn btn-outline-primary" type="button" data-phone-type-add>–î–æ–±–∞–≤–∏—Ç—å</button>
                      </div>
                      <div class="d-flex flex-wrap gap-2" data-phone-type-list></div>
                    </div>
                    <div class="form-text">–†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Ç–∏–ø–æ–≤ –≤—Ä—É—á–Ω—É—é.</div>
                  </div>

                  <div class="col-lg-4">
                    <label class="form-label" for="inputPhonePreview">–ê–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–≤–æ–¥–∞</label>
                    <input type="text" class="form-control" id="inputPhonePreview" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä" data-phone-format-input>
                    <div class="form-text">–ù–æ–º–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–≤–æ–¥–∏—Ç—Å—è –∫ —Ñ–æ—Ä–º–∞—Ç—É –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã.</div>
                    <div class="border rounded mt-3 p-3 bg-light" data-phone-preview data-font-preview="phone">+7 (900) 123-45-67</div>
                  </div>

                  <div class="col-12">
                    <div class="card border-0 bg-light">
                      <div class="card-body d-flex flex-wrap align-items-center gap-3" data-font-settings="phone">
                        <div class="fw-semibold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —à—Ä–∏—Ñ—Ç–∞</div>
                        <div class="d-flex align-items-center gap-2">
                          <label class="form-label small mb-0" for="inputPhoneFontFamily">–®—Ä–∏—Ñ—Ç</label>
                          <select class="form-select form-select-sm" id="inputPhoneFontFamily" data-font-family>
                            <option value="Inter, sans-serif">Inter</option>
                            <option value="Roboto, sans-serif">Roboto</option>
                            <option value="Arial, sans-serif">Arial</option>
                            <option value="'Segoe UI', sans-serif">Segoe UI</option>
                            <option value="Georgia, serif">Georgia</option>
                            <option value="'Courier New', monospace">Courier New</option>
                          </select>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                          <label class="form-label small mb-0" for="inputPhoneFontSize">–†–∞–∑–º–µ—Ä</label>
                          <input type="number" class="form-control form-control-sm" id="inputPhoneFontSize" min="10" max="36" step="1" value="16" data-font-size>
                          <span class="small text-muted">px</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card mb-4 shadow-sm border-0">
              <div class="card-header bg-success bg-opacity-10 border-success border-opacity-25">
                <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-2">
                  <div>
                    <h5 class="mb-1">‚úâÔ∏è E-mail</h5>
                    <p class="mb-0 text-muted small">–ó–∞–¥–∞–π—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Ç–µ–∫—Å—Ç—ã –æ—à–∏–±–æ–∫.</p>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div class="row g-4">
                  <div class="col-md-6">
                    <div class="form-check form-switch mb-3">
                      <input class="form-check-input" type="checkbox" id="inputEmailRequireAt" data-email-require-at checked>
                      <label class="form-check-label" for="inputEmailRequireAt">–¢—Ä–µ–±–æ–≤–∞—Ç—å —Å–∏–º–≤–æ–ª ¬´@¬ª</label>
                    </div>
                    <label class="form-label" for="inputEmailMessageAt">–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ</label>
                    <input type="text" class="form-control mb-3" id="inputEmailMessageAt" placeholder="–£–∫–∞–∂–∏—Ç–µ e-mail —Å —Å–∏–º–≤–æ–ª–æ–º @" data-email-message-at value="–£–∫–∞–∂–∏—Ç–µ e-mail —Å —Å–∏–º–≤–æ–ª–æ–º @">

                    <div class="form-check form-switch mb-3">
                      <input class="form-check-input" type="checkbox" id="inputEmailRequireDomain" data-email-require-domain checked>
                      <label class="form-check-label" for="inputEmailRequireDomain">–¢—Ä–µ–±–æ–≤–∞—Ç—å –¥–æ–º–µ–Ω –ø–æ—Å–ª–µ ¬´@¬ª</label>
                    </div>
                    <label class="form-label" for="inputEmailMessageDomain">–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ</label>
                    <input type="text" class="form-control" id="inputEmailMessageDomain" placeholder="–î–æ–±–∞–≤—å—Ç–µ –¥–æ–º–µ–Ω, –Ω–∞–ø—Ä–∏–º–µ—Ä example.com" data-email-message-domain value="–î–æ–±–∞–≤—å—Ç–µ –¥–æ–º–µ–Ω, –Ω–∞–ø—Ä–∏–º–µ—Ä example.com">
                  </div>

                  <div class="col-md-6">
                    <label class="form-label" for="inputEmailPreview">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏</label>
                    <input type="text" class="form-control" id="inputEmailPreview" placeholder="–í–≤–µ–¥–∏—Ç–µ e-mail" data-email-preview-input>
                    <div class="form-text">–¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –≤–≤–æ–¥–µ.</div>
                    <div class="mt-3">
                      <div class="small text-muted">–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
                      <div class="border rounded p-3 bg-light" data-email-preview-message data-font-preview="email">–í–≤–µ–¥–∏—Ç–µ e-mail –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.</div>
                    </div>
                  </div>

                  <div class="col-12">
                    <div class="card border-0 bg-light">
                      <div class="card-body d-flex flex-wrap align-items-center gap-3" data-font-settings="email">
                        <div class="fw-semibold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —à—Ä–∏—Ñ—Ç–∞</div>
                        <div class="d-flex align-items-center gap-2">
                          <label class="form-label small mb-0" for="inputEmailFontFamily">–®—Ä–∏—Ñ—Ç</label>
                          <select class="form-select form-select-sm" id="inputEmailFontFamily" data-font-family>
                            <option value="Inter, sans-serif">Inter</option>
                            <option value="Roboto, sans-serif">Roboto</option>
                            <option value="Arial, sans-serif">Arial</option>
                            <option value="'Segoe UI', sans-serif">Segoe UI</option>
                            <option value="Georgia, serif">Georgia</option>
                            <option value="'Courier New', monospace">Courier New</option>
                          </select>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                          <label class="form-label small mb-0" for="inputEmailFontSize">–†–∞–∑–º–µ—Ä</label>
                          <input type="number" class="form-control form-control-sm" id="inputEmailFontSize" min="10" max="36" step="1" value="16" data-font-size>
                          <span class="small text-muted">px</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card shadow-sm border-0">
              <div class="card-header bg-warning bg-opacity-10 border-warning border-opacity-25">
                <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-2">
                  <div>
                    <h5 class="mb-1">üè† –ê–¥—Ä–µ—Å</h5>
                    <p class="mb-0 text-muted small">–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –±–ª–æ–∫–∏ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏–µ.</p>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div class="row g-4">
                  <div class="col-lg-6">
                    <label class="form-label" for="inputAddressRaw">–ò—Å—Ö–æ–¥–Ω—ã–π –≤–≤–æ–¥</label>
                    <textarea class="form-control" id="inputAddressRaw" rows="6" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∞–¥—Ä–µ—Å —Ü–µ–ª–∏–∫–æ–º" data-address-raw></textarea>
                    <div class="form-text">–ü—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –æ–¥–Ω–∏–º –±–ª–æ–∫–æ–º –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø–æ –ø–æ–ª—è–º –≤ –∑–∞–¥–∞–Ω–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.</div>
                  </div>

                  <div class="col-lg-6">
                    <label class="form-label">–†–µ–∑—É–ª—å—Ç–∞—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</label>
                    <div class="border rounded p-3 bg-light" data-address-preview data-font-preview="address">
                      <ol class="list-unstyled mb-0" data-address-preview-list></ol>
                    </div>
                    <div class="form-text">–ü–æ–ª–µ ¬´‚Äî¬ª –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –∏–ª–∏ –±–ª–æ–∫ –æ—Ç–∫–ª—é—á—ë–Ω.</div>
                    <div class="alert alert-info mt-3 d-none" role="alert" data-address-overflow></div>
                  </div>

                  <div class="col-12">
                    <div class="table-responsive">
                      <table class="table table-sm align-middle mb-0">
                        <thead>
                          <tr>
                            <th style="width: 28%">–ë–ª–æ–∫ –∞–¥—Ä–µ—Å–∞</th>
                            <th style="width: 16%">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</th>
                            <th>–ó–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr data-address-field="country">
                            <td>–°—Ç—Ä–∞–Ω–∞</td>
                            <td>
                              <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="addressFieldCountry" data-address-toggle="country" checked>
                              </div>
                            </td>
                            <td data-address-value="country">‚Äî</td>
                          </tr>
                          <tr data-address-field="postal_code">
                            <td>–ò–Ω–¥–µ–∫—Å</td>
                            <td>
                              <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="addressFieldPostal" data-address-toggle="postal_code" checked>
                              </div>
                            </td>
                            <td data-address-value="postal_code">‚Äî</td>
                          </tr>
                          <tr data-address-field="region">
                            <td>–†–µ–≥–∏–æ–Ω</td>
                            <td>
                              <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="addressFieldRegion" data-address-toggle="region" checked>
                              </div>
                            </td>
                            <td data-address-value="region">‚Äî</td>
                          </tr>
                          <tr data-address-field="city">
                            <td>–ì–æ—Ä–æ–¥</td>
                            <td>
                              <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="addressFieldCity" data-address-toggle="city" checked>
                              </div>
                            </td>
                            <td data-address-value="city">‚Äî</td>
                          </tr>
                          <tr data-address-field="district">
                            <td>–†–∞–π–æ–Ω</td>
                            <td>
                              <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="addressFieldDistrict" data-address-toggle="district" checked>
                              </div>
                            </td>
                            <td data-address-value="district">‚Äî</td>
                          </tr>
                          <tr data-address-field="street">
                            <td>–£–ª–∏—Ü–∞</td>
                            <td>
                              <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="addressFieldStreet" data-address-toggle="street" checked>
                              </div>
                            </td>
                            <td data-address-value="street">‚Äî</td>
                          </tr>
                          <tr data-address-field="building">
                            <td>–î–æ–º</td>
                            <td>
                              <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="addressFieldBuilding" data-address-toggle="building" checked>
                              </div>
                            </td>
                            <td data-address-value="building">‚Äî</td>
                          </tr>
                          <tr data-address-field="block">
                            <td>–°—Ç—Ä–æ–µ–Ω–∏–µ / –∫–æ—Ä–ø—É—Å</td>
                            <td>
                              <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="addressFieldBlock" data-address-toggle="block" checked>
                              </div>
                            </td>
                            <td data-address-value="block">‚Äî</td>
                          </tr>
                          <tr data-address-field="apartment">
                            <td>–ö–≤–∞—Ä—Ç–∏—Ä–∞ / –æ—Ñ–∏—Å</td>
                            <td>
                              <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="addressFieldApartment" data-address-toggle="apartment" checked>
                              </div>
                            </td>
                            <td data-address-value="apartment">‚Äî</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <div class="col-12">
                    <div class="card border-0 bg-light">
                      <div class="card-body d-flex flex-wrap align-items-center gap-3" data-font-settings="address">
                        <div class="fw-semibold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —à—Ä–∏—Ñ—Ç–∞</div>
                        <div class="d-flex align-items-center gap-2">
                          <label class="form-label small mb-0" for="inputAddressFontFamily">–®—Ä–∏—Ñ—Ç</label>
                          <select class="form-select form-select-sm" id="inputAddressFontFamily" data-font-family>
                            <option value="Inter, sans-serif">Inter</option>
                            <option value="Roboto, sans-serif">Roboto</option>
                            <option value="Arial, sans-serif">Arial</option>
                            <option value="'Segoe UI', sans-serif">Segoe UI</option>
                            <option value="Georgia, serif">Georgia</option>
                            <option value="'Courier New', monospace">Courier New</option>
                          </select>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                          <label class="form-label small mb-0" for="inputAddressFontSize">–†–∞–∑–º–µ—Ä</label>
                          <input type="number" class="form-control form-control-sm" id="inputAddressFontSize" min="10" max="36" step="1" value="16" data-font-size>
                          <span class="small text-muted">px</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
            <button type="button" class="btn btn-primary" data-input-settings-save>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
          </div>
        </div>
      </div>
    </div>

    <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
    <div class="modal fade" id="usersModal" tabindex="-1" aria-labelledby="usersModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="usersModalLabel">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–∞–Ω–µ–ª–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–∞</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
          </div>
          <div class="modal-body">
            <div
              class="auth-management"
              data-auth-management
              data-auth-photo-upload-endpoint="{{ url_for('api_users_upload_photo') }}"
            >
              <div class="alert alert-danger d-none" role="alert" data-auth-message></div>

              <ul class="nav nav-tabs" role="tablist" data-auth-tabs>
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="auth-users-tab" data-bs-toggle="tab" data-bs-target="#settingsAuthUsers" type="button" role="tab">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="auth-roles-tab" data-bs-toggle="tab" data-bs-target="#settingsAuthRoles" type="button" role="tab">–†–æ–ª–∏</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="auth-org-tab" data-bs-toggle="tab" data-bs-target="#settingsAuthOrg" type="button" role="tab">–û—Ä–≥.—Å—Ç—Ä—É–∫—Ç—É—Ä–∞</button>
                </li>
              </ul>

              <div class="tab-content pt-3">
                <div class="tab-pane fade show active" id="settingsAuthUsers" role="tabpanel" data-auth-users-section>
                  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-3">
                    <div class="text-muted small">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏ –∏ –¥–æ—Å—Ç—É–ø–æ–º.</div>
                    <button type="button" class="btn btn-primary btn-sm" data-auth-user-create-trigger>+ –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
                  </div>

                  <div class="table-responsive">
                    <table class="table table-sm align-middle" data-auth-users-table>
                      <thead>
                        <tr>
                          <th style="width: 30%">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                          <th style="width: 22%">–†–æ–ª—å</th>
                          <th style="width: 32%">–ö–æ–Ω—Ç–∞–∫—Ç—ã</th>
                          <th class="text-end" style="width: 16%">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                      </thead>
                      <tbody data-auth-users-body></tbody>
                    </table>
                  </div>
                  <div class="alert alert-info mt-3 d-none" data-auth-users-empty>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</div>
                </div>

                <div class="tab-pane fade" id="settingsAuthRoles" role="tabpanel" data-auth-roles-section>
                  <form class="row g-2 align-items-end mb-3" data-auth-role-create>
                    <div class="col-md-4">
                      <label class="form-label small mb-1" for="authRoleName">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                      <input type="text" class="form-control form-control-sm" id="authRoleName" name="name" autocomplete="off" required>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label small mb-1" for="authRoleDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                      <input type="text" class="form-control form-control-sm" id="authRoleDescription" name="description" autocomplete="off">
                    </div>
                    <div class="col-md-2 d-flex justify-content-end">
                      <button type="submit" class="btn btn-primary btn-sm w-100">–°–æ–∑–¥–∞—Ç—å —Ä–æ–ª—å</button>
                    </div>
                  </form>
                  <div class="text-danger small mb-3 d-none" data-auth-role-create-error></div>
                  <div class="d-flex flex-column gap-3" data-auth-roles-container></div>
                  <div class="alert alert-info d-none" data-auth-roles-empty>–†–æ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</div>
                </div>

                <div class="tab-pane fade" id="settingsAuthOrg" role="tabpanel" data-org-structure-section>
                  <div class="card border-0 shadow-sm">
                    <div class="card-body">
                      <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-3">
                        <div class="text-muted small">
                          –§–æ—Ä–º–∏—Ä—É–π—Ç–µ –∏–µ—Ä–∞—Ä—Ö–∏—é –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π –∏ –Ω–∞–∑–Ω–∞—á–∞–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –∫–∞–∂–¥–æ–π –≤–µ—Ç–∫–µ.
                        </div>
                        <div class="d-flex flex-wrap gap-2 justify-content-end">
                          <button type="button" class="btn btn-outline-primary btn-sm" data-org-action="add-root">+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ—Ä–Ω–µ–≤—É—é –≤–µ—Ç–∫—É</button>
                          <button type="button" class="btn btn-success btn-sm" data-org-save disabled>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ä–≥—Å—Ç—Ä—É–∫—Ç—É—Ä—É</button>
                        </div>
                      </div>
                      <div class="org-tree-wrapper" data-org-tree-wrapper>
                        <div class="alert alert-info small" data-org-empty>
                          –û—Ä–≥—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–µ –∑–∞–¥–∞–Ω–∞. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –≤–µ—Ç–∫—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.
                        </div>
                        <ul class="org-tree list-unstyled mb-0" data-org-tree></ul>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="authUserDetailsModal" tabindex="-1" aria-hidden="true" data-auth-user-modal>
      <div class="modal-dialog modal-dialog-scrollable modal-xl auth-user-modal-dialog modal-fullscreen-sm-down">
        <div class="modal-content">
          <form data-auth-user-form>
            <div class="modal-header">
              <h5 class="modal-title" data-auth-user-modal-title>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
            </div>
            <div class="modal-body">
              <div class="alert alert-danger d-none" role="alert" data-auth-user-modal-error></div>
              <div class="d-flex flex-column gap-4">
                <div class="auth-user-overview d-flex flex-column flex-xl-row align-items-stretch">
                  <div class="auth-user-main pe-xl-4">
                    <div class="auth-user-fullname-field mb-3">
                      <label class="form-label small mb-1" for="authUserModalFullName">–§–ò–û</label>
                      <input type="text" class="form-control form-control-sm" id="authUserModalFullName" name="full_name" autocomplete="off" placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û —Ü–µ–ª–∏–∫–æ–º">
                    </div>
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label small mb-1" for="authUserModalLogin">–õ–æ–≥–∏–Ω</label>
                        <input type="text" class="form-control form-control-sm" id="authUserModalLogin" name="username" autocomplete="off" required>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small mb-1" for="authUserModalRole">–†–æ–ª—å</label>
                        <select class="form-select form-select-sm" id="authUserModalRole" name="role_id" data-auth-user-role-select>
                          <option value="">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
                        </select>
                      </div>
                      <div class="col-12">
                        <label class="form-label small mb-1" for="authUserModalDepartment">–û—Ç–¥–µ–ª</label>
                        <input
                          type="search"
                          class="form-control form-control-sm mb-2"
                          placeholder="–ü–æ–∏—Å–∫ –ø–æ –æ—Ç–¥–µ–ª–∞–º"
                          autocomplete="off"
                          data-auth-user-department-search
                          aria-label="–ü–æ–∏—Å–∫ –ø–æ –æ—Ç–¥–µ–ª–∞–º"
                        >
                        <select
                          class="form-select form-select-sm"
                          id="authUserModalDepartment"
                          name="department"
                          data-auth-user-department-select
                        >
                          <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω</option>
                        </select>
                        <div class="form-text">–°–ø–∏—Å–æ–∫ –æ—Ç–¥–µ–ª–æ–≤ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫–µ ¬´–û—Ä–≥.—Å—Ç—Ä—É–∫—Ç—É—Ä–∞¬ª.</div>
                      </div>
                    </div>
                  </div>
                  <div class="auth-user-photo ms-xl-auto">
                    <div class="auth-user-photo-wrapper auth-user-photo-uploader" data-auth-user-photo-uploader>
                      <label class="form-label small mb-1" for="authUserModalPhoto">–§–æ—Ç–æ</label>
                      <input type="hidden" id="authUserModalPhoto" name="photo" data-auth-user-photo-value>
                      <input type="file" class="visually-hidden" accept="image/*" data-auth-user-photo-file>
                      <div class="auth-user-photo-dropzone" data-auth-user-photo-dropzone>
                        <div class="auth-user-photo-placeholder" data-auth-user-photo-placeholder>
                          <div class="auth-user-photo-icon mb-2">
                            <i class="bi bi-image"></i>
                          </div>
                          <p class="mb-2">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å</p>
                          <button type="button" class="btn btn-outline-primary btn-sm" data-auth-user-photo-trigger>–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
                          <div class="text-muted small mt-2">PNG, JPG, WebP –¥–æ 5 –ú–ë</div>
                        </div>
                        <div class="auth-user-photo-preview d-none" data-auth-user-photo-preview>
                          <img
                            src=""
                            alt="–§–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
                            class="auth-user-photo-img"
                            data-auth-user-photo-img
                            data-auth-user-photo-preview-trigger
                            role="button"
                            tabindex="0"
                            aria-label="–û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ç–æ –≤ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ"
                            loading="lazy"
                          >
                          <div class="d-flex gap-2 mt-3">
                            <button type="button" class="btn btn-outline-primary btn-sm" data-auth-user-photo-change>–ó–∞–º–µ–Ω–∏—Ç—å</button>
                            <button type="button" class="btn btn-outline-danger btn-sm" data-auth-user-photo-remove>–£–¥–∞–ª–∏—Ç—å</button>
                          </div>
                        </div>
                        <div class="auth-user-photo-uploading d-none" data-auth-user-photo-uploading>
                          <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                          <span class="ms-2 small">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                      </div>
                      <div class="form-text mt-2" data-auth-user-photo-status></div>
                    </div>
                  </div>
                </div>
                <div class="row g-3">
                  <div class="col-12">
                    <div class="border rounded-3 p-3 bg-light-subtle">
                      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
                        <h6 class="mb-0">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h6>
                      </div>
                      <div class="row g-3">
                        <div class="col-md-6">
                          <label class="form-label small mb-1" for="authUserModalEmail">E-mail</label>
                          <input type="email" class="form-control form-control-sm" id="authUserModalEmail" name="email" autocomplete="off">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label small mb-1" for="authUserModalBirthDate">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                          <input type="date" class="form-control form-control-sm" id="authUserModalBirthDate" name="birth_date">
                        </div>
                      </div>
                      <div class="mt-3">
                        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                          <h6 class="mb-0">–¢–µ–ª–µ—Ñ–æ–Ω—ã</h6>
                          <button type="button" class="btn btn-outline-secondary btn-sm" data-auth-user-phone-add>+ –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω</button>
                        </div>
                        <div class="d-flex flex-column gap-2 mt-2" data-auth-user-phones></div>
                        <div class="text-muted small d-none" data-auth-user-phones-empty>–¢–µ–ª–µ—Ñ–æ–Ω—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã.</div>
                      </div>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="border rounded-3 p-3">
                      <div class="d-flex flex-column gap-3">
                        <div class="d-flex flex-column gap-2 d-none" data-auth-user-block-wrapper>
                          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                            <div>
                              <h6 class="mb-0">–°—Ç–∞—Ç—É—Å –¥–æ—Å—Ç—É–ø–∞</h6>
                              <p class="small text-muted mb-0">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–Ω–µ–ª–∏.</p>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                              <span class="badge rounded-pill text-bg-success auth-user-block-status" data-auth-user-block-status>–ê–∫—Ç–∏–≤–µ–Ω</span>
                              <button type="button" class="btn btn-outline-danger btn-sm" data-auth-user-block-toggle>–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                            </div>
                          </div>
                          <div class="small text-muted" data-auth-user-block-message>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤—Ö–æ–¥–∏—Ç—å –≤ –ø–∞–Ω–µ–ª—å.</div>
                        </div>
                        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2" data-auth-user-password-change-wrapper>
                          <div>
                            <h6 class="mb-0">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h6>
                            <p class="small text-muted mb-0">–ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—É—â–µ–≥–æ –ø–∞—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –ø—Ä–∞–≤–∞–º. –°–º–µ–Ω–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ.</p>
                          </div>
                          <button type="button" class="btn btn-outline-primary btn-sm" data-auth-user-password-change>–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                        </div>
                      </div>
                      <div class="mb-0 mt-3" data-auth-user-password-current>
                        <label class="form-label small mb-1">–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
                        <div class="input-group input-group-sm">
                          <input type="password" class="form-control" data-auth-user-password-display value="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" readonly>
                          <button type="button" class="btn btn-outline-secondary" data-auth-user-password-toggle data-action="toggle-password">–ü–æ–∫–∞–∑–∞—Ç—å</button>
                        </div>
                        <div class="form-text">–ü–∞—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø—Ä–∞–≤.</div>
                      </div>
                      <div class="mt-3 d-none" data-auth-user-password-create>
                        <div class="row g-3">
                          <div class="col-md-6">
                            <label class="form-label small mb-1" for="authUserModalPassword">–ü–∞—Ä–æ–ª—å</label>
                            <input type="password" class="form-control form-control-sm" id="authUserModalPassword" name="password" autocomplete="off" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å">
                          </div>
                          <div class="col-md-6">
                            <label class="form-label small mb-1" for="authUserModalPasswordConfirm">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                            <input
                              type="password"
                              class="form-control form-control-sm"
                              id="authUserModalPasswordConfirm"
                              autocomplete="off"
                              placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –ø–æ–≤—Ç–æ—Ä–Ω–æ"
                              data-auth-user-password-confirm
                            >
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-12">
                    <label class="form-label small mb-1" for="authUserModalRegistration">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</label>
                    <div class="row g-2 align-items-center flex-wrap">
                      <div class="col-auto">
                        <input type="text" class="form-control form-control-sm auth-user-registration-input" id="authUserModalRegistration" data-auth-user-registration readonly>
                      </div>
                      <div class="col-auto text-muted small auth-user-registration-relative" data-auth-user-registration-relative>‚Äî</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∏—Ç—å</button>
              <button type="submit" class="btn btn-primary" data-auth-user-submit>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="authUserPasswordModal" tabindex="-1" aria-hidden="true" data-auth-user-password-modal>
      <div class="modal-dialog">
        <div class="modal-content">
          <form data-auth-user-password-form>
            <div class="modal-header">
              <h5 class="modal-title">–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
            </div>
            <div class="modal-body">
              <div class="alert alert-danger d-none" role="alert" data-auth-user-password-error></div>
              <div class="mb-3">
                <label class="form-label small mb-1" for="authUserPasswordNew">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                <input type="password" class="form-control" id="authUserPasswordNew" autocomplete="off" data-auth-user-password-new placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
              </div>
              <div class="mb-3">
                <label class="form-label small mb-1" for="authUserPasswordConfirmNew">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                <input type="password" class="form-control" id="authUserPasswordConfirmNew" autocomplete="off" data-auth-user-password-confirm-new placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å –µ—â—ë —Ä–∞–∑">
              </div>
              <p class="small text-muted mb-0">–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–æ–ª–∏—Ç–∏–∫–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
              <button type="submit" class="btn btn-primary" data-auth-user-password-submit>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="authUserPhotoPreviewModal" tabindex="-1" aria-hidden="true" data-auth-user-photo-viewer-modal>
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark text-white auth-user-photo-preview-modal">
          <div class="modal-header border-0">
            <h5 class="modal-title">–§–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
          </div>
          <div class="modal-body text-center">
            <img src="" alt="–§–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" class="img-fluid rounded shadow" data-auth-user-photo-viewer-img loading="lazy">
          </div>
          <div class="modal-footer border-0 justify-content-center">
            <a href="#" class="btn btn-outline-light btn-sm" download data-auth-user-photo-download>–°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ</a>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="orgMembersModal" tabindex="-1" aria-hidden="true" data-org-members-modal>
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <form data-org-members-form>
            <div class="modal-header">
              <h5 class="modal-title" data-org-members-title>–°–æ—Å—Ç–∞–≤ –≤–µ—Ç–∫–∏</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <div class="text-muted small" data-org-members-description></div>
              </div>
              <div class="org-members-list" data-org-members-list></div>
              <div class="alert alert-info small d-none mt-3" data-org-members-empty>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.</div>
            </div>
            <div class="modal-footer justify-content-end">
              <button type="submit" class="btn btn-primary btn-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤ -->
    <div class="modal fade" id="categoriesModal" tabindex="-1" aria-labelledby="categoriesModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="categoriesModalLabel">üóÇÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
          </div>
          <div class="modal-body">
            <section class="mb-4">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">–®–∞–±–ª–æ–Ω—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π –æ–±—Ä–∞—â–µ–Ω–∏–π</h6>
                <button class="btn btn-sm btn-outline-success" type="button" onclick="addCategoryTemplate()">+ –®–∞–±–ª–æ–Ω</button>
              </div>
              <p class="small text-muted">–°–≥—Ä—É–ø–ø–∏—Ä—É–π—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –∏ –∑–∞–¥–∞–π—Ç–µ –∏–º–µ–Ω–∞, —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É –Ω–∞–±–æ—Ä–∞–º–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π.</p>
              <div id="categoryTemplatesList" class="d-flex flex-column gap-3"></div>
            </section>

            <hr>

            <section class="mb-4">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">–®–∞–±–ª–æ–Ω—ã —Ç–∏–ø–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤</h6>
                <button class="btn btn-sm btn-outline-success" type="button" onclick="addQuestionTemplate()">+ –®–∞–±–ª–æ–Ω</button>
              </div>
              <p class="small text-muted">–°–æ–∑–¥–∞–π—Ç–µ –Ω–∞–±–æ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏ –æ–±—â–µ–Ω–∏–∏ —Å –∫–ª–∏–µ–Ω—Ç–æ–º. –û–Ω–∏ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –æ–∫–Ω–µ –¥–∏–∞–ª–æ–≥–∞.</p>
              <div id="questionTemplatesList" class="d-flex flex-column gap-3"></div>
            </section>

            <hr>

            <section>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">–®–∞–±–ª–æ–Ω—ã –¥–µ–π—Å—Ç–≤–∏–π –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</h6>
                <button class="btn btn-sm btn-outline-success" type="button" onclick="addCompletionTemplate()">+ –®–∞–±–ª–æ–Ω</button>
              </div>
              <p class="small text-muted">–û–ø–∏—à–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –¥–∏–∞–ª–æ–≥–∞. –≠—Ç–∏ —à–∞–±–ª–æ–Ω—ã –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è.</p>
              <div id="completionTemplatesList" class="d-flex flex-column gap-3"></div>
            </section>

            <hr>

            <section>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">–¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏</h6>
              </div>
              <p class="small text-muted">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ—Ä–æ–≥–∏ –∏ —Ü–≤–µ—Ç–∞ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –±–ª–æ–∫–∞ ¬´–í—Ä–µ–º—è –æ–±—Ä–∞—â–µ–Ω–∏—è¬ª –≤ –æ–∫–Ω–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞.</p>
              <div class="row g-3 align-items-end">
                <div class="col-md-4">
                  <label for="timeMetricGoodLimit" class="form-label">–ó–µ–ª—ë–Ω–∞—è –∑–æ–Ω–∞, –º–∏–Ω</label>
                  <input type="number" class="form-control" id="timeMetricGoodLimit" min="1" step="1">
                  <div class="invalid-feedback">–£–∫–∞–∂–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –º–∏–Ω—É—Ç.</div>
                  <div class="form-text">–î–æ —ç—Ç–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –±–ª–æ–∫ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç—Å—è –∑–µ–ª–µ–Ω–æ–≤–∞—Ç—ã–º —Ü–≤–µ—Ç–æ–º.</div>
                </div>
                <div class="col-md-4">
                  <label for="timeMetricWarningLimit" class="form-label">–ñ—ë–ª—Ç–∞—è –∑–æ–Ω–∞, –º–∏–Ω</label>
                  <input type="number" class="form-control" id="timeMetricWarningLimit" min="1" step="1">
                  <div class="invalid-feedback">–ó–Ω–∞—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ –∑–µ–ª—ë–Ω–æ–π –∑–æ–Ω—ã.</div>
                  <div class="form-text">–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø–æ—Ä–æ–≥–∞ —Ü–≤–µ—Ç —Å—Ç–∞–Ω–µ—Ç –∫—Ä–∞—Å–Ω—ã–º.</div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">–¶–≤–µ—Ç–æ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã</label>
                  <div class="d-flex flex-column gap-2">
                    <label class="d-flex align-items-center gap-2">
                      <span class="small text-muted flex-grow-1">–ó–µ–ª—ë–Ω—ã–π</span>
                      <input type="color" class="form-control form-control-color" id="timeMetricColorGood" title="–¶–≤–µ—Ç –∑–µ–ª—ë–Ω–æ–π –∑–æ–Ω—ã">
                    </label>
                    <label class="d-flex align-items-center gap-2">
                      <span class="small text-muted flex-grow-1">–ñ—ë–ª—Ç—ã–π</span>
                      <input type="color" class="form-control form-control-color" id="timeMetricColorWarning" title="–¶–≤–µ—Ç –∂—ë–ª—Ç–æ–π –∑–æ–Ω—ã">
                    </label>
                    <label class="d-flex align-items-center gap-2">
                      <span class="small text-muted flex-grow-1">–ö—Ä–∞—Å–Ω—ã–π</span>
                      <input type="color" class="form-control form-control-color" id="timeMetricColorDanger" title="–¶–≤–µ—Ç –∫—Ä–∞—Å–Ω–æ–π –∑–æ–Ω—ã">
                    </label>
                  </div>
                </div>
              </div>
              <div class="mt-3">
                <label class="form-label">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</label>
                <div id="timeMetricPreview" class="dialog-time-metrics-preview"></div>
              </div>
            </section>
          </div>
          <div class="modal-footer">
            <div class="small text-muted me-auto">–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤—Å—Ç—É–ø—è—Ç –≤ —Å–∏–ª—É –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.</div>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            <button type="button" class="btn btn-primary" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
          </div>
        </div>
      </div>
    </div>

    <!-- –õ–æ–∫–∞—Ü–∏–∏ -->
    <div class="modal fade" id="locationsModal" tabindex="-1" aria-labelledby="locationsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="locationsModalLabel">üß≠ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–æ–∫–∞—Ü–∏–π</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
          </div>
          <div class="modal-body">
            <p class="mb-3">–†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –±–∏–∑–Ω–µ—Å ‚Üí —Ç–∏–ø ‚Üí –≥–æ—Ä–æ–¥ ‚Üí –ª–æ–∫–∞—Ü–∏–∏. –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –¥–µ—Ä–µ–≤–æ —Å–≤—ë—Ä–Ω—É—Ç–æ –¥–æ —É—Ä–æ–≤–Ω—è —Ç–∏–ø–æ–≤.</p>
            <div class="d-flex flex-wrap gap-2 mb-3">
              <button class="btn btn-sm btn-primary" type="button" onclick="openAddLocationWizard()">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
              <button class="btn btn-sm btn-success" type="button" onclick="addBusiness()">+ –î–æ–±–∞–≤–∏—Ç—å –±–∏–∑–Ω–µ—Å</button>
            </div>
            <div id="locationsEditor" class="mb-3">
              <!-- –î–µ—Ä–µ–≤–æ –±—É–¥–µ—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
          </div>
          <div class="modal-footer justify-content-end">
            <button class="btn btn-primary" type="button" onclick="saveLocationsChanges()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
          </div>
        </div>
      </div>
    </div>

    <!-- –ú–∞—Å—Ç–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –ª–æ–∫–∞—Ü–∏–π -->
    <div class="modal fade" id="locationWizardModal" tabindex="-1" aria-labelledby="locationWizardLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="locationWizardLabel">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
          </div>
          <div class="modal-body">
            <div class="location-wizard-steps">
              <div data-location-wizard-step="0" class="location-wizard-step mb-3">
                <label for="wizardBusinessSelect" class="form-label">1. –í—ã–±–µ—Ä–∏—Ç–µ –±–∏–∑–Ω–µ—Å</label>
                <select id="wizardBusinessSelect" class="form-select" required></select>
                <div class="form-text">–°–ø–∏—Å–æ–∫ –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤.</div>
              </div>
              <div data-location-wizard-step="1" class="location-wizard-step mb-3 d-none">
                <label for="wizardTypeSelect" class="form-label">2. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</label>
                <select id="wizardTypeSelect" class="form-select" required></select>
              </div>
              <div data-location-wizard-step="2" class="location-wizard-step mb-3 d-none">
                <label for="wizardCitySelect" class="form-label">3. –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</label>
                <select id="wizardCitySelect" class="form-select" required></select>
                <div class="form-text">–î–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ –±–ª–æ–∫–∞ ¬´–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤¬ª ‚Üí ¬´–ì–æ—Ä–æ–¥¬ª.</div>
              </div>
              <div data-location-wizard-step="3" class="location-wizard-step mb-3 d-none">
                <label for="wizardDepartmentSelect" class="form-label">4. –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</label>
                <select id="wizardDepartmentSelect" class="form-select" required></select>
              </div>
            </div>
            <div class="alert alert-light border" id="wizardSummary"></div>
          </div>
          <div class="modal-footer justify-content-between">
            <div>
              <button type="button" class="btn btn-outline-secondary" id="wizardPrevStep">–ù–∞–∑–∞–¥</button>
            </div>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-primary" id="wizardNextStep">–î–∞–ª–µ–µ</button>
              <button type="button" class="btn btn-success d-none" id="wizardFinish">–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
    <div class="modal fade" id="statusesModal" tabindex="-1" aria-labelledby="statusesModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="statusesModalLabel">üè∑Ô∏è –°—Ç–∞—Ç—É—Å—ã –∫–ª–∏–µ–Ω—Ç–æ–≤</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
          </div>
          <div class="modal-body">
            <div class="client-status-toolbar mb-3">
              <div class="d-flex align-items-center gap-2">
                <h6 class="mb-0">–°–ø–∏—Å–æ–∫ —Å—Ç–∞—Ç—É—Å–æ–≤</h6>
                <span class="text-muted small">–ò–∑–º–µ–Ω–µ–Ω–∏—è –º–æ–∂–Ω–æ –≤–Ω–æ—Å–∏—Ç—å –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.</span>
              </div>
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-primary btn-sm" id="editStatusesBtn" onclick="startStatusesEdit()">
                  <i class="bi bi-pencil-square me-1"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                </button>
                <button type="button" class="btn btn-success btn-sm d-none" id="saveStatusesBtn" onclick="saveClientStatuses()">
                  <i class="bi bi-check-lg me-1"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm d-none" id="cancelStatusesBtn" onclick="cancelStatusesEdit()">
                  –û—Ç–º–µ–Ω–∞
                </button>
              </div>
            </div>
            <div id="statusesList" class="list-group"></div>
            <div id="statusesEmptyPlaceholder" class="text-muted fst-italic small d-none">
              –ü–æ–∫–∞ –Ω–µ—Ç —Å—Ç–∞—Ç—É—Å–æ–≤. –ù–∞–∂–º–∏—Ç–µ ¬´–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å¬ª, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π —Å—Ç–∞—Ç—É—Å.
            </div>
            <button class="btn btn-sm btn-success mt-3 d-none" id="addStatusBtn" type="button" onclick="addStatus()">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
          </div>
        </div>
      </div>
    </div>

    <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ -->
    <div class="modal fade" id="parametersModal" tabindex="-1" aria-labelledby="parametersModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="parametersModalLabel">üß© –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
          </div>
          <div class="modal-body">
            <ul class="nav nav-tabs mb-3" id="partnerParametersTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link active"
                  id="partnerParametersTabContragentsTab"
                  data-bs-toggle="tab"
                  data-bs-target="#partnerParametersTabContragents"
                  type="button"
                  role="tab"
                  aria-controls="partnerParametersTabContragents"
                  aria-selected="true"
                >
                  –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link"
                  id="partnerParametersTabFranchiseTab"
                  data-bs-toggle="tab"
                  data-bs-target="#partnerParametersTabFranchise"
                  type="button"
                  role="tab"
                  aria-controls="partnerParametersTabFranchise"
                  aria-selected="false"
                >
                  –§—Ä–∞–Ω—á–∞–π–∑–∏
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link"
                  id="partnerParametersTabBasicsTab"
                  data-bs-toggle="tab"
                  data-bs-target="#partnerParametersTabBasics"
                  type="button"
                  role="tab"
                  aria-controls="partnerParametersTabBasics"
                  aria-selected="false"
                >
                  –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
              </li>
            </ul>
            <div class="tab-content" id="partnerParametersTabsContent">
              <div
                class="tab-pane fade show active"
                id="partnerParametersTabContragents"
                role="tabpanel"
                aria-labelledby="partnerParametersTabContragentsTab"
                data-partner-contacts-section="partner"
              >
                <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
                  <div>
                    <h6 class="mb-1">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤</h6>
                    <p class="small text-muted mb-0">–§–∏–∫—Å–∏—Ä—É–π—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã, e-mail –∏ —Å–≤—è–∑—å —Å —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º–∏ –ª–∏—Ü–∞–º–∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤.</p>
                  </div>
                  <button class="btn btn-sm btn-success" type="button" data-partner-contact-add="partner">+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</button>
                </div>
                <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3" data-partner-contacts-list></div>
                <div class="card border-0 bg-light text-center py-5 d-none" data-partner-contacts-empty>
                  <div class="card-body">
                    <div class="fw-semibold mb-1">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</div>
                    <div class="text-muted small">–ù–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç¬ª, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞—Ö.</div>
                  </div>
                </div>
              </div>
              <div
                class="tab-pane fade"
                id="partnerParametersTabFranchise"
                role="tabpanel"
                aria-labelledby="partnerParametersTabFranchiseTab"
                data-partner-contacts-section="ka"
              >
                <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
                  <div>
                    <h6 class="mb-1">–ö–æ–Ω—Ç–∞–∫—Ç—ã —Ñ—Ä–∞–Ω—á–∞–π–∑–∏</h6>
                    <p class="small text-muted mb-0">–•—Ä–∞–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –æ —Ñ—Ä–∞–Ω—á–∞–π–∑–∏: —Ç–µ–ª–µ—Ñ–æ–Ω—ã, –ø–æ—á—Ç—É –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ª–∏—Ü.</p>
                  </div>
                  <button class="btn btn-sm btn-success" type="button" data-partner-contact-add="ka">+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</button>
                </div>
                <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3" data-partner-contacts-list></div>
                <div class="card border-0 bg-light text-center py-5 d-none" data-partner-contacts-empty>
                  <div class="card-body">
                    <div class="fw-semibold mb-1">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</div>
                    <div class="text-muted small">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –≤–µ—Å—Ç–∏ –±–∞–∑—É —Ñ—Ä–∞–Ω—á–∞–π–∑–∏.</div>
                  </div>
                </div>
              </div>
              <div
                class="tab-pane fade"
                id="partnerParametersTabBasics"
                role="tabpanel"
                aria-labelledby="partnerParametersTabBasicsTab"
              >
                <div class="row g-3">
                  {% for slug, title in parameter_types.items() %}
                  {% if slug not in ['it_connection', 'remote_access', 'legal_entity'] %}
                  <div class="col-md-6 col-xl-4">
                    <div class="card shadow-sm parameter-card" data-param-type="{{ slug }}">
                      <div class="card-header d-flex justify-content-between align-items-center">
                        <button type="button" class="btn btn-link flex-grow-1 text-start" data-param-toggle>
                          {{ title }}
                        </button>
                        <span class="badge bg-secondary" data-param-count>0</span>
                      </div>
                      <div class="card-body d-none" data-param-body></div>
                      <div class="px-3 py-2 small text-muted d-none" data-param-hint>
                        –°–ø–∏—Å–æ–∫ —Å–æ–¥–µ—Ä–∂–∏—Ç –±–æ–ª–µ–µ 10 –∑–∞–ø–∏—Å–µ–π. –ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ.
                      </div>
                    </div>
                  </div>
                  {% endif %}
                  {% endfor %}
                  <div class="col-md-6 col-xl-4">
                    <div
                      class="card shadow-sm parameter-card"
                      data-city-card
                      data-city-count="{{ cities | length }}"
                    >
                      <div class="card-header d-flex justify-content-between align-items-center">
                        <button type="button" class="btn btn-link flex-grow-1 text-start" data-city-toggle>
                          –ì–æ—Ä–æ–¥
                        </button>
                        <span class="badge bg-secondary">{{ cities | length }}</span>
                      </div>
                      <div class="card-body" data-city-body>
                        <div class="param-items" data-city-list>
                          {% if cities %}
                          <ul class="list-group list-group-flush">
                            {% for city in cities %}
                            <li class="list-group-item py-1 px-2">{{ city }}</li>
                            {% endfor %}
                          </ul>
                          {% else %}
                          <div class="empty-placeholder">–ü–æ–∫–∞ –Ω–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–π</div>
                          {% endif %}
                        </div>
                      </div>
                      <div class="px-3 py-2 small text-muted d-none" data-city-hint>
                        –°–ø–∏—Å–æ–∫ —Å–æ–¥–µ—Ä–∂–∏—Ç –±–æ–ª–µ–µ 10 –∑–∞–ø–∏—Å–µ–π. –ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ.
                      </div>
                    </div>
                  </div>
                </div>
                <div class="form-text text-muted mt-3">
                  –≠—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ —Ñ–æ—Ä–º–∞—Ö —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤, –∑–∞–¥–∞—á –∏ –¥—Ä—É–≥–∏—Ö —Ä–∞–∑–¥–µ–ª–æ–≤.
                </div>
              </div>
            </div>
          </div>
    </div>
  </div>
</div>

    <div class="modal fade" id="parameterItemsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" data-param-modal-title>–ó–Ω–∞—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
          </div>
          <div class="modal-body" data-param-modal-body></div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="legalEntitiesModal" tabindex="-1" aria-labelledby="legalEntitiesModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="legalEntitiesModalLabel">üè¢ –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –ª–∏—Ü–∞</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
          </div>
          <div class="modal-body">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
              <div>
                <h6 class="mb-1">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü</h6>
                <p class="small text-muted mb-0">–•—Ä–∞–Ω–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –¥–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤.</p>
              </div>
              <button class="btn btn-sm btn-success" type="button" data-legal-entity-add>+ –î–æ–±–∞–≤–∏—Ç—å –Æ–õ</button>
            </div>
            <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3" data-legal-entities-list></div>
            <div class="card border-0 bg-light text-center py-5 d-none" data-legal-entities-empty>
              <div class="card-body">
                <div class="fw-semibold mb-1">–ü–æ–∫–∞ –Ω–µ—Ç —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü</div>
                <div class="text-muted small">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–î–æ–±–∞–≤–∏—Ç—å –Æ–õ¬ª, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å.</div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <div class="small text-muted me-auto">–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–Ω–æ–ø–∫–∞–º–∏ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö.</div>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="partnerContactEditorModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" data-partner-contact-editor-title>–ö–∞—Ä—Ç–æ—á–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
          </div>
          <div class="modal-body" data-partner-contact-editor-body>
            <div class="text-center text-muted py-5">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.</div>
          </div>
          <div class="modal-footer justify-content-between flex-wrap gap-2">
            <div class="d-flex flex-wrap gap-2 d-none" data-partner-contact-editor-actions></div>
          </div>
        </div>
      </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è IT-–±–ª–æ–∫–∞ –∏ –ø—Ä–æ—Ñ–∏–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ -->
    <div class="modal fade" id="itConnectionsModal" tabindex="-1" aria-labelledby="itConnectionsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="itConnectionsModalLabel">üñß –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è IT-–±–ª–æ–∫–∞</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
          </div>
          <div class="modal-body">
            <div
              class="row row-cols-1 row-cols-sm-2 row-cols-xl-4 g-3 mb-4 settings-tiles"
              data-it-section-tiles
            >
              <div class="col">
                <div class="card settings-tile h-100" data-it-section-target="#itEquipmentSection" tabindex="0">
                  <div class="card-body text-center">
                    <div class="tile-icon">üóÉÔ∏è</div>
                    <h6 class="card-title mb-1">–ö–∞—Ç–∞–ª–æ–≥ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h6>
                    <p class="card-text text-muted small mb-0">–ö–∞—Ä—Ç–æ—á–∫–∏ –º–æ–¥–µ–ª–µ–π –∏ —Å–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã.</p>
                  </div>
                </div>
              </div>
              <div class="col">
                <div class="card settings-tile h-100" data-it-section-target="#itConnectionsSection" tabindex="0">
                  <div class="card-body text-center">
                    <div class="tile-icon">üîå</div>
                    <h6 class="card-title mb-1">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</h6>
                    <p class="card-text text-muted small mb-0">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ç–∏–ø—ã –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π.</p>
                  </div>
                </div>
              </div>
              <div class="col">
                <div class="card settings-tile h-100" data-it-section-target="#networkProfilesSection" tabindex="0">
                  <div class="card-body text-center">
                    <div class="tile-icon">üì°</div>
                    <h6 class="card-title mb-1">–ü—Ä–æ—Ñ–∏–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤</h6>
                    <p class="card-text text-muted small mb-0">–ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –¥–æ–≥–æ–≤–æ—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π.</p>
                  </div>
                </div>
              </div>
              <div class="col">
                <div class="card settings-tile h-100" data-it-section-target="#remoteAccessSection" tabindex="0">
                  <div class="card-body text-center">
                    <div class="tile-icon">üåê</div>
                    <h6 class="card-title mb-1">–£–¥–∞–ª—ë–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø</h6>
                    <p class="card-text text-muted small mb-0">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –∏–Ω–∂–µ–Ω–µ—Ä–æ–≤.</p>
                  </div>
                </div>
              </div>
            </div>
            <div class="accordion it-section-accordion" id="itSettingsAccordion">
              <div class="accordion-item">
                <h2 class="accordion-header" id="itEquipmentSectionHeading">
                  <button
                    class="accordion-button"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#itEquipmentSection"
                    aria-expanded="true"
                    aria-controls="itEquipmentSection"
                  >
                    –ö–∞—Ç–∞–ª–æ–≥ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                  </button>
                </h2>
                <div
                  id="itEquipmentSection"
                  class="accordion-collapse collapse show"
                  aria-labelledby="itEquipmentSectionHeading"
                  data-bs-parent="#itSettingsAccordion"
                >
                  <div class="accordion-body">
                    <div class="table-responsive">
                      <table class="table table-sm align-middle" id="itEquipmentTable">
                        <thead>
                          <tr>
                            <th>–¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</th>
                            <th>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</th>
                            <th>–ú–æ–¥–µ–ª—å</th>
                            <th>–°—Å—ã–ª–∫–∏</th>
                            <th></th>
                          </tr>
                        </thead>
                        <tbody id="itEquipmentBody"></tbody>
                      </table>
                    </div>
                    <button
                      class="btn btn-sm btn-success mt-3"
                      type="button"
                      data-bs-toggle="modal"
                      data-bs-target="#itEquipmentAddModal"
                    >
                      + –î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                    </button>
                    <div class="form-text text-muted mt-2">
                      –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–∞—Å–ø–æ—Ä—Ç–æ–≤ –æ–±—ä–µ–∫—Ç–æ–≤.
                    </div>
                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h2 class="accordion-header" id="itConnectionsSectionHeading">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#itConnectionsSection"
                    aria-expanded="false"
                    aria-controls="itConnectionsSection"
                  >
                    –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                  </button>
                </h2>
                <div
                  id="itConnectionsSection"
                  class="accordion-collapse collapse"
                  aria-labelledby="itConnectionsSectionHeading"
                  data-bs-parent="#itSettingsAccordion"
                >
                  <div class="accordion-body">
                    <div
                      class="accordion it-section-accordion it-section-accordion--nested"
                      id="itConnectionsCategoryAccordion"
                      data-it-connections-container
                    ></div>
                    <button
                      class="btn btn-sm btn-success mt-3"
                      type="button"
                      data-bs-toggle="modal"
                      data-bs-target="#itConnectionAddModal"
                    >
                      + –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                    </button>
                    <div class="form-text text-muted mt-2">
                      –ó–¥–µ—Å—å —É–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–ø–∏—Å–∫–æ–º –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π IT-–±–ª–æ–∫–∞.
                    </div>
                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h2 class="accordion-header" id="networkProfilesSectionHeading">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#networkProfilesSection"
                    aria-expanded="false"
                    aria-controls="networkProfilesSection"
                  >
                    –ü—Ä–æ—Ñ–∏–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
                  </button>
                </h2>
                <div
                  id="networkProfilesSection"
                  class="accordion-collapse collapse"
                  aria-labelledby="networkProfilesSectionHeading"
                  data-bs-parent="#itSettingsAccordion"
                >
                  <div class="accordion-body">
                    <div class="table-responsive">
                      <table class="table table-sm align-middle" id="networkProfilesTable">
                        <thead>
                          <tr>
                            <th>–ü—Ä–æ–≤–∞–π–¥–µ—Ä</th>
                            <th>–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞</th>
                            <th>ID —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</th>
                            <th>–¢–µ–ª–µ—Ñ–æ–Ω –¢–ü</th>
                            <th>–Æ–õ</th>
                            <th>–û–±—ä–µ–∫—Ç–æ–≤</th>
                            <th></th>
                          </tr>
                        </thead>
                        <tbody id="networkProfilesBody"></tbody>
                      </table>
                    </div>
                    <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mt-3">
                      <button class="btn btn-sm btn-success" type="button" data-network-profiles-add>+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
                      <button class="btn btn-sm btn-primary" type="button" data-network-profiles-save>
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                      </button>
                    </div>
                    <div class="form-text text-muted mt-2">–≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è—Ç—å—Å—è –≤ –ø–∞—Å–ø–æ—Ä—Ç –æ–±—ä–µ–∫—Ç–∞.</div>
                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h2 class="accordion-header" id="remoteAccessSectionHeading">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#remoteAccessSection"
                    aria-expanded="false"
                    aria-controls="remoteAccessSection"
                  >
                    –£–¥–∞–ª—ë–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø
                  </button>
                </h2>
                <div
                  id="remoteAccessSection"
                  class="accordion-collapse collapse"
                  aria-labelledby="remoteAccessSectionHeading"
                  data-bs-parent="#itSettingsAccordion"
                >
                  <div class="accordion-body">
                    <p class="text-muted small mb-3">
                      –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –¥–ª—è —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–Ω–∂–µ–Ω–µ—Ä–æ–≤.
                    </p>
                    <div data-remote-access-container></div>
                  </div>
                </div>
              </div>
            </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="networkProfileEditorModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <form data-network-profile-form>
            <div class="modal-header">
              <h5 class="modal-title" data-network-profile-title>–ü—Ä–æ—Ñ–∏–ª—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
            </div>
            <div class="modal-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label" for="networkProfileProviderInput">–ü—Ä–æ–≤–∞–π–¥–µ—Ä</label>
                  <input
                    type="text"
                    class="form-control"
                    id="networkProfileProviderInput"
                    data-network-profile-provider
                    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –†–æ—Å—Ç–µ–ª–µ–∫–æ–º"
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="networkProfileContractInput">–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞</label>
                  <input
                    type="text"
                    class="form-control"
                    id="networkProfileContractInput"
                    data-network-profile-contract
                    placeholder="–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞"
                  />
                </div>
                <div class="col-12">
                  <label class="form-label">ID —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</label>
                  <div class="d-flex flex-column gap-2" data-network-profile-restaurant-ids></div>
                  <button type="button" class="btn btn-sm btn-outline-primary mt-2" data-network-profile-add-restaurant-id>
                    + –î–æ–±–∞–≤–∏—Ç—å ID —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
                  </button>
                  <div class="form-text text-muted">–ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è.</div>
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="networkProfileSupportPhoneInput">–¢–µ–ª–µ—Ñ–æ–Ω –¢–ü</label>
                  <input
                    type="text"
                    class="form-control"
                    id="networkProfileSupportPhoneInput"
                    data-network-profile-support-phone
                    placeholder="–¢–µ–ª–µ—Ñ–æ–Ω —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏"
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="networkProfileLegalEntityInput">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ</label>
                  <input
                    type="text"
                    class="form-control"
                    id="networkProfileLegalEntityInput"
                    data-network-profile-legal-entity
                    placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Æ–õ"
                  />
                </div>
              </div>
            </div>
            <div class="modal-footer justify-content-between flex-wrap gap-2">
              <button type="button" class="btn btn-outline-danger d-none" data-network-profile-delete>–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
              <div class="d-flex gap-2 ms-auto">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="itConnectionAddModal" tabindex="-1" aria-labelledby="itConnectionAddModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="itConnectionAddModalLabel">–ù–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
          </div>
          <form data-it-connection-add-form>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label" for="itConnectionCategorySelect">–í—ã–±–µ—Ä–∏—Ç–µ, —á—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å</label>
                <div class="input-group">
                  <select class="form-select" id="itConnectionCategorySelect" data-it-connection-category-select>
                    {% for key, label in it_connection_categories.items() %}
                    <option value="{{ key }}">{{ label }}</option>
                    {% endfor %}
                  </select>
                  <button
                    class="btn btn-outline-secondary"
                    type="button"
                    data-it-connection-category-create
                  >
                    + –ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
                  </button>
                </div>
                <div class="form-text">–ï—Å–ª–∏ –Ω—É–∂–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ, —Å–æ–∑–¥–∞–π—Ç–µ –µ—ë.</div>
              </div>
              <div>
                <label class="form-label" for="itConnectionValueInput">–ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</label>
                <input
                  type="text"
                  class="form-control"
                  id="itConnectionValueInput"
                  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, TeamViewer"
                  data-it-connection-value-input
                >
                <div class="form-text">–í–≤–µ–¥–∏—Ç–µ –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.</div>
                <div class="invalid-feedback">–£–∫–∞–∂–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.</div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
              <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="itEquipmentAddModal" tabindex="-1" aria-labelledby="itEquipmentAddModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="itEquipmentAddModalLabel">–ù–æ–≤–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
          </div>
          <form data-it-equipment-add-form>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label" for="itEquipmentTypeSelect">–¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</label>
                <select class="form-select" id="itEquipmentTypeSelect" data-it-equipment-field="equipment_type" required></select>
                <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∏–∑ —Ä–∞–Ω–µ–µ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π.</div>
                <div class="invalid-feedback">–£–∫–∞–∂–∏—Ç–µ —Ç–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.</div>
              </div>
              <div class="mb-3">
                <label class="form-label" for="itEquipmentVendorSelect">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</label>
                <select class="form-select" id="itEquipmentVendorSelect" data-it-equipment-field="equipment_vendor" required></select>
                <div class="invalid-feedback">–£–∫–∞–∂–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.</div>
              </div>
              <div class="mb-3">
                <label class="form-label" for="itEquipmentModelSelect">–ú–æ–¥–µ–ª—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</label>
                <select class="form-select" id="itEquipmentModelSelect" data-it-equipment-field="equipment_model" required></select>
                <div class="invalid-feedback">–£–∫–∞–∂–∏—Ç–µ –º–æ–¥–µ–ª—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.</div>
              </div>
              <div class="mb-3">
                <label class="form-label">–°—Å—ã–ª–∫–∏ <span class="text-muted">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></label>
                <div class="d-flex flex-column gap-2" data-it-equipment-add-links></div>
                <button
                  class="btn btn-sm btn-outline-secondary mt-2"
                  type="button"
                  data-it-equipment-add-link
                >
                  + –î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É
                </button>
                <div class="form-text">–ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Å—ã–ª–æ–∫ –Ω–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –∫–∞—Ä—Ç–æ—á–∫–∏ –∏ —Ç.–ø.</div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
              <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="botRatingTemplateModal" tabindex="-1" aria-labelledby="botRatingTemplateLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="botRatingTemplateLabel">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ –æ—Ü–µ–Ω–æ–∫</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label" for="botRatingTemplateName">–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞</label>
              <input type="text" class="form-control" id="botRatingTemplateName" data-bot-rating-template-name>
            </div>
            <div class="mb-3">
              <label class="form-label" for="botRatingTemplateDescription">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
              <textarea class="form-control" id="botRatingTemplateDescription" rows="2" data-bot-rating-template-description></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label" for="botRatingTemplatePrompt">–¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞</label>
              <textarea class="form-control" id="botRatingTemplatePrompt" rows="2" data-bot-rating-template-prompt></textarea>
              <div class="form-text">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ {ticket_id} –∏ {scale}.</div>
            </div>
            <div class="row g-3">
              <div class="col-lg-4">
                <label class="form-label" for="botRatingTemplateScale">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ü–µ–Ω–æ–∫</label>
                <input
                  type="number"
                  class="form-control"
                  id="botRatingTemplateScale"
                  min="1"
                  max="10"
                  step="1"
                  data-bot-rating-template-scale
                >
                <div class="form-text">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç 1 –¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞.</div>
              </div>
              <div class="col-lg-8">
                <label class="form-label">–û—Ç–≤–µ—Ç—ã –¥–ª—è –æ—Ü–µ–Ω–æ–∫</label>
                <div class="d-flex flex-column gap-2" data-bot-rating-template-responses></div>
                <div class="form-text">–ö–∞–∂–¥—ã–π —Ç–µ–∫—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –æ—Ü–µ–Ω–∫–µ. –î–æ—Å—Ç—É–ø–Ω—ã –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ {value} –∏ {scale}.</div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <div class="small text-muted me-auto" data-bot-rating-template-status></div>
            <button type="button" class="btn btn-outline-secondary" data-bot-rating-template-cancel data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
            <button type="button" class="btn btn-primary" data-bot-rating-template-save>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="botTemplateEditorModal" tabindex="-1" aria-labelledby="botTemplateEditorLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="botTemplateEditorLabel">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ –≤–æ–ø—Ä–æ—Å–æ–≤</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label" for="botTemplateNameInput">–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞</label>
              <input type="text" class="form-control" id="botTemplateNameInput" data-bot-template-name>
            </div>
            <div class="mb-3">
              <label class="form-label" for="botTemplateDescriptionInput">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
              <textarea class="form-control" id="botTemplateDescriptionInput" rows="2" data-bot-template-description></textarea>
            </div>
            <div class="mb-3">
              <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
                <div>
                  <h6 class="mb-1">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–æ–ø—Ä–æ—Å–æ–≤</h6>
                  <p class="small text-muted mb-0">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–æ–ø—Ä–æ—Å–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–≤–æ–±–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–ª–∏ –≥–æ—Ç–æ–≤—ã–µ –ø–æ–ª—è –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤.</p>
                </div>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-primary" type="button" data-bot-question-add data-type="custom">+ –°–≤–æ–±–æ–¥–Ω—ã–π –≤–æ–ø—Ä–æ—Å</button>
                  <button class="btn btn-outline-secondary" type="button" data-bot-question-add data-type="preset">+ –ì–æ—Ç–æ–≤–æ–µ –ø–æ–ª–µ</button>
                </div>
              </div>
              <div class="d-flex flex-column gap-3" data-bot-questions-container></div>
              <div class="card border-0 bg-light mt-3" data-bot-presets-summary>
                <div class="card-body py-3">
                  <div class="fw-semibold mb-1">–î–æ—Å—Ç—É–ø–Ω—ã–µ –≥–æ—Ç–æ–≤—ã–µ –ø–æ–ª—è</div>
                  <div class="small text-muted" data-bot-preset-hints></div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <div class="small text-muted me-auto" data-bot-template-status></div>
            <button type="button" class="btn btn-outline-secondary" data-bot-template-cancel data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
            <button type="button" class="btn btn-primary" data-bot-template-save>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
          </div>
        </div>
      </div>
    </div>

    <!-- –ö–∞–Ω–∞–ª—ã (–±–æ—Ç—ã) -->
    <div class="modal fade" id="channelsModal" tabindex="-1" aria-labelledby="channelsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="channelsModalLabel">ü§ñ –ö–∞–Ω–∞–ª—ã (–±–æ—Ç—ã)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
          </div>
          <div class="modal-body">
            <ul class="nav nav-tabs" id="channelsTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link active"
                  id="channels-manage-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#channels-manage"
                  type="button"
                  role="tab"
                  aria-controls="channels-manage"
                  aria-selected="true"
                >
                  –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞–º–∏
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link"
                  id="channels-templates-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#channels-templates"
                  type="button"
                  role="tab"
                  aria-controls="channels-templates"
                  aria-selected="false"
                >
                  –®–∞–±–ª–æ–Ω—ã
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link"
                  id="channels-automation-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#channels-automation"
                  type="button"
                  role="tab"
                  aria-controls="channels-automation"
                  aria-selected="false"
                >
                  –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
                </button>
              </li>
            </ul>

            <div class="tab-content pt-3" id="channelsTabsContent">
              <div
                class="tab-pane fade show active"
                id="channels-manage"
                role="tabpanel"
                aria-labelledby="channels-manage-tab"
              >
                <div class="card mb-4 shadow-sm">
                  <div class="card-body">
                    <h5 class="card-title">–î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª</h5>
                    <div class="row g-3 align-items-end">
                      <div class="col-12 col-md-4 col-xl-3" id="token_field_container">
                        <label class="form-label" for="new_token">–¢–æ–∫–µ–Ω –±–æ—Ç–∞</label>
                        <input id="new_token" class="form-control" placeholder="–¢–æ–∫–µ–Ω –∏–∑ BotFather">
                        <div class="form-text">–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è Telegram.</div>
                      </div>
                      <div class="col-12 col-md-4 col-xl-3">
                        <label class="form-label" for="new_channel_name">–ù–∞–∑–≤–∞–Ω–∏–µ –≤ –ø–∞–Ω–µ–ª–∏</label>
                        <input id="new_channel_name" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–æ—Å—Ç–∞–≤–∫–∞">
                        <div class="form-text">–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–æ–≤.</div>
                      </div>
                      <div class="col-12 col-md-4 col-xl-2">
                        <label class="form-label" for="new_platform">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</label>
                        <select id="new_platform" class="form-select">
                          <option value="telegram" selected>Telegram</option>
                          <option value="vk">VK</option>
                        </select>
                      </div>
                      <div class="col-12 col-md-4 col-xl-3">
                        <label class="form-label" for="new_question_template">–®–∞–±–ª–æ–Ω –≤–æ–ø—Ä–æ—Å–æ–≤</label>
                        <select id="new_question_template" class="form-select"></select>
                      </div>
                      <div class="col-12 col-md-4 col-xl-3">
                        <label class="form-label" for="new_rating_template">–°–∏—Å—Ç–µ–º–∞ –æ—Ü–µ–Ω–æ–∫</label>
                        <select id="new_rating_template" class="form-select"></select>
                      </div>
                      <div class="col-12 col-md-4 col-xl-3">
                        <label class="form-label" for="new_auto_action_template">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</label>
                        <select id="new_auto_action_template" class="form-select"></select>
                      </div>
                      <div class="col-12 col-xl-2 d-grid ms-xl-auto">
                        <button class="btn btn-primary" type="button" onclick="addChannel()">–î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª</button>
                      </div>
                      <div class="col-12" id="vk_group_id_container" style="display: none;">
                        <div class="row g-3">
                          <div class="col-12 col-md-4 col-xl-3">
                            <label class="form-label" for="new_vk_group_id">ID —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ VK</label>
                            <input id="new_vk_group_id" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 123456789">
                            <div class="form-text">–ù–∞–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ ‚Üí –†–∞–±–æ—Ç–∞ —Å API.</div>
                          </div>
                          <div class="col-12 col-md-4 col-xl-3">
                            <label class="form-label" for="new_vk_confirmation">–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è Callback API</label>
                            <input id="new_vk_confirmation" class="form-control" placeholder="–°—Ç—Ä–æ–∫–∞ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ Callback API">
                          </div>
                          <div class="col-12 col-md-4 col-xl-3">
                            <label class="form-label" for="new_vk_secret">–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                            <input id="new_vk_secret" class="form-control" placeholder="–ï—Å–ª–∏ –∑–∞–¥–∞–Ω –≤ VK">
                          </div>
                        </div>
                        <div class="alert alert-info small mt-3 mb-0" role="alert">
                          <div class="fw-semibold mb-1">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ VK Callback API</div>
                          <ol class="mb-0 ps-3">
                            <li>–í —Å–æ–æ–±—â–µ—Å—Ç–≤–µ –æ—Ç–∫—Ä–æ–π—Ç–µ ¬´–†–∞–±–æ—Ç–∞ —Å API¬ª ‚Üí ¬´Callback API¬ª –∏ —É–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –≤–∏–¥–∞ <code>https://–≤–∞—à-–¥–æ–º–µ–Ω/webhooks/vk/&lt;group_id&gt;</code>.</li>
                            <li>–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∑–∞–ø—Ä–æ—Å–æ–≤.</li>
                            <li>–ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ —Å–æ–±—ã—Ç–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–µ—Ä–≤–∏—Å–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ <code>python vk_webhook_support.py</code>.</li>
                          </ol>
                        </div>
                      </div>
                    </div>
                    <div class="text-muted small mt-2">–î–ª—è Telegram —Ç–æ–∫–µ–Ω –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ <code>getMe</code>. –î–ª—è VK –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Callback API –±–µ–∑ —Ç–æ–∫–µ–Ω–∞.</div>
                  </div>
                </div>

                <div class="table-responsive shadow-sm">
                  <table class="table align-middle mb-0">
                    <thead class="table-light">
                      <tr>
                        <th style="width: 6%">ID</th>
                        <th style="width: 20%">–ö–∞–Ω–∞–ª –∏ –±–æ—Ç</th>
                        <th style="width: 16%">–ù–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –ø–∞–Ω–µ–ª–∏</th>
                        <th style="width: 12%">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</th>
                        <th style="width: 10%" class="text-center">–°—Ç–∞—Ç—É—Å</th>
                        <th style="width: 16%">–®–∞–±–ª–æ–Ω –≤–æ–ø—Ä–æ—Å–æ–≤</th>
                        <th style="width: 14%">–°–∏—Å—Ç–µ–º–∞ –æ—Ü–µ–Ω–æ–∫</th>
                        <th style="width: 16%">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</th>
                        <th style="width: 6%"></th>
                      </tr>
                    </thead>
                    <tbody id="channelsBody">
                      <tr>
                        <td colspan="9" class="text-center text-muted py-4">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–Ω–∞–ª–æ–≤‚Ä¶</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <div
                class="tab-pane fade"
                id="channels-templates"
                role="tabpanel"
                aria-labelledby="channels-templates-tab"
              >
                <div class="pt-1" data-bot-settings-modal>
                  <section class="mb-4">
                    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
                      <div>
                        <h6 class="mb-1">–®–∞–±–ª–æ–Ω—ã –≤–æ–ø—Ä–æ—Å–æ–≤</h6>
                        <p class="small text-muted mb-0">
                          –°–æ–∑–¥–∞–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –±–æ—Ç–∞ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π. –ö–∞–∂–¥—ã–π —à–∞–±–ª–æ–Ω –º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ.
                        </p>
                      </div>
                      <button class="btn btn-sm btn-outline-success" type="button" data-bot-template-create>+ –®–∞–±–ª–æ–Ω</button>
                    </div>
                    <div class="d-flex flex-column gap-3" data-bot-templates-container></div>
                  </section>

                  <hr>

                  <section>
                    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
                      <div>
                        <h6 class="mb-1">–°–∏—Å—Ç–µ–º–∞ –æ—Ü–µ–Ω–æ–∫</h6>
                        <p class="small text-muted mb-0">–°–æ–∑–¥–∞–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –æ—Ü–µ–Ω–æ–∫ –¥–ª—è –±–æ—Ç–æ–≤ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∞–∫—Ç–∏–≤–Ω—ã–π —à–∞–±–ª–æ–Ω.</p>
                      </div>
                      <button class="btn btn-sm btn-outline-success" type="button" data-bot-rating-template-create>+ –®–∞–±–ª–æ–Ω</button>
                    </div>
                    <div class="d-flex flex-column gap-3" data-bot-rating-templates-container></div>
                  </section>

                  <div class="d-flex flex-column flex-lg-row align-items-lg-center gap-3 mt-4">
                    <div class="small text-muted" data-bot-settings-status></div>
                    <div class="ms-lg-auto d-flex gap-2">
                      <button type="button" class="btn btn-primary" data-bot-settings-save>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω—ã</button>
                    </div>
                  </div>
                </div>
              </div>

              <div
                class="tab-pane fade"
                id="channels-automation"
                role="tabpanel"
                aria-labelledby="channels-automation-tab"
              >
                <section class="mb-4">
                  <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
                    <div>
                      <h6 class="mb-1">–®–∞–±–ª–æ–Ω—ã –∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏—è</h6>
                      <p class="small text-muted mb-0">
                        –°–æ–∑–¥–∞–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏—è –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π. –ö–∞–∂–¥—ã–π —à–∞–±–ª–æ–Ω –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ.
                      </p>
                    </div>
                    <button class="btn btn-sm btn-outline-success" type="button" onclick="addAutoCloseTemplate()">+ –®–∞–±–ª–æ–Ω</button>
                  </div>
                  <div class="d-flex flex-column gap-3" data-auto-close-templates></div>
                </section>
                <div class="alert alert-light border small mb-3" role="alert">
                  –ê–∫—Ç–∏–≤–Ω—ã–π —à–∞–±–ª–æ–Ω –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –ü–æ–∑–∂–µ –≤—ã —Å–º–æ–∂–µ—Ç–µ –≤—ã–±–∏—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–æ—Ç–∞.
                </div>
                <div class="d-flex justify-content-end">
                  <button type="button" class="btn btn-primary" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="vkWebhookModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">VK: –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ–±—Ö—É–∫–∞</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">ID —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ (group_id)</label>
            <input type="number" min="0" class="form-control" id="vkGroupIdInput">
            <div class="form-text">–ù–∞–π–¥–∏—Ç–µ —á–∏—Å–ª–æ–≤–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–æ–æ–±—â–µ—Å—Ç–≤–∞.</div>
          </div>
          <div class="mb-3">
            <label class="form-label">–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è Callback API</label>
            <input type="text" class="form-control" id="vkConfirmationInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 123abc">
          </div>
          <div class="mb-3">
            <label class="form-label">–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <input type="text" class="form-control" id="vkSecretInput" placeholder="–ë—É–¥–µ—Ç —Å–≤–µ—Ä—è—Ç—å—Å—è —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º secret">
          </div>
          <div class="alert alert-info small">
            <div class="fw-semibold mb-1">–ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å Callback API</div>
            <ol class="mb-0 ps-3">
              <li>–í —Ä–∞–∑–¥–µ–ª–µ ¬´–†–∞–±–æ—Ç–∞ —Å API¬ª ‚Üí ¬´Callback API¬ª –∑–∞–¥–∞–π—Ç–µ –∞–¥—Ä–µ—Å –≤–∏–¥–∞ <code>https://–≤–∞—à-–¥–æ–º–µ–Ω/webhooks/vk/&lt;group_id&gt;</code>.</li>
              <li>–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∏—Å—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã.</li>
              <li>–í–∫–ª—é—á–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–µ—Ä–≤–∏—Å–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ <code>python vk_webhook_support.py</code>.</li>
            </ol>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          <button type="button" class="btn btn-primary" id="vkWebhookSaveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å -->
  <button class="btn btn-primary mt-4" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='modal-helpers.js') }}"></script>
    <script>
    const showAppModalMessage = window.showAppModalMessage;
    const showConfirmActionModal = window.showConfirmActionModal;
  const RAW_DIALOG_CONFIG = {{ settings.dialog_config | tojson | safe }};
  const DIALOG_CONFIG = RAW_DIALOG_CONFIG && typeof RAW_DIALOG_CONFIG === 'object' ? RAW_DIALOG_CONFIG : {};
  const RAW_AUTO_CLOSE_CONFIG = {{ (settings.auto_close_config or {}) | tojson | safe }};
  const AUTO_CLOSE_CONFIG = RAW_AUTO_CLOSE_CONFIG && typeof RAW_AUTO_CLOSE_CONFIG === 'object' ? RAW_AUTO_CLOSE_CONFIG : {};
  const AUTO_CLOSE_FALLBACK_HOURS = Number({{ settings.auto_close_hours | tojson }}) || 24;
  const FALLBACK_DIALOG_CATEGORIES = {{ settings.categories | tojson | safe }};

  const DEFAULT_DIALOG_TIME_METRICS = Object.freeze({
    good_limit: 30,
    warning_limit: 60,
    colors: Object.freeze({
      good: '#d1f7d1',
      warning: '#fff4d6',
      danger: '#f8d7da',
    }),
  });

  function sanitizeHexColor(value, fallback) {
    const raw = typeof value === 'string' ? value.trim() : '';
    if (/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(raw)) {
      return raw;
    }
    return fallback;
  }

  function normalizeDialogTimeMetrics(raw) {
    const base = {
      good_limit: DEFAULT_DIALOG_TIME_METRICS.good_limit,
      warning_limit: DEFAULT_DIALOG_TIME_METRICS.warning_limit,
      colors: {
        ...DEFAULT_DIALOG_TIME_METRICS.colors,
      },
    };

    if (raw && typeof raw === 'object') {
      const good = Number.parseInt(raw.good_limit, 10);
      const warning = Number.parseInt(raw.warning_limit, 10);
      if (Number.isFinite(good) && good > 0) {
        base.good_limit = good;
      }
      if (Number.isFinite(warning) && warning > 0) {
        base.warning_limit = warning;
      }
      if (raw.colors && typeof raw.colors === 'object') {
        base.colors.good = sanitizeHexColor(raw.colors.good, base.colors.good);
        base.colors.warning = sanitizeHexColor(raw.colors.warning, base.colors.warning);
        base.colors.danger = sanitizeHexColor(raw.colors.danger, base.colors.danger);
      }
    }

    if (!Number.isFinite(base.good_limit) || base.good_limit <= 0) {
      base.good_limit = DEFAULT_DIALOG_TIME_METRICS.good_limit;
    }

    if (!Number.isFinite(base.warning_limit) || base.warning_limit <= base.good_limit) {
      base.warning_limit = Math.max(base.good_limit + 1, DEFAULT_DIALOG_TIME_METRICS.warning_limit);
    }

    return base;
  }

  const BOT_SETTINGS_INITIAL = {{ settings.bot_settings | tojson | safe }};
  const BOT_PRESET_DEFINITIONS = {{ bot_question_presets | tojson | safe }};

  const PARAMETER_TITLES = {{ parameter_types | tojson }};
  const PARAMETER_DEPENDENCIES = {{ parameter_dependencies | default({}) | tojson }} || {};
  const PARAMETER_STATE_TYPES = new Set(['partner_type', 'country', 'legal_entity', 'partner_contact']);
  const PARAMETER_STATES = ['–ê–∫—Ç–∏–≤–µ–Ω', '–ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ', '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'Black_List', '–ó–∞–∫—Ä—ã—Ç'];
  const PARAMETER_FILTER_KEYS = {
    business: 'business',
    partner_type: 'partner_type',
    country: 'country',
    legal_entity: 'legal_entity',
    network: 'network',
    it_connection: 'it_connection_type',
    iiko_server: 'it_iiko_server',
  };
  const IT_CONNECTION_USAGE_FILTER_PARAMS = {
    equipment_type: 'it_connection_type',
    equipment_vendor: 'equipment_vendor',
    equipment_model: 'equipment_model',
    equipment_status: 'equipment_status',
  };
  const PARTNER_CONTACT_TYPES = {
    partner: '–ü–∞—Ä—Ç–Ω—ë—Ä',
    ka: '–ö–ê',
  };
  const PARTNER_CONTACT_PHONE_TYPES = {
    work: '–†–∞–±–æ—á–∏–π',
    personal: '–õ–∏—á–Ω—ã–π',
    fax: '–§–∞–∫—Å',
    support: '–°–∞–ø–ø–æ—Ä—Ç',
  };
  const PARTNER_CONTACT_EMAIL_TYPES = {
    work: '–†–∞–±–æ—á–∏–π',
    personal: '–õ–∏—á–Ω—ã–π',
    common: '–û–±—â–∏–π',
    support: '–°–∞–ø–ø–æ—Ä—Ç',
  };
  const PARTNER_CONTACT_STATE_CLASS_MAP = {
    –ê–∫—Ç–∏–≤–µ–Ω: 'partner-contact-card__header--state-active',
    –ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ: 'partner-contact-card__header--state-pending',
    –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: 'partner-contact-card__header--state-blocked',
    Black_List: 'partner-contact-card__header--state-blacklist',
    –ó–∞–∫—Ä—ã—Ç: 'partner-contact-card__header--state-closed',
  };
  const PARTNER_CONTACT_STATE_CLASSES = Object.values(PARTNER_CONTACT_STATE_CLASS_MAP);
  const CITY_PARAMETER_TYPE = 'city';
  const CITY_PARAMETER_LABEL = '–ì–æ—Ä–æ–¥';

  const legalEntitiesContainer = document.querySelector('[data-legal-entities-list]');
  const legalEntitiesEmptyPlaceholder = document.querySelector('[data-legal-entities-empty]');
  const legalEntitiesModalEl = document.getElementById('legalEntitiesModal');
  let legalEntityDrafts = [];
  let legalEntityDraftCounter = 0;

  const parametersModalEl = document.getElementById('parametersModal');
  const partnerContactSections = new Map();
  document.querySelectorAll('[data-partner-contacts-section]').forEach((section) => {
    if (!section || !(section instanceof HTMLElement)) return;
    const scope = section.dataset.partnerContactsSection;
    if (!scope) return;
    const container = section.querySelector('[data-partner-contacts-list]');
    const emptyPlaceholder = section.querySelector('[data-partner-contacts-empty]');
    partnerContactSections.set(scope, {
      section,
      container,
      emptyPlaceholder,
    });
  });
  let partnerContactDrafts = [];
  let partnerContactDraftCounter = 0;
  const partnerContactEdits = new Map();
  let partnerContactPhoneCounter = 0;
  let partnerContactEmailCounter = 0;
  let partnerContactPersonCounter = 0;
  const partnerContactDetailsState = new Map();
  const partnerContactEditorModalEl = document.getElementById('partnerContactEditorModal');
  const partnerContactEditorBody = partnerContactEditorModalEl
    ? partnerContactEditorModalEl.querySelector('[data-partner-contact-editor-body]')
    : null;
  const partnerContactEditorTitle = partnerContactEditorModalEl
    ? partnerContactEditorModalEl.querySelector('[data-partner-contact-editor-title]')
    : null;
  const partnerContactEditorActions = partnerContactEditorModalEl
    ? partnerContactEditorModalEl.querySelector('[data-partner-contact-editor-actions]')
    : null;
  const partnerContactEditorModal = partnerContactEditorModalEl
    ? new bootstrap.Modal(partnerContactEditorModalEl)
    : null;
  let partnerContactEditorState = null;

  function cssEscape(value) {
    if (window.CSS && typeof window.CSS.escape === 'function') {
      return window.CSS.escape(String(value));
    }
    return String(value).replace(/["\\]/g, '\\$&');
  }

  function findPartnerContactCardByKey(key) {
    if (!key) return null;
    let selector = '';
    if (key.startsWith('draft:')) {
      const draftId = key.slice('draft:'.length);
      selector = `[data-partner-contact-card][data-partner-contact-draft="true"][data-partner-contact-draft-id="${cssEscape(
        draftId
      )}"]`;
    } else if (key.startsWith('item:')) {
      const id = key.slice('item:'.length);
      selector = `[data-partner-contact-card][data-partner-contact-draft="false"][data-partner-contact-id="${cssEscape(id)}"]`;
    }
    if (!selector) return null;
    return document.querySelector(selector);
  }

  function setPartnerContactCardVisibility(key, visible) {
    const card = findPartnerContactCardByKey(key);
    if (!card) return;
    const col = card.closest('.col');
    const target = col || card;
    if (visible) {
      target.classList.remove('d-none');
      target.removeAttribute('data-partner-contact-hidden');
    } else {
      target.classList.add('d-none');
      target.setAttribute('data-partner-contact-hidden', 'true');
    }
  }

  function clearPartnerContactEditorActions() {
    if (!partnerContactEditorActions) return;
    partnerContactEditorActions.innerHTML = '';
    partnerContactEditorActions.classList.add('d-none');
  }

  function syncPartnerContactEditorActions(card) {
    if (!partnerContactEditorActions) return;
    partnerContactEditorActions.innerHTML = '';
    if (!card) {
      partnerContactEditorActions.classList.add('d-none');
      return;
    }
    const actionsContainer = card.querySelector('[data-partner-contact-actions]');
    if (!actionsContainer) {
      partnerContactEditorActions.classList.add('d-none');
      return;
    }
    const key = card.dataset.partnerContactKey || actionsContainer.dataset.partnerContactActionsOwner || '';
    const buttons = Array.from(actionsContainer.children || []);
    if (!buttons.length) {
      partnerContactEditorActions.classList.add('d-none');
      return;
    }
    const fragment = document.createDocumentFragment();
    buttons.forEach((button) => {
      const clone = button.cloneNode(true);
      if (key) {
        clone.dataset.partnerContactActionTarget = key;
      }
      fragment.appendChild(clone);
    });
    partnerContactEditorActions.appendChild(fragment);
    partnerContactEditorActions.classList.remove('d-none');
    actionsContainer.classList.add('d-none');
  }

  function updatePartnerContactEditorTitleByKey(key) {
    if (!partnerContactEditorTitle) return;
    if (!key) {
      partnerContactEditorTitle.textContent = '–ö–∞—Ä—Ç–æ—á–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞';
      return;
    }
    const items = getPartnerContactRenderItems();
    const item = items.find((entry) => getPartnerContactItemKey(entry) === key);
    const displayName = getPartnerContactDisplayName(item);
    partnerContactEditorTitle.textContent = displayName
      ? `–ö–∞—Ä—Ç–æ—á–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞ ‚Ä¢ ${displayName}`
      : '–ö–∞—Ä—Ç–æ—á–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞';
  }

  function renderPartnerContactModalContentByKey(key) {
    if (!partnerContactEditorBody || !key) return false;
    const items = getPartnerContactRenderItems();
    const item = items.find((entry) => getPartnerContactItemKey(entry) === key);
    if (!item) {
      partnerContactEditorBody.innerHTML =
        '<div class="alert alert-warning mb-0">–ö–æ–Ω—Ç–∞–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –±—ã–ª —É–¥–∞–ª—ë–Ω.</div>';
      clearPartnerContactEditorActions();
      return false;
    }
    const html = renderPartnerContactCard(item, { mode: 'editor' });
    const temp = document.createElement('div');
    temp.innerHTML = html.trim();
    const col = temp.firstElementChild;
    let card = col ? col.querySelector('[data-partner-contact-card]') : temp.querySelector('[data-partner-contact-card]');
    if (!card) {
      partnerContactEditorBody.innerHTML =
        '<div class="alert alert-warning mb-0">–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –∫–æ–Ω—Ç–∞–∫—Ç–∞.</div>';
      clearPartnerContactEditorActions();
      return false;
    }
    card = card.cloneNode(true);
    card.classList.add('partner-contact-card--modal');
    card.classList.remove('h-100');
    const keyValue = getPartnerContactItemKey(item);
    if (keyValue) {
      partnerContactDetailsState.set(keyValue, 'expanded');
    }
    card.querySelectorAll('[data-partner-contact-details]').forEach((section) => {
      section.classList.remove('is-collapsed');
      section.classList.add('is-expanded');
      const toggle = section.querySelector('[data-partner-contact-details-toggle]');
      if (toggle) {
        toggle.setAttribute('aria-expanded', 'true');
      }
    });
    const modalOpenBtn = card.querySelector('[data-partner-contact-open-modal]');
    if (modalOpenBtn) {
      modalOpenBtn.setAttribute('disabled', 'true');
      modalOpenBtn.classList.add('disabled');
    }
    partnerContactEditorBody.innerHTML = '';
    partnerContactEditorBody.appendChild(card);
    syncPartnerContactEditorActions(card);
    card
      .querySelectorAll('[data-partner-contact-comm-field="value"][data-comm-type="phone"]')
      .forEach((input) => updatePhoneInputFormatting(input));
    card
      .querySelectorAll('[data-partner-contact-comm-field="value"][data-comm-type="email"]')
      .forEach((input) => validateEmailInput(input));
    card
      .querySelectorAll('[data-partner-contact-person-field="phone"]')
      .forEach((input) => updatePhoneInputFormatting(input));
    card
      .querySelectorAll('[data-partner-contact-person-field="email"]')
      .forEach((input) => validateEmailInput(input));
    return true;
  }

  function openPartnerContactEditor(card) {
    if (!partnerContactEditorModal || !card) return;
    const key = getPartnerContactCardKey(card);
    if (!key) return;
    partnerContactEditorState = { key };
    setPartnerContactCardVisibility(key, false);
    const rendered = renderPartnerContactModalContentByKey(key);
    if (!rendered) {
      partnerContactEditorState = null;
      setPartnerContactCardVisibility(key, true);
      return;
    }
    updatePartnerContactEditorTitleByKey(key);
    partnerContactEditorModal.show();
  }

  function refreshPartnerContactPersonRow(row) {
    if (!row) return;
    const titleEl = row.querySelector('[data-partner-contact-person-title]');
    const subtitleEl = row.querySelector('[data-partner-contact-person-subtitle]');
    const fullNameInput = row.querySelector('[data-partner-contact-person-field="full_name"]');
    const positionInput = row.querySelector('[data-partner-contact-person-field="position"]');
    if (titleEl && fullNameInput) {
      const fullName = fullNameInput.value.trim();
      titleEl.textContent = fullName || '–ë–µ–∑ –∏–º–µ–Ω–∏';
    }
    if (subtitleEl && positionInput) {
      const position = positionInput.value.trim();
      subtitleEl.textContent = position;
      subtitleEl.classList.toggle('d-none', !position);
    }
    const topBadge = row.querySelector('[data-partner-contact-person-top-badge]');
    if (topBadge) {
      const toggle = row.querySelector('[data-partner-contact-person-field="is_top"]');
      const isChecked = toggle ? toggle.checked : false;
      topBadge.classList.toggle('d-none', !isChecked);
    }
  }

  function getPartnerContactItemKey(item) {
    if (!item || typeof item !== 'object') {
      return null;
    }
    if (item.isDraft) {
      if (item.draftId) {
        return `draft:${item.draftId}`;
      }
      return null;
    }
    if (Number.isFinite(item.id)) {
      return `item:${item.id}`;
    }
    if (item.id) {
      return `item:${item.id}`;
    }
    return null;
  }

  function getPartnerContactCardKey(card) {
    if (!card || !card.dataset.partnerContactCard) return null;
    if (card.dataset.partnerContactDraft === 'true') {
      const draftId = card.dataset.partnerContactDraftId;
      return draftId ? `draft:${draftId}` : null;
    }
    const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
    if (Number.isFinite(id)) {
      return `item:${id}`;
    }
    return null;
  }

  function getPartnerContactDisplayName(item) {
    if (!item || typeof item !== 'object') return '';
    const internalName = typeof item.internal_name === 'string' ? item.internal_name.trim() : '';
    if (internalName) {
      return internalName;
    }
    const value = typeof item.value === 'string' ? item.value.trim() : '';
    return value;
  }

  function refreshPartnerContactCardTitle(card) {
    if (!card) return;
    const title = card.querySelector('[data-partner-contact-title]');
    if (!title) return;
    const data = getPartnerContactCardData(card);
    const displayName = getPartnerContactDisplayName(data);
    title.textContent = displayName || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
    const key = getPartnerContactCardKey(card);
    if (partnerContactEditorState && partnerContactEditorState.key === key) {
      updatePartnerContactEditorTitleByKey(key);
    }
  }

  function updatePartnerContactCardHeaderState(card, stateValue) {
    if (!card) return;
    const header = card.querySelector('[data-partner-contact-card-header]');
    if (!header) return;
    if (PARTNER_CONTACT_STATE_CLASSES.length) {
      header.classList.remove(...PARTNER_CONTACT_STATE_CLASSES);
    }
    const className = PARTNER_CONTACT_STATE_CLASS_MAP[stateValue] || '';
    if (className) {
      header.classList.add(className);
    }
  }

  function updatePartnerContactServedSummary(card, data) {
    if (!card) return;
    const summary = card.querySelector('[data-partner-contact-served-summary]');
    if (!summary) return;
    const source = data || getPartnerContactCardData(card);
    if (!source) {
      summary.textContent = '';
      return;
    }
    const served = Array.isArray(source.served_legal_entities) ? source.served_legal_entities : [];
    if (!served.length) {
      summary.textContent = '';
      return;
    }
    const labels = served
      .map((entry) => {
        if (!entry || typeof entry !== 'object') return '';
        const id = Number.isFinite(entry.id) ? entry.id : Number.parseInt(entry.id, 10);
        const name = typeof entry.name === 'string' ? entry.name.trim() : '';
        if (name) return name;
        if (Number.isFinite(id)) return `ID ${id}`;
        return '';
      })
      .filter((label) => label);
    summary.textContent = labels.length ? `–í—ã–±—Ä–∞–Ω–æ: ${labels.join(', ')}` : '';
  }

  const IT_CONNECTION_FALLBACK_LABELS = {{ it_connection_categories | tojson }} || {};
  const IT_CONNECTION_CATEGORY_FIELDS = {{ it_connection_category_fields | tojson }} || {};
  let IT_CONNECTION_CATEGORY_LABELS = {};
  let IT_CONNECTION_CATEGORY_KEYS = [];
  let IT_CONNECTION_DEFAULT_CATEGORY = 'equipment_type';
  let itConnectionCategorySelect = null;

  function determineItConnectionDefaultCategory(keys) {
    if (Array.isArray(keys) && keys.includes('equipment_type')) {
      return 'equipment_type';
    }
    if (Array.isArray(keys) && keys.length) {
      return keys[0];
    }
    return 'equipment_type';
  }

  function generatePartnerContactCommKey(prefix) {
    if (prefix === 'phone') {
      partnerContactPhoneCounter += 1;
      return `${prefix}-${partnerContactPhoneCounter}`;
    }
    partnerContactEmailCounter += 1;
    return `${prefix}-${partnerContactEmailCounter}`;
  }

  function updatePartnerContactPersonCounterFromKey(key) {
    if (typeof key !== 'string') return;
    const match = key.match(/^person-(\d+)$/);
    if (!match) return;
    const value = Number.parseInt(match[1], 10);
    if (Number.isFinite(value) && value > partnerContactPersonCounter) {
      partnerContactPersonCounter = value;
    }
  }

  function generatePartnerContactPersonKey() {
    partnerContactPersonCounter += 1;
    return `person-${partnerContactPersonCounter}`;
  }

  function extractDigits(value) {
    if (typeof value === 'string' || typeof value === 'number') {
      return String(value).replace(/\D+/g, '');
    }
    return '';
  }

  const PHONE_COUNTRY_FORMATS = [
    { code: '375', prefix: '+375', mask: ' (##) ###-##-##' },
    { code: '380', prefix: '+380', mask: ' (##) ###-##-##' },
    { code: '7', prefix: '+7', mask: ' (###) ###-##-##' },
    { code: '1', prefix: '+1', mask: ' (###) ###-####' },
  ];
  const EMAIL_VALIDATION_REGEX = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

  function applyPhoneMask(mask, digits) {
    if (!digits) {
      return '';
    }
    let result = '';
    let index = 0;
    for (const char of mask) {
      if (char === '#') {
        if (index < digits.length) {
          result += digits[index];
          index += 1;
        } else {
          break;
        }
      } else if (index > 0 || digits.length > 0) {
        result += char;
      }
    }
    if (index < digits.length) {
      const remainder = digits.slice(index);
      if (remainder) {
        result += (result && !result.endsWith(' ') ? ' ' : '') + remainder;
      }
    }
    return result;
  }

  function formatPhoneValue(value) {
    const digits = extractDigits(value);
    if (!digits) {
      return '';
    }
    for (const format of PHONE_COUNTRY_FORMATS) {
      if (digits.startsWith(format.code)) {
        const rest = digits.slice(format.code.length);
        const maskedRest = rest ? applyPhoneMask(format.mask, rest) : '';
        return (format.prefix + maskedRest).trim();
      }
    }
    const prefix = `+${digits[0]}`;
    const rest = digits.slice(1);
    const maskedRest = rest ? applyPhoneMask(' (###) ###-##-##', rest) : '';
    return (prefix + maskedRest).trim();
  }

  function updatePhoneInputFormatting(input) {
    if (!input) return;
    const digits = extractDigits(input.value || input.dataset.phoneDigits || '');
    input.dataset.phoneDigits = digits;
    input.value = formatPhoneValue(digits);
  }

  function enforceExtensionDigits(input) {
    if (!input) return;
    const digits = extractDigits(input.value);
    input.value = digits;
  }

  function validateEmailInput(input) {
    if (!input) return;
    const value = typeof input.value === 'string' ? input.value.trim() : '';
    const isValid = !value || EMAIL_VALIDATION_REGEX.test(value);
    input.classList.toggle('is-invalid', !isValid);
    if (typeof input.setCustomValidity === 'function') {
      input.setCustomValidity(
        isValid ? '' : '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π e-mail: –Ω–µ–æ–±—Ö–æ–¥–∏–º —Å–∏–º–≤–æ–ª @ –∏ –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è.'
      );
    }
  }

  function createBlankPartnerContactPersonEntry() {
    return {
      key: generatePartnerContactPersonKey(),
      full_name: '',
      position: '',
      phone: '',
      email: '',
      is_top: false,
    };
  }

  function normalizePartnerContactCommList(rawList, kind) {
    const allowed = kind === 'phone' ? PARTNER_CONTACT_PHONE_TYPES : PARTNER_CONTACT_EMAIL_TYPES;
    const allowedKeys = Object.keys(allowed);
    const defaultType = allowedKeys.includes('work') ? 'work' : allowedKeys[0] || '';
    if (!Array.isArray(rawList)) {
      return [];
    }
    return rawList
      .map((item) => {
        let value = '';
        let type = defaultType;
        let key = '';
        let extension = '';
        if (item && typeof item === 'object') {
          const rawType = typeof item.type === 'string' ? item.type.trim() : '';
          if (rawType && Object.prototype.hasOwnProperty.call(allowed, rawType)) {
            type = rawType;
          }
          if (typeof item.value === 'string' || typeof item.value === 'number') {
            value = String(item.value).trim();
          }
          if (kind === 'phone' && (typeof item.extension === 'string' || typeof item.extension === 'number')) {
            extension = String(item.extension).trim();
          }
          if (typeof item.key === 'string' && item.key.trim()) {
            key = item.key.trim();
          }
        } else if (typeof item === 'string' || typeof item === 'number') {
          value = String(item).trim();
        }
        if (!value) {
          return null;
        }
        if (!Object.prototype.hasOwnProperty.call(allowed, type)) {
          type = defaultType;
        }
        if (!key) {
          key = generatePartnerContactCommKey(kind);
        }
        if (kind === 'phone') {
          value = value.replace(/\D+/g, '');
          extension = extension.replace(/\D+/g, '');
          return { key, type, value, extension };
        }
        return { key, type, value };
      })
      .filter((entry) => entry);
  }

  function normalizeBooleanValue(value) {
    if (typeof value === 'string') {
      const normalized = value.trim().toLowerCase();
      if (!normalized) return false;
      return (
        normalized === '1' ||
        normalized === 'true' ||
        normalized === 'yes' ||
        normalized === 'y' ||
        normalized === 'on'
      );
    }
    return Boolean(value);
  }

  function normalizePartnerContactPeople(rawExtra) {
    const extra = rawExtra && typeof rawExtra === 'object' ? rawExtra : {};
    const list = Array.isArray(extra.contacts) ? extra.contacts : [];
    const seen = new Set();
    return list
      .map((entry) => {
        if (!entry || typeof entry !== 'object') {
          return null;
        }
        const fullName = typeof entry.full_name === 'string' ? entry.full_name.trim() : '';
        const position = typeof entry.position === 'string' ? entry.position.trim() : '';
        const phone = typeof entry.phone === 'string' ? entry.phone.trim() : '';
        const email = typeof entry.email === 'string' ? entry.email.trim() : '';
        let key = typeof entry.key === 'string' ? entry.key.trim() : '';
        if (key) {
          if (seen.has(key)) {
            key = '';
          } else {
            updatePartnerContactPersonCounterFromKey(key);
          }
        }
        if (!key) {
          key = generatePartnerContactPersonKey();
        }
        seen.add(key);
        return {
          key,
          full_name: fullName,
          position,
          phone,
          email,
          is_top: normalizeBooleanValue(entry.is_top),
        };
      })
      .filter((entry) => entry);
  }

  function clonePartnerContactPeople(list) {
    if (!Array.isArray(list)) {
      return [];
    }
    return list
      .map((item) => {
        if (!item || typeof item !== 'object') {
          return null;
        }
        let key = typeof item.key === 'string' ? item.key : '';
        if (key) {
          updatePartnerContactPersonCounterFromKey(key);
        } else {
          key = generatePartnerContactPersonKey();
        }
        return {
          key,
          full_name: typeof item.full_name === 'string' ? item.full_name : '',
          position: typeof item.position === 'string' ? item.position : '',
          phone: typeof item.phone === 'string' ? item.phone : '',
          email: typeof item.email === 'string' ? item.email : '',
          is_top: normalizeBooleanValue(item.is_top),
        };
      })
      .filter((entry) => entry);
  }

  function normalizePartnerContactServedEntities(rawExtra) {
    const extra = rawExtra && typeof rawExtra === 'object' ? rawExtra : {};
    const result = [];
    const seen = new Set();

    const addEntry = (rawId, rawName) => {
      const parsed = Number.parseInt(rawId, 10);
      if (!Number.isFinite(parsed) || parsed <= 0 || seen.has(parsed)) {
        return;
      }
      seen.add(parsed);
      const name = typeof rawName === 'string' ? rawName.trim() : '';
      result.push({ id: parsed, name });
    };

    if (Array.isArray(extra.served_legal_entities)) {
      extra.served_legal_entities.forEach((entry) => {
        if (!entry || typeof entry !== 'object') return;
        addEntry(entry.id, entry.name || entry.label || entry.title || entry.served_legal_entity_name);
      });
    }

    if (Array.isArray(extra.served_legal_entity_ids)) {
      const names = Array.isArray(extra.served_legal_entity_names) ? extra.served_legal_entity_names : [];
      extra.served_legal_entity_ids.forEach((id, index) => {
        const name = names[index];
        addEntry(id, name);
      });
    }

    if (Object.prototype.hasOwnProperty.call(extra, 'served_legal_entity_id')) {
      addEntry(extra.served_legal_entity_id, extra.served_legal_entity_name);
    }

    return result;
  }

  function normalizePartnerContactExtra(rawExtra, { value } = {}) {
    const extra = rawExtra && typeof rawExtra === 'object' ? rawExtra : {};
    const rawType = typeof extra.contact_type === 'string' ? extra.contact_type.trim() : '';
    const contactType = Object.prototype.hasOwnProperty.call(PARTNER_CONTACT_TYPES, rawType)
      ? rawType
      : 'partner';
    const phones = normalizePartnerContactCommList(Array.isArray(extra.phones) ? extra.phones : [], 'phone');
    const emails = normalizePartnerContactCommList(Array.isArray(extra.emails) ? extra.emails : [], 'email');
    const contacts = normalizePartnerContactPeople(extra);
    const innDigits = extractDigits(extra.inn);
    const innValue = innDigits || (typeof extra.inn === 'string' ? extra.inn.trim() : '');
    const legalEntityValue = typeof extra.legal_entity === 'string' && extra.legal_entity.trim()
      ? extra.legal_entity.trim()
      : typeof value === 'string'
        ? value.trim()
        : '';
    const servedEntities = normalizePartnerContactServedEntities(extra);
    const firstServed = servedEntities.length ? servedEntities[0] : null;
    const internalName = typeof extra.internal_name === 'string' ? extra.internal_name.trim() : '';
    return {
      contact_type: contactType,
      phones,
      emails,
      served_legal_entities: servedEntities,
      served_legal_entity_id: firstServed ? firstServed.id : null,
      served_legal_entity_name: firstServed ? firstServed.name : '',
      served_legal_entity_ids: servedEntities.map((entry) => entry.id),
      served_legal_entity_names: servedEntities.map((entry) => entry.name).filter((name) => name),
      legal_entity: legalEntityValue,
      internal_name: internalName,
      inn: innValue,
      contacts,
    };
  }

  function createBlankPartnerContactCommEntry(kind) {
    const allowed = kind === 'phone' ? PARTNER_CONTACT_PHONE_TYPES : PARTNER_CONTACT_EMAIL_TYPES;
    const allowedKeys = Object.keys(allowed);
    const defaultType = allowedKeys.includes('work') ? 'work' : allowedKeys[0] || '';
    const entry = { key: generatePartnerContactCommKey(kind), type: defaultType, value: '' };
    if (kind === 'phone') {
      entry.extension = '';
    }
    return entry;
  }

  function clonePartnerContactCommList(list) {
    if (!Array.isArray(list)) {
      return [];
    }
    return list.map((item) => ({
      key: item.key,
      type: item.type,
      value: item.value,
      extension: typeof item.extension === 'string' ? item.extension : '',
    }));
  }

  function clonePartnerContactServedEntities(list) {
    if (!Array.isArray(list)) {
      return [];
    }
    return list
      .map((item) => {
        if (!item || typeof item !== 'object') return null;
        const id = Number.isFinite(item.id) ? item.id : Number.parseInt(item.id, 10);
        if (!Number.isFinite(id) || id <= 0) return null;
        return {
          id,
          name: typeof item.name === 'string' ? item.name : '',
        };
      })
      .filter((entry) => entry);
  }

  function clonePartnerContactItem(item) {
    if (!item || typeof item !== 'object') {
      return null;
    }
    const servedEntities = clonePartnerContactServedEntities(item.served_legal_entities);
    let servedId = Number.isFinite(item.served_legal_entity_id)
      ? item.served_legal_entity_id
      : Number.parseInt(item.served_legal_entity_id, 10);
    servedId = Number.isFinite(servedId) && servedId > 0 ? servedId : null;
    let servedName = typeof item.served_legal_entity_name === 'string' ? item.served_legal_entity_name : '';
    if (!servedEntities.length && Number.isFinite(servedId)) {
      servedEntities.push({ id: servedId, name: servedName });
    }
    if (servedEntities.length) {
      const first = servedEntities[0];
      if (first) {
        if (!Number.isFinite(servedId)) {
          servedId = first.id;
        }
        if (!servedName) {
          servedName = first.name;
        }
      }
    }
    return {
      id: item.id,
      draftId: item.draftId,
      isDraft: Boolean(item.isDraft),
      value: typeof item.value === 'string' ? item.value : '',
      state: typeof item.state === 'string' ? item.state : PARAMETER_STATES[0],
      contact_type: Object.prototype.hasOwnProperty.call(PARTNER_CONTACT_TYPES, item.contact_type)
        ? item.contact_type
        : 'partner',
      phones: clonePartnerContactCommList(item.phones),
      emails: clonePartnerContactCommList(item.emails),
      contacts: clonePartnerContactPeople(item.contacts),
      served_legal_entities: servedEntities,
      served_legal_entity_id: Number.isFinite(servedId) ? servedId : null,
      served_legal_entity_name: typeof servedName === 'string' ? servedName : '',
      legal_entity: typeof item.legal_entity === 'string' ? item.legal_entity : '',
      internal_name: typeof item.internal_name === 'string' ? item.internal_name : '',
      inn: typeof item.inn === 'string' ? item.inn : '',
      is_deleted: Boolean(item.is_deleted),
      usage_count: Number.isFinite(item.usage_count) ? item.usage_count : 0,
    };
  }

  function sanitizeItConnectionCategoryMap(source) {
    const target = {};
    if (!source || typeof source !== 'object') {
      return target;
    }
    Object.keys(source).forEach((key) => {
      const rawKey = typeof key === 'string' ? key : String(key || '');
      const label = source[key];
      if (typeof rawKey !== 'string' || typeof label !== 'string') {
        return;
      }
      const trimmedKey = rawKey.trim();
      const trimmedLabel = label.trim();
      if (!trimmedKey || !trimmedLabel) {
        return;
      }
      target[trimmedKey] = trimmedLabel;
    });
    return target;
  }

  function rebuildItConnectionCategorySelect(select, selectedKey) {
    if (!select) return;
    const desiredValue = typeof selectedKey === 'string' ? selectedKey : select.value;
    const fragment = document.createDocumentFragment();
    IT_CONNECTION_CATEGORY_KEYS.forEach((key) => {
      const option = document.createElement('option');
      option.value = key;
      option.textContent = IT_CONNECTION_CATEGORY_LABELS[key] || key;
      if (key === desiredValue) {
        option.selected = true;
      }
      fragment.appendChild(option);
    });
    select.innerHTML = '';
    if (fragment.childNodes.length) {
      select.appendChild(fragment);
    } else {
      const fallbackOption = document.createElement('option');
      fallbackOption.value = IT_CONNECTION_DEFAULT_CATEGORY;
      fallbackOption.textContent =
        IT_CONNECTION_CATEGORY_LABELS[IT_CONNECTION_DEFAULT_CATEGORY] || IT_CONNECTION_DEFAULT_CATEGORY;
      select.appendChild(fallbackOption);
    }
    if (
      desiredValue &&
      select.value !== desiredValue &&
      IT_CONNECTION_CATEGORY_KEYS.includes(desiredValue)
    ) {
      select.value = desiredValue;
    }
  }

  function setItConnectionCategories(newLabels, options = {}) {
    const base = sanitizeItConnectionCategoryMap(IT_CONNECTION_FALLBACK_LABELS);
    const overrides = sanitizeItConnectionCategoryMap(newLabels);
    Object.keys(overrides).forEach((key) => {
      base[key] = overrides[key];
    });
    if (!Object.keys(base).length) {
      base.equipment_type = '–¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è';
      base.equipment_vendor = '–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è';
      base.equipment_model = '–ú–æ–¥–µ–ª—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è';
      base.equipment_status = '–°—Ç–∞—Ç—É—Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è';
    }
    IT_CONNECTION_CATEGORY_LABELS = base;
    IT_CONNECTION_CATEGORY_KEYS = Object.keys(IT_CONNECTION_CATEGORY_LABELS);
    IT_CONNECTION_DEFAULT_CATEGORY = determineItConnectionDefaultCategory(IT_CONNECTION_CATEGORY_KEYS);
    if (itConnectionCategorySelect) {
      const selectedKey = typeof options.selectedKey === 'string' ? options.selectedKey : undefined;
      rebuildItConnectionCategorySelect(itConnectionCategorySelect, selectedKey);
    }
  }

  setItConnectionCategories(IT_CONNECTION_FALLBACK_LABELS);

  let parameterData = {};
  function getDependencyChain(type) {
    const chain = PARAMETER_DEPENDENCIES[type];
    return Array.isArray(chain) ? chain : [];
  }

  function normalizeDependencyValue(value) {
    return typeof value === 'string' ? value.trim() : '';
  }

  function getDependencyLabel(key) {
    return PARAMETER_TITLES[key] || key;
  }

  function getParameterItemsSafe(type) {
    const items = parameterData[type];
    return Array.isArray(items) ? items : [];
  }

  function buildDependencySelect(type, dependencyKey, selectedValue, disabled, context) {
    const normalized = normalizeDependencyValue(selectedValue);
    const disabledAttr = disabled ? ' disabled' : '';
    const valueAttr = escapeHtml(normalized);
    return `
      <select
        class="form-select form-select-sm"
        data-param-dependency-field="${dependencyKey}"
        data-param-type="${type}"
        data-param-dependency-context="${context}"
        data-param-dependency-value="${valueAttr}"${disabledAttr}>
      </select>
    `;
  }

  function buildDependencyOptions(type, selections) {
    const baseSelections = selections && typeof selections === 'object' ? selections : {};
    const items = getParameterItemsSafe(type);
    const unique = new Map();
    items.forEach((item) => {
      if (!item || item.is_deleted) return;
      const value = normalizeDependencyValue(item.value);
      if (!value) return;
      const deps = item && typeof item.dependencies === 'object' ? item.dependencies : {};
      const matches = Object.entries(baseSelections).every(([key, selectionValue]) => {
        const normalizedSelection = normalizeDependencyValue(selectionValue);
        if (!normalizedSelection) return true;
        if (key === type) return true;
        const candidate = normalizeDependencyValue(deps && deps[key]);
        if (!candidate) return false;
        return candidate === normalizedSelection;
      });
      if (!matches) return;
      if (!unique.has(value)) {
        const label = normalizeDependencyValue(item.label || item.value);
        unique.set(value, label || value);
      }
    });
    return Array.from(unique.entries()).map(([value, label]) => ({ value, label }));
  }

  function fillDependencySelectOptions(select, options, { placeholder, selected } = {}) {
    if (!(select instanceof HTMLSelectElement)) return;
    const doc = select.ownerDocument || document;
    const desired = normalizeDependencyValue(selected);
    const wasDisabled = select.disabled;
    select.innerHTML = '';
    const placeholderOption = doc.createElement('option');
    placeholderOption.value = '';
    placeholderOption.textContent = placeholder || '‚Äî';
    select.appendChild(placeholderOption);
    let hasSelected = false;
    options.forEach((option) => {
      const optionEl = doc.createElement('option');
      optionEl.value = option.value;
      optionEl.textContent = option.label || option.value;
      if (desired && option.value === desired) {
        optionEl.selected = true;
        hasSelected = true;
      }
      select.appendChild(optionEl);
    });
    if (hasSelected) {
      select.value = desired;
    } else {
      select.value = '';
    }
    if (wasDisabled) {
      select.disabled = true;
    }
  }

  function refreshDependencySelectGroup(group, type) {
    if (!(group instanceof HTMLElement)) return;
    const chain = getDependencyChain(type);
    if (!chain.length) return;
    if (!group.dataset.paramType) {
      group.dataset.paramType = type;
    }
    const selections = {};
    chain.forEach((dep) => {
      const select = group.querySelector(`[data-param-dependency-field="${dep}"]`);
      if (!(select instanceof HTMLSelectElement)) {
        selections[dep] = '';
        return;
      }
      const desired = normalizeDependencyValue(select.dataset.paramDependencyValue || select.value);
      const placeholder = `‚Äî ${getDependencyLabel(dep)} ‚Äî`;
      const options = buildDependencyOptions(dep, selections);
      fillDependencySelectOptions(select, options, { placeholder, selected: desired });
      const finalValue = normalizeDependencyValue(select.value);
      select.dataset.paramDependencyValue = finalValue;
      selections[dep] = finalValue;
    });
  }

  function refreshParameterDependencyControls(root, fallbackType = null) {
    const scope = root || document;
    scope.querySelectorAll('[data-param-dependency-group]').forEach((group) => {
      const groupType = group.dataset.paramType || fallbackType;
      if (!groupType) return;
      if (!getDependencyChain(groupType).length) return;
      refreshDependencySelectGroup(group, groupType);
    });
  }

  function collectDependencyValues(container, type) {
    const chain = getDependencyChain(type);
    const result = { values: {} };
    if (!chain.length) {
      return result;
    }
    if (!(container instanceof HTMLElement)) {
      return result;
    }
    for (const dep of chain) {
      const select = container.querySelector(`[data-param-dependency-field="${dep}"]`);
      if (!(select instanceof HTMLSelectElement)) {
        continue;
      }
      const value = normalizeDependencyValue(select.value);
      if (!value) {
        const label = getDependencyLabel(dep);
        return { error: `–ü–æ–ª–µ ¬´${label}¬ª –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ`, field: select };
      }
      result.values[dep] = value;
    }
    return result;
  }

  const parameterStatusCache = new Map();
  let parametersLoaded = false;
  Object.keys(PARAMETER_TITLES).forEach((type) => {
    parameterData[type] = [];
  });
  const parameterModalEl = document.getElementById('parameterItemsModal');
  const parameterModal = parameterModalEl ? new bootstrap.Modal(parameterModalEl) : null;
  let parameterModalType = null;
  const cityCardEl = document.querySelector('[data-city-card]');

  function syncParameterData(source) {
    const data = source && typeof source === 'object' ? source : {};
    const result = {};
    const itConnectionCategoryUpdates = {}
    Object.keys(PARAMETER_TITLES).forEach((type) => {
      const items = Array.isArray(data[type]) ? data[type] : [];
      result[type] = items.map((item) => {
        const rawId = item && Object.prototype.hasOwnProperty.call(item, 'id') ? item.id : null;
        const idNumber = Number(rawId);
        const normalizedId = Number.isFinite(idNumber) ? idNumber : Number.parseInt(rawId, 10);
        const rawValue = item && Object.prototype.hasOwnProperty.call(item, 'value') ? item.value : '';
        const value = rawValue === null || rawValue === undefined ? '' : String(rawValue);
        const state = item && typeof item.state === 'string' && item.state ? item.state : PARAMETER_STATES[0];
        const usageRaw = Number(item && item.usage_count);
        const usageCount = Number.isFinite(usageRaw) ? usageRaw : 0;
        const extraRaw = item && typeof item.extra === 'object' && item.extra !== null ? item.extra : {};
        const extra = extraRaw && typeof extraRaw === 'object' ? Object.assign({}, extraRaw) : {};
        const entry = {
          id: Number.isFinite(normalizedId) ? normalizedId : null,
          value,
          state: PARAMETER_STATES.includes(state) ? state : PARAMETER_STATES[0],
          is_deleted: Boolean(item && item.is_deleted),
          deleted_at: item && item.deleted_at ? item.deleted_at : null,
          usage_count: usageCount,
        };
        if (type === 'it_connection') {
          const extraData = extra && typeof extra === 'object' ? extra : {};
          const rawCategory =
            (item && typeof item.category === 'string' && item.category) ||
            (typeof extraData.category === 'string' ? extraData.category : '');
          const category = normalizeItConnectionCategory(rawCategory);
          const trimmedValue = value.trim();
          const rawCategoryLabel =
            (item && typeof item.category_label === 'string' && item.category_label) ||
            (typeof extraData.category_label === 'string' ? extraData.category_label : '');
          const categoryLabel = typeof rawCategoryLabel === 'string' ? rawCategoryLabel.trim() : '';
          const equipmentTypeSource =
            (item && typeof item.equipment_type === 'string' && item.equipment_type) ||
            (typeof extraData.equipment_type === 'string' ? extraData.equipment_type : '');
          const equipmentVendorSource =
            (item && typeof item.equipment_vendor === 'string' && item.equipment_vendor) ||
            (typeof extraData.equipment_vendor === 'string' ? extraData.equipment_vendor : '');
          const equipmentModelSource =
            (item && typeof item.equipment_model === 'string' && item.equipment_model) ||
            (typeof extraData.equipment_model === 'string' ? extraData.equipment_model : '');
          const equipmentStatusSource =
            (item && typeof item.equipment_status === 'string' && item.equipment_status) ||
            (typeof extraData.equipment_status === 'string' ? extraData.equipment_status : '');
          const equipmentType = typeof equipmentTypeSource === 'string' ? equipmentTypeSource.trim() : '';
          const equipmentVendor = typeof equipmentVendorSource === 'string' ? equipmentVendorSource.trim() : '';
          const equipmentModel = typeof equipmentModelSource === 'string' ? equipmentModelSource.trim() : '';
          const equipmentStatus = typeof equipmentStatusSource === 'string' ? equipmentStatusSource.trim() : '';
          let categoryValue = trimmedValue;
          if (category === 'equipment_type' && equipmentType) {
            categoryValue = equipmentType;
          } else if (category === 'equipment_vendor' && equipmentVendor) {
            categoryValue = equipmentVendor;
          } else if (category === 'equipment_model' && equipmentModel) {
            categoryValue = equipmentModel;
          } else if (category === 'equipment_status' && equipmentStatus) {
            categoryValue = equipmentStatus;
          }
          if (category && categoryLabel) {
            itConnectionCategoryUpdates[category] = categoryLabel;
          }
          const effectiveLabel = categoryLabel || IT_CONNECTION_CATEGORY_LABELS[category] || category;
          entry.value = categoryValue;
          entry.category = category;
          entry.category_label = effectiveLabel;
          entry.equipment_type = equipmentType;
          entry.equipment_vendor = equipmentVendor;
          entry.equipment_model = equipmentModel;
          entry.equipment_status = equipmentStatus;
          entry.extra = {
            category,
            category_label: effectiveLabel,
            equipment_type: equipmentType,
            equipment_vendor: equipmentVendor,
            equipment_model: equipmentModel,
            equipment_status: equipmentStatus,
          };
        } else if (type === 'iiko_server') {
          const extraData = extra && typeof extra === 'object' ? extra : {};
          const serverNameSource =
            (item && typeof item.server_name === 'string' && item.server_name) ||
            (typeof extraData.server_name === 'string' ? extraData.server_name : '');
          const serverName = typeof serverNameSource === 'string' ? serverNameSource.trim() : '';
          entry.server_name = serverName;
          entry.extra = Object.assign({}, extraData, { server_name: serverName });
        } else if (type === 'partner_contact') {
          const normalizedExtra = normalizePartnerContactExtra(extra, { value });
          entry.contact_type = normalizedExtra.contact_type;
          entry.phones = normalizedExtra.phones;
          entry.emails = normalizedExtra.emails;
          entry.contacts = normalizedExtra.contacts;
          entry.served_legal_entity_id = normalizedExtra.served_legal_entity_id;
          entry.served_legal_entity_name = normalizedExtra.served_legal_entity_name;
          entry.legal_entity = normalizedExtra.legal_entity;
          entry.inn = normalizedExtra.inn;
          entry.extra = normalizedExtra;
        }

        const dependencyChain = getDependencyChain(type);
        if (dependencyChain.length) {
          const baseExtra = entry.extra && typeof entry.extra === 'object'
            ? Object.assign({}, entry.extra)
            : Object.assign({}, extra);
          const dependenciesSource = baseExtra && typeof baseExtra.dependencies === 'object'
            ? baseExtra.dependencies
            : {};
          const normalizedDependencies = {};
          dependencyChain.forEach((dep) => {
            let raw = dependenciesSource && Object.prototype.hasOwnProperty.call(dependenciesSource, dep)
              ? dependenciesSource[dep]
              : baseExtra[dep];
            normalizedDependencies[dep] = normalizeDependencyValue(raw);
          });
          entry.dependencies = normalizedDependencies;
          const enrichedExtra = Object.assign({}, baseExtra, { dependencies: normalizedDependencies });
          dependencyChain.forEach((dep) => {
            enrichedExtra[dep] = normalizedDependencies[dep];
          });
          entry.extra = enrichedExtra;
        } else {
          entry.dependencies = {};
          if (entry.extra === undefined && extra && Object.keys(extra).length) {
            entry.extra = extra;
          }
        }
        return entry;
      });
    });
    if (Object.keys(itConnectionCategoryUpdates).length) {
      setItConnectionCategories(itConnectionCategoryUpdates);
    }
    parameterData = result;
    parameterStatusCache.clear();
    partnerContactEdits.clear();
  }

  function buildStateSelect(type, selected, disabled, { forInput = false } = {}) {
    if (!PARAMETER_STATE_TYPES.has(type)) {
      return '';
    }
    const effective = PARAMETER_STATES.includes(selected) ? selected : PARAMETER_STATES[0];
    const options = PARAMETER_STATES.map((state) => `<option value="${state}"${state === effective ? ' selected' : ''}>${state}</option>`).join('');
    const roleAttr = forInput ? 'data-param-state-input' : 'data-param-field="state"';
    const disabledAttr = disabled ? ' disabled' : '';
    return `<select class="form-select form-select-sm" ${roleAttr} data-param-type="${type}" data-param-current-state="${effective}"${disabledAttr}>${options}</select>`;
  }

  function buildUsageControl(type, item) {
    if (type === 'department') {
      return '<span class="input-group-text text-muted">‚Äî</span>';
    }
    const filterKey = PARAMETER_FILTER_KEYS[type];
    const value = item && item.value ? String(item.value) : '';
    const trimmedValue = value.trim();
    if (!filterKey || !trimmedValue) {
      return '<span class="input-group-text text-muted">‚Äî</span>';
    }
    const usage = Number.isFinite(Number(item && item.usage_count)) ? Number(item.usage_count) : 0;
    const url = `/object_passports?${filterKey}=${encodeURIComponent(trimmedValue)}`;
    const btnClass = usage > 0 ? 'btn btn-outline-primary' : 'btn btn-outline-secondary';
    return `<a class="${btnClass}" data-param-role="usage" href="${url}" title="–û—Ç–∫—Ä—ã—Ç—å –ø–∞—Å–ø–æ—Ä—Ç–∞ —Å —ç—Ç–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º">${usage}</a>`;
  }

  function buildParameterItem(type, item) {
    const rawId = item && item.id;
    const idNumber = Number(rawId);
    const id = Number.isFinite(idNumber) ? idNumber : Number.parseInt(rawId, 10);
    if (!Number.isFinite(id)) {
      return '';
    }
    const value = item && item.value ? String(item.value) : '';
    const disabled = Boolean(item && item.is_deleted);
    const dependencyChain = getDependencyChain(type);
    const dependencyValues = item && typeof item.dependencies === 'object' ? item.dependencies : {};
    const dependencySelects = dependencyChain
      .map((dep) => {
        const selected = dependencyValues && typeof dependencyValues[dep] === 'string' ? dependencyValues[dep] : '';
        return buildDependencySelect(type, dep, selected, disabled, 'entry');
      })
      .join('');
    let serverNameInput = '';
    if (type === 'iiko_server') {
      let serverNameSource = '';
      if (item && typeof item.server_name === 'string') {
        serverNameSource = item.server_name;
      } else if (item && item.extra && typeof item.extra.server_name === 'string') {
        serverNameSource = item.extra.server_name;
      }
      const serverName = typeof serverNameSource === 'string' ? serverNameSource.trim() : '';
      serverNameInput = `<input type="text" class="form-control" data-param-field="server_name" placeholder="–ò–º—è —Å–µ—Ä–≤–µ—Ä–∞" value="${escapeHtml(serverName)}"${disabled ? ' disabled' : ''}>`;
    }
    const valuePlaceholder = type === 'iiko_server' ? '–ê–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞' : '';
    const valueInput = `<input type="text" class="form-control" data-param-field="value"${valuePlaceholder ? ` placeholder="${valuePlaceholder}"` : ''} value="${escapeHtml(value)}"${disabled ? ' disabled' : ''}>`;
    const stateSelect = buildStateSelect(type, item ? item.state : undefined, disabled, { forInput: false });
    const usageControl = buildUsageControl(type, item);
    const saveButton = `<button class="btn btn-outline-success" type="button" data-param-action="save" data-param-id="${id}" data-param-type="${type}" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"${disabled ? ' disabled' : ''}>üíæ</button>`;
    const deleteButton = disabled
      ? `<button class="btn btn-outline-secondary" type="button" data-param-action="restore" data-param-id="${id}" data-param-type="${type}" title="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å">‚Ü©Ô∏è</button>`
      : `<button class="btn btn-outline-danger" type="button" data-param-action="delete" data-param-id="${id}" data-param-type="${type}" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>`;
    const deletedHint = disabled ? '<div class="form-text text-danger small">–ó–∞–ø–∏—Å—å –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ —É–¥–∞–ª—ë–Ω–Ω–∞—è</div>' : '';
    return `
      <div class="param-entry${disabled ? ' param-entry--deleted' : ''}" data-param-id="${id}" data-param-type="${type}" data-param-dependency-group="entry">
        <div class="input-group input-group-sm mb-2">
          ${dependencySelects}
          ${serverNameInput}
          ${valueInput}
          ${stateSelect}
          ${usageControl}
          ${saveButton}
          ${deleteButton}
        </div>
        ${deletedHint}
      </div>
    `;
  }

  function buildParameterContent(type, items, context) {
    const listHtml = items.length
      ? items.map((item) => buildParameterItem(type, item)).join('')
      : '<div class="empty-placeholder">–ü–æ–∫–∞ –Ω–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–π</div>';
    const createPlaceholder = type === 'iiko_server' ? '–ê–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞' : '–î–æ–±–∞–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ';
    const extraControls = [];
    if (type === 'iiko_server') {
      extraControls.push(
        '<input type="text" class="form-control" placeholder="–ò–º—è —Å–µ—Ä–≤–µ—Ä–∞" data-param-create-field="server_name">'
      );
    }
    const dependencyChain = getDependencyChain(type);
    const dependencySelects = dependencyChain
      .map((dep) => buildDependencySelect(type, dep, '', false, 'create'))
      .join('');
    const controls = `
      <div class="input-group input-group-sm mt-3" data-param-dependency-group="create" data-param-type="${type}">
        ${dependencySelects}
        ${buildStateSelect(type, PARAMETER_STATES[0], false, { forInput: true })}
        ${extraControls.join('')}
        <input type="text" class="form-control" placeholder="${createPlaceholder}" data-param-input>
        <button class="btn btn-success" type="button" data-param-action="create" data-param-type="${type}">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    `;
    return `
      <div data-param-container data-param-type="${type}" data-param-context="${context}">
        <div class="param-items">${listHtml}</div>
        ${controls}
      </div>
    `;
  }

  function renderRemoteAccessSection() {
    const remoteAccessContainer = document.querySelector('[data-remote-access-container]');
    if (!remoteAccessContainer) return;
    const items = Array.isArray(parameterData.remote_access) ? parameterData.remote_access : [];
    remoteAccessContainer.innerHTML = buildParameterContent('remote_access', items, 'it');
  }

  function buildLegalEntityStateSelect(state, disabled, { isDraft = false } = {}) {
    const effective = PARAMETER_STATES.includes(state) ? state : PARAMETER_STATES[0];
    const options = PARAMETER_STATES.map((item) => {
      const isSelected = item === effective;
      return `<option value="${escapeHtml(item)}"${isSelected ? ' selected' : ''}>${escapeHtml(item)}</option>`;
    }).join('');
    const disabledAttr = disabled ? ' disabled' : '';
    if (isDraft) {
      return `<select class="form-select form-select-sm" data-legal-entity-field="state"${disabledAttr}>${options}</select>`;
    }
    return `
      <select
        class="form-select form-select-sm"
        data-legal-entity-field="state"
        data-param-field="state"
        data-param-type="legal_entity"
        data-param-current-state="${escapeHtml(effective)}"
        ${disabledAttr}
      >
        ${options}
      </select>
    `;
  }

  function getLegalEntityRenderItems() {
    const existing = Array.isArray(parameterData.legal_entity) ? parameterData.legal_entity : [];
    const mappedExisting = existing.map((item) => {
      const extra = item && typeof item.extra === 'object' ? item.extra : {};
      const inn = typeof extra.inn === 'string' ? extra.inn : '';
      const contacts = typeof extra.manager_contacts === 'string' ? extra.manager_contacts : '';
      const usage = Number.isFinite(Number(item && item.usage_count)) ? Number(item.usage_count) : 0;
      return {
        id: item.id,
        value: item && typeof item.value === 'string' ? item.value : '',
        state: item && typeof item.state === 'string' ? item.state : PARAMETER_STATES[0],
        is_deleted: Boolean(item && item.is_deleted),
        usage_count: usage,
        inn,
        manager_contacts: contacts,
        isDraft: false,
      };
    });
    const mappedDrafts = legalEntityDrafts.map((draft) => ({
      draftId: draft.draftId,
      value: typeof draft.value === 'string' ? draft.value : '',
      state: typeof draft.state === 'string' ? draft.state : PARAMETER_STATES[0],
      is_deleted: false,
      usage_count: 0,
      inn: typeof draft.inn === 'string' ? draft.inn : '',
      manager_contacts: typeof draft.manager_contacts === 'string' ? draft.manager_contacts : '',
      isDraft: true,
    }));
    return mappedExisting.concat(mappedDrafts);
  }

  function renderLegalEntityCard(item) {
    const isDraft = Boolean(item && item.isDraft);
    const nameValue = typeof item.value === 'string' ? item.value : '';
    const trimmedName = nameValue.trim();
    const innValue = typeof item.inn === 'string' ? item.inn : '';
    const contactsValue = typeof item.manager_contacts === 'string' ? item.manager_contacts : '';
    const stateValue = typeof item.state === 'string' ? item.state : PARAMETER_STATES[0];
    const isDeleted = Boolean(item && item.is_deleted);
    const usageCount = Number.isFinite(Number(item && item.usage_count)) ? Number(item.usage_count) : 0;
    const usageLabel = `–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: ${usageCount}`;
    const usageControl = !isDraft && trimmedName
      ? `<a href="/object_passports?legal_entity=${encodeURIComponent(trimmedName)}" class="btn btn-link btn-sm p-0${usageCount ? '' : ' text-muted'}">${usageLabel}</a>`
      : `<span class="text-muted small">${usageLabel}</span>`;
    const disabledAttr = isDeleted ? ' disabled' : '';
    const stateSelectHtml = buildLegalEntityStateSelect(stateValue, isDeleted, { isDraft });
    const contactsField = `<textarea class="form-control" rows="3" data-legal-entity-field="manager_contacts"${disabledAttr} placeholder="–¢–µ–ª–µ—Ñ–æ–Ω, –ø–æ—á—Ç–∞, Telegram">${escapeHtml(contactsValue)}</textarea>`;
    const primaryLabel = isDraft ? '–°–æ–∑–¥–∞—Ç—å' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    const primaryClass = isDraft ? 'btn-success' : 'btn-primary';
    const primaryDisabled = isDeleted ? ' disabled' : '';
    let secondaryButton = '';
    if (isDraft) {
      secondaryButton = '<button class="btn btn-outline-secondary btn-sm" type="button" data-legal-entity-action="cancel">–û—Ç–º–µ–Ω–∞</button>';
    } else if (isDeleted) {
      secondaryButton = '<button class="btn btn-outline-success btn-sm" type="button" data-legal-entity-action="restore">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>';
    } else {
      secondaryButton = '<button class="btn btn-outline-danger btn-sm" type="button" data-legal-entity-action="delete">–£–¥–∞–ª–∏—Ç—å</button>';
    }
    const deletedHint = isDeleted
      ? '<div class="alert alert-warning small mt-3 mb-0">–ó–∞–ø–∏—Å—å –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ —É–¥–∞–ª—ë–Ω–Ω–∞—è. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ—ë, —á—Ç–æ–±—ã –≤–Ω–æ—Å–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.</div>'
      : '';
    const idBadge = !isDraft ? `<span class="badge bg-secondary ms-auto">ID: ${item.id}</span>` : '';
    const cardClasses = ['card', 'shadow-sm', 'h-100', 'legal-entity-card'];
    if (isDeleted) {
      cardClasses.push('border-danger', 'opacity-75');
    }
    const datasetAttrs = isDraft
      ? `data-legal-entity-card="true" data-legal-entity-draft="true" data-legal-entity-draft-id="${escapeHtml(item.draftId)}"`
      : `data-legal-entity-card="true" data-legal-entity-draft="false" data-param-id="${item.id}" data-param-type="legal_entity"${isDeleted ? ' data-legal-entity-deleted="true"' : ''}`;
    return `
      <div class="col">
        <div class="${cardClasses.join(' ')}" ${datasetAttrs}>
          <div class="card-header d-flex justify-content-between align-items-start gap-2">
            <div>
              <div class="fw-semibold" data-legal-entity-title>${escapeHtml(trimmedName || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</div>
              <div class="small text-muted" data-legal-entity-state-label>${escapeHtml(stateValue)}</div>
            </div>
            <div>${usageControl}</div>
          </div>
          <div class="card-body d-flex flex-column gap-3">
            <div>
              <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –Æ–õ</label>
              <input type="text" class="form-control" data-legal-entity-field="value"${disabledAttr} value="${escapeHtml(nameValue)}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –û–û–û ¬´–ü–∞—Ä—Ç–Ω—ë—Ä¬ª">
            </div>
            <div class="row g-3">
              <div class="col-sm-6">
                <label class="form-label">–ò–ù–ù</label>
                <input type="text" class="form-control" data-legal-entity-field="inn"${disabledAttr} value="${escapeHtml(innValue)}" placeholder="12 —Ü–∏—Ñ—Ä">
              </div>
              <div class="col-sm-6">
                <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                ${stateSelectHtml}
              </div>
            </div>
            <div>
              <label class="form-label">–ö–æ–Ω—Ç–∞–∫—Ç—ã –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤</label>
              ${contactsField}
              <div class="form-text">–£–∫–∞–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã, –ø–æ—á—Ç—É –∏–ª–∏ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤.</div>
            </div>
            <div class="d-flex flex-wrap gap-2 align-items-center">
              <button class="btn ${primaryClass} btn-sm" type="button" data-legal-entity-action="save"${primaryDisabled}>${primaryLabel}</button>
              ${secondaryButton}
              ${idBadge}
            </div>
            ${deletedHint}
          </div>
        </div>
      </div>
    `;
  }

  function renderLegalEntities() {
    if (!legalEntitiesContainer) return;
    const items = getLegalEntityRenderItems();
    if (!items.length) {
      legalEntitiesContainer.innerHTML = '';
      if (legalEntitiesEmptyPlaceholder) {
        legalEntitiesEmptyPlaceholder.classList.remove('d-none');
      }
      return;
    }
    legalEntitiesContainer.innerHTML = items.map((item) => renderLegalEntityCard(item)).join('');
    if (legalEntitiesEmptyPlaceholder) {
      legalEntitiesEmptyPlaceholder.classList.add('d-none');
    }
  }

  function addLegalEntityDraft(initial = {}) {
    legalEntityDraftCounter += 1;
    const defaults = {
      draftId: `draft-${legalEntityDraftCounter}`,
      value: '',
      inn: '',
      manager_contacts: '',
      state: PARAMETER_STATES[0],
    };
    const draft = Object.assign({}, defaults, initial || {});
    legalEntityDrafts.push(draft);
    renderLegalEntities();
  }

  function removeLegalEntityDraft(draftId) {
    const index = legalEntityDrafts.findIndex((item) => item.draftId === draftId);
    if (index === -1) return;
    legalEntityDrafts.splice(index, 1);
    renderLegalEntities();
  }

  function updateLegalEntityDraftValue(draftId, field, value) {
    const draft = legalEntityDrafts.find((item) => item.draftId === draftId);
    if (!draft) return;
    if (field === 'value') {
      draft.value = value;
    } else if (field === 'inn') {
      draft.inn = value;
    } else if (field === 'manager_contacts') {
      draft.manager_contacts = value;
    } else if (field === 'state') {
      draft.state = PARAMETER_STATES.includes(value) ? value : draft.state;
    }
  }

  function updateLegalEntityStateLabel(card, value) {
    const label = card.querySelector('[data-legal-entity-state-label]');
    if (label) {
      label.textContent = value || '‚Äî';
    }
  }

  async function handleLegalEntitySave(card, trigger) {
    const isDraft = card.dataset.legalEntityDraft === 'true';
    const valueInput = card.querySelector('[data-legal-entity-field="value"]');
    const innInput = card.querySelector('[data-legal-entity-field="inn"]');
    const contactsInput = card.querySelector('[data-legal-entity-field="manager_contacts"]');
    const stateSelect = card.querySelector('[data-legal-entity-field="state"]');
    const name = valueInput ? valueInput.value.trim() : '';
    if (!name) {
      alert('–ù–∞–∑–≤–∞–Ω–∏–µ –Æ–õ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
      if (valueInput) {
        valueInput.focus();
      }
      return;
    }
    const payload = {
      value: name,
      inn: innInput ? innInput.value.trim() : '',
      manager_contacts: contactsInput ? contactsInput.value.trim() : '',
    };
    if (stateSelect && !stateSelect.disabled) {
      payload.state = stateSelect.value;
    }

    const originalText = trigger.textContent;
    trigger.disabled = true;
    trigger.textContent = '...';

    try {
      let response;
      if (isDraft) {
        payload.param_type = 'legal_entity';
        response = await fetch('/api/settings/parameters', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } else {
        const id = Number.parseInt(card.dataset.paramId, 10);
        if (!Number.isFinite(id)) {
          throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏');
        }
        response = await fetch(`/api/settings/parameters/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      }
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏');
      }
      if (isDraft) {
        const draftId = card.dataset.legalEntityDraftId;
        if (draftId) {
          const index = legalEntityDrafts.findIndex((item) => item.draftId === draftId);
          if (index !== -1) {
            legalEntityDrafts.splice(index, 1);
          }
        }
      }
      syncParameterData((data && data.data) || parameterData);
      renderParameters({ forceBodies: true });
      renderItConnectionsTable();
    } catch (error) {
      const message = error && error.message ? error.message : error;
      alert('‚ùå ' + message);
    } finally {
      trigger.disabled = false;
      trigger.textContent = originalText;
    }
  }

  function getPartnerContactLegalEntityOptions() {
    const items = Array.isArray(parameterData.legal_entity) ? parameterData.legal_entity : [];
    const options = [];
    items.forEach((item) => {
      if (!item) return;
      if (item.is_deleted) return;
      const label = typeof item.value === 'string' ? item.value.trim() : '';
      if (!label) return;
      const id = Number.isFinite(item.id) ? item.id : Number.parseInt(item.id, 10);
      if (!Number.isFinite(id)) return;
      options.push({ id, label });
    });
    return options;
  }

  function getPartnerContactBaseItems() {
    const items = Array.isArray(parameterData.partner_contact) ? parameterData.partner_contact : [];
    return items
      .map((item) => {
        if (!item) return null;
        return clonePartnerContactItem({
          id: Number.isFinite(item.id) ? item.id : Number.parseInt(item.id, 10),
          value: typeof item.value === 'string' ? item.value : '',
          state: typeof item.state === 'string' ? item.state : PARAMETER_STATES[0],
          contact_type: item.contact_type,
          phones: item.phones,
          emails: item.emails,
          contacts: item.contacts,
          served_legal_entities: item.served_legal_entities,
          served_legal_entity_id: item.served_legal_entity_id,
          served_legal_entity_name: item.served_legal_entity_name,
          served_legal_entity_ids: item.served_legal_entity_ids,
          served_legal_entity_names: item.served_legal_entity_names,
          legal_entity: typeof item.legal_entity === 'string' ? item.legal_entity : '',
          internal_name: typeof item.internal_name === 'string' ? item.internal_name : '',
          inn: typeof item.inn === 'string' ? item.inn : '',
          is_deleted: Boolean(item.is_deleted),
          usage_count: Number.isFinite(Number(item.usage_count)) ? Number(item.usage_count) : 0,
        });
      })
      .filter((entry) => entry && Number.isFinite(entry.id));
  }

  function ensurePartnerContactEdit(id) {
    if (!Number.isFinite(id)) return null;
    if (!partnerContactEdits.has(id)) {
      const baseItems = getPartnerContactBaseItems();
      const base = baseItems.find((item) => item && item.id === id);
      partnerContactEdits.set(id, base ? clonePartnerContactItem(base) : null);
    }
    const current = partnerContactEdits.get(id);
    if (!current) {
      return null;
    }
    if (!Array.isArray(current.phones)) {
      current.phones = [];
    }
    if (!Array.isArray(current.emails)) {
      current.emails = [];
    }
    if (!Array.isArray(current.served_legal_entities)) {
      current.served_legal_entities = [];
    }
    if (!Array.isArray(current.contacts)) {
      current.contacts = [];
    }
    return current;
  }

  function getPartnerContactRenderItems() {
    const baseItems = getPartnerContactBaseItems();
    const rendered = baseItems.map((item) => {
      const id = item.id;
      const edit = ensurePartnerContactEdit(id);
      if (edit) {
        const clone = clonePartnerContactItem(edit);
        clone.id = id;
        clone.isDraft = false;
        clone.is_deleted = item.is_deleted;
        clone.usage_count = item.usage_count;
        return clone;
      }
      item.isDraft = false;
      return item;
    });
    partnerContactDrafts.forEach((draft) => {
      const clone = clonePartnerContactItem(draft);
      if (!clone) return;
      clone.isDraft = true;
      clone.draftId = draft.draftId;
      rendered.push(clone);
    });
    return rendered;
  }

  function buildPartnerContactTypeSelect(selected, disabled) {
    const effective = Object.prototype.hasOwnProperty.call(PARTNER_CONTACT_TYPES, selected)
      ? selected
      : 'partner';
    const disabledAttr = disabled ? ' disabled' : '';
    const options = Object.keys(PARTNER_CONTACT_TYPES)
      .map((key) => {
        const label = PARTNER_CONTACT_TYPES[key];
        const isSelected = key === effective;
        return `<option value="${key}"${isSelected ? ' selected' : ''}>${escapeHtml(label)}</option>`;
      })
      .join('');
    return `<select class="form-select form-select-sm" data-partner-contact-field="contact_type"${disabledAttr}>${options}</select>`;
  }

  function buildPartnerContactStateControl(item, disabled) {
    const effective = PARAMETER_STATES.includes(item.state) ? item.state : PARAMETER_STATES[0];
    const options = PARAMETER_STATES.map((state) => {
      const isSelected = state === effective;
      return `<option value="${escapeHtml(state)}"${isSelected ? ' selected' : ''}>${escapeHtml(state)}</option>`;
    }).join('');
    const disabledAttr = disabled ? ' disabled' : '';
    return `<select class="form-select form-select-sm" data-partner-contact-field="state"${disabledAttr}>${options}</select>`;
  }

  function buildPartnerContactServedSelect(item, disabled) {
    const disabledAttr = disabled ? ' disabled' : '';
    const options = getPartnerContactLegalEntityOptions();
    const servedEntities = Array.isArray(item.served_legal_entities) ? item.served_legal_entities : [];
    const selectedIds = new Set();
    const labelById = new Map();

    servedEntities.forEach((entry) => {
      if (!entry || typeof entry !== 'object') return;
      const parsed = Number.isFinite(entry.id) ? entry.id : Number.parseInt(entry.id, 10);
      if (!Number.isFinite(parsed) || parsed <= 0) return;
      selectedIds.add(parsed);
      const label = typeof entry.name === 'string' && entry.name.trim() ? entry.name.trim() : `ID ${parsed}`;
      labelById.set(parsed, label);
    });

    const fallbackId = Number.isFinite(item.served_legal_entity_id)
      ? item.served_legal_entity_id
      : Number.parseInt(item.served_legal_entity_id, 10);
    if (Number.isFinite(fallbackId) && fallbackId > 0 && !selectedIds.has(fallbackId)) {
      selectedIds.add(fallbackId);
      const fallbackName = typeof item.served_legal_entity_name === 'string' && item.served_legal_entity_name.trim()
        ? item.served_legal_entity_name.trim()
        : `ID ${fallbackId}`;
      labelById.set(fallbackId, fallbackName);
    }

    const entries = [];
    options.forEach(({ id, label }) => {
      const isSelected = selectedIds.has(id);
      if (isSelected) {
        selectedIds.delete(id);
      }
      labelById.set(id, label);
      entries.push(
        `<option value="${id}" data-label="${escapeHtml(label)}"${isSelected ? ' selected' : ''}>${escapeHtml(label)}</option>`
      );
    });

    selectedIds.forEach((id) => {
      const fallbackLabel = labelById.get(id) || `ID ${id}`;
      entries.push(
        `<option value="${id}" data-label="${escapeHtml(fallbackLabel)}" selected>${escapeHtml(fallbackLabel)} ‚Ä¢ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</option>`
      );
    });

    if (!entries.length) {
      return '<div class="text-muted small">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Æ–õ</div>';
    }

    const size = Math.min(Math.max(entries.length, 4), 10);
    return `<select class="form-select form-select-sm partner-contact-served-select" data-partner-contact-field="served_legal_entities" multiple size="${size}"${disabledAttr}>${entries.join('')}</select>`;
  }

  function buildPartnerContactCommRows(entries, kind, disabled) {
    if (!Array.isArray(entries) || !entries.length) {
      return '<div class="text-muted small" data-partner-contact-empty>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
    }
    const allowed = kind === 'phone' ? PARTNER_CONTACT_PHONE_TYPES : PARTNER_CONTACT_EMAIL_TYPES;
    return entries
      .map((entry) => {
        const rawValue = typeof entry.value === 'string' ? entry.value : '';
        const digitsValue = kind === 'phone' ? extractDigits(rawValue) : rawValue;
        const value = kind === 'phone' ? formatPhoneValue(digitsValue) : rawValue;
        const extensionValue = kind === 'phone' && typeof entry.extension === 'string' ? extractDigits(entry.extension) : '';
        const type = Object.prototype.hasOwnProperty.call(allowed, entry.type) ? entry.type : Object.keys(allowed)[0];
        const disabledAttr = disabled ? ' disabled' : '';
        const options = Object.keys(allowed)
          .map((key) => {
            const label = allowed[key];
            const isSelected = key === type;
            return `<option value="${key}"${isSelected ? ' selected' : ''}>${escapeHtml(label)}</option>`;
          })
          .join('');
        const removeBtn = disabled
          ? ''
          : `<button class="btn btn-outline-danger" type="button" data-partner-contact-remove-comm data-comm-type="${kind}" data-entry-key="${escapeHtml(entry.key)}" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>`;
        if (kind === 'phone') {
          return `
            <div class="input-group input-group-sm mb-2" data-partner-contact-comm-row data-comm-type="${kind}" data-entry-key="${escapeHtml(entry.key)}">
              <select class="form-select form-select-sm" data-partner-contact-comm-field="type" data-comm-type="${kind}" data-entry-key="${escapeHtml(entry.key)}"${disabledAttr}>${options}</select>
              <input type="text" class="form-control" data-partner-contact-comm-field="value" data-comm-type="${kind}" data-entry-key="${escapeHtml(entry.key)}" data-phone-digits="${escapeHtml(digitsValue)}" value="${escapeHtml(value)}" placeholder="–ù–æ–º–µ—Ä" inputmode="numeric"${disabledAttr}>
              <span class="input-group-text">–¥–æ–±.</span>
              <input type="text" class="form-control" data-partner-contact-comm-field="extension" data-comm-type="${kind}" data-entry-key="${escapeHtml(entry.key)}" value="${escapeHtml(extensionValue)}" placeholder="–î–æ–±. –Ω–æ–º–µ—Ä" inputmode="numeric"${disabledAttr}>
              ${removeBtn}
            </div>
          `;
        }
        return `
          <div class="input-group input-group-sm mb-2" data-partner-contact-comm-row data-comm-type="${kind}" data-entry-key="${escapeHtml(entry.key)}">
            <select class="form-select form-select-sm" data-partner-contact-comm-field="type" data-comm-type="${kind}" data-entry-key="${escapeHtml(entry.key)}"${disabledAttr}>${options}</select>
            <input type="email" class="form-control" data-partner-contact-comm-field="value" data-comm-type="${kind}" data-entry-key="${escapeHtml(entry.key)}" value="${escapeHtml(value)}" placeholder="E-mail"${disabledAttr}>
            ${removeBtn}
          </div>
        `;
      })
      .join('');
  }

  function getSortedPartnerContactPeople(entries) {
    if (!Array.isArray(entries) || !entries.length) {
      return [];
    }
    return entries
      .map((person, index) => ({
        person,
        index,
        isTop: normalizeBooleanValue(person && person.is_top),
        name: person && typeof person.full_name === 'string' ? person.full_name.trim() : '',
      }))
      .sort((a, b) => {
        if (a.isTop !== b.isTop) {
          return a.isTop ? -1 : 1;
        }
        const nameCompare = a.name.localeCompare(b.name, undefined, { sensitivity: 'base' });
        if (nameCompare !== 0) {
          return nameCompare;
        }
        return a.index - b.index;
      })
      .map(({ person }) => person);
  }

  function buildPartnerContactPeople(entries, disabled) {
    if (!Array.isArray(entries) || !entries.length) {
      return '<div class="text-muted small" data-partner-contact-person-empty>–ö–æ–Ω—Ç–∞–∫—Ç—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>';
    }
    const sortedEntries = getSortedPartnerContactPeople(entries);
    const maxVisible = 2;
    const peopleCards = sortedEntries
      .map((person, index) => {
        if (!person || typeof person !== 'object') {
          return '';
        }
        const key = typeof person.key === 'string' ? person.key : '';
        const fullName = typeof person.full_name === 'string' ? person.full_name : '';
        const position = typeof person.position === 'string' ? person.position : '';
        const phone = typeof person.phone === 'string' ? person.phone : '';
        const email = typeof person.email === 'string' ? person.email : '';
        const phoneDigits = extractDigits(phone);
        const formattedPhone = formatPhoneValue(phone);
        const disabledAttr = disabled ? ' disabled' : '';
        const isTop = normalizeBooleanValue(person.is_top);
        const topBadgeClass = isTop
          ? 'badge bg-warning text-dark'
          : 'badge bg-warning text-dark d-none';
        const topToggle = `
          <div class="form-check form-switch mb-0">
            <input class="form-check-input" type="checkbox" data-partner-contact-person-field="is_top"${isTop ? ' checked' : ''}${disabledAttr}>
            <label class="form-check-label small">–¢–û–ü</label>
          </div>
        `;
        const removeBtn = disabled
          ? ''
          : `<button class="btn btn-outline-danger btn-sm" type="button" data-partner-contact-remove-person data-person-key="${escapeHtml(
              key
            )}">–£–¥–∞–ª–∏—Ç—å</button>`;
        const titleText = escapeHtml(fullName || `–ö–æ–Ω—Ç–∞–∫—Ç ${index + 1}`);
        const subtitleClass = position
          ? 'partner-contact-person-card__subtitle'
          : 'partner-contact-person-card__subtitle d-none';
        const subtitleText = escapeHtml(position || '');
        return `
          <div class="partner-contact-person partner-contact-person-card" data-partner-contact-person="${escapeHtml(key)}">
            <div class="partner-contact-person-card__header">
              <div>
                <div class="d-flex align-items-center gap-2">
                  <div class="partner-contact-person-card__title" data-partner-contact-person-title>${titleText}</div>
                  <span class="${topBadgeClass}" data-partner-contact-person-top-badge>–¢–û–ü</span>
                </div>
                <div class="${subtitleClass}" data-partner-contact-person-subtitle>${subtitleText}</div>
              </div>
              <div class="partner-contact-person__actions d-flex flex-column align-items-end gap-2">
                ${topToggle}
                ${removeBtn}
              </div>
            </div>
            <div class="partner-contact-person-card__body">
              <div class="row g-3">
                <div class="col-12 col-lg-6">
                  <label class="form-label">–§–ò–û</label>
                  <input type="text" class="form-control form-control-sm" data-partner-contact-person-field="full_name" value="${escapeHtml(
                    fullName
                  )}" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á"${disabledAttr}>
                </div>
                <div class="col-12 col-lg-6">
                  <label class="form-label">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                  <input type="text" class="form-control form-control-sm" data-partner-contact-person-field="position" value="${escapeHtml(
                    position
                  )}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –º–µ–Ω–µ–¥–∂–µ—Ä"${disabledAttr}>
                </div>
                <div class="col-12 col-lg-6">
                  <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                  <input type="text" class="form-control form-control-sm" data-partner-contact-person-field="phone" value="${escapeHtml(
                    formattedPhone
                  )}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, +7 999 123-45-67" inputmode="tel" data-phone-digits="${escapeHtml(
                    phoneDigits
                  )}"${disabledAttr}>
                </div>
                <div class="col-12 col-lg-6">
                  <label class="form-label">E-mail</label>
                  <input type="email" class="form-control form-control-sm" data-partner-contact-person-field="email" value="${escapeHtml(
                    email
                  )}" placeholder="example@company.com"${disabledAttr}>
                </div>
              </div>
            </div>
          </div>
        `;
      })
      .filter(Boolean);
    const visibleCards = peopleCards.slice(0, maxVisible).join('');
    const hiddenCards = peopleCards.slice(maxVisible).join('');
    if (!hiddenCards) {
      return visibleCards;
    }
    const extraCount = sortedEntries.length - maxVisible;
    const collapsedText = `–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë ${formatPartnerContactCount(extraCount)}`;
    const expandedText = '–°–∫—Ä—ã—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã';
    return `
      <div class="partner-contact-people-wrapper" data-partner-contact-people-wrapper>
        ${visibleCards}
        <div class="partner-contact-people-extra mt-3 d-none" data-partner-contact-people-extra>${hiddenCards}</div>
        <div class="mt-3">
          <button class="btn btn-link btn-sm px-0 partner-contact-people-toggle" type="button" data-partner-contact-people-toggle aria-expanded="false" data-collapsed-text="${escapeHtml(
            collapsedText
          )}" data-expanded-text="${escapeHtml(expandedText)}">${escapeHtml(collapsedText)}</button>
        </div>
      </div>
    `;
  }

  function formatPartnerContactCount(count) {
    const value = Number.parseInt(count, 10);
    if (!Number.isFinite(value) || value <= 0) {
      return '0 –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤';
    }
    const abs = Math.abs(value);
    const mod10 = abs % 10;
    const mod100 = abs % 100;
    if (mod10 === 1 && mod100 !== 11) {
      return `${abs} –∫–æ–Ω—Ç–∞–∫—Ç`;
    }
    if (mod10 >= 2 && mod10 <= 4 && (mod100 < 10 || mod100 >= 20)) {
      return `${abs} –∫–æ–Ω—Ç–∞–∫—Ç–∞`;
    }
    return `${abs} –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤`;
  }

  function getPartnerContactServedSummaryText(item) {
    if (!item || typeof item !== 'object') return '';
    const names = [];
    const servedEntities = Array.isArray(item.served_legal_entities) ? item.served_legal_entities : [];
    servedEntities.forEach((entry) => {
      if (!entry || typeof entry !== 'object') return;
      const name = typeof entry.name === 'string' ? entry.name.trim() : '';
      const id = Number.isFinite(entry.id) ? entry.id : Number.parseInt(entry.id, 10);
      if (name) {
        names.push(name);
      } else if (Number.isFinite(id) && id > 0) {
        names.push(`ID ${id}`);
      }
    });
    if (!names.length) {
      const fallbackName = typeof item.served_legal_entity_name === 'string' ? item.served_legal_entity_name.trim() : '';
      const fallbackId = Number.isFinite(item.served_legal_entity_id)
        ? item.served_legal_entity_id
        : Number.parseInt(item.served_legal_entity_id, 10);
      if (fallbackName) {
        names.push(fallbackName);
      } else if (Number.isFinite(fallbackId) && fallbackId > 0) {
        names.push(`ID ${fallbackId}`);
      }
    }
    return names.join(', ');
  }

  function buildPartnerContactSummaryContacts(item) {
    const contacts = getSortedPartnerContactPeople(Array.isArray(item.contacts) ? item.contacts : []);
    const normalized = contacts
      .map((person, index) => {
        if (!person || typeof person !== 'object') return null;
        const fullName = typeof person.full_name === 'string' ? person.full_name.trim() : '';
        const position = typeof person.position === 'string' ? person.position.trim() : '';
        const phone = typeof person.phone === 'string' ? person.phone.trim() : '';
        const formattedPhone = formatPhoneValue(phone);
        const email = typeof person.email === 'string' ? person.email.trim() : '';
        if (!fullName && !position && !phone && !email) return null;
        return {
          title: fullName || `–ö–æ–Ω—Ç–∞–∫—Ç ${index + 1}`,
          position,
          phone: formattedPhone,
          email,
          is_top: normalizeBooleanValue(person.is_top),
        };
      })
      .filter((entry) => entry);
    const limited = normalized.slice(0, 2);
    const items = limited.map((person) => {
      const metaLines = [];
      if (person.position) {
        metaLines.push(`<div class="partner-contact-summary-contact-meta">${escapeHtml(person.position)}</div>`);
      }
      const detailParts = [];
      if (person.phone) {
        detailParts.push(`<span><i class="bi bi-telephone-fill me-1"></i>${escapeHtml(person.phone)}</span>`);
      }
      if (person.email) {
        detailParts.push(`<span><i class="bi bi-envelope-fill me-1"></i>${escapeHtml(person.email)}</span>`);
      }
      if (detailParts.length) {
        metaLines.push(
          `<div class="partner-contact-summary-contact-meta">${detailParts.join('<span class="text-muted">‚Ä¢</span>')}</div>`
        );
      }
      const topBadge = person.is_top
        ? ' <span class="badge bg-warning text-dark ms-1">–¢–û–ü</span>'
        : '';
      return `
        <li class="partner-contact-summary-contact">
          <div class="partner-contact-summary-contact-title">${escapeHtml(person.title)}${topBadge}</div>
          ${metaLines.join('')}
        </li>
      `;
    });
    if (normalized.length > limited.length) {
      const remainder = normalized.length - limited.length;
      items.push(
        `<li class="partner-contact-summary-contact-meta text-muted">–ï—â—ë ${formatPartnerContactCount(remainder)}</li>`
      );
    }
    if (items.length) {
      return items.join('');
    }
    const fallbackEntries = [];
    const phones = Array.isArray(item.phones) ? item.phones : [];
    phones.forEach((entry) => {
      if (!entry || typeof entry !== 'object') return;
      const value = typeof entry.value === 'string' ? extractDigits(entry.value) : '';
      if (!value) return;
      const extension = typeof entry.extension === 'string' ? extractDigits(entry.extension) : '';
      fallbackEntries.push({ kind: 'phone', value, extension });
    });
    const emails = Array.isArray(item.emails) ? item.emails : [];
    emails.forEach((entry) => {
      if (!entry || typeof entry !== 'object') return;
      const value = typeof entry.value === 'string' ? entry.value.trim() : '';
      if (!value) return;
      fallbackEntries.push({ kind: 'email', value });
    });
    const limitedFallback = fallbackEntries.slice(0, 2);
    if (limitedFallback.length) {
      const rendered = limitedFallback
        .map((entry) => {
          const icon = entry.kind === 'phone'
            ? '<i class="bi bi-telephone-fill me-1"></i>'
            : '<i class="bi bi-envelope-fill me-1"></i>';
          const label = entry.kind === 'phone' ? '–¢–µ–ª–µ—Ñ–æ–Ω' : 'E-mail';
          if (entry.kind === 'phone') {
            const formatted = formatPhoneValue(entry.value);
            if (!formatted) {
              return '';
            }
            const extensionPart = entry.extension
              ? `<span class="text-muted">‚Ä¢</span><span> –¥–æ–±. ${escapeHtml(entry.extension)}</span>`
              : '';
            return `
              <li class="partner-contact-summary-contact">
                <div class="partner-contact-summary-contact-title">${label}</div>
                <div class="partner-contact-summary-contact-meta">${icon}${escapeHtml(formatted)}${extensionPart}</div>
              </li>
            `;
          }
          return `
            <li class="partner-contact-summary-contact">
              <div class="partner-contact-summary-contact-title">${label}</div>
              <div class="partner-contact-summary-contact-meta">${icon}${escapeHtml(entry.value)}</div>
            </li>
          `;
        })
        .join('');
      if (fallbackEntries.length > limitedFallback.length) {
        const remainder = fallbackEntries.length - limitedFallback.length;
        return (
          rendered +
          `<li class="partner-contact-summary-contact-meta text-muted">–ï—â—ë ${formatPartnerContactCount(remainder)}</li>`
        );
      }
      return rendered;
    }
    return '<li class="partner-contact-summary-empty">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —É–∫–∞–∑–∞–Ω—ã</li>';
  }

  function renderPartnerContactCard(item, options = {}) {
    if (!item) return '';
    const mode = options.mode === 'editor' ? 'editor' : 'summary';
    const isDraft = Boolean(item.isDraft);
    const isDeleted = Boolean(item.is_deleted);
    const disabled = !isDraft && isDeleted;
    const idValue = item && item.id != null ? String(item.id) : '';
    const cardClasses = ['card', 'shadow-sm', 'partner-contact-card', 'h-100'];
    if (mode === 'summary') {
      cardClasses.push('partner-contact-card--summary');
    }
    if (isDeleted) {
      cardClasses.push('border-danger', 'opacity-75');
    }
    let datasetAttrs;
    if (isDraft) {
      const draftId = typeof item.draftId === 'string' ? item.draftId : '';
      const attrs = ['data-partner-contact-card="true"', 'data-partner-contact-draft="true"'];
      if (draftId) {
        attrs.push(`data-partner-contact-draft-id="${escapeHtml(draftId)}"`);
      }
      datasetAttrs = attrs.join(' ');
    } else {
      const attrs = ['data-partner-contact-card="true"', 'data-partner-contact-draft="false"', 'data-param-type="partner_contact"'];
      if (idValue) {
        attrs.push(`data-partner-contact-id="${escapeHtml(idValue)}"`, `data-param-id="${escapeHtml(idValue)}"`);
      }
      if (isDeleted) {
        attrs.push('data-partner-contact-deleted="true"');
      }
      datasetAttrs = attrs.join(' ');
    }
    const typeLabel = PARTNER_CONTACT_TYPES[item.contact_type] || PARTNER_CONTACT_TYPES.partner;
    const stateValue = typeof item.state === 'string' ? item.state : PARAMETER_STATES[0];
    const titleValue = typeof item.value === 'string' ? item.value.trim() : '';
    const displayName = getPartnerContactDisplayName(item);
    const servedSummaryText = getPartnerContactServedSummaryText(item);
    const innValue = typeof item.inn === 'string' ? item.inn.trim() : '';

    if (mode === 'summary') {
      const contactsSummary = buildPartnerContactSummaryContacts(item);
      const ariaLabel = displayName
        ? `–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –∫–æ–Ω—Ç–∞–∫—Ç–∞ ¬´${displayName}¬ª`
        : '–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –∫–æ–Ω—Ç–∞–∫—Ç–∞';
      const idBadge = !isDraft && idValue ? `<span class="badge bg-secondary">ID: ${escapeHtml(idValue)}</span>` : '';
      const draftBadge = isDraft ? '<span class="badge bg-success">–ß–µ—Ä–Ω–æ–≤–∏–∫</span>' : '';
      const deletedBadge = isDeleted ? '<span class="badge text-bg-warning">–£–¥–∞–ª–µ–Ω–æ</span>' : '';
      return `
        <div class="col">
          <div class="${cardClasses.join(' ')}" ${datasetAttrs} data-partner-contact-open-modal role="button" tabindex="0" aria-label="${escapeHtml(ariaLabel)}">
            <div class="card-body">
              <div class="partner-contact-summary-head">
                <div>
                  <div class="partner-contact-summary-title" data-partner-contact-title>${escapeHtml((displayName || titleValue || '').trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</div>
                  <div class="partner-contact-summary-meta" data-partner-contact-subtitle>${escapeHtml(typeLabel)} ‚Ä¢ ${escapeHtml(stateValue)}</div>
                </div>
                <div class="d-flex flex-column align-items-end gap-1">
                  ${draftBadge}
                  ${idBadge}
                  ${deletedBadge}
                </div>
              </div>
              <div>
                <div class="partner-contact-summary-label small text-muted text-uppercase">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ</div>
                <div class="partner-contact-summary-value">${escapeHtml(titleValue || '‚Äî')}</div>
              </div>
              <div>
                <div class="partner-contact-summary-label small text-muted text-uppercase">–ò–ù–ù</div>
                <div class="partner-contact-summary-value">${escapeHtml(innValue || '‚Äî')}</div>
              </div>
              <div>
                <div class="partner-contact-summary-label small text-muted text-uppercase">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div>
                <ul class="partner-contact-summary-list mb-0">
                  ${contactsSummary}
                </ul>
              </div>
              ${servedSummaryText ? `
              <div>
                <div class="partner-contact-summary-label small text-muted text-uppercase">–û–±—Å–ª—É–∂–∏–≤–∞–µ—Ç</div>
                <div class="partner-contact-summary-value">${escapeHtml(servedSummaryText)}</div>
              </div>` : ''}
              <div class="mt-auto text-end">
                <span class="text-primary small d-inline-flex align-items-center gap-1">
                  –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                  <i class="bi bi-arrow-right-short fs-5 mb-0"></i>
                </span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    const typeSelect = buildPartnerContactTypeSelect(item.contact_type, disabled);
    const stateControl = buildPartnerContactStateControl(item, disabled);
    const servedSelect = buildPartnerContactServedSelect(item, disabled);
    const contactsSection = buildPartnerContactPeople(item.contacts, disabled);
    const primaryLabel = isDraft ? '–°–æ–∑–¥–∞—Ç—å' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    const primaryClass = isDraft ? 'btn-success' : 'btn-primary';
    const primaryDisabled = disabled ? ' disabled' : '';
    const actionButtons = [`<button class="btn ${primaryClass} btn-sm" type="button" data-partner-contact-action="save"${primaryDisabled}>${primaryLabel}</button>`];
    if (isDraft) {
      actionButtons.push(
        '<button class="btn btn-outline-secondary btn-sm" type="button" data-partner-contact-action="cancel">–û—Ç–º–µ–Ω–∞</button>'
      );
    } else if (isDeleted) {
      actionButtons.push(
        '<button class="btn btn-outline-success btn-sm" type="button" data-partner-contact-action="restore">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>'
      );
    } else {
      actionButtons.push(
        '<button class="btn btn-outline-secondary btn-sm" type="button" data-partner-contact-action="reset">–û—Ç–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>'
      );
      actionButtons.push(
        '<button class="btn btn-outline-danger btn-sm" type="button" data-partner-contact-action="delete">–£–¥–∞–ª–∏—Ç—å</button>'
      );
    }
    const idBadge = !isDraft && idValue ? `<span class="badge bg-secondary ms-auto">ID: ${escapeHtml(idValue)}</span>` : '';
    const addPersonBtn = disabled
      ? ''
      : '<button class="btn btn-outline-success btn-sm" type="button" data-partner-contact-add-person>+ –ö–æ–Ω—Ç–∞–∫—Ç</button>';
    const servedWrapperClass = item.contact_type === 'ka' ? '' : ' d-none';
    const internalNameValue = typeof item.internal_name === 'string' ? item.internal_name : '';
    const baseKey =
      getPartnerContactItemKey(item) ||
      (isDraft && item.draftId
        ? `draft:${item.draftId}`
        : Number.isFinite(item.id)
        ? `item:${item.id}`
        : null);
    if (baseKey && !partnerContactDetailsState.has(baseKey)) {
      partnerContactDetailsState.set(baseKey, 'expanded');
    }
    const isDetailsCollapsed = baseKey ? partnerContactDetailsState.get(baseKey) === 'collapsed' : false;
    const detailsClasses = ['partner-contact-details', isDetailsCollapsed ? 'is-collapsed' : 'is-expanded'];
    const detailsAria = isDetailsCollapsed ? 'false' : 'true';
    const deletedHint = isDeleted
      ? '<div class="alert alert-warning small mt-3 mb-0">–ö–æ–Ω—Ç–∞–∫—Ç –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ —É–¥–∞–ª—ë–Ω–Ω—ã–π. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–ø–∏—Å—å, —á—Ç–æ–±—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –µ—ë.</div>'
      : '';
    const headerStateClass = PARTNER_CONTACT_STATE_CLASS_MAP[stateValue] || '';
    const cardDatasetAttrs = baseKey
      ? `${datasetAttrs} data-partner-contact-key="${escapeHtml(baseKey)}"`
      : datasetAttrs;
    const actionsAttributes = ['data-partner-contact-actions'];
    if (baseKey) {
      actionsAttributes.push(`data-partner-contact-actions-owner="${escapeHtml(baseKey)}"`);
    }
    const actionsAttrString = actionsAttributes.join(' ');
    return `
      <div class="col">
        <div class="${cardClasses.join(' ')}" ${cardDatasetAttrs}>
          <div class="card-header d-flex justify-content-between align-items-start gap-2 ${headerStateClass}" data-partner-contact-card-header>
            <div>
              <div class="fw-semibold partner-contact-card__title" data-partner-contact-title>${escapeHtml((displayName || titleValue || '').trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</div>
              <div class="small partner-contact-card__subtitle" data-partner-contact-subtitle>${escapeHtml(typeLabel)} ‚Ä¢ ${escapeHtml(stateValue)}</div>
            </div>
            <div class="d-flex align-items-start gap-2">
              ${idBadge}
              <button class="btn btn-outline-primary btn-sm" type="button" data-partner-contact-open-modal title="–û—Ç–∫—Ä—ã—Ç—å –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ">
                <i class="bi bi-arrows-fullscreen"></i>
              </button>
            </div>
          </div>
          <div class="card-body d-flex flex-column gap-3">
            <div class="row g-3 align-items-end">
              <div class="col-12 col-lg-4 col-xl-3">
                <label class="form-label">–¢–∏–ø</label>
                ${typeSelect}
              </div>
              <div class="col-12 col-lg-4 col-xl-3">
                <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                ${stateControl}
              </div>
              <div class="col-12 col-lg-4 col-xl-6">
                <label class="form-label">–í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" class="form-control" data-partner-contact-field="internal_name" value="${escapeHtml((internalNameValue || '').trim())}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ö–ª—é—á–µ–≤–æ–π –ø–∞—Ä—Ç–Ω—ë—Ä"${disabled ? ' disabled' : ''}>
                <div class="form-text">–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –ø–∞–Ω–µ–ª–∏ –∏ –æ—Ç—á—ë—Ç–∞—Ö.</div>
              </div>
            </div>
            <div>
              <div class="row g-3">
                <div class="col-sm-6">
                  <label class="form-label">–Æ–õ</label>
                  <input type="text" class="form-control" data-partner-contact-field="value" value="${escapeHtml(item.value || '')}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –û–û–û ¬´–ü–∞—Ä—Ç–Ω—ë—Ä¬ª"${disabled ? ' disabled' : ''}>
                  <div class="form-text">–ù–∞–∑–≤–∞–Ω–∏–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –ª–∏—Ü–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞.</div>
                </div>
                <div class="col-sm-6">
                  <label class="form-label">–ò–ù–ù</label>
                  <input type="text" class="form-control" data-partner-contact-field="inn" value="${escapeHtml(innValue)}" placeholder="12 —Ü–∏—Ñ—Ä" inputmode="numeric"${disabled ? ' disabled' : ''}>
                  <div class="form-text">–£–∫–∞–∂–∏—Ç–µ –ò–ù–ù —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –ª–∏—Ü–∞.</div>
                </div>
              </div>
            </div>
            <div class="${servedWrapperClass}" data-partner-contact-served-wrapper>
              <label class="form-label mb-1">–ö–∞–∫–æ–µ –Æ–õ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç</label>
              ${servedSelect}
              <div class="form-text">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –Æ–õ.</div>
              <div class="partner-contact-served-summary" data-partner-contact-served-summary>${escapeHtml(servedSummaryText)}</div>
            </div>
            <div class="${detailsClasses.join(' ')}" data-partner-contact-details${baseKey ? ` data-details-key="${escapeHtml(baseKey)}"` : ''}>
              <div class="partner-contact-details__header">
                <button class="partner-contact-details__toggle" type="button" data-partner-contact-details-toggle aria-expanded="${detailsAria}">
                  <span class="partner-contact-details__title">–ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏</span>
                  <i class="bi bi-chevron-down partner-contact-details__chevron"></i>
                </button>
              </div>
              <div class="partner-contact-details__body">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
                  <label class="form-label mb-0">–ö–æ–Ω—Ç–∞–∫—Ç—ã</label>
                  ${addPersonBtn}
                </div>
                <div data-partner-contact-people>${contactsSection}</div>
              </div>
            </div>
            <div class="d-flex flex-wrap gap-2 align-items-center" ${actionsAttrString}>
              ${actionButtons.join('\n')}
            </div>
            ${deletedHint}
          </div>
        </div>
      </div>
    `;
  }

  function getPartnerContactScopeKey(item) {
    const type = item && typeof item.contact_type === 'string' ? item.contact_type : '';
    const normalizedType = type === 'ka' ? 'partner' : type;
    if (normalizedType && partnerContactSections.has(normalizedType)) {
      return normalizedType;
    }
    if (partnerContactSections.has('partner')) {
      return 'partner';
    }
    const iterator = partnerContactSections.keys();
    const first = iterator.next();
    return first && !first.done ? first.value : null;
  }

  function renderPartnerContacts() {
    if (!partnerContactSections.size) return;
    const items = getPartnerContactRenderItems();
    const activeKeys = new Set();
    items.forEach((item) => {
      const key = getPartnerContactItemKey(item);
      if (key) {
        activeKeys.add(key);
        if (!partnerContactDetailsState.has(key)) {
          partnerContactDetailsState.set(key, 'expanded');
        }
      }
    });
    Array.from(partnerContactDetailsState.keys()).forEach((key) => {
      if (!activeKeys.has(key)) {
        partnerContactDetailsState.delete(key);
      }
    });
    const grouped = new Map();
    items.forEach((item) => {
      const scope = getPartnerContactScopeKey(item);
      if (!scope) return;
      if (!grouped.has(scope)) {
        grouped.set(scope, []);
      }
      grouped.get(scope).push(item);
    });
    partnerContactSections.forEach(({ container, emptyPlaceholder }, scope) => {
      if (!container) return;
      const scopedItems = grouped.get(scope) || [];
      if (!scopedItems.length) {
        container.innerHTML = '';
        if (emptyPlaceholder) {
          emptyPlaceholder.classList.remove('d-none');
        }
        return;
      }
      container.innerHTML = scopedItems
        .map((item) => renderPartnerContactCard(item, { mode: 'summary' }))
        .join('');
      container
        .querySelectorAll('[data-partner-contact-comm-field="value"][data-comm-type="phone"]')
        .forEach((input) => updatePhoneInputFormatting(input));
      container
        .querySelectorAll('[data-partner-contact-comm-field="value"][data-comm-type="email"]')
        .forEach((input) => validateEmailInput(input));
      container
        .querySelectorAll('[data-partner-contact-person-field="phone"]')
        .forEach((input) => updatePhoneInputFormatting(input));
      container
        .querySelectorAll('[data-partner-contact-person-field="email"]')
        .forEach((input) => validateEmailInput(input));
      if (emptyPlaceholder) {
        emptyPlaceholder.classList.add('d-none');
      }
    });
    if (partnerContactEditorState && partnerContactEditorState.key) {
      const key = partnerContactEditorState.key;
      setPartnerContactCardVisibility(key, false);
      const rendered = renderPartnerContactModalContentByKey(key);
      if (!rendered && partnerContactEditorModal) {
        partnerContactEditorModal.hide();
      } else {
        updatePartnerContactEditorTitleByKey(key);
      }
    }
  }

  function addPartnerContactDraft(initial = {}) {
    partnerContactDraftCounter += 1;
    const servedEntities = Array.isArray(initial.served_legal_entities) && initial.served_legal_entities.length
      ? clonePartnerContactServedEntities(initial.served_legal_entities)
      : [];
    let servedId = Number.isFinite(initial.served_legal_entity_id)
      ? initial.served_legal_entity_id
      : Number.parseInt(initial.served_legal_entity_id, 10);
    servedId = Number.isFinite(servedId) && servedId > 0 ? servedId : null;
    let servedName = typeof initial.served_legal_entity_name === 'string' ? initial.served_legal_entity_name : '';
    if (!servedEntities.length && Number.isFinite(servedId)) {
      servedEntities.push({ id: servedId, name: servedName });
    }
    if (servedEntities.length) {
      const first = servedEntities[0];
      if (first) {
        if (!Number.isFinite(servedId) || servedId <= 0) {
          servedId = Number.isFinite(first.id) ? first.id : servedId;
        }
        if (!servedName && first && typeof first.name === 'string') {
          servedName = first.name;
        }
      }
    }
    const draft = {
      draftId: `draft-${partnerContactDraftCounter}`,
      isDraft: true,
      value: typeof initial.value === 'string' ? initial.value : '',
      state: PARAMETER_STATES[0],
      contact_type: initial.contact_type && Object.prototype.hasOwnProperty.call(PARTNER_CONTACT_TYPES, initial.contact_type)
        ? initial.contact_type
        : 'partner',
      phones: Array.isArray(initial.phones) && initial.phones.length
        ? clonePartnerContactCommList(initial.phones)
        : [],
      emails: Array.isArray(initial.emails) && initial.emails.length
        ? clonePartnerContactCommList(initial.emails)
        : [],
      contacts: Array.isArray(initial.contacts) && initial.contacts.length
        ? clonePartnerContactPeople(initial.contacts)
        : [createBlankPartnerContactPersonEntry()],
      served_legal_entities: servedEntities,
      served_legal_entity_id: Number.isFinite(servedId) ? servedId : null,
      served_legal_entity_name: typeof servedName === 'string' ? servedName : '',
      legal_entity: typeof initial.legal_entity === 'string' ? initial.legal_entity : '',
      internal_name: typeof initial.internal_name === 'string' ? initial.internal_name : '',
      inn: typeof initial.inn === 'string' ? extractDigits(initial.inn) || initial.inn : '',
      is_deleted: false,
      usage_count: 0,
    };
    partnerContactDrafts.push(draft);
    renderPartnerContacts();
    const key = getPartnerContactItemKey(draft);
    if (partnerContactEditorModal && key) {
      setTimeout(() => {
        const card = findPartnerContactCardByKey(key);
        if (card) {
          openPartnerContactEditor(card);
        }
      }, 0);
    }
  }

  function removePartnerContactDraft(draftId) {
    const index = partnerContactDrafts.findIndex((draft) => draft.draftId === draftId);
    if (index === -1) return;
    const [removed] = partnerContactDrafts.splice(index, 1);
    if (removed) {
      const key = getPartnerContactItemKey(removed);
      if (key) {
        partnerContactDetailsState.delete(key);
      }
    }
    renderPartnerContacts();
  }

  function updatePartnerContactDraftValue(draftId, field, value) {
    const draft = partnerContactDrafts.find((item) => item.draftId === draftId);
    if (!draft) return;
    if (field === 'value') {
      draft.value = value;
      draft.legal_entity = value;
    } else if (field === 'internal_name') {
      draft.internal_name = value;
    } else if (field === 'inn') {
      const digits = extractDigits(value);
      draft.inn = digits || (typeof value === 'string' ? value.trim() : '');
    } else if (field === 'state') {
      draft.state = PARAMETER_STATES.includes(value) ? value : draft.state;
    } else if (field === 'contact_type') {
      draft.contact_type = Object.prototype.hasOwnProperty.call(PARTNER_CONTACT_TYPES, value) ? value : 'partner';
      if (draft.contact_type !== 'ka') {
        draft.served_legal_entity_id = null;
        draft.served_legal_entity_name = '';
        draft.served_legal_entities = [];
      }
    } else if (field === 'served_legal_entities') {
      const list = Array.isArray(value) ? value : [];
      const normalized = clonePartnerContactServedEntities(list);
      draft.served_legal_entities = normalized;
      const first = normalized[0];
      draft.served_legal_entity_id = first ? first.id : null;
      draft.served_legal_entity_name = first ? first.name : '';
    } else if (field === 'served_legal_entity_id') {
      draft.served_legal_entity_id = value;
    } else if (field === 'served_legal_entity_name') {
      draft.served_legal_entity_name = value;
    }
  }

  function updatePartnerContactDraftComm(draftId, kind, entryKey, field, value) {
    const draft = partnerContactDrafts.find((item) => item.draftId === draftId);
    if (!draft) return;
    const list = kind === 'phone' ? draft.phones : draft.emails;
    if (!Array.isArray(list)) return;
    const entry = list.find((item) => item.key === entryKey);
    if (!entry) return;
    if (field === 'type') {
      const allowed = kind === 'phone' ? PARTNER_CONTACT_PHONE_TYPES : PARTNER_CONTACT_EMAIL_TYPES;
      entry.type = Object.prototype.hasOwnProperty.call(allowed, value) ? value : entry.type;
    } else if (field === 'value') {
      entry.value = kind === 'phone' ? extractDigits(value) : value;
    } else if (field === 'extension' && kind === 'phone') {
      entry.extension = extractDigits(value);
    }
  }

  function modifyPartnerContactDraftComm(draftId, kind, action, entryKey) {
    const draft = partnerContactDrafts.find((item) => item.draftId === draftId);
    if (!draft) return;
    const list = kind === 'phone' ? draft.phones : draft.emails;
    if (!Array.isArray(list)) return;
    if (action === 'add') {
      list.push(createBlankPartnerContactCommEntry(kind));
    } else if (action === 'remove') {
      const index = list.findIndex((item) => item.key === entryKey);
      if (index !== -1) {
        list.splice(index, 1);
      }
    }
  }

  function updatePartnerContactEditField(id, field, value) {
    const edit = ensurePartnerContactEdit(id);
    if (!edit) return;
    if (field === 'value') {
      edit.value = value;
      edit.legal_entity = value;
    } else if (field === 'internal_name') {
      edit.internal_name = value;
    } else if (field === 'inn') {
      const digits = extractDigits(value);
      edit.inn = digits || (typeof value === 'string' ? value.trim() : '');
    } else if (field === 'state') {
      edit.state = PARAMETER_STATES.includes(value) ? value : edit.state;
    } else if (field === 'contact_type') {
      edit.contact_type = Object.prototype.hasOwnProperty.call(PARTNER_CONTACT_TYPES, value) ? value : edit.contact_type;
      if (edit.contact_type !== 'ka') {
        edit.served_legal_entity_id = null;
        edit.served_legal_entity_name = '';
        edit.served_legal_entities = [];
      }
    } else if (field === 'served_legal_entities') {
      const list = Array.isArray(value) ? value : [];
      const normalized = clonePartnerContactServedEntities(list);
      edit.served_legal_entities = normalized;
      const first = normalized[0];
      edit.served_legal_entity_id = first ? first.id : null;
      edit.served_legal_entity_name = first ? first.name : '';
    } else if (field === 'served_legal_entity_id') {
      edit.served_legal_entity_id = value;
    } else if (field === 'served_legal_entity_name') {
      edit.served_legal_entity_name = value;
    }
  }

  function updatePartnerContactEditComm(id, kind, entryKey, field, value) {
    const edit = ensurePartnerContactEdit(id);
    if (!edit) return;
    const list = kind === 'phone' ? edit.phones : edit.emails;
    if (!Array.isArray(list)) return;
    const entry = list.find((item) => item.key === entryKey);
    if (!entry) return;
    if (field === 'type') {
      const allowed = kind === 'phone' ? PARTNER_CONTACT_PHONE_TYPES : PARTNER_CONTACT_EMAIL_TYPES;
      entry.type = Object.prototype.hasOwnProperty.call(allowed, value) ? value : entry.type;
    } else if (field === 'value') {
      entry.value = kind === 'phone' ? extractDigits(value) : value;
    } else if (field === 'extension' && kind === 'phone') {
      entry.extension = extractDigits(value);
    }
  }

  function modifyPartnerContactEditComm(id, kind, action, entryKey) {
    const edit = ensurePartnerContactEdit(id);
    if (!edit) return;
    const list = kind === 'phone' ? edit.phones : edit.emails;
    if (!Array.isArray(list)) return;
    if (action === 'add') {
      list.push(createBlankPartnerContactCommEntry(kind));
    } else if (action === 'remove') {
      const index = list.findIndex((item) => item.key === entryKey);
      if (index !== -1) {
        list.splice(index, 1);
      }
    }
  }

  function updatePartnerContactDraftPerson(draftId, personKey, field, value) {
    const draft = partnerContactDrafts.find((item) => item.draftId === draftId);
    if (!draft || !Array.isArray(draft.contacts)) return;
    const person = draft.contacts.find((entry) => entry.key === personKey);
    if (!person) return;
    if (field === 'full_name' || field === 'position') {
      person[field] = value;
    } else if (field === 'phone') {
      person.phone = value;
    } else if (field === 'email') {
      person.email = value;
    } else if (field === 'is_top') {
      person.is_top = Boolean(value);
    }
  }

  function updatePartnerContactEditPerson(id, personKey, field, value) {
    const edit = ensurePartnerContactEdit(id);
    if (!edit || !Array.isArray(edit.contacts)) return;
    const person = edit.contacts.find((entry) => entry.key === personKey);
    if (!person) return;
    if (field === 'full_name' || field === 'position') {
      person[field] = value;
    } else if (field === 'phone') {
      person.phone = value;
    } else if (field === 'email') {
      person.email = value;
    } else if (field === 'is_top') {
      person.is_top = Boolean(value);
    }
  }

  function modifyPartnerContactDraftPerson(draftId, action, personKey) {
    const draft = partnerContactDrafts.find((item) => item.draftId === draftId);
    if (!draft) return;
    if (!Array.isArray(draft.contacts)) {
      draft.contacts = [];
    }
    if (action === 'add') {
      draft.contacts.unshift(createBlankPartnerContactPersonEntry());
    } else if (action === 'remove') {
      const index = draft.contacts.findIndex((entry) => entry.key === personKey);
      if (index !== -1) {
        draft.contacts.splice(index, 1);
      }
    }
  }

  function modifyPartnerContactEditPerson(id, action, personKey) {
    const edit = ensurePartnerContactEdit(id);
    if (!edit) return;
    if (!Array.isArray(edit.contacts)) {
      edit.contacts = [];
    }
    if (action === 'add') {
      edit.contacts.unshift(createBlankPartnerContactPersonEntry());
    } else if (action === 'remove') {
      const index = edit.contacts.findIndex((entry) => entry.key === personKey);
      if (index !== -1) {
        edit.contacts.splice(index, 1);
      }
    }
  }

  function resetPartnerContactEdit(id) {
    if (!Number.isFinite(id)) return;
    if (!partnerContactEdits.has(id)) return;
    partnerContactEdits.delete(id);
    renderPartnerContacts();
  }

  function getPartnerContactCardData(card) {
    if (!card || !card.dataset.partnerContactCard) return null;
    if (card.dataset.partnerContactDraft === 'true') {
      const draftId = card.dataset.partnerContactDraftId;
      const draft = partnerContactDrafts.find((item) => item.draftId === draftId);
      return draft ? clonePartnerContactItem(draft) : null;
    }
    const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
    if (!Number.isFinite(id)) return null;
    const edit = ensurePartnerContactEdit(id);
    return edit ? clonePartnerContactItem(edit) : null;
  }

  function sanitizePartnerContactPayload(data) {
    const result = { contact_type: data.contact_type };
    result.value = typeof data.value === 'string' ? data.value.trim() : '';
    result.state = typeof data.state === 'string' ? data.state : PARAMETER_STATES[0];
    result.inn = extractDigits(data.inn) || (typeof data.inn === 'string' ? data.inn.trim() : '');
    const fallbackPhoneType = Object.keys(PARTNER_CONTACT_PHONE_TYPES)[0] || 'work';
    result.phones = Array.isArray(data.phones)
      ? data.phones
          .map((item) => {
            const valueDigits = extractDigits(item && item.value);
            const extensionDigits = extractDigits(item && item.extension);
            const typeKey = item && item.type;
            const type = Object.prototype.hasOwnProperty.call(PARTNER_CONTACT_PHONE_TYPES, typeKey)
              ? typeKey
              : fallbackPhoneType;
            return {
              type,
              value: valueDigits,
              extension: extensionDigits,
            };
          })
          .filter((item) => item.value)
      : [];
    const fallbackEmailType = Object.keys(PARTNER_CONTACT_EMAIL_TYPES)[0] || 'work';
    result.emails = Array.isArray(data.emails)
      ? data.emails
          .map((item) => {
            const typeKey = item && item.type;
            const type = Object.prototype.hasOwnProperty.call(PARTNER_CONTACT_EMAIL_TYPES, typeKey)
              ? typeKey
              : fallbackEmailType;
            return {
              type,
              value: typeof item.value === 'string' ? item.value.trim() : '',
            };
          })
          .filter((item) => item.value)
      : [];
    result.contacts = Array.isArray(data.contacts)
      ? data.contacts
          .map((person) => ({
            full_name: typeof person.full_name === 'string' ? person.full_name.trim() : '',
            position: typeof person.position === 'string' ? person.position.trim() : '',
            phone: typeof person.phone === 'string' ? person.phone.trim() : '',
            email: typeof person.email === 'string' ? person.email.trim() : '',
            is_top: Boolean(person.is_top),
          }))
          .filter((person) => person.full_name || person.position || person.phone || person.email)
      : [];
    if (!result.phones.length && Array.isArray(result.contacts)) {
      result.contacts.forEach((person) => {
        const digits = extractDigits(person.phone);
        if (digits) {
          result.phones.push({ type: fallbackPhoneType, value: digits, extension: '' });
        }
      });
    }
    if (!result.emails.length && Array.isArray(result.contacts)) {
      result.contacts.forEach((person) => {
        if (person.email) {
          result.emails.push({ type: fallbackEmailType, value: person.email });
        }
      });
    }
    result.internal_name = typeof data.internal_name === 'string' ? data.internal_name.trim() : '';
    const servedEntities = Array.isArray(data.served_legal_entities)
      ? data.served_legal_entities
          .map((entry) => {
            if (!entry || typeof entry !== 'object') return null;
            const id = Number.isFinite(entry.id) ? entry.id : Number.parseInt(entry.id, 10);
            if (!Number.isFinite(id) || id <= 0) return null;
            const name = typeof entry.name === 'string' ? entry.name.trim() : '';
            return { id, name };
          })
          .filter((entry) => entry)
      : [];
    result.served_legal_entities = servedEntities;
    result.served_legal_entity_ids = servedEntities.map((entry) => entry.id);
    result.served_legal_entity_names = servedEntities.map((entry) => entry.name).filter((name) => name);
    const explicitServedId = Number.isFinite(data.served_legal_entity_id)
      ? data.served_legal_entity_id
      : Number.parseInt(data.served_legal_entity_id, 10);
    const fallbackServed = servedEntities[0];
    const normalizedServedId = Number.isFinite(explicitServedId) && explicitServedId > 0
      ? explicitServedId
      : fallbackServed
        ? fallbackServed.id
        : null;
    const explicitServedName = typeof data.served_legal_entity_name === 'string' ? data.served_legal_entity_name : '';
    const normalizedServedName = fallbackServed ? fallbackServed.name : explicitServedName;
    result.served_legal_entity_id = Number.isFinite(normalizedServedId) ? normalizedServedId : null;
    result.served_legal_entity_name = normalizedServedName || '';
    return result;
  }

  async function handlePartnerContactSave(card, trigger) {
    const isDraft = card && card.dataset.partnerContactDraft === 'true';
    const data = getPartnerContactCardData(card);
    if (!data) {
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞');
      return;
    }
    const payload = sanitizePartnerContactPayload(data);
    if (!payload.value) {
      alert('–ü–æ–ª–µ ¬´–Æ–õ¬ª –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
      return;
    }
    const servedIds = Array.isArray(payload.served_legal_entity_ids) ? payload.served_legal_entity_ids : [];
    if (payload.contact_type === 'ka' && !servedIds.length) {
      alert('–î–ª—è —Ç–∏–ø–∞ ¬´–ö–ê¬ª –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –æ–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–±—Å–ª—É–∂–∏–≤–∞–µ–º—ã—Ö –Æ–õ');
      return;
    }
    const invalidEmail = Array.isArray(payload.emails)
      ? payload.emails.find((item) => item && item.value && !EMAIL_VALIDATION_REGEX.test(item.value))
      : null;
    if (invalidEmail) {
      alert('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ e-mail: –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —Å–∏–º–≤–æ–ª @ –∏ –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è.');
      return;
    }

    const originalText = trigger.textContent;
    trigger.disabled = true;
    trigger.textContent = '...';

    try {
      let response;
      if (isDraft) {
        const requestPayload = Object.assign({
          param_type: 'partner_contact',
          value: payload.value,
          state: payload.state,
        }, payload);
        response = await fetch('/api/settings/parameters', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestPayload),
        });
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (!Number.isFinite(id)) {
          throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–∞');
        }
        const requestPayload = {
          value: payload.value,
          contact_type: payload.contact_type,
          phones: payload.phones,
          emails: payload.emails,
          contacts: payload.contacts,
          internal_name: payload.internal_name,
          inn: payload.inn,
          served_legal_entities: payload.served_legal_entities,
          served_legal_entity_ids: payload.served_legal_entity_ids,
          served_legal_entity_names: payload.served_legal_entity_names,
          served_legal_entity_id: payload.served_legal_entity_id,
          served_legal_entity_name: payload.served_legal_entity_name,
          state: payload.state,
        };
        response = await fetch(`/api/settings/parameters/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestPayload),
        });
      }
      const result = await response.json();
      if (!response.ok || result.success === false) {
        throw new Error(result.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞');
      }
      if (isDraft) {
        const draftId = card.dataset.partnerContactDraftId;
        if (draftId) {
          const index = partnerContactDrafts.findIndex((item) => item.draftId === draftId);
          if (index !== -1) {
            partnerContactDrafts.splice(index, 1);
          }
        }
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          partnerContactEdits.delete(id);
        }
      }
      syncParameterData((result && result.data) || parameterData);
      renderParameters({ forceBodies: true });
      if (partnerContactEditorModal && partnerContactEditorModalEl && partnerContactEditorModalEl.contains(card)) {
        partnerContactEditorModal.hide();
      }
    } catch (error) {
      const message = error && error.message ? error.message : error;
      alert('‚ùå ' + message);
    } finally {
      trigger.disabled = false;
      trigger.textContent = originalText;
    }
  }

  function renderParameterCard(type, { forceBody = false } = {}) {
    const card = document.querySelector(`.parameter-card[data-param-type="${type}"]`);
    if (!card) return;
    const items = Array.isArray(parameterData[type]) ? parameterData[type] : [];
    const counter = card.querySelector('[data-param-count]');
    if (counter) {
      counter.textContent = items.length;
    }
    const hasMany = items.length > 10;
    card.dataset.hasMany = hasMany ? 'true' : 'false';
    const hint = card.querySelector('[data-param-hint]');
    if (hint) {
      hint.classList.toggle('d-none', !hasMany);
    }
    const body = card.querySelector('[data-param-body]');
    if (!body) return;
    if (hasMany) {
      card.classList.remove('is-expanded');
      body.classList.add('d-none');
      body.innerHTML = '';
      return;
    }
    if (!card.classList.contains('is-expanded')) {
      body.classList.add('d-none');
      body.innerHTML = '';
      return;
    }
    body.classList.remove('d-none');
    if (forceBody || !body.innerHTML.trim()) {
      body.innerHTML = buildParameterContent(type, items, 'card');
    }
    refreshParameterDependencyControls(body, type);
  }

  function renderParameters({ forceBodies = false } = {}) {
    Object.keys(PARAMETER_TITLES).forEach((type) => {
      renderParameterCard(type, { forceBody: forceBodies });
    });
    renderRemoteAccessSection();
    renderPartnerContacts();
    renderLegalEntities();
  }

  function buildCityModalContent() {
    const items = Array.isArray(parameterData[CITY_PARAMETER_TYPE]) ? parameterData[CITY_PARAMETER_TYPE] : [];
    if (items.length) {
      return buildParameterContent(CITY_PARAMETER_TYPE, items, 'modal');
    }
    if (!CITY_OPTIONS.length) {
      return '<div class="empty-placeholder">–ü–æ–∫–∞ –Ω–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–π</div>';
    }
    const listItems = CITY_OPTIONS.map((city) => `<li class="list-group-item py-1 px-2">${escapeHtml(city)}</li>`).join('');
    return `
      <div data-param-container data-param-type="${CITY_PARAMETER_TYPE}">
        <div class="param-items">
          <ul class="list-group list-group-flush">${listItems}</ul>
        </div>
      </div>
    `;
  }

  function renderParameterModal(type) {
    if (!parameterModalEl) return;
    const body = parameterModalEl.querySelector('[data-param-modal-body]');
    if (!body) return;
    if (type === CITY_PARAMETER_TYPE) {
      body.innerHTML = buildCityModalContent();
      refreshParameterDependencyControls(body, type);
      return;
    }
    const items = Array.isArray(parameterData[type]) ? parameterData[type] : [];
    body.innerHTML = buildParameterContent(type, items, 'modal');
    refreshParameterDependencyControls(body, type);
  }

  function renderCityCard() {
    if (!cityCardEl) return;
    const parameterCities = Array.isArray(parameterData[CITY_PARAMETER_TYPE])
      ? parameterData[CITY_PARAMETER_TYPE]
          .map((item) => (item && typeof item.value === 'string' ? item.value.trim() : ''))
          .filter((name) => name)
      : [];
    const sourceCities = parameterCities.length ? parameterCities : (Array.isArray(CITY_OPTIONS) ? CITY_OPTIONS : []);
    const uniqueCities = Array.from(new Set(sourceCities.map((city) => city.trim()))).filter((city) => city);
    uniqueCities.sort((a, b) => a.localeCompare(b));
    const count = uniqueCities.length;
    cityCardEl.dataset.cityCount = String(count);
    const body = cityCardEl.querySelector('[data-city-body]');
    const hint = cityCardEl.querySelector('[data-city-hint]');
    const counter = cityCardEl.querySelector('.badge');
    if (counter) {
      counter.textContent = String(count);
    }
    const listContainer = cityCardEl.querySelector('[data-city-list]');
    if (listContainer) {
      if (count) {
        const items = uniqueCities.map((city) => `<li class="list-group-item py-1 px-2">${escapeHtml(city)}</li>`).join('');
        listContainer.innerHTML = `<ul class="list-group list-group-flush">${items}</ul>`;
      } else {
        listContainer.innerHTML = '<div class="empty-placeholder">–ü–æ–∫–∞ –Ω–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–π</div>';
      }
    }
    if (body) {
      body.classList.toggle('d-none', count > 10);
    }
    if (hint) {
      hint.classList.toggle('d-none', !(count > 10));
    }
  }

  function openParameterModal(type) {
    if (!parameterModal) return;
    parameterModalType = type;
    const titleEl = parameterModalEl.querySelector('[data-param-modal-title]');
    if (titleEl) {
      const label =
        PARAMETER_TITLES[type] || (type === CITY_PARAMETER_TYPE ? CITY_PARAMETER_LABEL : '–ó–Ω–∞—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞');
      titleEl.textContent = `–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ ‚Ä¢ ${label}`;
    }
    renderParameterModal(type);
    parameterModal.show();
  }

  renderParameters();

  if (parameterModalEl) {
    parameterModalEl.addEventListener('hidden.bs.modal', () => {
      parameterModalType = null;
    });
  }

  if (legalEntitiesModalEl) {
    legalEntitiesModalEl.addEventListener('show.bs.modal', () => {
      renderLegalEntities();
    });
    legalEntitiesModalEl.addEventListener('hidden.bs.modal', () => {
      legalEntityDrafts = [];
      legalEntityDraftCounter = 0;
      renderLegalEntities();
    });
  }

  if (parametersModalEl) {
    parametersModalEl.addEventListener('show.bs.modal', () => {
      renderPartnerContacts();
    });
    parametersModalEl.addEventListener('hidden.bs.modal', () => {
      partnerContactDrafts = [];
      partnerContactDraftCounter = 0;
      partnerContactEdits.clear();
      partnerContactDetailsState.clear();
      renderPartnerContacts();
    });
  }

  if (partnerContactEditorModalEl) {
    partnerContactEditorModalEl.addEventListener('hidden.bs.modal', () => {
      if (partnerContactEditorState && partnerContactEditorState.key) {
        const key = partnerContactEditorState.key;
        if (key.startsWith('draft:')) {
          const draftId = key.slice('draft:'.length);
          const exists = partnerContactDrafts.some((draft) => draft.draftId === draftId);
          if (exists) {
            removePartnerContactDraft(draftId);
          }
        } else {
          setPartnerContactCardVisibility(key, true);
        }
      }
      if (partnerContactEditorBody) {
        partnerContactEditorBody.innerHTML =
          '<div class="text-center text-muted py-5">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.</div>';
      }
      clearPartnerContactEditorActions();
      partnerContactEditorState = null;
      renderPartnerContacts();
    });
  }

  function findParameterContainer(element) {
    return element ? element.closest('[data-param-container]') : null;
  }

  document.addEventListener('click', (event) => {
    const partnerContactOpenModalBtn = event.target.closest('[data-partner-contact-open-modal]');
    if (partnerContactOpenModalBtn) {
      const card = partnerContactOpenModalBtn.closest('[data-partner-contact-card]');
      if (!card) return;
      openPartnerContactEditor(card);
      event.preventDefault();
      return;
    }
    const detailsToggleBtn = event.target.closest('[data-partner-contact-details-toggle]');
    if (detailsToggleBtn) {
      const container = detailsToggleBtn.closest('[data-partner-contact-details]');
      if (!container) return;
      let key = container.dataset.detailsKey;
      if (!key) {
        const card = container.closest('[data-partner-contact-card]');
        key = getPartnerContactCardKey(card);
      }
      const isCollapsed = container.classList.contains('is-collapsed');
      if (isCollapsed) {
        container.classList.remove('is-collapsed');
        container.classList.add('is-expanded');
        detailsToggleBtn.setAttribute('aria-expanded', 'true');
        if (key) {
          partnerContactDetailsState.set(key, 'expanded');
        }
      } else {
        container.classList.add('is-collapsed');
        container.classList.remove('is-expanded');
        detailsToggleBtn.setAttribute('aria-expanded', 'false');
        if (key) {
          partnerContactDetailsState.set(key, 'collapsed');
        }
      }
      event.preventDefault();
      return;
    }
    const peopleToggleBtn = event.target.closest('[data-partner-contact-people-toggle]');
    if (peopleToggleBtn) {
      const wrapper = peopleToggleBtn.closest('[data-partner-contact-people-wrapper]');
      if (!wrapper) return;
      const hiddenContainer = wrapper.querySelector('[data-partner-contact-people-extra]');
      if (!hiddenContainer) return;
      const isHidden = hiddenContainer.classList.contains('d-none');
      if (isHidden) {
        hiddenContainer.classList.remove('d-none');
        peopleToggleBtn.setAttribute('aria-expanded', 'true');
        const expandedText = peopleToggleBtn.dataset.expandedText;
        if (expandedText) {
          peopleToggleBtn.textContent = expandedText;
        }
      } else {
        hiddenContainer.classList.add('d-none');
        peopleToggleBtn.setAttribute('aria-expanded', 'false');
        const collapsedText = peopleToggleBtn.dataset.collapsedText;
        if (collapsedText) {
          peopleToggleBtn.textContent = collapsedText;
        }
      }
      return;
    }
    const partnerContactAddBtn = event.target.closest('[data-partner-contact-add]');
    if (partnerContactAddBtn) {
      const scope = partnerContactAddBtn.dataset.partnerContactAdd;
      const initial = {};
      if (scope) {
        initial.contact_type = scope;
      }
      addPartnerContactDraft(initial);
      return;
    }
    const partnerContactActionBtn = event.target.closest('[data-partner-contact-action]');
    if (partnerContactActionBtn) {
      let card = partnerContactActionBtn.closest('[data-partner-contact-card]');
      if (!card) {
        const targetKey = partnerContactActionBtn.dataset.partnerContactActionTarget;
        if (targetKey) {
          if (partnerContactEditorBody) {
            const selector = `[data-partner-contact-card][data-partner-contact-key="${cssEscape(targetKey)}"]`;
            card = partnerContactEditorBody.querySelector(selector);
          }
          if (!card) {
            card = findPartnerContactCardByKey(targetKey);
          }
        }
      }
      if (!card) return;
      const action = partnerContactActionBtn.dataset.partnerContactAction;
      if (action === 'save') {
        handlePartnerContactSave(card, partnerContactActionBtn);
      } else if (action === 'cancel') {
        const draftId = card.dataset.partnerContactDraftId;
        if (draftId) {
          removePartnerContactDraft(draftId);
        }
      } else if (action === 'reset') {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          resetPartnerContactEdit(id);
        }
      } else if (action === 'delete') {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          deleteParameter(id, 'partner_contact', partnerContactActionBtn);
        }
      } else if (action === 'restore') {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          restoreParameter(id, 'partner_contact', partnerContactActionBtn);
        }
      }
      return;
    }
    const partnerContactAddCommBtn = event.target.closest('[data-partner-contact-add-comm]');
    if (partnerContactAddCommBtn) {
      const card = partnerContactAddCommBtn.closest('[data-partner-contact-card]');
      if (!card) return;
      const kind = partnerContactAddCommBtn.dataset.commType;
      if (!kind) return;
      if (card.dataset.partnerContactDraft === 'true') {
        modifyPartnerContactDraftComm(card.dataset.partnerContactDraftId, kind, 'add');
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          modifyPartnerContactEditComm(id, kind, 'add');
        }
      }
      renderPartnerContacts();
      return;
    }
    const partnerContactAddPersonBtn = event.target.closest('[data-partner-contact-add-person]');
    if (partnerContactAddPersonBtn) {
      const card = partnerContactAddPersonBtn.closest('[data-partner-contact-card]');
      if (!card) return;
      if (card.dataset.partnerContactDraft === 'true') {
        modifyPartnerContactDraftPerson(card.dataset.partnerContactDraftId, 'add');
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          modifyPartnerContactEditPerson(id, 'add');
        }
      }
      renderPartnerContacts();
      return;
    }
    const partnerContactRemovePersonBtn = event.target.closest('[data-partner-contact-remove-person]');
    if (partnerContactRemovePersonBtn) {
      const card = partnerContactRemovePersonBtn.closest('[data-partner-contact-card]');
      if (!card) return;
      const personKey = partnerContactRemovePersonBtn.dataset.personKey;
      if (!personKey) return;
      if (card.dataset.partnerContactDraft === 'true') {
        modifyPartnerContactDraftPerson(card.dataset.partnerContactDraftId, 'remove', personKey);
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          modifyPartnerContactEditPerson(id, 'remove', personKey);
        }
      }
      renderPartnerContacts();
      return;
    }
    const partnerContactRemoveCommBtn = event.target.closest('[data-partner-contact-remove-comm]');
    if (partnerContactRemoveCommBtn) {
      const card = partnerContactRemoveCommBtn.closest('[data-partner-contact-card]');
      if (!card) return;
      const kind = partnerContactRemoveCommBtn.dataset.commType;
      const entryKey = partnerContactRemoveCommBtn.dataset.entryKey;
      if (!kind || !entryKey) return;
      if (card.dataset.partnerContactDraft === 'true') {
        modifyPartnerContactDraftComm(card.dataset.partnerContactDraftId, kind, 'remove', entryKey);
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          modifyPartnerContactEditComm(id, kind, 'remove', entryKey);
        }
      }
      renderPartnerContacts();
      return;
    }
    const legalEntityAddBtn = event.target.closest('[data-legal-entity-add]');
    if (legalEntityAddBtn) {
      addLegalEntityDraft();
      return;
    }
    const legalEntityAction = event.target.closest('[data-legal-entity-action]');
    if (legalEntityAction) {
      const card = legalEntityAction.closest('[data-legal-entity-card]');
      if (!card) return;
      const action = legalEntityAction.dataset.legalEntityAction;
      if (action === 'save') {
        handleLegalEntitySave(card, legalEntityAction);
      } else if (action === 'delete') {
        const id = Number.parseInt(card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          deleteParameter(id, 'legal_entity', legalEntityAction);
        }
      } else if (action === 'restore') {
        const id = Number.parseInt(card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          restoreParameter(id, 'legal_entity', legalEntityAction);
        }
      } else if (action === 'cancel') {
        const draftId = card.dataset.legalEntityDraftId;
        if (draftId) {
          removeLegalEntityDraft(draftId);
        }
      }
      return;
    }
    const cityToggle = event.target.closest('[data-city-toggle]');
    if (cityToggle) {
      if (Array.isArray(CITY_OPTIONS) && CITY_OPTIONS.length > 10) {
        openParameterModal(CITY_PARAMETER_TYPE);
      }
      return;
    }
    const toggleBtn = event.target.closest('[data-param-toggle]');
    if (toggleBtn) {
      const card = toggleBtn.closest('.parameter-card');
      if (!card) return;
      const type = card.dataset.paramType;
      if (!type) return;
      if (card.dataset.hasMany === 'true') {
        openParameterModal(type);
        return;
      }
      card.classList.toggle('is-expanded');
      renderParameterCard(type, { forceBody: true });
      return;
    }
    const actionEl = event.target.closest('[data-param-action]');
    if (!actionEl) return;
    const action = actionEl.dataset.paramAction;
    const containerWithType = actionEl.closest('[data-param-type]');
    const type = actionEl.dataset.paramType || (containerWithType ? containerWithType.dataset.paramType : null);
    if (!action || !type) return;
    if (action === 'create') {
      createParameter(type, actionEl);
      return;
    }
    const entry = actionEl.closest('[data-param-id]');
    if (!entry) return;
    const id = Number.parseInt(entry.dataset.paramId, 10);
    if (!Number.isFinite(id)) return;
    if (action === 'save') {
      updateParameterValue(id, type, actionEl);
    } else if (action === 'delete') {
      deleteParameter(id, type, actionEl);
    } else if (action === 'restore') {
      restoreParameter(id, type, actionEl);
    }
  });

  document.addEventListener('keydown', (event) => {
    if (event.key !== 'Enter' && event.key !== ' ') return;
    const openTarget = event.target.closest('[data-partner-contact-open-modal]');
    if (!openTarget) return;
    if (openTarget.getAttribute('role') !== 'button') return;
    const card = openTarget.closest('[data-partner-contact-card]');
    if (!card) return;
    event.preventDefault();
    openPartnerContactEditor(card);
  });

  document.addEventListener('change', (event) => {
    const dependencySelect = event.target.closest('[data-param-dependency-field]');
    if (dependencySelect) {
      const group = dependencySelect.closest('[data-param-dependency-group]');
      const type = group ? group.dataset.paramType || dependencySelect.dataset.paramType : dependencySelect.dataset.paramType;
      if (type) {
        dependencySelect.dataset.paramDependencyValue = normalizeDependencyValue(dependencySelect.value);
        const targetGroup = group
          || dependencySelect.closest('[data-param-dependency-group]')
          || dependencySelect.closest('[data-param-type]');
        if (targetGroup) {
          refreshDependencySelectGroup(targetGroup, type);
        }
      }
      return;
    }
    const stateSelect = event.target.closest('[data-param-field="state"]');
    if (!stateSelect) return;
    const entry = stateSelect.closest('[data-param-id]');
    if (!entry) return;
    const id = Number.parseInt(entry.dataset.paramId, 10);
    const type = entry.dataset.paramType;
    if (!Number.isFinite(id) || !type) return;
    updateParameterState(id, type, stateSelect);
  });

  if (legalEntitiesContainer) {
    legalEntitiesContainer.addEventListener('input', (event) => {
      const field = event.target.dataset.legalEntityField;
      if (!field) return;
      const card = event.target.closest('[data-legal-entity-card]');
      if (!card) return;
      if (field === 'value') {
        const title = card.querySelector('[data-legal-entity-title]');
        if (title) {
          const text = event.target.value.trim();
          title.textContent = text || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
        }
      }
      if (card.dataset.legalEntityDraft === 'true') {
        const draftId = card.dataset.legalEntityDraftId;
        if (draftId) {
          updateLegalEntityDraftValue(draftId, field, event.target.value);
        }
      }
    });
    legalEntitiesContainer.addEventListener('change', (event) => {
      const field = event.target.dataset.legalEntityField;
      if (!field) return;
      const card = event.target.closest('[data-legal-entity-card]');
      if (!card) return;
      if (field === 'state') {
        updateLegalEntityStateLabel(card, event.target.value);
      }
      if (card.dataset.legalEntityDraft === 'true') {
        const draftId = card.dataset.legalEntityDraftId;
        if (draftId) {
          updateLegalEntityDraftValue(draftId, field, event.target.value);
        }
      }
    });
  }

  document.addEventListener('input', (event) => {
    const card = event.target.closest('[data-partner-contact-card]');
    if (!card) return;
    const personField = event.target.dataset.partnerContactPersonField;
    if (personField) {
      const row = event.target.closest('[data-partner-contact-person]');
      if (!row) return;
      const personKey = row.dataset.partnerContactPerson;
      if (!personKey) return;
      let value;
      if (personField === 'is_top') {
        value = event.target.checked;
      } else {
        value = event.target.value;
      }
      if (personField === 'phone') {
        updatePhoneInputFormatting(event.target);
        value = event.target.dataset.phoneDigits || extractDigits(event.target.value);
      } else if (personField === 'email') {
        validateEmailInput(event.target);
        value = typeof event.target.value === 'string' ? event.target.value.trim() : '';
      }
      if (card.dataset.partnerContactDraft === 'true') {
        updatePartnerContactDraftPerson(card.dataset.partnerContactDraftId, personKey, personField, value);
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          updatePartnerContactEditPerson(id, personKey, personField, value);
        }
      }
      refreshPartnerContactPersonRow(row);
      return;
    }
    const field = event.target.dataset.partnerContactField;
    if (field === 'value' || field === 'internal_name' || field === 'inn') {
      let value = event.target.value;
      if (field === 'inn') {
        const digits = extractDigits(value);
        event.target.value = digits;
        value = digits;
      }
      if (card.dataset.partnerContactDraft === 'true') {
        updatePartnerContactDraftValue(card.dataset.partnerContactDraftId, field, value);
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          updatePartnerContactEditField(id, field, value);
        }
      }
      if (field === 'value' || field === 'internal_name') {
        refreshPartnerContactCardTitle(card);
      }
      return;
    }
    const commField = event.target.dataset.partnerContactCommField;
    if (commField === 'value' || commField === 'extension') {
      const kind = event.target.dataset.commType;
      const entryKey = event.target.dataset.entryKey;
      if (!kind || !entryKey) return;
      let value = event.target.value;
      if (kind === 'phone') {
        if (commField === 'value') {
          updatePhoneInputFormatting(event.target);
          value = event.target.dataset.phoneDigits || extractDigits(event.target.value);
        } else {
          enforceExtensionDigits(event.target);
          value = event.target.value;
        }
      } else if (kind === 'email' && commField === 'value') {
        validateEmailInput(event.target);
      }
      if (card.dataset.partnerContactDraft === 'true') {
        updatePartnerContactDraftComm(card.dataset.partnerContactDraftId, kind, entryKey, commField, value);
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          updatePartnerContactEditComm(id, kind, entryKey, commField, value);
        }
      }
      return;
    }
  });

  document.addEventListener('change', (event) => {
    const card = event.target.closest('[data-partner-contact-card]');
    if (!card) return;
    const personField = event.target.dataset.partnerContactPersonField;
    if (personField === 'is_top') {
      const row = event.target.closest('[data-partner-contact-person]');
      if (!row) return;
      const personKey = row.dataset.partnerContactPerson;
      if (!personKey) return;
      const value = event.target.checked;
      if (card.dataset.partnerContactDraft === 'true') {
        updatePartnerContactDraftPerson(card.dataset.partnerContactDraftId, personKey, personField, value);
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          updatePartnerContactEditPerson(id, personKey, personField, value);
        }
      }
      refreshPartnerContactPersonRow(row);
      return;
    }
    const field = event.target.dataset.partnerContactField;
    if (field === 'contact_type') {
      const value = event.target.value;
      if (card.dataset.partnerContactDraft === 'true') {
        updatePartnerContactDraftValue(card.dataset.partnerContactDraftId, field, value);
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          updatePartnerContactEditField(id, field, value);
        }
      }
      const wrapper = card.querySelector('[data-partner-contact-served-wrapper]');
      if (wrapper) {
        wrapper.classList.toggle('d-none', value !== 'ka');
        const select = wrapper.querySelector('[data-partner-contact-field="served_legal_entities"]');
        if (select && value !== 'ka') {
          Array.from(select.options).forEach((option) => {
            option.selected = false;
          });
        }
      }
      updatePartnerContactServedSummary(card);
      const data = getPartnerContactCardData(card);
      const subtitle = card.querySelector('[data-partner-contact-subtitle]');
      if (subtitle && data) {
        const typeLabel = PARTNER_CONTACT_TYPES[data.contact_type] || PARTNER_CONTACT_TYPES.partner;
        subtitle.textContent = `${typeLabel} ‚Ä¢ ${data.state || PARAMETER_STATES[0]}`;
      }
      updatePartnerContactCardHeaderState(card, data ? data.state || PARAMETER_STATES[0] : PARAMETER_STATES[0]);
      return;
    }
    if (field === 'state') {
      const stateValue = event.target.value;
      if (card.dataset.partnerContactDraft === 'true') {
        updatePartnerContactDraftValue(card.dataset.partnerContactDraftId, field, stateValue);
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          updatePartnerContactEditField(id, field, stateValue);
        }
      }
      const data = getPartnerContactCardData(card);
      const subtitle = card.querySelector('[data-partner-contact-subtitle]');
      if (subtitle && data) {
        const typeLabel = PARTNER_CONTACT_TYPES[data.contact_type] || PARTNER_CONTACT_TYPES.partner;
        subtitle.textContent = `${typeLabel} ‚Ä¢ ${data.state || PARAMETER_STATES[0]}`;
      }
      updatePartnerContactCardHeaderState(card, data ? data.state || stateValue : stateValue);
      return;
    }
    if (field === 'served_legal_entities') {
      const select = event.target;
      const selections = Array.from(select.selectedOptions)
        .map((option) => {
          const id = Number.parseInt(option.value, 10);
          if (!Number.isFinite(id) || id <= 0) return null;
          const label = option.dataset.label || option.textContent || '';
          return { id, name: label };
        })
        .filter((entry) => entry);
      if (card.dataset.partnerContactDraft === 'true') {
        updatePartnerContactDraftValue(card.dataset.partnerContactDraftId, 'served_legal_entities', selections);
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          updatePartnerContactEditField(id, 'served_legal_entities', selections);
        }
      }
      updatePartnerContactServedSummary(card, { served_legal_entities: selections });
      return;
    }
    if (field === 'served_legal_entity_id') {
      const select = event.target;
      const option = select.options[select.selectedIndex];
      const label = option ? option.dataset.label || option.textContent : '';
      const idValue = select.value ? Number.parseInt(select.value, 10) : null;
      if (card.dataset.partnerContactDraft === 'true') {
        updatePartnerContactDraftValue(card.dataset.partnerContactDraftId, field, Number.isFinite(idValue) ? idValue : null);
        updatePartnerContactDraftValue(card.dataset.partnerContactDraftId, 'served_legal_entity_name', label || '');
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          updatePartnerContactEditField(id, field, Number.isFinite(idValue) ? idValue : null);
          updatePartnerContactEditField(id, 'served_legal_entity_name', label || '');
        }
      }
      updatePartnerContactServedSummary(card);
      return;
    }
    const commField = event.target.dataset.partnerContactCommField;
    if (commField === 'type') {
      const kind = event.target.dataset.commType;
      const entryKey = event.target.dataset.entryKey;
      if (!kind || !entryKey) return;
      const value = event.target.value;
      if (card.dataset.partnerContactDraft === 'true') {
        updatePartnerContactDraftComm(card.dataset.partnerContactDraftId, kind, entryKey, commField, value);
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          updatePartnerContactEditComm(id, kind, entryKey, commField, value);
        }
      }
    }
  });


  const CITY_OPTIONS = (() => {
    const values = {{ cities | tojson }};
    if (!Array.isArray(values)) {
      return [];
    }
    const cleaned = values
      .map((value) => (typeof value === 'string' ? value.trim() : ''))
      .filter((value) => value);
    return Array.from(new Set(cleaned)).sort((a, b) => a.localeCompare(b));
  })();
  renderCityCard();
  const contractUsageData = {{ contract_usage | tojson }};
  const networkProfilesInitial = {{ settings.network_profiles | tojson }};

  function sanitizeRestaurantIds(value) {
    const unique = [];
    const pushUnique = (candidate) => {
      const trimmed = typeof candidate === 'string' ? candidate.trim() : candidate != null ? String(candidate).trim() : '';
      if (!trimmed) return;
      if (!unique.includes(trimmed)) {
        unique.push(trimmed);
      }
    };
    if (Array.isArray(value)) {
      value.forEach((entry) => {
        if (typeof entry === 'string' || typeof entry === 'number') {
          String(entry)
            .split(/[,;\n]/)
            .forEach((part) => pushUnique(part));
        }
      });
    } else if (typeof value === 'string' || typeof value === 'number') {
      String(value)
        .split(/[,;\n]/)
        .forEach((part) => pushUnique(part));
    }
    return unique;
  }

  function prepareNetworkProfile(item) {
    const source = item || {};
    const provider = source.provider != null ? String(source.provider).trim() : '';
    const contractNumber = source.contract_number != null ? String(source.contract_number).trim() : '';
    const supportPhone = source.support_phone != null ? String(source.support_phone).trim() : '';
    const legalEntity = source.legal_entity != null ? String(source.legal_entity).trim() : '';
    const fallbackSingle = source.restaurant_id != null ? String(source.restaurant_id).trim() : '';
    const idsSource = source.restaurant_ids !== undefined ? source.restaurant_ids : fallbackSingle;
    let restaurantIds = sanitizeRestaurantIds(idsSource);
    if (!restaurantIds.length && fallbackSingle) {
      restaurantIds = [fallbackSingle];
    }
    const primaryRestaurantId = restaurantIds[0] || '';
    return {
      provider,
      contract_number: contractNumber,
      support_phone: supportPhone,
      legal_entity: legalEntity,
      restaurant_ids: restaurantIds,
      restaurant_id: primaryRestaurantId,
    };
  }

  function createEmptyNetworkProfile() {
    return prepareNetworkProfile({});
  }

  let networkProfilesData = Array.isArray(networkProfilesInitial)
    ? networkProfilesInitial.map((item) => prepareNetworkProfile(item))
    : [];

  const networkProfilesBody = document.getElementById('networkProfilesBody');
  const networkProfilesSaveButton = document.querySelector('[data-network-profiles-save]');
  const networkProfilesAddButton = document.querySelector('[data-network-profiles-add]');
  const networkProfileModalEl = document.getElementById('networkProfileEditorModal');
  const networkProfileModal = networkProfileModalEl ? new bootstrap.Modal(networkProfileModalEl) : null;
  const networkProfileForm = networkProfileModalEl ? networkProfileModalEl.querySelector('[data-network-profile-form]') : null;
  const networkProfileTitle = networkProfileModalEl ? networkProfileModalEl.querySelector('[data-network-profile-title]') : null;
  const networkProfileDeleteButton = networkProfileModalEl ? networkProfileModalEl.querySelector('[data-network-profile-delete]') : null;
  const networkProfileProviderInput = networkProfileModalEl ? networkProfileModalEl.querySelector('[data-network-profile-provider]') : null;
  const networkProfileContractInput = networkProfileModalEl ? networkProfileModalEl.querySelector('[data-network-profile-contract]') : null;
  const networkProfileSupportPhoneInput = networkProfileModalEl ? networkProfileModalEl.querySelector('[data-network-profile-support-phone]') : null;
  const networkProfileLegalEntityInput = networkProfileModalEl ? networkProfileModalEl.querySelector('[data-network-profile-legal-entity]') : null;
  const networkProfileRestaurantIdsContainer = networkProfileModalEl
    ? networkProfileModalEl.querySelector('[data-network-profile-restaurant-ids]')
    : null;
  const networkProfileAddRestaurantIdButton = networkProfileModalEl
    ? networkProfileModalEl.querySelector('[data-network-profile-add-restaurant-id]')
    : null;
  let networkProfileEditingIndex = null;

  function escapeHtml(value) {
    if (value === null || value === undefined) return '';
    return String(value)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function getProfileRestaurantIds(profile) {
    const data = profile || {};
    const ids = sanitizeRestaurantIds(data.restaurant_ids);
    if (!ids.length) {
      sanitizeRestaurantIds(data.restaurant_id).forEach((value) => {
        if (!ids.includes(value)) {
          ids.push(value);
        }
      });
    }
    return ids;
  }

  function renderText(value) {
    const trimmed = (value || '').trim();
    return trimmed ? escapeHtml(trimmed) : '<span class="text-muted">‚Äî</span>';
  }

  function renderRestaurantIdsCell(profile) {
    const ids = getProfileRestaurantIds(profile);
    if (!ids.length) {
      return '<span class="text-muted">‚Äî</span>';
    }
    const badges = ids
      .map((id) => `<span class="badge bg-light text-dark border">${escapeHtml(id)}</span>`)
      .join('');
    return `<div class="d-flex flex-wrap gap-1">${badges}</div>`;
  }

  function renderContractUsageLink(contractNumber) {
    const trimmed = (contractNumber || '').trim();
    if (!trimmed) {
      return '<span class="text-muted">‚Äî</span>';
    }
    const count = contractUsageData && typeof contractUsageData === 'object'
      ? (contractUsageData[trimmed] || 0)
      : 0;
    const url = `/object_passports?network_contract_number=${encodeURIComponent(trimmed)}`;
    return `<a href="${url}" class="btn btn-link btn-sm p-0">${count}</a>`;
  }

  function updateRestaurantIdRemoveButtonsState() {
    if (!networkProfileRestaurantIdsContainer) return;
    const entries = networkProfileRestaurantIdsContainer.querySelectorAll('[data-restaurant-id-entry]');
    const allowRemoval = entries.length > 1;
    entries.forEach((entry) => {
      const removeButton = entry.querySelector('[data-remove-restaurant-id]');
      if (removeButton) {
        removeButton.disabled = !allowRemoval;
      }
    });
  }

  function createRestaurantIdEntry(value) {
    const group = document.createElement('div');
    group.className = 'input-group input-group-sm';
    group.dataset.restaurantIdEntry = 'true';

    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'form-control';
    input.placeholder = 'ID —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞';
    input.value = value || '';
    input.setAttribute('data-restaurant-id-input', 'true');
    group.appendChild(input);

    const removeButton = document.createElement('button');
    removeButton.type = 'button';
    removeButton.className = 'btn btn-outline-danger';
    removeButton.setAttribute('data-remove-restaurant-id', 'true');
    removeButton.innerHTML = '&times;';
    removeButton.title = '–£–¥–∞–ª–∏—Ç—å';
    group.appendChild(removeButton);

    return group;
  }

  function renderRestaurantIdInputs(values) {
    if (!networkProfileRestaurantIdsContainer) return;
    const list = Array.isArray(values) && values.length ? values : [''];
    networkProfileRestaurantIdsContainer.innerHTML = '';
    list.forEach((value) => {
      const entry = createRestaurantIdEntry(value);
      networkProfileRestaurantIdsContainer.appendChild(entry);
    });
    updateRestaurantIdRemoveButtonsState();
  }

  function addRestaurantIdInput(value = '') {
    if (!networkProfileRestaurantIdsContainer) return;
    const entry = createRestaurantIdEntry(value);
    networkProfileRestaurantIdsContainer.appendChild(entry);
    updateRestaurantIdRemoveButtonsState();
    const input = entry.querySelector('[data-restaurant-id-input]');
    if (input) {
      input.focus();
      input.select();
    }
  }

  function collectRestaurantIdsFromForm() {
    if (!networkProfileRestaurantIdsContainer) return [];
    const inputs = networkProfileRestaurantIdsContainer.querySelectorAll('[data-restaurant-id-input]');
    const values = [];
    inputs.forEach((input) => {
      const trimmed = (input.value || '').trim();
      if (trimmed && !values.includes(trimmed)) {
        values.push(trimmed);
      }
    });
    return values;
  }

  function fillNetworkProfileForm(profile) {
    const data = prepareNetworkProfile(profile);
    if (networkProfileProviderInput) {
      networkProfileProviderInput.value = data.provider || '';
    }
    if (networkProfileContractInput) {
      networkProfileContractInput.value = data.contract_number || '';
    }
    if (networkProfileSupportPhoneInput) {
      networkProfileSupportPhoneInput.value = data.support_phone || '';
    }
    if (networkProfileLegalEntityInput) {
      networkProfileLegalEntityInput.value = data.legal_entity || '';
    }
    const ids = getProfileRestaurantIds(data);
    renderRestaurantIdInputs(ids.length ? ids : ['']);
  }

  function openNetworkProfileModal(index) {
    const numericIndex = Number.isInteger(index) ? index : Number.parseInt(index, 10);
    const isEdit = Number.isInteger(numericIndex) && numericIndex >= 0 && numericIndex < networkProfilesData.length;
    networkProfileEditingIndex = isEdit ? numericIndex : null;
    const profile = isEdit ? networkProfilesData[numericIndex] : createEmptyNetworkProfile();
    fillNetworkProfileForm(profile);
    if (networkProfileTitle) {
      networkProfileTitle.textContent = isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è' : '–ù–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞';
    }
    if (networkProfileDeleteButton) {
      networkProfileDeleteButton.classList.toggle('d-none', !isEdit);
    }
    if (networkProfileModal) {
      networkProfileModal.show();
    }
  }

  function renderNetworkProfiles() {
    if (!networkProfilesBody) return;
    networkProfilesBody.innerHTML = '';
    if (!networkProfilesData.length) {
      const emptyRow = document.createElement('tr');
      emptyRow.innerHTML = '<td colspan="7" class="text-muted text-center">–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π</td>';
      networkProfilesBody.appendChild(emptyRow);
      return;
    }
    networkProfilesData.forEach((profile, index) => {
      const prepared = prepareNetworkProfile(profile);
      networkProfilesData[index] = prepared;
      const row = document.createElement('tr');
      row.dataset.index = index;
      row.innerHTML = `
        <td>${renderText(prepared.provider)}</td>
        <td>${renderText(prepared.contract_number)}</td>
        <td>${renderRestaurantIdsCell(prepared)}</td>
        <td>${renderText(prepared.support_phone)}</td>
        <td>${renderText(prepared.legal_entity)}</td>
        <td data-usage-cell></td>
        <td class="text-nowrap">
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" type="button" data-action="edit-profile">–û—Ç–∫—Ä—ã—Ç—å</button>
            <button class="btn btn-outline-danger" type="button" data-action="remove-profile">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </td>
      `;
      const usageCell = row.querySelector('[data-usage-cell]');
      if (usageCell) {
        usageCell.innerHTML = renderContractUsageLink(prepared.contract_number);
      }
      networkProfilesBody.appendChild(row);
    });
  }

  function removeNetworkProfileRow(index) {
    if (index < 0 || index >= networkProfilesData.length) return;
    networkProfilesData.splice(index, 1);
    renderNetworkProfiles();
  }

  function collectNetworkProfilesPayload() {
    return networkProfilesData
      .map((item) => {
        const prepared = prepareNetworkProfile(item);
        return {
          provider: prepared.provider,
          contract_number: prepared.contract_number,
          support_phone: prepared.support_phone,
          legal_entity: prepared.legal_entity,
          restaurant_id: prepared.restaurant_id,
          restaurant_ids: prepared.restaurant_ids,
        };
      })
      .filter((profile) => {
        return (
          profile.provider ||
          profile.contract_number ||
          profile.support_phone ||
          profile.legal_entity ||
          profile.restaurant_id ||
          (Array.isArray(profile.restaurant_ids) && profile.restaurant_ids.length)
        );
      });
  }

  function handleNetworkProfileFormSubmit(event) {
    event.preventDefault();
    const data = {
      provider: networkProfileProviderInput ? networkProfileProviderInput.value : '',
      contract_number: networkProfileContractInput ? networkProfileContractInput.value : '',
      support_phone: networkProfileSupportPhoneInput ? networkProfileSupportPhoneInput.value : '',
      legal_entity: networkProfileLegalEntityInput ? networkProfileLegalEntityInput.value : '',
      restaurant_ids: collectRestaurantIdsFromForm(),
    };
    const prepared = prepareNetworkProfile(data);
    const isEdit =
      Number.isInteger(networkProfileEditingIndex) &&
      networkProfileEditingIndex >= 0 &&
      networkProfileEditingIndex < networkProfilesData.length;
    if (isEdit) {
      networkProfilesData[networkProfileEditingIndex] = prepared;
    } else {
      networkProfilesData.push(prepared);
    }
    renderNetworkProfiles();
    if (networkProfileModal) {
      networkProfileModal.hide();
    }
  }

  function handleNetworkProfileDelete() {
    if (
      !Number.isInteger(networkProfileEditingIndex) ||
      networkProfileEditingIndex < 0 ||
      networkProfileEditingIndex >= networkProfilesData.length
    ) {
      return;
    }
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞?')) {
      return;
    }
    removeNetworkProfileRow(networkProfileEditingIndex);
    if (networkProfileModal) {
      networkProfileModal.hide();
    }
  }

  if (networkProfilesAddButton) {
    networkProfilesAddButton.addEventListener('click', () => openNetworkProfileModal(null));
  }

  if (networkProfilesBody) {
    networkProfilesBody.addEventListener('click', (event) => {
      const actionButton = event.target.closest('[data-action]');
      if (!actionButton) return;
      const row = actionButton.closest('tr[data-index]');
      if (!row) return;
      const index = Number.parseInt(row.dataset.index, 10);
      if (Number.isNaN(index)) return;
      const action = actionButton.dataset.action;
      if (action === 'edit-profile') {
        openNetworkProfileModal(index);
      } else if (action === 'remove-profile') {
        if (confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞?')) {
          removeNetworkProfileRow(index);
        }
      }
    });
  }

  if (networkProfileAddRestaurantIdButton) {
    networkProfileAddRestaurantIdButton.addEventListener('click', () => addRestaurantIdInput(''));
  }

  if (networkProfileRestaurantIdsContainer) {
    networkProfileRestaurantIdsContainer.addEventListener('click', (event) => {
      const button = event.target.closest('[data-remove-restaurant-id]');
      if (!button) return;
      const entry = button.closest('[data-restaurant-id-entry]');
      if (!entry) return;
      const entries = networkProfileRestaurantIdsContainer.querySelectorAll('[data-restaurant-id-entry]');
      if (entries.length <= 1) {
        const input = entry.querySelector('[data-restaurant-id-input]');
        if (input) {
          input.value = '';
          input.focus();
          input.select();
        }
        return;
      }
      entry.remove();
      updateRestaurantIdRemoveButtonsState();
    });
  }

  if (networkProfileForm) {
    networkProfileForm.addEventListener('submit', handleNetworkProfileFormSubmit);
  }

  if (networkProfileDeleteButton) {
    networkProfileDeleteButton.addEventListener('click', handleNetworkProfileDelete);
  }

  if (networkProfileModalEl) {
    networkProfileModalEl.addEventListener('hidden.bs.modal', () => {
      networkProfileEditingIndex = null;
      if (networkProfileForm) {
        networkProfileForm.reset();
      }
      if (networkProfileRestaurantIdsContainer) {
        renderRestaurantIdInputs(['']);
      }
    });
    networkProfileModalEl.addEventListener('shown.bs.modal', () => {
      if (networkProfileProviderInput) {
        networkProfileProviderInput.focus();
        networkProfileProviderInput.select();
      }
    });
  }

  renderNetworkProfiles();

  function normalizeItConnectionCategory(value) {
    if (typeof value !== 'string') {
      return IT_CONNECTION_DEFAULT_CATEGORY;
    }
    const trimmed = value.trim();
    if (!trimmed) {
      return IT_CONNECTION_DEFAULT_CATEGORY;
    }
    if (IT_CONNECTION_CATEGORY_KEYS.includes(trimmed)) {
      return trimmed;
    }
    const lowered = trimmed.toLowerCase();
    const matchedKey = IT_CONNECTION_CATEGORY_KEYS.find((key) => {
      const label = IT_CONNECTION_CATEGORY_LABELS[key];
      return typeof label === 'string' && label.trim().toLowerCase() === lowered;
    });
    return matchedKey || trimmed;
  }

  function getItConnectionCategoryLabel(category) {
    const normalized = normalizeItConnectionCategory(category);
    return IT_CONNECTION_CATEGORY_LABELS[normalized] || normalized || '‚Äî';
  }

  function renderContractUsageLink(contractNumber) {
    const trimmed = (contractNumber || '').trim();
    if (!trimmed) {
      return '<span class="text-muted">‚Äî</span>';
    }
    const count = contractUsageData && typeof contractUsageData === 'object'
      ? (contractUsageData[trimmed] || 0)
      : 0;
    const url = `/object_passports?network_contract_number=${encodeURIComponent(trimmed)}`;
    return `<a href="${url}" class="btn btn-link btn-sm p-0">${count}</a>`;
  }

  async function saveNetworkProfilesSection() {
    if (networkProfilesSaveButton && networkProfilesSaveButton.disabled) {
      return;
    }
    const button = networkProfilesSaveButton;
    const originalText = button ? button.textContent : '';
    if (button) {
      button.disabled = true;
      button.textContent = '...';
    }
    try {
      const payload = { network_profiles: collectNetworkProfilesPayload() };
      const response = await fetch('/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error((data && data.error) || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–π');
      }
      alert('‚úÖ –ü—Ä–æ—Ñ–∏–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
    } catch (error) {
      alert('‚ùå ' + (error && error.message ? error.message : error));
    } finally {
      if (button) {
        button.disabled = false;
        button.textContent = originalText || '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
      }
    }
  }

  if (networkProfilesSaveButton) {
    networkProfilesSaveButton.addEventListener('click', (event) => {
      event.preventDefault();
      saveNetworkProfilesSection();
    });
  }

  const itConnectionsContainer = document.querySelector('[data-it-connections-container]');
  let itConnectionDrafts = [];
  const itEquipmentBody = document.getElementById('itEquipmentBody');
  let itEquipmentItems = [];

  function parseEquipmentLinks(raw) {
    if (Array.isArray(raw)) {
      return raw.map((item) => (item || '').toString().trim()).filter(Boolean);
    }
    if (typeof raw === 'string') {
      const trimmed = raw.trim();
      if (!trimmed) {
        return [];
      }
      if (trimmed.startsWith('[')) {
        try {
          const parsed = JSON.parse(trimmed);
          if (Array.isArray(parsed)) {
            return parsed.map((item) => (item || '').toString().trim()).filter(Boolean);
          }
        } catch (error) {
          // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞–∫ —Å—Ç—Ä–æ–∫—É
        }
      }
      if (trimmed.includes('\n')) {
        return trimmed
          .split('\n')
          .map((item) => item.trim())
          .filter(Boolean);
      }
      return [trimmed];
    }
    return [];
  }

  function formatEquipmentLinksPayload(links) {
    const normalized = Array.isArray(links)
      ? links.map((item) => (item || '').toString().trim()).filter(Boolean)
      : [];
    if (!normalized.length) {
      return '';
    }
    try {
      return JSON.stringify(normalized);
    } catch (error) {
      return normalized.join('\n');
    }
  }

  function ensureEquipmentLinksPlaceholder(container) {
    if (!container) return;
    const hasItems = container.querySelector('[data-link-item]');
    const placeholder = container.querySelector('[data-link-placeholder]');
    if (hasItems && placeholder) {
      placeholder.remove();
    } else if (!hasItems && !placeholder) {
      const hint = document.createElement('div');
      hint.className = 'text-muted small';
      hint.dataset.linkPlaceholder = 'true';
      hint.textContent = '–°—Å—ã–ª–æ–∫ –Ω–µ—Ç';
      container.appendChild(hint);
    }
  }

  function addEquipmentLinkInput(container, value = '') {
    if (!container) return null;
    const item = document.createElement('div');
    item.className = 'input-group input-group-sm';
    item.dataset.linkItem = 'true';
    item.innerHTML = `
      <input type="text" class="form-control form-control-sm" data-link-input placeholder="https://..." value="${escapeHtml(value)}">
      <button class="btn btn-outline-danger" type="button" data-it-equipment-link-action="remove-link">&times;</button>
    `;
    container.appendChild(item);
    ensureEquipmentLinksPlaceholder(container);
    return item;
  }

  function renderEquipmentLinks(container, links) {
    if (!container) return;
    container.innerHTML = '';
    const list = Array.isArray(links) ? links : [];
    if (!list.length) {
      ensureEquipmentLinksPlaceholder(container);
      return;
    }
    list.forEach((link) => {
      addEquipmentLinkInput(container, link);
    });
    ensureEquipmentLinksPlaceholder(container);
  }

  function collectEquipmentLinks(container) {
    if (!container) return [];
    return Array.from(container.querySelectorAll('[data-link-input]'))
      .map((input) => (input.value || '').trim())
      .filter(Boolean);
  }

  function renderItConnectionUsageLink(item) {
    if (!item) {
      return '<span class="text-muted">‚Äî</span>';
    }
    const category = normalizeItConnectionCategory(item.category);
    const value = item && item.value ? String(item.value).trim() : '';
    const usage = Number.isFinite(Number(item && item.usage_count)) ? Number(item.usage_count) : 0;
    if (!value) {
      return '<span class="text-muted">‚Äî</span>';
    }
    const filterKey = IT_CONNECTION_USAGE_FILTER_PARAMS[category];
    if (!filterKey) {
      const className = usage > 0 ? 'fw-semibold text-dark' : 'text-muted';
      return `<span class="${className}">${usage}</span>`;
    }
    const url = `/object_passports?${filterKey}=${encodeURIComponent(value)}`;
    const className = 'btn btn-link btn-sm p-0' + (usage > 0 ? '' : ' text-muted');
    return `<a href="${url}" class="${className}" title="–û—Ç–∫—Ä—ã—Ç—å –ø–∞—Å–ø–æ—Ä—Ç–∞ —Å —ç—Ç–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º">${usage}</a>`;
  }

  function buildItConnectionsRows() {
    const existing = Array.isArray(parameterData.it_connection) ? parameterData.it_connection : [];
    const rows = existing.map((item) => ({
      item: Object.assign({}, item, {
        category: normalizeItConnectionCategory(item && item.category),
        value: item && typeof item.value === 'string' ? item.value : '',
      }),
      isDraft: false,
    }));
    itConnectionDrafts.forEach((item, index) => {
      const draft = Object.assign(
        {
          category: IT_CONNECTION_DEFAULT_CATEGORY,
          value: '',
          is_deleted: false,
          usage_count: 0,
        },
        item || {}
      );
      draft.category = normalizeItConnectionCategory(draft.category);
      draft.value = typeof draft.value === 'string' ? draft.value : '';
      rows.push({ item: draft, isDraft: true, draftIndex: index });
    });
    return rows;
  }

  function renderItConnectionsTable() {
    if (!itConnectionsContainer) return;
    const rows = buildItConnectionsRows();
    itConnectionsContainer.innerHTML = '';
    if (!rows.length) {
      const emptyState = document.createElement('div');
      emptyState.className = 'text-muted text-center py-3';
      emptyState.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π';
      itConnectionsContainer.appendChild(emptyState);
      renderItEquipmentTable();
      return;
    }

    const grouped = rows.reduce((acc, entry) => {
      const category = normalizeItConnectionCategory(entry && entry.item && entry.item.category);
      if (!acc.has(category)) {
        acc.set(category, []);
      }
      acc.get(category).push(entry);
      return acc;
    }, new Map());

    const accordionId = 'itConnectionsCategoryAccordion';
    const categoryEntries = Array.from(grouped.entries()).sort(([a], [b]) => {
      const labelA = getItConnectionCategoryLabel(a);
      const labelB = getItConnectionCategoryLabel(b);
      return labelA.localeCompare(labelB, 'ru', { sensitivity: 'base' });
    });

    categoryEntries.forEach(([category, items], index) => {
      const collapseIdSlug = (category || 'uncategorized')
        .toString()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '') || 'all';
      const collapseId = `${accordionId}-panel-${index}-${collapseIdSlug}`;
      const headerId = `${collapseId}-header`;
      const accordionItem = document.createElement('div');
      accordionItem.className = 'accordion-item';
      accordionItem.innerHTML = `
        <h2 class="accordion-header" id="${headerId}">
          <button class="accordion-button${index === 0 ? '' : ' collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="${index === 0}" aria-controls="${collapseId}">
            ${escapeHtml(getItConnectionCategoryLabel(category))}
          </button>
        </h2>
        <div id="${collapseId}" class="accordion-collapse collapse${index === 0 ? ' show' : ''}" aria-labelledby="${headerId}" data-bs-parent="#${accordionId}">
          <div class="accordion-body p-0">
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead>
                  <tr>
                    <th style="width: 55%">–ó–Ω–∞—á–µ–Ω–∏–µ</th>
                    <th class="text-center" style="width: 10%">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</th>
                    <th style="width: 35%"></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      `;
      const tbody = accordionItem.querySelector('tbody');
      items.forEach(({ item, isDraft, draftIndex }) => {
        const row = document.createElement('tr');
        const disabled = !isDraft && Boolean(item && item.is_deleted);
        const value = item && typeof item.value === 'string' ? item.value : '';
        if (isDraft) {
          row.dataset.rowKind = 'draft';
          row.dataset.draftIndex = String(draftIndex);
        } else {
          row.dataset.rowKind = 'existing';
          const rawId = item && Object.prototype.hasOwnProperty.call(item, 'id') ? item.id : null;
          const idNumber = Number.parseInt(rawId, 10);
          if (Number.isFinite(idNumber)) {
            row.dataset.id = String(idNumber);
          }
          if (disabled) {
            row.classList.add('table-light', 'text-muted');
          }
        }
        row.dataset.category = category;
        const usageItem = Object.assign({}, item || {}, { category, value });
        const deletedHint = !isDraft && disabled
          ? '<div class="form-text text-danger small">–ó–∞–ø–∏—Å—å –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ —É–¥–∞–ª—ë–Ω–Ω–∞—è</div>'
          : '';
        const actions = isDraft
          ? `
              <button class="btn btn-sm btn-outline-success" type="button" data-it-connection-action="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button class="btn btn-sm btn-outline-secondary" type="button" data-it-connection-action="discard">–û—Ç–º–µ–Ω–∏—Ç—å</button>
            `
          : disabled
            ? '<button class="btn btn-sm btn-outline-secondary" type="button" data-it-connection-action="restore">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>'
            : `
              <button class="btn btn-sm btn-outline-success" type="button" data-it-connection-action="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button class="btn btn-sm btn-outline-danger" type="button" data-it-connection-action="delete">–£–¥–∞–ª–∏—Ç—å</button>
            `;
        row.innerHTML = `
          <td>
            <input type="text" class="form-control form-control-sm" data-field="value" value="${escapeHtml(value)}"${disabled ? ' disabled' : ''}>
            ${deletedHint}
          </td>
          <td class="text-center">${renderItConnectionUsageLink(usageItem)}</td>
          <td class="text-nowrap">${actions}</td>
        `;
        tbody.appendChild(row);
      });
      itConnectionsContainer.appendChild(accordionItem);
    });

    renderItEquipmentTable();
  }

  function collectEquipmentOptionSets() {
    const result = {
      types: new Set(),
      vendors: new Set(),
      models: new Set(),
    };
    const items = Array.isArray(parameterData.it_connection) ? parameterData.it_connection : [];
    items.forEach((item) => {
      if (!item) return;
      const category = normalizeItConnectionCategory(
        (item && item.category) || (item && item.extra && item.extra.category)
      );
      const values = {
        equipment_type: typeof item.equipment_type === 'string' ? item.equipment_type.trim() : '',
        equipment_vendor: typeof item.equipment_vendor === 'string' ? item.equipment_vendor.trim() : '',
        equipment_model: typeof item.equipment_model === 'string' ? item.equipment_model.trim() : '',
        value: typeof item.value === 'string' ? item.value.trim() : '',
      };
      if (category === 'equipment_type') {
        if (values.equipment_type) result.types.add(values.equipment_type);
        if (values.value) result.types.add(values.value);
      } else if (category === 'equipment_vendor') {
        if (values.equipment_vendor) result.vendors.add(values.equipment_vendor);
        if (values.value) result.vendors.add(values.value);
      } else if (category === 'equipment_model') {
        if (values.equipment_model) result.models.add(values.equipment_model);
        if (values.value) result.models.add(values.value);
      }
    });
    const sorter = (a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' });
    return {
      types: Array.from(result.types).sort(sorter),
      vendors: Array.from(result.vendors).sort(sorter),
      models: Array.from(result.models).sort(sorter),
    };
  }

  function buildEquipmentSelectOptions(values, selectedValue) {
    const list = Array.isArray(values) ? values : [];
    const normalizedSelected = typeof selectedValue === 'string' ? selectedValue.trim() : '';
    const options = ['<option value="">‚Äî</option>'];
    const seen = new Set();
    list.forEach((raw) => {
      const value = typeof raw === 'string' ? raw.trim() : '';
      if (!value || seen.has(value)) return;
      const selectedAttr = value === normalizedSelected ? ' selected' : '';
      options.push(`<option value="${escapeHtml(value)}"${selectedAttr}>${escapeHtml(value)}</option>`);
      seen.add(value);
    });
    if (normalizedSelected && !seen.has(normalizedSelected)) {
      options.push(
        `<option value="${escapeHtml(normalizedSelected)}" selected>${escapeHtml(normalizedSelected)}</option>`
      );
    }
    return options.join('');
  }

  function renderItEquipmentTable() {
    if (!itEquipmentBody) return;
    const list = Array.isArray(itEquipmentItems) ? itEquipmentItems : [];
    itEquipmentBody.innerHTML = '';
    if (!list.length) {
      const emptyRow = document.createElement('tr');
      emptyRow.innerHTML = '<td colspan="5" class="text-muted text-center">–ü–æ–∫–∞ –Ω–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</td>';
      itEquipmentBody.appendChild(emptyRow);
      return;
    }
    const optionSets = collectEquipmentOptionSets();
    list.forEach((item) => {
      const row = document.createElement('tr');
      const idNumber = Number.parseInt(item && item.id, 10);
      if (Number.isFinite(idNumber)) {
        row.dataset.id = String(idNumber);
      }
      const equipmentType = typeof (item && item.equipment_type) === 'string' ? item.equipment_type : '';
      const equipmentVendor = typeof (item && item.equipment_vendor) === 'string' ? item.equipment_vendor : '';
      const equipmentModel = typeof (item && item.equipment_model) === 'string' ? item.equipment_model : '';
      const links = parseEquipmentLinks(item && item.photo_url);
      row.innerHTML = `
        <td><select class="form-select form-select-sm" data-field="equipment_type">${buildEquipmentSelectOptions(optionSets.types, equipmentType)}</select></td>
        <td><select class="form-select form-select-sm" data-field="equipment_vendor">${buildEquipmentSelectOptions(optionSets.vendors, equipmentVendor)}</select></td>
        <td><select class="form-select form-select-sm" data-field="equipment_model">${buildEquipmentSelectOptions(optionSets.models, equipmentModel)}</select></td>
        <td>
          <div class="d-flex flex-column gap-2" data-links-container></div>
          <button class="btn btn-sm btn-outline-secondary align-self-start" type="button" data-it-equipment-link-action="add-link">+ –°—Å—ã–ª–∫–∞</button>
        </td>
        <td class="text-nowrap">
          <button class="btn btn-sm btn-outline-success" type="button" data-it-equipment-action="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn btn-sm btn-outline-danger" type="button" data-it-equipment-action="delete">–£–¥–∞–ª–∏—Ç—å</button>
        </td>
      `;
      const linksContainer = row.querySelector('[data-links-container]');
      renderEquipmentLinks(linksContainer, links);
      itEquipmentBody.appendChild(row);
    });
  }

  function collectItEquipmentPayload(row) {
    if (!row) return {};
    const selectValue = (selector) => {
      const element = row.querySelector(selector);
      return element ? element.value.trim() : '';
    };
    return {
      equipment_type: selectValue('[data-field="equipment_type"]'),
      equipment_vendor: selectValue('[data-field="equipment_vendor"]'),
      equipment_model: selectValue('[data-field="equipment_model"]'),
      photo_url: formatEquipmentLinksPayload(collectEquipmentLinks(row.querySelector('[data-links-container]'))),
    };
  }

  async function saveItEquipmentRow(row) {
    if (!row) return;
    const id = Number.parseInt(row.dataset.id, 10);
    if (!Number.isFinite(id)) return;
    const payload = collectItEquipmentPayload(row);
    if (!payload.equipment_type) {
      alert('–£–∫–∞–∂–∏—Ç–µ —Ç–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è');
      const select = row.querySelector('[data-field="equipment_type"]');
      if (select) select.focus();
      return;
    }
    if (!payload.equipment_vendor) {
      alert('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è');
      const select = row.querySelector('[data-field="equipment_vendor"]');
      if (select) select.focus();
      return;
    }
    if (!payload.equipment_model) {
      alert('–£–∫–∞–∂–∏—Ç–µ –º–æ–¥–µ–ª—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è');
      const select = row.querySelector('[data-field="equipment_model"]');
      if (select) select.focus();
      return;
    }
    const button = row.querySelector('[data-it-equipment-action="save"]');
    const originalText = button ? button.textContent : '';
    if (button) {
      button.disabled = true;
      button.textContent = '...';
    }
    try {
      const response = await fetch(`/api/settings/it-equipment/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error((data && data.error) || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è');
      }
      if (Array.isArray(data.items)) {
        itEquipmentItems = data.items;
      } else if (data.item) {
        const updatedId = Number.parseInt(data.item.id, 10);
        const index = itEquipmentItems.findIndex((entry) => Number.parseInt(entry.id, 10) === updatedId);
        if (index >= 0) {
          itEquipmentItems[index] = data.item;
        }
      }
      renderItEquipmentTable();
    } catch (error) {
      alert('‚ùå ' + (error && error.message ? error.message : error));
    } finally {
      if (button) {
        button.disabled = false;
        button.textContent = originalText || '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
      }
    }
  }

  async function deleteItEquipmentRow(row) {
    if (!row) return;
    const id = Number.parseInt(row.dataset.id, 10);
    if (!Number.isFinite(id)) return;
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ?')) return;
    const button = row.querySelector('[data-it-equipment-action="delete"]');
    const originalText = button ? button.textContent : '';
    if (button) {
      button.disabled = true;
      button.textContent = '...';
    }
    try {
      const response = await fetch(`/api/settings/it-equipment/${id}`, { method: 'DELETE' });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error((data && data.error) || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è');
      }
      itEquipmentItems = Array.isArray(data.items) ? data.items : [];
      renderItEquipmentTable();
    } catch (error) {
      alert('‚ùå ' + (error && error.message ? error.message : error));
    } finally {
      if (button) {
        button.disabled = false;
        button.textContent = originalText || '–£–¥–∞–ª–∏—Ç—å';
      }
    }
  }

  async function loadItEquipment() {
    if (!itEquipmentBody) return;
    try {
      const response = await fetch('/api/settings/it-equipment');
      if (!response.ok) {
        throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è');
      }
      const data = await response.json();
      if (data && data.success === false) {
        throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è');
      }
      itEquipmentItems = Array.isArray(data && data.items) ? data.items : [];
      renderItEquipmentTable();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–∞–ª–æ–≥–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:', error);
    }
  }

  function addItConnectionRow(initial) {
    const defaults = {
      category: IT_CONNECTION_DEFAULT_CATEGORY,
      value: '',
      usage_count: 0,
      is_deleted: false,
    };
    const data = Object.assign({}, defaults, initial || {});
    data.category = normalizeItConnectionCategory(data.category);
    data.value = typeof data.value === 'string' ? data.value : '';
    itConnectionDrafts.push(data);
    renderItConnectionsTable();
  }

  function buildItConnectionPayload(category, value) {
    const normalizedCategory = normalizeItConnectionCategory(category);
    const trimmedValue = typeof value === 'string' ? value.trim() : '';
    const payload = {
      value: trimmedValue,
      category: normalizedCategory,
      equipment_type: '',
      equipment_vendor: '',
      equipment_model: '',
      equipment_status: '',
    };
    const mappedField = IT_CONNECTION_CATEGORY_FIELDS[normalizedCategory];
    if (mappedField === 'equipment_type') {
      payload.equipment_type = trimmedValue;
    } else if (mappedField === 'equipment_vendor') {
      payload.equipment_vendor = trimmedValue;
    } else if (mappedField === 'equipment_model') {
      payload.equipment_model = trimmedValue;
    } else if (mappedField === 'equipment_status') {
      payload.equipment_status = trimmedValue;
    }
    return payload;
  }

  function collectItConnectionPayload(row) {
    const category = normalizeItConnectionCategory(row && row.dataset ? row.dataset.category : undefined);
    const input = row ? row.querySelector('[data-field="value"]') : null;
    const value = input ? input.value : '';
    return buildItConnectionPayload(category, value);
  }

  async function saveItConnection(row, context) {
    const { isDraft, draftIndex, id } = context;
    const payload = collectItConnectionPayload(row);
    if (!payload.value) {
      alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
      const input = row.querySelector('[data-field="value"]');
      if (input) input.focus();
      return;
    }
    let button = row.querySelector('[data-it-connection-action="save"]');
    if (button) button.disabled = true;
    try {
      let response;
      if (isDraft || !Number.isFinite(id)) {
        response = await fetch('/api/settings/parameters', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(Object.assign({ param_type: 'it_connection' }, payload)),
        });
      } else {
        response = await fetch(`/api/settings/parameters/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
      }
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
      }
      if (isDraft && Number.isInteger(draftIndex) && draftIndex >= 0) {
        itConnectionDrafts.splice(draftIndex, 1);
      }
      syncParameterData((data && data.data) || parameterData);
      renderParameters({ forceBodies: true });
      renderItConnectionsTable();
      if (parameterModal && parameterModalType) {
        renderParameterModal(parameterModalType);
      }
    } catch (error) {
      const message = error && error.message ? error.message : error;
      alert('‚ùå ' + message);
    } finally {
      if (button) button.disabled = false;
    }
  }

  async function deleteItConnection(row, context) {
    const { isDraft, draftIndex, id } = context;
    if (isDraft) {
      if (Number.isInteger(draftIndex) && draftIndex >= 0) {
        itConnectionDrafts.splice(draftIndex, 1);
        renderItConnectionsTable();
      }
      return;
    }
    if (!Number.isFinite(id)) {
      return;
    }
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ?')) {
      return;
    }
    let button = row.querySelector('[data-it-connection-action="delete"]');
    if (button) button.disabled = true;
    try {
      const response = await fetch(`/api/settings/parameters/${id}`, { method: 'DELETE' });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
      }
      syncParameterData((data && data.data) || parameterData);
      renderParameters({ forceBodies: true });
      renderItConnectionsTable();
      if (parameterModal && parameterModalType) {
        renderParameterModal(parameterModalType);
      }
    } catch (error) {
      const message = error && error.message ? error.message : error;
      alert('‚ùå ' + message);
    } finally {
      if (button) button.disabled = false;
    }
  }

  async function restoreItConnection(row, id) {
    if (!Number.isFinite(id)) {
      return;
    }
    let button = row.querySelector('[data-it-connection-action="restore"]');
    if (button) button.disabled = true;
    try {
      const response = await fetch(`/api/settings/parameters/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_deleted: false }),
      });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || '–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è');
      }
      syncParameterData((data && data.data) || parameterData);
      renderParameters({ forceBodies: true });
      renderItConnectionsTable();
      if (parameterModal && parameterModalType) {
        renderParameterModal(parameterModalType);
      }
    } catch (error) {
      const message = error && error.message ? error.message : error;
      alert('‚ùå ' + message);
    } finally {
      if (button) button.disabled = false;
    }
  }

  if (itConnectionsContainer) {
    itConnectionsContainer.addEventListener('click', (event) => {
      const button = event.target.closest('[data-it-connection-action]');
      if (!button) return;
      const action = button.dataset.itConnectionAction;
      const row = button.closest('tr');
      if (!row) return;
      const isDraft = row.dataset.rowKind === 'draft';
      const draftIndex = isDraft ? Number.parseInt(row.dataset.draftIndex, 10) : null;
      const id = !isDraft && row.dataset.id ? Number.parseInt(row.dataset.id, 10) : null;
      if (action === 'save') {
        saveItConnection(row, {
          isDraft,
          draftIndex: Number.isFinite(draftIndex) ? draftIndex : null,
          id: Number.isFinite(id) ? id : null,
        });
      } else if (action === 'delete') {
        deleteItConnection(row, {
          isDraft,
          draftIndex: Number.isFinite(draftIndex) ? draftIndex : null,
          id: Number.isFinite(id) ? id : null,
        });
      } else if (action === 'restore') {
        restoreItConnection(row, Number.isFinite(id) ? id : null);
      } else if (action === 'discard') {
        if (isDraft && Number.isFinite(draftIndex) && draftIndex >= 0) {
          itConnectionDrafts.splice(draftIndex, 1);
          renderItConnectionsTable();
        }
      }
    });
  }

  if (itEquipmentBody) {
    itEquipmentBody.addEventListener('click', (event) => {
      const linkButton = event.target.closest('[data-it-equipment-link-action]');
      if (linkButton) {
        const row = linkButton.closest('tr');
        if (!row) return;
        const action = linkButton.dataset.itEquipmentLinkAction;
        const container = row.querySelector('[data-links-container]');
        if (!container) return;
        if (action === 'add-link') {
          const item = addEquipmentLinkInput(container, '');
          const input = item ? item.querySelector('[data-link-input]') : null;
          if (input) {
            input.focus();
          }
        } else if (action === 'remove-link') {
          const item = linkButton.closest('[data-link-item]');
          if (item) {
            item.remove();
            ensureEquipmentLinksPlaceholder(container);
          }
        }
        return;
      }

      const button = event.target.closest('[data-it-equipment-action]');
      if (!button) return;
      const row = button.closest('tr');
      if (!row) return;
      const action = button.dataset.itEquipmentAction;
      if (action === 'save') {
        saveItEquipmentRow(row);
      } else if (action === 'delete') {
        deleteItEquipmentRow(row);
      }
    });
  }

  const itConnectionAddModalEl = document.getElementById('itConnectionAddModal');
  const itConnectionAddForm = itConnectionAddModalEl
    ? itConnectionAddModalEl.querySelector('[data-it-connection-add-form]')
    : null;
  if (itConnectionAddModalEl) {
    itConnectionCategorySelect = itConnectionAddModalEl.querySelector('[data-it-connection-category-select]');
  }
  const itConnectionCategoryCreateButton = itConnectionAddModalEl
    ? itConnectionAddModalEl.querySelector('[data-it-connection-category-create]')
    : null;
  const itConnectionValueInput = itConnectionAddModalEl
    ? itConnectionAddModalEl.querySelector('[data-it-connection-value-input]')
    : null;
  const itConnectionAddModal = itConnectionAddModalEl
    ? new bootstrap.Modal(itConnectionAddModalEl)
    : null;

  const itEquipmentAddModalEl = document.getElementById('itEquipmentAddModal');
  const itEquipmentAddForm = itEquipmentAddModalEl
    ? itEquipmentAddModalEl.querySelector('[data-it-equipment-add-form]')
    : null;
  const itEquipmentTypeSelect = itEquipmentAddModalEl
    ? itEquipmentAddModalEl.querySelector('#itEquipmentTypeSelect')
    : null;
  const itEquipmentVendorSelect = itEquipmentAddModalEl
    ? itEquipmentAddModalEl.querySelector('#itEquipmentVendorSelect')
    : null;
  const itEquipmentModelSelect = itEquipmentAddModalEl
    ? itEquipmentAddModalEl.querySelector('#itEquipmentModelSelect')
    : null;
  const itEquipmentAddLinksContainer = itEquipmentAddModalEl
    ? itEquipmentAddModalEl.querySelector('[data-it-equipment-add-links]')
    : null;
  const itEquipmentAddSubmitButton = itEquipmentAddForm
    ? itEquipmentAddForm.querySelector('button[type="submit"]')
    : null;
  const itEquipmentAddModal = itEquipmentAddModalEl
    ? new bootstrap.Modal(itEquipmentAddModalEl)
    : null;

  function populateItEquipmentAddOptions(selectedValues = {}) {
    const optionSets = collectEquipmentOptionSets();
    const ensureOptions = (select, values, emptyLabel, key) => {
      if (!select) return false;
      const list = Array.isArray(values) ? values : [];
      const selectedValue = selectedValues[key] || '';
      if (!list.length) {
        select.innerHTML = `<option value="" disabled selected>${escapeHtml(emptyLabel)}</option>`;
        select.disabled = true;
        select.value = '';
        select.classList.remove('is-invalid');
        return false;
      }
      select.disabled = false;
      select.innerHTML = buildEquipmentSelectOptions(list, selectedValue);
      select.value = selectedValue || '';
      select.classList.remove('is-invalid');
      return true;
    };
    const hasType = ensureOptions(
      itEquipmentTypeSelect,
      optionSets.types,
      '–î–æ–±–∞–≤—å—Ç–µ —Ç–∏–ø –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è¬ª',
      'equipment_type'
    );
    const hasVendor = ensureOptions(
      itEquipmentVendorSelect,
      optionSets.vendors,
      '–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è¬ª',
      'equipment_vendor'
    );
    const hasModel = ensureOptions(
      itEquipmentModelSelect,
      optionSets.models,
      '–î–æ–±–∞–≤—å—Ç–µ –º–æ–¥–µ–ª—å –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è¬ª',
      'equipment_model'
    );
    return hasType && hasVendor && hasModel;
  }

  if (itEquipmentAddModalEl) {
    itEquipmentAddModalEl.addEventListener('show.bs.modal', () => {
      const hasOptions = populateItEquipmentAddOptions();
      if (itEquipmentAddLinksContainer) {
        renderEquipmentLinks(itEquipmentAddLinksContainer, []);
      }
      if (itEquipmentAddSubmitButton) {
        itEquipmentAddSubmitButton.disabled = !hasOptions;
      }
    });
    itEquipmentAddModalEl.addEventListener('shown.bs.modal', () => {
      if (itEquipmentTypeSelect && !itEquipmentTypeSelect.disabled) {
        itEquipmentTypeSelect.focus();
      } else if (itEquipmentVendorSelect && !itEquipmentVendorSelect.disabled) {
        itEquipmentVendorSelect.focus();
      } else if (itEquipmentModelSelect && !itEquipmentModelSelect.disabled) {
        itEquipmentModelSelect.focus();
      }
    });
    itEquipmentAddModalEl.addEventListener('click', (event) => {
      const addLinkButton = event.target.closest('[data-it-equipment-add-link]');
      if (addLinkButton) {
        if (itEquipmentAddLinksContainer) {
          const item = addEquipmentLinkInput(itEquipmentAddLinksContainer, '');
          const input = item ? item.querySelector('[data-link-input]') : null;
          if (input) {
            input.focus();
          }
        }
        return;
      }
      const removeButton = event.target.closest('[data-it-equipment-link-action="remove-link"]');
      if (removeButton && itEquipmentAddLinksContainer) {
        const item = removeButton.closest('[data-link-item]');
        if (item) {
          item.remove();
          ensureEquipmentLinksPlaceholder(itEquipmentAddLinksContainer);
        }
      }
    });
  }

  [itEquipmentTypeSelect, itEquipmentVendorSelect, itEquipmentModelSelect].forEach((select) => {
    if (!select) return;
    select.addEventListener('change', () => {
      select.classList.remove('is-invalid');
    });
  });

  if (itEquipmentAddForm) {
    itEquipmentAddForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const payload = {
        equipment_type:
          itEquipmentTypeSelect && !itEquipmentTypeSelect.disabled
            ? itEquipmentTypeSelect.value.trim()
            : '',
        equipment_vendor:
          itEquipmentVendorSelect && !itEquipmentVendorSelect.disabled
            ? itEquipmentVendorSelect.value.trim()
            : '',
        equipment_model:
          itEquipmentModelSelect && !itEquipmentModelSelect.disabled
            ? itEquipmentModelSelect.value.trim()
            : '',
        photo_url: formatEquipmentLinksPayload(collectEquipmentLinks(itEquipmentAddLinksContainer)),
      };

      let hasError = false;
      if (!payload.equipment_type) {
        if (itEquipmentTypeSelect) {
          itEquipmentTypeSelect.classList.add('is-invalid');
        }
        hasError = true;
      }
      if (!payload.equipment_vendor) {
        if (itEquipmentVendorSelect) {
          itEquipmentVendorSelect.classList.add('is-invalid');
        }
        hasError = true;
      }
      if (!payload.equipment_model) {
        if (itEquipmentModelSelect) {
          itEquipmentModelSelect.classList.add('is-invalid');
        }
        hasError = true;
      }

      if (hasError) {
        const firstInvalid = [
          itEquipmentTypeSelect,
          itEquipmentVendorSelect,
          itEquipmentModelSelect,
        ].find((element) => element && element.classList.contains('is-invalid'));
        if (firstInvalid) {
          firstInvalid.focus();
        }
        return;
      }

      const button = itEquipmentAddSubmitButton;
      const originalText = button ? button.textContent : '';
      if (button) {
        button.disabled = true;
        button.textContent = '...';
      }

      try {
        const response = await fetch('/api/settings/it-equipment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await response.json();
        if (!response.ok || data.success === false) {
          throw new Error((data && data.error) || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è');
        }
        if (Array.isArray(data.items)) {
          itEquipmentItems = data.items;
        } else if (data.item) {
          itEquipmentItems.push(data.item);
        }
        renderItEquipmentTable();
        if (itEquipmentAddModal) {
          itEquipmentAddModal.hide();
        }
      } catch (error) {
        alert('‚ùå ' + (error && error.message ? error.message : error));
      } finally {
        if (button) {
          button.disabled = false;
          button.textContent = originalText || '–î–æ–±–∞–≤–∏—Ç—å';
        }
      }
    });
  }

  if (itConnectionCategorySelect) {
    rebuildItConnectionCategorySelect(itConnectionCategorySelect);
  }

  if (itConnectionAddModalEl) {
    itConnectionAddModalEl.addEventListener('show.bs.modal', () => {
      rebuildItConnectionCategorySelect(itConnectionCategorySelect, IT_CONNECTION_DEFAULT_CATEGORY);
      if (itConnectionCategorySelect) {
        itConnectionCategorySelect.value = IT_CONNECTION_DEFAULT_CATEGORY;
      }
      if (itConnectionValueInput) {
        itConnectionValueInput.value = '';
        itConnectionValueInput.classList.remove('is-invalid');
      }
    });
    itConnectionAddModalEl.addEventListener('shown.bs.modal', () => {
      if (itConnectionValueInput) {
        itConnectionValueInput.focus();
      } else if (itConnectionCategorySelect) {
        itConnectionCategorySelect.focus();
      }
    });
  }

  if (itConnectionCategoryCreateButton) {
    itConnectionCategoryCreateButton.addEventListener('click', async () => {
      const promptMessage = '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
      let label = window.prompt(promptMessage);
      if (label === null) {
        return;
      }
      label = String(label).trim();
      if (!label) {
        alert('–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
        return;
      }
      itConnectionCategoryCreateButton.disabled = true;
      try {
        const response = await fetch('/api/settings/it-connection-categories', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ label }),
        });
        const data = await response.json();
        if (!response.ok || data.success === false) {
          throw new Error((data && data.error) || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
        }
        const payload = (data && data.data) || {};
        const categories = payload.categories || {};
        const createdKey = payload.key || null;
        setItConnectionCategories(categories, { selectedKey: createdKey });
        renderItConnectionsTable();
        if (createdKey && itConnectionCategorySelect) {
          itConnectionCategorySelect.value = createdKey;
        }
        if (itConnectionValueInput) {
          itConnectionValueInput.focus();
        }
      } catch (error) {
        const message = error && error.message ? error.message : error;
        alert('‚ùå ' + message);
      } finally {
        itConnectionCategoryCreateButton.disabled = false;
      }
    });
  }

  if (itConnectionValueInput) {
    itConnectionValueInput.addEventListener('input', () => {
      itConnectionValueInput.classList.remove('is-invalid');
    });
  }

  if (itConnectionAddForm) {
    itConnectionAddForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const selected =
        itConnectionCategorySelect && itConnectionCategorySelect.value
          ? itConnectionCategorySelect.value
          : IT_CONNECTION_DEFAULT_CATEGORY;
      const payload = buildItConnectionPayload(selected, itConnectionValueInput ? itConnectionValueInput.value : '');
      if (!payload.value) {
        if (itConnectionValueInput) {
          itConnectionValueInput.classList.add('is-invalid');
          itConnectionValueInput.focus();
        }
        return;
      }

      const submitButton = itConnectionAddForm.querySelector('button[type="submit"]');
      const originalButtonText = submitButton ? submitButton.textContent : '';
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = '...';
      }

      try {
        const response = await fetch('/api/settings/parameters', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(Object.assign({ param_type: 'it_connection' }, payload)),
        });
        const data = await response.json();
        if (!response.ok || data.success === false) {
          throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
        }
        if (itConnectionValueInput) {
          itConnectionValueInput.value = '';
          itConnectionValueInput.classList.remove('is-invalid');
        }
        syncParameterData((data && data.data) || parameterData);
        renderParameters({ forceBodies: true });
        renderItConnectionsTable();
        if (parameterModal && parameterModalType) {
          renderParameterModal(parameterModalType);
        }
        if (itConnectionAddModal) {
          itConnectionAddModal.hide();
        }
        setTimeout(() => {
          if (!itConnectionsContainer) return;
          const rows = Array.from(itConnectionsContainer.querySelectorAll('tr'));
          const createdRow = rows.find((row) => {
            const input = row.querySelector('[data-field="value"]');
            return input && input.value.trim() === payload.value;
          });
          if (createdRow) {
            const input = createdRow.querySelector('[data-field="value"]');
            if (input) input.focus();
          }
        }, 0);
      } catch (error) {
        const message = error && error.message ? error.message : error;
        alert('‚ùå ' + message);
      } finally {
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = originalButtonText;
        }
      }
    });
  }

  window.addItConnectionRow = addItConnectionRow;

  renderNetworkProfiles();
  renderItConnectionsTable();
  loadItEquipment();

  const itSectionTilesContainer = document.querySelector('[data-it-section-tiles]');

  function activateItSectionTile(targetSelector) {
    if (!itSectionTilesContainer) return;
    const tiles = Array.from(
      itSectionTilesContainer.querySelectorAll('[data-it-section-target]')
    );
    tiles.forEach((tile) => {
      const matches = tile.dataset.itSectionTarget === targetSelector;
      tile.classList.toggle('is-active', matches);
      tile.setAttribute('aria-pressed', matches ? 'true' : 'false');
    });
  }

  if (itSectionTilesContainer) {
    const tiles = Array.from(
      itSectionTilesContainer.querySelectorAll('[data-it-section-target]')
    );
    tiles.forEach((tile) => {
      if (!tile.hasAttribute('role')) {
        tile.setAttribute('role', 'button');
      }
      if (!tile.hasAttribute('tabindex')) {
        tile.setAttribute('tabindex', '0');
      }
      tile.setAttribute('aria-pressed', 'false');
    });

    const collapses = Array.from(
      document.querySelectorAll('#itSettingsAccordion .accordion-collapse')
    );

    itSectionTilesContainer.addEventListener('click', (event) => {
      const tile = event.target.closest('[data-it-section-target]');
      if (!tile) return;
      const targetSelector = tile.dataset.itSectionTarget;
      if (!targetSelector) return;
      const target = document.querySelector(targetSelector);
      if (!target) return;
      const collapse = bootstrap.Collapse.getOrCreateInstance(target, { toggle: false });
      collapse.show();
      activateItSectionTile(targetSelector);
      setTimeout(() => {
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 50);
    });

    itSectionTilesContainer.addEventListener('keydown', (event) => {
      if (event.key !== 'Enter' && event.key !== ' ') return;
      const tile = event.target.closest('[data-it-section-target]');
      if (!tile) return;
      event.preventDefault();
      tile.click();
    });

    collapses.forEach((collapseEl) => {
      collapseEl.addEventListener('shown.bs.collapse', () => {
        activateItSectionTile(`#${collapseEl.id}`);
      });
    });

    const initiallyShown = collapses.find((collapseEl) => collapseEl.classList.contains('show'));
    if (initiallyShown) {
      activateItSectionTile(`#${initiallyShown.id}`);
    }
  }

  async function loadParameters() {
    try {
      parametersLoaded = false;
      const response = await fetch('/api/settings/parameters');
      if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤');
      const data = await response.json();
      syncParameterData((data && data.data) || data || parameterData);
      parametersLoaded = true;
      renderParameters({ forceBodies: true });
      renderCityCard();
      renderItConnectionsTable();
      buildLocationsTree();
      if (parameterModal && parameterModalType) {
        renderParameterModal(parameterModalType);
      }
    } catch (error) {
      parametersLoaded = false;
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:', error);
      const message = error && error.message ? error.message : error;
      alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: ' + message);
    }
  }

  async function createParameter(type, trigger) {
    const container = findParameterContainer(trigger);
    if (!container) return;
    const input = container.querySelector('[data-param-input]');
    if (!input) return;
    const value = input.value.trim();
    if (!value) {
      input.focus();
      return;
    }
    const stateSelect = container.querySelector('[data-param-state-input]');
    let serverNameInput = null;
    let serverName = '';
    if (type === 'iiko_server') {
      serverNameInput = container.querySelector('[data-param-create-field="server_name"]');
      serverName = serverNameInput ? serverNameInput.value.trim() : '';
      if (!serverName) {
        if (serverNameInput) {
          serverNameInput.focus();
        }
        alert('–ü–æ–ª–µ ¬´–ò–º—è —Å–µ—Ä–≤–µ—Ä–∞¬ª –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ');
        return;
      }
    }
    const dependencyResult = collectDependencyValues(container, type);
    if (dependencyResult.error) {
      alert('‚ùå ' + dependencyResult.error);
      if (dependencyResult.field) {
        dependencyResult.field.focus();
      }
      return;
    }
    const payload = { param_type: type, value };
    if (stateSelect && PARAMETER_STATE_TYPES.has(type)) {
      payload.state = stateSelect.value;
    }
    if (type === 'iiko_server') {
      payload.server_name = serverName;
    }
    Object.assign(payload, dependencyResult.values);

    const originalText = trigger.textContent;
    trigger.disabled = true;
    trigger.textContent = '...';

    try {
      const response = await fetch('/api/settings/parameters', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞');
      }
      syncParameterData((data && data.data) || parameterData);
      input.value = '';
      if (serverNameInput) {
        serverNameInput.value = '';
      }
      if (stateSelect) {
        stateSelect.value = PARAMETER_STATES[0];
      }
      renderParameters({ forceBodies: true });
      renderItConnectionsTable();
      if (parameterModal && parameterModalType === type) {
        renderParameterModal(type);
      }
    } catch (error) {
      const message = error && error.message ? error.message : error;
      alert('‚ùå ' + message);
    } finally {
      trigger.disabled = false;
      trigger.textContent = originalText;
    }
  }

  async function updateParameterValue(id, type, trigger) {
    const entry = trigger.closest('[data-param-id]');
    if (!entry) return;
    const input = entry.querySelector('input[data-param-field="value"]');
    if (!input) return;
    const value = input.value.trim();
    if (!value) {
      alert('–ó–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
      input.focus();
      return;
    }
    let serverNameInput = null;
    let serverName = '';
    if (type === 'iiko_server') {
      serverNameInput = entry.querySelector('input[data-param-field="server_name"]');
      serverName = serverNameInput ? serverNameInput.value.trim() : '';
      if (!serverName) {
        alert('–ò–º—è —Å–µ—Ä–≤–µ—Ä–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ');
        if (serverNameInput) {
          serverNameInput.focus();
        }
        return;
      }
    }

    trigger.disabled = true;

    try {
      const payload = { value };
      if (type === 'iiko_server') {
        payload.server_name = serverName;
      }
      const dependencyResult = collectDependencyValues(entry, type);
      if (dependencyResult.error) {
        alert('‚ùå ' + dependencyResult.error);
        if (dependencyResult.field) {
          dependencyResult.field.focus();
        }
        trigger.disabled = false;
        return;
      }
      Object.assign(payload, dependencyResult.values);
      const response = await fetch(`/api/settings/parameters/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
      }
      syncParameterData((data && data.data) || parameterData);
      renderParameters({ forceBodies: true });
      renderItConnectionsTable();
      if (parameterModal && parameterModalType === type) {
        renderParameterModal(type);
      }
    } catch (error) {
      const message = error && error.message ? error.message : error;
      alert('‚ùå ' + message);
    } finally {
      trigger.disabled = false;
    }
  }

  async function updateParameterState(id, type, select) {
    const previous = select.dataset.paramCurrentState || select.value;
    select.disabled = true;

    try {
      const response = await fetch(`/api/settings/parameters/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ state: select.value })
      });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è');
      }
      syncParameterData((data && data.data) || parameterData);
      renderParameters({ forceBodies: true });
      if (parameterModal && parameterModalType === type) {
      renderItConnectionsTable();
        renderParameterModal(type);
      }
      select.dataset.paramCurrentState = select.value;
    } catch (error) {
      const message = error && error.message ? error.message : error;
      alert('‚ùå ' + message);
      select.value = previous;
    } finally {
      select.disabled = false;
    }
  }

  async function deleteParameter(id, type, trigger) {
    const confirmations = [
      '–£–¥–∞–ª–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ?',
      '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ: –∑–∞–ø–∏—Å—å –±—É–¥–µ—Ç –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ —É–¥–∞–ª—ë–Ω–Ω–∞—è.',
      '–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?'
    ];
    for (const message of confirmations) {
      if (!confirm(message)) {
        return;
      }
    }

    trigger.disabled = true;

    try {
      const response = await fetch(`/api/settings/parameters/${id}`, {
        method: 'DELETE'
      });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
      }
      syncParameterData((data && data.data) || parameterData);
      renderParameters({ forceBodies: true });
      renderItConnectionsTable();
      if (parameterModal && parameterModalType === type) {
        renderParameterModal(type);
      }
    } catch (error) {
      const message = error && error.message ? error.message : error;
      alert('‚ùå ' + message);
    } finally {
      trigger.disabled = false;
    }
  }

  async function restoreParameter(id, type, trigger) {
    trigger.disabled = true;
    try {
      const response = await fetch(`/api/settings/parameters/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_deleted: false })
      });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || '–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è');
      }
      syncParameterData((data && data.data) || parameterData);
      renderParameters({ forceBodies: true });
      renderItConnectionsTable();
      if (parameterModal && parameterModalType === type) {
        renderParameterModal(type);
      }
    } catch (error) {
      const message = error && error.message ? error.message : error;
      alert('‚ùå ' + message);
    } finally {
      trigger.disabled = false;
    }
  }

  // === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ ===
  const STATUS_FILTER_BASE_URL = "{{ url_for('clients_list') }}";
  let CLIENT_STATUS_USAGE = {{ status_usage | tojson }} || {};
  const INITIAL_CLIENT_STATUSES = {{ settings.client_statuses | tojson }} || [];
  const INITIAL_CLIENT_STATUS_COLORS = {{ settings.client_status_colors | tojson }} || {};
  const STATUS_COLOR_FALLBACK = '#0d6efd';
  let CLIENT_STATUS_COLORS = sanitizeStatusColorMap(INITIAL_CLIENT_STATUS_COLORS);
  let statusEditMode = false;
  let initialStatusesSnapshot = [];

  function isValidHexColor(value) {
    return typeof value === 'string' && /^#(?:[0-9a-f]{6})$/i.test(value.trim());
  }

  function sanitizeColorValue(value) {
    const raw = typeof value === 'string' ? value.trim() : String(value || '');
    return isValidHexColor(raw) ? raw.toLowerCase() : STATUS_COLOR_FALLBACK;
  }

  function sanitizeStatusColorMap(source) {
    const map = {};
    if (!source || typeof source !== 'object') {
      return map;
    }
    Object.entries(source).forEach(([key, value]) => {
      if (typeof key !== 'string') {
        return;
      }
      const label = key.trim();
      if (!label) {
        return;
      }
      map[label] = sanitizeColorValue(value);
    });
    return map;
  }

  function resolveStatusColor(status) {
    const label = typeof status === 'string' ? status.trim() : '';
    if (label && CLIENT_STATUS_COLORS && CLIENT_STATUS_COLORS[label]) {
      return sanitizeColorValue(CLIENT_STATUS_COLORS[label]);
    }
    return STATUS_COLOR_FALLBACK;
  }

  function normalizeStatusItem(entry) {
    if (entry && typeof entry === 'object') {
      const rawValue =
        typeof entry.value === 'string'
          ? entry.value
          : typeof entry.label === 'string'
          ? entry.label
          : typeof entry.status === 'string'
          ? entry.status
          : '';
      const value = rawValue.trim();
      const colorSource =
        entry.color || entry.colour || entry.hex || (value ? CLIENT_STATUS_COLORS?.[value] : '');
      return { value, color: sanitizeColorValue(colorSource || resolveStatusColor(value)) };
    }
    const value = typeof entry === 'string' ? entry.trim() : '';
    return { value, color: resolveStatusColor(value) };
  }

  function buildStatusFilterLink(status) {
    const value = typeof status === 'string' ? status.trim() : '';
    if (!value) return '#';
    const params = new URLSearchParams({ client_status: value });
    return `${STATUS_FILTER_BASE_URL}?${params.toString()}`;
  }

  function handleStatusInputChange(row) {
    if (!(row instanceof HTMLElement)) return;
    const input = row.querySelector('.status-input');
    const link = row.querySelector('.status-count-link');
    const colorPreview = row.querySelector('.status-color-preview');
    if (!(input instanceof HTMLInputElement) || !(link instanceof HTMLAnchorElement)) return;

    const value = input.value.trim();
    const original = row.dataset.originalValue || '';
    const baseCount = Number(row.dataset.count || 0);
    let displayCount = baseCount;

    if (colorPreview instanceof HTMLElement) {
      colorPreview.title = value ? `–¶–≤–µ—Ç —Å—Ç–∞—Ç—É—Å–∞ ¬´${value}¬ª` : '–¶–≤–µ—Ç —Å—Ç–∞—Ç—É—Å–∞';
    }

    if (!value) {
      link.textContent = '0';
      link.href = '#';
      link.classList.add('disabled');
      return;
    }

    if (value !== original) {
      displayCount = 0;
    }

    link.textContent = String(displayCount);
    link.href = buildStatusFilterLink(value);
    link.classList.toggle('disabled', statusEditMode);
  }

  function buildStatusRow(status) {
    const { value, color } = normalizeStatusItem(status);
    const container = document.createElement('div');
    container.className = 'list-group-item d-flex align-items-center gap-3 status-row';
    const count = Number((CLIENT_STATUS_USAGE && CLIENT_STATUS_USAGE[value]) || 0);
    container.dataset.originalValue = value;
    container.dataset.count = String(count);
    container.dataset.color = color;

    const main = document.createElement('div');
    main.className = 'status-row-main flex-grow-1';

    const colorPreview = document.createElement('span');
    colorPreview.className = 'status-color-preview';
    colorPreview.style.setProperty('--status-color', color);
    colorPreview.title = value ? `–¶–≤–µ—Ç —Å—Ç–∞—Ç—É—Å–∞ ¬´${value}¬ª` : '–¶–≤–µ—Ç —Å—Ç–∞—Ç—É—Å–∞';
    main.appendChild(colorPreview);

    const colorInput = document.createElement('input');
    colorInput.type = 'color';
    colorInput.className = 'status-color-input form-control form-control-color';
    colorInput.value = color;
    colorInput.disabled = !statusEditMode;
    if (!statusEditMode) {
      colorInput.classList.add('d-none');
    }
    colorInput.addEventListener('input', () => {
      const sanitized = sanitizeColorValue(colorInput.value);
      colorInput.value = sanitized;
      container.dataset.color = sanitized;
      colorPreview.style.setProperty('--status-color', sanitized);
    });
    main.appendChild(colorInput);

    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'form-control status-input';
    input.value = value;
    input.disabled = !statusEditMode;
    input.placeholder = '–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å';
    input.addEventListener('input', () => handleStatusInputChange(container));
    main.appendChild(input);

    container.appendChild(main);

    const badge = document.createElement('a');
    badge.className = 'status-count-link';
    badge.dataset.statusCount = 'true';
    badge.title = value ? `–ö–ª–∏–µ–Ω—Ç–æ–≤ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º ¬´${value}¬ª` : '–ö–ª–∏–µ–Ω—Ç–æ–≤ —Å —ç—Ç–∏–º —Å—Ç–∞—Ç—É—Å–æ–º';
    badge.href = buildStatusFilterLink(value);
    badge.textContent = String(count);
    if (!value || statusEditMode) {
      badge.classList.add('disabled');
    }
    container.appendChild(badge);

    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-outline-danger btn-sm';
    removeBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
    if (!statusEditMode) {
      removeBtn.classList.add('d-none');
    }
    removeBtn.dataset.statusRemove = 'true';
    removeBtn.addEventListener('click', () => removeStatus(removeBtn));
    container.appendChild(removeBtn);

    handleStatusInputChange(container);
    return container;
  }

  function renderStatusesList(statuses) {
    const list = document.getElementById('statusesList');
    const placeholder = document.getElementById('statusesEmptyPlaceholder');
    if (!list) return;
    list.innerHTML = '';
    const items = Array.isArray(statuses) ? statuses : [];
    if (!items.length) {
      if (placeholder) placeholder.classList.remove('d-none');
      return;
    }
    if (placeholder) placeholder.classList.add('d-none');
    items.forEach((status) => {
      const row = buildStatusRow(status);
      list.appendChild(row);
    });
    updateStatusesEmptyState();
  }

  function updateStatusesEmptyState() {
    const list = document.getElementById('statusesList');
    const placeholder = document.getElementById('statusesEmptyPlaceholder');
    if (!list || !placeholder) return;
    const hasRows = Boolean(list.querySelector('.status-row'));
    placeholder.classList.toggle('d-none', hasRows);
  }

  function collectStatusItems() {
    return Array.from(document.querySelectorAll('#statusesList .status-row'))
      .map((row) => {
        const input = row.querySelector('.status-input');
        const colorInput = row.querySelector('.status-color-input');
        const preview = row.querySelector('.status-color-preview');
        const value = input instanceof HTMLInputElement ? input.value.trim() : '';
        const rawColor = colorInput instanceof HTMLInputElement ? colorInput.value : row.dataset.color;
        const color = sanitizeColorValue(rawColor);
        row.dataset.color = color;
        if (preview instanceof HTMLElement) {
          preview.style.setProperty('--status-color', color);
        }
        return { value, color };
      })
      .filter((item) => Boolean(item.value));
  }

  function setStatusesEditMode(enable, { restoreSnapshot = false } = {}) {
    statusEditMode = Boolean(enable);
    const editBtn = document.getElementById('editStatusesBtn');
    const saveBtn = document.getElementById('saveStatusesBtn');
    const cancelBtn = document.getElementById('cancelStatusesBtn');
    const addBtn = document.getElementById('addStatusBtn');

    if (editBtn) editBtn.classList.toggle('d-none', statusEditMode);
    if (saveBtn) saveBtn.classList.toggle('d-none', !statusEditMode);
    if (cancelBtn) cancelBtn.classList.toggle('d-none', !statusEditMode);
    if (addBtn) addBtn.classList.toggle('d-none', !statusEditMode);

    if (!statusEditMode && restoreSnapshot) {
      renderStatusesList(initialStatusesSnapshot);
    }

    document.querySelectorAll('#statusesList .status-row').forEach((row) => {
      const input = row.querySelector('.status-input');
      const removeBtn = row.querySelector('[data-status-remove]');
      const badge = row.querySelector('.status-count-link');
      const colorInput = row.querySelector('.status-color-input');
      if (input instanceof HTMLInputElement) {
        input.disabled = !statusEditMode;
      }
      if (colorInput instanceof HTMLInputElement) {
        colorInput.disabled = !statusEditMode;
        colorInput.classList.toggle('d-none', !statusEditMode);
      }
      if (removeBtn instanceof HTMLElement) {
        removeBtn.classList.toggle('d-none', !statusEditMode);
      }
      if (badge instanceof HTMLElement) {
        badge.classList.toggle('disabled', statusEditMode || !(input?.value.trim()));
      }
      handleStatusInputChange(row);
    });
  }

  function startStatusesEdit() {
    initialStatusesSnapshot = collectStatusItems();
    setStatusesEditMode(true);
  }

  function cancelStatusesEdit() {
    setStatusesEditMode(false, { restoreSnapshot: true });
  }

  function addStatus() {
    if (!statusEditMode) return;
    const list = document.getElementById('statusesList');
    if (!list) return;
    const row = buildStatusRow('');
    row.dataset.originalValue = '';
    row.dataset.count = '0';
    list.appendChild(row);
    updateStatusesEmptyState();
    const input = row.querySelector('.status-input');
    if (input instanceof HTMLInputElement) {
      setTimeout(() => input.focus(), 0);
    }
  }

  function removeStatus(trigger) {
    const row = trigger?.closest('.status-row');
    if (row) {
      row.remove();
      updateStatusesEmptyState();
    }
  }

  function syncStatusUsage(statuses) {
    const usage = {};
    const currentUsage = CLIENT_STATUS_USAGE || {};
    statuses.forEach((status) => {
      if (Object.prototype.hasOwnProperty.call(currentUsage, status)) {
        usage[status] = currentUsage[status];
      } else {
        usage[status] = 0;
      }
    });
    CLIENT_STATUS_USAGE = usage;
  }

  async function saveClientStatuses() {
    const saveBtn = document.getElementById('saveStatusesBtn');
    const items = collectStatusItems();
    const statuses = items.map((item) => item.value);
    const colors = items.reduce((acc, item) => {
      acc[item.value] = item.color;
      return acc;
    }, {});
    if (!statuses.length) {
      if (confirm('–°–ø–∏—Å–æ–∫ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø—É—Å—Ç. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å—Ç–∞—Ç—É—Å—ã?')) {
        // proceed
      } else {
        return;
      }
    }
    if (saveBtn) saveBtn.disabled = true;
    try {
      const response = await fetch('/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ client_statuses: statuses, client_status_colors: colors })
      });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã');
      }
      syncStatusUsage(statuses);
      CLIENT_STATUS_COLORS = sanitizeStatusColorMap(colors);
      renderStatusesList(items);
      setStatusesEditMode(false);
      alert('‚úÖ –°—Ç–∞—Ç—É—Å—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
    } catch (error) {
      const message = error && error.message ? error.message : String(error);
      alert('‚ùå –û—à–∏–±–∫–∞: ' + message);
    } finally {
      if (saveBtn) saveBtn.disabled = false;
    }
  }

  function initClientStatuses() {
    CLIENT_STATUS_COLORS = sanitizeStatusColorMap(INITIAL_CLIENT_STATUS_COLORS);
    renderStatusesList(Array.isArray(INITIAL_CLIENT_STATUSES) ? INITIAL_CLIENT_STATUSES : []);
    updateStatusesEmptyState();
    setStatusesEditMode(false);
  }

  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–æ–º ===
  document.addEventListener('DOMContentLoaded', () => {
    const usersModalEl = document.getElementById('usersModal');
    if (!usersModalEl) {
      return;
    }

    usersModalEl.addEventListener('shown.bs.modal', () => {
      const container = usersModalEl.querySelector('[data-auth-management]');
      if (!container || !window.AuthManagement) {
        console.error('–ú–æ–¥—É–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–æ–º –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.');
        return;
      }
      if (!container.__authManager) {
        container.__authManager = window.AuthManagement.mount(container);
      } else {
        container.__authManager.refresh();
      }
    });

    usersModalEl.addEventListener('hidden.bs.modal', () => {
      const container = usersModalEl.querySelector('[data-auth-management]');
      const manager = container && container.__authManager;
      if (manager) {
        manager.resetPasswords();
        manager.clearMessage();
      }
    });
  });

  // === JavaScript –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ª–æ–∫–∞—Ü–∏–π ===
  const LOCATION_STATUS_OPTIONS = [
    '–ê–∫—Ç–∏–≤–µ–Ω',
    '–ó–∞–∫—Ä—ã—Ç',
    '–ì–æ—Ç–æ–≤–∏—Ç—Å—è –∫ –∑–∞–ø—É—Å–∫—É',
    '–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω',
    '–ó–∞–º–æ—Ä–æ–∂–µ–Ω',
  ];
  const DEFAULT_LOCATION_STATUS = LOCATION_STATUS_OPTIONS[0];
  const LOCATION_STATUS_CLASS_MAP = {
    –ê–∫—Ç–∏–≤–µ–Ω: 'status-active',
    –ó–∞–∫—Ä—ã—Ç: 'status-closed',
    '–ì–æ—Ç–æ–≤–∏—Ç—Å—è –∫ –∑–∞–ø—É—Å–∫—É': 'status-prelaunch',
    –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: 'status-paused',
    –ó–∞–º–æ—Ä–æ–∂–µ–Ω: 'status-frozen',
  };
  const LOCATION_STATUS_DEFAULT_CLASS = 'status-default';
  const EDIT_ICON_HTML = '<i class="bi bi-pencil"></i>';
  const SAVE_ICON_HTML = '<i class="bi bi-check-lg"></i>';
  const DELETE_ICON_HTML = '<i class="bi bi-trash"></i>';
  const COLLAPSE_ICON_HTML = '<i class="bi bi-chevron-down"></i>';
  const EXPAND_ICON_HTML = '<i class="bi bi-chevron-right"></i>';
  const LOCATIONS_INITIAL = {{ locations | tojson }};
  const collapsedLocationNodes = new Set();

  function sanitizeStatusesMap(source) {
    const result = {};
    if (!source || typeof source !== 'object') {
      return result;
    }
    Object.entries(source).forEach(([key, value]) => {
      if (typeof key !== 'string') return;
      const raw = typeof value === 'string' ? value.trim() : '';
      result[key] = LOCATION_STATUS_OPTIONS.includes(raw) ? raw : DEFAULT_LOCATION_STATUS;
    });
    return result;
  }

  function sortObjectAlphabetically(obj) {
    if (!obj || typeof obj !== 'object') {
      return {};
    }
    return Object.keys(obj)
      .sort((a, b) => a.localeCompare(b))
      .reduce((sorted, key) => {
        sorted[key] = obj[key];
        return sorted;
      }, {});
  }

  function sortArrayAlphabetically(arr) {
    return Array.isArray(arr) ? arr.slice().sort((a, b) => a.localeCompare(b)) : [];
  }

  function normalizeLocationTree(tree) {
    if (!tree || typeof tree !== 'object') {
      return {};
    }
    const normalized = {};
    Object.keys(tree)
      .sort((a, b) => a.localeCompare(b))
      .forEach((business) => {
        const types = tree[business];
        if (!types || typeof types !== 'object') {
          normalized[business] = {};
          return;
        }
        const sortedTypes = {};
        Object.keys(types)
          .sort((a, b) => a.localeCompare(b))
          .forEach((type) => {
            const cities = types[type];
            if (Array.isArray(cities)) {
              sortedTypes[type] = sortArrayAlphabetically(cities);
            } else if (cities && typeof cities === 'object') {
              const sortedCities = {};
              Object.keys(cities)
                .sort((a, b) => a.localeCompare(b))
                .forEach((city) => {
                  sortedCities[city] = sortArrayAlphabetically(cities[city]);
                });
              sortedTypes[type] = sortedCities;
            } else {
              sortedTypes[type] = {};
            }
          });
        normalized[business] = sortedTypes;
      });
    return normalized;
  }

  let locationsState = {
    tree:
      LOCATIONS_INITIAL &&
      typeof LOCATIONS_INITIAL === 'object' &&
      LOCATIONS_INITIAL.tree &&
      typeof LOCATIONS_INITIAL.tree === 'object'
        ? normalizeLocationTree(LOCATIONS_INITIAL.tree)
        : normalizeLocationTree(LOCATIONS_INITIAL || {}),
    statuses: sanitizeStatusesMap(
      LOCATIONS_INITIAL && typeof LOCATIONS_INITIAL === 'object' ? LOCATIONS_INITIAL.statuses : {}
    ),
  };

  function makeStatusKey(level, ...parts) {
    return [level].concat(parts).join('::');
  }

  function getStatus(level, ...parts) {
    const key = makeStatusKey(level, ...parts);
    const stored = locationsState.statuses && locationsState.statuses[key];
    if (typeof stored === 'string' && LOCATION_STATUS_OPTIONS.includes(stored)) {
      return stored;
    }
    return DEFAULT_LOCATION_STATUS;
  }

  function setStatus(level, parts, status) {
    const resolved = LOCATION_STATUS_OPTIONS.includes(status) ? status : DEFAULT_LOCATION_STATUS;
    const key = makeStatusKey(level, ...parts);
    locationsState.statuses[key] = resolved;
  }

  function renameStatusEntries(level, context, oldName, newName) {
    if (!oldName || oldName === newName) {
      return;
    }
    const updates = [];
    Object.keys(locationsState.statuses || {}).forEach((key) => {
      const parts = key.split('::');
      const kind = parts[0];
      if (level === 'business') {
        if (parts[1] === oldName) {
          parts[1] = newName;
          updates.push([key, parts.join('::')]);
        }
      } else if (level === 'type') {
        if (
          ['type', 'city', 'location'].includes(kind) &&
          parts[1] === context.business &&
          parts[2] === oldName
        ) {
          parts[2] = newName;
          updates.push([key, parts.join('::')]);
        }
      } else if (level === 'city') {
        if (
          ['city', 'location'].includes(kind) &&
          parts[1] === context.business &&
          parts[2] === context.type &&
          parts[3] === oldName
        ) {
          parts[3] = newName;
          updates.push([key, parts.join('::')]);
        }
      } else if (level === 'location') {
        if (
          kind === 'location' &&
          parts[1] === context.business &&
          parts[2] === context.type &&
          parts[3] === context.city &&
          parts[4] === oldName
        ) {
          parts[4] = newName;
          updates.push([key, parts.join('::')]);
        }
      }
    });
    updates.forEach(([oldKey, newKey]) => {
      locationsState.statuses[newKey] = locationsState.statuses[oldKey];
      if (oldKey !== newKey) {
        delete locationsState.statuses[oldKey];
      }
    });
  }

  function removeStatusEntries(level, context, targetName) {
    Object.keys(locationsState.statuses || {}).forEach((key) => {
      const parts = key.split('::');
      const kind = parts[0];
      let shouldDelete = false;
      if (level === 'business') {
        shouldDelete = parts[1] === targetName;
      } else if (level === 'type') {
        shouldDelete =
          ['type', 'city', 'location'].includes(kind) &&
          parts[1] === context.business &&
          parts[2] === targetName;
      } else if (level === 'city') {
        shouldDelete =
          ['city', 'location'].includes(kind) &&
          parts[1] === context.business &&
          parts[2] === context.type &&
          parts[3] === targetName;
      } else if (level === 'location') {
        shouldDelete =
          kind === 'location' &&
          parts[1] === context.business &&
          parts[2] === context.type &&
          parts[3] === context.city &&
          parts[4] === targetName;
      }
      if (shouldDelete) {
        delete locationsState.statuses[key];
      }
    });
  }

  function makeCollapseKey(level, ...parts) {
    return ['collapse', level].concat(parts).join('::');
  }

  function pruneCollapsedNodes(tree) {
    const validKeys = new Set();
    Object.keys(tree || {}).forEach((business) => {
      validKeys.add(makeCollapseKey('business', business));
      const types = tree[business] || {};
      if (types && typeof types === 'object') {
        Object.keys(types).forEach((type) => {
          validKeys.add(makeCollapseKey('type', business, type));
          const cities = types[type];
          if (cities && typeof cities === 'object' && !Array.isArray(cities)) {
            Object.keys(cities).forEach((city) => {
              validKeys.add(makeCollapseKey('city', business, type, city));
            });
          }
        });
      }
    });
    Array.from(collapsedLocationNodes).forEach((key) => {
      if (!validKeys.has(key)) {
        collapsedLocationNodes.delete(key);
      }
    });
  }

  function setupTreeToggle(button, childrenList, key) {
    if (!(button instanceof HTMLElement) || !(childrenList instanceof HTMLElement) || !key) {
      return;
    }
    button.setAttribute('data-no-toggle', 'true');
    let isCollapsed = collapsedLocationNodes.has(key);

    const setCollapsed = (nextState) => {
      isCollapsed = nextState;
      if (isCollapsed) {
        collapsedLocationNodes.add(key);
      } else {
        collapsedLocationNodes.delete(key);
      }
      childrenList.classList.toggle('is-collapsed', isCollapsed);
      button.setAttribute('aria-expanded', isCollapsed ? 'false' : 'true');
      button.innerHTML = isCollapsed ? EXPAND_ICON_HTML : COLLAPSE_ICON_HTML;
      const title = isCollapsed ? '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤–µ—Ç–∫—É' : '–°–≤–µ—Ä–Ω—É—Ç—å –≤–µ—Ç–∫—É';
      button.title = title;
      button.setAttribute('aria-label', title);
    };

    button.addEventListener('click', (event) => {
      event.preventDefault();
      event.stopPropagation();
      setCollapsed(!isCollapsed);
    });

    setCollapsed(isCollapsed);
  }

  function createStatusSelect(level, parts) {
    const select = document.createElement('select');
    select.className = 'form-select form-select-sm location-status-select';
    select.setAttribute('data-no-toggle', 'true');
    LOCATION_STATUS_OPTIONS.forEach((option) => {
      const opt = document.createElement('option');
      opt.value = option;
      opt.textContent = option;
      select.appendChild(opt);
    });
    select.value = getStatus(level, ...parts);
    select.disabled = true;
    return select;
  }

  function applyStatusStyle(element, status) {
    if (!element) return;
    const classesToRemove = new Set(Object.values(LOCATION_STATUS_CLASS_MAP));
    classesToRemove.add(LOCATION_STATUS_DEFAULT_CLASS);
    classesToRemove.forEach((cls) => {
      if (cls) {
        element.classList.remove(cls);
      }
    });
    const targetClass = LOCATION_STATUS_CLASS_MAP[status] || LOCATION_STATUS_DEFAULT_CLASS;
    if (targetClass) {
      element.classList.add(targetClass);
    }
  }

  function configureEditControls({ input, statusSelect, editButton, deleteButton, onSubmit, onReset }) {
    const fields = [];
    if (input) {
      input.disabled = true;
      input.setAttribute('data-no-toggle', 'true');
      input.dataset.originalValue = input.value;
      fields.push(input);
    }
    if (statusSelect) {
      statusSelect.disabled = true;
      statusSelect.dataset.originalValue = statusSelect.value;
      fields.push(statusSelect);
    }
    if (!editButton) {
      return;
    }
    editButton.dataset.mode = 'view';
    editButton.setAttribute('data-no-toggle', 'true');
    editButton.innerHTML = EDIT_ICON_HTML;
    editButton.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';

    if (deleteButton) {
      deleteButton.disabled = true;
      deleteButton.setAttribute('data-no-toggle', 'true');
    }

    const enterEdit = () => {
      fields.forEach((field) => {
        field.disabled = false;
      });
      editButton.dataset.mode = 'edit';
      editButton.innerHTML = SAVE_ICON_HTML;
      editButton.title = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
      editButton.classList.remove('btn-outline-secondary');
      editButton.classList.add('btn-outline-success');
      if (deleteButton) {
        deleteButton.disabled = false;
      }
      if (input) {
        input.focus();
        input.select();
      }
    };

    const exitEdit = () => {
      fields.forEach((field) => {
        field.disabled = true;
      });
      editButton.dataset.mode = 'view';
      editButton.innerHTML = EDIT_ICON_HTML;
      editButton.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
      editButton.classList.remove('btn-outline-success');
      editButton.classList.add('btn-outline-secondary');
      if (deleteButton) {
        deleteButton.disabled = true;
      }
    };

    const resetFields = () => {
      if (typeof onReset === 'function') {
        onReset();
        return;
      }
      if (input) {
        input.value = input.dataset.originalValue || input.value;
      }
      if (statusSelect) {
        statusSelect.value = statusSelect.dataset.originalValue || statusSelect.value;
      }
    };

    const applySubmit = () => {
      if (typeof onSubmit !== 'function') {
        exitEdit();
        return;
      }
      const nameValue = input ? (input.value || '').trim() : '';
      const statusValue = statusSelect ? statusSelect.value : undefined;
      const result = onSubmit(nameValue, { status: statusValue });
      if (result === false) {
        return;
      }
      if (input) {
        input.dataset.originalValue = input.value;
      }
      if (statusSelect) {
        statusSelect.dataset.originalValue = statusSelect.value;
      }
      exitEdit();
    };

    editButton.addEventListener('click', () => {
      if (editButton.dataset.mode === 'edit') {
        applySubmit();
      } else {
        enterEdit();
      }
    });

    if (input) {
      input.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          applySubmit();
        } else if (event.key === 'Escape') {
          event.preventDefault();
          resetFields();
          exitEdit();
        }
      });
    }

    if (statusSelect) {
      statusSelect.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          event.preventDefault();
          resetFields();
          exitEdit();
        }
      });
    }
  }

  function confirmMultipleTimes(message, attempts = 3) {
    const total = Number.isFinite(Number(attempts)) && attempts > 0 ? Math.ceil(attempts) : 1;
    for (let i = 1; i <= total; i += 1) {
      const suffix = total > 1 ? `\n–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ (${i}/${total})` : '';
      if (!confirm(`${message}${suffix}`)) {
        return false;
      }
    }
    return true;
  }


  function getTypeMetrics(cities) {
    if (!cities || typeof cities !== 'object') {
      return { cityCount: 0, locationCount: 0 };
    }
    const cityNames = Object.keys(cities);
    let locationCount = 0;
    cityNames.forEach((cityName) => {
      const entries = Array.isArray(cities[cityName]) ? cities[cityName] : [];
      locationCount += entries.length;
    });
    return { cityCount: cityNames.length, locationCount };
  }

  function getBusinessMetrics(types) {
    const typeNames = types && typeof types === 'object' ? Object.keys(types) : [];
    let cityCount = 0;
    let locationCount = 0;
    typeNames.forEach((typeName) => {
      const { cityCount: typeCities, locationCount: typeLocations } = getTypeMetrics(types[typeName]);
      cityCount += typeCities;
      locationCount += typeLocations;
    });
    return { typeCount: typeNames.length, cityCount, locationCount };
  }

  function createLocationMeta(badges) {
    const normalized = Array.isArray(badges)
      ? badges.filter((badge) => badge && typeof badge.label === 'string')
      : [];
    if (!normalized.length) {
      return null;
    }
    const meta = document.createElement('div');
    meta.className = 'location-node-meta';
    normalized.forEach(({ label, value }) => {
      const badge = document.createElement('span');
      badge.className = 'badge rounded-pill text-bg-light';
      badge.textContent = `${label}: ${value}`;
      meta.appendChild(badge);
    });
    return meta;
  }

  function createLocationTreeRow(
    level,
    { name, statusPath, onSubmit, onReset, onDelete, collapsible = false }
  ) {
    const row = document.createElement('div');
    row.className = 'location-tree-row';
    row.dataset.locationLevel = level;

    let toggleButton = null;
    if (collapsible) {
      toggleButton = document.createElement('button');
      toggleButton.type = 'button';
      toggleButton.className = 'btn btn-sm btn-outline-secondary btn-icon location-tree-toggle';
      toggleButton.innerHTML = COLLAPSE_ICON_HTML;
      toggleButton.title = '–°–≤–µ—Ä–Ω—É—Ç—å –≤–µ—Ç–∫—É';
      toggleButton.setAttribute('aria-expanded', 'true');
      row.appendChild(toggleButton);
    }

    const bubble = document.createElement('div');
    bubble.className = 'location-structure-row location-tree-bubble';
    bubble.dataset.locationLevel = level;
    row.appendChild(bubble);

    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'form-control form-control-sm location-name-input';
    input.value = name;
    bubble.appendChild(input);

    const controls = document.createElement('div');
    controls.className = 'location-tree-controls';
    row.appendChild(controls);

    const statusContainer = document.createElement('div');
    statusContainer.className = 'location-status-wrapper';
    const statusSelect = createStatusSelect(level, statusPath);
    statusContainer.appendChild(statusSelect);
    controls.appendChild(statusContainer);

    const actions = document.createElement('div');
    actions.className = 'location-actions';
    controls.appendChild(actions);

    const editButton = document.createElement('button');
    editButton.type = 'button';
    editButton.className = 'btn btn-sm btn-outline-secondary btn-icon';
    editButton.innerHTML = EDIT_ICON_HTML;
    editButton.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
    actions.appendChild(editButton);

    let deleteButton = null;
    if (typeof onDelete === 'function') {
      deleteButton = document.createElement('button');
      deleteButton.type = 'button';
      deleteButton.className = 'btn btn-sm btn-outline-danger btn-icon';
      deleteButton.innerHTML = DELETE_ICON_HTML;
      deleteButton.title = '–£–¥–∞–ª–∏—Ç—å';
      deleteButton.addEventListener('click', () => onDelete());
      actions.appendChild(deleteButton);
    }

    configureEditControls({
      input,
      statusSelect,
      editButton,
      deleteButton,
      onSubmit,
      onReset,
    });

    const updateAppearance = () => applyStatusStyle(bubble, statusSelect.value);
    statusSelect.addEventListener('change', updateAppearance);
    updateAppearance();

    return {
      row,
      input,
      statusSelect,
      actions,
      editButton,
      deleteButton,
      toggleButton,
    };
  }

  function createLocationLeaf(businessName, typeName, cityName, locationName) {
    const item = document.createElement('li');
    item.className = 'org-tree__item location-tree__item location-level-location';

    const { row, input, statusSelect } = createLocationTreeRow('location', {
      name: locationName,
      statusPath: [businessName, typeName, cityName, locationName],
      onSubmit: (newName, meta) =>
        updateLocation(
          businessName,
          typeName,
          cityName,
          locationName,
          newName || locationName,
          meta.status
        ),
      onReset: () => {
        input.value = locationName;
        statusSelect.value = getStatus('location', businessName, typeName, cityName, locationName);
      },
      onDelete: () => removeLocation(businessName, typeName, cityName, locationName),
    });

    const card = document.createElement('div');
    card.className = 'location-tree-card';
    card.appendChild(row);
    item.appendChild(card);

    return item;
  }

  function createCityNode(businessName, typeName, cityName, locations) {
    const item = document.createElement('li');
    item.className = 'org-tree__item location-tree__item location-level-city';

    const locationNames = Array.isArray(locations) ? locations : [];
    const collapseKey = makeCollapseKey('city', businessName, typeName, cityName);

    const { row, input, statusSelect, actions, toggleButton } = createLocationTreeRow('city', {
      name: cityName,
      statusPath: [businessName, typeName, cityName],
      onSubmit: (newName, meta) =>
        updateCity(businessName, typeName, cityName, newName || cityName, meta.status),
      onReset: () => {
        input.value = cityName;
        statusSelect.value = getStatus('city', businessName, typeName, cityName);
      },
      onDelete: () => removeCity(businessName, typeName, cityName),
      collapsible: locationNames.length > 0,
    });

    const addLocationBtn = document.createElement('button');
    addLocationBtn.type = 'button';
    addLocationBtn.className = 'btn btn-sm btn-outline-success';
    addLocationBtn.textContent = '+ –õ–æ–∫–∞—Ü–∏—è';
    addLocationBtn.addEventListener('click', () => addLocation(businessName, typeName, cityName));
    actions.appendChild(addLocationBtn);

    const meta = createLocationMeta([
      { label: '–õ–æ–∫–∞—Ü–∏–π', value: locationNames.length },
    ]);

    const card = document.createElement('div');
    card.className = 'location-tree-card';
    card.appendChild(row);
    if (meta) {
      card.appendChild(meta);
    }
    item.appendChild(card);

    if (locationNames.length) {
      const childrenList = document.createElement('ul');
      childrenList.className = 'org-tree__children location-tree__children list-unstyled';
      locationNames.forEach((locationName) => {
        childrenList.appendChild(
          createLocationLeaf(businessName, typeName, cityName, locationName)
        );
      });
      item.appendChild(childrenList);
      setupTreeToggle(toggleButton, childrenList, collapseKey);
    }

    return item;
  }

  function createTypeNode(businessName, typeName, cities) {
    const item = document.createElement('li');
    item.className = 'org-tree__item location-tree__item location-level-type';

    const cityEntries = cities && typeof cities === 'object' ? Object.entries(cities) : [];
    const collapseKey = makeCollapseKey('type', businessName, typeName);

    const { row, input, statusSelect, actions, toggleButton } = createLocationTreeRow('type', {
      name: typeName,
      statusPath: [businessName, typeName],
      onSubmit: (newName, meta) =>
        updateType(businessName, typeName, newName || typeName, meta.status),
      onReset: () => {
        input.value = typeName;
        statusSelect.value = getStatus('type', businessName, typeName);
      },
      onDelete: () => removeType(businessName, typeName),
      collapsible: cityEntries.length > 0,
    });

    const addCityBtn = document.createElement('button');
    addCityBtn.type = 'button';
    addCityBtn.className = 'btn btn-sm btn-outline-success';
    addCityBtn.textContent = '+ –ì–æ—Ä–æ–¥';
    addCityBtn.addEventListener('click', () => addCityToType(businessName, typeName));
    actions.appendChild(addCityBtn);

    const { cityCount, locationCount } = getTypeMetrics(cities);
    const meta = createLocationMeta([
      { label: '–ì–æ—Ä–æ–¥–æ–≤', value: cityCount },
      { label: '–õ–æ–∫–∞—Ü–∏–π', value: locationCount },
    ]);

    const card = document.createElement('div');
    card.className = 'location-tree-card';
    card.appendChild(row);
    if (meta) {
      card.appendChild(meta);
    }
    item.appendChild(card);

    if (cityEntries.length) {
      const childrenList = document.createElement('ul');
      childrenList.className = 'org-tree__children location-tree__children list-unstyled';
      cityEntries.forEach(([cityName, cityLocations]) => {
        childrenList.appendChild(
          createCityNode(businessName, typeName, cityName, cityLocations)
        );
      });
      item.appendChild(childrenList);
      setupTreeToggle(toggleButton, childrenList, collapseKey);
    }

    return item;
  }

  function createBusinessNode(businessName, types) {
    const item = document.createElement('li');
    item.className = 'org-tree__item location-tree__item location-level-business';

    const typeEntries = types && typeof types === 'object' ? Object.entries(types) : [];
    const collapseKey = makeCollapseKey('business', businessName);

    const { row, input, statusSelect, actions, toggleButton } = createLocationTreeRow('business', {
      name: businessName,
      statusPath: [businessName],
      onSubmit: (newName, meta) => updateBusiness(businessName, newName || businessName, meta.status),
      onReset: () => {
        input.value = businessName;
        statusSelect.value = getStatus('business', businessName);
      },
      onDelete: () => removeBusiness(businessName),
      collapsible: typeEntries.length > 0,
    });

    const addTypeBtn = document.createElement('button');
    addTypeBtn.type = 'button';
    addTypeBtn.className = 'btn btn-sm btn-outline-success';
    addTypeBtn.textContent = '+ –¢–∏–ø';
    addTypeBtn.addEventListener('click', () => addTypeToBusiness(businessName));
    actions.appendChild(addTypeBtn);

    const { typeCount, cityCount, locationCount } = getBusinessMetrics(types);
    const meta = createLocationMeta([
      { label: '–¢–∏–ø–æ–≤', value: typeCount },
      { label: '–ì–æ—Ä–æ–¥–æ–≤', value: cityCount },
      { label: '–õ–æ–∫–∞—Ü–∏–π', value: locationCount },
    ]);

    const card = document.createElement('div');
    card.className = 'location-tree-card';
    card.appendChild(row);
    if (meta) {
      card.appendChild(meta);
    }
    item.appendChild(card);

    if (typeEntries.length) {
      const childrenList = document.createElement('ul');
      childrenList.className = 'org-tree__children location-tree__children list-unstyled';
      typeEntries.forEach(([typeName, cities]) => {
        childrenList.appendChild(createTypeNode(businessName, typeName, cities));
      });
      item.appendChild(childrenList);
      setupTreeToggle(toggleButton, childrenList, collapseKey);
    }

    return item;
  }

  function buildLocationsTree() {
    const container = document.getElementById('locationsEditor');
    if (!container) return;

    locationsState.tree = normalizeLocationTree(locationsState.tree);
    container.innerHTML = '';
    container.classList.add('org-tree-wrapper', 'location-tree-wrapper');

    const tree = locationsState.tree || {};
    pruneCollapsedNodes(tree);
    const businessNames = Object.keys(tree);
    if (!businessNames.length) {
      const placeholder = document.createElement('div');
      placeholder.className = 'alert alert-info small mb-0';
      placeholder.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π. –î–æ–±–∞–≤—å—Ç–µ –±–∏–∑–Ω–µ—Å –∏–ª–∏ –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –º–∞—Å—Ç–µ—Ä–æ–º –≤—ã—à–µ.';
      container.appendChild(placeholder);
      return;
    }

    const list = document.createElement('ul');
    list.className = 'org-tree location-tree list-unstyled';

    businessNames.forEach((businessName) => {
      list.appendChild(createBusinessNode(businessName, tree[businessName] || {}));
    });

    container.appendChild(list);
  }

  function updateBusiness(oldName, newName, statusValue) {
    const tree = locationsState.tree || {};
    const currentName = (oldName || '').trim();
    if (!currentName || !Object.prototype.hasOwnProperty.call(tree, currentName)) {
      return false;
    }
    const trimmed = (newName || '').trim() || currentName;
    if (trimmed !== currentName && Object.prototype.hasOwnProperty.call(tree, trimmed)) {
      alert(`–ë–∏–∑–Ω–µ—Å "${trimmed}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`);
      return false;
    }
    if (trimmed !== currentName) {
      tree[trimmed] = tree[currentName];
      delete tree[currentName];
      renameStatusEntries('business', {}, currentName, trimmed);
    }
    locationsState.tree = normalizeLocationTree(tree);
    setStatus('business', [trimmed], statusValue || getStatus('business', trimmed));
    buildLocationsTree();
    return true;
  }

  function addBusiness() {
    const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞:');
    const trimmed = (name || '').trim();
    if (!trimmed) {
      return;
    }
    if (Object.prototype.hasOwnProperty.call(locationsState.tree || {}, trimmed)) {
      alert(`–ë–∏–∑–Ω–µ—Å "${trimmed}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`);
      return;
    }
    locationsState.tree[trimmed] = { '–ù–æ–≤—ã–π —Ç–∏–ø': { '–ù–æ–≤—ã–π –≥–æ—Ä–æ–¥': [] } };
    setStatus('business', [trimmed], DEFAULT_LOCATION_STATUS);
    setStatus('type', [trimmed, '–ù–æ–≤—ã–π —Ç–∏–ø'], DEFAULT_LOCATION_STATUS);
    setStatus('city', [trimmed, '–ù–æ–≤—ã–π —Ç–∏–ø', '–ù–æ–≤—ã–π –≥–æ—Ä–æ–¥'], DEFAULT_LOCATION_STATUS);
    buildLocationsTree();
  }

  function removeBusiness(name) {
    if (!confirmMultipleTimes(`–£–¥–∞–ª–∏—Ç—å –±–∏–∑–Ω–µ—Å "${name}"?`)) {
      return;
    }
    delete locationsState.tree[name];
    removeStatusEntries('business', {}, name);
    buildLocationsTree();
  }

  function updateType(business, oldName, newName, statusValue) {
    const tree = locationsState.tree || {};
    const types = tree[business];
    if (!types) {
      return false;
    }
    const currentName = (oldName || '').trim();
    const trimmed = (newName || '').trim() || currentName;
    if (trimmed !== currentName && Object.prototype.hasOwnProperty.call(types, trimmed)) {
      alert(`–¢–∏–ø "${trimmed}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`);
      return false;
    }
    if (trimmed !== currentName) {
      types[trimmed] = types[currentName];
      delete types[currentName];
      renameStatusEntries('type', { business }, currentName, trimmed);
    }
    tree[business] = types;
    locationsState.tree = normalizeLocationTree(tree);
    setStatus('type', [business, trimmed], statusValue || getStatus('type', business, trimmed));
    buildLocationsTree();
    return true;
  }

  function addTypeToBusiness(business) {
    const types = locationsState.tree[business];
    if (!types) {
      return;
    }
    const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–ø–∞:');
    const trimmed = (name || '').trim();
    if (!trimmed) {
      return;
    }
    if (Object.prototype.hasOwnProperty.call(types, trimmed)) {
      alert(`–¢–∏–ø "${trimmed}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`);
      return;
    }
    types[trimmed] = { '–ù–æ–≤—ã–π –≥–æ—Ä–æ–¥': [] };
    setStatus('type', [business, trimmed], DEFAULT_LOCATION_STATUS);
    setStatus('city', [business, trimmed, '–ù–æ–≤—ã–π –≥–æ—Ä–æ–¥'], DEFAULT_LOCATION_STATUS);
    buildLocationsTree();
  }

  function removeType(business, typeName) {
    if (!confirmMultipleTimes(`–£–¥–∞–ª–∏—Ç—å —Ç–∏–ø "${typeName}"?`)) {
      return;
    }
    const types = locationsState.tree[business];
    if (!types) return;
    delete types[typeName];
    removeStatusEntries('type', { business }, typeName);
    buildLocationsTree();
  }

  function updateCity(business, typeName, oldName, newName, statusValue) {
    const tree = locationsState.tree || {};
    const types = tree[business];
    if (!types) return false;
    const cities = types[typeName];
    if (!cities || typeof cities !== 'object') return false;
    const currentName = (oldName || '').trim();
    const trimmed = (newName || '').trim() || currentName;
    if (trimmed !== currentName && Object.prototype.hasOwnProperty.call(cities, trimmed)) {
      alert(`–ì–æ—Ä–æ–¥ "${trimmed}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`);
      return false;
    }
    if (trimmed !== currentName) {
      cities[trimmed] = cities[currentName];
      delete cities[currentName];
      renameStatusEntries('city', { business, type: typeName }, currentName, trimmed);
    }
    setStatus('city', [business, typeName, trimmed], statusValue || getStatus('city', business, typeName, trimmed));
    buildLocationsTree();
    return true;
  }

  function addCityToType(business, typeName) {
    const types = locationsState.tree[business];
    if (!types) return;
    const cities = types[typeName];
    if (!cities || typeof cities !== 'object') return;
    const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞:');
    const trimmed = (name || '').trim();
    if (!trimmed) {
      return;
    }
    if (Object.prototype.hasOwnProperty.call(cities, trimmed)) {
      alert(`–ì–æ—Ä–æ–¥ "${trimmed}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`);
      return;
    }
    cities[trimmed] = [];
    setStatus('city', [business, typeName, trimmed], DEFAULT_LOCATION_STATUS);
    buildLocationsTree();
  }

  function removeCity(business, typeName, cityName) {
    if (!confirmMultipleTimes(`–£–¥–∞–ª–∏—Ç—å –≥–æ—Ä–æ–¥ "${cityName}"?`)) {
      return;
    }
    const types = locationsState.tree[business];
    if (!types) return;
    const cities = types[typeName];
    if (!cities || typeof cities !== 'object') return;
    delete cities[cityName];
    removeStatusEntries('city', { business, type: typeName }, cityName);
    buildLocationsTree();
  }

  function updateLocation(business, typeName, cityName, oldName, newName, statusValue) {
    const types = locationsState.tree[business];
    if (!types) return false;
    const cities = types[typeName];
    if (!cities || typeof cities !== 'object') return false;
    const locations = Array.isArray(cities[cityName]) ? cities[cityName] : [];
    const currentName = (oldName || '').trim();
    const trimmed = (newName || '').trim() || currentName;
    if (trimmed !== currentName && locations.includes(trimmed)) {
      alert(`–õ–æ–∫–∞—Ü–∏—è "${trimmed}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`);
      return false;
    }
    const idx = locations.indexOf(currentName);
    if (idx === -1) return false;
    locations[idx] = trimmed;
    cities[cityName] = sortArrayAlphabetically(locations);
    if (trimmed !== currentName) {
      renameStatusEntries('location', { business, type: typeName, city: cityName }, currentName, trimmed);
    }
    setStatus('location', [business, typeName, cityName, trimmed], statusValue || getStatus('location', business, typeName, cityName, trimmed));
    buildLocationsTree();
    return true;
  }

  function addLocation(business, typeName, cityName) {
    const types = locationsState.tree[business];
    if (!types) return;
    const cities = types[typeName];
    if (!cities || typeof cities !== 'object') return;
    const list = Array.isArray(cities[cityName]) ? cities[cityName] : [];
    const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏:');
    const trimmed = (name || '').trim();
    if (!trimmed) {
      return;
    }
    if (list.includes(trimmed)) {
      alert(`–õ–æ–∫–∞—Ü–∏—è "${trimmed}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`);
      return;
    }
    list.push(trimmed);
    cities[cityName] = sortArrayAlphabetically(list);
    setStatus('location', [business, typeName, cityName, trimmed], DEFAULT_LOCATION_STATUS);
    buildLocationsTree();
  }

  function removeLocation(business, typeName, cityName, locationName) {
    if (!confirmMultipleTimes(`–£–¥–∞–ª–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é "${locationName}"?`)) {
      return;
    }
    const types = locationsState.tree[business];
    if (!types) return;
    const cities = types[typeName];
    if (!cities || typeof cities !== 'object') return;
    const list = Array.isArray(cities[cityName]) ? cities[cityName] : [];
    const idx = list.indexOf(locationName);
    if (idx === -1) return;
    list.splice(idx, 1);
    cities[cityName] = list;
    removeStatusEntries('location', { business, type: typeName, city: cityName }, locationName);
    buildLocationsTree();
  }

  async function saveLocationsChanges() {
    try {
      const response = await fetch('/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ locations: locationsState }),
      });
      const data = await response.json();
      if (data.success) {
        alert('‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–æ–∫–∞—Ü–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
      } else {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
      }
    } catch (error) {
      alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
    }
  }

  const TYPE_OPTIONS = ['–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è —Å–µ—Ç—å', '–ü–∞—Ä—Ç–Ω—ë—Ä—ã-—Ñ—Ä–∞–Ω—á–∞–π–∑–∏'];
  let locationWizardModal = null;
  let locationWizardInitialised = false;
  let locationWizardStep = 0;
  const locationWizardState = {
    business: '',
    type: '',
    city: '',
    department: '',
  };
  let wizardSteps = [];
  let wizardSummary;
  let wizardBusinessSelect;
  let wizardTypeSelect;
  let wizardCitySelect;
  let wizardDepartmentSelect;
  let wizardPrevBtn;
  let wizardNextBtn;
  let wizardFinishBtn;

  function uniqueSorted(values) {
    return Array.from(
      new Set(
        (values || [])
          .map((value) => (typeof value === 'string' ? value.trim() : ''))
          .filter((value) => value)
      )
    ).sort((a, b) => a.localeCompare(b));
  }

  function getBusinessOptions() {
    const options = uniqueSorted((parameterData.business || []).map((item) => item.value));
    if (options.length) {
      return options;
    }
    return uniqueSorted(Object.keys(locationsState.tree || {}));
  }

  function getCityOptions() {
    if (CITY_OPTIONS && CITY_OPTIONS.length) {
      return CITY_OPTIONS;
    }
    const collected = [];
    Object.values(locationsState.tree || {}).forEach((types) => {
      Object.values(types || {}).forEach((cities) => {
        Object.keys(cities || {}).forEach((city) => {
          collected.push(city);
        });
      });
    });
    return uniqueSorted(collected);
  }

  function getDepartmentOptions() {
    const options = uniqueSorted((parameterData.department || []).map((item) => item.value));
    if (options.length) {
      return options;
    }
    const collected = [];
    Object.values(locationsState.tree || {}).forEach((types) => {
      Object.values(types || {}).forEach((cities) => {
        Object.values(cities || {}).forEach((departments) => {
          if (Array.isArray(departments)) {
            departments.forEach((department) => collected.push(department));
          }
        });
      });
    });
    return uniqueSorted(collected);
  }

  function clearInvalid(selectEl) {
    if (selectEl) {
      selectEl.classList.remove('is-invalid');
    }
  }

  function markInvalid(selectEl) {
    if (selectEl) {
      selectEl.classList.add('is-invalid');
      selectEl.focus();
    }
  }

  function fillSelect(selectEl, options, placeholder, selectedValue) {
    if (!selectEl) return;
    selectEl.innerHTML = '';
    const placeholderOption = document.createElement('option');
    placeholderOption.value = '';
    placeholderOption.textContent = placeholder;
    placeholderOption.disabled = true;
    if (!selectedValue) {
      placeholderOption.selected = true;
    }
    selectEl.appendChild(placeholderOption);
    options.forEach((value) => {
      const option = document.createElement('option');
      option.value = value;
      option.textContent = value;
      if (value === selectedValue) {
        option.selected = true;
      }
      selectEl.appendChild(option);
    });
    if (selectedValue && !options.includes(selectedValue)) {
      placeholderOption.selected = true;
      selectEl.value = '';
    }
    clearInvalid(selectEl);
  }

  function populateWizardOptions() {
    fillSelect(wizardBusinessSelect, getBusinessOptions(), '–í—ã–±–µ—Ä–∏—Ç–µ –±–∏–∑–Ω–µ—Å', locationWizardState.business);
    fillSelect(wizardTypeSelect, TYPE_OPTIONS.slice(), '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø', locationWizardState.type);
    fillSelect(wizardCitySelect, getCityOptions(), '–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥', locationWizardState.city);
    fillSelect(
      wizardDepartmentSelect,
      getDepartmentOptions(),
      '–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç',
      locationWizardState.department,
    );
  }

  function resetLocationWizardState() {
    locationWizardState.business = '';
    locationWizardState.type = '';
    locationWizardState.city = '';
    locationWizardState.department = '';
    locationWizardStep = 0;
  }

  function updateWizardSummary() {
    if (!wizardSummary) return;
    const entries = [
      ['–ë–∏–∑–Ω–µ—Å', locationWizardState.business || '‚Äî'],
      ['–¢–∏–ø', locationWizardState.type || '‚Äî'],
      ['–ì–æ—Ä–æ–¥', locationWizardState.city || '‚Äî'],
      ['–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç', locationWizardState.department || '‚Äî'],
    ];
    wizardSummary.innerHTML = `
      <ul class="mb-0 small">
        ${entries.map(([label, value]) => `<li><strong>${label}:</strong> ${value}</li>`).join('')}
      </ul>
    `;
  }

  function showLocationWizardStep(step) {
    locationWizardStep = step;
    if (wizardSteps && wizardSteps.length) {
      wizardSteps.forEach((stepEl, index) => {
        stepEl.classList.toggle('d-none', index !== step);
      });
    }
    if (wizardPrevBtn) {
      wizardPrevBtn.disabled = step === 0;
      wizardPrevBtn.classList.toggle('disabled', step === 0);
    }
    if (wizardNextBtn) {
      wizardNextBtn.classList.toggle('d-none', step === wizardSteps.length - 1);
    }
    if (wizardFinishBtn) {
      wizardFinishBtn.classList.toggle('d-none', step !== wizardSteps.length - 1);
    }
    updateWizardSummary();
  }

  function handleLocationWizardPrev() {
    if (locationWizardStep > 0) {
      showLocationWizardStep(locationWizardStep - 1);
    }
  }

  function handleLocationWizardNext() {
    if (locationWizardStep === 0) {
      if (!locationWizardState.business) {
        markInvalid(wizardBusinessSelect);
        return;
      }
    } else if (locationWizardStep === 1) {
      if (!locationWizardState.type) {
        markInvalid(wizardTypeSelect);
        return;
      }
    } else if (locationWizardStep === 2) {
      if (!locationWizardState.city) {
        markInvalid(wizardCitySelect);
        return;
      }
    }
    showLocationWizardStep(Math.min(locationWizardStep + 1, wizardSteps.length - 1));
  }

  function addLocationEntryFromWizard(entry) {
    const business = (entry.business || '').trim();
    const type = (entry.type || '').trim();
    const city = (entry.city || '').trim();
    const department = (entry.department || '').trim();
    if (!business || !type || !city || !department) {
      return false;
    }

    if (!locationsState.tree[business]) {
      locationsState.tree[business] = {};
      setStatus('business', [business], DEFAULT_LOCATION_STATUS);
    }
    if (!locationsState.tree[business][type]) {
      locationsState.tree[business][type] = {};
      setStatus('type', [business, type], DEFAULT_LOCATION_STATUS);
    }
    if (!Array.isArray(locationsState.tree[business][type][city])) {
      locationsState.tree[business][type][city] = [];
      setStatus('city', [business, type, city], DEFAULT_LOCATION_STATUS);
    }

    const targetList = locationsState.tree[business][type][city];
    if (targetList.includes(department)) {
      return false;
    }

    targetList.push(department);
    locationsState.tree[business][type][city] = sortArrayAlphabetically(targetList);
    setStatus('location', [business, type, city, department], DEFAULT_LOCATION_STATUS);
    buildLocationsTree();

    return true;
  }

  function handleLocationWizardFinish() {
    if (!locationWizardState.department) {
      markInvalid(wizardDepartmentSelect);
      return;
    }
    if (!addLocationEntryFromWizard(locationWizardState)) {
      alert('–¢–∞–∫–∞—è –∑–∞–ø–∏—Å—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ.');
      return;
    }
    if (locationWizardModal) {
      locationWizardModal.hide();
    }
  }

  function initLocationWizard() {
    if (locationWizardInitialised) return;
    const wizardModalEl = document.getElementById('locationWizardModal');
    if (!wizardModalEl || typeof bootstrap === 'undefined' || !bootstrap.Modal) {
      return;
    }
    locationWizardModal = bootstrap.Modal.getOrCreateInstance(wizardModalEl);
    wizardBusinessSelect = document.getElementById('wizardBusinessSelect');
    wizardTypeSelect = document.getElementById('wizardTypeSelect');
    wizardCitySelect = document.getElementById('wizardCitySelect');
    wizardDepartmentSelect = document.getElementById('wizardDepartmentSelect');
    wizardPrevBtn = document.getElementById('wizardPrevStep');
    wizardNextBtn = document.getElementById('wizardNextStep');
    wizardFinishBtn = document.getElementById('wizardFinish');
    wizardSummary = document.getElementById('wizardSummary');
    wizardSteps = Array.from(document.querySelectorAll('[data-location-wizard-step]'));

    if (wizardPrevBtn) {
      wizardPrevBtn.addEventListener('click', handleLocationWizardPrev);
    }
    if (wizardNextBtn) {
      wizardNextBtn.addEventListener('click', handleLocationWizardNext);
    }
    if (wizardFinishBtn) {
      wizardFinishBtn.addEventListener('click', handleLocationWizardFinish);
    }
    if (wizardBusinessSelect) {
      wizardBusinessSelect.addEventListener('change', (event) => {
        locationWizardState.business = (event.target.value || '').trim();
        locationWizardState.type = '';
        locationWizardState.city = '';
        locationWizardState.department = '';
        if (wizardTypeSelect) wizardTypeSelect.value = '';
        if (wizardCitySelect) wizardCitySelect.value = '';
        if (wizardDepartmentSelect) wizardDepartmentSelect.value = '';
        clearInvalid(wizardBusinessSelect);
        clearInvalid(wizardTypeSelect);
        clearInvalid(wizardCitySelect);
        clearInvalid(wizardDepartmentSelect);
        updateWizardSummary();
      });
    }
    if (wizardTypeSelect) {
      wizardTypeSelect.addEventListener('change', (event) => {
        locationWizardState.type = (event.target.value || '').trim();
        locationWizardState.city = '';
        locationWizardState.department = '';
        if (wizardCitySelect) wizardCitySelect.value = '';
        if (wizardDepartmentSelect) wizardDepartmentSelect.value = '';
        clearInvalid(wizardTypeSelect);
        clearInvalid(wizardCitySelect);
        clearInvalid(wizardDepartmentSelect);
        updateWizardSummary();
      });
    }
    if (wizardCitySelect) {
      wizardCitySelect.addEventListener('change', (event) => {
        locationWizardState.city = (event.target.value || '').trim();
        locationWizardState.department = '';
        if (wizardDepartmentSelect) wizardDepartmentSelect.value = '';
        clearInvalid(wizardCitySelect);
        clearInvalid(wizardDepartmentSelect);
        updateWizardSummary();
      });
    }
    if (wizardDepartmentSelect) {
      wizardDepartmentSelect.addEventListener('change', (event) => {
        locationWizardState.department = (event.target.value || '').trim();
        clearInvalid(wizardDepartmentSelect);
        updateWizardSummary();
      });
    }

    wizardModalEl.addEventListener('hidden.bs.modal', () => {
      resetLocationWizardState();
      populateWizardOptions();
      showLocationWizardStep(0);
    });

    populateWizardOptions();
    showLocationWizardStep(0);
    locationWizardInitialised = true;
  }

  async function openAddLocationWizard() {
    initLocationWizard();
    if (!locationWizardModal) return;
    if (!parametersLoaded) {
      await loadParameters();
      populateWizardOptions();
    }
    resetLocationWizardState();
    populateWizardOptions();
    showLocationWizardStep(0);
    updateWizardSummary();
    locationWizardModal.show();
  }

  window.openAddLocationWizard = openAddLocationWizard;

  function generateDialogTemplateId(prefix) {
    const randomPart = Math.random().toString(36).slice(2, 8);
    const timePart = Date.now().toString(36);
    return `${prefix}-${randomPart}-${timePart}`;
  }

  function pluralizeRussian(number, forms) {
    const abs = Math.abs(number);
    const mod10 = abs % 10;
    const mod100 = abs % 100;
    if (mod10 === 1 && mod100 !== 11) {
      return forms[0];
    }
    if (mod10 >= 2 && mod10 <= 4 && (mod100 < 10 || mod100 >= 20)) {
      return forms[1];
    }
    return forms[2];
  }

  function buildPreview(values, limit = 3) {
    if (!Array.isArray(values) || !values.length) {
      return '';
    }
    const slice = values.slice(0, limit);
    const preview = slice.join(', ');
    if (values.length > limit) {
      return `${preview}‚Ä¶`;
    }
    return preview;
  }

  function findDialogTemplateCard(source) {
    if (!(source instanceof HTMLElement)) return null;
    return source.closest('[data-category-template], [data-question-template], [data-completion-template], [data-auto-close-template]');
  }

  function toggleDialogTemplateEditor(source, forceState) {
    const card = source instanceof HTMLElement && source.matches('[data-category-template], [data-question-template], [data-completion-template], [data-auto-close-template]')
      ? source
      : findDialogTemplateCard(source);
    if (!card) return;
    const editor = card.querySelector('[data-dialog-template-editor]');
    const toggleBtn = card.querySelector('[data-dialog-template-toggle]');
    if (!editor || !toggleBtn) return;
    let shouldShow;
    if (typeof forceState === 'boolean') {
      shouldShow = forceState;
    } else {
      shouldShow = editor.classList.contains('d-none');
    }
    editor.classList.toggle('d-none', !shouldShow);
    toggleBtn.textContent = shouldShow ? '–°–≤–µ—Ä–Ω—É—Ç—å' : '–ù–∞—Å—Ç—Ä–æ–∏—Ç—å';
    toggleBtn.dataset.expanded = shouldShow ? 'true' : 'false';
    toggleBtn.setAttribute('aria-expanded', shouldShow ? 'true' : 'false');
    editor.setAttribute('aria-hidden', shouldShow ? 'false' : 'true');
  }

  function updateCategoryTemplateSummary(card) {
    if (!(card instanceof HTMLElement)) return;
    const nameInput = card.querySelector('.category-template-name');
    const titleEl = card.querySelector('[data-dialog-template-title]');
    const summaryEl = card.querySelector('[data-dialog-template-summary]');
    const name = (nameInput?.value || '').trim();
    if (titleEl) {
      titleEl.textContent = name || '–®–∞–±–ª–æ–Ω –∫–∞—Ç–µ–≥–æ—Ä–∏–π';
    }
    if (summaryEl) {
      const categories = Array.from(card.querySelectorAll('.category-item-input'))
        .map((input) => (input.value || '').trim())
        .filter((value) => value);
      if (!categories.length) {
        summaryEl.textContent = '–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π. –î–æ–±–∞–≤—å—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ —à–∞–±–ª–æ–Ω.';
      } else {
        const countText = `${categories.length} ${pluralizeRussian(categories.length, ['–∫–∞—Ç–µ–≥–æ—Ä–∏—è', '–∫–∞—Ç–µ–≥–æ—Ä–∏–∏', '–∫–∞—Ç–µ–≥–æ—Ä–∏–π'])}`;
        const preview = buildPreview(categories);
        summaryEl.textContent = preview ? `${countText} ¬∑ ${preview}` : countText;
      }
    }
  }

  function updateQuestionTemplateSummary(card) {
    if (!(card instanceof HTMLElement)) return;
    const nameInput = card.querySelector('.question-template-name');
    const titleEl = card.querySelector('[data-dialog-template-title]');
    const summaryEl = card.querySelector('[data-dialog-template-summary]');
    const name = (nameInput?.value || '').trim();
    if (titleEl) {
      titleEl.textContent = name || '–®–∞–±–ª–æ–Ω –≤–æ–ø—Ä–æ—Å–æ–≤';
    }
    if (summaryEl) {
      const questions = Array.from(card.querySelectorAll('.question-item-input'))
        .map((input) => (input.value || '').trim())
        .filter((value) => value);
      if (!questions.length) {
        summaryEl.textContent = '–ù–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –∏—Ö –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä –Ω–∏–∂–µ.';
      } else {
        const countText = `${questions.length} ${pluralizeRussian(questions.length, ['–≤–æ–ø—Ä–æ—Å', '–≤–æ–ø—Ä–æ—Å–∞', '–≤–æ–ø—Ä–æ—Å–æ–≤'])}`;
        const preview = buildPreview(questions);
        summaryEl.textContent = preview ? `${countText} ¬∑ ${preview}` : countText;
      }
    }
  }

  function updateCompletionTemplateSummary(card) {
    if (!(card instanceof HTMLElement)) return;
    const nameInput = card.querySelector('.completion-template-name');
    const titleEl = card.querySelector('[data-dialog-template-title]');
    const summaryEl = card.querySelector('[data-dialog-template-summary]');
    const name = (nameInput?.value || '').trim();
    if (titleEl) {
      titleEl.textContent = name || '–®–∞–±–ª–æ–Ω –¥–µ–π—Å—Ç–≤–∏–π';
    }
    if (summaryEl) {
      const items = Array.from(card.querySelectorAll('[data-completion-item]')).map((row) => {
        if (!(row instanceof HTMLElement)) return null;
        const question = (row.querySelector('.completion-question-input')?.value || '').trim();
        const action = (row.querySelector('.completion-action-input')?.value || '').trim();
        if (!question && !action) return null;
        return question || action;
      }).filter(Boolean);
      if (!items.length) {
        summaryEl.textContent = '–ù–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π. –î–æ–±–∞–≤—å—Ç–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏ —à–∞–≥–∏.';
      } else {
        const countText = `${items.length} ${pluralizeRussian(items.length, ['—à–∞–≥', '—à–∞–≥–∞', '—à–∞–≥–æ–≤'])}`;
        const preview = buildPreview(items);
        summaryEl.textContent = preview ? `${countText} ¬∑ ${preview}` : countText;
      }
    }
  }

  function addCategoryTemplate(template) {
    const list = document.getElementById('categoryTemplatesList');
    if (!list) return;
    const data = template && typeof template === 'object' ? template : {};
    const templateId = data.id || generateDialogTemplateId('cat');
    const name = typeof data.name === 'string' ? data.name : '';
    const categories = Array.isArray(data.categories) ? data.categories : [];

    const card = document.createElement('div');
    card.className = 'card shadow-sm dialog-template-card';
    card.dataset.categoryTemplate = 'true';
    card.dataset.templateId = templateId;

    card.innerHTML = `
      <div class="card-body">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start gap-3">
          <div>
            <h6 class="mb-1" data-dialog-template-title>–®–∞–±–ª–æ–Ω –∫–∞—Ç–µ–≥–æ—Ä–∏–π</h6>
            <div class="small text-muted dialog-template-summary" data-dialog-template-summary>–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π. –î–æ–±–∞–≤—å—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ —à–∞–±–ª–æ–Ω.</div>
          </div>
          <div class="d-flex flex-column align-items-lg-end gap-2 w-100 w-lg-auto">
            <div class="btn-group btn-group-sm align-self-start align-self-lg-end">
              <button class="btn btn-outline-primary" type="button" data-dialog-template-toggle onclick="toggleDialogTemplateEditor(this)">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å</button>
              <button class="btn btn-outline-danger" type="button" onclick="removeCategoryTemplate(this)">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        </div>
        <div class="dialog-template-editor bg-light mt-3" data-dialog-template-editor aria-hidden="false">
          <div class="mb-3">
            <label class="form-label" for="category-template-${templateId}">–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞</label>
            <input type="text" class="form-control form-control-sm category-template-name" id="category-template-${templateId}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞" value="${''}">
          </div>
          <div class="d-flex flex-column gap-2" data-category-items></div>
          <button class="btn btn-sm btn-outline-primary mt-3" type="button" onclick="addCategoryRow(this)">+ –ö–∞—Ç–µ–≥–æ—Ä–∏—è</button>
        </div>
      </div>
    `;

    list.appendChild(card);
    const nameInput = card.querySelector('.category-template-name');
    if (nameInput) {
      nameInput.value = name;
      nameInput.addEventListener('input', () => updateCategoryTemplateSummary(card));
    }

    const itemsContainer = card.querySelector('[data-category-items]');
    if (itemsContainer) {
      if (categories.length) {
        categories.forEach((cat) => addCategoryRow(itemsContainer, cat));
      } else {
        addCategoryRow(itemsContainer);
      }
    }

    updateCategoryTemplateSummary(card);
    const hasInitialData = Boolean(name || categories.length);
    toggleDialogTemplateEditor(card, !hasInitialData);

    return card;
  }

  function addCategoryRow(source, value = '') {
    let container = null;
    if (source instanceof HTMLElement && source.matches('[data-category-items]')) {
      container = source;
    } else if (source instanceof HTMLElement) {
      const card = source.closest('[data-category-template]');
      container = card ? card.querySelector('[data-category-items]') : null;
    }
    if (!container) return;

    const row = document.createElement('div');
    row.className = 'input-group input-group-sm';
    row.innerHTML = `
      <input type="text" class="form-control category-item-input" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è">
      <button class="btn btn-outline-danger" type="button" onclick="removeCategoryRow(this)">‚úï</button>
    `;
    container.appendChild(row);
    const input = row.querySelector('input');
    if (input) {
      input.value = value || '';
      input.addEventListener('input', () => {
        const card = container.closest('[data-category-template]');
        updateCategoryTemplateSummary(card);
      });
    }
    const card = container.closest('[data-category-template]');
    updateCategoryTemplateSummary(card);
  }

  function removeCategoryTemplate(trigger) {
    const card = trigger?.closest('[data-category-template]');
    if (!card) return;
    const list = document.getElementById('categoryTemplatesList');
    card.remove();
    if (list && !list.querySelector('[data-category-template]')) {
      addCategoryTemplate();
    }
  }

  function removeCategoryRow(trigger) {
    const row = trigger?.closest('.input-group');
    if (!row) return;
    const container = row.parentElement;
    row.remove();
    if (container && !container.querySelector('.input-group')) {
      addCategoryRow(container);
    }
    const card = container?.closest('[data-category-template]');
    updateCategoryTemplateSummary(card);
  }

  function addQuestionTemplate(template) {
    const list = document.getElementById('questionTemplatesList');
    if (!list) return;
    const data = template && typeof template === 'object' ? template : {};
    const templateId = data.id || generateDialogTemplateId('q');
    const name = typeof data.name === 'string' ? data.name : '';
    const questions = Array.isArray(data.questions) ? data.questions : [];

    const card = document.createElement('div');
    card.className = 'card shadow-sm dialog-template-card';
    card.dataset.questionTemplate = 'true';
    card.dataset.templateId = templateId;
    card.innerHTML = `
      <div class="card-body">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start gap-3">
          <div>
            <h6 class="mb-1" data-dialog-template-title>–®–∞–±–ª–æ–Ω –≤–æ–ø—Ä–æ—Å–æ–≤</h6>
            <div class="small text-muted dialog-template-summary" data-dialog-template-summary>–ù–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –∏—Ö –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä –Ω–∏–∂–µ.</div>
          </div>
          <div class="d-flex flex-column align-items-lg-end gap-2 w-100 w-lg-auto">
            <div class="btn-group btn-group-sm align-self-start align-self-lg-end">
              <button class="btn btn-outline-primary" type="button" data-dialog-template-toggle onclick="toggleDialogTemplateEditor(this)">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å</button>
              <button class="btn btn-outline-danger" type="button" onclick="removeQuestionTemplate(this)">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        </div>
        <div class="dialog-template-editor bg-light mt-3" data-dialog-template-editor aria-hidden="false">
          <div class="mb-3">
            <label class="form-label" for="question-template-${templateId}">–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞</label>
            <input type="text" class="form-control form-control-sm question-template-name" id="question-template-${templateId}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞" value="${''}">
          </div>
          <div class="d-flex flex-column gap-2" data-question-items></div>
          <button class="btn btn-sm btn-outline-primary mt-3" type="button" onclick="addQuestionRow(this)">+ –í–æ–ø—Ä–æ—Å</button>
        </div>
      </div>
    `;
    list.appendChild(card);

    const nameInput = card.querySelector('.question-template-name');
    if (nameInput) {
      nameInput.value = name;
      nameInput.addEventListener('input', () => updateQuestionTemplateSummary(card));
    }

    const itemsContainer = card.querySelector('[data-question-items]');
    if (itemsContainer) {
      if (questions.length) {
        questions.forEach((question) => addQuestionRow(itemsContainer, question));
      } else {
        addQuestionRow(itemsContainer);
      }
    }

    updateQuestionTemplateSummary(card);
    const hasInitialData = Boolean(name || questions.length);
    toggleDialogTemplateEditor(card, !hasInitialData);

    return card;
  }

  function addQuestionRow(source, value = '') {
    let container = null;
    if (source instanceof HTMLElement && source.matches('[data-question-items]')) {
      container = source;
    } else if (source instanceof HTMLElement) {
      const card = source.closest('[data-question-template]');
      container = card ? card.querySelector('[data-question-items]') : null;
    }
    if (!container) return;

    const row = document.createElement('div');
    row.className = 'input-group input-group-sm';
    row.innerHTML = `
      <input type="text" class="form-control question-item-input" placeholder="–¢–∏–ø–æ–≤–æ–π –≤–æ–ø—Ä–æ—Å">
      <button class="btn btn-outline-danger" type="button" onclick="removeQuestionRow(this)">‚úï</button>
    `;
    container.appendChild(row);
    const input = row.querySelector('input');
    if (input) {
      input.value = value || '';
      input.addEventListener('input', () => {
        const card = container.closest('[data-question-template]');
        updateQuestionTemplateSummary(card);
      });
    }
    const card = container.closest('[data-question-template]');
    updateQuestionTemplateSummary(card);
  }

  function removeQuestionTemplate(trigger) {
    const card = trigger?.closest('[data-question-template]');
    if (!card) return;
    const list = document.getElementById('questionTemplatesList');
    card.remove();
    if (list && !list.querySelector('[data-question-template]')) {
      addQuestionTemplate();
    }
  }

  function removeQuestionRow(trigger) {
    const row = trigger?.closest('.input-group');
    if (!row) return;
    const container = row.parentElement;
    row.remove();
    if (container && !container.querySelector('.input-group')) {
      addQuestionRow(container);
    }
    const card = container?.closest('[data-question-template]');
    updateQuestionTemplateSummary(card);
  }

  function addCompletionTemplate(template) {
    const list = document.getElementById('completionTemplatesList');
    if (!list) return;
    const data = template && typeof template === 'object' ? template : {};
    const templateId = data.id || generateDialogTemplateId('act');
    const name = typeof data.name === 'string' ? data.name : '';
    const items = Array.isArray(data.items) ? data.items : [];

    const card = document.createElement('div');
    card.className = 'card shadow-sm dialog-template-card';
    card.dataset.completionTemplate = 'true';
    card.dataset.templateId = templateId;
    card.innerHTML = `
      <div class="card-body">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start gap-3">
          <div>
            <h6 class="mb-1" data-dialog-template-title>–®–∞–±–ª–æ–Ω –¥–µ–π—Å—Ç–≤–∏–π</h6>
            <div class="small text-muted dialog-template-summary" data-dialog-template-summary>–ù–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π. –î–æ–±–∞–≤—å—Ç–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏ —à–∞–≥–∏.</div>
          </div>
          <div class="d-flex flex-column align-items-lg-end gap-2 w-100 w-lg-auto">
            <div class="btn-group btn-group-sm align-self-start align-self-lg-end">
              <button class="btn btn-outline-primary" type="button" data-dialog-template-toggle onclick="toggleDialogTemplateEditor(this)">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å</button>
              <button class="btn btn-outline-danger" type="button" onclick="removeCompletionTemplate(this)">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        </div>
        <div class="dialog-template-editor bg-light mt-3" data-dialog-template-editor aria-hidden="false">
          <div class="mb-3">
            <label class="form-label" for="completion-template-${templateId}">–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞</label>
            <input type="text" class="form-control form-control-sm completion-template-name" id="completion-template-${templateId}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞" value="${''}">
          </div>
          <div class="d-flex flex-column gap-3" data-completion-items></div>
          <button class="btn btn-sm btn-outline-primary mt-3" type="button" onclick="addCompletionRow(this)">+ –î–µ–π—Å—Ç–≤–∏–µ</button>
        </div>
      </div>
    `;
    list.appendChild(card);

    const nameInput = card.querySelector('.completion-template-name');
    if (nameInput) {
      nameInput.value = name;
      nameInput.addEventListener('input', () => updateCompletionTemplateSummary(card));
    }

    const itemsContainer = card.querySelector('[data-completion-items]');
    if (itemsContainer) {
      if (items.length) {
        items.forEach((entry) => {
          const question = entry && typeof entry.question === 'string' ? entry.question : '';
          const action = entry && typeof entry.action === 'string' ? entry.action : '';
          addCompletionRow(itemsContainer, question, action);
        });
      } else {
        addCompletionRow(itemsContainer);
      }
    }

    updateCompletionTemplateSummary(card);
    const hasInitialData = Boolean(name || items.length);
    toggleDialogTemplateEditor(card, !hasInitialData);

    return card;
  }

  function addCompletionRow(source, questionValue = '', actionValue = '') {
    let container = null;
    if (source instanceof HTMLElement && source.matches('[data-completion-items]')) {
      container = source;
    } else if (source instanceof HTMLElement) {
      const card = source.closest('[data-completion-template]');
      container = card ? card.querySelector('[data-completion-items]') : null;
    }
    if (!container) return;

    const row = document.createElement('div');
    row.className = 'row g-2 align-items-start completion-item-row';
    row.dataset.completionItem = 'true';
    row.innerHTML = `
      <div class="col-md-5">
        <input type="text" class="form-control form-control-sm completion-question-input" placeholder="–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å">
      </div>
      <div class="col-md-6">
        <input type="text" class="form-control form-control-sm completion-action-input" placeholder="–î–µ–π—Å—Ç–≤–∏–µ">
      </div>
      <div class="col-md-1 d-flex align-items-center">
        <button class="btn btn-outline-danger btn-sm w-100" type="button" onclick="removeCompletionRow(this)">‚úï</button>
      </div>
    `;
    container.appendChild(row);
    const questionInput = row.querySelector('.completion-question-input');
    const actionInput = row.querySelector('.completion-action-input');
    if (questionInput) questionInput.value = questionValue || '';
    if (actionInput) actionInput.value = actionValue || '';
    [questionInput, actionInput].forEach((input) => {
      if (input) {
        input.addEventListener('input', () => {
          const card = container.closest('[data-completion-template]');
          updateCompletionTemplateSummary(card);
        });
      }
    });
    const card = container.closest('[data-completion-template]');
    updateCompletionTemplateSummary(card);
  }

  function removeCompletionTemplate(trigger) {
    const card = trigger?.closest('[data-completion-template]');
    if (!card) return;
    const list = document.getElementById('completionTemplatesList');
    card.remove();
    if (list && !list.querySelector('[data-completion-template]')) {
      addCompletionTemplate();
    }
  }

  function removeCompletionRow(trigger) {
    const row = trigger?.closest('[data-completion-item]');
    if (!row) return;
    const container = row.parentElement;
    row.remove();
    if (container && !container.querySelector('[data-completion-item]')) {
      addCompletionRow(container);
    }
    const card = container?.closest('[data-completion-template]');
    updateCompletionTemplateSummary(card);
  }

  function buildAutoCloseTemplateCard(template) {
    const list = document.querySelector('[data-auto-close-templates]');
    if (!list) return null;
    const data = template && typeof template === 'object' ? template : {};
    const templateId = data.id || generateDialogTemplateId('auto');
    const name = typeof data.name === 'string' ? data.name : '';
    const description = typeof data.description === 'string' ? data.description : '';
    let hoursCandidate = null;
    ['hours', 'timeout_hours', 'auto_close_hours'].some((key) => {
      const value = data && typeof data === 'object' ? Number(data[key]) : NaN;
      if (Number.isFinite(value) && value > 0) {
        hoursCandidate = value;
        return true;
      }
      return false;
    });
    const rawHours = Number.isFinite(hoursCandidate) && hoursCandidate > 0 ? hoursCandidate : AUTO_CLOSE_FALLBACK_HOURS;
    const hours = Math.min(Math.max(Math.round(rawHours || AUTO_CLOSE_FALLBACK_HOURS), 1), 720);
    const safeIdAttr = escapeHtml(templateId);
    const safeName = escapeHtml(name);
    const safeDescription = escapeHtml(description);

    const card = document.createElement('div');
    card.className = 'card shadow-sm dialog-template-card template-card';
    card.dataset.autoCloseTemplate = 'true';
    card.dataset.templateId = templateId;

    card.innerHTML = `
      <div class="card-body">
        <div class="template-card-header">
          <h6 class="mb-1" data-auto-close-title>–®–∞–±–ª–æ–Ω –∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏—è</h6>
          <div class="small text-muted dialog-template-summary" data-auto-close-summary>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏—è.</div>
        </div>
        <div class="d-flex flex-column flex-lg-row align-items-center justify-content-between gap-3 mt-3">
          <div class="form-check">
            <input class="form-check-input" type="radio" id="auto-template-active-${safeIdAttr}" name="autoCloseActive" value="${safeIdAttr}" data-auto-close-active>
            <label class="form-check-label small" for="auto-template-active-${safeIdAttr}">–ê–∫—Ç–∏–≤–Ω—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
          </div>
          <div class="btn-group btn-group-sm template-card-actions">
            <button class="btn btn-outline-primary" type="button" data-dialog-template-toggle onclick="toggleDialogTemplateEditor(this)">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å</button>
            <button class="btn btn-outline-danger" type="button" onclick="removeAutoCloseTemplate(this)">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
        <div class="dialog-template-editor bg-light mt-3" data-dialog-template-editor>
          <div class="mb-3">
            <label class="form-label" for="auto-template-name-${safeIdAttr}">–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞</label>
            <input type="text" class="form-control form-control-sm auto-close-template-name" id="auto-template-name-${safeIdAttr}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 24 —á–∞—Å–∞" value="${safeName}">
          </div>
          <div class="row g-2">
            <div class="col-lg-4">
              <label class="form-label" for="auto-template-hours-${safeIdAttr}">–ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –∑–∞–∫—Ä—ã–≤–∞—Ç—å (—á–∞—Å—ã)</label>
              <input type="number" class="form-control form-control-sm auto-close-template-hours" id="auto-template-hours-${safeIdAttr}" min="1" max="720" step="1" value="${hours}">
              <div class="form-text">–ú–∏–Ω–∏–º—É–º 1 —á–∞—Å, –º–∞–∫—Å–∏–º—É–º 720 —á–∞—Å–æ–≤.</div>
            </div>
            <div class="col-lg-8">
              <label class="form-label" for="auto-template-description-${safeIdAttr}">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
              <textarea class="form-control form-control-sm auto-close-template-description" id="auto-template-description-${safeIdAttr}" rows="2" placeholder="–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–ª–∏ —É—Å–ª–æ–≤–∏—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è.">${safeDescription}</textarea>
            </div>
          </div>
        </div>
      </div>
    `;

    list.appendChild(card);

    const nameInput = card.querySelector('.auto-close-template-name');
    const hoursInput = card.querySelector('.auto-close-template-hours');
    const descriptionInput = card.querySelector('.auto-close-template-description');
    const activeInput = card.querySelector('[data-auto-close-active]');

    const updateSummary = () => updateAutoCloseTemplateSummary(card);

    nameInput?.addEventListener('input', updateSummary);
    descriptionInput?.addEventListener('input', updateSummary);
    hoursInput?.addEventListener('input', () => {
      if (!hoursInput) return;
      const value = Math.round(Number(hoursInput.value));
      if (!Number.isFinite(value) || value <= 0) {
        hoursInput.classList.add('is-invalid');
      } else {
        hoursInput.classList.remove('is-invalid');
      }
      updateSummary();
    });

    activeInput?.addEventListener('change', () => {
      document.querySelectorAll('[data-auto-close-template]').forEach((otherCard) => {
        if (!(otherCard instanceof HTMLElement)) return;
        otherCard.classList.toggle('border-primary', otherCard === card && activeInput.checked);
      });
    });

    const hasCustomHours = data && typeof data === 'object' && Object.prototype.hasOwnProperty.call(data, 'hours');
    const hasInitialData = Boolean(name) || Boolean(description) || hasCustomHours;
    toggleDialogTemplateEditor(card, !hasInitialData);
    updateAutoCloseTemplateSummary(card);
    return card;
  }

  function updateAutoCloseTemplateSummary(card) {
    if (!(card instanceof HTMLElement)) return;
    const nameInput = card.querySelector('.auto-close-template-name');
    const hoursInput = card.querySelector('.auto-close-template-hours');
    const descriptionInput = card.querySelector('.auto-close-template-description');
    const titleEl = card.querySelector('[data-auto-close-title]');
    const summaryEl = card.querySelector('[data-auto-close-summary]');
    const name = (nameInput?.value || '').trim();
    const description = (descriptionInput?.value || '').trim();
    const hoursValue = Math.round(Number(hoursInput?.value));

    if (titleEl) {
      titleEl.textContent = name || '–®–∞–±–ª–æ–Ω –∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏—è';
    }

    if (summaryEl) {
      if (!Number.isFinite(hoursValue) || hoursValue <= 0) {
        summaryEl.textContent = '–£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏—è –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–ø–∏—Å–∞–Ω–∏–µ.';
      } else {
        const normalized = Math.min(Math.max(hoursValue, 1), 720);
        const hoursText = `${normalized} ${pluralizeRussian(normalized, ['—á–∞—Å', '—á–∞—Å–∞', '—á–∞—Å–æ–≤'])}`;
        if (description) {
          summaryEl.textContent = `–ó–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ ${hoursText}. ${description}`;
        } else {
          summaryEl.textContent = `–ó–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ ${hoursText}.`;
        }
      }
    }
  }

  function addAutoCloseTemplate(template) {
    const card = buildAutoCloseTemplateCard(template);
    if (!card) return;
    const activeInput = card.querySelector('[data-auto-close-active]');
    if (activeInput) {
      const shouldActivate = template?.isActive === true;
      activeInput.checked = shouldActivate;
      if (shouldActivate) {
        activeInput.dispatchEvent(new Event('change'));
      }
    }
  }

  function removeAutoCloseTemplate(trigger) {
    const card = trigger?.closest('[data-auto-close-template]');
    const list = document.querySelector('[data-auto-close-templates]');
    if (!card || !list) return;
    const wasActive = card.querySelector('[data-auto-close-active]')?.checked;
    card.remove();
    if (!list.querySelector('[data-auto-close-template]')) {
      addAutoCloseTemplate({ hours: AUTO_CLOSE_FALLBACK_HOURS, isActive: true });
    }
    if (wasActive) {
      const firstRadio = list.querySelector('[data-auto-close-template] [data-auto-close-active]');
      if (firstRadio instanceof HTMLInputElement) {
        firstRadio.checked = true;
        firstRadio.dispatchEvent(new Event('change'));
      }
    }
  }

  function collectAutoCloseConfig() {
    const cards = Array.from(document.querySelectorAll('[data-auto-close-template]'));
    const templates = [];
    let hasInvalidHours = false;
    cards.forEach((card, index) => {
      if (!(card instanceof HTMLElement)) return;
      let templateId = card.dataset.templateId || generateDialogTemplateId('auto');
      card.dataset.templateId = templateId;
      const nameInput = card.querySelector('.auto-close-template-name');
      const hoursInput = card.querySelector('.auto-close-template-hours');
      const descriptionInput = card.querySelector('.auto-close-template-description');
      const name = (nameInput?.value || '').trim();
      const description = (descriptionInput?.value || '').trim();
      const rawHours = Math.round(Number(hoursInput?.value));
      if (!Number.isFinite(rawHours) || rawHours <= 0) {
        hasInvalidHours = true;
        hoursInput?.classList.add('is-invalid');
        return;
      }
      const normalizedHours = Math.min(Math.max(rawHours, 1), 720);
      if (hoursInput) {
        hoursInput.classList.remove('is-invalid');
        hoursInput.value = normalizedHours;
      }
      if (!templateId) {
        templateId = generateDialogTemplateId('auto');
        card.dataset.templateId = templateId;
      }
      templates.push({
        id: templateId,
        name: name || `–®–∞–±–ª–æ–Ω –∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏—è ${index + 1}`,
        hours: normalizedHours,
        description,
      });
    });
    const activeInput = document.querySelector('input[name="autoCloseActive"]:checked');
    const activeId = activeInput?.value && templates.some((tpl) => tpl.id === activeInput.value)
      ? activeInput.value
      : (templates[0]?.id || null);
    const errors = hasInvalidHours ? ['–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤ –¥–ª—è –≤—Å–µ—Ö —à–∞–±–ª–æ–Ω–æ–≤ –∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏—è.'] : [];
    return { templates, active_template_id: activeId, errors };
  }

  function initAutoCloseTemplates() {
    const list = document.querySelector('[data-auto-close-templates]');
    if (!list) return;
    list.innerHTML = '';
    const rawTemplates = Array.isArray(AUTO_CLOSE_CONFIG.templates) ? AUTO_CLOSE_CONFIG.templates : [];
    const activeId = typeof AUTO_CLOSE_CONFIG.active_template_id === 'string' ? AUTO_CLOSE_CONFIG.active_template_id : null;
    if (rawTemplates.length) {
      rawTemplates.forEach((template) => {
        const card = buildAutoCloseTemplateCard(template);
        if (!card) return;
        const radio = card.querySelector('[data-auto-close-active]');
        if (radio instanceof HTMLInputElement) {
          const isActive = typeof template?.id === 'string' && template.id === activeId;
          radio.checked = isActive;
          radio.dispatchEvent(new Event('change'));
          card.dataset.templateId = template.id || card.dataset.templateId;
        }
        updateAutoCloseTemplateSummary(card);
      });
    } else {
      const card = buildAutoCloseTemplateCard({ hours: AUTO_CLOSE_FALLBACK_HOURS });
      if (card) {
        const radio = card.querySelector('[data-auto-close-active]');
        if (radio instanceof HTMLInputElement) {
          radio.checked = true;
          radio.dispatchEvent(new Event('change'));
        }
      }
    }

    if (!document.querySelector('input[name="autoCloseActive"]:checked')) {
      const firstRadio = list.querySelector('[data-auto-close-template] [data-auto-close-active]');
      if (firstRadio instanceof HTMLInputElement) {
        firstRadio.checked = true;
        firstRadio.dispatchEvent(new Event('change'));
      }
    }
  }

  function getTimeMetricsInputs() {
    return {
      good: document.getElementById('timeMetricGoodLimit'),
      warning: document.getElementById('timeMetricWarningLimit'),
      goodColor: document.getElementById('timeMetricColorGood'),
      warningColor: document.getElementById('timeMetricColorWarning'),
      dangerColor: document.getElementById('timeMetricColorDanger'),
      preview: document.getElementById('timeMetricPreview'),
    };
  }

  function updateTimeMetricsPreview(metrics) {
    const inputs = getTimeMetricsInputs();
    if (!inputs.preview) return;
    const normalized = normalizeDialogTimeMetrics(metrics);
    const segments = [
      { label: `–ú–µ–Ω–µ–µ ${normalized.good_limit} –º–∏–Ω`, color: normalized.colors.good },
      { label: `–û—Ç ${normalized.good_limit} –¥–æ ${normalized.warning_limit} –º–∏–Ω`, color: normalized.colors.warning },
      { label: `–û—Ç ${normalized.warning_limit} –º–∏–Ω –∏ –±–æ–ª–µ–µ`, color: normalized.colors.danger },
    ];
    inputs.preview.innerHTML = segments
      .map(
        (segment) => `
          <div class="dialog-time-metrics-preview__chip" style="background-color: ${segment.color};">
            ${segment.label}
          </div>
        `
      )
      .join('');
  }

  function initTimeMetricsControls() {
    const inputs = getTimeMetricsInputs();
    if (!inputs.good || !inputs.warning || !inputs.goodColor || !inputs.warningColor || !inputs.dangerColor) {
      return;
    }
    const metrics = normalizeDialogTimeMetrics(DIALOG_CONFIG.time_metrics);
    inputs.good.value = metrics.good_limit;
    inputs.warning.value = metrics.warning_limit;
    inputs.goodColor.value = metrics.colors.good;
    inputs.warningColor.value = metrics.colors.warning;
    inputs.dangerColor.value = metrics.colors.danger;
    updateTimeMetricsPreview(metrics);

    [inputs.good, inputs.warning, inputs.goodColor, inputs.warningColor, inputs.dangerColor].forEach((input) => {
      if (!input) return;
      input.addEventListener('input', () => {
        if (input.classList.contains('is-invalid')) {
          input.classList.remove('is-invalid');
        }
        const snapshot = {
          good_limit: Number(inputs.good.value),
          warning_limit: Number(inputs.warning.value),
          colors: {
            good: inputs.goodColor.value,
            warning: inputs.warningColor.value,
            danger: inputs.dangerColor.value,
          },
        };
        updateTimeMetricsPreview(snapshot);
      });
    });
  }

  function collectTimeMetricsConfig() {
    const inputs = getTimeMetricsInputs();
    const errors = [];

    let goodLimit = Math.round(Number(inputs.good?.value));
    if (!Number.isFinite(goodLimit) || goodLimit <= 0) {
      errors.push('–£–∫–∞–∂–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∑–µ–ª—ë–Ω–æ–π –∑–æ–Ω—ã (–º–∏–Ω—É—Ç—ã).');
      if (inputs.good) {
        inputs.good.classList.add('is-invalid');
      }
      goodLimit = DEFAULT_DIALOG_TIME_METRICS.good_limit;
    } else if (inputs.good) {
      inputs.good.classList.remove('is-invalid');
      inputs.good.value = goodLimit;
    }

    let warningLimit = Math.round(Number(inputs.warning?.value));
    let warningValid = true;
    if (!Number.isFinite(warningLimit) || warningLimit <= 0) {
      errors.push('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∂—ë–ª—Ç–æ–π –∑–æ–Ω—ã (–º–∏–Ω—É—Ç—ã).');
      warningValid = false;
    } else if (warningLimit <= goodLimit) {
      errors.push('–ñ—ë–ª—Ç–∞—è –∑–æ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ –∑–µ–ª—ë–Ω–æ–π.');
      warningValid = false;
    }

    if (!warningValid) {
      warningLimit = Math.max(goodLimit + 1, DEFAULT_DIALOG_TIME_METRICS.warning_limit);
      if (inputs.warning) {
        inputs.warning.classList.add('is-invalid');
      }
    } else if (inputs.warning) {
      inputs.warning.classList.remove('is-invalid');
      inputs.warning.value = warningLimit;
    }

    const config = normalizeDialogTimeMetrics({
      good_limit: goodLimit,
      warning_limit: warningLimit,
      colors: {
        good: inputs.goodColor?.value,
        warning: inputs.warningColor?.value,
        danger: inputs.dangerColor?.value,
      },
    });

    updateTimeMetricsPreview(config);

    return { config, errors };
  }

  function initDialogTemplates() {
    const categoryTemplates = Array.isArray(DIALOG_CONFIG.category_templates)
      ? DIALOG_CONFIG.category_templates
      : [];
    if (categoryTemplates.length) {
      categoryTemplates.forEach((template) => addCategoryTemplate(template));
    } else {
      const fallback = Array.isArray(FALLBACK_DIALOG_CATEGORIES)
        ? [...FALLBACK_DIALOG_CATEGORIES]
        : [];
      addCategoryTemplate({ categories: fallback });
    }

    const questionTemplates = Array.isArray(DIALOG_CONFIG.question_templates)
      ? DIALOG_CONFIG.question_templates
      : [];
    if (questionTemplates.length) {
      questionTemplates.forEach((template) => addQuestionTemplate(template));
    } else {
      addQuestionTemplate();
    }

    const completionTemplates = Array.isArray(DIALOG_CONFIG.completion_templates)
      ? DIALOG_CONFIG.completion_templates
      : [];
    if (completionTemplates.length) {
      completionTemplates.forEach((template) => addCompletionTemplate(template));
    } else {
      addCompletionTemplate();
    }
  }

  // === –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ ===
  async function saveSettings() {
    try {
      const autoCloseState = collectAutoCloseConfig();
      if (autoCloseState.errors && autoCloseState.errors.length) {
        alert(autoCloseState.errors.join('\n'));
        return;
      }
      if (!autoCloseState.templates.length) {
        alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —à–∞–±–ª–æ–Ω –∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏—è.');
        return;
      }
      const activeTemplate = autoCloseState.templates.find((tpl) => tpl.id === autoCloseState.active_template_id)
        || autoCloseState.templates[0];
      const autoCloseHours = activeTemplate?.hours || AUTO_CLOSE_FALLBACK_HOURS;
      const autoClosePayload = {
        templates: autoCloseState.templates,
        active_template_id: autoCloseState.active_template_id,
      };

      const timeMetricsState = collectTimeMetricsConfig();
      if (timeMetricsState.errors && timeMetricsState.errors.length) {
        const uniqueErrors = Array.from(new Set(timeMetricsState.errors));
        alert(uniqueErrors.join('\n'));
        return;
      }

      // –°–æ–±–∏—Ä–∞–µ–º —à–∞–±–ª–æ–Ω—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π
      const categoryTemplates = Array.from(document.querySelectorAll('[data-category-template]')).map((card, index) => {
        if (!(card instanceof HTMLElement)) return null;
        const templateId = card.dataset.templateId || generateDialogTemplateId('cat');
        card.dataset.templateId = templateId;
        const name = (card.querySelector('.category-template-name')?.value || '').trim();
        const categories = Array.from(card.querySelectorAll('.category-item-input'))
          .map((input) => (input.value || '').trim())
          .filter((value) => value);
        return {
          id: templateId,
          name: name || `–®–∞–±–ª–æ–Ω –∫–∞—Ç–µ–≥–æ—Ä–∏–π ${index + 1}`,
          categories,
        };
      }).filter(Boolean);

      const fallbackCategories = categoryTemplates.length ? categoryTemplates[0].categories : [];

      // –°–æ–±–∏—Ä–∞–µ–º —à–∞–±–ª–æ–Ω—ã –≤–æ–ø—Ä–æ—Å–æ–≤
      const questionTemplates = Array.from(document.querySelectorAll('[data-question-template]')).map((card, index) => {
        if (!(card instanceof HTMLElement)) return null;
        const templateId = card.dataset.templateId || generateDialogTemplateId('q');
        card.dataset.templateId = templateId;
        const name = (card.querySelector('.question-template-name')?.value || '').trim();
        const questions = Array.from(card.querySelectorAll('.question-item-input'))
          .map((input) => (input.value || '').trim())
          .filter((value) => value);
        return {
          id: templateId,
          name: name || `–®–∞–±–ª–æ–Ω –≤–æ–ø—Ä–æ—Å–æ–≤ ${index + 1}`,
          questions,
        };
      }).filter(Boolean);

      // –°–æ–±–∏—Ä–∞–µ–º —à–∞–±–ª–æ–Ω—ã –¥–µ–π—Å—Ç–≤–∏–π
      const completionTemplates = Array.from(document.querySelectorAll('[data-completion-template]')).map((card, index) => {
        if (!(card instanceof HTMLElement)) return null;
        const templateId = card.dataset.templateId || generateDialogTemplateId('act');
        card.dataset.templateId = templateId;
        const name = (card.querySelector('.completion-template-name')?.value || '').trim();
        const items = Array.from(card.querySelectorAll('[data-completion-item]'))
          .map((row) => {
            if (!(row instanceof HTMLElement)) return null;
            const question = (row.querySelector('.completion-question-input')?.value || '').trim();
            const action = (row.querySelector('.completion-action-input')?.value || '').trim();
            if (!question && !action) return null;
            return { question, action };
          })
          .filter(Boolean);
        return {
          id: templateId,
          name: name || `–®–∞–±–ª–æ–Ω –¥–µ–π—Å—Ç–≤–∏–π ${index + 1}`,
          items,
        };
      }).filter(Boolean);

      // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã
      const statuses = Array.from(document.querySelectorAll('#statusesList .status-input'))
        .map(inp => inp.value.trim())
        .filter(v => v);

      const networkProfilesPayload = collectNetworkProfilesPayload();

      const response = await fetch('/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          categories: fallbackCategories,
          client_statuses: statuses,
          locations: locationsState,
          network_profiles: networkProfilesPayload,
          dialog_category_templates: categoryTemplates,
          dialog_question_templates: questionTemplates,
          dialog_completion_templates: completionTemplates,
          dialog_time_metrics: timeMetricsState.config,
          auto_close_config: autoClosePayload,
          auto_close_hours: autoCloseHours,
        })
      });
      
      const data = await response.json();
      if (data.success) {
        alert('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
      } else {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
      }
    } catch (error) {
      alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
    }
  }

  // === –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ===
  document.addEventListener('DOMContentLoaded', () => {
    initClientStatuses();
    initAutoCloseTemplates();
    initDialogTemplates();
    initTimeMetricsControls();
    initLocationWizard();
    buildLocationsTree();
    initChannelsManagement();
    loadParameters();
    renderNetworkProfiles();

    try {
      const params = new URLSearchParams(window.location.search);
      if (params.get('open') === 'channels') {
        const channelsModalEl = document.getElementById('channelsModal');
        if (channelsModalEl && typeof bootstrap !== 'undefined') {
          bootstrap.Modal.getOrCreateInstance(channelsModalEl).show();
        }
      }
    } catch (e) {
      console.error('Failed to process URL parameters', e);
    }
  });

  // === –ö–ê–ù–ê–õ–´ (–±–æ—Ç—ã) ===
  const channelsBody = document.getElementById('channelsBody');

  const vkWebhookState = {
    channelId: null,
    groupId: null,
    confirmationToken: '',
    secret: '',
  };

  let channelsInitialized = false;

  function escapeHtml(value) {
    if (value === null || value === undefined) return '';
    return String(value)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function openVkSettings(id) {
    const row = document.querySelector(`tr[data-id="${id}"]`);
    if (!row) return;
    const platformConfigRaw = row.dataset.platformConfig || '{}';
    let platformConfig = {};
    try {
      platformConfig = JSON.parse(platformConfigRaw);
    } catch (error) {
      platformConfig = {};
    }
    const groupId = platformConfig.group_id ?? platformConfig.groupId ?? null;
    const confirmationToken = platformConfig.confirmation_token ?? platformConfig.confirmationToken ?? '';
    const secret = platformConfig.secret ?? platformConfig.callback_secret ?? '';
    vkWebhookState.channelId = id;
    vkWebhookState.groupId = groupId;
    vkWebhookState.confirmationToken = confirmationToken;
    vkWebhookState.secret = secret;

    const groupInput = document.getElementById('vkGroupIdInput');
    const confirmationInput = document.getElementById('vkConfirmationInput');
    const secretInput = document.getElementById('vkSecretInput');
    if (groupInput) groupInput.value = groupId || '';
    if (confirmationInput) confirmationInput.value = confirmationToken || '';
    if (secretInput) secretInput.value = secret || '';

    const modalEl = document.getElementById('vkWebhookModal');
    if (modalEl && typeof bootstrap !== 'undefined') {
      bootstrap.Modal.getOrCreateInstance(modalEl).show();
    }
  }

  async function saveVkWebhookSettings() {
    if (vkWebhookState.channelId === null) return;
    const groupInput = document.getElementById('vkGroupIdInput');
    const confirmationInput = document.getElementById('vkConfirmationInput');
    const secretInput = document.getElementById('vkSecretInput');
    const groupIdVal = groupInput?.value?.trim();
    const confirmationVal = confirmationInput?.value?.trim();
    const secretVal = secretInput?.value?.trim();

    let groupId = parseInt(groupIdVal, 10);
    if (!Number.isFinite(groupId) || groupId <= 0) {
      alert('group_id –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º.');
      return;
    }
    if (!confirmationVal) {
      alert('–£–∫–∞–∂–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è Callback API.');
      return;
    }

    const payload = {
      platform_config: {
        group_id: groupId,
        confirmation_token: confirmationVal,
      },
    };
    payload.platform_config.secret = secretVal || null;

    try {
      const resp = await fetch(`/api/channels/${vkWebhookState.channelId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await resp.json();
      if (!resp.ok || data.success === false) {
        throw new Error(data.error || ('HTTP ' + resp.status));
      }

      const row = document.querySelector(`tr[data-id="${vkWebhookState.channelId}"]`);
      if (row) {
        const existing = row.dataset.platformConfig ? JSON.parse(row.dataset.platformConfig) : {};
        const updated = Object.assign({}, existing, payload.platform_config);
        if (!updated.secret) {
          delete updated.secret;
        }
        row.dataset.platformConfig = JSON.stringify(updated);
        const platformCell = row.querySelector('td:nth-child(4)');
        if (platformCell) {
          const infoEl = platformCell.querySelector('.small.text-muted');
          if (infoEl) {
            infoEl.textContent = `group_id: ${groupId}`;
          }
        }
      }

      const modalEl = document.getElementById('vkWebhookModal');
      if (modalEl && typeof bootstrap !== 'undefined') {
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal?.hide();
      }
      alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ–±—Ö—É–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.');
    } catch (error) {
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ–±—Ö—É–∫–∞: ' + error.message);
    }
  }

  function maskToken(token) {
    const str = String(token || '').trim();
    if (!str) return '‚Äî';
    if (str.length <= 10) return str;
    return `${str.slice(0, 6)}‚Ä¶${str.slice(-4)}`;
  }

  function pluralize(count, forms) {
    const n = Math.abs(count) % 100;
    const n1 = n % 10;
    if (n > 10 && n < 20) return forms[2];
    if (n1 > 1 && n1 < 5) return forms[1];
    if (n1 === 1) return forms[0];
    return forms[2];
  }

  const BOT_SETTINGS_DATA = BOT_SETTINGS_INITIAL && typeof BOT_SETTINGS_INITIAL === 'object' ? BOT_SETTINGS_INITIAL : {};
  const QUESTION_TEMPLATES = Array.isArray(BOT_SETTINGS_DATA.question_templates)
    ? BOT_SETTINGS_DATA.question_templates.filter((tpl) => tpl && typeof tpl === 'object' && tpl.id)
    : [];
  const QUESTION_TEMPLATE_MAP = new Map(
    QUESTION_TEMPLATES.map((tpl) => [String(tpl.id || '').trim(), tpl])
  );
  const DEFAULT_QUESTION_TEMPLATE_ID = (() => {
    const raw = typeof BOT_SETTINGS_DATA.active_template_id === 'string'
      ? BOT_SETTINGS_DATA.active_template_id.trim()
      : '';
    if (raw && QUESTION_TEMPLATE_MAP.has(raw)) {
      return raw;
    }
    const first = QUESTION_TEMPLATES.find((tpl) => tpl && tpl.id);
    return first ? String(first.id).trim() : '';
  })();

  const RATING_TEMPLATES = Array.isArray(BOT_SETTINGS_DATA.rating_templates)
    ? BOT_SETTINGS_DATA.rating_templates.filter((tpl) => tpl && typeof tpl === 'object' && tpl.id)
    : [];
  const RATING_TEMPLATE_MAP = new Map(
    RATING_TEMPLATES.map((tpl) => [String(tpl.id || '').trim(), tpl])
  );
  const DEFAULT_RATING_TEMPLATE_ID = (() => {
    const raw = typeof BOT_SETTINGS_DATA.active_rating_template_id === 'string'
      ? BOT_SETTINGS_DATA.active_rating_template_id.trim()
      : '';
    if (raw && RATING_TEMPLATE_MAP.has(raw)) {
      return raw;
    }
    const first = RATING_TEMPLATES.find((tpl) => tpl && tpl.id);
    return first ? String(first.id).trim() : '';
  })();

  const AUTO_ACTION_TEMPLATES = Array.isArray(AUTO_CLOSE_CONFIG.templates)
    ? AUTO_CLOSE_CONFIG.templates.filter((tpl) => tpl && typeof tpl === 'object' && tpl.id)
    : [];
  const AUTO_ACTION_TEMPLATE_MAP = new Map(
    AUTO_ACTION_TEMPLATES.map((tpl) => [String(tpl.id || '').trim(), tpl])
  );
  const DEFAULT_AUTO_ACTION_TEMPLATE_ID = (() => {
    const raw = typeof AUTO_CLOSE_CONFIG.active_template_id === 'string'
      ? AUTO_CLOSE_CONFIG.active_template_id.trim()
      : '';
    if (raw && AUTO_ACTION_TEMPLATE_MAP.has(raw)) {
      return raw;
    }
    const first = AUTO_ACTION_TEMPLATES.find((tpl) => tpl && tpl.id);
    return first ? String(first.id).trim() : '';
  })();

  function sanitizeTemplateId(raw, map, fallback) {
    const value = typeof raw === 'string' ? raw.trim() : '';
    if (value && map.has(value)) {
      return value;
    }
    return fallback || '';
  }

  function buildTemplateOptions(templates, selectedId) {
    if (!templates.length) {
      return '<option value="" selected>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤</option>';
    }
    return templates
      .map((tpl) => {
        const id = String(tpl.id || '').trim();
        if (!id) {
          return '';
        }
        const name = tpl.name ? String(tpl.name).trim() : id;
        const selected = id === selectedId ? ' selected' : '';
        return `<option value="${escapeHtml(id)}"${selected}>${escapeHtml(name || id)}</option>`;
      })
      .filter(Boolean)
      .join('');
  }

  function getQuestionTemplateSummary(id) {
    if (!QUESTION_TEMPLATE_MAP.size) {
      return '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤';
    }
    const templateId = sanitizeTemplateId(id, QUESTION_TEMPLATE_MAP, DEFAULT_QUESTION_TEMPLATE_ID);
    const template = QUESTION_TEMPLATE_MAP.get(templateId);
    if (!template) {
      return '–®–∞–±–ª–æ–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω';
    }
    const flow = Array.isArray(template.question_flow)
      ? template.question_flow
      : Array.isArray(template.questions)
        ? template.questions
        : [];
    const count = flow.length;
    const base = count
      ? `${count} ${pluralize(count, ['–≤–æ–ø—Ä–æ—Å', '–≤–æ–ø—Ä–æ—Å–∞', '–≤–æ–ø—Ä–æ—Å–æ–≤'])}`
      : '–ë–µ–∑ –≤–æ–ø—Ä–æ—Å–æ–≤';
    const description = typeof template.description === 'string' && template.description.trim()
      ? template.description.trim()
      : '';
    return description ? `${base} ‚Ä¢ ${description}` : base;
  }

  function getRatingTemplateSummary(id) {
    if (!RATING_TEMPLATE_MAP.size) {
      return '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤';
    }
    const templateId = sanitizeTemplateId(id, RATING_TEMPLATE_MAP, DEFAULT_RATING_TEMPLATE_ID);
    const template = RATING_TEMPLATE_MAP.get(templateId);
    if (!template) {
      return '–®–∞–±–ª–æ–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω';
    }
    const scale = Number.parseInt(template.scale_size, 10)
      || (Array.isArray(template.responses) ? template.responses.length : 0)
      || 0;
    const base = scale > 1 ? `–®–∫–∞–ª–∞ 1‚Äì${scale}` : '–ï–¥–∏–Ω–∞—è –æ—Ü–µ–Ω–∫–∞';
    const prompt = typeof template.prompt_text === 'string' && template.prompt_text.trim()
      ? template.prompt_text.trim()
      : '';
    return prompt ? `${base} ‚Ä¢ ${prompt}` : base;
  }

  function getAutoActionTemplateSummary(id) {
    if (!AUTO_ACTION_TEMPLATE_MAP.size) {
      return '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤';
    }
    const templateId = sanitizeTemplateId(id, AUTO_ACTION_TEMPLATE_MAP, DEFAULT_AUTO_ACTION_TEMPLATE_ID);
    const template = AUTO_ACTION_TEMPLATE_MAP.get(templateId);
    if (!template) {
      return '–®–∞–±–ª–æ–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω';
    }
    const hours = Number.parseInt(template.hours, 10);
    const hasHours = Number.isFinite(hours) && hours > 0;
    const base = hasHours
      ? `–ê–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ ${hours} ${pluralize(hours, ['—á–∞—Å', '—á–∞—Å–∞', '—á–∞—Å–æ–≤'])}`
      : '–ê–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ';
    const description = typeof template.description === 'string' && template.description.trim()
      ? template.description.trim()
      : '';
    return description ? `${base} ‚Ä¢ ${description}` : base;
  }

  const TEMPLATE_SUMMARY_BUILDERS = {
    question_template_id: getQuestionTemplateSummary,
    rating_template_id: getRatingTemplateSummary,
    auto_action_template_id: getAutoActionTemplateSummary,
  };

  function attachTemplateSummary(selectEl) {
    if (!(selectEl instanceof HTMLSelectElement)) {
      return;
    }
    const field = selectEl.dataset.field;
    const builder = TEMPLATE_SUMMARY_BUILDERS[field];
    const summaryEl = selectEl.closest('td')?.querySelector(`[data-template-summary="${field}"]`);
    if (typeof builder !== 'function' || !summaryEl) {
      return;
    }
    const update = () => {
      summaryEl.textContent = builder(selectEl.value || '');
    };
    update();
    selectEl.addEventListener('change', update);
  }

  function parsePlatformConfig(raw) {
    if (!raw) return {};
    if (typeof raw === 'string') {
      try {
        const value = JSON.parse(raw);
        return value && typeof value === 'object' ? value : {};
      } catch (e) {
        return {};
      }
    }
    if (typeof raw === 'object') {
      return Object.assign({}, raw);
    }
    return {};
  }

  function renderChannels(rows) {
    if (!channelsBody) return;
    channelsBody.innerHTML = '';
    if (!rows.length) {
      channelsBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">–ö–∞–Ω–∞–ª—ã –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</td></tr>';
      return;
    }
    rows.forEach((row) => {
      const platform = String(row.platform || 'telegram').toLowerCase();
      const platformLabel = platform === 'vk' ? 'VK' : 'Telegram';
      const platformConfig = parsePlatformConfig(row.platform_config);
      const vkGroupId = platform === 'vk' ? (platformConfig.group_id ?? platformConfig.groupId) : null;
      const questionTemplateId = sanitizeTemplateId(row.question_template_id, QUESTION_TEMPLATE_MAP, DEFAULT_QUESTION_TEMPLATE_ID);
      const ratingTemplateId = sanitizeTemplateId(row.rating_template_id, RATING_TEMPLATE_MAP, DEFAULT_RATING_TEMPLATE_ID);
      const autoTemplateId = sanitizeTemplateId(row.auto_action_template_id, AUTO_ACTION_TEMPLATE_MAP, DEFAULT_AUTO_ACTION_TEMPLATE_ID);

      const tr = document.createElement('tr');
      tr.dataset.id = row.id;
      tr.dataset.platform = platform;
      tr.dataset.platformConfig = JSON.stringify(platformConfig);
      tr.innerHTML = `
        <td class="fw-semibold">#${row.id}</td>
        <td>
          <div class="fw-medium">${escapeHtml(row.channel_name || '‚Äî')}</div>
          <div class="text-muted small">
            –ë–æ—Ç: ${escapeHtml(row.bot_name || '‚Äî')}${row.bot_username ? ` (@${escapeHtml(row.bot_username)})` : ''}
          </div>
          <div class="text-muted small">–¢–æ–∫–µ–Ω: ${escapeHtml(maskToken(row.token))}</div>
          <div class="text-muted small">ID –¥–ª—è —Ñ–æ—Ä–º: <span class="font-monospace">${escapeHtml(row.public_id || '‚Äî')}</span></div>
        </td>
        <td>
          <input class="form-control form-control-sm" data-field="channel_name" value="${escapeHtml(row.channel_name || '')}">
        </td>
        <td>
          <div><span class="badge bg-secondary-subtle text-uppercase">${escapeHtml(platformLabel)}</span></div>
          ${vkGroupId ? `<div class="small text-muted">group_id: ${escapeHtml(String(vkGroupId))}</div>` : ''}
          ${platform === 'vk'
            ? `<button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="openVkSettings(${row.id})">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤–µ–±—Ö—É–∫‚Ä¶</button>`
            : ''}
        </td>
        <td class="text-center align-middle">
          <div class="form-check form-switch d-inline-flex align-items-center gap-2">
            <input class="form-check-input" type="checkbox" data-field="is_active" ${row.is_active ? 'checked' : ''}>
            <label class="form-check-label small" data-status-label>${row.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–í—ã–∫–ª—é—á–µ–Ω'}</label>
          </div>
        </td>
        <td>
          <div class="d-flex flex-column gap-1">
            <select class="form-select form-select-sm" data-field="question_template_id" ${QUESTION_TEMPLATES.length ? '' : 'disabled'}>
              ${buildTemplateOptions(QUESTION_TEMPLATES, questionTemplateId)}
            </select>
            <div class="form-text small" data-template-summary="question_template_id">${escapeHtml(getQuestionTemplateSummary(questionTemplateId))}</div>
          </div>
        </td>
        <td>
          <div class="d-flex flex-column gap-1">
            <select class="form-select form-select-sm" data-field="rating_template_id" ${RATING_TEMPLATES.length ? '' : 'disabled'}>
              ${buildTemplateOptions(RATING_TEMPLATES, ratingTemplateId)}
            </select>
            <div class="form-text small" data-template-summary="rating_template_id">${escapeHtml(getRatingTemplateSummary(ratingTemplateId))}</div>
          </div>
        </td>
        <td>
          <div class="d-flex flex-column gap-1">
            <select class="form-select form-select-sm" data-field="auto_action_template_id" ${AUTO_ACTION_TEMPLATES.length ? '' : 'disabled'}>
              ${buildTemplateOptions(AUTO_ACTION_TEMPLATES, autoTemplateId)}
            </select>
            <div class="form-text small" data-template-summary="auto_action_template_id">${escapeHtml(getAutoActionTemplateSummary(autoTemplateId))}</div>
          </div>
        </td>
        <td class="text-nowrap">
          <button type="button" class="btn btn-sm btn-success me-2" onclick="saveChannel(${row.id})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeChannel(${row.id})">–£–¥–∞–ª–∏—Ç—å</button>
        </td>
      `;

      const statusSwitch = tr.querySelector('[data-field="is_active"]');
      const statusLabel = tr.querySelector('[data-status-label]');
      if (statusSwitch && statusLabel) {
        statusSwitch.addEventListener('change', () => {
          statusLabel.textContent = statusSwitch.checked ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–í—ã–∫–ª—é—á–µ–Ω';
        });
      }

      tr.querySelectorAll('select[data-field]').forEach(attachTemplateSummary);
      channelsBody.appendChild(tr);
    });
  }

  async function loadChannels() {
    if (!channelsBody) return;
    try {
      const resp = await fetch('/api/channels');
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const rows = await resp.json();
      renderChannels(Array.isArray(rows) ? rows : []);
    } catch (error) {
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞–Ω–∞–ª—ã: ' + error.message);
    }
  }

  async function addChannel() {
    const tokenInput = document.getElementById('new_token');
    const nameInput = document.getElementById('new_channel_name');
    const platformSelect = document.getElementById('new_platform');
    const questionSelect = document.getElementById('new_question_template');
    const ratingSelect = document.getElementById('new_rating_template');
    const autoSelect = document.getElementById('new_auto_action_template');
    const vkGroupInput = document.getElementById('new_vk_group_id');
    const vkConfirmInput = document.getElementById('new_vk_confirmation');
    const vkSecretInput = document.getElementById('new_vk_secret');

    const platform = platformSelect?.value || 'telegram';
    const token = tokenInput?.value?.trim() || '';
    const channelName = nameInput?.value?.trim() || '';

    if (!channelName) {
      alert('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞.');
      return;
    }
    if (platform !== 'vk' && !token) {
      alert('–î–ª—è Telegram –Ω–µ–æ–±—Ö–æ–¥–∏–º —Ç–æ–∫–µ–Ω –±–æ—Ç–∞.');
      return;
    }

    const payload = {
      token,
      channel_name: channelName,
      platform,
      is_active: true,
    };

    const questionTemplateId = questionSelect?.value || '';
    const ratingTemplateId = ratingSelect?.value || '';
    const autoTemplateId = autoSelect?.value || '';
    if (questionTemplateId) payload.question_template_id = questionTemplateId;
    if (ratingTemplateId) payload.rating_template_id = ratingTemplateId;
    if (autoTemplateId) payload.auto_action_template_id = autoTemplateId;

    if (platform === 'vk') {
      const groupId = Number.parseInt(vkGroupInput?.value || '0', 10);
      const confirmation = vkConfirmInput?.value?.trim() || '';
      if (!Number.isFinite(groupId) || groupId <= 0) {
        alert('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ VK.');
        return;
      }
      if (!confirmation) {
        alert('–£–∫–∞–∂–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è Callback API.');
        return;
      }
      payload.platform_config = { group_id: groupId, confirmation_token: confirmation };
      const secret = vkSecretInput?.value?.trim();
      if (secret) {
        payload.platform_config.secret = secret;
      }
    }

    try {
      const resp = await fetch('/api/channels', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await resp.json();
      if (!resp.ok || data.success === false) {
        throw new Error(data.error || ('HTTP ' + resp.status));
      }
      if (tokenInput) tokenInput.value = '';
      if (nameInput) nameInput.value = '';
      if (vkGroupInput) vkGroupInput.value = '';
      if (vkConfirmInput) vkConfirmInput.value = '';
      if (vkSecretInput) vkSecretInput.value = '';
      if (questionSelect && !questionSelect.disabled) {
        questionSelect.value = DEFAULT_QUESTION_TEMPLATE_ID;
      }
      if (ratingSelect && !ratingSelect.disabled) {
        ratingSelect.value = DEFAULT_RATING_TEMPLATE_ID;
      }
      if (autoSelect && !autoSelect.disabled) {
        autoSelect.value = DEFAULT_AUTO_ACTION_TEMPLATE_ID;
      }
      loadChannels();
    } catch (error) {
      alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞: ' + error.message);
    }
  }

  async function saveChannel(id) {
    const row = document.querySelector(`tr[data-id="${id}"]`);
    if (!row) return;
    const nameInput = row.querySelector('[data-field="channel_name"]');
    const activeInput = row.querySelector('[data-field="is_active"]');
    const questionSelect = row.querySelector('[data-field="question_template_id"]');
    const ratingSelect = row.querySelector('[data-field="rating_template_id"]');
    const autoSelect = row.querySelector('[data-field="auto_action_template_id"]');

    const channelName = (nameInput?.value || '').trim();
    if (!channelName) {
      alert('–£–∫–∞–∂–∏—Ç–µ –∏–º—è –∫–∞–Ω–∞–ª–∞.');
      return;
    }

    const body = {
      channel_name: channelName,
      is_active: activeInput?.checked ? 1 : 0,
    };

    const configPayload = {};
    if (questionSelect && !questionSelect.disabled) {
      const value = questionSelect.value || '';
      body.question_template_id = value;
      if (value) configPayload.question_template_id = value;
    }
    if (ratingSelect && !ratingSelect.disabled) {
      const value = ratingSelect.value || '';
      body.rating_template_id = value;
      if (value) configPayload.rating_template_id = value;
    }
    if (autoSelect && !autoSelect.disabled) {
      body.auto_action_template_id = autoSelect.value || '';
    }
    if (Object.keys(configPayload).length) {
      body.questions_cfg = configPayload;
    }

    try {
      const resp = await fetch(`/api/channels/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      const data = await resp.json();
      if (!resp.ok || data.success === false) {
        throw new Error(data.error || ('HTTP ' + resp.status));
      }
      alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–Ω–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.');
      loadChannels();
    } catch (error) {
      alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
    }
  }

  async function removeChannel(id) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞–Ω–∞–ª? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) return;
    try {
      const resp = await fetch(`/api/channels/${id}`, { method: 'DELETE' });
      const data = await resp.json();
      if (!resp.ok || data.success === false) throw new Error(data.error || ('HTTP ' + resp.status));
      await loadChannels();
    } catch (error) {
      alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message);
    }
  }

  function populateAddChannelTemplateSelects() {
    const questionSelect = document.getElementById('new_question_template');
    if (questionSelect) {
      questionSelect.innerHTML = buildTemplateOptions(QUESTION_TEMPLATES, DEFAULT_QUESTION_TEMPLATE_ID);
      questionSelect.disabled = !QUESTION_TEMPLATES.length;
    }
    const ratingSelect = document.getElementById('new_rating_template');
    if (ratingSelect) {
      ratingSelect.innerHTML = buildTemplateOptions(RATING_TEMPLATES, DEFAULT_RATING_TEMPLATE_ID);
      ratingSelect.disabled = !RATING_TEMPLATES.length;
    }
    const autoSelect = document.getElementById('new_auto_action_template');
    if (autoSelect) {
      autoSelect.innerHTML = buildTemplateOptions(AUTO_ACTION_TEMPLATES, DEFAULT_AUTO_ACTION_TEMPLATE_ID);
      autoSelect.disabled = !AUTO_ACTION_TEMPLATES.length;
    }
  }

  function togglePlatformFields() {
    const platformSelect = document.getElementById('new_platform');
    const tokenContainer = document.getElementById('token_field_container');
    const vkContainer = document.getElementById('vk_group_id_container');
    const platform = platformSelect?.value || 'telegram';
    if (tokenContainer) {
      tokenContainer.classList.toggle('d-none', platform === 'vk');
    }
    if (vkContainer) {
      vkContainer.style.display = platform === 'vk' ? '' : 'none';
    }
  }

  function initChannelsManagement() {
    if (channelsInitialized) return;
    channelsInitialized = true;
    populateAddChannelTemplateSelects();
    togglePlatformFields();
    loadChannels();

    const platformSelect = document.getElementById('new_platform');
    const vkSaveBtn = document.getElementById('vkWebhookSaveBtn');
    platformSelect?.addEventListener('change', togglePlatformFields);
    vkSaveBtn?.addEventListener('click', saveVkWebhookSettings);
  }

  window.addChannel = addChannel;
  window.saveChannel = saveChannel;
  window.removeChannel = removeChannel;
  window.openVkSettings = openVkSettings;

  </script>
</main>
  <script src="{{ url_for('static', filename='input-settings.js') }}"></script>
  <script src="{{ url_for('static', filename='auth-management.js') }}"></script>
  <script src="{{ url_for('static', filename='sidebar.js') }}"></script>
  <script src="{{ url_for('static', filename='modal-transitions.js') }}"></script>
  <script src="{{ url_for('static', filename='bot-settings.js') }}"></script>
</body>
</html>
