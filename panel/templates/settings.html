<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Настройки — Bender</title>
  <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='bender-icon.svg') }}" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='sidebar.css') }}" rel="stylesheet" />
  <style>
    .settings-tiles .settings-tile {
      border: 1px solid #e9ecef;
      border-radius: 1rem;
      background: linear-gradient(135deg, #f8f9fa, #ffffff);
      box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.08);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .settings-tiles .settings-tile--accent {
      background: linear-gradient(135deg, rgba(13, 110, 253, 0.12), #ffffff);
      border-color: rgba(13, 110, 253, 0.2);
      box-shadow: 0 0.25rem 0.75rem rgba(13, 110, 253, 0.15);
    }

    .settings-tiles .settings-tile.is-active {
      border-color: rgba(13, 110, 253, 0.45);
      box-shadow: 0 0.75rem 1.5rem rgba(13, 110, 253, 0.2);
      background: linear-gradient(135deg, rgba(13, 110, 253, 0.18), #ffffff);
    }

    .settings-tiles .settings-tile:hover {
      transform: translateY(-4px);
      box-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.12);
    }

    .settings-tiles .settings-tile .tile-icon {
      width: 3rem;
      height: 3rem;
      border-radius: 0.75rem;
      background: rgba(13, 110, 253, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }

    .settings-tiles .settings-tile--accent .tile-icon {
      background: rgba(13, 110, 253, 0.18);
      color: #0d6efd;
    }

    .settings-tiles .settings-tile .card-title {
      text-align: center;
      color: #0d6efd;
      font-weight: 600;
    }

    .settings-tiles .settings-tile--accent .card-text {
      color: #495057;
    }

    .it-section-accordion .accordion-button {
      background: linear-gradient(135deg, rgba(13, 110, 253, 0.12), rgba(13, 110, 253, 0.04));
      color: #0d6efd;
      font-weight: 600;
    }

    .it-section-accordion .accordion-button.collapsed {
      background: linear-gradient(135deg, rgba(13, 110, 253, 0.05), #ffffff);
      color: #0d6efd;
    }

    .it-section-accordion .accordion-button:focus {
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    .it-section-accordion .accordion-body {
      background-color: #fdfdfd;
    }

    .it-section-accordion .table thead th {
      background: rgba(13, 110, 253, 0.1);
      color: #0d6efd;
      border-bottom: 0;
    }

    .it-section-accordion--nested .accordion-item {
      border: 1px solid rgba(13, 110, 253, 0.15);
      border-radius: 0.75rem;
      overflow: hidden;
    }

    .it-section-accordion--nested .accordion-item + .accordion-item {
      margin-top: 0.75rem;
    }

    .it-section-accordion--nested .accordion-button {
      background: linear-gradient(135deg, rgba(13, 110, 253, 0.15), rgba(13, 110, 253, 0.05));
    }

    .it-section-accordion--nested .accordion-button.collapsed {
      background: linear-gradient(135deg, rgba(13, 110, 253, 0.08), rgba(13, 110, 253, 0.02));
    }

    .modal .card-header {
      background: linear-gradient(135deg, rgba(13, 110, 253, 0.12), rgba(13, 110, 253, 0.05));
      color: #0d6efd;
      font-weight: 600;
    }

    .modal .card-header:not(.d-flex) {
      text-align: center;
    }

    .parameter-card .param-items { min-height: 2.5rem; }
    .parameter-card .param-item .btn { min-width: 2.5rem; }
    .parameter-card .param-item input { min-width: 0; }
    .parameter-card .param-items .empty-placeholder { font-size: 0.9rem; color: #6c757d; }
    .parameter-card .card-header button[data-param-toggle] {
      border: 0;
      background: transparent;
      padding: 0;
      font-weight: 600;
      text-align: left;
      color: inherit;
    }
    .parameter-card.is-expanded .card-header {
      background-color: #f8f9fa;
    }
    .param-entry--deleted .form-control {
      text-decoration: line-through;
    }
    .parameter-card .param-items a.btn,
    .parameter-card .param-items .btn {
      min-width: 3rem;
    }
    .parameter-card .param-items .form-select {
      max-width: 10rem;
    }
    .partner-contact-card {
      transition: box-shadow 0.2s ease;
    }
    .partner-contact-card__title {
      color: #0d6efd;
    }
    .partner-contact-card__subtitle {
      color: #6c757d;
    }
    .partner-contact-card__header--state-active {
      background-color: #e8f5e9;
      border-bottom-color: #c7e8ce;
    }
    .partner-contact-card__header--state-active .partner-contact-card__title {
      color: #1b5e20;
    }
    .partner-contact-card__header--state-active .partner-contact-card__subtitle {
      color: #2e7d32;
    }
    .partner-contact-card__header--state-pending {
      background-color: #fff4d6;
      border-bottom-color: #ffe09f;
    }
    .partner-contact-card__header--state-pending .partner-contact-card__title {
      color: #9a6700;
    }
    .partner-contact-card__header--state-pending .partner-contact-card__subtitle {
      color: #b8860b;
    }
    .partner-contact-card__header--state-blocked,
    .partner-contact-card__header--state-blacklist {
      background-color: #fde2e4;
      border-bottom-color: #f5b5bb;
    }
    .partner-contact-card__header--state-blocked .partner-contact-card__title,
    .partner-contact-card__header--state-blacklist .partner-contact-card__title {
      color: #a4133c;
    }
    .partner-contact-card__header--state-blocked .partner-contact-card__subtitle,
    .partner-contact-card__header--state-blacklist .partner-contact-card__subtitle {
      color: #c9184a;
    }
    .partner-contact-card__header--state-closed {
      background-color: #f1f3f5;
      border-bottom-color: #d0d5db;
    }
    .partner-contact-card__header--state-closed .partner-contact-card__title {
      color: #495057;
    }
    .partner-contact-card__header--state-closed .partner-contact-card__subtitle {
      color: #6c757d;
    }
    .partner-contact-details {
      border: 1px solid #e9ecef;
      border-radius: 0.75rem;
      background-color: #fdfdfd;
    }
    .partner-contact-details__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem;
    }
    .partner-contact-details__toggle {
      border: 0;
      background: transparent;
      padding: 0;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-weight: 600;
      color: #0d6efd;
      text-align: left;
    }
    .partner-contact-details__toggle:focus {
      outline: none;
      box-shadow: none;
    }
    .partner-contact-details__title {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .partner-contact-details__body {
      padding: 0.75rem;
      border-top: 1px solid #e9ecef;
    }
    .partner-contact-details__chevron {
      transition: transform 0.2s ease;
    }
    .partner-contact-details.is-collapsed .partner-contact-details__body {
      display: none;
    }
    .partner-contact-details.is-collapsed .partner-contact-details__chevron {
      transform: rotate(-90deg);
    }
    .partner-contact-details.is-expanded .partner-contact-details__chevron {
      transform: rotate(0deg);
    }
    .partner-contact-person {
      border: 1px solid #dee2e6;
      border-radius: 0.75rem;
      background: linear-gradient(135deg, #ffffff, #f8f9fa);
      padding: 0.75rem;
    }
    .partner-contact-person + .partner-contact-person {
      margin-top: 0.75rem;
    }
    .partner-contact-person__actions {
      text-align: right;
    }
    .partner-contact-person-card__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 0.75rem;
    }
    .partner-contact-person-card__title {
      font-weight: 600;
    }
    .partner-contact-person-card__subtitle {
      font-size: 0.9rem;
      color: #6c757d;
    }
    .partner-contact-person-card__body .form-label {
      font-weight: 500;
    }
    .partner-contact-card--summary {
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      border: 1px solid #e9ecef;
      border-radius: 0.75rem;
      background: linear-gradient(135deg, #ffffff, #f8f9fa);
    }
    .partner-contact-card--summary:hover {
      transform: translateY(-4px);
      box-shadow: 0 0.75rem 1.5rem rgba(13, 110, 253, 0.15);
    }
    .partner-contact-card--summary .card-body {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      height: 100%;
    }
    .partner-contact-card--summary .partner-contact-summary-head {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      align-items: flex-start;
    }
    .partner-contact-card--summary .partner-contact-summary-title {
      font-weight: 600;
      color: #0d6efd;
    }
    .partner-contact-card--summary .partner-contact-summary-meta {
      font-size: 0.9rem;
      color: #6c757d;
    }
    .partner-contact-card--summary .partner-contact-summary-label {
      letter-spacing: 0.08em;
      font-weight: 600;
    }
    .partner-contact-card--summary .partner-contact-summary-value {
      font-size: 1rem;
    }
    .partner-contact-summary-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .partner-contact-summary-contact-title {
      font-weight: 600;
    }
    .partner-contact-summary-contact-meta {
      font-size: 0.85rem;
      color: #6c757d;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }
    .partner-contact-summary-empty {
      font-size: 0.9rem;
      color: #adb5bd;
    }
    .partner-contact-served-summary {
      font-size: 0.85rem;
      color: #6c757d;
      margin-top: 0.25rem;
    }
    .partner-contact-served-summary:empty {
      display: none;
    }
    .partner-contact-served-select {
      min-height: 6.5rem;
    }
    .partner-contact-card--modal {
      border: 0;
      box-shadow: none;
      height: auto !important;
      background: transparent;
    }
    .partner-contact-card--modal .card-header {
      border-bottom: 1px solid #e9ecef;
    }
    .partner-contact-card--modal .card-body {
      max-height: 65vh;
      overflow-y: auto;
    }
    .client-status-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .status-count-link {
      text-decoration: none;
      min-width: 3rem;
      text-align: center;
      font-weight: 600;
      border: 1px solid #ced4da;
      padding: 0.35rem 0.65rem;
      border-radius: 2rem;
      background-color: #f8f9fa;
      color: #0d6efd;
      transition: background-color 0.2s ease, color 0.2s ease;
    }
    .status-count-link:hover {
      background-color: #0d6efd;
      color: #fff;
    }
    .status-count-link.disabled {
      pointer-events: none;
      opacity: 0.65;
      color: #6c757d;
      background-color: #f1f3f5;
      border-color: #dee2e6;
    }
    .status-row .status-input[disabled] {
      background-color: #f8f9fa;
    }
    .location-tree-business .card-body { background: #fdfdfd; }
    .location-type-header { background: #f1f3f5; border-radius: 0.75rem; padding: 0.5rem 0.75rem; }
    .location-type-header .btn[data-bs-toggle="collapse"] { min-width: 7rem; }
    .location-type-body { padding: 0.75rem 0.25rem 0.25rem 2.25rem; }
    .location-city-block { background: #ffffff; border: 1px solid #e9ecef; border-radius: 0.75rem; padding: 0.75rem; }
    .location-city-block .input-group > .btn { min-width: 5.5rem; }
    .location-city-collapse { padding-top: 0.5rem; }
    .location-section-header { cursor: pointer; }
    .location-section-header .form-control[disabled],
    .location-city-block input[disabled],
    .location-entry-row input[disabled] {
      background-color: #f8f9fa;
    }
    .location-structure-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border-radius: 0.75rem;
      border: 1px solid transparent;
      transition: background-color 0.2s ease, border-color 0.2s ease;
      background-color: #fff;
    }
    .location-structure-row.location-entry-row {
      padding-right: 0.5rem;
    }
    .location-structure-row .location-name-input {
      flex: 1 1 auto;
      min-width: 12rem;
    }
    .location-status-select {
      min-width: 10rem;
      flex: 0 0 auto;
    }
    .location-actions {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      margin-left: auto;
      flex: 0 0 auto;
    }
    .location-actions .btn-icon {
      width: 2.25rem;
      height: 2.25rem;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.5rem;
    }
    .location-actions .btn-icon i {
      pointer-events: none;
      font-size: 1rem;
    }
    .location-actions .btn-icon:disabled {
      opacity: 0.5;
    }
    .location-structure-row.status-default {
      background-color: #f8f9fa;
      border-color: #e9ecef;
    }
    .location-structure-row.status-active {
      background-color: #e8f5e9;
      border-color: #c7e8ce;
    }
    .location-structure-row.status-closed {
      background-color: #fde2e4;
      border-color: #f5b5bb;
    }
    .location-structure-row.status-prelaunch {
      background-color: #fff4d6;
      border-color: #ffe09f;
    }
    .location-structure-row.status-paused {
      background-color: #f1f3f5;
      border-color: #d3d7dc;
    }
    .location-structure-row.status-frozen {
      background-color: #e3f2ff;
      border-color: #b6dcff;
    }
    .location-wizard-step .form-select.is-invalid { border-color: #dc3545; }
    .channel-questions-list .question-item { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 0.75rem; padding: 0.75rem; }
    .dialog-template-card .btn-group .btn { white-space: nowrap; }
    .dialog-template-summary { font-size: 0.9rem; }
    .template-card {
      border-radius: 1rem;
      border: 1px solid #e9ecef;
    }
    .template-card-header {
      background: linear-gradient(135deg, rgba(13, 110, 253, 0.18), rgba(13, 110, 253, 0.05));
      border-radius: 0.75rem;
      padding: 1rem;
      text-align: center;
    }
    .template-card-header h6 {
      color: #0d6efd;
      font-weight: 600;
    }
    .template-card-header p,
    .template-card-header .small {
      margin-bottom: 0;
      color: #495057;
      text-align: center;
    }
    .template-card-header p + .small,
    .template-card-header .small + .small {
      margin-top: 0.25rem;
    }
    .template-card-actions {
      justify-content: center;
    }
    .dialog-template-editor {
      border: 1px dashed #ced4da;
      border-radius: 0.75rem;
      padding: 1rem;
      background-color: #f8f9fa;
    }
    .dialog-template-editor .form-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #6c757d;
    }
    .dialog-template-editor .input-group > .btn,
    .dialog-template-editor .btn-sm {
      min-width: 2.5rem;
    }
    .modal-dialog {
      width: auto;
      max-width: min(90vw, var(--bs-modal-width, 500px));
      max-height: 90vh;
      margin-left: auto;
      margin-right: auto;
      overflow: auto;
      resize: both;
    }
    .modal-dialog.modal-lg {
      --bs-modal-width: 1000px;
    }
    .modal-dialog.modal-xl {
      --bs-modal-width: 1440px;
    }
    .modal-content {
      min-height: 100%;
      max-height: 100%;
      display: flex;
      flex-direction: column;
    }
    .modal-body {
      overflow-y: auto;
    }
  </style>
</head>
<body class="with-sidebar sidebar-pinned">
  {% include "_sidebar.html" %}
  <main class="main-content container-fluid">

  <div class="container mt-4">
    <h2>⚙️ Настройки системы</h2>

    <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 settings-tiles">
      <div class="col">
        <div class="card settings-tile h-100" role="button" data-bs-toggle="modal" data-bs-target="#channelsModal">
          <div class="card-body">
            <div class="tile-icon">🤖</div>
            <h5 class="card-title">Каналы (боты)</h5>
            <p class="card-text text-muted">Управляйте подключёнными Telegram-ботами.</p>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card settings-tile settings-tile--accent h-100" role="button" data-bs-toggle="modal" data-bs-target="#categoriesModal">
          <div class="card-body">
            <div class="tile-icon">🗂️</div>
            <h5 class="card-title">Настройка диалогов</h5>
            <p class="card-text text-muted">Управляйте шаблонами категорий, вопросов и действий.</p>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card settings-tile settings-tile--accent h-100" role="button" data-bs-toggle="modal" data-bs-target="#parametersModal">
          <div class="card-body">
            <div class="tile-icon">🧩</div>
            <h5 class="card-title">Параметры партнёров</h5>
            <p class="card-text text-muted">Обновляйте справочники и значения для форм.</p>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card settings-tile settings-tile--accent h-100" role="button" data-bs-toggle="modal" data-bs-target="#itConnectionsModal">
          <div class="card-body">
            <div class="tile-icon">🖧</div>
            <h5 class="card-title">Подключения IT-блока</h5>
            <p class="card-text text-muted">Управляйте подключениями и профилями провайдеров.</p>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card settings-tile settings-tile--accent h-100" role="button" data-bs-toggle="modal" data-bs-target="#usersModal">
          <div class="card-body">
            <div class="tile-icon">👥</div>
            <h5 class="card-title">Пользователи панели и настройки доступа</h5>
            <p class="card-text text-muted">Создавайте роли, настраивайте права и управляйте пользователями.</p>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card settings-tile settings-tile--accent h-100" role="button" data-bs-toggle="modal" data-bs-target="#statusesModal">
          <div class="card-body">
            <div class="tile-icon">🏷️</div>
            <h5 class="card-title">Статусы клиентов</h5>
            <p class="card-text text-muted">Создавайте статусы для сегментации клиентов.</p>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card settings-tile settings-tile--accent h-100" role="button" data-bs-toggle="modal" data-bs-target="#locationsModal">
          <div class="card-body">
            <div class="tile-icon">🧭</div>
            <h5 class="card-title">Структура локаций</h5>
            <p class="card-text text-muted">Управляйте деревом бизнесов, типов и локаций.</p>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card settings-tile settings-tile--accent h-100" role="button" data-bs-toggle="modal" data-bs-target="#legalEntitiesModal">
          <div class="card-body">
            <div class="tile-icon">🏢</div>
            <h5 class="card-title">Юридические лица</h5>
            <p class="card-text text-muted">Управляйте реквизитами и контактами партнёров.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Пользователи -->
    <div class="modal fade" id="usersModal" tabindex="-1" aria-labelledby="usersModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="usersModalLabel">👥 Пользователи панили и настройки доступа</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <div class="modal-body">
            <div
              class="auth-management"
              data-auth-management
              data-auth-photo-upload-endpoint="{{ url_for('api_users_upload_photo') }}"
            >
              <div class="alert alert-danger d-none" role="alert" data-auth-message></div>

              <ul class="nav nav-tabs" role="tablist" data-auth-tabs>
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="auth-users-tab" data-bs-toggle="tab" data-bs-target="#settingsAuthUsers" type="button" role="tab">Пользователи</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="auth-roles-tab" data-bs-toggle="tab" data-bs-target="#settingsAuthRoles" type="button" role="tab">Роли</button>
                </li>
              </ul>

              <div class="tab-content pt-3">
                <div class="tab-pane fade show active" id="settingsAuthUsers" role="tabpanel" data-auth-users-section>
                  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-3">
                    <div class="text-muted small">Управляйте карточками пользователей, контактами и доступом.</div>
                    <button type="button" class="btn btn-primary btn-sm" data-auth-user-create-trigger>+ Создать пользователя</button>
                  </div>

                  <div class="table-responsive">
                    <table class="table table-sm align-middle" data-auth-users-table>
                      <thead>
                        <tr>
                          <th style="width: 30%">Пользователь</th>
                          <th style="width: 22%">Роль</th>
                          <th style="width: 32%">Контакты</th>
                          <th class="text-end" style="width: 16%">Действия</th>
                        </tr>
                      </thead>
                      <tbody data-auth-users-body></tbody>
                    </table>
                  </div>
                  <div class="alert alert-info mt-3 d-none" data-auth-users-empty>Пользователи не найдены.</div>
                </div>

                <div class="tab-pane fade" id="settingsAuthRoles" role="tabpanel" data-auth-roles-section>
                  <form class="row g-2 align-items-end mb-3" data-auth-role-create>
                    <div class="col-md-4">
                      <label class="form-label small mb-1" for="authRoleName">Название</label>
                      <input type="text" class="form-control form-control-sm" id="authRoleName" name="name" autocomplete="off" required>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label small mb-1" for="authRoleDescription">Описание</label>
                      <input type="text" class="form-control form-control-sm" id="authRoleDescription" name="description" autocomplete="off">
                    </div>
                    <div class="col-md-2 d-flex justify-content-end">
                      <button type="submit" class="btn btn-primary btn-sm w-100">Создать роль</button>
                    </div>
                  </form>
                  <div class="text-danger small mb-3 d-none" data-auth-role-create-error></div>
                  <div class="d-flex flex-column gap-3" data-auth-roles-container></div>
                  <div class="alert alert-info d-none" data-auth-roles-empty>Роли не найдены.</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="authUserDetailsModal" tabindex="-1" aria-hidden="true" data-auth-user-modal>
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <form data-auth-user-form>
            <div class="modal-header">
              <h5 class="modal-title" data-auth-user-modal-title>Пользователь</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
              <div class="alert alert-danger d-none" role="alert" data-auth-user-modal-error></div>
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label small mb-1" for="authUserModalLogin">Логин</label>
                  <input type="text" class="form-control form-control-sm" id="authUserModalLogin" name="username" autocomplete="off" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label small mb-1" for="authUserModalRole">Роль</label>
                  <select class="form-select form-select-sm" id="authUserModalRole" name="role_id" data-auth-user-role-select>
                    <option value="">По умолчанию</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label small mb-1" for="authUserModalEmail">E-mail</label>
                  <input type="email" class="form-control form-control-sm" id="authUserModalEmail" name="email" autocomplete="off">
                </div>
                <div class="col-md-6">
                  <label class="form-label small mb-1" for="authUserModalDepartment">Отдел</label>
                  <input type="text" class="form-control form-control-sm" id="authUserModalDepartment" name="department" autocomplete="off">
                </div>
                <div class="col-md-6">
                  <label class="form-label small mb-1" for="authUserModalBirthDate">Дата рождения</label>
                  <input type="date" class="form-control form-control-sm" id="authUserModalBirthDate" name="birth_date">
                </div>
                <div class="col-md-6">
                  <label class="form-label small mb-1" for="authUserModalPhoto">Фото</label>
                  <div class="auth-user-photo-uploader" data-auth-user-photo-uploader>
                    <input type="hidden" id="authUserModalPhoto" name="photo" data-auth-user-photo-value>
                    <input type="file" class="visually-hidden" accept="image/*" data-auth-user-photo-file>
                    <div class="auth-user-photo-dropzone" data-auth-user-photo-dropzone>
                      <div class="auth-user-photo-placeholder" data-auth-user-photo-placeholder>
                        <div class="auth-user-photo-icon mb-2">
                          <i class="bi bi-image"></i>
                        </div>
                        <p class="mb-2">Перетащите фото сюда или нажмите, чтобы загрузить</p>
                        <button type="button" class="btn btn-outline-primary btn-sm" data-auth-user-photo-trigger>Выбрать файл</button>
                        <div class="text-muted small mt-2">PNG, JPG, WebP до 5 МБ</div>
                      </div>
                      <div class="auth-user-photo-preview d-none" data-auth-user-photo-preview>
                        <img src="" alt="Фото пользователя" class="auth-user-photo-img" data-auth-user-photo-img loading="lazy">
                        <div class="d-flex gap-2 mt-3">
                          <button type="button" class="btn btn-outline-primary btn-sm" data-auth-user-photo-change>Заменить</button>
                          <button type="button" class="btn btn-outline-danger btn-sm" data-auth-user-photo-remove>Удалить</button>
                        </div>
                      </div>
                      <div class="auth-user-photo-uploading d-none" data-auth-user-photo-uploading>
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        <span class="ms-2 small">Загрузка...</span>
                      </div>
                    </div>
                    <div class="form-text mt-2" data-auth-user-photo-status></div>
                  </div>
                </div>
              </div>
              <hr class="my-3">
              <div class="mb-3" data-auth-user-password-current>
                <label class="form-label small mb-1">Текущий пароль</label>
                <div class="input-group input-group-sm">
                  <input type="password" class="form-control" data-auth-user-password-display value="••••••••" readonly>
                  <button type="button" class="btn btn-outline-secondary" data-auth-user-password-toggle data-action="toggle-password">Показать</button>
                </div>
                <div class="form-text">Пароль доступен при наличии прав.</div>
              </div>
              <div class="mb-3">
                <label class="form-label small mb-1" for="authUserModalPassword">Пароль</label>
                <input type="text" class="form-control form-control-sm" id="authUserModalPassword" name="password" autocomplete="off" placeholder="Оставьте пустым, чтобы не менять">
              </div>
              <div class="mb-3">
                <label class="form-label small mb-1" for="authUserModalRegistration">Дата регистрации</label>
                <input type="text" class="form-control form-control-sm" id="authUserModalRegistration" data-auth-user-registration readonly>
              </div>
              <div class="mb-2 d-flex align-items-center justify-content-between flex-wrap gap-2">
                <h6 class="mb-0">Телефоны</h6>
                <button type="button" class="btn btn-outline-secondary btn-sm" data-auth-user-phone-add>+ Добавить телефон</button>
              </div>
              <div class="d-flex flex-column gap-2" data-auth-user-phones></div>
              <div class="text-muted small d-none" data-auth-user-phones-empty>Телефоны не указаны.</div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Отменить</button>
              <button type="submit" class="btn btn-primary" data-auth-user-submit>Сохранить</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Настройки диалогов -->
    <div class="modal fade" id="categoriesModal" tabindex="-1" aria-labelledby="categoriesModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="categoriesModalLabel">🗂️ Настройка диалогов</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <div class="modal-body">
            <section class="mb-4">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Шаблоны категорий обращений</h6>
                <button class="btn btn-sm btn-outline-success" type="button" onclick="addCategoryTemplate()">+ Шаблон</button>
              </div>
              <p class="small text-muted">Сгруппируйте категории обращений в отдельные шаблоны и задайте имена, чтобы быстро переключаться между наборами категорий.</p>
              <div id="categoryTemplatesList" class="d-flex flex-column gap-3"></div>
            </section>

            <hr>

            <section class="mb-4">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Шаблоны типовых вопросов</h6>
                <button class="btn btn-sm btn-outline-success" type="button" onclick="addQuestionTemplate()">+ Шаблон</button>
              </div>
              <p class="small text-muted">Создайте наборы вопросов, которые можно использовать при общении с клиентом. Они будут доступны в окне диалога.</p>
              <div id="questionTemplatesList" class="d-flex flex-column gap-3"></div>
            </section>

            <hr>

            <section>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Шаблоны действий после завершения</h6>
                <button class="btn btn-sm btn-outline-success" type="button" onclick="addCompletionTemplate()">+ Шаблон</button>
              </div>
              <p class="small text-muted">Опишите список действий и контрольных вопросов, которые нужно выполнить после закрытия диалога. Эти шаблоны будут доступны при завершении обращения.</p>
              <div id="completionTemplatesList" class="d-flex flex-column gap-3"></div>
            </section>
          </div>
          <div class="modal-footer">
            <div class="small text-muted me-auto">Изменения вступят в силу после сохранения.</div>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Закрыть</button>
            <button type="button" class="btn btn-primary" onclick="saveSettings()">Сохранить настройки</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Локации -->
    <div class="modal fade" id="locationsModal" tabindex="-1" aria-labelledby="locationsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="locationsModalLabel">🧭 Структура локаций</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <div class="modal-body">
            <p class="mb-3">Редактируйте бизнес → тип → город → локации. При открытии дерево свёрнуто до уровня типов.</p>
            <div class="d-flex flex-wrap gap-2 mb-3">
              <button class="btn btn-sm btn-primary" type="button" onclick="openAddLocationWizard()">Добавить запись</button>
              <button class="btn btn-sm btn-success" type="button" onclick="addBusiness()">+ Добавить бизнес</button>
            </div>
            <div id="locationsEditor" class="mb-3">
              <!-- Дерево будет построено динамически -->
            </div>
          </div>
          <div class="modal-footer justify-content-end">
            <button class="btn btn-primary" type="button" onclick="saveLocationsChanges()">Сохранить изменения</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Мастер добавления записи локаций -->
    <div class="modal fade" id="locationWizardModal" tabindex="-1" aria-labelledby="locationWizardLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="locationWizardLabel">Добавление записи</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <div class="modal-body">
            <div class="location-wizard-steps">
              <div data-location-wizard-step="0" class="location-wizard-step mb-3">
                <label for="wizardBusinessSelect" class="form-label">1. Выберите бизнес</label>
                <select id="wizardBusinessSelect" class="form-select" required></select>
                <div class="form-text">Список подтягивается из параметров партнёров.</div>
              </div>
              <div data-location-wizard-step="1" class="location-wizard-step mb-3 d-none">
                <label for="wizardTypeSelect" class="form-label">2. Выберите тип</label>
                <select id="wizardTypeSelect" class="form-select" required></select>
              </div>
              <div data-location-wizard-step="2" class="location-wizard-step mb-3 d-none">
                <label for="wizardCitySelect" class="form-label">3. Выберите город</label>
                <select id="wizardCitySelect" class="form-select" required></select>
                <div class="form-text">Данные берутся из блока «Параметры партнёров» → «Город».</div>
              </div>
              <div data-location-wizard-step="3" class="location-wizard-step mb-3 d-none">
                <label for="wizardDepartmentSelect" class="form-label">4. Выберите департамент</label>
                <select id="wizardDepartmentSelect" class="form-select" required></select>
              </div>
            </div>
            <div class="alert alert-light border" id="wizardSummary"></div>
          </div>
          <div class="modal-footer justify-content-between">
            <div>
              <button type="button" class="btn btn-outline-secondary" id="wizardPrevStep">Назад</button>
            </div>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-primary" id="wizardNextStep">Далее</button>
              <button type="button" class="btn btn-success d-none" id="wizardFinish">Создать запись</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Статусы клиентов -->
    <div class="modal fade" id="statusesModal" tabindex="-1" aria-labelledby="statusesModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="statusesModalLabel">🏷️ Статусы клиентов</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <div class="modal-body">
            <div class="client-status-toolbar mb-3">
              <div class="d-flex align-items-center gap-2">
                <h6 class="mb-0">Список статусов</h6>
                <span class="text-muted small">Изменения можно вносить в режиме редактирования.</span>
              </div>
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-primary btn-sm" id="editStatusesBtn" onclick="startStatusesEdit()">
                  <i class="bi bi-pencil-square me-1"></i> Редактировать
                </button>
                <button type="button" class="btn btn-success btn-sm d-none" id="saveStatusesBtn" onclick="saveClientStatuses()">
                  <i class="bi bi-check-lg me-1"></i> Сохранить
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm d-none" id="cancelStatusesBtn" onclick="cancelStatusesEdit()">
                  Отмена
                </button>
              </div>
            </div>
            <div id="statusesList" class="list-group"></div>
            <div id="statusesEmptyPlaceholder" class="text-muted fst-italic small d-none">
              Пока нет статусов. Нажмите «Редактировать», чтобы добавить первый статус.
            </div>
            <button class="btn btn-sm btn-success mt-3 d-none" id="addStatusBtn" type="button" onclick="addStatus()">+ Добавить статус</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Параметры партнёров -->
    <div class="modal fade" id="parametersModal" tabindex="-1" aria-labelledby="parametersModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="parametersModalLabel">🧩 Параметры партнёров</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <div class="modal-body">
            <ul class="nav nav-tabs mb-3" id="partnerParametersTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link active"
                  id="partnerParametersTabContragentsTab"
                  data-bs-toggle="tab"
                  data-bs-target="#partnerParametersTabContragents"
                  type="button"
                  role="tab"
                  aria-controls="partnerParametersTabContragents"
                  aria-selected="true"
                >
                  Контрагенты
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link"
                  id="partnerParametersTabFranchiseTab"
                  data-bs-toggle="tab"
                  data-bs-target="#partnerParametersTabFranchise"
                  type="button"
                  role="tab"
                  aria-controls="partnerParametersTabFranchise"
                  aria-selected="false"
                >
                  Франчайзи
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link"
                  id="partnerParametersTabBasicsTab"
                  data-bs-toggle="tab"
                  data-bs-target="#partnerParametersTabBasics"
                  type="button"
                  role="tab"
                  aria-controls="partnerParametersTabBasics"
                  aria-selected="false"
                >
                  Основные настройки
                </button>
              </li>
            </ul>
            <div class="tab-content" id="partnerParametersTabsContent">
              <div
                class="tab-pane fade show active"
                id="partnerParametersTabContragents"
                role="tabpanel"
                aria-labelledby="partnerParametersTabContragentsTab"
                data-partner-contacts-section="partner"
              >
                <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
                  <div>
                    <h6 class="mb-1">Контактные данные контрагентов</h6>
                    <p class="small text-muted mb-0">Фиксируйте телефоны, e-mail и связь с юридическими лицами контрагентов.</p>
                  </div>
                  <button class="btn btn-sm btn-success" type="button" data-partner-contact-add="partner">+ Добавить контакт</button>
                </div>
                <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3" data-partner-contacts-list></div>
                <div class="card border-0 bg-light text-center py-5 d-none" data-partner-contacts-empty>
                  <div class="card-body">
                    <div class="fw-semibold mb-1">Пока нет контактов</div>
                    <div class="text-muted small">Нажмите «Добавить контакт», чтобы сохранить информацию о контрагентах.</div>
                  </div>
                </div>
              </div>
              <div
                class="tab-pane fade"
                id="partnerParametersTabFranchise"
                role="tabpanel"
                aria-labelledby="partnerParametersTabFranchiseTab"
                data-partner-contacts-section="ka"
              >
                <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
                  <div>
                    <h6 class="mb-1">Контакты франчайзи</h6>
                    <p class="small text-muted mb-0">Храните данные о франчайзи: телефоны, почту и ответственных лиц.</p>
                  </div>
                  <button class="btn btn-sm btn-success" type="button" data-partner-contact-add="ka">+ Добавить контакт</button>
                </div>
                <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3" data-partner-contacts-list></div>
                <div class="card border-0 bg-light text-center py-5 d-none" data-partner-contacts-empty>
                  <div class="card-body">
                    <div class="fw-semibold mb-1">Пока нет контактов</div>
                    <div class="text-muted small">Добавьте первую запись, чтобы начать вести базу франчайзи.</div>
                  </div>
                </div>
              </div>
              <div
                class="tab-pane fade"
                id="partnerParametersTabBasics"
                role="tabpanel"
                aria-labelledby="partnerParametersTabBasicsTab"
              >
                <div class="row g-3">
                  {% for slug, title in parameter_types.items() %}
                  {% if slug not in ['it_connection', 'remote_access', 'legal_entity'] %}
                  <div class="col-md-6 col-xl-4">
                    <div class="card shadow-sm parameter-card" data-param-type="{{ slug }}">
                      <div class="card-header d-flex justify-content-between align-items-center">
                        <button type="button" class="btn btn-link flex-grow-1 text-start" data-param-toggle>
                          {{ title }}
                        </button>
                        <span class="badge bg-secondary" data-param-count>0</span>
                      </div>
                      <div class="card-body d-none" data-param-body></div>
                      <div class="px-3 py-2 small text-muted d-none" data-param-hint>
                        Список содержит более 10 записей. Нажмите, чтобы открыть значения в модальном окне.
                      </div>
                    </div>
                  </div>
                  {% endif %}
                  {% endfor %}
                  <div class="col-md-6 col-xl-4">
                    <div
                      class="card shadow-sm parameter-card"
                      data-city-card
                      data-city-count="{{ cities | length }}"
                    >
                      <div class="card-header d-flex justify-content-between align-items-center">
                        <button type="button" class="btn btn-link flex-grow-1 text-start" data-city-toggle>
                          Город
                        </button>
                        <span class="badge bg-secondary">{{ cities | length }}</span>
                      </div>
                      <div class="card-body" data-city-body>
                        <div class="param-items" data-city-list>
                          {% if cities %}
                          <ul class="list-group list-group-flush">
                            {% for city in cities %}
                            <li class="list-group-item py-1 px-2">{{ city }}</li>
                            {% endfor %}
                          </ul>
                          {% else %}
                          <div class="empty-placeholder">Пока нет значений</div>
                          {% endif %}
                        </div>
                      </div>
                      <div class="px-3 py-2 small text-muted d-none" data-city-hint>
                        Список содержит более 10 записей. Нажмите, чтобы открыть значения в модальном окне.
                      </div>
                    </div>
                  </div>
                </div>
                <div class="form-text text-muted mt-3">
                  Эти значения будут использоваться в формах создания клиентов, задач и других разделов.
                </div>
              </div>
            </div>
          </div>
    </div>
  </div>
</div>

    <div class="modal fade" id="parameterItemsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" data-param-modal-title>Значения параметра</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <div class="modal-body" data-param-modal-body></div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="legalEntitiesModal" tabindex="-1" aria-labelledby="legalEntitiesModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="legalEntitiesModalLabel">🏢 Юридические лица</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <div class="modal-body">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
              <div>
                <h6 class="mb-1">Справочник юридических лиц</h6>
                <p class="small text-muted mb-0">Храните реквизиты и контакты менеджеров для партнёров.</p>
              </div>
              <button class="btn btn-sm btn-success" type="button" data-legal-entity-add>+ Добавить ЮЛ</button>
            </div>
            <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3" data-legal-entities-list></div>
            <div class="card border-0 bg-light text-center py-5 d-none" data-legal-entities-empty>
              <div class="card-body">
                <div class="fw-semibold mb-1">Пока нет юридических лиц</div>
                <div class="text-muted small">Используйте кнопку «Добавить ЮЛ», чтобы создать первую запись.</div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <div class="small text-muted me-auto">Изменения сохраняются кнопками на карточках.</div>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Закрыть</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="partnerContactEditorModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" data-partner-contact-editor-title>Карточка контакта</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <div class="modal-body" data-partner-contact-editor-body>
            <div class="text-center text-muted py-5">Выберите контакт из списка для редактирования.</div>
          </div>
          <div class="modal-footer justify-content-between flex-wrap gap-2">
            <div class="d-flex flex-wrap gap-2 d-none" data-partner-contact-editor-actions></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Подключения IT-блока и профили провайдеров -->
    <div class="modal fade" id="itConnectionsModal" tabindex="-1" aria-labelledby="itConnectionsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="itConnectionsModalLabel">🖧 Подключения IT-блока</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <div class="modal-body">
            <div
              class="row row-cols-1 row-cols-sm-2 row-cols-xl-4 g-3 mb-4 settings-tiles"
              data-it-section-tiles
            >
              <div class="col">
                <div class="card settings-tile h-100" data-it-section-target="#itEquipmentSection" tabindex="0">
                  <div class="card-body text-center">
                    <div class="tile-icon">🗃️</div>
                    <h6 class="card-title mb-1">Каталог оборудования</h6>
                    <p class="card-text text-muted small mb-0">Карточки моделей и сопутствующие материалы.</p>
                  </div>
                </div>
              </div>
              <div class="col">
                <div class="card settings-tile h-100" data-it-section-target="#itConnectionsSection" tabindex="0">
                  <div class="card-body text-center">
                    <div class="tile-icon">🔌</div>
                    <h6 class="card-title mb-1">Оборудование</h6>
                    <p class="card-text text-muted small mb-0">Настройте типы и категории подключений.</p>
                  </div>
                </div>
              </div>
              <div class="col">
                <div class="card settings-tile h-100" data-it-section-target="#networkProfilesSection" tabindex="0">
                  <div class="card-body text-center">
                    <div class="tile-icon">📡</div>
                    <h6 class="card-title mb-1">Профили провайдеров</h6>
                    <p class="card-text text-muted small mb-0">Контакты и договоры подключений.</p>
                  </div>
                </div>
              </div>
              <div class="col">
                <div class="card settings-tile h-100" data-it-section-target="#remoteAccessSection" tabindex="0">
                  <div class="card-body text-center">
                    <div class="tile-icon">🌐</div>
                    <h6 class="card-title mb-1">Удалённый доступ</h6>
                    <p class="card-text text-muted small mb-0">Справочник инструментов для инженеров.</p>
                  </div>
                </div>
              </div>
            </div>
            <div class="accordion it-section-accordion" id="itSettingsAccordion">
              <div class="accordion-item">
                <h2 class="accordion-header" id="itEquipmentSectionHeading">
                  <button
                    class="accordion-button"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#itEquipmentSection"
                    aria-expanded="true"
                    aria-controls="itEquipmentSection"
                  >
                    Каталог оборудования
                  </button>
                </h2>
                <div
                  id="itEquipmentSection"
                  class="accordion-collapse collapse show"
                  aria-labelledby="itEquipmentSectionHeading"
                  data-bs-parent="#itSettingsAccordion"
                >
                  <div class="accordion-body">
                    <div class="table-responsive">
                      <table class="table table-sm align-middle" id="itEquipmentTable">
                        <thead>
                          <tr>
                            <th>Тип оборудования</th>
                            <th>Производитель</th>
                            <th>Модель</th>
                            <th>Ссылки</th>
                            <th></th>
                          </tr>
                        </thead>
                        <tbody id="itEquipmentBody"></tbody>
                      </table>
                    </div>
                    <button
                      class="btn btn-sm btn-success mt-3"
                      type="button"
                      data-bs-toggle="modal"
                      data-bs-target="#itEquipmentAddModal"
                    >
                      + Добавить оборудование
                    </button>
                    <div class="form-text text-muted mt-2">
                      Подготовьте справочник оборудования для быстрого заполнения паспортов объектов.
                    </div>
                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h2 class="accordion-header" id="itConnectionsSectionHeading">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#itConnectionsSection"
                    aria-expanded="false"
                    aria-controls="itConnectionsSection"
                  >
                    Оборудование
                  </button>
                </h2>
                <div
                  id="itConnectionsSection"
                  class="accordion-collapse collapse"
                  aria-labelledby="itConnectionsSectionHeading"
                  data-bs-parent="#itSettingsAccordion"
                >
                  <div class="accordion-body">
                    <div
                      class="accordion it-section-accordion it-section-accordion--nested"
                      id="itConnectionsCategoryAccordion"
                      data-it-connections-container
                    ></div>
                    <button
                      class="btn btn-sm btn-success mt-3"
                      type="button"
                      data-bs-toggle="modal"
                      data-bs-target="#itConnectionAddModal"
                    >
                      + Добавить подключение
                    </button>
                    <div class="form-text text-muted mt-2">
                      Здесь управляйте списком доступных подключений IT-блока.
                    </div>
                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h2 class="accordion-header" id="networkProfilesSectionHeading">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#networkProfilesSection"
                    aria-expanded="false"
                    aria-controls="networkProfilesSection"
                  >
                    Профили провайдеров
                  </button>
                </h2>
                <div
                  id="networkProfilesSection"
                  class="accordion-collapse collapse"
                  aria-labelledby="networkProfilesSectionHeading"
                  data-bs-parent="#itSettingsAccordion"
                >
                  <div class="accordion-body">
                    <div class="table-responsive">
                      <table class="table table-sm align-middle" id="networkProfilesTable">
                        <thead>
                          <tr>
                            <th>Провайдер</th>
                            <th>Номер договора</th>
                            <th>ID ресторана</th>
                            <th>Телефон ТП</th>
                            <th>ЮЛ</th>
                            <th>Объектов</th>
                            <th></th>
                          </tr>
                        </thead>
                        <tbody id="networkProfilesBody"></tbody>
                      </table>
                    </div>
                    <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mt-3">
                      <button class="btn btn-sm btn-success" type="button" data-network-profiles-add>+ Добавить профиль</button>
                      <button class="btn btn-sm btn-primary" type="button" data-network-profiles-save>
                        💾 Сохранить изменения
                      </button>
                    </div>
                    <div class="form-text text-muted mt-2">Эти данные будут автоматически подставляться в паспорт объекта.</div>
                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h2 class="accordion-header" id="remoteAccessSectionHeading">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#remoteAccessSection"
                    aria-expanded="false"
                    aria-controls="remoteAccessSection"
                  >
                    Удалённый доступ
                  </button>
                </h2>
                <div
                  id="remoteAccessSection"
                  class="accordion-collapse collapse"
                  aria-labelledby="remoteAccessSectionHeading"
                  data-bs-parent="#itSettingsAccordion"
                >
                  <div class="accordion-body">
                    <p class="text-muted small mb-3">
                      Справочник приложений для удалённого подключения инженеров.
                    </p>
                    <div data-remote-access-container></div>
                  </div>
                </div>
              </div>
            </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="networkProfileEditorModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <form data-network-profile-form>
            <div class="modal-header">
              <h5 class="modal-title" data-network-profile-title>Профиль провайдера</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label" for="networkProfileProviderInput">Провайдер</label>
                  <input
                    type="text"
                    class="form-control"
                    id="networkProfileProviderInput"
                    data-network-profile-provider
                    placeholder="Например, Ростелеком"
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="networkProfileContractInput">Номер договора</label>
                  <input
                    type="text"
                    class="form-control"
                    id="networkProfileContractInput"
                    data-network-profile-contract
                    placeholder="Номер договора"
                  />
                </div>
                <div class="col-12">
                  <label class="form-label">ID ресторана</label>
                  <div class="d-flex flex-column gap-2" data-network-profile-restaurant-ids></div>
                  <button type="button" class="btn btn-sm btn-outline-primary mt-2" data-network-profile-add-restaurant-id>
                    + Добавить ID ресторана
                  </button>
                  <div class="form-text text-muted">Можно указать несколько идентификаторов для одного профиля.</div>
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="networkProfileSupportPhoneInput">Телефон ТП</label>
                  <input
                    type="text"
                    class="form-control"
                    id="networkProfileSupportPhoneInput"
                    data-network-profile-support-phone
                    placeholder="Телефон технической поддержки"
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="networkProfileLegalEntityInput">Юридическое лицо</label>
                  <input
                    type="text"
                    class="form-control"
                    id="networkProfileLegalEntityInput"
                    data-network-profile-legal-entity
                    placeholder="Название ЮЛ"
                  />
                </div>
              </div>
            </div>
            <div class="modal-footer justify-content-between flex-wrap gap-2">
              <button type="button" class="btn btn-outline-danger d-none" data-network-profile-delete>Удалить профиль</button>
              <div class="d-flex gap-2 ms-auto">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="submit" class="btn btn-primary">Сохранить</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="itConnectionAddModal" tabindex="-1" aria-labelledby="itConnectionAddModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="itConnectionAddModalLabel">Новое подключение</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <form data-it-connection-add-form>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label" for="itConnectionCategorySelect">Выберите, что необходимо добавить</label>
                <div class="input-group">
                  <select class="form-select" id="itConnectionCategorySelect" data-it-connection-category-select>
                    {% for key, label in it_connection_categories.items() %}
                    <option value="{{ key }}">{{ label }}</option>
                    {% endfor %}
                  </select>
                  <button
                    class="btn btn-outline-secondary"
                    type="button"
                    data-it-connection-category-create
                  >
                    + Новая категория
                  </button>
                </div>
                <div class="form-text">Если нужной категории нет в списке, создайте её.</div>
              </div>
              <div>
                <label class="form-label" for="itConnectionValueInput">Значение подключения</label>
                <input
                  type="text"
                  class="form-control"
                  id="itConnectionValueInput"
                  placeholder="Например, TeamViewer"
                  data-it-connection-value-input
                >
                <div class="form-text">Введите или вставьте новое значение подключения.</div>
                <div class="invalid-feedback">Укажите значение подключения.</div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
              <button type="submit" class="btn btn-primary">Добавить</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="itEquipmentAddModal" tabindex="-1" aria-labelledby="itEquipmentAddModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="itEquipmentAddModalLabel">Новое оборудование</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <form data-it-equipment-add-form>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label" for="itEquipmentTypeSelect">Тип оборудования</label>
                <select class="form-select" id="itEquipmentTypeSelect" data-it-equipment-field="equipment_type" required></select>
                <div class="form-text">Выберите тип из ранее созданных подключений.</div>
                <div class="invalid-feedback">Укажите тип оборудования.</div>
              </div>
              <div class="mb-3">
                <label class="form-label" for="itEquipmentVendorSelect">Производитель оборудования</label>
                <select class="form-select" id="itEquipmentVendorSelect" data-it-equipment-field="equipment_vendor" required></select>
                <div class="invalid-feedback">Укажите производителя оборудования.</div>
              </div>
              <div class="mb-3">
                <label class="form-label" for="itEquipmentModelSelect">Модель оборудования</label>
                <select class="form-select" id="itEquipmentModelSelect" data-it-equipment-field="equipment_model" required></select>
                <div class="invalid-feedback">Укажите модель оборудования.</div>
              </div>
              <div class="mb-3">
                <label class="form-label">Ссылки <span class="text-muted">(необязательно)</span></label>
                <div class="d-flex flex-column gap-2" data-it-equipment-add-links></div>
                <button
                  class="btn btn-sm btn-outline-secondary mt-2"
                  type="button"
                  data-it-equipment-add-link
                >
                  + Добавить ссылку
                </button>
                <div class="form-text">Можно указать несколько ссылок на инструкции, карточки и т.п.</div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
              <button type="submit" class="btn btn-primary">Добавить</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="botRatingTemplateModal" tabindex="-1" aria-labelledby="botRatingTemplateLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="botRatingTemplateLabel">Редактирование шаблона оценок</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label" for="botRatingTemplateName">Название шаблона</label>
              <input type="text" class="form-control" id="botRatingTemplateName" data-bot-rating-template-name>
            </div>
            <div class="mb-3">
              <label class="form-label" for="botRatingTemplateDescription">Описание (необязательно)</label>
              <textarea class="form-control" id="botRatingTemplateDescription" rows="2" data-bot-rating-template-description></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label" for="botRatingTemplatePrompt">Текст запроса</label>
              <textarea class="form-control" id="botRatingTemplatePrompt" rows="2" data-bot-rating-template-prompt></textarea>
              <div class="form-text">Поддерживаются подстановки {ticket_id} и {scale}.</div>
            </div>
            <div class="row g-3">
              <div class="col-lg-4">
                <label class="form-label" for="botRatingTemplateScale">Количество оценок</label>
                <input
                  type="number"
                  class="form-control"
                  id="botRatingTemplateScale"
                  min="1"
                  max="10"
                  step="1"
                  data-bot-rating-template-scale
                >
                <div class="form-text">Пользователь сможет выбрать значение от 1 до указанного числа.</div>
              </div>
              <div class="col-lg-8">
                <label class="form-label">Ответы для оценок</label>
                <div class="d-flex flex-column gap-2" data-bot-rating-template-responses></div>
                <div class="form-text">Каждый текст отправляется при соответствующей оценке. Доступны подстановки {value} и {scale}.</div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <div class="small text-muted me-auto" data-bot-rating-template-status></div>
            <button type="button" class="btn btn-outline-secondary" data-bot-rating-template-cancel data-bs-dismiss="modal">Отмена</button>
            <button type="button" class="btn btn-primary" data-bot-rating-template-save>Сохранить шаблон</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="botTemplateEditorModal" tabindex="-1" aria-labelledby="botTemplateEditorLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="botTemplateEditorLabel">Редактирование шаблона вопросов</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label" for="botTemplateNameInput">Название шаблона</label>
              <input type="text" class="form-control" id="botTemplateNameInput" data-bot-template-name>
            </div>
            <div class="mb-3">
              <label class="form-label" for="botTemplateDescriptionInput">Описание (необязательно)</label>
              <textarea class="form-control" id="botTemplateDescriptionInput" rows="2" data-bot-template-description></textarea>
            </div>
            <div class="mb-3">
              <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
                <div>
                  <h6 class="mb-1">Структура вопросов</h6>
                  <p class="small text-muted mb-0">Настройте последовательность вопросов. Используйте свободный текст или готовые поля из справочников.</p>
                </div>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-primary" type="button" data-bot-question-add data-type="custom">+ Свободный вопрос</button>
                  <button class="btn btn-outline-secondary" type="button" data-bot-question-add data-type="preset">+ Готовое поле</button>
                </div>
              </div>
              <div class="d-flex flex-column gap-3" data-bot-questions-container></div>
              <div class="card border-0 bg-light mt-3" data-bot-presets-summary>
                <div class="card-body py-3">
                  <div class="fw-semibold mb-1">Доступные готовые поля</div>
                  <div class="small text-muted" data-bot-preset-hints></div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <div class="small text-muted me-auto" data-bot-template-status></div>
            <button type="button" class="btn btn-outline-secondary" data-bot-template-cancel data-bs-dismiss="modal">Отмена</button>
            <button type="button" class="btn btn-primary" data-bot-template-save>Сохранить шаблон</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Каналы (боты) -->
    <div class="modal fade" id="channelsModal" tabindex="-1" aria-labelledby="channelsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="channelsModalLabel">🤖 Каналы (боты)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <div class="modal-body">
            <ul class="nav nav-tabs" id="channelsTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link active"
                  id="channels-manage-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#channels-manage"
                  type="button"
                  role="tab"
                  aria-controls="channels-manage"
                  aria-selected="true"
                >
                  Управление ботами
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link"
                  id="channels-templates-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#channels-templates"
                  type="button"
                  role="tab"
                  aria-controls="channels-templates"
                  aria-selected="false"
                >
                  Шаблоны
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link"
                  id="channels-automation-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#channels-automation"
                  type="button"
                  role="tab"
                  aria-controls="channels-automation"
                  aria-selected="false"
                >
                  Автоматические действия
                </button>
              </li>
            </ul>

            <div class="tab-content pt-3" id="channelsTabsContent">
              <div
                class="tab-pane fade show active"
                id="channels-manage"
                role="tabpanel"
                aria-labelledby="channels-manage-tab"
              >
                <div class="card mb-3">
                  <div class="card-header">Добавить канал</div>
                  <div class="card-body">
                    <div class="row g-3 align-items-end">
                      <div class="col-lg-4">
                        <input id="ch_token" class="form-control" placeholder="Токен бота (BotFather)">
                      </div>
                      <div class="col-lg-3">
                        <input id="ch_name" class="form-control" placeholder="Имя канала (произвольное)">
                      </div>
                      <div class="col-lg-3">
                        <label class="form-label" for="ch_questions">Список вопросов</label>
                        <select id="ch_questions" class="form-select"></select>
                        <div class="form-text">Берётся из вкладки «Шаблоны».</div>
                      </div>
                      <div class="col-lg-2">
                        <label class="form-label" for="ch_rating">Система оценок</label>
                        <select id="ch_rating" class="form-select"></select>
                      </div>
                      <div class="col-12 d-grid mt-2 mt-lg-0">
                        <button class="btn btn-primary" onclick="addChannel()">Добавить</button>
                      </div>
                    </div>
                    <div class="form-text mt-2">Имя бота подтянется автоматически через Telegram <code>getMe</code>.</div>
                  </div>
                </div>

                <div class="table-responsive">
                  <table class="table table-striped align-middle">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Внутреннее имя канала</th>
                        <th>Бот</th>
                        <th>Токен</th>
                        <th>Активен</th>
                        <th>Список вопросов</th>
                        <th>Система оценок</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody id="channelsBody"></tbody>
                  </table>
                </div>
              </div>

              <div
                class="tab-pane fade"
                id="channels-templates"
                role="tabpanel"
                aria-labelledby="channels-templates-tab"
              >
                <div class="pt-1" data-bot-settings-modal>
                  <section class="mb-4">
                    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
                      <div>
                        <h6 class="mb-1">Шаблоны вопросов</h6>
                        <p class="small text-muted mb-0">
                          Создайте несколько сценариев вопросов для бота и выберите основной. Каждый шаблон можно редактировать отдельно.
                        </p>
                      </div>
                      <button class="btn btn-sm btn-outline-success" type="button" data-bot-template-create>+ Шаблон</button>
                    </div>
                    <div class="d-flex flex-column gap-3" data-bot-templates-container></div>
                  </section>

                  <hr>

                  <section>
                    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
                      <div>
                        <h6 class="mb-1">Система оценок</h6>
                        <p class="small text-muted mb-0">Создайте несколько сценариев оценок для ботов и выберите активный шаблон.</p>
                      </div>
                      <button class="btn btn-sm btn-outline-success" type="button" data-bot-rating-template-create>+ Шаблон</button>
                    </div>
                    <div class="d-flex flex-column gap-3" data-bot-rating-templates-container></div>
                  </section>

                  <div class="d-flex flex-column flex-lg-row align-items-lg-center gap-3 mt-4">
                    <div class="small text-muted" data-bot-settings-status></div>
                    <div class="ms-lg-auto d-flex gap-2">
                      <button type="button" class="btn btn-primary" data-bot-settings-save>Сохранить шаблоны</button>
                    </div>
                  </div>
                </div>
              </div>

              <div
                class="tab-pane fade"
                id="channels-automation"
                role="tabpanel"
                aria-labelledby="channels-automation-tab"
              >
                <section class="mb-4">
                  <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
                    <div>
                      <h6 class="mb-1">Шаблоны автозакрытия</h6>
                      <p class="small text-muted mb-0">
                        Создайте несколько сценариев автозакрытия и выберите основной. Каждый шаблон можно настроить отдельно.
                      </p>
                    </div>
                    <button class="btn btn-sm btn-outline-success" type="button" onclick="addAutoCloseTemplate()">+ Шаблон</button>
                  </div>
                  <div class="d-flex flex-column gap-3" data-auto-close-templates></div>
                </section>
                <div class="alert alert-light border small mb-3" role="alert">
                  Активный шаблон будет применяться по умолчанию. Позже вы сможете выбирать подходящий сценарий для каждого бота.
                </div>
                <div class="d-flex justify-content-end">
                  <button type="button" class="btn btn-primary" onclick="saveSettings()">Сохранить изменения</button>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Закрыть</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Сохранить -->
    <button class="btn btn-primary mt-4" onclick="saveSettings()">Сохранить настройки</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  const RAW_DIALOG_CONFIG = {{ settings.dialog_config | tojson | safe }};
  const DIALOG_CONFIG = RAW_DIALOG_CONFIG && typeof RAW_DIALOG_CONFIG === 'object' ? RAW_DIALOG_CONFIG : {};
  const RAW_AUTO_CLOSE_CONFIG = {{ (settings.auto_close_config or {}) | tojson | safe }};
  const AUTO_CLOSE_CONFIG = RAW_AUTO_CLOSE_CONFIG && typeof RAW_AUTO_CLOSE_CONFIG === 'object' ? RAW_AUTO_CLOSE_CONFIG : {};
  const AUTO_CLOSE_FALLBACK_HOURS = Number({{ settings.auto_close_hours | tojson }}) || 24;
  const FALLBACK_DIALOG_CATEGORIES = {{ settings.categories | tojson | safe }};

  const BOT_SETTINGS_INITIAL = {{ settings.bot_settings | tojson | safe }};
  const BOT_PRESET_DEFINITIONS = {{ bot_question_presets | tojson | safe }};

  const PARAMETER_TITLES = {{ parameter_types | tojson }};
  const PARAMETER_STATE_TYPES = new Set(['partner_type', 'country', 'legal_entity', 'partner_contact']);
  const PARAMETER_STATES = ['Активен', 'Подписание', 'Заблокирован', 'Black_List', 'Закрыт'];
  const PARAMETER_FILTER_KEYS = {
    business: 'business',
    partner_type: 'partner_type',
    country: 'country',
    legal_entity: 'legal_entity',
    network: 'network',
    it_connection: 'it_connection_type',
    iiko_server: 'it_iiko_server',
  };
  const IT_CONNECTION_USAGE_FILTER_PARAMS = {
    equipment_type: 'it_connection_type',
    equipment_vendor: 'equipment_vendor',
    equipment_model: 'equipment_model',
    equipment_status: 'equipment_status',
  };
  const PARTNER_CONTACT_TYPES = {
    partner: 'Партнёр',
    ka: 'КА',
  };
  const PARTNER_CONTACT_PHONE_TYPES = {
    work: 'Рабочий',
    personal: 'Личный',
    fax: 'Факс',
    support: 'Саппорт',
  };
  const PARTNER_CONTACT_EMAIL_TYPES = {
    work: 'Рабочий',
    personal: 'Личный',
    common: 'Общий',
    support: 'Саппорт',
  };
  const PARTNER_CONTACT_STATE_CLASS_MAP = {
    Активен: 'partner-contact-card__header--state-active',
    Подписание: 'partner-contact-card__header--state-pending',
    Заблокирован: 'partner-contact-card__header--state-blocked',
    Black_List: 'partner-contact-card__header--state-blacklist',
    Закрыт: 'partner-contact-card__header--state-closed',
  };
  const PARTNER_CONTACT_STATE_CLASSES = Object.values(PARTNER_CONTACT_STATE_CLASS_MAP);
  const CITY_PARAMETER_TYPE = 'city';
  const CITY_PARAMETER_LABEL = 'Город';

  const legalEntitiesContainer = document.querySelector('[data-legal-entities-list]');
  const legalEntitiesEmptyPlaceholder = document.querySelector('[data-legal-entities-empty]');
  const legalEntitiesModalEl = document.getElementById('legalEntitiesModal');
  let legalEntityDrafts = [];
  let legalEntityDraftCounter = 0;

  const parametersModalEl = document.getElementById('parametersModal');
  const partnerContactSections = new Map();
  document.querySelectorAll('[data-partner-contacts-section]').forEach((section) => {
    if (!section || !(section instanceof HTMLElement)) return;
    const scope = section.dataset.partnerContactsSection;
    if (!scope) return;
    const container = section.querySelector('[data-partner-contacts-list]');
    const emptyPlaceholder = section.querySelector('[data-partner-contacts-empty]');
    partnerContactSections.set(scope, {
      section,
      container,
      emptyPlaceholder,
    });
  });
  let partnerContactDrafts = [];
  let partnerContactDraftCounter = 0;
  const partnerContactEdits = new Map();
  let partnerContactPhoneCounter = 0;
  let partnerContactEmailCounter = 0;
  let partnerContactPersonCounter = 0;
  const partnerContactDetailsState = new Map();
  const partnerContactEditorModalEl = document.getElementById('partnerContactEditorModal');
  const partnerContactEditorBody = partnerContactEditorModalEl
    ? partnerContactEditorModalEl.querySelector('[data-partner-contact-editor-body]')
    : null;
  const partnerContactEditorTitle = partnerContactEditorModalEl
    ? partnerContactEditorModalEl.querySelector('[data-partner-contact-editor-title]')
    : null;
  const partnerContactEditorActions = partnerContactEditorModalEl
    ? partnerContactEditorModalEl.querySelector('[data-partner-contact-editor-actions]')
    : null;
  const partnerContactEditorModal = partnerContactEditorModalEl
    ? new bootstrap.Modal(partnerContactEditorModalEl)
    : null;
  let partnerContactEditorState = null;

  function cssEscape(value) {
    if (window.CSS && typeof window.CSS.escape === 'function') {
      return window.CSS.escape(String(value));
    }
    return String(value).replace(/["\\]/g, '\\$&');
  }

  function findPartnerContactCardByKey(key) {
    if (!key) return null;
    let selector = '';
    if (key.startsWith('draft:')) {
      const draftId = key.slice('draft:'.length);
      selector = `[data-partner-contact-card][data-partner-contact-draft="true"][data-partner-contact-draft-id="${cssEscape(
        draftId
      )}"]`;
    } else if (key.startsWith('item:')) {
      const id = key.slice('item:'.length);
      selector = `[data-partner-contact-card][data-partner-contact-draft="false"][data-partner-contact-id="${cssEscape(id)}"]`;
    }
    if (!selector) return null;
    return document.querySelector(selector);
  }

  function setPartnerContactCardVisibility(key, visible) {
    const card = findPartnerContactCardByKey(key);
    if (!card) return;
    const col = card.closest('.col');
    const target = col || card;
    if (visible) {
      target.classList.remove('d-none');
      target.removeAttribute('data-partner-contact-hidden');
    } else {
      target.classList.add('d-none');
      target.setAttribute('data-partner-contact-hidden', 'true');
    }
  }

  function clearPartnerContactEditorActions() {
    if (!partnerContactEditorActions) return;
    partnerContactEditorActions.innerHTML = '';
    partnerContactEditorActions.classList.add('d-none');
  }

  function syncPartnerContactEditorActions(card) {
    if (!partnerContactEditorActions) return;
    partnerContactEditorActions.innerHTML = '';
    if (!card) {
      partnerContactEditorActions.classList.add('d-none');
      return;
    }
    const actionsContainer = card.querySelector('[data-partner-contact-actions]');
    if (!actionsContainer) {
      partnerContactEditorActions.classList.add('d-none');
      return;
    }
    const key = card.dataset.partnerContactKey || actionsContainer.dataset.partnerContactActionsOwner || '';
    const buttons = Array.from(actionsContainer.children || []);
    if (!buttons.length) {
      partnerContactEditorActions.classList.add('d-none');
      return;
    }
    const fragment = document.createDocumentFragment();
    buttons.forEach((button) => {
      const clone = button.cloneNode(true);
      if (key) {
        clone.dataset.partnerContactActionTarget = key;
      }
      fragment.appendChild(clone);
    });
    partnerContactEditorActions.appendChild(fragment);
    partnerContactEditorActions.classList.remove('d-none');
    actionsContainer.classList.add('d-none');
  }

  function updatePartnerContactEditorTitleByKey(key) {
    if (!partnerContactEditorTitle) return;
    if (!key) {
      partnerContactEditorTitle.textContent = 'Карточка контакта';
      return;
    }
    const items = getPartnerContactRenderItems();
    const item = items.find((entry) => getPartnerContactItemKey(entry) === key);
    const displayName = getPartnerContactDisplayName(item);
    partnerContactEditorTitle.textContent = displayName
      ? `Карточка контакта • ${displayName}`
      : 'Карточка контакта';
  }

  function renderPartnerContactModalContentByKey(key) {
    if (!partnerContactEditorBody || !key) return false;
    const items = getPartnerContactRenderItems();
    const item = items.find((entry) => getPartnerContactItemKey(entry) === key);
    if (!item) {
      partnerContactEditorBody.innerHTML =
        '<div class="alert alert-warning mb-0">Контакт не найден или был удалён.</div>';
      clearPartnerContactEditorActions();
      return false;
    }
    const html = renderPartnerContactCard(item, { mode: 'editor' });
    const temp = document.createElement('div');
    temp.innerHTML = html.trim();
    const col = temp.firstElementChild;
    let card = col ? col.querySelector('[data-partner-contact-card]') : temp.querySelector('[data-partner-contact-card]');
    if (!card) {
      partnerContactEditorBody.innerHTML =
        '<div class="alert alert-warning mb-0">Не удалось отобразить карточку контакта.</div>';
      clearPartnerContactEditorActions();
      return false;
    }
    card = card.cloneNode(true);
    card.classList.add('partner-contact-card--modal');
    card.classList.remove('h-100');
    const keyValue = getPartnerContactItemKey(item);
    if (keyValue) {
      partnerContactDetailsState.set(keyValue, 'expanded');
    }
    card.querySelectorAll('[data-partner-contact-details]').forEach((section) => {
      section.classList.remove('is-collapsed');
      section.classList.add('is-expanded');
      const toggle = section.querySelector('[data-partner-contact-details-toggle]');
      if (toggle) {
        toggle.setAttribute('aria-expanded', 'true');
      }
    });
    const modalOpenBtn = card.querySelector('[data-partner-contact-open-modal]');
    if (modalOpenBtn) {
      modalOpenBtn.setAttribute('disabled', 'true');
      modalOpenBtn.classList.add('disabled');
    }
    partnerContactEditorBody.innerHTML = '';
    partnerContactEditorBody.appendChild(card);
    syncPartnerContactEditorActions(card);
    card
      .querySelectorAll('[data-partner-contact-comm-field="value"][data-comm-type="phone"]')
      .forEach((input) => updatePhoneInputFormatting(input));
    card
      .querySelectorAll('[data-partner-contact-comm-field="value"][data-comm-type="email"]')
      .forEach((input) => validateEmailInput(input));
    card
      .querySelectorAll('[data-partner-contact-person-field="phone"]')
      .forEach((input) => updatePhoneInputFormatting(input));
    card
      .querySelectorAll('[data-partner-contact-person-field="email"]')
      .forEach((input) => validateEmailInput(input));
    return true;
  }

  function openPartnerContactEditor(card) {
    if (!partnerContactEditorModal || !card) return;
    const key = getPartnerContactCardKey(card);
    if (!key) return;
    partnerContactEditorState = { key };
    setPartnerContactCardVisibility(key, false);
    const rendered = renderPartnerContactModalContentByKey(key);
    if (!rendered) {
      partnerContactEditorState = null;
      setPartnerContactCardVisibility(key, true);
      return;
    }
    updatePartnerContactEditorTitleByKey(key);
    partnerContactEditorModal.show();
  }

  function refreshPartnerContactPersonRow(row) {
    if (!row) return;
    const titleEl = row.querySelector('[data-partner-contact-person-title]');
    const subtitleEl = row.querySelector('[data-partner-contact-person-subtitle]');
    const fullNameInput = row.querySelector('[data-partner-contact-person-field="full_name"]');
    const positionInput = row.querySelector('[data-partner-contact-person-field="position"]');
    if (titleEl && fullNameInput) {
      const fullName = fullNameInput.value.trim();
      titleEl.textContent = fullName || 'Без имени';
    }
    if (subtitleEl && positionInput) {
      const position = positionInput.value.trim();
      subtitleEl.textContent = position;
      subtitleEl.classList.toggle('d-none', !position);
    }
    const topBadge = row.querySelector('[data-partner-contact-person-top-badge]');
    if (topBadge) {
      const toggle = row.querySelector('[data-partner-contact-person-field="is_top"]');
      const isChecked = toggle ? toggle.checked : false;
      topBadge.classList.toggle('d-none', !isChecked);
    }
  }

  function getPartnerContactItemKey(item) {
    if (!item || typeof item !== 'object') {
      return null;
    }
    if (item.isDraft) {
      if (item.draftId) {
        return `draft:${item.draftId}`;
      }
      return null;
    }
    if (Number.isFinite(item.id)) {
      return `item:${item.id}`;
    }
    if (item.id) {
      return `item:${item.id}`;
    }
    return null;
  }

  function getPartnerContactCardKey(card) {
    if (!card || !card.dataset.partnerContactCard) return null;
    if (card.dataset.partnerContactDraft === 'true') {
      const draftId = card.dataset.partnerContactDraftId;
      return draftId ? `draft:${draftId}` : null;
    }
    const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
    if (Number.isFinite(id)) {
      return `item:${id}`;
    }
    return null;
  }

  function getPartnerContactDisplayName(item) {
    if (!item || typeof item !== 'object') return '';
    const internalName = typeof item.internal_name === 'string' ? item.internal_name.trim() : '';
    if (internalName) {
      return internalName;
    }
    const value = typeof item.value === 'string' ? item.value.trim() : '';
    return value;
  }

  function refreshPartnerContactCardTitle(card) {
    if (!card) return;
    const title = card.querySelector('[data-partner-contact-title]');
    if (!title) return;
    const data = getPartnerContactCardData(card);
    const displayName = getPartnerContactDisplayName(data);
    title.textContent = displayName || 'Без названия';
    const key = getPartnerContactCardKey(card);
    if (partnerContactEditorState && partnerContactEditorState.key === key) {
      updatePartnerContactEditorTitleByKey(key);
    }
  }

  function updatePartnerContactCardHeaderState(card, stateValue) {
    if (!card) return;
    const header = card.querySelector('[data-partner-contact-card-header]');
    if (!header) return;
    if (PARTNER_CONTACT_STATE_CLASSES.length) {
      header.classList.remove(...PARTNER_CONTACT_STATE_CLASSES);
    }
    const className = PARTNER_CONTACT_STATE_CLASS_MAP[stateValue] || '';
    if (className) {
      header.classList.add(className);
    }
  }

  function updatePartnerContactServedSummary(card, data) {
    if (!card) return;
    const summary = card.querySelector('[data-partner-contact-served-summary]');
    if (!summary) return;
    const source = data || getPartnerContactCardData(card);
    if (!source) {
      summary.textContent = '';
      return;
    }
    const served = Array.isArray(source.served_legal_entities) ? source.served_legal_entities : [];
    if (!served.length) {
      summary.textContent = '';
      return;
    }
    const labels = served
      .map((entry) => {
        if (!entry || typeof entry !== 'object') return '';
        const id = Number.isFinite(entry.id) ? entry.id : Number.parseInt(entry.id, 10);
        const name = typeof entry.name === 'string' ? entry.name.trim() : '';
        if (name) return name;
        if (Number.isFinite(id)) return `ID ${id}`;
        return '';
      })
      .filter((label) => label);
    summary.textContent = labels.length ? `Выбрано: ${labels.join(', ')}` : '';
  }

  const IT_CONNECTION_FALLBACK_LABELS = {{ it_connection_categories | tojson }} || {};
  const IT_CONNECTION_CATEGORY_FIELDS = {{ it_connection_category_fields | tojson }} || {};
  let IT_CONNECTION_CATEGORY_LABELS = {};
  let IT_CONNECTION_CATEGORY_KEYS = [];
  let IT_CONNECTION_DEFAULT_CATEGORY = 'equipment_type';
  let itConnectionCategorySelect = null;

  function determineItConnectionDefaultCategory(keys) {
    if (Array.isArray(keys) && keys.includes('equipment_type')) {
      return 'equipment_type';
    }
    if (Array.isArray(keys) && keys.length) {
      return keys[0];
    }
    return 'equipment_type';
  }

  function generatePartnerContactCommKey(prefix) {
    if (prefix === 'phone') {
      partnerContactPhoneCounter += 1;
      return `${prefix}-${partnerContactPhoneCounter}`;
    }
    partnerContactEmailCounter += 1;
    return `${prefix}-${partnerContactEmailCounter}`;
  }

  function updatePartnerContactPersonCounterFromKey(key) {
    if (typeof key !== 'string') return;
    const match = key.match(/^person-(\d+)$/);
    if (!match) return;
    const value = Number.parseInt(match[1], 10);
    if (Number.isFinite(value) && value > partnerContactPersonCounter) {
      partnerContactPersonCounter = value;
    }
  }

  function generatePartnerContactPersonKey() {
    partnerContactPersonCounter += 1;
    return `person-${partnerContactPersonCounter}`;
  }

  function extractDigits(value) {
    if (typeof value === 'string' || typeof value === 'number') {
      return String(value).replace(/\D+/g, '');
    }
    return '';
  }

  const PHONE_COUNTRY_FORMATS = [
    { code: '375', prefix: '+375', mask: ' (##) ###-##-##' },
    { code: '380', prefix: '+380', mask: ' (##) ###-##-##' },
    { code: '7', prefix: '+7', mask: ' (###) ###-##-##' },
    { code: '1', prefix: '+1', mask: ' (###) ###-####' },
  ];
  const EMAIL_VALIDATION_REGEX = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

  function applyPhoneMask(mask, digits) {
    if (!digits) {
      return '';
    }
    let result = '';
    let index = 0;
    for (const char of mask) {
      if (char === '#') {
        if (index < digits.length) {
          result += digits[index];
          index += 1;
        } else {
          break;
        }
      } else if (index > 0 || digits.length > 0) {
        result += char;
      }
    }
    if (index < digits.length) {
      const remainder = digits.slice(index);
      if (remainder) {
        result += (result && !result.endsWith(' ') ? ' ' : '') + remainder;
      }
    }
    return result;
  }

  function formatPhoneValue(value) {
    const digits = extractDigits(value);
    if (!digits) {
      return '';
    }
    for (const format of PHONE_COUNTRY_FORMATS) {
      if (digits.startsWith(format.code)) {
        const rest = digits.slice(format.code.length);
        const maskedRest = rest ? applyPhoneMask(format.mask, rest) : '';
        return (format.prefix + maskedRest).trim();
      }
    }
    const prefix = `+${digits[0]}`;
    const rest = digits.slice(1);
    const maskedRest = rest ? applyPhoneMask(' (###) ###-##-##', rest) : '';
    return (prefix + maskedRest).trim();
  }

  function updatePhoneInputFormatting(input) {
    if (!input) return;
    const digits = extractDigits(input.value || input.dataset.phoneDigits || '');
    input.dataset.phoneDigits = digits;
    input.value = formatPhoneValue(digits);
  }

  function enforceExtensionDigits(input) {
    if (!input) return;
    const digits = extractDigits(input.value);
    input.value = digits;
  }

  function validateEmailInput(input) {
    if (!input) return;
    const value = typeof input.value === 'string' ? input.value.trim() : '';
    const isValid = !value || EMAIL_VALIDATION_REGEX.test(value);
    input.classList.toggle('is-invalid', !isValid);
    if (typeof input.setCustomValidity === 'function') {
      input.setCustomValidity(
        isValid ? '' : 'Введите корректный e-mail: необходим символ @ и доменное имя.'
      );
    }
  }

  function createBlankPartnerContactPersonEntry() {
    return {
      key: generatePartnerContactPersonKey(),
      full_name: '',
      position: '',
      phone: '',
      email: '',
      is_top: false,
    };
  }

  function normalizePartnerContactCommList(rawList, kind) {
    const allowed = kind === 'phone' ? PARTNER_CONTACT_PHONE_TYPES : PARTNER_CONTACT_EMAIL_TYPES;
    const allowedKeys = Object.keys(allowed);
    const defaultType = allowedKeys.includes('work') ? 'work' : allowedKeys[0] || '';
    if (!Array.isArray(rawList)) {
      return [];
    }
    return rawList
      .map((item) => {
        let value = '';
        let type = defaultType;
        let key = '';
        let extension = '';
        if (item && typeof item === 'object') {
          const rawType = typeof item.type === 'string' ? item.type.trim() : '';
          if (rawType && Object.prototype.hasOwnProperty.call(allowed, rawType)) {
            type = rawType;
          }
          if (typeof item.value === 'string' || typeof item.value === 'number') {
            value = String(item.value).trim();
          }
          if (kind === 'phone' && (typeof item.extension === 'string' || typeof item.extension === 'number')) {
            extension = String(item.extension).trim();
          }
          if (typeof item.key === 'string' && item.key.trim()) {
            key = item.key.trim();
          }
        } else if (typeof item === 'string' || typeof item === 'number') {
          value = String(item).trim();
        }
        if (!value) {
          return null;
        }
        if (!Object.prototype.hasOwnProperty.call(allowed, type)) {
          type = defaultType;
        }
        if (!key) {
          key = generatePartnerContactCommKey(kind);
        }
        if (kind === 'phone') {
          value = value.replace(/\D+/g, '');
          extension = extension.replace(/\D+/g, '');
          return { key, type, value, extension };
        }
        return { key, type, value };
      })
      .filter((entry) => entry);
  }

  function normalizeBooleanValue(value) {
    if (typeof value === 'string') {
      const normalized = value.trim().toLowerCase();
      if (!normalized) return false;
      return (
        normalized === '1' ||
        normalized === 'true' ||
        normalized === 'yes' ||
        normalized === 'y' ||
        normalized === 'on'
      );
    }
    return Boolean(value);
  }

  function normalizePartnerContactPeople(rawExtra) {
    const extra = rawExtra && typeof rawExtra === 'object' ? rawExtra : {};
    const list = Array.isArray(extra.contacts) ? extra.contacts : [];
    const seen = new Set();
    return list
      .map((entry) => {
        if (!entry || typeof entry !== 'object') {
          return null;
        }
        const fullName = typeof entry.full_name === 'string' ? entry.full_name.trim() : '';
        const position = typeof entry.position === 'string' ? entry.position.trim() : '';
        const phone = typeof entry.phone === 'string' ? entry.phone.trim() : '';
        const email = typeof entry.email === 'string' ? entry.email.trim() : '';
        let key = typeof entry.key === 'string' ? entry.key.trim() : '';
        if (key) {
          if (seen.has(key)) {
            key = '';
          } else {
            updatePartnerContactPersonCounterFromKey(key);
          }
        }
        if (!key) {
          key = generatePartnerContactPersonKey();
        }
        seen.add(key);
        return {
          key,
          full_name: fullName,
          position,
          phone,
          email,
          is_top: normalizeBooleanValue(entry.is_top),
        };
      })
      .filter((entry) => entry);
  }

  function clonePartnerContactPeople(list) {
    if (!Array.isArray(list)) {
      return [];
    }
    return list
      .map((item) => {
        if (!item || typeof item !== 'object') {
          return null;
        }
        let key = typeof item.key === 'string' ? item.key : '';
        if (key) {
          updatePartnerContactPersonCounterFromKey(key);
        } else {
          key = generatePartnerContactPersonKey();
        }
        return {
          key,
          full_name: typeof item.full_name === 'string' ? item.full_name : '',
          position: typeof item.position === 'string' ? item.position : '',
          phone: typeof item.phone === 'string' ? item.phone : '',
          email: typeof item.email === 'string' ? item.email : '',
          is_top: normalizeBooleanValue(item.is_top),
        };
      })
      .filter((entry) => entry);
  }

  function normalizePartnerContactServedEntities(rawExtra) {
    const extra = rawExtra && typeof rawExtra === 'object' ? rawExtra : {};
    const result = [];
    const seen = new Set();

    const addEntry = (rawId, rawName) => {
      const parsed = Number.parseInt(rawId, 10);
      if (!Number.isFinite(parsed) || parsed <= 0 || seen.has(parsed)) {
        return;
      }
      seen.add(parsed);
      const name = typeof rawName === 'string' ? rawName.trim() : '';
      result.push({ id: parsed, name });
    };

    if (Array.isArray(extra.served_legal_entities)) {
      extra.served_legal_entities.forEach((entry) => {
        if (!entry || typeof entry !== 'object') return;
        addEntry(entry.id, entry.name || entry.label || entry.title || entry.served_legal_entity_name);
      });
    }

    if (Array.isArray(extra.served_legal_entity_ids)) {
      const names = Array.isArray(extra.served_legal_entity_names) ? extra.served_legal_entity_names : [];
      extra.served_legal_entity_ids.forEach((id, index) => {
        const name = names[index];
        addEntry(id, name);
      });
    }

    if (Object.prototype.hasOwnProperty.call(extra, 'served_legal_entity_id')) {
      addEntry(extra.served_legal_entity_id, extra.served_legal_entity_name);
    }

    return result;
  }

  function normalizePartnerContactExtra(rawExtra, { value } = {}) {
    const extra = rawExtra && typeof rawExtra === 'object' ? rawExtra : {};
    const rawType = typeof extra.contact_type === 'string' ? extra.contact_type.trim() : '';
    const contactType = Object.prototype.hasOwnProperty.call(PARTNER_CONTACT_TYPES, rawType)
      ? rawType
      : 'partner';
    const phones = normalizePartnerContactCommList(Array.isArray(extra.phones) ? extra.phones : [], 'phone');
    const emails = normalizePartnerContactCommList(Array.isArray(extra.emails) ? extra.emails : [], 'email');
    const contacts = normalizePartnerContactPeople(extra);
    const innDigits = extractDigits(extra.inn);
    const innValue = innDigits || (typeof extra.inn === 'string' ? extra.inn.trim() : '');
    const legalEntityValue = typeof extra.legal_entity === 'string' && extra.legal_entity.trim()
      ? extra.legal_entity.trim()
      : typeof value === 'string'
        ? value.trim()
        : '';
    const servedEntities = normalizePartnerContactServedEntities(extra);
    const firstServed = servedEntities.length ? servedEntities[0] : null;
    const internalName = typeof extra.internal_name === 'string' ? extra.internal_name.trim() : '';
    return {
      contact_type: contactType,
      phones,
      emails,
      served_legal_entities: servedEntities,
      served_legal_entity_id: firstServed ? firstServed.id : null,
      served_legal_entity_name: firstServed ? firstServed.name : '',
      served_legal_entity_ids: servedEntities.map((entry) => entry.id),
      served_legal_entity_names: servedEntities.map((entry) => entry.name).filter((name) => name),
      legal_entity: legalEntityValue,
      internal_name: internalName,
      inn: innValue,
      contacts,
    };
  }

  function createBlankPartnerContactCommEntry(kind) {
    const allowed = kind === 'phone' ? PARTNER_CONTACT_PHONE_TYPES : PARTNER_CONTACT_EMAIL_TYPES;
    const allowedKeys = Object.keys(allowed);
    const defaultType = allowedKeys.includes('work') ? 'work' : allowedKeys[0] || '';
    const entry = { key: generatePartnerContactCommKey(kind), type: defaultType, value: '' };
    if (kind === 'phone') {
      entry.extension = '';
    }
    return entry;
  }

  function clonePartnerContactCommList(list) {
    if (!Array.isArray(list)) {
      return [];
    }
    return list.map((item) => ({
      key: item.key,
      type: item.type,
      value: item.value,
      extension: typeof item.extension === 'string' ? item.extension : '',
    }));
  }

  function clonePartnerContactServedEntities(list) {
    if (!Array.isArray(list)) {
      return [];
    }
    return list
      .map((item) => {
        if (!item || typeof item !== 'object') return null;
        const id = Number.isFinite(item.id) ? item.id : Number.parseInt(item.id, 10);
        if (!Number.isFinite(id) || id <= 0) return null;
        return {
          id,
          name: typeof item.name === 'string' ? item.name : '',
        };
      })
      .filter((entry) => entry);
  }

  function clonePartnerContactItem(item) {
    if (!item || typeof item !== 'object') {
      return null;
    }
    const servedEntities = clonePartnerContactServedEntities(item.served_legal_entities);
    let servedId = Number.isFinite(item.served_legal_entity_id)
      ? item.served_legal_entity_id
      : Number.parseInt(item.served_legal_entity_id, 10);
    servedId = Number.isFinite(servedId) && servedId > 0 ? servedId : null;
    let servedName = typeof item.served_legal_entity_name === 'string' ? item.served_legal_entity_name : '';
    if (!servedEntities.length && Number.isFinite(servedId)) {
      servedEntities.push({ id: servedId, name: servedName });
    }
    if (servedEntities.length) {
      const first = servedEntities[0];
      if (first) {
        if (!Number.isFinite(servedId)) {
          servedId = first.id;
        }
        if (!servedName) {
          servedName = first.name;
        }
      }
    }
    return {
      id: item.id,
      draftId: item.draftId,
      isDraft: Boolean(item.isDraft),
      value: typeof item.value === 'string' ? item.value : '',
      state: typeof item.state === 'string' ? item.state : PARAMETER_STATES[0],
      contact_type: Object.prototype.hasOwnProperty.call(PARTNER_CONTACT_TYPES, item.contact_type)
        ? item.contact_type
        : 'partner',
      phones: clonePartnerContactCommList(item.phones),
      emails: clonePartnerContactCommList(item.emails),
      contacts: clonePartnerContactPeople(item.contacts),
      served_legal_entities: servedEntities,
      served_legal_entity_id: Number.isFinite(servedId) ? servedId : null,
      served_legal_entity_name: typeof servedName === 'string' ? servedName : '',
      legal_entity: typeof item.legal_entity === 'string' ? item.legal_entity : '',
      internal_name: typeof item.internal_name === 'string' ? item.internal_name : '',
      inn: typeof item.inn === 'string' ? item.inn : '',
      is_deleted: Boolean(item.is_deleted),
      usage_count: Number.isFinite(item.usage_count) ? item.usage_count : 0,
    };
  }

  function sanitizeItConnectionCategoryMap(source) {
    const target = {};
    if (!source || typeof source !== 'object') {
      return target;
    }
    Object.keys(source).forEach((key) => {
      const rawKey = typeof key === 'string' ? key : String(key || '');
      const label = source[key];
      if (typeof rawKey !== 'string' || typeof label !== 'string') {
        return;
      }
      const trimmedKey = rawKey.trim();
      const trimmedLabel = label.trim();
      if (!trimmedKey || !trimmedLabel) {
        return;
      }
      target[trimmedKey] = trimmedLabel;
    });
    return target;
  }

  function rebuildItConnectionCategorySelect(select, selectedKey) {
    if (!select) return;
    const desiredValue = typeof selectedKey === 'string' ? selectedKey : select.value;
    const fragment = document.createDocumentFragment();
    IT_CONNECTION_CATEGORY_KEYS.forEach((key) => {
      const option = document.createElement('option');
      option.value = key;
      option.textContent = IT_CONNECTION_CATEGORY_LABELS[key] || key;
      if (key === desiredValue) {
        option.selected = true;
      }
      fragment.appendChild(option);
    });
    select.innerHTML = '';
    if (fragment.childNodes.length) {
      select.appendChild(fragment);
    } else {
      const fallbackOption = document.createElement('option');
      fallbackOption.value = IT_CONNECTION_DEFAULT_CATEGORY;
      fallbackOption.textContent =
        IT_CONNECTION_CATEGORY_LABELS[IT_CONNECTION_DEFAULT_CATEGORY] || IT_CONNECTION_DEFAULT_CATEGORY;
      select.appendChild(fallbackOption);
    }
    if (
      desiredValue &&
      select.value !== desiredValue &&
      IT_CONNECTION_CATEGORY_KEYS.includes(desiredValue)
    ) {
      select.value = desiredValue;
    }
  }

  function setItConnectionCategories(newLabels, options = {}) {
    const base = sanitizeItConnectionCategoryMap(IT_CONNECTION_FALLBACK_LABELS);
    const overrides = sanitizeItConnectionCategoryMap(newLabels);
    Object.keys(overrides).forEach((key) => {
      base[key] = overrides[key];
    });
    if (!Object.keys(base).length) {
      base.equipment_type = 'Тип оборудования';
      base.equipment_vendor = 'Производитель оборудования';
      base.equipment_model = 'Модель оборудования';
      base.equipment_status = 'Статус оборудования';
    }
    IT_CONNECTION_CATEGORY_LABELS = base;
    IT_CONNECTION_CATEGORY_KEYS = Object.keys(IT_CONNECTION_CATEGORY_LABELS);
    IT_CONNECTION_DEFAULT_CATEGORY = determineItConnectionDefaultCategory(IT_CONNECTION_CATEGORY_KEYS);
    if (itConnectionCategorySelect) {
      const selectedKey = typeof options.selectedKey === 'string' ? options.selectedKey : undefined;
      rebuildItConnectionCategorySelect(itConnectionCategorySelect, selectedKey);
    }
  }

  setItConnectionCategories(IT_CONNECTION_FALLBACK_LABELS);

  let parameterData = {};
  const parameterStatusCache = new Map();
  let parametersLoaded = false;
  Object.keys(PARAMETER_TITLES).forEach((type) => {
    parameterData[type] = [];
  });
  const parameterModalEl = document.getElementById('parameterItemsModal');
  const parameterModal = parameterModalEl ? new bootstrap.Modal(parameterModalEl) : null;
  let parameterModalType = null;
  const cityCardEl = document.querySelector('[data-city-card]');

  function syncParameterData(source) {
    const data = source && typeof source === 'object' ? source : {};
    const result = {};
    const itConnectionCategoryUpdates = {}
    Object.keys(PARAMETER_TITLES).forEach((type) => {
      const items = Array.isArray(data[type]) ? data[type] : [];
      result[type] = items.map((item) => {
        const rawId = item && Object.prototype.hasOwnProperty.call(item, 'id') ? item.id : null;
        const idNumber = Number(rawId);
        const normalizedId = Number.isFinite(idNumber) ? idNumber : Number.parseInt(rawId, 10);
        const rawValue = item && Object.prototype.hasOwnProperty.call(item, 'value') ? item.value : '';
        const value = rawValue === null || rawValue === undefined ? '' : String(rawValue);
        const state = item && typeof item.state === 'string' && item.state ? item.state : PARAMETER_STATES[0];
        const usageRaw = Number(item && item.usage_count);
        const usageCount = Number.isFinite(usageRaw) ? usageRaw : 0;
        const extra = item && typeof item.extra === 'object' && item.extra !== null ? item.extra : {};
        const entry = {
          id: Number.isFinite(normalizedId) ? normalizedId : null,
          value,
          state: PARAMETER_STATES.includes(state) ? state : PARAMETER_STATES[0],
          is_deleted: Boolean(item && item.is_deleted),
          deleted_at: item && item.deleted_at ? item.deleted_at : null,
          usage_count: usageCount,
        };
        if (type === 'it_connection') {
          const extraData = extra && typeof extra === 'object' ? extra : {};
          const rawCategory =
            (item && typeof item.category === 'string' && item.category) ||
            (typeof extraData.category === 'string' ? extraData.category : '');
          const category = normalizeItConnectionCategory(rawCategory);
          const trimmedValue = value.trim();
          const rawCategoryLabel =
            (item && typeof item.category_label === 'string' && item.category_label) ||
            (typeof extraData.category_label === 'string' ? extraData.category_label : '');
          const categoryLabel = typeof rawCategoryLabel === 'string' ? rawCategoryLabel.trim() : '';
          const equipmentTypeSource =
            (item && typeof item.equipment_type === 'string' && item.equipment_type) ||
            (typeof extraData.equipment_type === 'string' ? extraData.equipment_type : '');
          const equipmentVendorSource =
            (item && typeof item.equipment_vendor === 'string' && item.equipment_vendor) ||
            (typeof extraData.equipment_vendor === 'string' ? extraData.equipment_vendor : '');
          const equipmentModelSource =
            (item && typeof item.equipment_model === 'string' && item.equipment_model) ||
            (typeof extraData.equipment_model === 'string' ? extraData.equipment_model : '');
          const equipmentStatusSource =
            (item && typeof item.equipment_status === 'string' && item.equipment_status) ||
            (typeof extraData.equipment_status === 'string' ? extraData.equipment_status : '');
          const equipmentType = typeof equipmentTypeSource === 'string' ? equipmentTypeSource.trim() : '';
          const equipmentVendor = typeof equipmentVendorSource === 'string' ? equipmentVendorSource.trim() : '';
          const equipmentModel = typeof equipmentModelSource === 'string' ? equipmentModelSource.trim() : '';
          const equipmentStatus = typeof equipmentStatusSource === 'string' ? equipmentStatusSource.trim() : '';
          let categoryValue = trimmedValue;
          if (category === 'equipment_type' && equipmentType) {
            categoryValue = equipmentType;
          } else if (category === 'equipment_vendor' && equipmentVendor) {
            categoryValue = equipmentVendor;
          } else if (category === 'equipment_model' && equipmentModel) {
            categoryValue = equipmentModel;
          } else if (category === 'equipment_status' && equipmentStatus) {
            categoryValue = equipmentStatus;
          }
          if (category && categoryLabel) {
            itConnectionCategoryUpdates[category] = categoryLabel;
          }
          const effectiveLabel = categoryLabel || IT_CONNECTION_CATEGORY_LABELS[category] || category;
          entry.value = categoryValue;
          entry.category = category;
          entry.category_label = effectiveLabel;
          entry.equipment_type = equipmentType;
          entry.equipment_vendor = equipmentVendor;
          entry.equipment_model = equipmentModel;
          entry.equipment_status = equipmentStatus;
          entry.extra = {
            category,
            category_label: effectiveLabel,
            equipment_type: equipmentType,
            equipment_vendor: equipmentVendor,
            equipment_model: equipmentModel,
            equipment_status: equipmentStatus,
          };
        } else if (type === 'iiko_server') {
          const extraData = extra && typeof extra === 'object' ? extra : {};
          const serverNameSource =
            (item && typeof item.server_name === 'string' && item.server_name) ||
            (typeof extraData.server_name === 'string' ? extraData.server_name : '');
          const serverName = typeof serverNameSource === 'string' ? serverNameSource.trim() : '';
          entry.server_name = serverName;
          entry.extra = Object.assign({}, extraData, { server_name: serverName });
        } else if (type === 'partner_contact') {
          const normalizedExtra = normalizePartnerContactExtra(extra, { value });
          entry.contact_type = normalizedExtra.contact_type;
          entry.phones = normalizedExtra.phones;
          entry.emails = normalizedExtra.emails;
          entry.contacts = normalizedExtra.contacts;
          entry.served_legal_entity_id = normalizedExtra.served_legal_entity_id;
          entry.served_legal_entity_name = normalizedExtra.served_legal_entity_name;
          entry.legal_entity = normalizedExtra.legal_entity;
          entry.inn = normalizedExtra.inn;
          entry.extra = normalizedExtra;
        } else if (extra && Object.keys(extra).length) {
          entry.extra = extra;
        }
        return entry;
      });
    });
    if (Object.keys(itConnectionCategoryUpdates).length) {
      setItConnectionCategories(itConnectionCategoryUpdates);
    }
    parameterData = result;
    parameterStatusCache.clear();
    partnerContactEdits.clear();
  }

  function buildStateSelect(type, selected, disabled, { forInput = false } = {}) {
    if (!PARAMETER_STATE_TYPES.has(type)) {
      return '';
    }
    const effective = PARAMETER_STATES.includes(selected) ? selected : PARAMETER_STATES[0];
    const options = PARAMETER_STATES.map((state) => `<option value="${state}"${state === effective ? ' selected' : ''}>${state}</option>`).join('');
    const roleAttr = forInput ? 'data-param-state-input' : 'data-param-field="state"';
    const disabledAttr = disabled ? ' disabled' : '';
    return `<select class="form-select form-select-sm" ${roleAttr} data-param-type="${type}" data-param-current-state="${effective}"${disabledAttr}>${options}</select>`;
  }

  function buildUsageControl(type, item) {
    if (type === 'department') {
      return '<span class="input-group-text text-muted">—</span>';
    }
    const filterKey = PARAMETER_FILTER_KEYS[type];
    const value = item && item.value ? String(item.value) : '';
    const trimmedValue = value.trim();
    if (!filterKey || !trimmedValue) {
      return '<span class="input-group-text text-muted">—</span>';
    }
    const usage = Number.isFinite(Number(item && item.usage_count)) ? Number(item.usage_count) : 0;
    const url = `/object_passports?${filterKey}=${encodeURIComponent(trimmedValue)}`;
    const btnClass = usage > 0 ? 'btn btn-outline-primary' : 'btn btn-outline-secondary';
    return `<a class="${btnClass}" data-param-role="usage" href="${url}" title="Открыть паспорта с этим значением">${usage}</a>`;
  }

  function buildParameterItem(type, item) {
    const rawId = item && item.id;
    const idNumber = Number(rawId);
    const id = Number.isFinite(idNumber) ? idNumber : Number.parseInt(rawId, 10);
    if (!Number.isFinite(id)) {
      return '';
    }
    const value = item && item.value ? String(item.value) : '';
    const disabled = Boolean(item && item.is_deleted);
    let serverNameInput = '';
    if (type === 'iiko_server') {
      let serverNameSource = '';
      if (item && typeof item.server_name === 'string') {
        serverNameSource = item.server_name;
      } else if (item && item.extra && typeof item.extra.server_name === 'string') {
        serverNameSource = item.extra.server_name;
      }
      const serverName = typeof serverNameSource === 'string' ? serverNameSource.trim() : '';
      serverNameInput = `<input type="text" class="form-control" data-param-field="server_name" placeholder="Имя сервера" value="${escapeHtml(serverName)}"${disabled ? ' disabled' : ''}>`;
    }
    const valuePlaceholder = type === 'iiko_server' ? 'Адрес сервера' : '';
    const valueInput = `<input type="text" class="form-control" data-param-field="value"${valuePlaceholder ? ` placeholder="${valuePlaceholder}"` : ''} value="${escapeHtml(value)}"${disabled ? ' disabled' : ''}>`;
    const stateSelect = buildStateSelect(type, item ? item.state : undefined, disabled, { forInput: false });
    const usageControl = buildUsageControl(type, item);
    const saveButton = `<button class="btn btn-outline-success" type="button" data-param-action="save" data-param-id="${id}" data-param-type="${type}" title="Сохранить"${disabled ? ' disabled' : ''}>💾</button>`;
    const deleteButton = disabled
      ? `<button class="btn btn-outline-secondary" type="button" data-param-action="restore" data-param-id="${id}" data-param-type="${type}" title="Восстановить">↩️</button>`
      : `<button class="btn btn-outline-danger" type="button" data-param-action="delete" data-param-id="${id}" data-param-type="${type}" title="Удалить">🗑</button>`;
    const deletedHint = disabled ? '<div class="form-text text-danger small">Запись помечена как удалённая</div>' : '';
    return `
      <div class="param-entry${disabled ? ' param-entry--deleted' : ''}" data-param-id="${id}" data-param-type="${type}">
        <div class="input-group input-group-sm mb-2">
          ${serverNameInput}
          ${valueInput}
          ${stateSelect}
          ${usageControl}
          ${saveButton}
          ${deleteButton}
        </div>
        ${deletedHint}
      </div>
    `;
  }

  function buildParameterContent(type, items, context) {
    const listHtml = items.length
      ? items.map((item) => buildParameterItem(type, item)).join('')
      : '<div class="empty-placeholder">Пока нет значений</div>';
    const createPlaceholder = type === 'iiko_server' ? 'Адрес сервера' : 'Добавить значение';
    const extraControls = [];
    if (type === 'iiko_server') {
      extraControls.push(
        '<input type="text" class="form-control" placeholder="Имя сервера" data-param-create-field="server_name">'
      );
    }
    const controls = `
      <div class="input-group input-group-sm mt-3">
        ${buildStateSelect(type, PARAMETER_STATES[0], false, { forInput: true })}
        ${extraControls.join('')}
        <input type="text" class="form-control" placeholder="${createPlaceholder}" data-param-input>
        <button class="btn btn-success" type="button" data-param-action="create" data-param-type="${type}">Добавить</button>
      </div>
    `;
    return `
      <div data-param-container data-param-type="${type}" data-param-context="${context}">
        <div class="param-items">${listHtml}</div>
        ${controls}
      </div>
    `;
  }

  function renderRemoteAccessSection() {
    const remoteAccessContainer = document.querySelector('[data-remote-access-container]');
    if (!remoteAccessContainer) return;
    const items = Array.isArray(parameterData.remote_access) ? parameterData.remote_access : [];
    remoteAccessContainer.innerHTML = buildParameterContent('remote_access', items, 'it');
  }

  function buildLegalEntityStateSelect(state, disabled, { isDraft = false } = {}) {
    const effective = PARAMETER_STATES.includes(state) ? state : PARAMETER_STATES[0];
    const options = PARAMETER_STATES.map((item) => {
      const isSelected = item === effective;
      return `<option value="${escapeHtml(item)}"${isSelected ? ' selected' : ''}>${escapeHtml(item)}</option>`;
    }).join('');
    const disabledAttr = disabled ? ' disabled' : '';
    if (isDraft) {
      return `<select class="form-select form-select-sm" data-legal-entity-field="state"${disabledAttr}>${options}</select>`;
    }
    return `
      <select
        class="form-select form-select-sm"
        data-legal-entity-field="state"
        data-param-field="state"
        data-param-type="legal_entity"
        data-param-current-state="${escapeHtml(effective)}"
        ${disabledAttr}
      >
        ${options}
      </select>
    `;
  }

  function getLegalEntityRenderItems() {
    const existing = Array.isArray(parameterData.legal_entity) ? parameterData.legal_entity : [];
    const mappedExisting = existing.map((item) => {
      const extra = item && typeof item.extra === 'object' ? item.extra : {};
      const inn = typeof extra.inn === 'string' ? extra.inn : '';
      const contacts = typeof extra.manager_contacts === 'string' ? extra.manager_contacts : '';
      const usage = Number.isFinite(Number(item && item.usage_count)) ? Number(item.usage_count) : 0;
      return {
        id: item.id,
        value: item && typeof item.value === 'string' ? item.value : '',
        state: item && typeof item.state === 'string' ? item.state : PARAMETER_STATES[0],
        is_deleted: Boolean(item && item.is_deleted),
        usage_count: usage,
        inn,
        manager_contacts: contacts,
        isDraft: false,
      };
    });
    const mappedDrafts = legalEntityDrafts.map((draft) => ({
      draftId: draft.draftId,
      value: typeof draft.value === 'string' ? draft.value : '',
      state: typeof draft.state === 'string' ? draft.state : PARAMETER_STATES[0],
      is_deleted: false,
      usage_count: 0,
      inn: typeof draft.inn === 'string' ? draft.inn : '',
      manager_contacts: typeof draft.manager_contacts === 'string' ? draft.manager_contacts : '',
      isDraft: true,
    }));
    return mappedExisting.concat(mappedDrafts);
  }

  function renderLegalEntityCard(item) {
    const isDraft = Boolean(item && item.isDraft);
    const nameValue = typeof item.value === 'string' ? item.value : '';
    const trimmedName = nameValue.trim();
    const innValue = typeof item.inn === 'string' ? item.inn : '';
    const contactsValue = typeof item.manager_contacts === 'string' ? item.manager_contacts : '';
    const stateValue = typeof item.state === 'string' ? item.state : PARAMETER_STATES[0];
    const isDeleted = Boolean(item && item.is_deleted);
    const usageCount = Number.isFinite(Number(item && item.usage_count)) ? Number(item.usage_count) : 0;
    const usageLabel = `Используется: ${usageCount}`;
    const usageControl = !isDraft && trimmedName
      ? `<a href="/object_passports?legal_entity=${encodeURIComponent(trimmedName)}" class="btn btn-link btn-sm p-0${usageCount ? '' : ' text-muted'}">${usageLabel}</a>`
      : `<span class="text-muted small">${usageLabel}</span>`;
    const disabledAttr = isDeleted ? ' disabled' : '';
    const stateSelectHtml = buildLegalEntityStateSelect(stateValue, isDeleted, { isDraft });
    const contactsField = `<textarea class="form-control" rows="3" data-legal-entity-field="manager_contacts"${disabledAttr} placeholder="Телефон, почта, Telegram">${escapeHtml(contactsValue)}</textarea>`;
    const primaryLabel = isDraft ? 'Создать' : 'Сохранить';
    const primaryClass = isDraft ? 'btn-success' : 'btn-primary';
    const primaryDisabled = isDeleted ? ' disabled' : '';
    let secondaryButton = '';
    if (isDraft) {
      secondaryButton = '<button class="btn btn-outline-secondary btn-sm" type="button" data-legal-entity-action="cancel">Отмена</button>';
    } else if (isDeleted) {
      secondaryButton = '<button class="btn btn-outline-success btn-sm" type="button" data-legal-entity-action="restore">Восстановить</button>';
    } else {
      secondaryButton = '<button class="btn btn-outline-danger btn-sm" type="button" data-legal-entity-action="delete">Удалить</button>';
    }
    const deletedHint = isDeleted
      ? '<div class="alert alert-warning small mt-3 mb-0">Запись помечена как удалённая. Восстановите её, чтобы вносить изменения.</div>'
      : '';
    const idBadge = !isDraft ? `<span class="badge bg-secondary ms-auto">ID: ${item.id}</span>` : '';
    const cardClasses = ['card', 'shadow-sm', 'h-100', 'legal-entity-card'];
    if (isDeleted) {
      cardClasses.push('border-danger', 'opacity-75');
    }
    const datasetAttrs = isDraft
      ? `data-legal-entity-card="true" data-legal-entity-draft="true" data-legal-entity-draft-id="${escapeHtml(item.draftId)}"`
      : `data-legal-entity-card="true" data-legal-entity-draft="false" data-param-id="${item.id}" data-param-type="legal_entity"${isDeleted ? ' data-legal-entity-deleted="true"' : ''}`;
    return `
      <div class="col">
        <div class="${cardClasses.join(' ')}" ${datasetAttrs}>
          <div class="card-header d-flex justify-content-between align-items-start gap-2">
            <div>
              <div class="fw-semibold" data-legal-entity-title>${escapeHtml(trimmedName || 'Без названия')}</div>
              <div class="small text-muted" data-legal-entity-state-label>${escapeHtml(stateValue)}</div>
            </div>
            <div>${usageControl}</div>
          </div>
          <div class="card-body d-flex flex-column gap-3">
            <div>
              <label class="form-label">Название ЮЛ</label>
              <input type="text" class="form-control" data-legal-entity-field="value"${disabledAttr} value="${escapeHtml(nameValue)}" placeholder="Например, ООО «Партнёр»">
            </div>
            <div class="row g-3">
              <div class="col-sm-6">
                <label class="form-label">ИНН</label>
                <input type="text" class="form-control" data-legal-entity-field="inn"${disabledAttr} value="${escapeHtml(innValue)}" placeholder="12 цифр">
              </div>
              <div class="col-sm-6">
                <label class="form-label">Статус</label>
                ${stateSelectHtml}
              </div>
            </div>
            <div>
              <label class="form-label">Контакты менеджеров</label>
              ${contactsField}
              <div class="form-text">Укажите телефоны, почту или мессенджеры ответственных менеджеров.</div>
            </div>
            <div class="d-flex flex-wrap gap-2 align-items-center">
              <button class="btn ${primaryClass} btn-sm" type="button" data-legal-entity-action="save"${primaryDisabled}>${primaryLabel}</button>
              ${secondaryButton}
              ${idBadge}
            </div>
            ${deletedHint}
          </div>
        </div>
      </div>
    `;
  }

  function renderLegalEntities() {
    if (!legalEntitiesContainer) return;
    const items = getLegalEntityRenderItems();
    if (!items.length) {
      legalEntitiesContainer.innerHTML = '';
      if (legalEntitiesEmptyPlaceholder) {
        legalEntitiesEmptyPlaceholder.classList.remove('d-none');
      }
      return;
    }
    legalEntitiesContainer.innerHTML = items.map((item) => renderLegalEntityCard(item)).join('');
    if (legalEntitiesEmptyPlaceholder) {
      legalEntitiesEmptyPlaceholder.classList.add('d-none');
    }
  }

  function addLegalEntityDraft(initial = {}) {
    legalEntityDraftCounter += 1;
    const defaults = {
      draftId: `draft-${legalEntityDraftCounter}`,
      value: '',
      inn: '',
      manager_contacts: '',
      state: PARAMETER_STATES[0],
    };
    const draft = Object.assign({}, defaults, initial || {});
    legalEntityDrafts.push(draft);
    renderLegalEntities();
  }

  function removeLegalEntityDraft(draftId) {
    const index = legalEntityDrafts.findIndex((item) => item.draftId === draftId);
    if (index === -1) return;
    legalEntityDrafts.splice(index, 1);
    renderLegalEntities();
  }

  function updateLegalEntityDraftValue(draftId, field, value) {
    const draft = legalEntityDrafts.find((item) => item.draftId === draftId);
    if (!draft) return;
    if (field === 'value') {
      draft.value = value;
    } else if (field === 'inn') {
      draft.inn = value;
    } else if (field === 'manager_contacts') {
      draft.manager_contacts = value;
    } else if (field === 'state') {
      draft.state = PARAMETER_STATES.includes(value) ? value : draft.state;
    }
  }

  function updateLegalEntityStateLabel(card, value) {
    const label = card.querySelector('[data-legal-entity-state-label]');
    if (label) {
      label.textContent = value || '—';
    }
  }

  async function handleLegalEntitySave(card, trigger) {
    const isDraft = card.dataset.legalEntityDraft === 'true';
    const valueInput = card.querySelector('[data-legal-entity-field="value"]');
    const innInput = card.querySelector('[data-legal-entity-field="inn"]');
    const contactsInput = card.querySelector('[data-legal-entity-field="manager_contacts"]');
    const stateSelect = card.querySelector('[data-legal-entity-field="state"]');
    const name = valueInput ? valueInput.value.trim() : '';
    if (!name) {
      alert('Название ЮЛ не может быть пустым');
      if (valueInput) {
        valueInput.focus();
      }
      return;
    }
    const payload = {
      value: name,
      inn: innInput ? innInput.value.trim() : '',
      manager_contacts: contactsInput ? contactsInput.value.trim() : '',
    };
    if (stateSelect && !stateSelect.disabled) {
      payload.state = stateSelect.value;
    }

    const originalText = trigger.textContent;
    trigger.disabled = true;
    trigger.textContent = '...';

    try {
      let response;
      if (isDraft) {
        payload.param_type = 'legal_entity';
        response = await fetch('/api/settings/parameters', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } else {
        const id = Number.parseInt(card.dataset.paramId, 10);
        if (!Number.isFinite(id)) {
          throw new Error('Не удалось определить идентификатор записи');
        }
        response = await fetch(`/api/settings/parameters/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      }
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || 'Ошибка сохранения записи');
      }
      if (isDraft) {
        const draftId = card.dataset.legalEntityDraftId;
        if (draftId) {
          const index = legalEntityDrafts.findIndex((item) => item.draftId === draftId);
          if (index !== -1) {
            legalEntityDrafts.splice(index, 1);
          }
        }
      }
      syncParameterData((data && data.data) || parameterData);
      renderParameters({ forceBodies: true });
      renderItConnectionsTable();
    } catch (error) {
      const message = error && error.message ? error.message : error;
      alert('❌ ' + message);
    } finally {
      trigger.disabled = false;
      trigger.textContent = originalText;
    }
  }

  function getPartnerContactLegalEntityOptions() {
    const items = Array.isArray(parameterData.legal_entity) ? parameterData.legal_entity : [];
    const options = [];
    items.forEach((item) => {
      if (!item) return;
      if (item.is_deleted) return;
      const label = typeof item.value === 'string' ? item.value.trim() : '';
      if (!label) return;
      const id = Number.isFinite(item.id) ? item.id : Number.parseInt(item.id, 10);
      if (!Number.isFinite(id)) return;
      options.push({ id, label });
    });
    return options;
  }

  function getPartnerContactBaseItems() {
    const items = Array.isArray(parameterData.partner_contact) ? parameterData.partner_contact : [];
    return items
      .map((item) => {
        if (!item) return null;
        return clonePartnerContactItem({
          id: Number.isFinite(item.id) ? item.id : Number.parseInt(item.id, 10),
          value: typeof item.value === 'string' ? item.value : '',
          state: typeof item.state === 'string' ? item.state : PARAMETER_STATES[0],
          contact_type: item.contact_type,
          phones: item.phones,
          emails: item.emails,
          contacts: item.contacts,
          served_legal_entities: item.served_legal_entities,
          served_legal_entity_id: item.served_legal_entity_id,
          served_legal_entity_name: item.served_legal_entity_name,
          served_legal_entity_ids: item.served_legal_entity_ids,
          served_legal_entity_names: item.served_legal_entity_names,
          legal_entity: typeof item.legal_entity === 'string' ? item.legal_entity : '',
          internal_name: typeof item.internal_name === 'string' ? item.internal_name : '',
          inn: typeof item.inn === 'string' ? item.inn : '',
          is_deleted: Boolean(item.is_deleted),
          usage_count: Number.isFinite(Number(item.usage_count)) ? Number(item.usage_count) : 0,
        });
      })
      .filter((entry) => entry && Number.isFinite(entry.id));
  }

  function ensurePartnerContactEdit(id) {
    if (!Number.isFinite(id)) return null;
    if (!partnerContactEdits.has(id)) {
      const baseItems = getPartnerContactBaseItems();
      const base = baseItems.find((item) => item && item.id === id);
      partnerContactEdits.set(id, base ? clonePartnerContactItem(base) : null);
    }
    const current = partnerContactEdits.get(id);
    if (!current) {
      return null;
    }
    if (!Array.isArray(current.phones)) {
      current.phones = [];
    }
    if (!Array.isArray(current.emails)) {
      current.emails = [];
    }
    if (!Array.isArray(current.served_legal_entities)) {
      current.served_legal_entities = [];
    }
    if (!Array.isArray(current.contacts)) {
      current.contacts = [];
    }
    return current;
  }

  function getPartnerContactRenderItems() {
    const baseItems = getPartnerContactBaseItems();
    const rendered = baseItems.map((item) => {
      const id = item.id;
      const edit = ensurePartnerContactEdit(id);
      if (edit) {
        const clone = clonePartnerContactItem(edit);
        clone.id = id;
        clone.isDraft = false;
        clone.is_deleted = item.is_deleted;
        clone.usage_count = item.usage_count;
        return clone;
      }
      item.isDraft = false;
      return item;
    });
    partnerContactDrafts.forEach((draft) => {
      const clone = clonePartnerContactItem(draft);
      if (!clone) return;
      clone.isDraft = true;
      clone.draftId = draft.draftId;
      rendered.push(clone);
    });
    return rendered;
  }

  function buildPartnerContactTypeSelect(selected, disabled) {
    const effective = Object.prototype.hasOwnProperty.call(PARTNER_CONTACT_TYPES, selected)
      ? selected
      : 'partner';
    const disabledAttr = disabled ? ' disabled' : '';
    const options = Object.keys(PARTNER_CONTACT_TYPES)
      .map((key) => {
        const label = PARTNER_CONTACT_TYPES[key];
        const isSelected = key === effective;
        return `<option value="${key}"${isSelected ? ' selected' : ''}>${escapeHtml(label)}</option>`;
      })
      .join('');
    return `<select class="form-select form-select-sm" data-partner-contact-field="contact_type"${disabledAttr}>${options}</select>`;
  }

  function buildPartnerContactStateControl(item, disabled) {
    const effective = PARAMETER_STATES.includes(item.state) ? item.state : PARAMETER_STATES[0];
    const options = PARAMETER_STATES.map((state) => {
      const isSelected = state === effective;
      return `<option value="${escapeHtml(state)}"${isSelected ? ' selected' : ''}>${escapeHtml(state)}</option>`;
    }).join('');
    const disabledAttr = disabled ? ' disabled' : '';
    return `<select class="form-select form-select-sm" data-partner-contact-field="state"${disabledAttr}>${options}</select>`;
  }

  function buildPartnerContactServedSelect(item, disabled) {
    const disabledAttr = disabled ? ' disabled' : '';
    const options = getPartnerContactLegalEntityOptions();
    const servedEntities = Array.isArray(item.served_legal_entities) ? item.served_legal_entities : [];
    const selectedIds = new Set();
    const labelById = new Map();

    servedEntities.forEach((entry) => {
      if (!entry || typeof entry !== 'object') return;
      const parsed = Number.isFinite(entry.id) ? entry.id : Number.parseInt(entry.id, 10);
      if (!Number.isFinite(parsed) || parsed <= 0) return;
      selectedIds.add(parsed);
      const label = typeof entry.name === 'string' && entry.name.trim() ? entry.name.trim() : `ID ${parsed}`;
      labelById.set(parsed, label);
    });

    const fallbackId = Number.isFinite(item.served_legal_entity_id)
      ? item.served_legal_entity_id
      : Number.parseInt(item.served_legal_entity_id, 10);
    if (Number.isFinite(fallbackId) && fallbackId > 0 && !selectedIds.has(fallbackId)) {
      selectedIds.add(fallbackId);
      const fallbackName = typeof item.served_legal_entity_name === 'string' && item.served_legal_entity_name.trim()
        ? item.served_legal_entity_name.trim()
        : `ID ${fallbackId}`;
      labelById.set(fallbackId, fallbackName);
    }

    const entries = [];
    options.forEach(({ id, label }) => {
      const isSelected = selectedIds.has(id);
      if (isSelected) {
        selectedIds.delete(id);
      }
      labelById.set(id, label);
      entries.push(
        `<option value="${id}" data-label="${escapeHtml(label)}"${isSelected ? ' selected' : ''}>${escapeHtml(label)}</option>`
      );
    });

    selectedIds.forEach((id) => {
      const fallbackLabel = labelById.get(id) || `ID ${id}`;
      entries.push(
        `<option value="${id}" data-label="${escapeHtml(fallbackLabel)}" selected>${escapeHtml(fallbackLabel)} • не найдено</option>`
      );
    });

    if (!entries.length) {
      return '<div class="text-muted small">Нет доступных ЮЛ</div>';
    }

    const size = Math.min(Math.max(entries.length, 4), 10);
    return `<select class="form-select form-select-sm partner-contact-served-select" data-partner-contact-field="served_legal_entities" multiple size="${size}"${disabledAttr}>${entries.join('')}</select>`;
  }

  function buildPartnerContactCommRows(entries, kind, disabled) {
    if (!Array.isArray(entries) || !entries.length) {
      return '<div class="text-muted small" data-partner-contact-empty>Нет данных</div>';
    }
    const allowed = kind === 'phone' ? PARTNER_CONTACT_PHONE_TYPES : PARTNER_CONTACT_EMAIL_TYPES;
    return entries
      .map((entry) => {
        const rawValue = typeof entry.value === 'string' ? entry.value : '';
        const digitsValue = kind === 'phone' ? extractDigits(rawValue) : rawValue;
        const value = kind === 'phone' ? formatPhoneValue(digitsValue) : rawValue;
        const extensionValue = kind === 'phone' && typeof entry.extension === 'string' ? extractDigits(entry.extension) : '';
        const type = Object.prototype.hasOwnProperty.call(allowed, entry.type) ? entry.type : Object.keys(allowed)[0];
        const disabledAttr = disabled ? ' disabled' : '';
        const options = Object.keys(allowed)
          .map((key) => {
            const label = allowed[key];
            const isSelected = key === type;
            return `<option value="${key}"${isSelected ? ' selected' : ''}>${escapeHtml(label)}</option>`;
          })
          .join('');
        const removeBtn = disabled
          ? ''
          : `<button class="btn btn-outline-danger" type="button" data-partner-contact-remove-comm data-comm-type="${kind}" data-entry-key="${escapeHtml(entry.key)}" title="Удалить">🗑</button>`;
        if (kind === 'phone') {
          return `
            <div class="input-group input-group-sm mb-2" data-partner-contact-comm-row data-comm-type="${kind}" data-entry-key="${escapeHtml(entry.key)}">
              <select class="form-select form-select-sm" data-partner-contact-comm-field="type" data-comm-type="${kind}" data-entry-key="${escapeHtml(entry.key)}"${disabledAttr}>${options}</select>
              <input type="text" class="form-control" data-partner-contact-comm-field="value" data-comm-type="${kind}" data-entry-key="${escapeHtml(entry.key)}" data-phone-digits="${escapeHtml(digitsValue)}" value="${escapeHtml(value)}" placeholder="Номер" inputmode="numeric"${disabledAttr}>
              <span class="input-group-text">доб.</span>
              <input type="text" class="form-control" data-partner-contact-comm-field="extension" data-comm-type="${kind}" data-entry-key="${escapeHtml(entry.key)}" value="${escapeHtml(extensionValue)}" placeholder="Доб. номер" inputmode="numeric"${disabledAttr}>
              ${removeBtn}
            </div>
          `;
        }
        return `
          <div class="input-group input-group-sm mb-2" data-partner-contact-comm-row data-comm-type="${kind}" data-entry-key="${escapeHtml(entry.key)}">
            <select class="form-select form-select-sm" data-partner-contact-comm-field="type" data-comm-type="${kind}" data-entry-key="${escapeHtml(entry.key)}"${disabledAttr}>${options}</select>
            <input type="email" class="form-control" data-partner-contact-comm-field="value" data-comm-type="${kind}" data-entry-key="${escapeHtml(entry.key)}" value="${escapeHtml(value)}" placeholder="E-mail"${disabledAttr}>
            ${removeBtn}
          </div>
        `;
      })
      .join('');
  }

  function getSortedPartnerContactPeople(entries) {
    if (!Array.isArray(entries) || !entries.length) {
      return [];
    }
    return entries
      .map((person, index) => ({
        person,
        index,
        isTop: normalizeBooleanValue(person && person.is_top),
        name: person && typeof person.full_name === 'string' ? person.full_name.trim() : '',
      }))
      .sort((a, b) => {
        if (a.isTop !== b.isTop) {
          return a.isTop ? -1 : 1;
        }
        const nameCompare = a.name.localeCompare(b.name, undefined, { sensitivity: 'base' });
        if (nameCompare !== 0) {
          return nameCompare;
        }
        return a.index - b.index;
      })
      .map(({ person }) => person);
  }

  function buildPartnerContactPeople(entries, disabled) {
    if (!Array.isArray(entries) || !entries.length) {
      return '<div class="text-muted small" data-partner-contact-person-empty>Контакты не добавлены</div>';
    }
    const sortedEntries = getSortedPartnerContactPeople(entries);
    const maxVisible = 2;
    const peopleCards = sortedEntries
      .map((person, index) => {
        if (!person || typeof person !== 'object') {
          return '';
        }
        const key = typeof person.key === 'string' ? person.key : '';
        const fullName = typeof person.full_name === 'string' ? person.full_name : '';
        const position = typeof person.position === 'string' ? person.position : '';
        const phone = typeof person.phone === 'string' ? person.phone : '';
        const email = typeof person.email === 'string' ? person.email : '';
        const phoneDigits = extractDigits(phone);
        const formattedPhone = formatPhoneValue(phone);
        const disabledAttr = disabled ? ' disabled' : '';
        const isTop = normalizeBooleanValue(person.is_top);
        const topBadgeClass = isTop
          ? 'badge bg-warning text-dark'
          : 'badge bg-warning text-dark d-none';
        const topToggle = `
          <div class="form-check form-switch mb-0">
            <input class="form-check-input" type="checkbox" data-partner-contact-person-field="is_top"${isTop ? ' checked' : ''}${disabledAttr}>
            <label class="form-check-label small">ТОП</label>
          </div>
        `;
        const removeBtn = disabled
          ? ''
          : `<button class="btn btn-outline-danger btn-sm" type="button" data-partner-contact-remove-person data-person-key="${escapeHtml(
              key
            )}">Удалить</button>`;
        const titleText = escapeHtml(fullName || `Контакт ${index + 1}`);
        const subtitleClass = position
          ? 'partner-contact-person-card__subtitle'
          : 'partner-contact-person-card__subtitle d-none';
        const subtitleText = escapeHtml(position || '');
        return `
          <div class="partner-contact-person partner-contact-person-card" data-partner-contact-person="${escapeHtml(key)}">
            <div class="partner-contact-person-card__header">
              <div>
                <div class="d-flex align-items-center gap-2">
                  <div class="partner-contact-person-card__title" data-partner-contact-person-title>${titleText}</div>
                  <span class="${topBadgeClass}" data-partner-contact-person-top-badge>ТОП</span>
                </div>
                <div class="${subtitleClass}" data-partner-contact-person-subtitle>${subtitleText}</div>
              </div>
              <div class="partner-contact-person__actions d-flex flex-column align-items-end gap-2">
                ${topToggle}
                ${removeBtn}
              </div>
            </div>
            <div class="partner-contact-person-card__body">
              <div class="row g-3">
                <div class="col-12 col-lg-6">
                  <label class="form-label">ФИО</label>
                  <input type="text" class="form-control form-control-sm" data-partner-contact-person-field="full_name" value="${escapeHtml(
                    fullName
                  )}" placeholder="Иванов Иван Иванович"${disabledAttr}>
                </div>
                <div class="col-12 col-lg-6">
                  <label class="form-label">Должность</label>
                  <input type="text" class="form-control form-control-sm" data-partner-contact-person-field="position" value="${escapeHtml(
                    position
                  )}" placeholder="Например, менеджер"${disabledAttr}>
                </div>
                <div class="col-12 col-lg-6">
                  <label class="form-label">Телефон</label>
                  <input type="text" class="form-control form-control-sm" data-partner-contact-person-field="phone" value="${escapeHtml(
                    formattedPhone
                  )}" placeholder="Например, +7 999 123-45-67" inputmode="tel" data-phone-digits="${escapeHtml(
                    phoneDigits
                  )}"${disabledAttr}>
                </div>
                <div class="col-12 col-lg-6">
                  <label class="form-label">E-mail</label>
                  <input type="email" class="form-control form-control-sm" data-partner-contact-person-field="email" value="${escapeHtml(
                    email
                  )}" placeholder="example@company.com"${disabledAttr}>
                </div>
              </div>
            </div>
          </div>
        `;
      })
      .filter(Boolean);
    const visibleCards = peopleCards.slice(0, maxVisible).join('');
    const hiddenCards = peopleCards.slice(maxVisible).join('');
    if (!hiddenCards) {
      return visibleCards;
    }
    const extraCount = sortedEntries.length - maxVisible;
    const collapsedText = `Показать ещё ${formatPartnerContactCount(extraCount)}`;
    const expandedText = 'Скрыть дополнительные контакты';
    return `
      <div class="partner-contact-people-wrapper" data-partner-contact-people-wrapper>
        ${visibleCards}
        <div class="partner-contact-people-extra mt-3 d-none" data-partner-contact-people-extra>${hiddenCards}</div>
        <div class="mt-3">
          <button class="btn btn-link btn-sm px-0 partner-contact-people-toggle" type="button" data-partner-contact-people-toggle aria-expanded="false" data-collapsed-text="${escapeHtml(
            collapsedText
          )}" data-expanded-text="${escapeHtml(expandedText)}">${escapeHtml(collapsedText)}</button>
        </div>
      </div>
    `;
  }

  function formatPartnerContactCount(count) {
    const value = Number.parseInt(count, 10);
    if (!Number.isFinite(value) || value <= 0) {
      return '0 контактов';
    }
    const abs = Math.abs(value);
    const mod10 = abs % 10;
    const mod100 = abs % 100;
    if (mod10 === 1 && mod100 !== 11) {
      return `${abs} контакт`;
    }
    if (mod10 >= 2 && mod10 <= 4 && (mod100 < 10 || mod100 >= 20)) {
      return `${abs} контакта`;
    }
    return `${abs} контактов`;
  }

  function getPartnerContactServedSummaryText(item) {
    if (!item || typeof item !== 'object') return '';
    const names = [];
    const servedEntities = Array.isArray(item.served_legal_entities) ? item.served_legal_entities : [];
    servedEntities.forEach((entry) => {
      if (!entry || typeof entry !== 'object') return;
      const name = typeof entry.name === 'string' ? entry.name.trim() : '';
      const id = Number.isFinite(entry.id) ? entry.id : Number.parseInt(entry.id, 10);
      if (name) {
        names.push(name);
      } else if (Number.isFinite(id) && id > 0) {
        names.push(`ID ${id}`);
      }
    });
    if (!names.length) {
      const fallbackName = typeof item.served_legal_entity_name === 'string' ? item.served_legal_entity_name.trim() : '';
      const fallbackId = Number.isFinite(item.served_legal_entity_id)
        ? item.served_legal_entity_id
        : Number.parseInt(item.served_legal_entity_id, 10);
      if (fallbackName) {
        names.push(fallbackName);
      } else if (Number.isFinite(fallbackId) && fallbackId > 0) {
        names.push(`ID ${fallbackId}`);
      }
    }
    return names.join(', ');
  }

  function buildPartnerContactSummaryContacts(item) {
    const contacts = getSortedPartnerContactPeople(Array.isArray(item.contacts) ? item.contacts : []);
    const normalized = contacts
      .map((person, index) => {
        if (!person || typeof person !== 'object') return null;
        const fullName = typeof person.full_name === 'string' ? person.full_name.trim() : '';
        const position = typeof person.position === 'string' ? person.position.trim() : '';
        const phone = typeof person.phone === 'string' ? person.phone.trim() : '';
        const formattedPhone = formatPhoneValue(phone);
        const email = typeof person.email === 'string' ? person.email.trim() : '';
        if (!fullName && !position && !phone && !email) return null;
        return {
          title: fullName || `Контакт ${index + 1}`,
          position,
          phone: formattedPhone,
          email,
          is_top: normalizeBooleanValue(person.is_top),
        };
      })
      .filter((entry) => entry);
    const limited = normalized.slice(0, 2);
    const items = limited.map((person) => {
      const metaLines = [];
      if (person.position) {
        metaLines.push(`<div class="partner-contact-summary-contact-meta">${escapeHtml(person.position)}</div>`);
      }
      const detailParts = [];
      if (person.phone) {
        detailParts.push(`<span><i class="bi bi-telephone-fill me-1"></i>${escapeHtml(person.phone)}</span>`);
      }
      if (person.email) {
        detailParts.push(`<span><i class="bi bi-envelope-fill me-1"></i>${escapeHtml(person.email)}</span>`);
      }
      if (detailParts.length) {
        metaLines.push(
          `<div class="partner-contact-summary-contact-meta">${detailParts.join('<span class="text-muted">•</span>')}</div>`
        );
      }
      const topBadge = person.is_top
        ? ' <span class="badge bg-warning text-dark ms-1">ТОП</span>'
        : '';
      return `
        <li class="partner-contact-summary-contact">
          <div class="partner-contact-summary-contact-title">${escapeHtml(person.title)}${topBadge}</div>
          ${metaLines.join('')}
        </li>
      `;
    });
    if (normalized.length > limited.length) {
      const remainder = normalized.length - limited.length;
      items.push(
        `<li class="partner-contact-summary-contact-meta text-muted">Ещё ${formatPartnerContactCount(remainder)}</li>`
      );
    }
    if (items.length) {
      return items.join('');
    }
    const fallbackEntries = [];
    const phones = Array.isArray(item.phones) ? item.phones : [];
    phones.forEach((entry) => {
      if (!entry || typeof entry !== 'object') return;
      const value = typeof entry.value === 'string' ? extractDigits(entry.value) : '';
      if (!value) return;
      const extension = typeof entry.extension === 'string' ? extractDigits(entry.extension) : '';
      fallbackEntries.push({ kind: 'phone', value, extension });
    });
    const emails = Array.isArray(item.emails) ? item.emails : [];
    emails.forEach((entry) => {
      if (!entry || typeof entry !== 'object') return;
      const value = typeof entry.value === 'string' ? entry.value.trim() : '';
      if (!value) return;
      fallbackEntries.push({ kind: 'email', value });
    });
    const limitedFallback = fallbackEntries.slice(0, 2);
    if (limitedFallback.length) {
      const rendered = limitedFallback
        .map((entry) => {
          const icon = entry.kind === 'phone'
            ? '<i class="bi bi-telephone-fill me-1"></i>'
            : '<i class="bi bi-envelope-fill me-1"></i>';
          const label = entry.kind === 'phone' ? 'Телефон' : 'E-mail';
          if (entry.kind === 'phone') {
            const formatted = formatPhoneValue(entry.value);
            if (!formatted) {
              return '';
            }
            const extensionPart = entry.extension
              ? `<span class="text-muted">•</span><span> доб. ${escapeHtml(entry.extension)}</span>`
              : '';
            return `
              <li class="partner-contact-summary-contact">
                <div class="partner-contact-summary-contact-title">${label}</div>
                <div class="partner-contact-summary-contact-meta">${icon}${escapeHtml(formatted)}${extensionPart}</div>
              </li>
            `;
          }
          return `
            <li class="partner-contact-summary-contact">
              <div class="partner-contact-summary-contact-title">${label}</div>
              <div class="partner-contact-summary-contact-meta">${icon}${escapeHtml(entry.value)}</div>
            </li>
          `;
        })
        .join('');
      if (fallbackEntries.length > limitedFallback.length) {
        const remainder = fallbackEntries.length - limitedFallback.length;
        return (
          rendered +
          `<li class="partner-contact-summary-contact-meta text-muted">Ещё ${formatPartnerContactCount(remainder)}</li>`
        );
      }
      return rendered;
    }
    return '<li class="partner-contact-summary-empty">Контактные данные не указаны</li>';
  }

  function renderPartnerContactCard(item, options = {}) {
    if (!item) return '';
    const mode = options.mode === 'editor' ? 'editor' : 'summary';
    const isDraft = Boolean(item.isDraft);
    const isDeleted = Boolean(item.is_deleted);
    const disabled = !isDraft && isDeleted;
    const idValue = item && item.id != null ? String(item.id) : '';
    const cardClasses = ['card', 'shadow-sm', 'partner-contact-card', 'h-100'];
    if (mode === 'summary') {
      cardClasses.push('partner-contact-card--summary');
    }
    if (isDeleted) {
      cardClasses.push('border-danger', 'opacity-75');
    }
    let datasetAttrs;
    if (isDraft) {
      const draftId = typeof item.draftId === 'string' ? item.draftId : '';
      const attrs = ['data-partner-contact-card="true"', 'data-partner-contact-draft="true"'];
      if (draftId) {
        attrs.push(`data-partner-contact-draft-id="${escapeHtml(draftId)}"`);
      }
      datasetAttrs = attrs.join(' ');
    } else {
      const attrs = ['data-partner-contact-card="true"', 'data-partner-contact-draft="false"', 'data-param-type="partner_contact"'];
      if (idValue) {
        attrs.push(`data-partner-contact-id="${escapeHtml(idValue)}"`, `data-param-id="${escapeHtml(idValue)}"`);
      }
      if (isDeleted) {
        attrs.push('data-partner-contact-deleted="true"');
      }
      datasetAttrs = attrs.join(' ');
    }
    const typeLabel = PARTNER_CONTACT_TYPES[item.contact_type] || PARTNER_CONTACT_TYPES.partner;
    const stateValue = typeof item.state === 'string' ? item.state : PARAMETER_STATES[0];
    const titleValue = typeof item.value === 'string' ? item.value.trim() : '';
    const displayName = getPartnerContactDisplayName(item);
    const servedSummaryText = getPartnerContactServedSummaryText(item);
    const innValue = typeof item.inn === 'string' ? item.inn.trim() : '';

    if (mode === 'summary') {
      const contactsSummary = buildPartnerContactSummaryContacts(item);
      const ariaLabel = displayName
        ? `Открыть карточку контакта «${displayName}»`
        : 'Открыть карточку контакта';
      const idBadge = !isDraft && idValue ? `<span class="badge bg-secondary">ID: ${escapeHtml(idValue)}</span>` : '';
      const draftBadge = isDraft ? '<span class="badge bg-success">Черновик</span>' : '';
      const deletedBadge = isDeleted ? '<span class="badge text-bg-warning">Удалено</span>' : '';
      return `
        <div class="col">
          <div class="${cardClasses.join(' ')}" ${datasetAttrs} data-partner-contact-open-modal role="button" tabindex="0" aria-label="${escapeHtml(ariaLabel)}">
            <div class="card-body">
              <div class="partner-contact-summary-head">
                <div>
                  <div class="partner-contact-summary-title" data-partner-contact-title>${escapeHtml((displayName || titleValue || '').trim() || 'Без названия')}</div>
                  <div class="partner-contact-summary-meta" data-partner-contact-subtitle>${escapeHtml(typeLabel)} • ${escapeHtml(stateValue)}</div>
                </div>
                <div class="d-flex flex-column align-items-end gap-1">
                  ${draftBadge}
                  ${idBadge}
                  ${deletedBadge}
                </div>
              </div>
              <div>
                <div class="partner-contact-summary-label small text-muted text-uppercase">Юридическое лицо</div>
                <div class="partner-contact-summary-value">${escapeHtml(titleValue || '—')}</div>
              </div>
              <div>
                <div class="partner-contact-summary-label small text-muted text-uppercase">ИНН</div>
                <div class="partner-contact-summary-value">${escapeHtml(innValue || '—')}</div>
              </div>
              <div>
                <div class="partner-contact-summary-label small text-muted text-uppercase">Контакты</div>
                <ul class="partner-contact-summary-list mb-0">
                  ${contactsSummary}
                </ul>
              </div>
              ${servedSummaryText ? `
              <div>
                <div class="partner-contact-summary-label small text-muted text-uppercase">Обслуживает</div>
                <div class="partner-contact-summary-value">${escapeHtml(servedSummaryText)}</div>
              </div>` : ''}
              <div class="mt-auto text-end">
                <span class="text-primary small d-inline-flex align-items-center gap-1">
                  Подробнее
                  <i class="bi bi-arrow-right-short fs-5 mb-0"></i>
                </span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    const typeSelect = buildPartnerContactTypeSelect(item.contact_type, disabled);
    const stateControl = buildPartnerContactStateControl(item, disabled);
    const servedSelect = buildPartnerContactServedSelect(item, disabled);
    const contactsSection = buildPartnerContactPeople(item.contacts, disabled);
    const primaryLabel = isDraft ? 'Создать' : 'Сохранить';
    const primaryClass = isDraft ? 'btn-success' : 'btn-primary';
    const primaryDisabled = disabled ? ' disabled' : '';
    const actionButtons = [`<button class="btn ${primaryClass} btn-sm" type="button" data-partner-contact-action="save"${primaryDisabled}>${primaryLabel}</button>`];
    if (isDraft) {
      actionButtons.push(
        '<button class="btn btn-outline-secondary btn-sm" type="button" data-partner-contact-action="cancel">Отмена</button>'
      );
    } else if (isDeleted) {
      actionButtons.push(
        '<button class="btn btn-outline-success btn-sm" type="button" data-partner-contact-action="restore">Восстановить</button>'
      );
    } else {
      actionButtons.push(
        '<button class="btn btn-outline-secondary btn-sm" type="button" data-partner-contact-action="reset">Отменить изменения</button>'
      );
      actionButtons.push(
        '<button class="btn btn-outline-danger btn-sm" type="button" data-partner-contact-action="delete">Удалить</button>'
      );
    }
    const idBadge = !isDraft && idValue ? `<span class="badge bg-secondary ms-auto">ID: ${escapeHtml(idValue)}</span>` : '';
    const addPersonBtn = disabled
      ? ''
      : '<button class="btn btn-outline-success btn-sm" type="button" data-partner-contact-add-person>+ Контакт</button>';
    const servedWrapperClass = item.contact_type === 'ka' ? '' : ' d-none';
    const internalNameValue = typeof item.internal_name === 'string' ? item.internal_name : '';
    const baseKey =
      getPartnerContactItemKey(item) ||
      (isDraft && item.draftId
        ? `draft:${item.draftId}`
        : Number.isFinite(item.id)
        ? `item:${item.id}`
        : null);
    if (baseKey && !partnerContactDetailsState.has(baseKey)) {
      partnerContactDetailsState.set(baseKey, 'expanded');
    }
    const isDetailsCollapsed = baseKey ? partnerContactDetailsState.get(baseKey) === 'collapsed' : false;
    const detailsClasses = ['partner-contact-details', isDetailsCollapsed ? 'is-collapsed' : 'is-expanded'];
    const detailsAria = isDetailsCollapsed ? 'false' : 'true';
    const deletedHint = isDeleted
      ? '<div class="alert alert-warning small mt-3 mb-0">Контакт помечен как удалённый. Восстановите запись, чтобы редактировать её.</div>'
      : '';
    const headerStateClass = PARTNER_CONTACT_STATE_CLASS_MAP[stateValue] || '';
    const cardDatasetAttrs = baseKey
      ? `${datasetAttrs} data-partner-contact-key="${escapeHtml(baseKey)}"`
      : datasetAttrs;
    const actionsAttributes = ['data-partner-contact-actions'];
    if (baseKey) {
      actionsAttributes.push(`data-partner-contact-actions-owner="${escapeHtml(baseKey)}"`);
    }
    const actionsAttrString = actionsAttributes.join(' ');
    return `
      <div class="col">
        <div class="${cardClasses.join(' ')}" ${cardDatasetAttrs}>
          <div class="card-header d-flex justify-content-between align-items-start gap-2 ${headerStateClass}" data-partner-contact-card-header>
            <div>
              <div class="fw-semibold partner-contact-card__title" data-partner-contact-title>${escapeHtml((displayName || titleValue || '').trim() || 'Без названия')}</div>
              <div class="small partner-contact-card__subtitle" data-partner-contact-subtitle>${escapeHtml(typeLabel)} • ${escapeHtml(stateValue)}</div>
            </div>
            <div class="d-flex align-items-start gap-2">
              ${idBadge}
              <button class="btn btn-outline-primary btn-sm" type="button" data-partner-contact-open-modal title="Открыть в модальном окне">
                <i class="bi bi-arrows-fullscreen"></i>
              </button>
            </div>
          </div>
          <div class="card-body d-flex flex-column gap-3">
            <div class="row g-3 align-items-end">
              <div class="col-12 col-lg-4 col-xl-3">
                <label class="form-label">Тип</label>
                ${typeSelect}
              </div>
              <div class="col-12 col-lg-4 col-xl-3">
                <label class="form-label">Статус</label>
                ${stateControl}
              </div>
              <div class="col-12 col-lg-4 col-xl-6">
                <label class="form-label">Внутреннее название</label>
                <input type="text" class="form-control" data-partner-contact-field="internal_name" value="${escapeHtml((internalNameValue || '').trim())}" placeholder="Например, Ключевой партнёр"${disabled ? ' disabled' : ''}>
                <div class="form-text">Отображается в панели и отчётах.</div>
              </div>
            </div>
            <div>
              <div class="row g-3">
                <div class="col-sm-6">
                  <label class="form-label">ЮЛ</label>
                  <input type="text" class="form-control" data-partner-contact-field="value" value="${escapeHtml(item.value || '')}" placeholder="Например, ООО «Партнёр»"${disabled ? ' disabled' : ''}>
                  <div class="form-text">Название юридического лица контакта.</div>
                </div>
                <div class="col-sm-6">
                  <label class="form-label">ИНН</label>
                  <input type="text" class="form-control" data-partner-contact-field="inn" value="${escapeHtml(innValue)}" placeholder="12 цифр" inputmode="numeric"${disabled ? ' disabled' : ''}>
                  <div class="form-text">Укажите ИНН юридического лица.</div>
                </div>
              </div>
            </div>
            <div class="${servedWrapperClass}" data-partner-contact-served-wrapper>
              <label class="form-label mb-1">Какое ЮЛ обслуживает</label>
              ${servedSelect}
              <div class="form-text">Можно выбрать несколько ЮЛ.</div>
              <div class="partner-contact-served-summary" data-partner-contact-served-summary>${escapeHtml(servedSummaryText)}</div>
            </div>
            <div class="${detailsClasses.join(' ')}" data-partner-contact-details${baseKey ? ` data-details-key="${escapeHtml(baseKey)}"` : ''}>
              <div class="partner-contact-details__header">
                <button class="partner-contact-details__toggle" type="button" data-partner-contact-details-toggle aria-expanded="${detailsAria}">
                  <span class="partner-contact-details__title">Контакты и должности</span>
                  <i class="bi bi-chevron-down partner-contact-details__chevron"></i>
                </button>
              </div>
              <div class="partner-contact-details__body">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
                  <label class="form-label mb-0">Контакты</label>
                  ${addPersonBtn}
                </div>
                <div data-partner-contact-people>${contactsSection}</div>
              </div>
            </div>
            <div class="d-flex flex-wrap gap-2 align-items-center" ${actionsAttrString}>
              ${actionButtons.join('\n')}
            </div>
            ${deletedHint}
          </div>
        </div>
      </div>
    `;
  }

  function getPartnerContactScopeKey(item) {
    const type = item && typeof item.contact_type === 'string' ? item.contact_type : '';
    const normalizedType = type === 'ka' ? 'partner' : type;
    if (normalizedType && partnerContactSections.has(normalizedType)) {
      return normalizedType;
    }
    if (partnerContactSections.has('partner')) {
      return 'partner';
    }
    const iterator = partnerContactSections.keys();
    const first = iterator.next();
    return first && !first.done ? first.value : null;
  }

  function renderPartnerContacts() {
    if (!partnerContactSections.size) return;
    const items = getPartnerContactRenderItems();
    const activeKeys = new Set();
    items.forEach((item) => {
      const key = getPartnerContactItemKey(item);
      if (key) {
        activeKeys.add(key);
        if (!partnerContactDetailsState.has(key)) {
          partnerContactDetailsState.set(key, 'expanded');
        }
      }
    });
    Array.from(partnerContactDetailsState.keys()).forEach((key) => {
      if (!activeKeys.has(key)) {
        partnerContactDetailsState.delete(key);
      }
    });
    const grouped = new Map();
    items.forEach((item) => {
      const scope = getPartnerContactScopeKey(item);
      if (!scope) return;
      if (!grouped.has(scope)) {
        grouped.set(scope, []);
      }
      grouped.get(scope).push(item);
    });
    partnerContactSections.forEach(({ container, emptyPlaceholder }, scope) => {
      if (!container) return;
      const scopedItems = grouped.get(scope) || [];
      if (!scopedItems.length) {
        container.innerHTML = '';
        if (emptyPlaceholder) {
          emptyPlaceholder.classList.remove('d-none');
        }
        return;
      }
      container.innerHTML = scopedItems
        .map((item) => renderPartnerContactCard(item, { mode: 'summary' }))
        .join('');
      container
        .querySelectorAll('[data-partner-contact-comm-field="value"][data-comm-type="phone"]')
        .forEach((input) => updatePhoneInputFormatting(input));
      container
        .querySelectorAll('[data-partner-contact-comm-field="value"][data-comm-type="email"]')
        .forEach((input) => validateEmailInput(input));
      container
        .querySelectorAll('[data-partner-contact-person-field="phone"]')
        .forEach((input) => updatePhoneInputFormatting(input));
      container
        .querySelectorAll('[data-partner-contact-person-field="email"]')
        .forEach((input) => validateEmailInput(input));
      if (emptyPlaceholder) {
        emptyPlaceholder.classList.add('d-none');
      }
    });
    if (partnerContactEditorState && partnerContactEditorState.key) {
      const key = partnerContactEditorState.key;
      setPartnerContactCardVisibility(key, false);
      const rendered = renderPartnerContactModalContentByKey(key);
      if (!rendered && partnerContactEditorModal) {
        partnerContactEditorModal.hide();
      } else {
        updatePartnerContactEditorTitleByKey(key);
      }
    }
  }

  function addPartnerContactDraft(initial = {}) {
    partnerContactDraftCounter += 1;
    const servedEntities = Array.isArray(initial.served_legal_entities) && initial.served_legal_entities.length
      ? clonePartnerContactServedEntities(initial.served_legal_entities)
      : [];
    let servedId = Number.isFinite(initial.served_legal_entity_id)
      ? initial.served_legal_entity_id
      : Number.parseInt(initial.served_legal_entity_id, 10);
    servedId = Number.isFinite(servedId) && servedId > 0 ? servedId : null;
    let servedName = typeof initial.served_legal_entity_name === 'string' ? initial.served_legal_entity_name : '';
    if (!servedEntities.length && Number.isFinite(servedId)) {
      servedEntities.push({ id: servedId, name: servedName });
    }
    if (servedEntities.length) {
      const first = servedEntities[0];
      if (first) {
        if (!Number.isFinite(servedId) || servedId <= 0) {
          servedId = Number.isFinite(first.id) ? first.id : servedId;
        }
        if (!servedName && first && typeof first.name === 'string') {
          servedName = first.name;
        }
      }
    }
    const draft = {
      draftId: `draft-${partnerContactDraftCounter}`,
      isDraft: true,
      value: typeof initial.value === 'string' ? initial.value : '',
      state: PARAMETER_STATES[0],
      contact_type: initial.contact_type && Object.prototype.hasOwnProperty.call(PARTNER_CONTACT_TYPES, initial.contact_type)
        ? initial.contact_type
        : 'partner',
      phones: Array.isArray(initial.phones) && initial.phones.length
        ? clonePartnerContactCommList(initial.phones)
        : [],
      emails: Array.isArray(initial.emails) && initial.emails.length
        ? clonePartnerContactCommList(initial.emails)
        : [],
      contacts: Array.isArray(initial.contacts) && initial.contacts.length
        ? clonePartnerContactPeople(initial.contacts)
        : [createBlankPartnerContactPersonEntry()],
      served_legal_entities: servedEntities,
      served_legal_entity_id: Number.isFinite(servedId) ? servedId : null,
      served_legal_entity_name: typeof servedName === 'string' ? servedName : '',
      legal_entity: typeof initial.legal_entity === 'string' ? initial.legal_entity : '',
      internal_name: typeof initial.internal_name === 'string' ? initial.internal_name : '',
      inn: typeof initial.inn === 'string' ? extractDigits(initial.inn) || initial.inn : '',
      is_deleted: false,
      usage_count: 0,
    };
    partnerContactDrafts.push(draft);
    renderPartnerContacts();
    const key = getPartnerContactItemKey(draft);
    if (partnerContactEditorModal && key) {
      setTimeout(() => {
        const card = findPartnerContactCardByKey(key);
        if (card) {
          openPartnerContactEditor(card);
        }
      }, 0);
    }
  }

  function removePartnerContactDraft(draftId) {
    const index = partnerContactDrafts.findIndex((draft) => draft.draftId === draftId);
    if (index === -1) return;
    const [removed] = partnerContactDrafts.splice(index, 1);
    if (removed) {
      const key = getPartnerContactItemKey(removed);
      if (key) {
        partnerContactDetailsState.delete(key);
      }
    }
    renderPartnerContacts();
  }

  function updatePartnerContactDraftValue(draftId, field, value) {
    const draft = partnerContactDrafts.find((item) => item.draftId === draftId);
    if (!draft) return;
    if (field === 'value') {
      draft.value = value;
      draft.legal_entity = value;
    } else if (field === 'internal_name') {
      draft.internal_name = value;
    } else if (field === 'inn') {
      const digits = extractDigits(value);
      draft.inn = digits || (typeof value === 'string' ? value.trim() : '');
    } else if (field === 'state') {
      draft.state = PARAMETER_STATES.includes(value) ? value : draft.state;
    } else if (field === 'contact_type') {
      draft.contact_type = Object.prototype.hasOwnProperty.call(PARTNER_CONTACT_TYPES, value) ? value : 'partner';
      if (draft.contact_type !== 'ka') {
        draft.served_legal_entity_id = null;
        draft.served_legal_entity_name = '';
        draft.served_legal_entities = [];
      }
    } else if (field === 'served_legal_entities') {
      const list = Array.isArray(value) ? value : [];
      const normalized = clonePartnerContactServedEntities(list);
      draft.served_legal_entities = normalized;
      const first = normalized[0];
      draft.served_legal_entity_id = first ? first.id : null;
      draft.served_legal_entity_name = first ? first.name : '';
    } else if (field === 'served_legal_entity_id') {
      draft.served_legal_entity_id = value;
    } else if (field === 'served_legal_entity_name') {
      draft.served_legal_entity_name = value;
    }
  }

  function updatePartnerContactDraftComm(draftId, kind, entryKey, field, value) {
    const draft = partnerContactDrafts.find((item) => item.draftId === draftId);
    if (!draft) return;
    const list = kind === 'phone' ? draft.phones : draft.emails;
    if (!Array.isArray(list)) return;
    const entry = list.find((item) => item.key === entryKey);
    if (!entry) return;
    if (field === 'type') {
      const allowed = kind === 'phone' ? PARTNER_CONTACT_PHONE_TYPES : PARTNER_CONTACT_EMAIL_TYPES;
      entry.type = Object.prototype.hasOwnProperty.call(allowed, value) ? value : entry.type;
    } else if (field === 'value') {
      entry.value = kind === 'phone' ? extractDigits(value) : value;
    } else if (field === 'extension' && kind === 'phone') {
      entry.extension = extractDigits(value);
    }
  }

  function modifyPartnerContactDraftComm(draftId, kind, action, entryKey) {
    const draft = partnerContactDrafts.find((item) => item.draftId === draftId);
    if (!draft) return;
    const list = kind === 'phone' ? draft.phones : draft.emails;
    if (!Array.isArray(list)) return;
    if (action === 'add') {
      list.push(createBlankPartnerContactCommEntry(kind));
    } else if (action === 'remove') {
      const index = list.findIndex((item) => item.key === entryKey);
      if (index !== -1) {
        list.splice(index, 1);
      }
    }
  }

  function updatePartnerContactEditField(id, field, value) {
    const edit = ensurePartnerContactEdit(id);
    if (!edit) return;
    if (field === 'value') {
      edit.value = value;
      edit.legal_entity = value;
    } else if (field === 'internal_name') {
      edit.internal_name = value;
    } else if (field === 'inn') {
      const digits = extractDigits(value);
      edit.inn = digits || (typeof value === 'string' ? value.trim() : '');
    } else if (field === 'state') {
      edit.state = PARAMETER_STATES.includes(value) ? value : edit.state;
    } else if (field === 'contact_type') {
      edit.contact_type = Object.prototype.hasOwnProperty.call(PARTNER_CONTACT_TYPES, value) ? value : edit.contact_type;
      if (edit.contact_type !== 'ka') {
        edit.served_legal_entity_id = null;
        edit.served_legal_entity_name = '';
        edit.served_legal_entities = [];
      }
    } else if (field === 'served_legal_entities') {
      const list = Array.isArray(value) ? value : [];
      const normalized = clonePartnerContactServedEntities(list);
      edit.served_legal_entities = normalized;
      const first = normalized[0];
      edit.served_legal_entity_id = first ? first.id : null;
      edit.served_legal_entity_name = first ? first.name : '';
    } else if (field === 'served_legal_entity_id') {
      edit.served_legal_entity_id = value;
    } else if (field === 'served_legal_entity_name') {
      edit.served_legal_entity_name = value;
    }
  }

  function updatePartnerContactEditComm(id, kind, entryKey, field, value) {
    const edit = ensurePartnerContactEdit(id);
    if (!edit) return;
    const list = kind === 'phone' ? edit.phones : edit.emails;
    if (!Array.isArray(list)) return;
    const entry = list.find((item) => item.key === entryKey);
    if (!entry) return;
    if (field === 'type') {
      const allowed = kind === 'phone' ? PARTNER_CONTACT_PHONE_TYPES : PARTNER_CONTACT_EMAIL_TYPES;
      entry.type = Object.prototype.hasOwnProperty.call(allowed, value) ? value : entry.type;
    } else if (field === 'value') {
      entry.value = kind === 'phone' ? extractDigits(value) : value;
    } else if (field === 'extension' && kind === 'phone') {
      entry.extension = extractDigits(value);
    }
  }

  function modifyPartnerContactEditComm(id, kind, action, entryKey) {
    const edit = ensurePartnerContactEdit(id);
    if (!edit) return;
    const list = kind === 'phone' ? edit.phones : edit.emails;
    if (!Array.isArray(list)) return;
    if (action === 'add') {
      list.push(createBlankPartnerContactCommEntry(kind));
    } else if (action === 'remove') {
      const index = list.findIndex((item) => item.key === entryKey);
      if (index !== -1) {
        list.splice(index, 1);
      }
    }
  }

  function updatePartnerContactDraftPerson(draftId, personKey, field, value) {
    const draft = partnerContactDrafts.find((item) => item.draftId === draftId);
    if (!draft || !Array.isArray(draft.contacts)) return;
    const person = draft.contacts.find((entry) => entry.key === personKey);
    if (!person) return;
    if (field === 'full_name' || field === 'position') {
      person[field] = value;
    } else if (field === 'phone') {
      person.phone = value;
    } else if (field === 'email') {
      person.email = value;
    } else if (field === 'is_top') {
      person.is_top = Boolean(value);
    }
  }

  function updatePartnerContactEditPerson(id, personKey, field, value) {
    const edit = ensurePartnerContactEdit(id);
    if (!edit || !Array.isArray(edit.contacts)) return;
    const person = edit.contacts.find((entry) => entry.key === personKey);
    if (!person) return;
    if (field === 'full_name' || field === 'position') {
      person[field] = value;
    } else if (field === 'phone') {
      person.phone = value;
    } else if (field === 'email') {
      person.email = value;
    } else if (field === 'is_top') {
      person.is_top = Boolean(value);
    }
  }

  function modifyPartnerContactDraftPerson(draftId, action, personKey) {
    const draft = partnerContactDrafts.find((item) => item.draftId === draftId);
    if (!draft) return;
    if (!Array.isArray(draft.contacts)) {
      draft.contacts = [];
    }
    if (action === 'add') {
      draft.contacts.unshift(createBlankPartnerContactPersonEntry());
    } else if (action === 'remove') {
      const index = draft.contacts.findIndex((entry) => entry.key === personKey);
      if (index !== -1) {
        draft.contacts.splice(index, 1);
      }
    }
  }

  function modifyPartnerContactEditPerson(id, action, personKey) {
    const edit = ensurePartnerContactEdit(id);
    if (!edit) return;
    if (!Array.isArray(edit.contacts)) {
      edit.contacts = [];
    }
    if (action === 'add') {
      edit.contacts.unshift(createBlankPartnerContactPersonEntry());
    } else if (action === 'remove') {
      const index = edit.contacts.findIndex((entry) => entry.key === personKey);
      if (index !== -1) {
        edit.contacts.splice(index, 1);
      }
    }
  }

  function resetPartnerContactEdit(id) {
    if (!Number.isFinite(id)) return;
    if (!partnerContactEdits.has(id)) return;
    partnerContactEdits.delete(id);
    renderPartnerContacts();
  }

  function getPartnerContactCardData(card) {
    if (!card || !card.dataset.partnerContactCard) return null;
    if (card.dataset.partnerContactDraft === 'true') {
      const draftId = card.dataset.partnerContactDraftId;
      const draft = partnerContactDrafts.find((item) => item.draftId === draftId);
      return draft ? clonePartnerContactItem(draft) : null;
    }
    const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
    if (!Number.isFinite(id)) return null;
    const edit = ensurePartnerContactEdit(id);
    return edit ? clonePartnerContactItem(edit) : null;
  }

  function sanitizePartnerContactPayload(data) {
    const result = { contact_type: data.contact_type };
    result.value = typeof data.value === 'string' ? data.value.trim() : '';
    result.state = typeof data.state === 'string' ? data.state : PARAMETER_STATES[0];
    result.inn = extractDigits(data.inn) || (typeof data.inn === 'string' ? data.inn.trim() : '');
    const fallbackPhoneType = Object.keys(PARTNER_CONTACT_PHONE_TYPES)[0] || 'work';
    result.phones = Array.isArray(data.phones)
      ? data.phones
          .map((item) => {
            const valueDigits = extractDigits(item && item.value);
            const extensionDigits = extractDigits(item && item.extension);
            const typeKey = item && item.type;
            const type = Object.prototype.hasOwnProperty.call(PARTNER_CONTACT_PHONE_TYPES, typeKey)
              ? typeKey
              : fallbackPhoneType;
            return {
              type,
              value: valueDigits,
              extension: extensionDigits,
            };
          })
          .filter((item) => item.value)
      : [];
    const fallbackEmailType = Object.keys(PARTNER_CONTACT_EMAIL_TYPES)[0] || 'work';
    result.emails = Array.isArray(data.emails)
      ? data.emails
          .map((item) => {
            const typeKey = item && item.type;
            const type = Object.prototype.hasOwnProperty.call(PARTNER_CONTACT_EMAIL_TYPES, typeKey)
              ? typeKey
              : fallbackEmailType;
            return {
              type,
              value: typeof item.value === 'string' ? item.value.trim() : '',
            };
          })
          .filter((item) => item.value)
      : [];
    result.contacts = Array.isArray(data.contacts)
      ? data.contacts
          .map((person) => ({
            full_name: typeof person.full_name === 'string' ? person.full_name.trim() : '',
            position: typeof person.position === 'string' ? person.position.trim() : '',
            phone: typeof person.phone === 'string' ? person.phone.trim() : '',
            email: typeof person.email === 'string' ? person.email.trim() : '',
            is_top: Boolean(person.is_top),
          }))
          .filter((person) => person.full_name || person.position || person.phone || person.email)
      : [];
    if (!result.phones.length && Array.isArray(result.contacts)) {
      result.contacts.forEach((person) => {
        const digits = extractDigits(person.phone);
        if (digits) {
          result.phones.push({ type: fallbackPhoneType, value: digits, extension: '' });
        }
      });
    }
    if (!result.emails.length && Array.isArray(result.contacts)) {
      result.contacts.forEach((person) => {
        if (person.email) {
          result.emails.push({ type: fallbackEmailType, value: person.email });
        }
      });
    }
    result.internal_name = typeof data.internal_name === 'string' ? data.internal_name.trim() : '';
    const servedEntities = Array.isArray(data.served_legal_entities)
      ? data.served_legal_entities
          .map((entry) => {
            if (!entry || typeof entry !== 'object') return null;
            const id = Number.isFinite(entry.id) ? entry.id : Number.parseInt(entry.id, 10);
            if (!Number.isFinite(id) || id <= 0) return null;
            const name = typeof entry.name === 'string' ? entry.name.trim() : '';
            return { id, name };
          })
          .filter((entry) => entry)
      : [];
    result.served_legal_entities = servedEntities;
    result.served_legal_entity_ids = servedEntities.map((entry) => entry.id);
    result.served_legal_entity_names = servedEntities.map((entry) => entry.name).filter((name) => name);
    const explicitServedId = Number.isFinite(data.served_legal_entity_id)
      ? data.served_legal_entity_id
      : Number.parseInt(data.served_legal_entity_id, 10);
    const fallbackServed = servedEntities[0];
    const normalizedServedId = Number.isFinite(explicitServedId) && explicitServedId > 0
      ? explicitServedId
      : fallbackServed
        ? fallbackServed.id
        : null;
    const explicitServedName = typeof data.served_legal_entity_name === 'string' ? data.served_legal_entity_name : '';
    const normalizedServedName = fallbackServed ? fallbackServed.name : explicitServedName;
    result.served_legal_entity_id = Number.isFinite(normalizedServedId) ? normalizedServedId : null;
    result.served_legal_entity_name = normalizedServedName || '';
    return result;
  }

  async function handlePartnerContactSave(card, trigger) {
    const isDraft = card && card.dataset.partnerContactDraft === 'true';
    const data = getPartnerContactCardData(card);
    if (!data) {
      alert('Не удалось получить данные контакта');
      return;
    }
    const payload = sanitizePartnerContactPayload(data);
    if (!payload.value) {
      alert('Поле «ЮЛ» не может быть пустым');
      return;
    }
    const servedIds = Array.isArray(payload.served_legal_entity_ids) ? payload.served_legal_entity_ids : [];
    if (payload.contact_type === 'ka' && !servedIds.length) {
      alert('Для типа «КА» необходимо выбрать одно или несколько обслуживаемых ЮЛ');
      return;
    }
    const invalidEmail = Array.isArray(payload.emails)
      ? payload.emails.find((item) => item && item.value && !EMAIL_VALIDATION_REGEX.test(item.value))
      : null;
    if (invalidEmail) {
      alert('Проверьте e-mail: необходимо указать символ @ и доменное имя.');
      return;
    }

    const originalText = trigger.textContent;
    trigger.disabled = true;
    trigger.textContent = '...';

    try {
      let response;
      if (isDraft) {
        const requestPayload = Object.assign({
          param_type: 'partner_contact',
          value: payload.value,
          state: payload.state,
        }, payload);
        response = await fetch('/api/settings/parameters', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestPayload),
        });
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (!Number.isFinite(id)) {
          throw new Error('Не удалось определить идентификатор контакта');
        }
        const requestPayload = {
          value: payload.value,
          contact_type: payload.contact_type,
          phones: payload.phones,
          emails: payload.emails,
          contacts: payload.contacts,
          internal_name: payload.internal_name,
          inn: payload.inn,
          served_legal_entities: payload.served_legal_entities,
          served_legal_entity_ids: payload.served_legal_entity_ids,
          served_legal_entity_names: payload.served_legal_entity_names,
          served_legal_entity_id: payload.served_legal_entity_id,
          served_legal_entity_name: payload.served_legal_entity_name,
          state: payload.state,
        };
        response = await fetch(`/api/settings/parameters/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestPayload),
        });
      }
      const result = await response.json();
      if (!response.ok || result.success === false) {
        throw new Error(result.error || 'Ошибка сохранения контакта');
      }
      if (isDraft) {
        const draftId = card.dataset.partnerContactDraftId;
        if (draftId) {
          const index = partnerContactDrafts.findIndex((item) => item.draftId === draftId);
          if (index !== -1) {
            partnerContactDrafts.splice(index, 1);
          }
        }
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          partnerContactEdits.delete(id);
        }
      }
      syncParameterData((result && result.data) || parameterData);
      renderParameters({ forceBodies: true });
      if (partnerContactEditorModal && partnerContactEditorModalEl && partnerContactEditorModalEl.contains(card)) {
        partnerContactEditorModal.hide();
      }
    } catch (error) {
      const message = error && error.message ? error.message : error;
      alert('❌ ' + message);
    } finally {
      trigger.disabled = false;
      trigger.textContent = originalText;
    }
  }

  function renderParameterCard(type, { forceBody = false } = {}) {
    const card = document.querySelector(`.parameter-card[data-param-type="${type}"]`);
    if (!card) return;
    const items = Array.isArray(parameterData[type]) ? parameterData[type] : [];
    const counter = card.querySelector('[data-param-count]');
    if (counter) {
      counter.textContent = items.length;
    }
    const hasMany = items.length > 10;
    card.dataset.hasMany = hasMany ? 'true' : 'false';
    const hint = card.querySelector('[data-param-hint]');
    if (hint) {
      hint.classList.toggle('d-none', !hasMany);
    }
    const body = card.querySelector('[data-param-body]');
    if (!body) return;
    if (hasMany) {
      card.classList.remove('is-expanded');
      body.classList.add('d-none');
      body.innerHTML = '';
      return;
    }
    if (!card.classList.contains('is-expanded')) {
      body.classList.add('d-none');
      body.innerHTML = '';
      return;
    }
    body.classList.remove('d-none');
    if (forceBody || !body.innerHTML.trim()) {
      body.innerHTML = buildParameterContent(type, items, 'card');
    }
  }

  function renderParameters({ forceBodies = false } = {}) {
    Object.keys(PARAMETER_TITLES).forEach((type) => {
      renderParameterCard(type, { forceBody: forceBodies });
    });
    renderRemoteAccessSection();
    renderPartnerContacts();
    renderLegalEntities();
  }

  function buildCityModalContent() {
    if (!CITY_OPTIONS.length) {
      return '<div class="empty-placeholder">Пока нет значений</div>';
    }
    const items = CITY_OPTIONS.map((city) => `<li class="list-group-item py-1 px-2">${escapeHtml(city)}</li>`).join('');
    return `
      <div data-param-container data-param-type="${CITY_PARAMETER_TYPE}">
        <div class="param-items">
          <ul class="list-group list-group-flush">${items}</ul>
        </div>
      </div>
    `;
  }

  function renderParameterModal(type) {
    if (!parameterModalEl) return;
    const body = parameterModalEl.querySelector('[data-param-modal-body]');
    if (!body) return;
    if (type === CITY_PARAMETER_TYPE) {
      body.innerHTML = buildCityModalContent();
      return;
    }
    const items = Array.isArray(parameterData[type]) ? parameterData[type] : [];
    body.innerHTML = buildParameterContent(type, items, 'modal');
  }

  function renderCityCard() {
    if (!cityCardEl) return;
    const count = Array.isArray(CITY_OPTIONS) ? CITY_OPTIONS.length : 0;
    cityCardEl.dataset.cityCount = String(count);
    const body = cityCardEl.querySelector('[data-city-body]');
    const hint = cityCardEl.querySelector('[data-city-hint]');
    const counter = cityCardEl.querySelector('.badge');
    if (counter) {
      counter.textContent = String(count);
    }
    const listContainer = cityCardEl.querySelector('[data-city-list]');
    if (listContainer) {
      if (count) {
        const items = CITY_OPTIONS.map((city) => `<li class="list-group-item py-1 px-2">${escapeHtml(city)}</li>`).join('');
        listContainer.innerHTML = `<ul class="list-group list-group-flush">${items}</ul>`;
      } else {
        listContainer.innerHTML = '<div class="empty-placeholder">Пока нет значений</div>';
      }
    }
    if (body) {
      body.classList.toggle('d-none', count > 10);
    }
    if (hint) {
      hint.classList.toggle('d-none', !(count > 10));
    }
  }

  function openParameterModal(type) {
    if (!parameterModal) return;
    parameterModalType = type;
    const titleEl = parameterModalEl.querySelector('[data-param-modal-title]');
    if (titleEl) {
      const label =
        PARAMETER_TITLES[type] || (type === CITY_PARAMETER_TYPE ? CITY_PARAMETER_LABEL : 'Значения параметра');
      titleEl.textContent = `Параметры партнёров • ${label}`;
    }
    renderParameterModal(type);
    parameterModal.show();
  }

  renderParameters();

  if (parameterModalEl) {
    parameterModalEl.addEventListener('hidden.bs.modal', () => {
      parameterModalType = null;
    });
  }

  if (legalEntitiesModalEl) {
    legalEntitiesModalEl.addEventListener('show.bs.modal', () => {
      renderLegalEntities();
    });
    legalEntitiesModalEl.addEventListener('hidden.bs.modal', () => {
      legalEntityDrafts = [];
      legalEntityDraftCounter = 0;
      renderLegalEntities();
    });
  }

  if (parametersModalEl) {
    parametersModalEl.addEventListener('show.bs.modal', () => {
      renderPartnerContacts();
    });
    parametersModalEl.addEventListener('hidden.bs.modal', () => {
      partnerContactDrafts = [];
      partnerContactDraftCounter = 0;
      partnerContactEdits.clear();
      partnerContactDetailsState.clear();
      renderPartnerContacts();
    });
  }

  if (partnerContactEditorModalEl) {
    partnerContactEditorModalEl.addEventListener('hidden.bs.modal', () => {
      if (partnerContactEditorState && partnerContactEditorState.key) {
        const key = partnerContactEditorState.key;
        if (key.startsWith('draft:')) {
          const draftId = key.slice('draft:'.length);
          const exists = partnerContactDrafts.some((draft) => draft.draftId === draftId);
          if (exists) {
            removePartnerContactDraft(draftId);
          }
        } else {
          setPartnerContactCardVisibility(key, true);
        }
      }
      if (partnerContactEditorBody) {
        partnerContactEditorBody.innerHTML =
          '<div class="text-center text-muted py-5">Выберите контакт из списка для редактирования.</div>';
      }
      clearPartnerContactEditorActions();
      partnerContactEditorState = null;
      renderPartnerContacts();
    });
  }

  function findParameterContainer(element) {
    return element ? element.closest('[data-param-container]') : null;
  }

  document.addEventListener('click', (event) => {
    const partnerContactOpenModalBtn = event.target.closest('[data-partner-contact-open-modal]');
    if (partnerContactOpenModalBtn) {
      const card = partnerContactOpenModalBtn.closest('[data-partner-contact-card]');
      if (!card) return;
      openPartnerContactEditor(card);
      event.preventDefault();
      return;
    }
    const detailsToggleBtn = event.target.closest('[data-partner-contact-details-toggle]');
    if (detailsToggleBtn) {
      const container = detailsToggleBtn.closest('[data-partner-contact-details]');
      if (!container) return;
      let key = container.dataset.detailsKey;
      if (!key) {
        const card = container.closest('[data-partner-contact-card]');
        key = getPartnerContactCardKey(card);
      }
      const isCollapsed = container.classList.contains('is-collapsed');
      if (isCollapsed) {
        container.classList.remove('is-collapsed');
        container.classList.add('is-expanded');
        detailsToggleBtn.setAttribute('aria-expanded', 'true');
        if (key) {
          partnerContactDetailsState.set(key, 'expanded');
        }
      } else {
        container.classList.add('is-collapsed');
        container.classList.remove('is-expanded');
        detailsToggleBtn.setAttribute('aria-expanded', 'false');
        if (key) {
          partnerContactDetailsState.set(key, 'collapsed');
        }
      }
      event.preventDefault();
      return;
    }
    const peopleToggleBtn = event.target.closest('[data-partner-contact-people-toggle]');
    if (peopleToggleBtn) {
      const wrapper = peopleToggleBtn.closest('[data-partner-contact-people-wrapper]');
      if (!wrapper) return;
      const hiddenContainer = wrapper.querySelector('[data-partner-contact-people-extra]');
      if (!hiddenContainer) return;
      const isHidden = hiddenContainer.classList.contains('d-none');
      if (isHidden) {
        hiddenContainer.classList.remove('d-none');
        peopleToggleBtn.setAttribute('aria-expanded', 'true');
        const expandedText = peopleToggleBtn.dataset.expandedText;
        if (expandedText) {
          peopleToggleBtn.textContent = expandedText;
        }
      } else {
        hiddenContainer.classList.add('d-none');
        peopleToggleBtn.setAttribute('aria-expanded', 'false');
        const collapsedText = peopleToggleBtn.dataset.collapsedText;
        if (collapsedText) {
          peopleToggleBtn.textContent = collapsedText;
        }
      }
      return;
    }
    const partnerContactAddBtn = event.target.closest('[data-partner-contact-add]');
    if (partnerContactAddBtn) {
      const scope = partnerContactAddBtn.dataset.partnerContactAdd;
      const initial = {};
      if (scope) {
        initial.contact_type = scope;
      }
      addPartnerContactDraft(initial);
      return;
    }
    const partnerContactActionBtn = event.target.closest('[data-partner-contact-action]');
    if (partnerContactActionBtn) {
      let card = partnerContactActionBtn.closest('[data-partner-contact-card]');
      if (!card) {
        const targetKey = partnerContactActionBtn.dataset.partnerContactActionTarget;
        if (targetKey) {
          if (partnerContactEditorBody) {
            const selector = `[data-partner-contact-card][data-partner-contact-key="${cssEscape(targetKey)}"]`;
            card = partnerContactEditorBody.querySelector(selector);
          }
          if (!card) {
            card = findPartnerContactCardByKey(targetKey);
          }
        }
      }
      if (!card) return;
      const action = partnerContactActionBtn.dataset.partnerContactAction;
      if (action === 'save') {
        handlePartnerContactSave(card, partnerContactActionBtn);
      } else if (action === 'cancel') {
        const draftId = card.dataset.partnerContactDraftId;
        if (draftId) {
          removePartnerContactDraft(draftId);
        }
      } else if (action === 'reset') {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          resetPartnerContactEdit(id);
        }
      } else if (action === 'delete') {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          deleteParameter(id, 'partner_contact', partnerContactActionBtn);
        }
      } else if (action === 'restore') {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          restoreParameter(id, 'partner_contact', partnerContactActionBtn);
        }
      }
      return;
    }
    const partnerContactAddCommBtn = event.target.closest('[data-partner-contact-add-comm]');
    if (partnerContactAddCommBtn) {
      const card = partnerContactAddCommBtn.closest('[data-partner-contact-card]');
      if (!card) return;
      const kind = partnerContactAddCommBtn.dataset.commType;
      if (!kind) return;
      if (card.dataset.partnerContactDraft === 'true') {
        modifyPartnerContactDraftComm(card.dataset.partnerContactDraftId, kind, 'add');
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          modifyPartnerContactEditComm(id, kind, 'add');
        }
      }
      renderPartnerContacts();
      return;
    }
    const partnerContactAddPersonBtn = event.target.closest('[data-partner-contact-add-person]');
    if (partnerContactAddPersonBtn) {
      const card = partnerContactAddPersonBtn.closest('[data-partner-contact-card]');
      if (!card) return;
      if (card.dataset.partnerContactDraft === 'true') {
        modifyPartnerContactDraftPerson(card.dataset.partnerContactDraftId, 'add');
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          modifyPartnerContactEditPerson(id, 'add');
        }
      }
      renderPartnerContacts();
      return;
    }
    const partnerContactRemovePersonBtn = event.target.closest('[data-partner-contact-remove-person]');
    if (partnerContactRemovePersonBtn) {
      const card = partnerContactRemovePersonBtn.closest('[data-partner-contact-card]');
      if (!card) return;
      const personKey = partnerContactRemovePersonBtn.dataset.personKey;
      if (!personKey) return;
      if (card.dataset.partnerContactDraft === 'true') {
        modifyPartnerContactDraftPerson(card.dataset.partnerContactDraftId, 'remove', personKey);
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          modifyPartnerContactEditPerson(id, 'remove', personKey);
        }
      }
      renderPartnerContacts();
      return;
    }
    const partnerContactRemoveCommBtn = event.target.closest('[data-partner-contact-remove-comm]');
    if (partnerContactRemoveCommBtn) {
      const card = partnerContactRemoveCommBtn.closest('[data-partner-contact-card]');
      if (!card) return;
      const kind = partnerContactRemoveCommBtn.dataset.commType;
      const entryKey = partnerContactRemoveCommBtn.dataset.entryKey;
      if (!kind || !entryKey) return;
      if (card.dataset.partnerContactDraft === 'true') {
        modifyPartnerContactDraftComm(card.dataset.partnerContactDraftId, kind, 'remove', entryKey);
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          modifyPartnerContactEditComm(id, kind, 'remove', entryKey);
        }
      }
      renderPartnerContacts();
      return;
    }
    const legalEntityAddBtn = event.target.closest('[data-legal-entity-add]');
    if (legalEntityAddBtn) {
      addLegalEntityDraft();
      return;
    }
    const legalEntityAction = event.target.closest('[data-legal-entity-action]');
    if (legalEntityAction) {
      const card = legalEntityAction.closest('[data-legal-entity-card]');
      if (!card) return;
      const action = legalEntityAction.dataset.legalEntityAction;
      if (action === 'save') {
        handleLegalEntitySave(card, legalEntityAction);
      } else if (action === 'delete') {
        const id = Number.parseInt(card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          deleteParameter(id, 'legal_entity', legalEntityAction);
        }
      } else if (action === 'restore') {
        const id = Number.parseInt(card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          restoreParameter(id, 'legal_entity', legalEntityAction);
        }
      } else if (action === 'cancel') {
        const draftId = card.dataset.legalEntityDraftId;
        if (draftId) {
          removeLegalEntityDraft(draftId);
        }
      }
      return;
    }
    const cityToggle = event.target.closest('[data-city-toggle]');
    if (cityToggle) {
      if (Array.isArray(CITY_OPTIONS) && CITY_OPTIONS.length > 10) {
        openParameterModal(CITY_PARAMETER_TYPE);
      }
      return;
    }
    const toggleBtn = event.target.closest('[data-param-toggle]');
    if (toggleBtn) {
      const card = toggleBtn.closest('.parameter-card');
      if (!card) return;
      const type = card.dataset.paramType;
      if (!type) return;
      if (card.dataset.hasMany === 'true') {
        openParameterModal(type);
        return;
      }
      card.classList.toggle('is-expanded');
      renderParameterCard(type, { forceBody: true });
      return;
    }
    const actionEl = event.target.closest('[data-param-action]');
    if (!actionEl) return;
    const action = actionEl.dataset.paramAction;
    const containerWithType = actionEl.closest('[data-param-type]');
    const type = actionEl.dataset.paramType || (containerWithType ? containerWithType.dataset.paramType : null);
    if (!action || !type) return;
    if (action === 'create') {
      createParameter(type, actionEl);
      return;
    }
    const entry = actionEl.closest('[data-param-id]');
    if (!entry) return;
    const id = Number.parseInt(entry.dataset.paramId, 10);
    if (!Number.isFinite(id)) return;
    if (action === 'save') {
      updateParameterValue(id, type, actionEl);
    } else if (action === 'delete') {
      deleteParameter(id, type, actionEl);
    } else if (action === 'restore') {
      restoreParameter(id, type, actionEl);
    }
  });

  document.addEventListener('keydown', (event) => {
    if (event.key !== 'Enter' && event.key !== ' ') return;
    const openTarget = event.target.closest('[data-partner-contact-open-modal]');
    if (!openTarget) return;
    if (openTarget.getAttribute('role') !== 'button') return;
    const card = openTarget.closest('[data-partner-contact-card]');
    if (!card) return;
    event.preventDefault();
    openPartnerContactEditor(card);
  });

  document.addEventListener('change', (event) => {
    const stateSelect = event.target.closest('[data-param-field="state"]');
    if (!stateSelect) return;
    const entry = stateSelect.closest('[data-param-id]');
    if (!entry) return;
    const id = Number.parseInt(entry.dataset.paramId, 10);
    const type = entry.dataset.paramType;
    if (!Number.isFinite(id) || !type) return;
    updateParameterState(id, type, stateSelect);
  });

  if (legalEntitiesContainer) {
    legalEntitiesContainer.addEventListener('input', (event) => {
      const field = event.target.dataset.legalEntityField;
      if (!field) return;
      const card = event.target.closest('[data-legal-entity-card]');
      if (!card) return;
      if (field === 'value') {
        const title = card.querySelector('[data-legal-entity-title]');
        if (title) {
          const text = event.target.value.trim();
          title.textContent = text || 'Без названия';
        }
      }
      if (card.dataset.legalEntityDraft === 'true') {
        const draftId = card.dataset.legalEntityDraftId;
        if (draftId) {
          updateLegalEntityDraftValue(draftId, field, event.target.value);
        }
      }
    });
    legalEntitiesContainer.addEventListener('change', (event) => {
      const field = event.target.dataset.legalEntityField;
      if (!field) return;
      const card = event.target.closest('[data-legal-entity-card]');
      if (!card) return;
      if (field === 'state') {
        updateLegalEntityStateLabel(card, event.target.value);
      }
      if (card.dataset.legalEntityDraft === 'true') {
        const draftId = card.dataset.legalEntityDraftId;
        if (draftId) {
          updateLegalEntityDraftValue(draftId, field, event.target.value);
        }
      }
    });
  }

  document.addEventListener('input', (event) => {
    const card = event.target.closest('[data-partner-contact-card]');
    if (!card) return;
    const personField = event.target.dataset.partnerContactPersonField;
    if (personField) {
      const row = event.target.closest('[data-partner-contact-person]');
      if (!row) return;
      const personKey = row.dataset.partnerContactPerson;
      if (!personKey) return;
      let value;
      if (personField === 'is_top') {
        value = event.target.checked;
      } else {
        value = event.target.value;
      }
      if (personField === 'phone') {
        updatePhoneInputFormatting(event.target);
        value = event.target.dataset.phoneDigits || extractDigits(event.target.value);
      } else if (personField === 'email') {
        validateEmailInput(event.target);
        value = typeof event.target.value === 'string' ? event.target.value.trim() : '';
      }
      if (card.dataset.partnerContactDraft === 'true') {
        updatePartnerContactDraftPerson(card.dataset.partnerContactDraftId, personKey, personField, value);
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          updatePartnerContactEditPerson(id, personKey, personField, value);
        }
      }
      refreshPartnerContactPersonRow(row);
      return;
    }
    const field = event.target.dataset.partnerContactField;
    if (field === 'value' || field === 'internal_name' || field === 'inn') {
      let value = event.target.value;
      if (field === 'inn') {
        const digits = extractDigits(value);
        event.target.value = digits;
        value = digits;
      }
      if (card.dataset.partnerContactDraft === 'true') {
        updatePartnerContactDraftValue(card.dataset.partnerContactDraftId, field, value);
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          updatePartnerContactEditField(id, field, value);
        }
      }
      if (field === 'value' || field === 'internal_name') {
        refreshPartnerContactCardTitle(card);
      }
      return;
    }
    const commField = event.target.dataset.partnerContactCommField;
    if (commField === 'value' || commField === 'extension') {
      const kind = event.target.dataset.commType;
      const entryKey = event.target.dataset.entryKey;
      if (!kind || !entryKey) return;
      let value = event.target.value;
      if (kind === 'phone') {
        if (commField === 'value') {
          updatePhoneInputFormatting(event.target);
          value = event.target.dataset.phoneDigits || extractDigits(event.target.value);
        } else {
          enforceExtensionDigits(event.target);
          value = event.target.value;
        }
      } else if (kind === 'email' && commField === 'value') {
        validateEmailInput(event.target);
      }
      if (card.dataset.partnerContactDraft === 'true') {
        updatePartnerContactDraftComm(card.dataset.partnerContactDraftId, kind, entryKey, commField, value);
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          updatePartnerContactEditComm(id, kind, entryKey, commField, value);
        }
      }
      return;
    }
  });

  document.addEventListener('change', (event) => {
    const card = event.target.closest('[data-partner-contact-card]');
    if (!card) return;
    const personField = event.target.dataset.partnerContactPersonField;
    if (personField === 'is_top') {
      const row = event.target.closest('[data-partner-contact-person]');
      if (!row) return;
      const personKey = row.dataset.partnerContactPerson;
      if (!personKey) return;
      const value = event.target.checked;
      if (card.dataset.partnerContactDraft === 'true') {
        updatePartnerContactDraftPerson(card.dataset.partnerContactDraftId, personKey, personField, value);
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          updatePartnerContactEditPerson(id, personKey, personField, value);
        }
      }
      refreshPartnerContactPersonRow(row);
      return;
    }
    const field = event.target.dataset.partnerContactField;
    if (field === 'contact_type') {
      const value = event.target.value;
      if (card.dataset.partnerContactDraft === 'true') {
        updatePartnerContactDraftValue(card.dataset.partnerContactDraftId, field, value);
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          updatePartnerContactEditField(id, field, value);
        }
      }
      const wrapper = card.querySelector('[data-partner-contact-served-wrapper]');
      if (wrapper) {
        wrapper.classList.toggle('d-none', value !== 'ka');
        const select = wrapper.querySelector('[data-partner-contact-field="served_legal_entities"]');
        if (select && value !== 'ka') {
          Array.from(select.options).forEach((option) => {
            option.selected = false;
          });
        }
      }
      updatePartnerContactServedSummary(card);
      const data = getPartnerContactCardData(card);
      const subtitle = card.querySelector('[data-partner-contact-subtitle]');
      if (subtitle && data) {
        const typeLabel = PARTNER_CONTACT_TYPES[data.contact_type] || PARTNER_CONTACT_TYPES.partner;
        subtitle.textContent = `${typeLabel} • ${data.state || PARAMETER_STATES[0]}`;
      }
      updatePartnerContactCardHeaderState(card, data ? data.state || PARAMETER_STATES[0] : PARAMETER_STATES[0]);
      return;
    }
    if (field === 'state') {
      const stateValue = event.target.value;
      if (card.dataset.partnerContactDraft === 'true') {
        updatePartnerContactDraftValue(card.dataset.partnerContactDraftId, field, stateValue);
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          updatePartnerContactEditField(id, field, stateValue);
        }
      }
      const data = getPartnerContactCardData(card);
      const subtitle = card.querySelector('[data-partner-contact-subtitle]');
      if (subtitle && data) {
        const typeLabel = PARTNER_CONTACT_TYPES[data.contact_type] || PARTNER_CONTACT_TYPES.partner;
        subtitle.textContent = `${typeLabel} • ${data.state || PARAMETER_STATES[0]}`;
      }
      updatePartnerContactCardHeaderState(card, data ? data.state || stateValue : stateValue);
      return;
    }
    if (field === 'served_legal_entities') {
      const select = event.target;
      const selections = Array.from(select.selectedOptions)
        .map((option) => {
          const id = Number.parseInt(option.value, 10);
          if (!Number.isFinite(id) || id <= 0) return null;
          const label = option.dataset.label || option.textContent || '';
          return { id, name: label };
        })
        .filter((entry) => entry);
      if (card.dataset.partnerContactDraft === 'true') {
        updatePartnerContactDraftValue(card.dataset.partnerContactDraftId, 'served_legal_entities', selections);
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          updatePartnerContactEditField(id, 'served_legal_entities', selections);
        }
      }
      updatePartnerContactServedSummary(card, { served_legal_entities: selections });
      return;
    }
    if (field === 'served_legal_entity_id') {
      const select = event.target;
      const option = select.options[select.selectedIndex];
      const label = option ? option.dataset.label || option.textContent : '';
      const idValue = select.value ? Number.parseInt(select.value, 10) : null;
      if (card.dataset.partnerContactDraft === 'true') {
        updatePartnerContactDraftValue(card.dataset.partnerContactDraftId, field, Number.isFinite(idValue) ? idValue : null);
        updatePartnerContactDraftValue(card.dataset.partnerContactDraftId, 'served_legal_entity_name', label || '');
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          updatePartnerContactEditField(id, field, Number.isFinite(idValue) ? idValue : null);
          updatePartnerContactEditField(id, 'served_legal_entity_name', label || '');
        }
      }
      updatePartnerContactServedSummary(card);
      return;
    }
    const commField = event.target.dataset.partnerContactCommField;
    if (commField === 'type') {
      const kind = event.target.dataset.commType;
      const entryKey = event.target.dataset.entryKey;
      if (!kind || !entryKey) return;
      const value = event.target.value;
      if (card.dataset.partnerContactDraft === 'true') {
        updatePartnerContactDraftComm(card.dataset.partnerContactDraftId, kind, entryKey, commField, value);
      } else {
        const id = Number.parseInt(card.dataset.partnerContactId || card.dataset.paramId, 10);
        if (Number.isFinite(id)) {
          updatePartnerContactEditComm(id, kind, entryKey, commField, value);
        }
      }
    }
  });


  const CITY_OPTIONS = (() => {
    const values = {{ cities | tojson }};
    if (!Array.isArray(values)) {
      return [];
    }
    const cleaned = values
      .map((value) => (typeof value === 'string' ? value.trim() : ''))
      .filter((value) => value);
    return Array.from(new Set(cleaned)).sort((a, b) => a.localeCompare(b));
  })();
  renderCityCard();
  const contractUsageData = {{ contract_usage | tojson }};
  const networkProfilesInitial = {{ settings.network_profiles | tojson }};

  function sanitizeRestaurantIds(value) {
    const unique = [];
    const pushUnique = (candidate) => {
      const trimmed = typeof candidate === 'string' ? candidate.trim() : candidate != null ? String(candidate).trim() : '';
      if (!trimmed) return;
      if (!unique.includes(trimmed)) {
        unique.push(trimmed);
      }
    };
    if (Array.isArray(value)) {
      value.forEach((entry) => {
        if (typeof entry === 'string' || typeof entry === 'number') {
          String(entry)
            .split(/[,;\n]/)
            .forEach((part) => pushUnique(part));
        }
      });
    } else if (typeof value === 'string' || typeof value === 'number') {
      String(value)
        .split(/[,;\n]/)
        .forEach((part) => pushUnique(part));
    }
    return unique;
  }

  function prepareNetworkProfile(item) {
    const source = item || {};
    const provider = source.provider != null ? String(source.provider).trim() : '';
    const contractNumber = source.contract_number != null ? String(source.contract_number).trim() : '';
    const supportPhone = source.support_phone != null ? String(source.support_phone).trim() : '';
    const legalEntity = source.legal_entity != null ? String(source.legal_entity).trim() : '';
    const fallbackSingle = source.restaurant_id != null ? String(source.restaurant_id).trim() : '';
    const idsSource = source.restaurant_ids !== undefined ? source.restaurant_ids : fallbackSingle;
    let restaurantIds = sanitizeRestaurantIds(idsSource);
    if (!restaurantIds.length && fallbackSingle) {
      restaurantIds = [fallbackSingle];
    }
    const primaryRestaurantId = restaurantIds[0] || '';
    return {
      provider,
      contract_number: contractNumber,
      support_phone: supportPhone,
      legal_entity: legalEntity,
      restaurant_ids: restaurantIds,
      restaurant_id: primaryRestaurantId,
    };
  }

  function createEmptyNetworkProfile() {
    return prepareNetworkProfile({});
  }

  let networkProfilesData = Array.isArray(networkProfilesInitial)
    ? networkProfilesInitial.map((item) => prepareNetworkProfile(item))
    : [];

  const networkProfilesBody = document.getElementById('networkProfilesBody');
  const networkProfilesSaveButton = document.querySelector('[data-network-profiles-save]');
  const networkProfilesAddButton = document.querySelector('[data-network-profiles-add]');
  const networkProfileModalEl = document.getElementById('networkProfileEditorModal');
  const networkProfileModal = networkProfileModalEl ? new bootstrap.Modal(networkProfileModalEl) : null;
  const networkProfileForm = networkProfileModalEl ? networkProfileModalEl.querySelector('[data-network-profile-form]') : null;
  const networkProfileTitle = networkProfileModalEl ? networkProfileModalEl.querySelector('[data-network-profile-title]') : null;
  const networkProfileDeleteButton = networkProfileModalEl ? networkProfileModalEl.querySelector('[data-network-profile-delete]') : null;
  const networkProfileProviderInput = networkProfileModalEl ? networkProfileModalEl.querySelector('[data-network-profile-provider]') : null;
  const networkProfileContractInput = networkProfileModalEl ? networkProfileModalEl.querySelector('[data-network-profile-contract]') : null;
  const networkProfileSupportPhoneInput = networkProfileModalEl ? networkProfileModalEl.querySelector('[data-network-profile-support-phone]') : null;
  const networkProfileLegalEntityInput = networkProfileModalEl ? networkProfileModalEl.querySelector('[data-network-profile-legal-entity]') : null;
  const networkProfileRestaurantIdsContainer = networkProfileModalEl
    ? networkProfileModalEl.querySelector('[data-network-profile-restaurant-ids]')
    : null;
  const networkProfileAddRestaurantIdButton = networkProfileModalEl
    ? networkProfileModalEl.querySelector('[data-network-profile-add-restaurant-id]')
    : null;
  let networkProfileEditingIndex = null;

  function escapeHtml(value) {
    if (value === null || value === undefined) return '';
    return String(value)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function getProfileRestaurantIds(profile) {
    const data = profile || {};
    const ids = sanitizeRestaurantIds(data.restaurant_ids);
    if (!ids.length) {
      sanitizeRestaurantIds(data.restaurant_id).forEach((value) => {
        if (!ids.includes(value)) {
          ids.push(value);
        }
      });
    }
    return ids;
  }

  function renderText(value) {
    const trimmed = (value || '').trim();
    return trimmed ? escapeHtml(trimmed) : '<span class="text-muted">—</span>';
  }

  function renderRestaurantIdsCell(profile) {
    const ids = getProfileRestaurantIds(profile);
    if (!ids.length) {
      return '<span class="text-muted">—</span>';
    }
    const badges = ids
      .map((id) => `<span class="badge bg-light text-dark border">${escapeHtml(id)}</span>`)
      .join('');
    return `<div class="d-flex flex-wrap gap-1">${badges}</div>`;
  }

  function renderContractUsageLink(contractNumber) {
    const trimmed = (contractNumber || '').trim();
    if (!trimmed) {
      return '<span class="text-muted">—</span>';
    }
    const count = contractUsageData && typeof contractUsageData === 'object'
      ? (contractUsageData[trimmed] || 0)
      : 0;
    const url = `/object_passports?network_contract_number=${encodeURIComponent(trimmed)}`;
    return `<a href="${url}" class="btn btn-link btn-sm p-0">${count}</a>`;
  }

  function updateRestaurantIdRemoveButtonsState() {
    if (!networkProfileRestaurantIdsContainer) return;
    const entries = networkProfileRestaurantIdsContainer.querySelectorAll('[data-restaurant-id-entry]');
    const allowRemoval = entries.length > 1;
    entries.forEach((entry) => {
      const removeButton = entry.querySelector('[data-remove-restaurant-id]');
      if (removeButton) {
        removeButton.disabled = !allowRemoval;
      }
    });
  }

  function createRestaurantIdEntry(value) {
    const group = document.createElement('div');
    group.className = 'input-group input-group-sm';
    group.dataset.restaurantIdEntry = 'true';

    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'form-control';
    input.placeholder = 'ID ресторана';
    input.value = value || '';
    input.setAttribute('data-restaurant-id-input', 'true');
    group.appendChild(input);

    const removeButton = document.createElement('button');
    removeButton.type = 'button';
    removeButton.className = 'btn btn-outline-danger';
    removeButton.setAttribute('data-remove-restaurant-id', 'true');
    removeButton.innerHTML = '&times;';
    removeButton.title = 'Удалить';
    group.appendChild(removeButton);

    return group;
  }

  function renderRestaurantIdInputs(values) {
    if (!networkProfileRestaurantIdsContainer) return;
    const list = Array.isArray(values) && values.length ? values : [''];
    networkProfileRestaurantIdsContainer.innerHTML = '';
    list.forEach((value) => {
      const entry = createRestaurantIdEntry(value);
      networkProfileRestaurantIdsContainer.appendChild(entry);
    });
    updateRestaurantIdRemoveButtonsState();
  }

  function addRestaurantIdInput(value = '') {
    if (!networkProfileRestaurantIdsContainer) return;
    const entry = createRestaurantIdEntry(value);
    networkProfileRestaurantIdsContainer.appendChild(entry);
    updateRestaurantIdRemoveButtonsState();
    const input = entry.querySelector('[data-restaurant-id-input]');
    if (input) {
      input.focus();
      input.select();
    }
  }

  function collectRestaurantIdsFromForm() {
    if (!networkProfileRestaurantIdsContainer) return [];
    const inputs = networkProfileRestaurantIdsContainer.querySelectorAll('[data-restaurant-id-input]');
    const values = [];
    inputs.forEach((input) => {
      const trimmed = (input.value || '').trim();
      if (trimmed && !values.includes(trimmed)) {
        values.push(trimmed);
      }
    });
    return values;
  }

  function fillNetworkProfileForm(profile) {
    const data = prepareNetworkProfile(profile);
    if (networkProfileProviderInput) {
      networkProfileProviderInput.value = data.provider || '';
    }
    if (networkProfileContractInput) {
      networkProfileContractInput.value = data.contract_number || '';
    }
    if (networkProfileSupportPhoneInput) {
      networkProfileSupportPhoneInput.value = data.support_phone || '';
    }
    if (networkProfileLegalEntityInput) {
      networkProfileLegalEntityInput.value = data.legal_entity || '';
    }
    const ids = getProfileRestaurantIds(data);
    renderRestaurantIdInputs(ids.length ? ids : ['']);
  }

  function openNetworkProfileModal(index) {
    const numericIndex = Number.isInteger(index) ? index : Number.parseInt(index, 10);
    const isEdit = Number.isInteger(numericIndex) && numericIndex >= 0 && numericIndex < networkProfilesData.length;
    networkProfileEditingIndex = isEdit ? numericIndex : null;
    const profile = isEdit ? networkProfilesData[numericIndex] : createEmptyNetworkProfile();
    fillNetworkProfileForm(profile);
    if (networkProfileTitle) {
      networkProfileTitle.textContent = isEdit ? 'Редактирование профиля' : 'Новый профиль провайдера';
    }
    if (networkProfileDeleteButton) {
      networkProfileDeleteButton.classList.toggle('d-none', !isEdit);
    }
    if (networkProfileModal) {
      networkProfileModal.show();
    }
  }

  function renderNetworkProfiles() {
    if (!networkProfilesBody) return;
    networkProfilesBody.innerHTML = '';
    if (!networkProfilesData.length) {
      const emptyRow = document.createElement('tr');
      emptyRow.innerHTML = '<td colspan="7" class="text-muted text-center">Пока нет профилей</td>';
      networkProfilesBody.appendChild(emptyRow);
      return;
    }
    networkProfilesData.forEach((profile, index) => {
      const prepared = prepareNetworkProfile(profile);
      networkProfilesData[index] = prepared;
      const row = document.createElement('tr');
      row.dataset.index = index;
      row.innerHTML = `
        <td>${renderText(prepared.provider)}</td>
        <td>${renderText(prepared.contract_number)}</td>
        <td>${renderRestaurantIdsCell(prepared)}</td>
        <td>${renderText(prepared.support_phone)}</td>
        <td>${renderText(prepared.legal_entity)}</td>
        <td data-usage-cell></td>
        <td class="text-nowrap">
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" type="button" data-action="edit-profile">Открыть</button>
            <button class="btn btn-outline-danger" type="button" data-action="remove-profile">Удалить</button>
          </div>
        </td>
      `;
      const usageCell = row.querySelector('[data-usage-cell]');
      if (usageCell) {
        usageCell.innerHTML = renderContractUsageLink(prepared.contract_number);
      }
      networkProfilesBody.appendChild(row);
    });
  }

  function removeNetworkProfileRow(index) {
    if (index < 0 || index >= networkProfilesData.length) return;
    networkProfilesData.splice(index, 1);
    renderNetworkProfiles();
  }

  function collectNetworkProfilesPayload() {
    return networkProfilesData
      .map((item) => {
        const prepared = prepareNetworkProfile(item);
        return {
          provider: prepared.provider,
          contract_number: prepared.contract_number,
          support_phone: prepared.support_phone,
          legal_entity: prepared.legal_entity,
          restaurant_id: prepared.restaurant_id,
          restaurant_ids: prepared.restaurant_ids,
        };
      })
      .filter((profile) => {
        return (
          profile.provider ||
          profile.contract_number ||
          profile.support_phone ||
          profile.legal_entity ||
          profile.restaurant_id ||
          (Array.isArray(profile.restaurant_ids) && profile.restaurant_ids.length)
        );
      });
  }

  function handleNetworkProfileFormSubmit(event) {
    event.preventDefault();
    const data = {
      provider: networkProfileProviderInput ? networkProfileProviderInput.value : '',
      contract_number: networkProfileContractInput ? networkProfileContractInput.value : '',
      support_phone: networkProfileSupportPhoneInput ? networkProfileSupportPhoneInput.value : '',
      legal_entity: networkProfileLegalEntityInput ? networkProfileLegalEntityInput.value : '',
      restaurant_ids: collectRestaurantIdsFromForm(),
    };
    const prepared = prepareNetworkProfile(data);
    const isEdit =
      Number.isInteger(networkProfileEditingIndex) &&
      networkProfileEditingIndex >= 0 &&
      networkProfileEditingIndex < networkProfilesData.length;
    if (isEdit) {
      networkProfilesData[networkProfileEditingIndex] = prepared;
    } else {
      networkProfilesData.push(prepared);
    }
    renderNetworkProfiles();
    if (networkProfileModal) {
      networkProfileModal.hide();
    }
  }

  function handleNetworkProfileDelete() {
    if (
      !Number.isInteger(networkProfileEditingIndex) ||
      networkProfileEditingIndex < 0 ||
      networkProfileEditingIndex >= networkProfilesData.length
    ) {
      return;
    }
    if (!confirm('Удалить профиль провайдера?')) {
      return;
    }
    removeNetworkProfileRow(networkProfileEditingIndex);
    if (networkProfileModal) {
      networkProfileModal.hide();
    }
  }

  if (networkProfilesAddButton) {
    networkProfilesAddButton.addEventListener('click', () => openNetworkProfileModal(null));
  }

  if (networkProfilesBody) {
    networkProfilesBody.addEventListener('click', (event) => {
      const actionButton = event.target.closest('[data-action]');
      if (!actionButton) return;
      const row = actionButton.closest('tr[data-index]');
      if (!row) return;
      const index = Number.parseInt(row.dataset.index, 10);
      if (Number.isNaN(index)) return;
      const action = actionButton.dataset.action;
      if (action === 'edit-profile') {
        openNetworkProfileModal(index);
      } else if (action === 'remove-profile') {
        if (confirm('Удалить профиль провайдера?')) {
          removeNetworkProfileRow(index);
        }
      }
    });
  }

  if (networkProfileAddRestaurantIdButton) {
    networkProfileAddRestaurantIdButton.addEventListener('click', () => addRestaurantIdInput(''));
  }

  if (networkProfileRestaurantIdsContainer) {
    networkProfileRestaurantIdsContainer.addEventListener('click', (event) => {
      const button = event.target.closest('[data-remove-restaurant-id]');
      if (!button) return;
      const entry = button.closest('[data-restaurant-id-entry]');
      if (!entry) return;
      const entries = networkProfileRestaurantIdsContainer.querySelectorAll('[data-restaurant-id-entry]');
      if (entries.length <= 1) {
        const input = entry.querySelector('[data-restaurant-id-input]');
        if (input) {
          input.value = '';
          input.focus();
          input.select();
        }
        return;
      }
      entry.remove();
      updateRestaurantIdRemoveButtonsState();
    });
  }

  if (networkProfileForm) {
    networkProfileForm.addEventListener('submit', handleNetworkProfileFormSubmit);
  }

  if (networkProfileDeleteButton) {
    networkProfileDeleteButton.addEventListener('click', handleNetworkProfileDelete);
  }

  if (networkProfileModalEl) {
    networkProfileModalEl.addEventListener('hidden.bs.modal', () => {
      networkProfileEditingIndex = null;
      if (networkProfileForm) {
        networkProfileForm.reset();
      }
      if (networkProfileRestaurantIdsContainer) {
        renderRestaurantIdInputs(['']);
      }
    });
    networkProfileModalEl.addEventListener('shown.bs.modal', () => {
      if (networkProfileProviderInput) {
        networkProfileProviderInput.focus();
        networkProfileProviderInput.select();
      }
    });
  }

  renderNetworkProfiles();

  function normalizeItConnectionCategory(value) {
    if (typeof value !== 'string') {
      return IT_CONNECTION_DEFAULT_CATEGORY;
    }
    const trimmed = value.trim();
    if (!trimmed) {
      return IT_CONNECTION_DEFAULT_CATEGORY;
    }
    if (IT_CONNECTION_CATEGORY_KEYS.includes(trimmed)) {
      return trimmed;
    }
    const lowered = trimmed.toLowerCase();
    const matchedKey = IT_CONNECTION_CATEGORY_KEYS.find((key) => {
      const label = IT_CONNECTION_CATEGORY_LABELS[key];
      return typeof label === 'string' && label.trim().toLowerCase() === lowered;
    });
    return matchedKey || trimmed;
  }

  function getItConnectionCategoryLabel(category) {
    const normalized = normalizeItConnectionCategory(category);
    return IT_CONNECTION_CATEGORY_LABELS[normalized] || normalized || '—';
  }

  function renderContractUsageLink(contractNumber) {
    const trimmed = (contractNumber || '').trim();
    if (!trimmed) {
      return '<span class="text-muted">—</span>';
    }
    const count = contractUsageData && typeof contractUsageData === 'object'
      ? (contractUsageData[trimmed] || 0)
      : 0;
    const url = `/object_passports?network_contract_number=${encodeURIComponent(trimmed)}`;
    return `<a href="${url}" class="btn btn-link btn-sm p-0">${count}</a>`;
  }

  async function saveNetworkProfilesSection() {
    if (networkProfilesSaveButton && networkProfilesSaveButton.disabled) {
      return;
    }
    const button = networkProfilesSaveButton;
    const originalText = button ? button.textContent : '';
    if (button) {
      button.disabled = true;
      button.textContent = '...';
    }
    try {
      const payload = { network_profiles: collectNetworkProfilesPayload() };
      const response = await fetch('/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error((data && data.error) || 'Ошибка сохранения профилей');
      }
      alert('✅ Профили провайдеров сохранены');
    } catch (error) {
      alert('❌ ' + (error && error.message ? error.message : error));
    } finally {
      if (button) {
        button.disabled = false;
        button.textContent = originalText || 'Сохранить изменения';
      }
    }
  }

  if (networkProfilesSaveButton) {
    networkProfilesSaveButton.addEventListener('click', (event) => {
      event.preventDefault();
      saveNetworkProfilesSection();
    });
  }

  const itConnectionsContainer = document.querySelector('[data-it-connections-container]');
  let itConnectionDrafts = [];
  const itEquipmentBody = document.getElementById('itEquipmentBody');
  let itEquipmentItems = [];

  function parseEquipmentLinks(raw) {
    if (Array.isArray(raw)) {
      return raw.map((item) => (item || '').toString().trim()).filter(Boolean);
    }
    if (typeof raw === 'string') {
      const trimmed = raw.trim();
      if (!trimmed) {
        return [];
      }
      if (trimmed.startsWith('[')) {
        try {
          const parsed = JSON.parse(trimmed);
          if (Array.isArray(parsed)) {
            return parsed.map((item) => (item || '').toString().trim()).filter(Boolean);
          }
        } catch (error) {
          // игнорируем ошибки парсинга и используем значение как строку
        }
      }
      if (trimmed.includes('\n')) {
        return trimmed
          .split('\n')
          .map((item) => item.trim())
          .filter(Boolean);
      }
      return [trimmed];
    }
    return [];
  }

  function formatEquipmentLinksPayload(links) {
    const normalized = Array.isArray(links)
      ? links.map((item) => (item || '').toString().trim()).filter(Boolean)
      : [];
    if (!normalized.length) {
      return '';
    }
    try {
      return JSON.stringify(normalized);
    } catch (error) {
      return normalized.join('\n');
    }
  }

  function ensureEquipmentLinksPlaceholder(container) {
    if (!container) return;
    const hasItems = container.querySelector('[data-link-item]');
    const placeholder = container.querySelector('[data-link-placeholder]');
    if (hasItems && placeholder) {
      placeholder.remove();
    } else if (!hasItems && !placeholder) {
      const hint = document.createElement('div');
      hint.className = 'text-muted small';
      hint.dataset.linkPlaceholder = 'true';
      hint.textContent = 'Ссылок нет';
      container.appendChild(hint);
    }
  }

  function addEquipmentLinkInput(container, value = '') {
    if (!container) return null;
    const item = document.createElement('div');
    item.className = 'input-group input-group-sm';
    item.dataset.linkItem = 'true';
    item.innerHTML = `
      <input type="text" class="form-control form-control-sm" data-link-input placeholder="https://..." value="${escapeHtml(value)}">
      <button class="btn btn-outline-danger" type="button" data-it-equipment-link-action="remove-link">&times;</button>
    `;
    container.appendChild(item);
    ensureEquipmentLinksPlaceholder(container);
    return item;
  }

  function renderEquipmentLinks(container, links) {
    if (!container) return;
    container.innerHTML = '';
    const list = Array.isArray(links) ? links : [];
    if (!list.length) {
      ensureEquipmentLinksPlaceholder(container);
      return;
    }
    list.forEach((link) => {
      addEquipmentLinkInput(container, link);
    });
    ensureEquipmentLinksPlaceholder(container);
  }

  function collectEquipmentLinks(container) {
    if (!container) return [];
    return Array.from(container.querySelectorAll('[data-link-input]'))
      .map((input) => (input.value || '').trim())
      .filter(Boolean);
  }

  function renderItConnectionUsageLink(item) {
    if (!item) {
      return '<span class="text-muted">—</span>';
    }
    const category = normalizeItConnectionCategory(item.category);
    const value = item && item.value ? String(item.value).trim() : '';
    const usage = Number.isFinite(Number(item && item.usage_count)) ? Number(item.usage_count) : 0;
    if (!value) {
      return '<span class="text-muted">—</span>';
    }
    const filterKey = IT_CONNECTION_USAGE_FILTER_PARAMS[category];
    if (!filterKey) {
      const className = usage > 0 ? 'fw-semibold text-dark' : 'text-muted';
      return `<span class="${className}">${usage}</span>`;
    }
    const url = `/object_passports?${filterKey}=${encodeURIComponent(value)}`;
    const className = 'btn btn-link btn-sm p-0' + (usage > 0 ? '' : ' text-muted');
    return `<a href="${url}" class="${className}" title="Открыть паспорта с этим значением">${usage}</a>`;
  }

  function buildItConnectionsRows() {
    const existing = Array.isArray(parameterData.it_connection) ? parameterData.it_connection : [];
    const rows = existing.map((item) => ({
      item: Object.assign({}, item, {
        category: normalizeItConnectionCategory(item && item.category),
        value: item && typeof item.value === 'string' ? item.value : '',
      }),
      isDraft: false,
    }));
    itConnectionDrafts.forEach((item, index) => {
      const draft = Object.assign(
        {
          category: IT_CONNECTION_DEFAULT_CATEGORY,
          value: '',
          is_deleted: false,
          usage_count: 0,
        },
        item || {}
      );
      draft.category = normalizeItConnectionCategory(draft.category);
      draft.value = typeof draft.value === 'string' ? draft.value : '';
      rows.push({ item: draft, isDraft: true, draftIndex: index });
    });
    return rows;
  }

  function renderItConnectionsTable() {
    if (!itConnectionsContainer) return;
    const rows = buildItConnectionsRows();
    itConnectionsContainer.innerHTML = '';
    if (!rows.length) {
      const emptyState = document.createElement('div');
      emptyState.className = 'text-muted text-center py-3';
      emptyState.textContent = 'Пока нет подключений';
      itConnectionsContainer.appendChild(emptyState);
      renderItEquipmentTable();
      return;
    }

    const grouped = rows.reduce((acc, entry) => {
      const category = normalizeItConnectionCategory(entry && entry.item && entry.item.category);
      if (!acc.has(category)) {
        acc.set(category, []);
      }
      acc.get(category).push(entry);
      return acc;
    }, new Map());

    const accordionId = 'itConnectionsCategoryAccordion';
    const categoryEntries = Array.from(grouped.entries()).sort(([a], [b]) => {
      const labelA = getItConnectionCategoryLabel(a);
      const labelB = getItConnectionCategoryLabel(b);
      return labelA.localeCompare(labelB, 'ru', { sensitivity: 'base' });
    });

    categoryEntries.forEach(([category, items], index) => {
      const collapseIdSlug = (category || 'uncategorized')
        .toString()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '') || 'all';
      const collapseId = `${accordionId}-panel-${index}-${collapseIdSlug}`;
      const headerId = `${collapseId}-header`;
      const accordionItem = document.createElement('div');
      accordionItem.className = 'accordion-item';
      accordionItem.innerHTML = `
        <h2 class="accordion-header" id="${headerId}">
          <button class="accordion-button${index === 0 ? '' : ' collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="${index === 0}" aria-controls="${collapseId}">
            ${escapeHtml(getItConnectionCategoryLabel(category))}
          </button>
        </h2>
        <div id="${collapseId}" class="accordion-collapse collapse${index === 0 ? ' show' : ''}" aria-labelledby="${headerId}" data-bs-parent="#${accordionId}">
          <div class="accordion-body p-0">
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead>
                  <tr>
                    <th style="width: 55%">Значение</th>
                    <th class="text-center" style="width: 10%">Использование</th>
                    <th style="width: 35%"></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      `;
      const tbody = accordionItem.querySelector('tbody');
      items.forEach(({ item, isDraft, draftIndex }) => {
        const row = document.createElement('tr');
        const disabled = !isDraft && Boolean(item && item.is_deleted);
        const value = item && typeof item.value === 'string' ? item.value : '';
        if (isDraft) {
          row.dataset.rowKind = 'draft';
          row.dataset.draftIndex = String(draftIndex);
        } else {
          row.dataset.rowKind = 'existing';
          const rawId = item && Object.prototype.hasOwnProperty.call(item, 'id') ? item.id : null;
          const idNumber = Number.parseInt(rawId, 10);
          if (Number.isFinite(idNumber)) {
            row.dataset.id = String(idNumber);
          }
          if (disabled) {
            row.classList.add('table-light', 'text-muted');
          }
        }
        row.dataset.category = category;
        const usageItem = Object.assign({}, item || {}, { category, value });
        const deletedHint = !isDraft && disabled
          ? '<div class="form-text text-danger small">Запись помечена как удалённая</div>'
          : '';
        const actions = isDraft
          ? `
              <button class="btn btn-sm btn-outline-success" type="button" data-it-connection-action="save">Сохранить</button>
              <button class="btn btn-sm btn-outline-secondary" type="button" data-it-connection-action="discard">Отменить</button>
            `
          : disabled
            ? '<button class="btn btn-sm btn-outline-secondary" type="button" data-it-connection-action="restore">Восстановить</button>'
            : `
              <button class="btn btn-sm btn-outline-success" type="button" data-it-connection-action="save">Сохранить</button>
              <button class="btn btn-sm btn-outline-danger" type="button" data-it-connection-action="delete">Удалить</button>
            `;
        row.innerHTML = `
          <td>
            <input type="text" class="form-control form-control-sm" data-field="value" value="${escapeHtml(value)}"${disabled ? ' disabled' : ''}>
            ${deletedHint}
          </td>
          <td class="text-center">${renderItConnectionUsageLink(usageItem)}</td>
          <td class="text-nowrap">${actions}</td>
        `;
        tbody.appendChild(row);
      });
      itConnectionsContainer.appendChild(accordionItem);
    });

    renderItEquipmentTable();
  }

  function collectEquipmentOptionSets() {
    const result = {
      types: new Set(),
      vendors: new Set(),
      models: new Set(),
    };
    const items = Array.isArray(parameterData.it_connection) ? parameterData.it_connection : [];
    items.forEach((item) => {
      if (!item) return;
      const category = normalizeItConnectionCategory(
        (item && item.category) || (item && item.extra && item.extra.category)
      );
      const values = {
        equipment_type: typeof item.equipment_type === 'string' ? item.equipment_type.trim() : '',
        equipment_vendor: typeof item.equipment_vendor === 'string' ? item.equipment_vendor.trim() : '',
        equipment_model: typeof item.equipment_model === 'string' ? item.equipment_model.trim() : '',
        value: typeof item.value === 'string' ? item.value.trim() : '',
      };
      if (category === 'equipment_type') {
        if (values.equipment_type) result.types.add(values.equipment_type);
        if (values.value) result.types.add(values.value);
      } else if (category === 'equipment_vendor') {
        if (values.equipment_vendor) result.vendors.add(values.equipment_vendor);
        if (values.value) result.vendors.add(values.value);
      } else if (category === 'equipment_model') {
        if (values.equipment_model) result.models.add(values.equipment_model);
        if (values.value) result.models.add(values.value);
      }
    });
    const sorter = (a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' });
    return {
      types: Array.from(result.types).sort(sorter),
      vendors: Array.from(result.vendors).sort(sorter),
      models: Array.from(result.models).sort(sorter),
    };
  }

  function buildEquipmentSelectOptions(values, selectedValue) {
    const list = Array.isArray(values) ? values : [];
    const normalizedSelected = typeof selectedValue === 'string' ? selectedValue.trim() : '';
    const options = ['<option value="">—</option>'];
    const seen = new Set();
    list.forEach((raw) => {
      const value = typeof raw === 'string' ? raw.trim() : '';
      if (!value || seen.has(value)) return;
      const selectedAttr = value === normalizedSelected ? ' selected' : '';
      options.push(`<option value="${escapeHtml(value)}"${selectedAttr}>${escapeHtml(value)}</option>`);
      seen.add(value);
    });
    if (normalizedSelected && !seen.has(normalizedSelected)) {
      options.push(
        `<option value="${escapeHtml(normalizedSelected)}" selected>${escapeHtml(normalizedSelected)}</option>`
      );
    }
    return options.join('');
  }

  function renderItEquipmentTable() {
    if (!itEquipmentBody) return;
    const list = Array.isArray(itEquipmentItems) ? itEquipmentItems : [];
    itEquipmentBody.innerHTML = '';
    if (!list.length) {
      const emptyRow = document.createElement('tr');
      emptyRow.innerHTML = '<td colspan="5" class="text-muted text-center">Пока нет оборудования</td>';
      itEquipmentBody.appendChild(emptyRow);
      return;
    }
    const optionSets = collectEquipmentOptionSets();
    list.forEach((item) => {
      const row = document.createElement('tr');
      const idNumber = Number.parseInt(item && item.id, 10);
      if (Number.isFinite(idNumber)) {
        row.dataset.id = String(idNumber);
      }
      const equipmentType = typeof (item && item.equipment_type) === 'string' ? item.equipment_type : '';
      const equipmentVendor = typeof (item && item.equipment_vendor) === 'string' ? item.equipment_vendor : '';
      const equipmentModel = typeof (item && item.equipment_model) === 'string' ? item.equipment_model : '';
      const links = parseEquipmentLinks(item && item.photo_url);
      row.innerHTML = `
        <td><select class="form-select form-select-sm" data-field="equipment_type">${buildEquipmentSelectOptions(optionSets.types, equipmentType)}</select></td>
        <td><select class="form-select form-select-sm" data-field="equipment_vendor">${buildEquipmentSelectOptions(optionSets.vendors, equipmentVendor)}</select></td>
        <td><select class="form-select form-select-sm" data-field="equipment_model">${buildEquipmentSelectOptions(optionSets.models, equipmentModel)}</select></td>
        <td>
          <div class="d-flex flex-column gap-2" data-links-container></div>
          <button class="btn btn-sm btn-outline-secondary align-self-start" type="button" data-it-equipment-link-action="add-link">+ Ссылка</button>
        </td>
        <td class="text-nowrap">
          <button class="btn btn-sm btn-outline-success" type="button" data-it-equipment-action="save">Сохранить</button>
          <button class="btn btn-sm btn-outline-danger" type="button" data-it-equipment-action="delete">Удалить</button>
        </td>
      `;
      const linksContainer = row.querySelector('[data-links-container]');
      renderEquipmentLinks(linksContainer, links);
      itEquipmentBody.appendChild(row);
    });
  }

  function collectItEquipmentPayload(row) {
    if (!row) return {};
    const selectValue = (selector) => {
      const element = row.querySelector(selector);
      return element ? element.value.trim() : '';
    };
    return {
      equipment_type: selectValue('[data-field="equipment_type"]'),
      equipment_vendor: selectValue('[data-field="equipment_vendor"]'),
      equipment_model: selectValue('[data-field="equipment_model"]'),
      photo_url: formatEquipmentLinksPayload(collectEquipmentLinks(row.querySelector('[data-links-container]'))),
    };
  }

  async function saveItEquipmentRow(row) {
    if (!row) return;
    const id = Number.parseInt(row.dataset.id, 10);
    if (!Number.isFinite(id)) return;
    const payload = collectItEquipmentPayload(row);
    if (!payload.equipment_type) {
      alert('Укажите тип оборудования');
      const select = row.querySelector('[data-field="equipment_type"]');
      if (select) select.focus();
      return;
    }
    if (!payload.equipment_vendor) {
      alert('Укажите производителя оборудования');
      const select = row.querySelector('[data-field="equipment_vendor"]');
      if (select) select.focus();
      return;
    }
    if (!payload.equipment_model) {
      alert('Укажите модель оборудования');
      const select = row.querySelector('[data-field="equipment_model"]');
      if (select) select.focus();
      return;
    }
    const button = row.querySelector('[data-it-equipment-action="save"]');
    const originalText = button ? button.textContent : '';
    if (button) {
      button.disabled = true;
      button.textContent = '...';
    }
    try {
      const response = await fetch(`/api/settings/it-equipment/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error((data && data.error) || 'Ошибка сохранения оборудования');
      }
      if (Array.isArray(data.items)) {
        itEquipmentItems = data.items;
      } else if (data.item) {
        const updatedId = Number.parseInt(data.item.id, 10);
        const index = itEquipmentItems.findIndex((entry) => Number.parseInt(entry.id, 10) === updatedId);
        if (index >= 0) {
          itEquipmentItems[index] = data.item;
        }
      }
      renderItEquipmentTable();
    } catch (error) {
      alert('❌ ' + (error && error.message ? error.message : error));
    } finally {
      if (button) {
        button.disabled = false;
        button.textContent = originalText || 'Сохранить';
      }
    }
  }

  async function deleteItEquipmentRow(row) {
    if (!row) return;
    const id = Number.parseInt(row.dataset.id, 10);
    if (!Number.isFinite(id)) return;
    if (!confirm('Удалить оборудование?')) return;
    const button = row.querySelector('[data-it-equipment-action="delete"]');
    const originalText = button ? button.textContent : '';
    if (button) {
      button.disabled = true;
      button.textContent = '...';
    }
    try {
      const response = await fetch(`/api/settings/it-equipment/${id}`, { method: 'DELETE' });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error((data && data.error) || 'Ошибка удаления оборудования');
      }
      itEquipmentItems = Array.isArray(data.items) ? data.items : [];
      renderItEquipmentTable();
    } catch (error) {
      alert('❌ ' + (error && error.message ? error.message : error));
    } finally {
      if (button) {
        button.disabled = false;
        button.textContent = originalText || 'Удалить';
      }
    }
  }

  async function loadItEquipment() {
    if (!itEquipmentBody) return;
    try {
      const response = await fetch('/api/settings/it-equipment');
      if (!response.ok) {
        throw new Error('Ошибка загрузки оборудования');
      }
      const data = await response.json();
      if (data && data.success === false) {
        throw new Error(data.error || 'Ошибка загрузки оборудования');
      }
      itEquipmentItems = Array.isArray(data && data.items) ? data.items : [];
      renderItEquipmentTable();
    } catch (error) {
      console.error('Ошибка загрузки каталога оборудования:', error);
    }
  }

  function addItConnectionRow(initial) {
    const defaults = {
      category: IT_CONNECTION_DEFAULT_CATEGORY,
      value: '',
      usage_count: 0,
      is_deleted: false,
    };
    const data = Object.assign({}, defaults, initial || {});
    data.category = normalizeItConnectionCategory(data.category);
    data.value = typeof data.value === 'string' ? data.value : '';
    itConnectionDrafts.push(data);
    renderItConnectionsTable();
  }

  function buildItConnectionPayload(category, value) {
    const normalizedCategory = normalizeItConnectionCategory(category);
    const trimmedValue = typeof value === 'string' ? value.trim() : '';
    const payload = {
      value: trimmedValue,
      category: normalizedCategory,
      equipment_type: '',
      equipment_vendor: '',
      equipment_model: '',
      equipment_status: '',
    };
    const mappedField = IT_CONNECTION_CATEGORY_FIELDS[normalizedCategory];
    if (mappedField === 'equipment_type') {
      payload.equipment_type = trimmedValue;
    } else if (mappedField === 'equipment_vendor') {
      payload.equipment_vendor = trimmedValue;
    } else if (mappedField === 'equipment_model') {
      payload.equipment_model = trimmedValue;
    } else if (mappedField === 'equipment_status') {
      payload.equipment_status = trimmedValue;
    }
    return payload;
  }

  function collectItConnectionPayload(row) {
    const category = normalizeItConnectionCategory(row && row.dataset ? row.dataset.category : undefined);
    const input = row ? row.querySelector('[data-field="value"]') : null;
    const value = input ? input.value : '';
    return buildItConnectionPayload(category, value);
  }

  async function saveItConnection(row, context) {
    const { isDraft, draftIndex, id } = context;
    const payload = collectItConnectionPayload(row);
    if (!payload.value) {
      alert('Необходимо указать значение подключения');
      const input = row.querySelector('[data-field="value"]');
      if (input) input.focus();
      return;
    }
    let button = row.querySelector('[data-it-connection-action="save"]');
    if (button) button.disabled = true;
    try {
      let response;
      if (isDraft || !Number.isFinite(id)) {
        response = await fetch('/api/settings/parameters', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(Object.assign({ param_type: 'it_connection' }, payload)),
        });
      } else {
        response = await fetch(`/api/settings/parameters/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
      }
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || 'Ошибка сохранения');
      }
      if (isDraft && Number.isInteger(draftIndex) && draftIndex >= 0) {
        itConnectionDrafts.splice(draftIndex, 1);
      }
      syncParameterData((data && data.data) || parameterData);
      renderParameters({ forceBodies: true });
      renderItConnectionsTable();
      if (parameterModal && parameterModalType) {
        renderParameterModal(parameterModalType);
      }
    } catch (error) {
      const message = error && error.message ? error.message : error;
      alert('❌ ' + message);
    } finally {
      if (button) button.disabled = false;
    }
  }

  async function deleteItConnection(row, context) {
    const { isDraft, draftIndex, id } = context;
    if (isDraft) {
      if (Number.isInteger(draftIndex) && draftIndex >= 0) {
        itConnectionDrafts.splice(draftIndex, 1);
        renderItConnectionsTable();
      }
      return;
    }
    if (!Number.isFinite(id)) {
      return;
    }
    if (!confirm('Удалить подключение?')) {
      return;
    }
    let button = row.querySelector('[data-it-connection-action="delete"]');
    if (button) button.disabled = true;
    try {
      const response = await fetch(`/api/settings/parameters/${id}`, { method: 'DELETE' });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || 'Ошибка удаления');
      }
      syncParameterData((data && data.data) || parameterData);
      renderParameters({ forceBodies: true });
      renderItConnectionsTable();
      if (parameterModal && parameterModalType) {
        renderParameterModal(parameterModalType);
      }
    } catch (error) {
      const message = error && error.message ? error.message : error;
      alert('❌ ' + message);
    } finally {
      if (button) button.disabled = false;
    }
  }

  async function restoreItConnection(row, id) {
    if (!Number.isFinite(id)) {
      return;
    }
    let button = row.querySelector('[data-it-connection-action="restore"]');
    if (button) button.disabled = true;
    try {
      const response = await fetch(`/api/settings/parameters/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_deleted: false }),
      });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || 'Ошибка восстановления');
      }
      syncParameterData((data && data.data) || parameterData);
      renderParameters({ forceBodies: true });
      renderItConnectionsTable();
      if (parameterModal && parameterModalType) {
        renderParameterModal(parameterModalType);
      }
    } catch (error) {
      const message = error && error.message ? error.message : error;
      alert('❌ ' + message);
    } finally {
      if (button) button.disabled = false;
    }
  }

  if (itConnectionsContainer) {
    itConnectionsContainer.addEventListener('click', (event) => {
      const button = event.target.closest('[data-it-connection-action]');
      if (!button) return;
      const action = button.dataset.itConnectionAction;
      const row = button.closest('tr');
      if (!row) return;
      const isDraft = row.dataset.rowKind === 'draft';
      const draftIndex = isDraft ? Number.parseInt(row.dataset.draftIndex, 10) : null;
      const id = !isDraft && row.dataset.id ? Number.parseInt(row.dataset.id, 10) : null;
      if (action === 'save') {
        saveItConnection(row, {
          isDraft,
          draftIndex: Number.isFinite(draftIndex) ? draftIndex : null,
          id: Number.isFinite(id) ? id : null,
        });
      } else if (action === 'delete') {
        deleteItConnection(row, {
          isDraft,
          draftIndex: Number.isFinite(draftIndex) ? draftIndex : null,
          id: Number.isFinite(id) ? id : null,
        });
      } else if (action === 'restore') {
        restoreItConnection(row, Number.isFinite(id) ? id : null);
      } else if (action === 'discard') {
        if (isDraft && Number.isFinite(draftIndex) && draftIndex >= 0) {
          itConnectionDrafts.splice(draftIndex, 1);
          renderItConnectionsTable();
        }
      }
    });
  }

  if (itEquipmentBody) {
    itEquipmentBody.addEventListener('click', (event) => {
      const linkButton = event.target.closest('[data-it-equipment-link-action]');
      if (linkButton) {
        const row = linkButton.closest('tr');
        if (!row) return;
        const action = linkButton.dataset.itEquipmentLinkAction;
        const container = row.querySelector('[data-links-container]');
        if (!container) return;
        if (action === 'add-link') {
          const item = addEquipmentLinkInput(container, '');
          const input = item ? item.querySelector('[data-link-input]') : null;
          if (input) {
            input.focus();
          }
        } else if (action === 'remove-link') {
          const item = linkButton.closest('[data-link-item]');
          if (item) {
            item.remove();
            ensureEquipmentLinksPlaceholder(container);
          }
        }
        return;
      }

      const button = event.target.closest('[data-it-equipment-action]');
      if (!button) return;
      const row = button.closest('tr');
      if (!row) return;
      const action = button.dataset.itEquipmentAction;
      if (action === 'save') {
        saveItEquipmentRow(row);
      } else if (action === 'delete') {
        deleteItEquipmentRow(row);
      }
    });
  }

  const itConnectionAddModalEl = document.getElementById('itConnectionAddModal');
  const itConnectionAddForm = itConnectionAddModalEl
    ? itConnectionAddModalEl.querySelector('[data-it-connection-add-form]')
    : null;
  if (itConnectionAddModalEl) {
    itConnectionCategorySelect = itConnectionAddModalEl.querySelector('[data-it-connection-category-select]');
  }
  const itConnectionCategoryCreateButton = itConnectionAddModalEl
    ? itConnectionAddModalEl.querySelector('[data-it-connection-category-create]')
    : null;
  const itConnectionValueInput = itConnectionAddModalEl
    ? itConnectionAddModalEl.querySelector('[data-it-connection-value-input]')
    : null;
  const itConnectionAddModal = itConnectionAddModalEl
    ? new bootstrap.Modal(itConnectionAddModalEl)
    : null;

  const itEquipmentAddModalEl = document.getElementById('itEquipmentAddModal');
  const itEquipmentAddForm = itEquipmentAddModalEl
    ? itEquipmentAddModalEl.querySelector('[data-it-equipment-add-form]')
    : null;
  const itEquipmentTypeSelect = itEquipmentAddModalEl
    ? itEquipmentAddModalEl.querySelector('#itEquipmentTypeSelect')
    : null;
  const itEquipmentVendorSelect = itEquipmentAddModalEl
    ? itEquipmentAddModalEl.querySelector('#itEquipmentVendorSelect')
    : null;
  const itEquipmentModelSelect = itEquipmentAddModalEl
    ? itEquipmentAddModalEl.querySelector('#itEquipmentModelSelect')
    : null;
  const itEquipmentAddLinksContainer = itEquipmentAddModalEl
    ? itEquipmentAddModalEl.querySelector('[data-it-equipment-add-links]')
    : null;
  const itEquipmentAddSubmitButton = itEquipmentAddForm
    ? itEquipmentAddForm.querySelector('button[type="submit"]')
    : null;
  const itEquipmentAddModal = itEquipmentAddModalEl
    ? new bootstrap.Modal(itEquipmentAddModalEl)
    : null;

  function populateItEquipmentAddOptions(selectedValues = {}) {
    const optionSets = collectEquipmentOptionSets();
    const ensureOptions = (select, values, emptyLabel, key) => {
      if (!select) return false;
      const list = Array.isArray(values) ? values : [];
      const selectedValue = selectedValues[key] || '';
      if (!list.length) {
        select.innerHTML = `<option value="" disabled selected>${escapeHtml(emptyLabel)}</option>`;
        select.disabled = true;
        select.value = '';
        select.classList.remove('is-invalid');
        return false;
      }
      select.disabled = false;
      select.innerHTML = buildEquipmentSelectOptions(list, selectedValue);
      select.value = selectedValue || '';
      select.classList.remove('is-invalid');
      return true;
    };
    const hasType = ensureOptions(
      itEquipmentTypeSelect,
      optionSets.types,
      'Добавьте тип в разделе «Подключения»',
      'equipment_type'
    );
    const hasVendor = ensureOptions(
      itEquipmentVendorSelect,
      optionSets.vendors,
      'Добавьте производителя в разделе «Подключения»',
      'equipment_vendor'
    );
    const hasModel = ensureOptions(
      itEquipmentModelSelect,
      optionSets.models,
      'Добавьте модель в разделе «Подключения»',
      'equipment_model'
    );
    return hasType && hasVendor && hasModel;
  }

  if (itEquipmentAddModalEl) {
    itEquipmentAddModalEl.addEventListener('show.bs.modal', () => {
      const hasOptions = populateItEquipmentAddOptions();
      if (itEquipmentAddLinksContainer) {
        renderEquipmentLinks(itEquipmentAddLinksContainer, []);
      }
      if (itEquipmentAddSubmitButton) {
        itEquipmentAddSubmitButton.disabled = !hasOptions;
      }
    });
    itEquipmentAddModalEl.addEventListener('shown.bs.modal', () => {
      if (itEquipmentTypeSelect && !itEquipmentTypeSelect.disabled) {
        itEquipmentTypeSelect.focus();
      } else if (itEquipmentVendorSelect && !itEquipmentVendorSelect.disabled) {
        itEquipmentVendorSelect.focus();
      } else if (itEquipmentModelSelect && !itEquipmentModelSelect.disabled) {
        itEquipmentModelSelect.focus();
      }
    });
    itEquipmentAddModalEl.addEventListener('click', (event) => {
      const addLinkButton = event.target.closest('[data-it-equipment-add-link]');
      if (addLinkButton) {
        if (itEquipmentAddLinksContainer) {
          const item = addEquipmentLinkInput(itEquipmentAddLinksContainer, '');
          const input = item ? item.querySelector('[data-link-input]') : null;
          if (input) {
            input.focus();
          }
        }
        return;
      }
      const removeButton = event.target.closest('[data-it-equipment-link-action="remove-link"]');
      if (removeButton && itEquipmentAddLinksContainer) {
        const item = removeButton.closest('[data-link-item]');
        if (item) {
          item.remove();
          ensureEquipmentLinksPlaceholder(itEquipmentAddLinksContainer);
        }
      }
    });
  }

  [itEquipmentTypeSelect, itEquipmentVendorSelect, itEquipmentModelSelect].forEach((select) => {
    if (!select) return;
    select.addEventListener('change', () => {
      select.classList.remove('is-invalid');
    });
  });

  if (itEquipmentAddForm) {
    itEquipmentAddForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const payload = {
        equipment_type:
          itEquipmentTypeSelect && !itEquipmentTypeSelect.disabled
            ? itEquipmentTypeSelect.value.trim()
            : '',
        equipment_vendor:
          itEquipmentVendorSelect && !itEquipmentVendorSelect.disabled
            ? itEquipmentVendorSelect.value.trim()
            : '',
        equipment_model:
          itEquipmentModelSelect && !itEquipmentModelSelect.disabled
            ? itEquipmentModelSelect.value.trim()
            : '',
        photo_url: formatEquipmentLinksPayload(collectEquipmentLinks(itEquipmentAddLinksContainer)),
      };

      let hasError = false;
      if (!payload.equipment_type) {
        if (itEquipmentTypeSelect) {
          itEquipmentTypeSelect.classList.add('is-invalid');
        }
        hasError = true;
      }
      if (!payload.equipment_vendor) {
        if (itEquipmentVendorSelect) {
          itEquipmentVendorSelect.classList.add('is-invalid');
        }
        hasError = true;
      }
      if (!payload.equipment_model) {
        if (itEquipmentModelSelect) {
          itEquipmentModelSelect.classList.add('is-invalid');
        }
        hasError = true;
      }

      if (hasError) {
        const firstInvalid = [
          itEquipmentTypeSelect,
          itEquipmentVendorSelect,
          itEquipmentModelSelect,
        ].find((element) => element && element.classList.contains('is-invalid'));
        if (firstInvalid) {
          firstInvalid.focus();
        }
        return;
      }

      const button = itEquipmentAddSubmitButton;
      const originalText = button ? button.textContent : '';
      if (button) {
        button.disabled = true;
        button.textContent = '...';
      }

      try {
        const response = await fetch('/api/settings/it-equipment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await response.json();
        if (!response.ok || data.success === false) {
          throw new Error((data && data.error) || 'Ошибка создания оборудования');
        }
        if (Array.isArray(data.items)) {
          itEquipmentItems = data.items;
        } else if (data.item) {
          itEquipmentItems.push(data.item);
        }
        renderItEquipmentTable();
        if (itEquipmentAddModal) {
          itEquipmentAddModal.hide();
        }
      } catch (error) {
        alert('❌ ' + (error && error.message ? error.message : error));
      } finally {
        if (button) {
          button.disabled = false;
          button.textContent = originalText || 'Добавить';
        }
      }
    });
  }

  if (itConnectionCategorySelect) {
    rebuildItConnectionCategorySelect(itConnectionCategorySelect);
  }

  if (itConnectionAddModalEl) {
    itConnectionAddModalEl.addEventListener('show.bs.modal', () => {
      rebuildItConnectionCategorySelect(itConnectionCategorySelect, IT_CONNECTION_DEFAULT_CATEGORY);
      if (itConnectionCategorySelect) {
        itConnectionCategorySelect.value = IT_CONNECTION_DEFAULT_CATEGORY;
      }
      if (itConnectionValueInput) {
        itConnectionValueInput.value = '';
        itConnectionValueInput.classList.remove('is-invalid');
      }
    });
    itConnectionAddModalEl.addEventListener('shown.bs.modal', () => {
      if (itConnectionValueInput) {
        itConnectionValueInput.focus();
      } else if (itConnectionCategorySelect) {
        itConnectionCategorySelect.focus();
      }
    });
  }

  if (itConnectionCategoryCreateButton) {
    itConnectionCategoryCreateButton.addEventListener('click', async () => {
      const promptMessage = 'Введите название новой категории подключения';
      let label = window.prompt(promptMessage);
      if (label === null) {
        return;
      }
      label = String(label).trim();
      if (!label) {
        alert('Название категории не может быть пустым');
        return;
      }
      itConnectionCategoryCreateButton.disabled = true;
      try {
        const response = await fetch('/api/settings/it-connection-categories', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ label }),
        });
        const data = await response.json();
        if (!response.ok || data.success === false) {
          throw new Error((data && data.error) || 'Ошибка создания категории');
        }
        const payload = (data && data.data) || {};
        const categories = payload.categories || {};
        const createdKey = payload.key || null;
        setItConnectionCategories(categories, { selectedKey: createdKey });
        renderItConnectionsTable();
        if (createdKey && itConnectionCategorySelect) {
          itConnectionCategorySelect.value = createdKey;
        }
        if (itConnectionValueInput) {
          itConnectionValueInput.focus();
        }
      } catch (error) {
        const message = error && error.message ? error.message : error;
        alert('❌ ' + message);
      } finally {
        itConnectionCategoryCreateButton.disabled = false;
      }
    });
  }

  if (itConnectionValueInput) {
    itConnectionValueInput.addEventListener('input', () => {
      itConnectionValueInput.classList.remove('is-invalid');
    });
  }

  if (itConnectionAddForm) {
    itConnectionAddForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const selected =
        itConnectionCategorySelect && itConnectionCategorySelect.value
          ? itConnectionCategorySelect.value
          : IT_CONNECTION_DEFAULT_CATEGORY;
      const payload = buildItConnectionPayload(selected, itConnectionValueInput ? itConnectionValueInput.value : '');
      if (!payload.value) {
        if (itConnectionValueInput) {
          itConnectionValueInput.classList.add('is-invalid');
          itConnectionValueInput.focus();
        }
        return;
      }

      const submitButton = itConnectionAddForm.querySelector('button[type="submit"]');
      const originalButtonText = submitButton ? submitButton.textContent : '';
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = '...';
      }

      try {
        const response = await fetch('/api/settings/parameters', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(Object.assign({ param_type: 'it_connection' }, payload)),
        });
        const data = await response.json();
        if (!response.ok || data.success === false) {
          throw new Error(data.error || 'Ошибка создания подключения');
        }
        if (itConnectionValueInput) {
          itConnectionValueInput.value = '';
          itConnectionValueInput.classList.remove('is-invalid');
        }
        syncParameterData((data && data.data) || parameterData);
        renderParameters({ forceBodies: true });
        renderItConnectionsTable();
        if (parameterModal && parameterModalType) {
          renderParameterModal(parameterModalType);
        }
        if (itConnectionAddModal) {
          itConnectionAddModal.hide();
        }
        setTimeout(() => {
          if (!itConnectionsContainer) return;
          const rows = Array.from(itConnectionsContainer.querySelectorAll('tr'));
          const createdRow = rows.find((row) => {
            const input = row.querySelector('[data-field="value"]');
            return input && input.value.trim() === payload.value;
          });
          if (createdRow) {
            const input = createdRow.querySelector('[data-field="value"]');
            if (input) input.focus();
          }
        }, 0);
      } catch (error) {
        const message = error && error.message ? error.message : error;
        alert('❌ ' + message);
      } finally {
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = originalButtonText;
        }
      }
    });
  }

  window.addItConnectionRow = addItConnectionRow;

  renderNetworkProfiles();
  renderItConnectionsTable();
  loadItEquipment();

  const itSectionTilesContainer = document.querySelector('[data-it-section-tiles]');

  function activateItSectionTile(targetSelector) {
    if (!itSectionTilesContainer) return;
    const tiles = Array.from(
      itSectionTilesContainer.querySelectorAll('[data-it-section-target]')
    );
    tiles.forEach((tile) => {
      const matches = tile.dataset.itSectionTarget === targetSelector;
      tile.classList.toggle('is-active', matches);
      tile.setAttribute('aria-pressed', matches ? 'true' : 'false');
    });
  }

  if (itSectionTilesContainer) {
    const tiles = Array.from(
      itSectionTilesContainer.querySelectorAll('[data-it-section-target]')
    );
    tiles.forEach((tile) => {
      if (!tile.hasAttribute('role')) {
        tile.setAttribute('role', 'button');
      }
      if (!tile.hasAttribute('tabindex')) {
        tile.setAttribute('tabindex', '0');
      }
      tile.setAttribute('aria-pressed', 'false');
    });

    const collapses = Array.from(
      document.querySelectorAll('#itSettingsAccordion .accordion-collapse')
    );

    itSectionTilesContainer.addEventListener('click', (event) => {
      const tile = event.target.closest('[data-it-section-target]');
      if (!tile) return;
      const targetSelector = tile.dataset.itSectionTarget;
      if (!targetSelector) return;
      const target = document.querySelector(targetSelector);
      if (!target) return;
      const collapse = bootstrap.Collapse.getOrCreateInstance(target, { toggle: false });
      collapse.show();
      activateItSectionTile(targetSelector);
      setTimeout(() => {
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 50);
    });

    itSectionTilesContainer.addEventListener('keydown', (event) => {
      if (event.key !== 'Enter' && event.key !== ' ') return;
      const tile = event.target.closest('[data-it-section-target]');
      if (!tile) return;
      event.preventDefault();
      tile.click();
    });

    collapses.forEach((collapseEl) => {
      collapseEl.addEventListener('shown.bs.collapse', () => {
        activateItSectionTile(`#${collapseEl.id}`);
      });
    });

    const initiallyShown = collapses.find((collapseEl) => collapseEl.classList.contains('show'));
    if (initiallyShown) {
      activateItSectionTile(`#${initiallyShown.id}`);
    }
  }

  async function loadParameters() {
    try {
      parametersLoaded = false;
      const response = await fetch('/api/settings/parameters');
      if (!response.ok) throw new Error('Ошибка загрузки параметров');
      const data = await response.json();
      syncParameterData((data && data.data) || data || parameterData);
      parametersLoaded = true;
      renderParameters({ forceBodies: true });
      renderCityCard();
      renderItConnectionsTable();
      buildLocationsTree();
      if (parameterModal && parameterModalType) {
        renderParameterModal(parameterModalType);
      }
    } catch (error) {
      parametersLoaded = false;
      console.error('Ошибка загрузки параметров:', error);
      const message = error && error.message ? error.message : error;
      alert('❌ Не удалось загрузить параметры: ' + message);
    }
  }

  async function createParameter(type, trigger) {
    const container = findParameterContainer(trigger);
    if (!container) return;
    const input = container.querySelector('[data-param-input]');
    if (!input) return;
    const value = input.value.trim();
    if (!value) {
      input.focus();
      return;
    }
    const stateSelect = container.querySelector('[data-param-state-input]');
    let serverNameInput = null;
    let serverName = '';
    if (type === 'iiko_server') {
      serverNameInput = container.querySelector('[data-param-create-field="server_name"]');
      serverName = serverNameInput ? serverNameInput.value.trim() : '';
      if (!serverName) {
        if (serverNameInput) {
          serverNameInput.focus();
        }
        alert('Поле «Имя сервера» обязательно');
        return;
      }
    }
    const payload = { param_type: type, value };
    if (stateSelect && PARAMETER_STATE_TYPES.has(type)) {
      payload.state = stateSelect.value;
    }
    if (type === 'iiko_server') {
      payload.server_name = serverName;
    }

    const originalText = trigger.textContent;
    trigger.disabled = true;
    trigger.textContent = '...';

    try {
      const response = await fetch('/api/settings/parameters', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || 'Ошибка создания параметра');
      }
      syncParameterData((data && data.data) || parameterData);
      input.value = '';
      if (serverNameInput) {
        serverNameInput.value = '';
      }
      if (stateSelect) {
        stateSelect.value = PARAMETER_STATES[0];
      }
      renderParameters({ forceBodies: true });
      renderItConnectionsTable();
      if (parameterModal && parameterModalType === type) {
        renderParameterModal(type);
      }
    } catch (error) {
      const message = error && error.message ? error.message : error;
      alert('❌ ' + message);
    } finally {
      trigger.disabled = false;
      trigger.textContent = originalText;
    }
  }

  async function updateParameterValue(id, type, trigger) {
    const entry = trigger.closest('[data-param-id]');
    if (!entry) return;
    const input = entry.querySelector('input[data-param-field="value"]');
    if (!input) return;
    const value = input.value.trim();
    if (!value) {
      alert('Значение не может быть пустым');
      input.focus();
      return;
    }
    let serverNameInput = null;
    let serverName = '';
    if (type === 'iiko_server') {
      serverNameInput = entry.querySelector('input[data-param-field="server_name"]');
      serverName = serverNameInput ? serverNameInput.value.trim() : '';
      if (!serverName) {
        alert('Имя сервера обязательно');
        if (serverNameInput) {
          serverNameInput.focus();
        }
        return;
      }
    }

    trigger.disabled = true;

    try {
      const payload = { value };
      if (type === 'iiko_server') {
        payload.server_name = serverName;
      }
      const response = await fetch(`/api/settings/parameters/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || 'Ошибка сохранения');
      }
      syncParameterData((data && data.data) || parameterData);
      renderParameters({ forceBodies: true });
      renderItConnectionsTable();
      if (parameterModal && parameterModalType === type) {
        renderParameterModal(type);
      }
    } catch (error) {
      const message = error && error.message ? error.message : error;
      alert('❌ ' + message);
    } finally {
      trigger.disabled = false;
    }
  }

  async function updateParameterState(id, type, select) {
    const previous = select.dataset.paramCurrentState || select.value;
    select.disabled = true;

    try {
      const response = await fetch(`/api/settings/parameters/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ state: select.value })
      });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || 'Ошибка сохранения состояния');
      }
      syncParameterData((data && data.data) || parameterData);
      renderParameters({ forceBodies: true });
      if (parameterModal && parameterModalType === type) {
      renderItConnectionsTable();
        renderParameterModal(type);
      }
      select.dataset.paramCurrentState = select.value;
    } catch (error) {
      const message = error && error.message ? error.message : error;
      alert('❌ ' + message);
      select.value = previous;
    } finally {
      select.disabled = false;
    }
  }

  async function deleteParameter(id, type, trigger) {
    const confirmations = [
      'Удалить значение?',
      'Подтвердите: запись будет помечена как удалённая.',
      'Последнее подтверждение перед удалением. Продолжить?'
    ];
    for (const message of confirmations) {
      if (!confirm(message)) {
        return;
      }
    }

    trigger.disabled = true;

    try {
      const response = await fetch(`/api/settings/parameters/${id}`, {
        method: 'DELETE'
      });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || 'Ошибка удаления');
      }
      syncParameterData((data && data.data) || parameterData);
      renderParameters({ forceBodies: true });
      renderItConnectionsTable();
      if (parameterModal && parameterModalType === type) {
        renderParameterModal(type);
      }
    } catch (error) {
      const message = error && error.message ? error.message : error;
      alert('❌ ' + message);
    } finally {
      trigger.disabled = false;
    }
  }

  async function restoreParameter(id, type, trigger) {
    trigger.disabled = true;
    try {
      const response = await fetch(`/api/settings/parameters/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_deleted: false })
      });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || 'Ошибка восстановления');
      }
      syncParameterData((data && data.data) || parameterData);
      renderParameters({ forceBodies: true });
      renderItConnectionsTable();
      if (parameterModal && parameterModalType === type) {
        renderParameterModal(type);
      }
    } catch (error) {
      const message = error && error.message ? error.message : error;
      alert('❌ ' + message);
    } finally {
      trigger.disabled = false;
    }
  }

  // === Управление статусами клиентов ===
  const STATUS_FILTER_BASE_URL = "{{ url_for('clients_list') }}";
  let CLIENT_STATUS_USAGE = {{ status_usage | tojson }} || {};
  const INITIAL_CLIENT_STATUSES = {{ settings.client_statuses | tojson }} || [];
  let statusEditMode = false;
  let initialStatusesSnapshot = [];

  function buildStatusFilterLink(status) {
    const value = typeof status === 'string' ? status.trim() : '';
    if (!value) return '#';
    const params = new URLSearchParams({ client_status: value });
    return `${STATUS_FILTER_BASE_URL}?${params.toString()}`;
  }

  function handleStatusInputChange(row) {
    if (!(row instanceof HTMLElement)) return;
    const input = row.querySelector('.status-input');
    const link = row.querySelector('.status-count-link');
    if (!(input instanceof HTMLInputElement) || !(link instanceof HTMLAnchorElement)) return;

    const value = input.value.trim();
    const original = row.dataset.originalValue || '';
    const baseCount = Number(row.dataset.count || 0);
    let displayCount = baseCount;

    if (!value) {
      link.textContent = '0';
      link.href = '#';
      link.classList.add('disabled');
      return;
    }

    if (value !== original) {
      displayCount = 0;
    }

    link.textContent = String(displayCount);
    link.href = buildStatusFilterLink(value);
    link.classList.toggle('disabled', statusEditMode);
  }

  function buildStatusRow(status) {
    const container = document.createElement('div');
    container.className = 'list-group-item d-flex align-items-center gap-2 status-row';
    const value = typeof status === 'string' ? status : '';
    const count = Number((CLIENT_STATUS_USAGE && CLIENT_STATUS_USAGE[value]) || 0);
    container.dataset.originalValue = value;
    container.dataset.count = String(count);

    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'form-control status-input';
    input.value = value;
    input.disabled = !statusEditMode;
    input.placeholder = 'Новый статус';
    input.addEventListener('input', () => handleStatusInputChange(container));
    container.appendChild(input);

    const badge = document.createElement('a');
    badge.className = 'status-count-link';
    badge.dataset.statusCount = 'true';
    badge.title = value ? `Клиентов со статусом «${value}»` : 'Клиентов с этим статусом';
    badge.href = buildStatusFilterLink(value);
    badge.textContent = String(count);
    if (!value || statusEditMode) {
      badge.classList.add('disabled');
    }
    container.appendChild(badge);

    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-outline-danger btn-sm';
    removeBtn.textContent = 'Удалить';
    if (!statusEditMode) {
      removeBtn.classList.add('d-none');
    }
    removeBtn.dataset.statusRemove = 'true';
    removeBtn.addEventListener('click', () => removeStatus(removeBtn));
    container.appendChild(removeBtn);

    handleStatusInputChange(container);
    return container;
  }

  function renderStatusesList(statuses) {
    const list = document.getElementById('statusesList');
    const placeholder = document.getElementById('statusesEmptyPlaceholder');
    if (!list) return;
    list.innerHTML = '';
    const items = Array.isArray(statuses) ? statuses : [];
    if (!items.length) {
      if (placeholder) placeholder.classList.remove('d-none');
      return;
    }
    if (placeholder) placeholder.classList.add('d-none');
    items.forEach((status) => {
      const row = buildStatusRow(status);
      list.appendChild(row);
    });
  }

  function updateStatusesEmptyState() {
    const list = document.getElementById('statusesList');
    const placeholder = document.getElementById('statusesEmptyPlaceholder');
    if (!list || !placeholder) return;
    const hasRows = Boolean(list.querySelector('.status-row'));
    placeholder.classList.toggle('d-none', hasRows);
  }

  function collectStatuses() {
    return Array.from(document.querySelectorAll('#statusesList .status-input'))
      .map((input) => input.value.trim())
      .filter((value) => Boolean(value));
  }

  function setStatusesEditMode(enable, { restoreSnapshot = false } = {}) {
    statusEditMode = Boolean(enable);
    const editBtn = document.getElementById('editStatusesBtn');
    const saveBtn = document.getElementById('saveStatusesBtn');
    const cancelBtn = document.getElementById('cancelStatusesBtn');
    const addBtn = document.getElementById('addStatusBtn');

    if (editBtn) editBtn.classList.toggle('d-none', statusEditMode);
    if (saveBtn) saveBtn.classList.toggle('d-none', !statusEditMode);
    if (cancelBtn) cancelBtn.classList.toggle('d-none', !statusEditMode);
    if (addBtn) addBtn.classList.toggle('d-none', !statusEditMode);

    if (!statusEditMode && restoreSnapshot) {
      renderStatusesList(initialStatusesSnapshot);
    }

    document.querySelectorAll('#statusesList .status-row').forEach((row) => {
      const input = row.querySelector('.status-input');
      const removeBtn = row.querySelector('[data-status-remove]');
      const badge = row.querySelector('.status-count-link');
      if (input instanceof HTMLInputElement) {
        input.disabled = !statusEditMode;
      }
      if (removeBtn instanceof HTMLElement) {
        removeBtn.classList.toggle('d-none', !statusEditMode);
      }
      if (badge instanceof HTMLElement) {
        badge.classList.toggle('disabled', statusEditMode || !(input?.value.trim()));
      }
      handleStatusInputChange(row);
    });
  }

  function startStatusesEdit() {
    initialStatusesSnapshot = collectStatuses();
    setStatusesEditMode(true);
  }

  function cancelStatusesEdit() {
    setStatusesEditMode(false, { restoreSnapshot: true });
  }

  function addStatus() {
    if (!statusEditMode) return;
    const list = document.getElementById('statusesList');
    if (!list) return;
    const row = buildStatusRow('');
    row.dataset.originalValue = '';
    row.dataset.count = '0';
    list.appendChild(row);
    updateStatusesEmptyState();
    const input = row.querySelector('.status-input');
    if (input instanceof HTMLInputElement) {
      setTimeout(() => input.focus(), 0);
    }
  }

  function removeStatus(trigger) {
    const row = trigger?.closest('.status-row');
    if (row) {
      row.remove();
      updateStatusesEmptyState();
    }
  }

  function syncStatusUsage(statuses) {
    const usage = {};
    const currentUsage = CLIENT_STATUS_USAGE || {};
    statuses.forEach((status) => {
      if (Object.prototype.hasOwnProperty.call(currentUsage, status)) {
        usage[status] = currentUsage[status];
      } else {
        usage[status] = 0;
      }
    });
    CLIENT_STATUS_USAGE = usage;
  }

  async function saveClientStatuses() {
    const saveBtn = document.getElementById('saveStatusesBtn');
    const statuses = collectStatuses();
    if (!statuses.length) {
      if (confirm('Список статусов пуст. Сохранить и удалить все статусы?')) {
        // proceed
      } else {
        return;
      }
    }
    if (saveBtn) saveBtn.disabled = true;
    try {
      const response = await fetch('/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ client_statuses: statuses })
      });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || 'Не удалось сохранить статусы');
      }
      syncStatusUsage(statuses);
      renderStatusesList(statuses);
      setStatusesEditMode(false);
      alert('✅ Статусы клиентов сохранены');
    } catch (error) {
      const message = error && error.message ? error.message : String(error);
      alert('❌ Ошибка: ' + message);
    } finally {
      if (saveBtn) saveBtn.disabled = false;
    }
  }

  function initClientStatuses() {
    renderStatusesList(Array.isArray(INITIAL_CLIENT_STATUSES) ? INITIAL_CLIENT_STATUSES : []);
    updateStatusesEmptyState();
    setStatusesEditMode(false);
  }

  // === Инициализация управления доступом ===
  document.addEventListener('DOMContentLoaded', () => {
    const usersModalEl = document.getElementById('usersModal');
    if (!usersModalEl) {
      return;
    }

    usersModalEl.addEventListener('shown.bs.modal', () => {
      const container = usersModalEl.querySelector('[data-auth-management]');
      if (!container || !window.AuthManagement) {
        console.error('Модуль управления доступом недоступен.');
        return;
      }
      if (!container.__authManager) {
        container.__authManager = window.AuthManagement.mount(container);
      } else {
        container.__authManager.refresh();
      }
    });

    usersModalEl.addEventListener('hidden.bs.modal', () => {
      const container = usersModalEl.querySelector('[data-auth-management]');
      const manager = container && container.__authManager;
      if (manager) {
        manager.resetPasswords();
        manager.clearMessage();
      }
    });
  });

  // === JavaScript для редактирования структуры локаций ===
  const LOCATION_STATUS_OPTIONS = [
    'Активен',
    'Закрыт',
    'Готовится к запуску',
    'Приостановлен',
    'Заморожен',
  ];
  const DEFAULT_LOCATION_STATUS = LOCATION_STATUS_OPTIONS[0];
  const LOCATION_STATUS_CLASS_MAP = {
    Активен: 'status-active',
    Закрыт: 'status-closed',
    'Готовится к запуску': 'status-prelaunch',
    Приостановлен: 'status-paused',
    Заморожен: 'status-frozen',
  };
  const LOCATION_STATUS_DEFAULT_CLASS = 'status-default';
  const EDIT_ICON_HTML = '<i class="bi bi-pencil"></i>';
  const SAVE_ICON_HTML = '<i class="bi bi-check-lg"></i>';
  const DELETE_ICON_HTML = '<i class="bi bi-trash"></i>';
  const LOCATIONS_INITIAL = {{ locations | tojson }};

  function sanitizeStatusesMap(source) {
    const result = {};
    if (!source || typeof source !== 'object') {
      return result;
    }
    Object.entries(source).forEach(([key, value]) => {
      if (typeof key !== 'string') return;
      const raw = typeof value === 'string' ? value.trim() : '';
      result[key] = LOCATION_STATUS_OPTIONS.includes(raw) ? raw : DEFAULT_LOCATION_STATUS;
    });
    return result;
  }

  function sortObjectAlphabetically(obj) {
    if (!obj || typeof obj !== 'object') {
      return {};
    }
    return Object.keys(obj)
      .sort((a, b) => a.localeCompare(b))
      .reduce((sorted, key) => {
        sorted[key] = obj[key];
        return sorted;
      }, {});
  }

  function sortArrayAlphabetically(arr) {
    return Array.isArray(arr) ? arr.slice().sort((a, b) => a.localeCompare(b)) : [];
  }

  function normalizeLocationTree(tree) {
    if (!tree || typeof tree !== 'object') {
      return {};
    }
    const normalized = {};
    Object.keys(tree)
      .sort((a, b) => a.localeCompare(b))
      .forEach((business) => {
        const types = tree[business];
        if (!types || typeof types !== 'object') {
          normalized[business] = {};
          return;
        }
        const sortedTypes = {};
        Object.keys(types)
          .sort((a, b) => a.localeCompare(b))
          .forEach((type) => {
            const cities = types[type];
            if (Array.isArray(cities)) {
              sortedTypes[type] = sortArrayAlphabetically(cities);
            } else if (cities && typeof cities === 'object') {
              const sortedCities = {};
              Object.keys(cities)
                .sort((a, b) => a.localeCompare(b))
                .forEach((city) => {
                  sortedCities[city] = sortArrayAlphabetically(cities[city]);
                });
              sortedTypes[type] = sortedCities;
            } else {
              sortedTypes[type] = {};
            }
          });
        normalized[business] = sortedTypes;
      });
    return normalized;
  }

  let locationsState = {
    tree:
      LOCATIONS_INITIAL &&
      typeof LOCATIONS_INITIAL === 'object' &&
      LOCATIONS_INITIAL.tree &&
      typeof LOCATIONS_INITIAL.tree === 'object'
        ? normalizeLocationTree(LOCATIONS_INITIAL.tree)
        : normalizeLocationTree(LOCATIONS_INITIAL || {}),
    statuses: sanitizeStatusesMap(
      LOCATIONS_INITIAL && typeof LOCATIONS_INITIAL === 'object' ? LOCATIONS_INITIAL.statuses : {}
    ),
  };

  function hashString(value) {
    if (typeof value !== 'string') return 0;
    let hash = 0;
    for (let i = 0; i < value.length; i += 1) {
      hash = (hash << 5) - hash + value.charCodeAt(i);
      hash |= 0;
    }
    return Math.abs(hash);
  }

  function businessCollapseIdFor(business) {
    return `collapse-business-${hashString(business)}`;
  }

  function typeCollapseIdFor(business, type) {
    return `collapse-${hashString(business)}-${hashString(type)}`;
  }

  function cityCollapseIdFor(business, type, city) {
    return `collapse-${hashString(business)}-${hashString(type)}-${hashString(city)}`;
  }

  function makeStatusKey(level, ...parts) {
    return [level].concat(parts).join('::');
  }

  function getStatus(level, ...parts) {
    const key = makeStatusKey(level, ...parts);
    const stored = locationsState.statuses && locationsState.statuses[key];
    if (typeof stored === 'string' && LOCATION_STATUS_OPTIONS.includes(stored)) {
      return stored;
    }
    return DEFAULT_LOCATION_STATUS;
  }

  function setStatus(level, parts, status) {
    const resolved = LOCATION_STATUS_OPTIONS.includes(status) ? status : DEFAULT_LOCATION_STATUS;
    const key = makeStatusKey(level, ...parts);
    locationsState.statuses[key] = resolved;
  }

  function renameStatusEntries(level, context, oldName, newName) {
    if (!oldName || oldName === newName) {
      return;
    }
    const updates = [];
    Object.keys(locationsState.statuses || {}).forEach((key) => {
      const parts = key.split('::');
      const kind = parts[0];
      if (level === 'business') {
        if (parts[1] === oldName) {
          parts[1] = newName;
          updates.push([key, parts.join('::')]);
        }
      } else if (level === 'type') {
        if (
          ['type', 'city', 'location'].includes(kind) &&
          parts[1] === context.business &&
          parts[2] === oldName
        ) {
          parts[2] = newName;
          updates.push([key, parts.join('::')]);
        }
      } else if (level === 'city') {
        if (
          ['city', 'location'].includes(kind) &&
          parts[1] === context.business &&
          parts[2] === context.type &&
          parts[3] === oldName
        ) {
          parts[3] = newName;
          updates.push([key, parts.join('::')]);
        }
      } else if (level === 'location') {
        if (
          kind === 'location' &&
          parts[1] === context.business &&
          parts[2] === context.type &&
          parts[3] === context.city &&
          parts[4] === oldName
        ) {
          parts[4] = newName;
          updates.push([key, parts.join('::')]);
        }
      }
    });
    updates.forEach(([oldKey, newKey]) => {
      locationsState.statuses[newKey] = locationsState.statuses[oldKey];
      if (oldKey !== newKey) {
        delete locationsState.statuses[oldKey];
      }
    });
  }

  function removeStatusEntries(level, context, targetName) {
    Object.keys(locationsState.statuses || {}).forEach((key) => {
      const parts = key.split('::');
      const kind = parts[0];
      let shouldDelete = false;
      if (level === 'business') {
        shouldDelete = parts[1] === targetName;
      } else if (level === 'type') {
        shouldDelete =
          ['type', 'city', 'location'].includes(kind) &&
          parts[1] === context.business &&
          parts[2] === targetName;
      } else if (level === 'city') {
        shouldDelete =
          ['city', 'location'].includes(kind) &&
          parts[1] === context.business &&
          parts[2] === context.type &&
          parts[3] === targetName;
      } else if (level === 'location') {
        shouldDelete =
          kind === 'location' &&
          parts[1] === context.business &&
          parts[2] === context.type &&
          parts[3] === context.city &&
          parts[4] === targetName;
      }
      if (shouldDelete) {
        delete locationsState.statuses[key];
      }
    });
  }

  function createStatusSelect(level, parts) {
    const select = document.createElement('select');
    select.className = 'form-select form-select-sm location-status-select';
    select.setAttribute('data-no-toggle', 'true');
    LOCATION_STATUS_OPTIONS.forEach((option) => {
      const opt = document.createElement('option');
      opt.value = option;
      opt.textContent = option;
      select.appendChild(opt);
    });
    select.value = getStatus(level, ...parts);
    select.disabled = true;
    return select;
  }

  function applyStatusStyle(element, status) {
    if (!element) return;
    const classesToRemove = new Set(Object.values(LOCATION_STATUS_CLASS_MAP));
    classesToRemove.add(LOCATION_STATUS_DEFAULT_CLASS);
    classesToRemove.forEach((cls) => {
      if (cls) {
        element.classList.remove(cls);
      }
    });
    const targetClass = LOCATION_STATUS_CLASS_MAP[status] || LOCATION_STATUS_DEFAULT_CLASS;
    if (targetClass) {
      element.classList.add(targetClass);
    }
  }

  function attachHeaderToggle(element, toggler) {
    if (!element) return;
    element.addEventListener('click', (event) => {
      if (event.target.closest('[data-no-toggle]')) {
        return;
      }
      if (typeof toggler === 'function') {
        toggler();
      }
    });
  }

  function configureEditControls({ input, statusSelect, editButton, deleteButton, onSubmit, onReset }) {
    const fields = [];
    if (input) {
      input.disabled = true;
      input.setAttribute('data-no-toggle', 'true');
      input.dataset.originalValue = input.value;
      fields.push(input);
    }
    if (statusSelect) {
      statusSelect.disabled = true;
      statusSelect.dataset.originalValue = statusSelect.value;
      fields.push(statusSelect);
    }
    if (!editButton) {
      return;
    }
    editButton.dataset.mode = 'view';
    editButton.setAttribute('data-no-toggle', 'true');
    editButton.innerHTML = EDIT_ICON_HTML;
    editButton.title = 'Редактировать';

    if (deleteButton) {
      deleteButton.disabled = true;
      deleteButton.setAttribute('data-no-toggle', 'true');
    }

    const enterEdit = () => {
      fields.forEach((field) => {
        field.disabled = false;
      });
      editButton.dataset.mode = 'edit';
      editButton.innerHTML = SAVE_ICON_HTML;
      editButton.title = 'Сохранить';
      editButton.classList.remove('btn-outline-secondary');
      editButton.classList.add('btn-outline-success');
      if (deleteButton) {
        deleteButton.disabled = false;
      }
      if (input) {
        input.focus();
        input.select();
      }
    };

    const exitEdit = () => {
      fields.forEach((field) => {
        field.disabled = true;
      });
      editButton.dataset.mode = 'view';
      editButton.innerHTML = EDIT_ICON_HTML;
      editButton.title = 'Редактировать';
      editButton.classList.remove('btn-outline-success');
      editButton.classList.add('btn-outline-secondary');
      if (deleteButton) {
        deleteButton.disabled = true;
      }
    };

    const resetFields = () => {
      if (typeof onReset === 'function') {
        onReset();
        return;
      }
      if (input) {
        input.value = input.dataset.originalValue || input.value;
      }
      if (statusSelect) {
        statusSelect.value = statusSelect.dataset.originalValue || statusSelect.value;
      }
    };

    const applySubmit = () => {
      if (typeof onSubmit !== 'function') {
        exitEdit();
        return;
      }
      const nameValue = input ? (input.value || '').trim() : '';
      const statusValue = statusSelect ? statusSelect.value : undefined;
      const result = onSubmit(nameValue, { status: statusValue });
      if (result === false) {
        return;
      }
      if (input) {
        input.dataset.originalValue = input.value;
      }
      if (statusSelect) {
        statusSelect.dataset.originalValue = statusSelect.value;
      }
      exitEdit();
    };

    editButton.addEventListener('click', () => {
      if (editButton.dataset.mode === 'edit') {
        applySubmit();
      } else {
        enterEdit();
      }
    });

    if (input) {
      input.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          applySubmit();
        } else if (event.key === 'Escape') {
          event.preventDefault();
          resetFields();
          exitEdit();
        }
      });
    }

    if (statusSelect) {
      statusSelect.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          event.preventDefault();
          resetFields();
          exitEdit();
        }
      });
    }
  }

  function confirmMultipleTimes(message, attempts = 3) {
    const total = Number.isFinite(Number(attempts)) && attempts > 0 ? Math.ceil(attempts) : 1;
    for (let i = 1; i <= total; i += 1) {
      const suffix = total > 1 ? `\nПодтвердите действие (${i}/${total})` : '';
      if (!confirm(`${message}${suffix}`)) {
        return false;
      }
    }
    return true;
  }

  function buildLocationsTree() {
    const container = document.getElementById('locationsEditor');
    if (!container) return;

    locationsState.tree = normalizeLocationTree(locationsState.tree);
    container.innerHTML = '';

    const tree = locationsState.tree || {};
    const businessNames = Object.keys(tree);
    if (!businessNames.length) {
      const placeholder = document.createElement('div');
      placeholder.className = 'text-muted';
      placeholder.textContent = 'Пока нет записей';
      container.appendChild(placeholder);
      return;
    }

    businessNames.forEach((businessName) => {
      const partnerTypes = tree[businessName] || {};
      const businessCard = document.createElement('div');
      businessCard.className = 'location-tree-business card shadow-sm mb-3';

      const cardBody = document.createElement('div');
      cardBody.className = 'card-body';

      const businessCollapseId = businessCollapseIdFor(businessName);
      const businessHeader = document.createElement('div');
      businessHeader.className = 'location-section-header location-structure-row flex-wrap mb-3';

      const businessInput = document.createElement('input');
      businessInput.type = 'text';
      businessInput.className = 'form-control form-control-sm location-name-input';
      businessInput.value = businessName;

      const businessStatus = createStatusSelect('business', [businessName]);

      const businessActions = document.createElement('div');
      businessActions.className = 'location-actions';
      businessActions.setAttribute('data-no-toggle', 'true');

      const businessEditBtn = document.createElement('button');
      businessEditBtn.type = 'button';
      businessEditBtn.className = 'btn btn-sm btn-outline-secondary btn-icon';
      businessEditBtn.innerHTML = EDIT_ICON_HTML;
      businessEditBtn.title = 'Редактировать';

      const deleteBusinessBtn = document.createElement('button');
      deleteBusinessBtn.type = 'button';
      deleteBusinessBtn.className = 'btn btn-sm btn-outline-danger btn-icon';
      deleteBusinessBtn.innerHTML = DELETE_ICON_HTML;
      deleteBusinessBtn.title = 'Удалить бизнес';
      deleteBusinessBtn.disabled = true;
      deleteBusinessBtn.setAttribute('data-no-toggle', 'true');
      deleteBusinessBtn.addEventListener('click', () => removeBusiness(businessName));

      businessActions.appendChild(businessEditBtn);
      businessActions.appendChild(deleteBusinessBtn);

      businessHeader.appendChild(businessStatus);
      businessHeader.appendChild(businessInput);
      businessHeader.appendChild(businessActions);
      cardBody.appendChild(businessHeader);
      attachHeaderToggle(businessHeader, () => {
        const collapseEl = document.getElementById(businessCollapseId);
        if (!collapseEl) return;
        const instance = bootstrap.Collapse.getOrCreateInstance(collapseEl, { toggle: false });
        instance.toggle();
      });

      const updateBusinessAppearance = () => applyStatusStyle(businessHeader, businessStatus.value);
      businessStatus.addEventListener('change', updateBusinessAppearance);
      updateBusinessAppearance();

      configureEditControls({
        input: businessInput,
        statusSelect: businessStatus,
        editButton: businessEditBtn,
        deleteButton: deleteBusinessBtn,
        onReset: () => {
          businessInput.value = businessName;
          businessStatus.value = getStatus('business', businessName);
          updateBusinessAppearance();
        },
        onSubmit: (newName, meta) => updateBusiness(businessName, newName || businessName, meta.status),
      });

      const collapse = document.createElement('div');
      collapse.className = 'collapse show location-type-body mt-2';
      collapse.id = businessCollapseId;

      const typesContainer = document.createElement('div');
      const typeNames = Object.keys(partnerTypes);

      if (!typeNames.length) {
        const emptyType = document.createElement('div');
        emptyType.className = 'text-muted small';
        emptyType.textContent = 'Нет типов для бизнеса';
        typesContainer.appendChild(emptyType);
      }

      typeNames.forEach((typeName) => {
        const currentTypeName = typeName;
        const collapseId = typeCollapseIdFor(businessName, currentTypeName);
        const typeBlock = document.createElement('div');
        typeBlock.className = 'location-type-block mb-3';

        const typeHeader = document.createElement('div');
        typeHeader.className = 'location-section-header location-structure-row flex-wrap';

        const typeInput = document.createElement('input');
        typeInput.type = 'text';
        typeInput.className = 'form-control form-control-sm location-name-input';
        typeInput.value = currentTypeName;

        const typeStatus = createStatusSelect('type', [businessName, currentTypeName]);

        const typeActions = document.createElement('div');
        typeActions.className = 'location-actions';
        typeActions.setAttribute('data-no-toggle', 'true');

        const typeEditBtn = document.createElement('button');
        typeEditBtn.type = 'button';
        typeEditBtn.className = 'btn btn-sm btn-outline-secondary btn-icon';
        typeEditBtn.innerHTML = EDIT_ICON_HTML;
        typeEditBtn.title = 'Редактировать';

        const deleteTypeBtn = document.createElement('button');
        deleteTypeBtn.type = 'button';
        deleteTypeBtn.className = 'btn btn-sm btn-outline-danger btn-icon';
        deleteTypeBtn.innerHTML = DELETE_ICON_HTML;
        deleteTypeBtn.title = 'Удалить тип';
        deleteTypeBtn.disabled = true;
        deleteTypeBtn.setAttribute('data-no-toggle', 'true');
        deleteTypeBtn.addEventListener('click', () => removeType(businessName, currentTypeName));

        typeActions.appendChild(typeEditBtn);
        typeActions.appendChild(deleteTypeBtn);

        typeHeader.appendChild(typeStatus);
        typeHeader.appendChild(typeInput);
        typeHeader.appendChild(typeActions);
        attachHeaderToggle(typeHeader, () => {
          const el = document.getElementById(collapseId);
          if (!el) return;
          const instance = bootstrap.Collapse.getOrCreateInstance(el, { toggle: false });
          instance.toggle();
        });

        const updateTypeAppearance = () => applyStatusStyle(typeHeader, typeStatus.value);
        typeStatus.addEventListener('change', updateTypeAppearance);
        updateTypeAppearance();

        configureEditControls({
          input: typeInput,
          statusSelect: typeStatus,
          editButton: typeEditBtn,
          deleteButton: deleteTypeBtn,
          onReset: () => {
            typeInput.value = currentTypeName;
            typeStatus.value = getStatus('type', businessName, currentTypeName);
            updateTypeAppearance();
          },
          onSubmit: (newName, meta) =>
            updateType(businessName, currentTypeName, newName || currentTypeName, meta.status),
        });

        const collapseEl = document.createElement('div');
        collapseEl.className = 'collapse location-type-body mt-2';
        collapseEl.id = collapseId;

        const cityContainer = document.createElement('div');
        const cities = partnerTypes[currentTypeName] || {};
        const cityNames = Object.keys(cities);

        if (!cityNames.length) {
          const emptyCities = document.createElement('div');
          emptyCities.className = 'text-muted small mb-2';
          emptyCities.textContent = 'Нет городов';
          cityContainer.appendChild(emptyCities);
        }

        cityNames.forEach((cityName) => {
          const currentCityName = cityName;
          const cityBlock = document.createElement('div');
          cityBlock.className = 'location-city-block mb-3';

          const cityCollapseId = cityCollapseIdFor(businessName, currentTypeName, currentCityName);

          const cityHeader = document.createElement('div');
          cityHeader.className = 'location-section-header location-structure-row flex-wrap mb-2';

          const cityInput = document.createElement('input');
          cityInput.type = 'text';
          cityInput.className = 'form-control form-control-sm location-name-input';
          cityInput.value = currentCityName;

          const cityStatus = createStatusSelect('city', [businessName, currentTypeName, currentCityName]);

          const cityActions = document.createElement('div');
          cityActions.className = 'location-actions';
          cityActions.setAttribute('data-no-toggle', 'true');

          const cityEditBtn = document.createElement('button');
          cityEditBtn.type = 'button';
          cityEditBtn.className = 'btn btn-sm btn-outline-secondary btn-icon';
          cityEditBtn.innerHTML = EDIT_ICON_HTML;
          cityEditBtn.title = 'Редактировать';

          const deleteCityBtn = document.createElement('button');
          deleteCityBtn.type = 'button';
          deleteCityBtn.className = 'btn btn-sm btn-outline-danger btn-icon';
          deleteCityBtn.innerHTML = DELETE_ICON_HTML;
          deleteCityBtn.title = 'Удалить город';
          deleteCityBtn.disabled = true;
          deleteCityBtn.setAttribute('data-no-toggle', 'true');
          deleteCityBtn.addEventListener('click', () => removeCity(businessName, currentTypeName, currentCityName));

          cityActions.appendChild(cityEditBtn);
          cityActions.appendChild(deleteCityBtn);

          cityHeader.appendChild(cityStatus);
          cityHeader.appendChild(cityInput);
          cityHeader.appendChild(cityActions);
          attachHeaderToggle(cityHeader, () => {
            const el = document.getElementById(cityCollapseId);
            if (!el) return;
            const instance = bootstrap.Collapse.getOrCreateInstance(el, { toggle: false });
            instance.toggle();
          });

          const updateCityAppearance = () => applyStatusStyle(cityHeader, cityStatus.value);
          cityStatus.addEventListener('change', updateCityAppearance);
          updateCityAppearance();

          configureEditControls({
            input: cityInput,
            statusSelect: cityStatus,
            editButton: cityEditBtn,
            deleteButton: deleteCityBtn,
            onReset: () => {
              cityInput.value = currentCityName;
              cityStatus.value = getStatus('city', businessName, currentTypeName, currentCityName);
              updateCityAppearance();
            },
            onSubmit: (newName, meta) =>
              updateCity(
                businessName,
                currentTypeName,
                currentCityName,
                newName || currentCityName,
                meta.status
              ),
          });

          const cityCollapse = document.createElement('div');
          cityCollapse.className = 'collapse location-city-collapse';
          cityCollapse.id = cityCollapseId;

          const cityBody = document.createElement('div');
          cityBody.className = 'location-city-body';

          const cityLocations = Array.isArray(cities[currentCityName]) ? cities[currentCityName] : [];
          if (!cityLocations.length) {
            const emptyLocations = document.createElement('div');
            emptyLocations.className = 'text-muted small mb-2';
            emptyLocations.textContent = 'Нет локаций';
            cityBody.appendChild(emptyLocations);
          } else {
            cityLocations.forEach((locationName) => {
              const currentLocationName = locationName;
              const locationRow = document.createElement('div');
              locationRow.className = 'location-entry-row location-structure-row flex-wrap mb-2';

              const locationInput = document.createElement('input');
              locationInput.type = 'text';
              locationInput.className = 'form-control form-control-sm location-name-input';
              locationInput.value = currentLocationName;

              const locationStatus = createStatusSelect('location', [
                businessName,
                currentTypeName,
                currentCityName,
                currentLocationName,
              ]);

              const locationActions = document.createElement('div');
              locationActions.className = 'location-actions';
              locationActions.setAttribute('data-no-toggle', 'true');

              const locationEditBtn = document.createElement('button');
              locationEditBtn.type = 'button';
              locationEditBtn.className = 'btn btn-sm btn-outline-secondary btn-icon';
              locationEditBtn.innerHTML = EDIT_ICON_HTML;
              locationEditBtn.title = 'Редактировать';
              locationEditBtn.setAttribute('data-no-toggle', 'true');

              const deleteLocationBtn = document.createElement('button');
              deleteLocationBtn.type = 'button';
              deleteLocationBtn.className = 'btn btn-sm btn-outline-danger btn-icon';
              deleteLocationBtn.innerHTML = DELETE_ICON_HTML;
              deleteLocationBtn.title = 'Удалить локацию';
              deleteLocationBtn.disabled = true;
              deleteLocationBtn.setAttribute('data-no-toggle', 'true');
              deleteLocationBtn.addEventListener('click', () =>
                removeLocation(businessName, currentTypeName, currentCityName, currentLocationName)
              );

              locationActions.appendChild(locationEditBtn);
              locationActions.appendChild(deleteLocationBtn);

              locationRow.appendChild(locationStatus);
              locationRow.appendChild(locationInput);
              locationRow.appendChild(locationActions);

              configureEditControls({
                input: locationInput,
                statusSelect: locationStatus,
                editButton: locationEditBtn,
                deleteButton: deleteLocationBtn,
                onReset: () => {
                  locationInput.value = currentLocationName;
                  locationStatus.value = getStatus(
                    'location',
                    businessName,
                    currentTypeName,
                    currentCityName,
                    currentLocationName
                  );
                  updateLocationAppearance();
                },
                onSubmit: (newName, meta) =>
                  updateLocation(
                    businessName,
                    currentTypeName,
                    currentCityName,
                    currentLocationName,
                    newName || currentLocationName,
                    meta.status
                  ),
              });

              const updateLocationAppearance = () => applyStatusStyle(locationRow, locationStatus.value);
              locationStatus.addEventListener('change', updateLocationAppearance);
              updateLocationAppearance();

              cityBody.appendChild(locationRow);
            });
          }

          const addLocationBtn = document.createElement('button');
          addLocationBtn.type = 'button';
          addLocationBtn.className = 'btn btn-sm btn-outline-success';
          addLocationBtn.textContent = '+ Локация';
          addLocationBtn.setAttribute('data-no-toggle', 'true');
          addLocationBtn.addEventListener('click', () =>
            addLocation(businessName, currentTypeName, currentCityName)
          );

          cityBody.appendChild(addLocationBtn);
          cityCollapse.appendChild(cityBody);
          cityBlock.appendChild(cityHeader);
          cityBlock.appendChild(cityCollapse);
          cityContainer.appendChild(cityBlock);
        });

        const addCityBtn = document.createElement('button');
        addCityBtn.type = 'button';
        addCityBtn.className = 'btn btn-sm btn-outline-success';
        addCityBtn.textContent = '+ Город';
        addCityBtn.setAttribute('data-no-toggle', 'true');
        addCityBtn.addEventListener('click', () => addCityToType(businessName, currentTypeName));

        collapseEl.appendChild(cityContainer);
        collapseEl.appendChild(addCityBtn);

        typeBlock.appendChild(typeHeader);
        typeBlock.appendChild(collapseEl);
        typesContainer.appendChild(typeBlock);
      });

      const addTypeBtn = document.createElement('button');
      addTypeBtn.type = 'button';
      addTypeBtn.className = 'btn btn-sm btn-outline-success';
      addTypeBtn.textContent = '+ Тип';
      addTypeBtn.setAttribute('data-no-toggle', 'true');
      addTypeBtn.addEventListener('click', () => addTypeToBusiness(businessName));

      collapse.appendChild(typesContainer);
      collapse.appendChild(addTypeBtn);
      cardBody.appendChild(collapse);
      businessCard.appendChild(cardBody);
      container.appendChild(businessCard);
    });
  }

  function updateBusiness(oldName, newName, statusValue) {
    const tree = locationsState.tree || {};
    const currentName = (oldName || '').trim();
    if (!currentName || !Object.prototype.hasOwnProperty.call(tree, currentName)) {
      return false;
    }
    const trimmed = (newName || '').trim() || currentName;
    if (trimmed !== currentName && Object.prototype.hasOwnProperty.call(tree, trimmed)) {
      alert(`Бизнес "${trimmed}" уже существует`);
      return false;
    }
    if (trimmed !== currentName) {
      tree[trimmed] = tree[currentName];
      delete tree[currentName];
      renameStatusEntries('business', {}, currentName, trimmed);
    }
    locationsState.tree = normalizeLocationTree(tree);
    setStatus('business', [trimmed], statusValue || getStatus('business', trimmed));
    buildLocationsTree();
    return true;
  }

  function addBusiness() {
    const name = prompt('Название бизнеса:');
    const trimmed = (name || '').trim();
    if (!trimmed) {
      return;
    }
    if (Object.prototype.hasOwnProperty.call(locationsState.tree || {}, trimmed)) {
      alert(`Бизнес "${trimmed}" уже существует`);
      return;
    }
    locationsState.tree[trimmed] = { 'Новый тип': { 'Новый город': [] } };
    setStatus('business', [trimmed], DEFAULT_LOCATION_STATUS);
    setStatus('type', [trimmed, 'Новый тип'], DEFAULT_LOCATION_STATUS);
    setStatus('city', [trimmed, 'Новый тип', 'Новый город'], DEFAULT_LOCATION_STATUS);
    buildLocationsTree();
  }

  function removeBusiness(name) {
    if (!confirmMultipleTimes(`Удалить бизнес "${name}"?`)) {
      return;
    }
    delete locationsState.tree[name];
    removeStatusEntries('business', {}, name);
    buildLocationsTree();
  }

  function updateType(business, oldName, newName, statusValue) {
    const tree = locationsState.tree || {};
    const types = tree[business];
    if (!types) {
      return false;
    }
    const currentName = (oldName || '').trim();
    const trimmed = (newName || '').trim() || currentName;
    if (trimmed !== currentName && Object.prototype.hasOwnProperty.call(types, trimmed)) {
      alert(`Тип "${trimmed}" уже существует`);
      return false;
    }
    if (trimmed !== currentName) {
      types[trimmed] = types[currentName];
      delete types[currentName];
      renameStatusEntries('type', { business }, currentName, trimmed);
    }
    tree[business] = types;
    locationsState.tree = normalizeLocationTree(tree);
    setStatus('type', [business, trimmed], statusValue || getStatus('type', business, trimmed));
    buildLocationsTree();
    return true;
  }

  function addTypeToBusiness(business) {
    const types = locationsState.tree[business];
    if (!types) {
      return;
    }
    const name = prompt('Название типа:');
    const trimmed = (name || '').trim();
    if (!trimmed) {
      return;
    }
    if (Object.prototype.hasOwnProperty.call(types, trimmed)) {
      alert(`Тип "${trimmed}" уже существует`);
      return;
    }
    types[trimmed] = { 'Новый город': [] };
    setStatus('type', [business, trimmed], DEFAULT_LOCATION_STATUS);
    setStatus('city', [business, trimmed, 'Новый город'], DEFAULT_LOCATION_STATUS);
    buildLocationsTree();
  }

  function removeType(business, typeName) {
    if (!confirmMultipleTimes(`Удалить тип "${typeName}"?`)) {
      return;
    }
    const types = locationsState.tree[business];
    if (!types) return;
    delete types[typeName];
    removeStatusEntries('type', { business }, typeName);
    buildLocationsTree();
  }

  function updateCity(business, typeName, oldName, newName, statusValue) {
    const tree = locationsState.tree || {};
    const types = tree[business];
    if (!types) return false;
    const cities = types[typeName];
    if (!cities || typeof cities !== 'object') return false;
    const currentName = (oldName || '').trim();
    const trimmed = (newName || '').trim() || currentName;
    if (trimmed !== currentName && Object.prototype.hasOwnProperty.call(cities, trimmed)) {
      alert(`Город "${trimmed}" уже существует`);
      return false;
    }
    if (trimmed !== currentName) {
      cities[trimmed] = cities[currentName];
      delete cities[currentName];
      renameStatusEntries('city', { business, type: typeName }, currentName, trimmed);
    }
    setStatus('city', [business, typeName, trimmed], statusValue || getStatus('city', business, typeName, trimmed));
    buildLocationsTree();
    return true;
  }

  function addCityToType(business, typeName) {
    const types = locationsState.tree[business];
    if (!types) return;
    const cities = types[typeName];
    if (!cities || typeof cities !== 'object') return;
    const name = prompt('Название города:');
    const trimmed = (name || '').trim();
    if (!trimmed) {
      return;
    }
    if (Object.prototype.hasOwnProperty.call(cities, trimmed)) {
      alert(`Город "${trimmed}" уже существует`);
      return;
    }
    cities[trimmed] = [];
    setStatus('city', [business, typeName, trimmed], DEFAULT_LOCATION_STATUS);
    buildLocationsTree();
  }

  function removeCity(business, typeName, cityName) {
    if (!confirmMultipleTimes(`Удалить город "${cityName}"?`)) {
      return;
    }
    const types = locationsState.tree[business];
    if (!types) return;
    const cities = types[typeName];
    if (!cities || typeof cities !== 'object') return;
    delete cities[cityName];
    removeStatusEntries('city', { business, type: typeName }, cityName);
    buildLocationsTree();
  }

  function updateLocation(business, typeName, cityName, oldName, newName, statusValue) {
    const types = locationsState.tree[business];
    if (!types) return false;
    const cities = types[typeName];
    if (!cities || typeof cities !== 'object') return false;
    const locations = Array.isArray(cities[cityName]) ? cities[cityName] : [];
    const currentName = (oldName || '').trim();
    const trimmed = (newName || '').trim() || currentName;
    if (trimmed !== currentName && locations.includes(trimmed)) {
      alert(`Локация "${trimmed}" уже существует`);
      return false;
    }
    const idx = locations.indexOf(currentName);
    if (idx === -1) return false;
    locations[idx] = trimmed;
    cities[cityName] = sortArrayAlphabetically(locations);
    if (trimmed !== currentName) {
      renameStatusEntries('location', { business, type: typeName, city: cityName }, currentName, trimmed);
    }
    setStatus('location', [business, typeName, cityName, trimmed], statusValue || getStatus('location', business, typeName, cityName, trimmed));
    buildLocationsTree();
    return true;
  }

  function addLocation(business, typeName, cityName) {
    const types = locationsState.tree[business];
    if (!types) return;
    const cities = types[typeName];
    if (!cities || typeof cities !== 'object') return;
    const list = Array.isArray(cities[cityName]) ? cities[cityName] : [];
    const name = prompt('Название локации:');
    const trimmed = (name || '').trim();
    if (!trimmed) {
      return;
    }
    if (list.includes(trimmed)) {
      alert(`Локация "${trimmed}" уже существует`);
      return;
    }
    list.push(trimmed);
    cities[cityName] = sortArrayAlphabetically(list);
    setStatus('location', [business, typeName, cityName, trimmed], DEFAULT_LOCATION_STATUS);
    buildLocationsTree();
  }

  function removeLocation(business, typeName, cityName, locationName) {
    if (!confirmMultipleTimes(`Удалить локацию "${locationName}"?`)) {
      return;
    }
    const types = locationsState.tree[business];
    if (!types) return;
    const cities = types[typeName];
    if (!cities || typeof cities !== 'object') return;
    const list = Array.isArray(cities[cityName]) ? cities[cityName] : [];
    const idx = list.indexOf(locationName);
    if (idx === -1) return;
    list.splice(idx, 1);
    cities[cityName] = list;
    removeStatusEntries('location', { business, type: typeName, city: cityName }, locationName);
    buildLocationsTree();
  }

  async function saveLocationsChanges() {
    try {
      const response = await fetch('/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ locations: locationsState }),
      });
      const data = await response.json();
      if (data.success) {
        alert('✅ Структура локаций сохранена');
      } else {
        alert('❌ Ошибка: ' + (data.error || 'неизвестная ошибка'));
      }
    } catch (error) {
      alert('❌ Ошибка сети: ' + error.message);
    }
  }

  const TYPE_OPTIONS = ['Корпоративная сеть', 'Партнёры-франчайзи'];
  let locationWizardModal = null;
  let locationWizardInitialised = false;
  let locationWizardStep = 0;
  const locationWizardState = {
    business: '',
    type: '',
    city: '',
    department: '',
  };
  let wizardSteps = [];
  let wizardSummary;
  let wizardBusinessSelect;
  let wizardTypeSelect;
  let wizardCitySelect;
  let wizardDepartmentSelect;
  let wizardPrevBtn;
  let wizardNextBtn;
  let wizardFinishBtn;

  function uniqueSorted(values) {
    return Array.from(
      new Set(
        (values || [])
          .map((value) => (typeof value === 'string' ? value.trim() : ''))
          .filter((value) => value)
      )
    ).sort((a, b) => a.localeCompare(b));
  }

  function getBusinessOptions() {
    const options = uniqueSorted((parameterData.business || []).map((item) => item.value));
    if (options.length) {
      return options;
    }
    return uniqueSorted(Object.keys(locationsState.tree || {}));
  }

  function getCityOptions() {
    if (CITY_OPTIONS && CITY_OPTIONS.length) {
      return CITY_OPTIONS;
    }
    const collected = [];
    Object.values(locationsState.tree || {}).forEach((types) => {
      Object.values(types || {}).forEach((cities) => {
        Object.keys(cities || {}).forEach((city) => {
          collected.push(city);
        });
      });
    });
    return uniqueSorted(collected);
  }

  function getDepartmentOptions() {
    const options = uniqueSorted((parameterData.department || []).map((item) => item.value));
    if (options.length) {
      return options;
    }
    const collected = [];
    Object.values(locationsState.tree || {}).forEach((types) => {
      Object.values(types || {}).forEach((cities) => {
        Object.values(cities || {}).forEach((departments) => {
          if (Array.isArray(departments)) {
            departments.forEach((department) => collected.push(department));
          }
        });
      });
    });
    return uniqueSorted(collected);
  }

  function clearInvalid(selectEl) {
    if (selectEl) {
      selectEl.classList.remove('is-invalid');
    }
  }

  function markInvalid(selectEl) {
    if (selectEl) {
      selectEl.classList.add('is-invalid');
      selectEl.focus();
    }
  }

  function fillSelect(selectEl, options, placeholder, selectedValue) {
    if (!selectEl) return;
    selectEl.innerHTML = '';
    const placeholderOption = document.createElement('option');
    placeholderOption.value = '';
    placeholderOption.textContent = placeholder;
    placeholderOption.disabled = true;
    if (!selectedValue) {
      placeholderOption.selected = true;
    }
    selectEl.appendChild(placeholderOption);
    options.forEach((value) => {
      const option = document.createElement('option');
      option.value = value;
      option.textContent = value;
      if (value === selectedValue) {
        option.selected = true;
      }
      selectEl.appendChild(option);
    });
    if (selectedValue && !options.includes(selectedValue)) {
      placeholderOption.selected = true;
      selectEl.value = '';
    }
    clearInvalid(selectEl);
  }

  function populateWizardOptions() {
    fillSelect(wizardBusinessSelect, getBusinessOptions(), 'Выберите бизнес', locationWizardState.business);
    fillSelect(wizardTypeSelect, TYPE_OPTIONS.slice(), 'Выберите тип', locationWizardState.type);
    fillSelect(wizardCitySelect, getCityOptions(), 'Выберите город', locationWizardState.city);
    fillSelect(
      wizardDepartmentSelect,
      getDepartmentOptions(),
      'Выберите департамент',
      locationWizardState.department,
    );
  }

  function resetLocationWizardState() {
    locationWizardState.business = '';
    locationWizardState.type = '';
    locationWizardState.city = '';
    locationWizardState.department = '';
    locationWizardStep = 0;
  }

  function updateWizardSummary() {
    if (!wizardSummary) return;
    const entries = [
      ['Бизнес', locationWizardState.business || '—'],
      ['Тип', locationWizardState.type || '—'],
      ['Город', locationWizardState.city || '—'],
      ['Департамент', locationWizardState.department || '—'],
    ];
    wizardSummary.innerHTML = `
      <ul class="mb-0 small">
        ${entries.map(([label, value]) => `<li><strong>${label}:</strong> ${value}</li>`).join('')}
      </ul>
    `;
  }

  function showLocationWizardStep(step) {
    locationWizardStep = step;
    if (wizardSteps && wizardSteps.length) {
      wizardSteps.forEach((stepEl, index) => {
        stepEl.classList.toggle('d-none', index !== step);
      });
    }
    if (wizardPrevBtn) {
      wizardPrevBtn.disabled = step === 0;
      wizardPrevBtn.classList.toggle('disabled', step === 0);
    }
    if (wizardNextBtn) {
      wizardNextBtn.classList.toggle('d-none', step === wizardSteps.length - 1);
    }
    if (wizardFinishBtn) {
      wizardFinishBtn.classList.toggle('d-none', step !== wizardSteps.length - 1);
    }
    updateWizardSummary();
  }

  function handleLocationWizardPrev() {
    if (locationWizardStep > 0) {
      showLocationWizardStep(locationWizardStep - 1);
    }
  }

  function handleLocationWizardNext() {
    if (locationWizardStep === 0) {
      if (!locationWizardState.business) {
        markInvalid(wizardBusinessSelect);
        return;
      }
    } else if (locationWizardStep === 1) {
      if (!locationWizardState.type) {
        markInvalid(wizardTypeSelect);
        return;
      }
    } else if (locationWizardStep === 2) {
      if (!locationWizardState.city) {
        markInvalid(wizardCitySelect);
        return;
      }
    }
    showLocationWizardStep(Math.min(locationWizardStep + 1, wizardSteps.length - 1));
  }

  function addLocationEntryFromWizard(entry) {
    const business = (entry.business || '').trim();
    const type = (entry.type || '').trim();
    const city = (entry.city || '').trim();
    const department = (entry.department || '').trim();
    if (!business || !type || !city || !department) {
      return false;
    }

    if (!locationsState.tree[business]) {
      locationsState.tree[business] = {};
      setStatus('business', [business], DEFAULT_LOCATION_STATUS);
    }
    if (!locationsState.tree[business][type]) {
      locationsState.tree[business][type] = {};
      setStatus('type', [business, type], DEFAULT_LOCATION_STATUS);
    }
    if (!Array.isArray(locationsState.tree[business][type][city])) {
      locationsState.tree[business][type][city] = [];
      setStatus('city', [business, type, city], DEFAULT_LOCATION_STATUS);
    }

    const targetList = locationsState.tree[business][type][city];
    if (targetList.includes(department)) {
      return false;
    }

    targetList.push(department);
    locationsState.tree[business][type][city] = sortArrayAlphabetically(targetList);
    setStatus('location', [business, type, city, department], DEFAULT_LOCATION_STATUS);
    buildLocationsTree();

    const collapseId = typeCollapseIdFor(business, type);
    const collapseEl = document.getElementById(collapseId);
    if (collapseEl && typeof bootstrap !== 'undefined' && bootstrap.Collapse) {
      const collapse = bootstrap.Collapse.getOrCreateInstance(collapseEl, { toggle: false });
      collapse.show();
    }

    return true;
  }

  function handleLocationWizardFinish() {
    if (!locationWizardState.department) {
      markInvalid(wizardDepartmentSelect);
      return;
    }
    if (!addLocationEntryFromWizard(locationWizardState)) {
      alert('Такая запись уже существует в выбранной структуре.');
      return;
    }
    if (locationWizardModal) {
      locationWizardModal.hide();
    }
  }

  function initLocationWizard() {
    if (locationWizardInitialised) return;
    const wizardModalEl = document.getElementById('locationWizardModal');
    if (!wizardModalEl || typeof bootstrap === 'undefined' || !bootstrap.Modal) {
      return;
    }
    locationWizardModal = bootstrap.Modal.getOrCreateInstance(wizardModalEl);
    wizardBusinessSelect = document.getElementById('wizardBusinessSelect');
    wizardTypeSelect = document.getElementById('wizardTypeSelect');
    wizardCitySelect = document.getElementById('wizardCitySelect');
    wizardDepartmentSelect = document.getElementById('wizardDepartmentSelect');
    wizardPrevBtn = document.getElementById('wizardPrevStep');
    wizardNextBtn = document.getElementById('wizardNextStep');
    wizardFinishBtn = document.getElementById('wizardFinish');
    wizardSummary = document.getElementById('wizardSummary');
    wizardSteps = Array.from(document.querySelectorAll('[data-location-wizard-step]'));

    if (wizardPrevBtn) {
      wizardPrevBtn.addEventListener('click', handleLocationWizardPrev);
    }
    if (wizardNextBtn) {
      wizardNextBtn.addEventListener('click', handleLocationWizardNext);
    }
    if (wizardFinishBtn) {
      wizardFinishBtn.addEventListener('click', handleLocationWizardFinish);
    }
    if (wizardBusinessSelect) {
      wizardBusinessSelect.addEventListener('change', (event) => {
        locationWizardState.business = (event.target.value || '').trim();
        locationWizardState.type = '';
        locationWizardState.city = '';
        locationWizardState.department = '';
        if (wizardTypeSelect) wizardTypeSelect.value = '';
        if (wizardCitySelect) wizardCitySelect.value = '';
        if (wizardDepartmentSelect) wizardDepartmentSelect.value = '';
        clearInvalid(wizardBusinessSelect);
        clearInvalid(wizardTypeSelect);
        clearInvalid(wizardCitySelect);
        clearInvalid(wizardDepartmentSelect);
        updateWizardSummary();
      });
    }
    if (wizardTypeSelect) {
      wizardTypeSelect.addEventListener('change', (event) => {
        locationWizardState.type = (event.target.value || '').trim();
        locationWizardState.city = '';
        locationWizardState.department = '';
        if (wizardCitySelect) wizardCitySelect.value = '';
        if (wizardDepartmentSelect) wizardDepartmentSelect.value = '';
        clearInvalid(wizardTypeSelect);
        clearInvalid(wizardCitySelect);
        clearInvalid(wizardDepartmentSelect);
        updateWizardSummary();
      });
    }
    if (wizardCitySelect) {
      wizardCitySelect.addEventListener('change', (event) => {
        locationWizardState.city = (event.target.value || '').trim();
        locationWizardState.department = '';
        if (wizardDepartmentSelect) wizardDepartmentSelect.value = '';
        clearInvalid(wizardCitySelect);
        clearInvalid(wizardDepartmentSelect);
        updateWizardSummary();
      });
    }
    if (wizardDepartmentSelect) {
      wizardDepartmentSelect.addEventListener('change', (event) => {
        locationWizardState.department = (event.target.value || '').trim();
        clearInvalid(wizardDepartmentSelect);
        updateWizardSummary();
      });
    }

    wizardModalEl.addEventListener('hidden.bs.modal', () => {
      resetLocationWizardState();
      populateWizardOptions();
      showLocationWizardStep(0);
    });

    populateWizardOptions();
    showLocationWizardStep(0);
    locationWizardInitialised = true;
  }

  async function openAddLocationWizard() {
    initLocationWizard();
    if (!locationWizardModal) return;
    if (!parametersLoaded) {
      await loadParameters();
      populateWizardOptions();
    }
    resetLocationWizardState();
    populateWizardOptions();
    showLocationWizardStep(0);
    updateWizardSummary();
    locationWizardModal.show();
  }

  window.openAddLocationWizard = openAddLocationWizard;

  function generateDialogTemplateId(prefix) {
    const randomPart = Math.random().toString(36).slice(2, 8);
    const timePart = Date.now().toString(36);
    return `${prefix}-${randomPart}-${timePart}`;
  }

  function pluralizeRussian(number, forms) {
    const abs = Math.abs(number);
    const mod10 = abs % 10;
    const mod100 = abs % 100;
    if (mod10 === 1 && mod100 !== 11) {
      return forms[0];
    }
    if (mod10 >= 2 && mod10 <= 4 && (mod100 < 10 || mod100 >= 20)) {
      return forms[1];
    }
    return forms[2];
  }

  function buildPreview(values, limit = 3) {
    if (!Array.isArray(values) || !values.length) {
      return '';
    }
    const slice = values.slice(0, limit);
    const preview = slice.join(', ');
    if (values.length > limit) {
      return `${preview}…`;
    }
    return preview;
  }

  function findDialogTemplateCard(source) {
    if (!(source instanceof HTMLElement)) return null;
    return source.closest('[data-category-template], [data-question-template], [data-completion-template], [data-auto-close-template]');
  }

  function toggleDialogTemplateEditor(source, forceState) {
    const card = source instanceof HTMLElement && source.matches('[data-category-template], [data-question-template], [data-completion-template], [data-auto-close-template]')
      ? source
      : findDialogTemplateCard(source);
    if (!card) return;
    const editor = card.querySelector('[data-dialog-template-editor]');
    const toggleBtn = card.querySelector('[data-dialog-template-toggle]');
    if (!editor || !toggleBtn) return;
    let shouldShow;
    if (typeof forceState === 'boolean') {
      shouldShow = forceState;
    } else {
      shouldShow = editor.classList.contains('d-none');
    }
    editor.classList.toggle('d-none', !shouldShow);
    toggleBtn.textContent = shouldShow ? 'Свернуть' : 'Настроить';
    toggleBtn.dataset.expanded = shouldShow ? 'true' : 'false';
    toggleBtn.setAttribute('aria-expanded', shouldShow ? 'true' : 'false');
    editor.setAttribute('aria-hidden', shouldShow ? 'false' : 'true');
  }

  function updateCategoryTemplateSummary(card) {
    if (!(card instanceof HTMLElement)) return;
    const nameInput = card.querySelector('.category-template-name');
    const titleEl = card.querySelector('[data-dialog-template-title]');
    const summaryEl = card.querySelector('[data-dialog-template-summary]');
    const name = (nameInput?.value || '').trim();
    if (titleEl) {
      titleEl.textContent = name || 'Шаблон категорий';
    }
    if (summaryEl) {
      const categories = Array.from(card.querySelectorAll('.category-item-input'))
        .map((input) => (input.value || '').trim())
        .filter((value) => value);
      if (!categories.length) {
        summaryEl.textContent = 'Нет категорий. Добавьте элементы в шаблон.';
      } else {
        const countText = `${categories.length} ${pluralizeRussian(categories.length, ['категория', 'категории', 'категорий'])}`;
        const preview = buildPreview(categories);
        summaryEl.textContent = preview ? `${countText} · ${preview}` : countText;
      }
    }
  }

  function updateQuestionTemplateSummary(card) {
    if (!(card instanceof HTMLElement)) return;
    const nameInput = card.querySelector('.question-template-name');
    const titleEl = card.querySelector('[data-dialog-template-title]');
    const summaryEl = card.querySelector('[data-dialog-template-summary]');
    const name = (nameInput?.value || '').trim();
    if (titleEl) {
      titleEl.textContent = name || 'Шаблон вопросов';
    }
    if (summaryEl) {
      const questions = Array.from(card.querySelectorAll('.question-item-input'))
        .map((input) => (input.value || '').trim())
        .filter((value) => value);
      if (!questions.length) {
        summaryEl.textContent = 'Нет вопросов. Добавьте их в редактор ниже.';
      } else {
        const countText = `${questions.length} ${pluralizeRussian(questions.length, ['вопрос', 'вопроса', 'вопросов'])}`;
        const preview = buildPreview(questions);
        summaryEl.textContent = preview ? `${countText} · ${preview}` : countText;
      }
    }
  }

  function updateCompletionTemplateSummary(card) {
    if (!(card instanceof HTMLElement)) return;
    const nameInput = card.querySelector('.completion-template-name');
    const titleEl = card.querySelector('[data-dialog-template-title]');
    const summaryEl = card.querySelector('[data-dialog-template-summary]');
    const name = (nameInput?.value || '').trim();
    if (titleEl) {
      titleEl.textContent = name || 'Шаблон действий';
    }
    if (summaryEl) {
      const items = Array.from(card.querySelectorAll('[data-completion-item]')).map((row) => {
        if (!(row instanceof HTMLElement)) return null;
        const question = (row.querySelector('.completion-question-input')?.value || '').trim();
        const action = (row.querySelector('.completion-action-input')?.value || '').trim();
        if (!question && !action) return null;
        return question || action;
      }).filter(Boolean);
      if (!items.length) {
        summaryEl.textContent = 'Нет действий. Добавьте контрольные вопросы и шаги.';
      } else {
        const countText = `${items.length} ${pluralizeRussian(items.length, ['шаг', 'шага', 'шагов'])}`;
        const preview = buildPreview(items);
        summaryEl.textContent = preview ? `${countText} · ${preview}` : countText;
      }
    }
  }

  function addCategoryTemplate(template) {
    const list = document.getElementById('categoryTemplatesList');
    if (!list) return;
    const data = template && typeof template === 'object' ? template : {};
    const templateId = data.id || generateDialogTemplateId('cat');
    const name = typeof data.name === 'string' ? data.name : '';
    const categories = Array.isArray(data.categories) ? data.categories : [];

    const card = document.createElement('div');
    card.className = 'card shadow-sm dialog-template-card';
    card.dataset.categoryTemplate = 'true';
    card.dataset.templateId = templateId;

    card.innerHTML = `
      <div class="card-body">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start gap-3">
          <div>
            <h6 class="mb-1" data-dialog-template-title>Шаблон категорий</h6>
            <div class="small text-muted dialog-template-summary" data-dialog-template-summary>Нет категорий. Добавьте элементы в шаблон.</div>
          </div>
          <div class="d-flex flex-column align-items-lg-end gap-2 w-100 w-lg-auto">
            <div class="btn-group btn-group-sm align-self-start align-self-lg-end">
              <button class="btn btn-outline-primary" type="button" data-dialog-template-toggle onclick="toggleDialogTemplateEditor(this)">Настроить</button>
              <button class="btn btn-outline-danger" type="button" onclick="removeCategoryTemplate(this)">Удалить</button>
            </div>
          </div>
        </div>
        <div class="dialog-template-editor bg-light mt-3" data-dialog-template-editor aria-hidden="false">
          <div class="mb-3">
            <label class="form-label" for="category-template-${templateId}">Название шаблона</label>
            <input type="text" class="form-control form-control-sm category-template-name" id="category-template-${templateId}" placeholder="Название шаблона" value="${''}">
          </div>
          <div class="d-flex flex-column gap-2" data-category-items></div>
          <button class="btn btn-sm btn-outline-primary mt-3" type="button" onclick="addCategoryRow(this)">+ Категория</button>
        </div>
      </div>
    `;

    list.appendChild(card);
    const nameInput = card.querySelector('.category-template-name');
    if (nameInput) {
      nameInput.value = name;
      nameInput.addEventListener('input', () => updateCategoryTemplateSummary(card));
    }

    const itemsContainer = card.querySelector('[data-category-items]');
    if (itemsContainer) {
      if (categories.length) {
        categories.forEach((cat) => addCategoryRow(itemsContainer, cat));
      } else {
        addCategoryRow(itemsContainer);
      }
    }

    updateCategoryTemplateSummary(card);
    const hasInitialData = Boolean(name || categories.length);
    toggleDialogTemplateEditor(card, !hasInitialData);

    return card;
  }

  function addCategoryRow(source, value = '') {
    let container = null;
    if (source instanceof HTMLElement && source.matches('[data-category-items]')) {
      container = source;
    } else if (source instanceof HTMLElement) {
      const card = source.closest('[data-category-template]');
      container = card ? card.querySelector('[data-category-items]') : null;
    }
    if (!container) return;

    const row = document.createElement('div');
    row.className = 'input-group input-group-sm';
    row.innerHTML = `
      <input type="text" class="form-control category-item-input" placeholder="Категория">
      <button class="btn btn-outline-danger" type="button" onclick="removeCategoryRow(this)">✕</button>
    `;
    container.appendChild(row);
    const input = row.querySelector('input');
    if (input) {
      input.value = value || '';
      input.addEventListener('input', () => {
        const card = container.closest('[data-category-template]');
        updateCategoryTemplateSummary(card);
      });
    }
    const card = container.closest('[data-category-template]');
    updateCategoryTemplateSummary(card);
  }

  function removeCategoryTemplate(trigger) {
    const card = trigger?.closest('[data-category-template]');
    if (!card) return;
    const list = document.getElementById('categoryTemplatesList');
    card.remove();
    if (list && !list.querySelector('[data-category-template]')) {
      addCategoryTemplate();
    }
  }

  function removeCategoryRow(trigger) {
    const row = trigger?.closest('.input-group');
    if (!row) return;
    const container = row.parentElement;
    row.remove();
    if (container && !container.querySelector('.input-group')) {
      addCategoryRow(container);
    }
    const card = container?.closest('[data-category-template]');
    updateCategoryTemplateSummary(card);
  }

  function addQuestionTemplate(template) {
    const list = document.getElementById('questionTemplatesList');
    if (!list) return;
    const data = template && typeof template === 'object' ? template : {};
    const templateId = data.id || generateDialogTemplateId('q');
    const name = typeof data.name === 'string' ? data.name : '';
    const questions = Array.isArray(data.questions) ? data.questions : [];

    const card = document.createElement('div');
    card.className = 'card shadow-sm dialog-template-card';
    card.dataset.questionTemplate = 'true';
    card.dataset.templateId = templateId;
    card.innerHTML = `
      <div class="card-body">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start gap-3">
          <div>
            <h6 class="mb-1" data-dialog-template-title>Шаблон вопросов</h6>
            <div class="small text-muted dialog-template-summary" data-dialog-template-summary>Нет вопросов. Добавьте их в редактор ниже.</div>
          </div>
          <div class="d-flex flex-column align-items-lg-end gap-2 w-100 w-lg-auto">
            <div class="btn-group btn-group-sm align-self-start align-self-lg-end">
              <button class="btn btn-outline-primary" type="button" data-dialog-template-toggle onclick="toggleDialogTemplateEditor(this)">Настроить</button>
              <button class="btn btn-outline-danger" type="button" onclick="removeQuestionTemplate(this)">Удалить</button>
            </div>
          </div>
        </div>
        <div class="dialog-template-editor bg-light mt-3" data-dialog-template-editor aria-hidden="false">
          <div class="mb-3">
            <label class="form-label" for="question-template-${templateId}">Название шаблона</label>
            <input type="text" class="form-control form-control-sm question-template-name" id="question-template-${templateId}" placeholder="Название шаблона" value="${''}">
          </div>
          <div class="d-flex flex-column gap-2" data-question-items></div>
          <button class="btn btn-sm btn-outline-primary mt-3" type="button" onclick="addQuestionRow(this)">+ Вопрос</button>
        </div>
      </div>
    `;
    list.appendChild(card);

    const nameInput = card.querySelector('.question-template-name');
    if (nameInput) {
      nameInput.value = name;
      nameInput.addEventListener('input', () => updateQuestionTemplateSummary(card));
    }

    const itemsContainer = card.querySelector('[data-question-items]');
    if (itemsContainer) {
      if (questions.length) {
        questions.forEach((question) => addQuestionRow(itemsContainer, question));
      } else {
        addQuestionRow(itemsContainer);
      }
    }

    updateQuestionTemplateSummary(card);
    const hasInitialData = Boolean(name || questions.length);
    toggleDialogTemplateEditor(card, !hasInitialData);

    return card;
  }

  function addQuestionRow(source, value = '') {
    let container = null;
    if (source instanceof HTMLElement && source.matches('[data-question-items]')) {
      container = source;
    } else if (source instanceof HTMLElement) {
      const card = source.closest('[data-question-template]');
      container = card ? card.querySelector('[data-question-items]') : null;
    }
    if (!container) return;

    const row = document.createElement('div');
    row.className = 'input-group input-group-sm';
    row.innerHTML = `
      <input type="text" class="form-control question-item-input" placeholder="Типовой вопрос">
      <button class="btn btn-outline-danger" type="button" onclick="removeQuestionRow(this)">✕</button>
    `;
    container.appendChild(row);
    const input = row.querySelector('input');
    if (input) {
      input.value = value || '';
      input.addEventListener('input', () => {
        const card = container.closest('[data-question-template]');
        updateQuestionTemplateSummary(card);
      });
    }
    const card = container.closest('[data-question-template]');
    updateQuestionTemplateSummary(card);
  }

  function removeQuestionTemplate(trigger) {
    const card = trigger?.closest('[data-question-template]');
    if (!card) return;
    const list = document.getElementById('questionTemplatesList');
    card.remove();
    if (list && !list.querySelector('[data-question-template]')) {
      addQuestionTemplate();
    }
  }

  function removeQuestionRow(trigger) {
    const row = trigger?.closest('.input-group');
    if (!row) return;
    const container = row.parentElement;
    row.remove();
    if (container && !container.querySelector('.input-group')) {
      addQuestionRow(container);
    }
    const card = container?.closest('[data-question-template]');
    updateQuestionTemplateSummary(card);
  }

  function addCompletionTemplate(template) {
    const list = document.getElementById('completionTemplatesList');
    if (!list) return;
    const data = template && typeof template === 'object' ? template : {};
    const templateId = data.id || generateDialogTemplateId('act');
    const name = typeof data.name === 'string' ? data.name : '';
    const items = Array.isArray(data.items) ? data.items : [];

    const card = document.createElement('div');
    card.className = 'card shadow-sm dialog-template-card';
    card.dataset.completionTemplate = 'true';
    card.dataset.templateId = templateId;
    card.innerHTML = `
      <div class="card-body">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start gap-3">
          <div>
            <h6 class="mb-1" data-dialog-template-title>Шаблон действий</h6>
            <div class="small text-muted dialog-template-summary" data-dialog-template-summary>Нет действий. Добавьте контрольные вопросы и шаги.</div>
          </div>
          <div class="d-flex flex-column align-items-lg-end gap-2 w-100 w-lg-auto">
            <div class="btn-group btn-group-sm align-self-start align-self-lg-end">
              <button class="btn btn-outline-primary" type="button" data-dialog-template-toggle onclick="toggleDialogTemplateEditor(this)">Настроить</button>
              <button class="btn btn-outline-danger" type="button" onclick="removeCompletionTemplate(this)">Удалить</button>
            </div>
          </div>
        </div>
        <div class="dialog-template-editor bg-light mt-3" data-dialog-template-editor aria-hidden="false">
          <div class="mb-3">
            <label class="form-label" for="completion-template-${templateId}">Название шаблона</label>
            <input type="text" class="form-control form-control-sm completion-template-name" id="completion-template-${templateId}" placeholder="Название шаблона" value="${''}">
          </div>
          <div class="d-flex flex-column gap-3" data-completion-items></div>
          <button class="btn btn-sm btn-outline-primary mt-3" type="button" onclick="addCompletionRow(this)">+ Действие</button>
        </div>
      </div>
    `;
    list.appendChild(card);

    const nameInput = card.querySelector('.completion-template-name');
    if (nameInput) {
      nameInput.value = name;
      nameInput.addEventListener('input', () => updateCompletionTemplateSummary(card));
    }

    const itemsContainer = card.querySelector('[data-completion-items]');
    if (itemsContainer) {
      if (items.length) {
        items.forEach((entry) => {
          const question = entry && typeof entry.question === 'string' ? entry.question : '';
          const action = entry && typeof entry.action === 'string' ? entry.action : '';
          addCompletionRow(itemsContainer, question, action);
        });
      } else {
        addCompletionRow(itemsContainer);
      }
    }

    updateCompletionTemplateSummary(card);
    const hasInitialData = Boolean(name || items.length);
    toggleDialogTemplateEditor(card, !hasInitialData);

    return card;
  }

  function addCompletionRow(source, questionValue = '', actionValue = '') {
    let container = null;
    if (source instanceof HTMLElement && source.matches('[data-completion-items]')) {
      container = source;
    } else if (source instanceof HTMLElement) {
      const card = source.closest('[data-completion-template]');
      container = card ? card.querySelector('[data-completion-items]') : null;
    }
    if (!container) return;

    const row = document.createElement('div');
    row.className = 'row g-2 align-items-start completion-item-row';
    row.dataset.completionItem = 'true';
    row.innerHTML = `
      <div class="col-md-5">
        <input type="text" class="form-control form-control-sm completion-question-input" placeholder="Контрольный вопрос">
      </div>
      <div class="col-md-6">
        <input type="text" class="form-control form-control-sm completion-action-input" placeholder="Действие">
      </div>
      <div class="col-md-1 d-flex align-items-center">
        <button class="btn btn-outline-danger btn-sm w-100" type="button" onclick="removeCompletionRow(this)">✕</button>
      </div>
    `;
    container.appendChild(row);
    const questionInput = row.querySelector('.completion-question-input');
    const actionInput = row.querySelector('.completion-action-input');
    if (questionInput) questionInput.value = questionValue || '';
    if (actionInput) actionInput.value = actionValue || '';
    [questionInput, actionInput].forEach((input) => {
      if (input) {
        input.addEventListener('input', () => {
          const card = container.closest('[data-completion-template]');
          updateCompletionTemplateSummary(card);
        });
      }
    });
    const card = container.closest('[data-completion-template]');
    updateCompletionTemplateSummary(card);
  }

  function removeCompletionTemplate(trigger) {
    const card = trigger?.closest('[data-completion-template]');
    if (!card) return;
    const list = document.getElementById('completionTemplatesList');
    card.remove();
    if (list && !list.querySelector('[data-completion-template]')) {
      addCompletionTemplate();
    }
  }

  function removeCompletionRow(trigger) {
    const row = trigger?.closest('[data-completion-item]');
    if (!row) return;
    const container = row.parentElement;
    row.remove();
    if (container && !container.querySelector('[data-completion-item]')) {
      addCompletionRow(container);
    }
    const card = container?.closest('[data-completion-template]');
    updateCompletionTemplateSummary(card);
  }

  function buildAutoCloseTemplateCard(template) {
    const list = document.querySelector('[data-auto-close-templates]');
    if (!list) return null;
    const data = template && typeof template === 'object' ? template : {};
    const templateId = data.id || generateDialogTemplateId('auto');
    const name = typeof data.name === 'string' ? data.name : '';
    const description = typeof data.description === 'string' ? data.description : '';
    let hoursCandidate = null;
    ['hours', 'timeout_hours', 'auto_close_hours'].some((key) => {
      const value = data && typeof data === 'object' ? Number(data[key]) : NaN;
      if (Number.isFinite(value) && value > 0) {
        hoursCandidate = value;
        return true;
      }
      return false;
    });
    const rawHours = Number.isFinite(hoursCandidate) && hoursCandidate > 0 ? hoursCandidate : AUTO_CLOSE_FALLBACK_HOURS;
    const hours = Math.min(Math.max(Math.round(rawHours || AUTO_CLOSE_FALLBACK_HOURS), 1), 720);
    const safeIdAttr = escapeHtml(templateId);
    const safeName = escapeHtml(name);
    const safeDescription = escapeHtml(description);

    const card = document.createElement('div');
    card.className = 'card shadow-sm dialog-template-card template-card';
    card.dataset.autoCloseTemplate = 'true';
    card.dataset.templateId = templateId;

    card.innerHTML = `
      <div class="card-body">
        <div class="template-card-header">
          <h6 class="mb-1" data-auto-close-title>Шаблон автозакрытия</h6>
          <div class="small text-muted dialog-template-summary" data-auto-close-summary>Настройте параметры автозакрытия.</div>
        </div>
        <div class="d-flex flex-column flex-lg-row align-items-center justify-content-between gap-3 mt-3">
          <div class="form-check">
            <input class="form-check-input" type="radio" id="auto-template-active-${safeIdAttr}" name="autoCloseActive" value="${safeIdAttr}" data-auto-close-active>
            <label class="form-check-label small" for="auto-template-active-${safeIdAttr}">Активный по умолчанию</label>
          </div>
          <div class="btn-group btn-group-sm template-card-actions">
            <button class="btn btn-outline-primary" type="button" data-dialog-template-toggle onclick="toggleDialogTemplateEditor(this)">Настроить</button>
            <button class="btn btn-outline-danger" type="button" onclick="removeAutoCloseTemplate(this)">Удалить</button>
          </div>
        </div>
        <div class="dialog-template-editor bg-light mt-3" data-dialog-template-editor>
          <div class="mb-3">
            <label class="form-label" for="auto-template-name-${safeIdAttr}">Название шаблона</label>
            <input type="text" class="form-control form-control-sm auto-close-template-name" id="auto-template-name-${safeIdAttr}" placeholder="Например, 24 часа" value="${safeName}">
          </div>
          <div class="row g-2">
            <div class="col-lg-4">
              <label class="form-label" for="auto-template-hours-${safeIdAttr}">Через сколько закрывать (часы)</label>
              <input type="number" class="form-control form-control-sm auto-close-template-hours" id="auto-template-hours-${safeIdAttr}" min="1" max="720" step="1" value="${hours}">
              <div class="form-text">Минимум 1 час, максимум 720 часов.</div>
            </div>
            <div class="col-lg-8">
              <label class="form-label" for="auto-template-description-${safeIdAttr}">Описание (необязательно)</label>
              <textarea class="form-control form-control-sm auto-close-template-description" id="auto-template-description-${safeIdAttr}" rows="2" placeholder="Добавьте комментарий или условия срабатывания.">${safeDescription}</textarea>
            </div>
          </div>
        </div>
      </div>
    `;

    list.appendChild(card);

    const nameInput = card.querySelector('.auto-close-template-name');
    const hoursInput = card.querySelector('.auto-close-template-hours');
    const descriptionInput = card.querySelector('.auto-close-template-description');
    const activeInput = card.querySelector('[data-auto-close-active]');

    const updateSummary = () => updateAutoCloseTemplateSummary(card);

    nameInput?.addEventListener('input', updateSummary);
    descriptionInput?.addEventListener('input', updateSummary);
    hoursInput?.addEventListener('input', () => {
      if (!hoursInput) return;
      const value = Math.round(Number(hoursInput.value));
      if (!Number.isFinite(value) || value <= 0) {
        hoursInput.classList.add('is-invalid');
      } else {
        hoursInput.classList.remove('is-invalid');
      }
      updateSummary();
    });

    activeInput?.addEventListener('change', () => {
      document.querySelectorAll('[data-auto-close-template]').forEach((otherCard) => {
        if (!(otherCard instanceof HTMLElement)) return;
        otherCard.classList.toggle('border-primary', otherCard === card && activeInput.checked);
      });
    });

    const hasCustomHours = data && typeof data === 'object' && Object.prototype.hasOwnProperty.call(data, 'hours');
    const hasInitialData = Boolean(name) || Boolean(description) || hasCustomHours;
    toggleDialogTemplateEditor(card, !hasInitialData);
    updateAutoCloseTemplateSummary(card);
    return card;
  }

  function updateAutoCloseTemplateSummary(card) {
    if (!(card instanceof HTMLElement)) return;
    const nameInput = card.querySelector('.auto-close-template-name');
    const hoursInput = card.querySelector('.auto-close-template-hours');
    const descriptionInput = card.querySelector('.auto-close-template-description');
    const titleEl = card.querySelector('[data-auto-close-title]');
    const summaryEl = card.querySelector('[data-auto-close-summary]');
    const name = (nameInput?.value || '').trim();
    const description = (descriptionInput?.value || '').trim();
    const hoursValue = Math.round(Number(hoursInput?.value));

    if (titleEl) {
      titleEl.textContent = name || 'Шаблон автозакрытия';
    }

    if (summaryEl) {
      if (!Number.isFinite(hoursValue) || hoursValue <= 0) {
        summaryEl.textContent = 'Укажите время автозакрытия и при необходимости описание.';
      } else {
        const normalized = Math.min(Math.max(hoursValue, 1), 720);
        const hoursText = `${normalized} ${pluralizeRussian(normalized, ['час', 'часа', 'часов'])}`;
        if (description) {
          summaryEl.textContent = `Закрытие через ${hoursText}. ${description}`;
        } else {
          summaryEl.textContent = `Закрытие через ${hoursText}.`;
        }
      }
    }
  }

  function addAutoCloseTemplate(template) {
    const card = buildAutoCloseTemplateCard(template);
    if (!card) return;
    const activeInput = card.querySelector('[data-auto-close-active]');
    if (activeInput) {
      const shouldActivate = template?.isActive === true;
      activeInput.checked = shouldActivate;
      if (shouldActivate) {
        activeInput.dispatchEvent(new Event('change'));
      }
    }
  }

  function removeAutoCloseTemplate(trigger) {
    const card = trigger?.closest('[data-auto-close-template]');
    const list = document.querySelector('[data-auto-close-templates]');
    if (!card || !list) return;
    const wasActive = card.querySelector('[data-auto-close-active]')?.checked;
    card.remove();
    if (!list.querySelector('[data-auto-close-template]')) {
      addAutoCloseTemplate({ hours: AUTO_CLOSE_FALLBACK_HOURS, isActive: true });
    }
    if (wasActive) {
      const firstRadio = list.querySelector('[data-auto-close-template] [data-auto-close-active]');
      if (firstRadio instanceof HTMLInputElement) {
        firstRadio.checked = true;
        firstRadio.dispatchEvent(new Event('change'));
      }
    }
  }

  function collectAutoCloseConfig() {
    const cards = Array.from(document.querySelectorAll('[data-auto-close-template]'));
    const templates = [];
    let hasInvalidHours = false;
    cards.forEach((card, index) => {
      if (!(card instanceof HTMLElement)) return;
      let templateId = card.dataset.templateId || generateDialogTemplateId('auto');
      card.dataset.templateId = templateId;
      const nameInput = card.querySelector('.auto-close-template-name');
      const hoursInput = card.querySelector('.auto-close-template-hours');
      const descriptionInput = card.querySelector('.auto-close-template-description');
      const name = (nameInput?.value || '').trim();
      const description = (descriptionInput?.value || '').trim();
      const rawHours = Math.round(Number(hoursInput?.value));
      if (!Number.isFinite(rawHours) || rawHours <= 0) {
        hasInvalidHours = true;
        hoursInput?.classList.add('is-invalid');
        return;
      }
      const normalizedHours = Math.min(Math.max(rawHours, 1), 720);
      if (hoursInput) {
        hoursInput.classList.remove('is-invalid');
        hoursInput.value = normalizedHours;
      }
      if (!templateId) {
        templateId = generateDialogTemplateId('auto');
        card.dataset.templateId = templateId;
      }
      templates.push({
        id: templateId,
        name: name || `Шаблон автозакрытия ${index + 1}`,
        hours: normalizedHours,
        description,
      });
    });
    const activeInput = document.querySelector('input[name="autoCloseActive"]:checked');
    const activeId = activeInput?.value && templates.some((tpl) => tpl.id === activeInput.value)
      ? activeInput.value
      : (templates[0]?.id || null);
    const errors = hasInvalidHours ? ['Укажите корректное количество часов для всех шаблонов автозакрытия.'] : [];
    return { templates, active_template_id: activeId, errors };
  }

  function initAutoCloseTemplates() {
    const list = document.querySelector('[data-auto-close-templates]');
    if (!list) return;
    list.innerHTML = '';
    const rawTemplates = Array.isArray(AUTO_CLOSE_CONFIG.templates) ? AUTO_CLOSE_CONFIG.templates : [];
    const activeId = typeof AUTO_CLOSE_CONFIG.active_template_id === 'string' ? AUTO_CLOSE_CONFIG.active_template_id : null;
    if (rawTemplates.length) {
      rawTemplates.forEach((template) => {
        const card = buildAutoCloseTemplateCard(template);
        if (!card) return;
        const radio = card.querySelector('[data-auto-close-active]');
        if (radio instanceof HTMLInputElement) {
          const isActive = typeof template?.id === 'string' && template.id === activeId;
          radio.checked = isActive;
          radio.dispatchEvent(new Event('change'));
          card.dataset.templateId = template.id || card.dataset.templateId;
        }
        updateAutoCloseTemplateSummary(card);
      });
    } else {
      const card = buildAutoCloseTemplateCard({ hours: AUTO_CLOSE_FALLBACK_HOURS });
      if (card) {
        const radio = card.querySelector('[data-auto-close-active]');
        if (radio instanceof HTMLInputElement) {
          radio.checked = true;
          radio.dispatchEvent(new Event('change'));
        }
      }
    }

    if (!document.querySelector('input[name="autoCloseActive"]:checked')) {
      const firstRadio = list.querySelector('[data-auto-close-template] [data-auto-close-active]');
      if (firstRadio instanceof HTMLInputElement) {
        firstRadio.checked = true;
        firstRadio.dispatchEvent(new Event('change'));
      }
    }
  }

  function initDialogTemplates() {
    const categoryTemplates = Array.isArray(DIALOG_CONFIG.category_templates)
      ? DIALOG_CONFIG.category_templates
      : [];
    if (categoryTemplates.length) {
      categoryTemplates.forEach((template) => addCategoryTemplate(template));
    } else {
      const fallback = Array.isArray(FALLBACK_DIALOG_CATEGORIES)
        ? [...FALLBACK_DIALOG_CATEGORIES]
        : [];
      addCategoryTemplate({ categories: fallback });
    }

    const questionTemplates = Array.isArray(DIALOG_CONFIG.question_templates)
      ? DIALOG_CONFIG.question_templates
      : [];
    if (questionTemplates.length) {
      questionTemplates.forEach((template) => addQuestionTemplate(template));
    } else {
      addQuestionTemplate();
    }

    const completionTemplates = Array.isArray(DIALOG_CONFIG.completion_templates)
      ? DIALOG_CONFIG.completion_templates
      : [];
    if (completionTemplates.length) {
      completionTemplates.forEach((template) => addCompletionTemplate(template));
    } else {
      addCompletionTemplate();
    }
  }

  // === Сохранение всех настроек ===
  async function saveSettings() {
    try {
      const autoCloseState = collectAutoCloseConfig();
      if (autoCloseState.errors && autoCloseState.errors.length) {
        alert(autoCloseState.errors.join('\n'));
        return;
      }
      if (!autoCloseState.templates.length) {
        alert('Добавьте хотя бы один шаблон автозакрытия.');
        return;
      }
      const activeTemplate = autoCloseState.templates.find((tpl) => tpl.id === autoCloseState.active_template_id)
        || autoCloseState.templates[0];
      const autoCloseHours = activeTemplate?.hours || AUTO_CLOSE_FALLBACK_HOURS;
      const autoClosePayload = {
        templates: autoCloseState.templates,
        active_template_id: autoCloseState.active_template_id,
      };

      // Собираем шаблоны категорий
      const categoryTemplates = Array.from(document.querySelectorAll('[data-category-template]')).map((card, index) => {
        if (!(card instanceof HTMLElement)) return null;
        const templateId = card.dataset.templateId || generateDialogTemplateId('cat');
        card.dataset.templateId = templateId;
        const name = (card.querySelector('.category-template-name')?.value || '').trim();
        const categories = Array.from(card.querySelectorAll('.category-item-input'))
          .map((input) => (input.value || '').trim())
          .filter((value) => value);
        return {
          id: templateId,
          name: name || `Шаблон категорий ${index + 1}`,
          categories,
        };
      }).filter(Boolean);

      const fallbackCategories = categoryTemplates.length ? categoryTemplates[0].categories : [];

      // Собираем шаблоны вопросов
      const questionTemplates = Array.from(document.querySelectorAll('[data-question-template]')).map((card, index) => {
        if (!(card instanceof HTMLElement)) return null;
        const templateId = card.dataset.templateId || generateDialogTemplateId('q');
        card.dataset.templateId = templateId;
        const name = (card.querySelector('.question-template-name')?.value || '').trim();
        const questions = Array.from(card.querySelectorAll('.question-item-input'))
          .map((input) => (input.value || '').trim())
          .filter((value) => value);
        return {
          id: templateId,
          name: name || `Шаблон вопросов ${index + 1}`,
          questions,
        };
      }).filter(Boolean);

      // Собираем шаблоны действий
      const completionTemplates = Array.from(document.querySelectorAll('[data-completion-template]')).map((card, index) => {
        if (!(card instanceof HTMLElement)) return null;
        const templateId = card.dataset.templateId || generateDialogTemplateId('act');
        card.dataset.templateId = templateId;
        const name = (card.querySelector('.completion-template-name')?.value || '').trim();
        const items = Array.from(card.querySelectorAll('[data-completion-item]'))
          .map((row) => {
            if (!(row instanceof HTMLElement)) return null;
            const question = (row.querySelector('.completion-question-input')?.value || '').trim();
            const action = (row.querySelector('.completion-action-input')?.value || '').trim();
            if (!question && !action) return null;
            return { question, action };
          })
          .filter(Boolean);
        return {
          id: templateId,
          name: name || `Шаблон действий ${index + 1}`,
          items,
        };
      }).filter(Boolean);

      // Собираем статусы
      const statuses = Array.from(document.querySelectorAll('#statusesList .status-input'))
        .map(inp => inp.value.trim())
        .filter(v => v);

      const networkProfilesPayload = collectNetworkProfilesPayload();

      const response = await fetch('/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          categories: fallbackCategories,
          client_statuses: statuses,
          locations: locationsState,
          network_profiles: networkProfilesPayload,
          dialog_category_templates: categoryTemplates,
          dialog_question_templates: questionTemplates,
          dialog_completion_templates: completionTemplates,
          auto_close_config: autoClosePayload,
          auto_close_hours: autoCloseHours,
        })
      });
      
      const data = await response.json();
      if (data.success) {
        alert('✅ Настройки сохранены');
      } else {
        alert('❌ Ошибка: ' + (data.error || 'неизвестная ошибка'));
      }
    } catch (error) {
      alert('❌ Ошибка сети: ' + error.message);
    }
  }

  // === Запуск при загрузке страницы ===
  document.addEventListener('DOMContentLoaded', () => {
    initClientStatuses();
    initAutoCloseTemplates();
    initDialogTemplates();
    initLocationWizard();
    buildLocationsTree();
    loadChannels(); // <— добавили
    loadParameters();
    renderNetworkProfiles();
  });

  // === КАНАЛЫ (боты) ===
  const CHANNEL_STATES = new Map();
  let BOT_QUESTION_TEMPLATE_OPTIONS = [];
  let BOT_RATING_TEMPLATE_OPTIONS = [];
  let BOT_ACTIVE_QUESTION_TEMPLATE_ID = null;
  let BOT_ACTIVE_RATING_TEMPLATE_ID = null;

  const newChannelQuestionSelect = document.getElementById('ch_questions');
  const newChannelRatingSelect = document.getElementById('ch_rating');

  function maskToken(tok) {
    if (!tok) return '';
    return tok.replace(/^(.{10}).+(.{4})$/, '$1…$2');
  }

  function normalizeTemplateId(value, options, fallback) {
    if (typeof value === 'string' && value && options.some((opt) => opt.id === value)) {
      return value;
    }
    if (typeof fallback === 'string' && fallback && options.some((opt) => opt.id === fallback)) {
      return fallback;
    }
    return options.length ? options[0].id : null;
  }

  function buildQuestionTemplateLabel(template) {
    const name = template?.name ? String(template.name).trim() : 'Шаблон вопросов';
    let count = null;
    if (Number.isFinite(template?.questionsCount)) {
      count = template.questionsCount;
    } else if (Array.isArray(template?.questionFlow)) {
      count = template.questionFlow.length;
    }
    if (!Number.isFinite(count)) {
      return name;
    }
    const suffix = count === 1 ? '1 вопрос' : `${count} вопросов`;
    return `${name} · ${suffix}`;
  }

  function buildRatingTemplateLabel(template) {
    const name = template?.name ? String(template.name).trim() : 'Шаблон оценок';
    const scale = Number.isFinite(template?.scaleSize)
      ? template.scaleSize
      : Number.isFinite(template?.scale_size)
        ? template.scale_size
        : null;
    if (!Number.isFinite(scale) || scale <= 0) {
      return name;
    }
    return `${name} · шкала 1–${scale}`;
  }

  function populateTemplateSelect(select, options, selectedId) {
    if (!(select instanceof HTMLSelectElement)) {
      return;
    }
    const previousValue = typeof selectedId === 'string' ? selectedId : select.value;
    select.innerHTML = '';
    if (!Array.isArray(options) || !options.length) {
      const option = document.createElement('option');
      option.value = '';
      option.textContent = 'Нет доступных шаблонов';
      select.appendChild(option);
      select.disabled = true;
      select.value = '';
      return;
    }
    select.disabled = false;
    options.forEach((optionData) => {
      const option = document.createElement('option');
      option.value = optionData.id;
      option.textContent = optionData.label || optionData.name || optionData.id;
      if (optionData.title) {
        option.title = optionData.title;
      }
      select.appendChild(option);
    });
    const normalized = normalizeTemplateId(previousValue, options, options[0]?.id || '');
    select.value = normalized || options[0].id;
  }

  function updateNewChannelSelects() {
    populateTemplateSelect(newChannelQuestionSelect, BOT_QUESTION_TEMPLATE_OPTIONS, BOT_ACTIVE_QUESTION_TEMPLATE_ID);
    populateTemplateSelect(newChannelRatingSelect, BOT_RATING_TEMPLATE_OPTIONS, BOT_ACTIVE_RATING_TEMPLATE_ID);
  }

  function normalizeAllChannelStates() {
    CHANNEL_STATES.forEach((state, id) => {
      state.questionTemplateId = normalizeTemplateId(state.questionTemplateId, BOT_QUESTION_TEMPLATE_OPTIONS, BOT_ACTIVE_QUESTION_TEMPLATE_ID);
      state.ratingTemplateId = normalizeTemplateId(state.ratingTemplateId, BOT_RATING_TEMPLATE_OPTIONS, BOT_ACTIVE_RATING_TEMPLATE_ID);
      const rowEl = document.querySelector(`tr[data-channel-id="${id}"]`);
      if (!rowEl) {
        return;
      }
      const questionSelect = rowEl.querySelector('[data-role="channel-question-template"]');
      if (questionSelect) {
        populateTemplateSelect(questionSelect, BOT_QUESTION_TEMPLATE_OPTIONS, state.questionTemplateId);
      }
      const ratingSelect = rowEl.querySelector('[data-role="channel-rating-template"]');
      if (ratingSelect) {
        populateTemplateSelect(ratingSelect, BOT_RATING_TEMPLATE_OPTIONS, state.ratingTemplateId);
      }
    });
  }

  function handleBotSettingsSnapshot(snapshot) {
    const questionTemplates = Array.isArray(snapshot?.questionTemplates) ? snapshot.questionTemplates : [];
    BOT_QUESTION_TEMPLATE_OPTIONS = questionTemplates
      .map((template) => ({
        id: template?.id,
        name: template?.name || 'Шаблон вопросов',
        label: buildQuestionTemplateLabel(template),
        title: template?.description || '',
        questionsCount: template?.questionsCount,
      }))
      .filter((item) => typeof item.id === 'string' && item.id);
    BOT_ACTIVE_QUESTION_TEMPLATE_ID =
      typeof snapshot?.activeQuestionTemplateId === 'string' && snapshot.activeQuestionTemplateId.trim()
        ? snapshot.activeQuestionTemplateId.trim()
        : (BOT_QUESTION_TEMPLATE_OPTIONS[0]?.id || null);

    const ratingTemplates = Array.isArray(snapshot?.ratingTemplates) ? snapshot.ratingTemplates : [];
    BOT_RATING_TEMPLATE_OPTIONS = ratingTemplates
      .map((template) => {
        const scale = Number.isFinite(template?.scaleSize)
          ? template.scaleSize
          : Number.isFinite(template?.scale_size)
            ? template.scale_size
            : null;
        return {
          id: template?.id,
          name: template?.name || 'Шаблон оценок',
          label: buildRatingTemplateLabel({ ...template, scaleSize: scale }),
          title: template?.description || '',
          scaleSize: scale,
        };
      })
      .filter((item) => typeof item.id === 'string' && item.id);
    BOT_ACTIVE_RATING_TEMPLATE_ID =
      typeof snapshot?.activeRatingTemplateId === 'string' && snapshot.activeRatingTemplateId.trim()
        ? snapshot.activeRatingTemplateId.trim()
        : (BOT_RATING_TEMPLATE_OPTIONS[0]?.id || null);

    updateNewChannelSelects();
    normalizeAllChannelStates();
  }

  window.addEventListener('bot-settings:ready', (event) => {
    handleBotSettingsSnapshot(event.detail || {});
  });
  window.addEventListener('bot-settings:change', (event) => {
    handleBotSettingsSnapshot(event.detail || {});
  });
  if (window.BotSettingsBridge && typeof window.BotSettingsBridge.getSnapshot === 'function') {
    try {
      const snapshot = window.BotSettingsBridge.getSnapshot();
      if (snapshot) {
        handleBotSettingsSnapshot(snapshot);
      }
    } catch (error) {
      console.error('Не удалось получить настройки ботов:', error);
    }
  }

  function parseChannelState(row) {
    const state = { questionTemplateId: null, ratingTemplateId: null };
    let cfg = {};
    const rawCfg = row.questions_cfg;
    if (typeof rawCfg === 'string' && rawCfg.trim()) {
      try {
        cfg = JSON.parse(rawCfg);
      } catch (error) {
        cfg = {};
      }
    } else if (rawCfg && typeof rawCfg === 'object') {
      cfg = rawCfg;
    }
    const questionCandidate = (row.question_template_id || cfg.question_template_id || cfg.questionTemplateId || '').trim();
    const ratingCandidate = (row.rating_template_id || cfg.rating_template_id || cfg.ratingTemplateId || '').trim();
    state.questionTemplateId = questionCandidate || null;
    state.ratingTemplateId = ratingCandidate || null;
    return state;
  }

  function createChannelRow(row) {
    const tr = document.createElement('tr');
    tr.dataset.channelId = row.id;

    const idCell = document.createElement('td');
    idCell.textContent = row.id;
    tr.appendChild(idCell);

    const nameCell = document.createElement('td');
    const nameInput = document.createElement('input');
    nameInput.className = 'form-control form-control-sm';
    nameInput.value = row.channel_name || '';
    nameInput.dataset.field = 'channel_name';
    nameCell.appendChild(nameInput);
    tr.appendChild(nameCell);

    const botCell = document.createElement('td');
    const botName = ((row.bot_name || '').trim()) || '—';
    const botNameEl = document.createElement('div');
    botNameEl.className = 'fw-medium';
    botNameEl.textContent = botName;
    botCell.appendChild(botNameEl);
    if (row.bot_username) {
      const usernameEl = document.createElement('div');
      usernameEl.className = 'text-muted small';
      usernameEl.textContent = `@${row.bot_username}`;
      botCell.appendChild(usernameEl);
    }
    tr.appendChild(botCell);

    const tokenCell = document.createElement('td');
    const tokenCode = document.createElement('code');
    tokenCode.textContent = maskToken(row.token || '');
    tokenCell.appendChild(tokenCode);
    tr.appendChild(tokenCell);

    const activeCell = document.createElement('td');
    const switchWrapper = document.createElement('div');
    switchWrapper.className = 'form-check form-switch';
    const switchInput = document.createElement('input');
    switchInput.className = 'form-check-input';
    switchInput.type = 'checkbox';
    switchInput.dataset.field = 'is_active';
    switchInput.checked = !!row.is_active;
    switchWrapper.appendChild(switchInput);
    activeCell.appendChild(switchWrapper);
    tr.appendChild(activeCell);

    const state = CHANNEL_STATES.get(row.id);

    const questionsCell = document.createElement('td');
    const questionsSelect = document.createElement('select');
    questionsSelect.className = 'form-select form-select-sm';
    questionsSelect.dataset.role = 'channel-question-template';
    populateTemplateSelect(questionsSelect, BOT_QUESTION_TEMPLATE_OPTIONS, state?.questionTemplateId);
    questionsSelect.addEventListener('change', () => {
      if (!state) return;
      state.questionTemplateId = normalizeTemplateId(questionsSelect.value, BOT_QUESTION_TEMPLATE_OPTIONS, BOT_ACTIVE_QUESTION_TEMPLATE_ID);
      populateTemplateSelect(questionsSelect, BOT_QUESTION_TEMPLATE_OPTIONS, state.questionTemplateId);
    });
    questionsCell.appendChild(questionsSelect);
    tr.appendChild(questionsCell);

    const ratingCell = document.createElement('td');
    const ratingSelect = document.createElement('select');
    ratingSelect.className = 'form-select form-select-sm';
    ratingSelect.dataset.role = 'channel-rating-template';
    populateTemplateSelect(ratingSelect, BOT_RATING_TEMPLATE_OPTIONS, state?.ratingTemplateId);
    ratingSelect.addEventListener('change', () => {
      if (!state) return;
      state.ratingTemplateId = normalizeTemplateId(ratingSelect.value, BOT_RATING_TEMPLATE_OPTIONS, BOT_ACTIVE_RATING_TEMPLATE_ID);
      populateTemplateSelect(ratingSelect, BOT_RATING_TEMPLATE_OPTIONS, state.ratingTemplateId);
    });
    ratingCell.appendChild(ratingSelect);
    tr.appendChild(ratingCell);

    const actionsCell = document.createElement('td');
    actionsCell.className = 'text-nowrap';
    const saveBtn = document.createElement('button');
    saveBtn.type = 'button';
    saveBtn.className = 'btn btn-sm btn-success me-2';
    saveBtn.textContent = '💾 Сохранить';
    saveBtn.addEventListener('click', () => saveChannel(row.id));
    const deleteBtn = document.createElement('button');
    deleteBtn.type = 'button';
    deleteBtn.className = 'btn btn-sm btn-outline-danger';
    deleteBtn.textContent = '🗑 Удалить';
    deleteBtn.addEventListener('click', () => removeChannel(row.id));
    actionsCell.appendChild(saveBtn);
    actionsCell.appendChild(deleteBtn);
    tr.appendChild(actionsCell);

    return tr;
  }

  async function loadChannels() {
    try {
      const response = await fetch('/api/channels');
      if (!response.ok) throw new Error('HTTP ' + response.status);
      const rows = await response.json();
      const tbody = document.getElementById('channelsBody');
      tbody.innerHTML = '';
      CHANNEL_STATES.clear();
      if (!Array.isArray(rows) || !rows.length) {
        const empty = document.createElement('tr');
        empty.innerHTML = '<td colspan="8" class="text-center text-muted py-4">Каналы ещё не добавлены</td>';
        tbody.appendChild(empty);
        return;
      }
      rows.forEach((row) => {
        const state = parseChannelState(row);
        CHANNEL_STATES.set(row.id, state);
        const tr = createChannelRow(row);
        tbody.appendChild(tr);
      });
      normalizeAllChannelStates();
    } catch (error) {
      alert('Не удалось загрузить каналы: ' + error.message);
    }
  }

  async function addChannel() {
    const token = document.getElementById('ch_token').value.trim();
    const channelName = document.getElementById('ch_name').value.trim() || 'Канал';
    const questionTemplateId = normalizeTemplateId(newChannelQuestionSelect?.value, BOT_QUESTION_TEMPLATE_OPTIONS, BOT_ACTIVE_QUESTION_TEMPLATE_ID);
    const ratingTemplateId = normalizeTemplateId(newChannelRatingSelect?.value, BOT_RATING_TEMPLATE_OPTIONS, BOT_ACTIVE_RATING_TEMPLATE_ID);

    if (!token) {
      alert('Укажите токен');
      return;
    }
    if (!questionTemplateId) {
      alert('Создайте и выберите шаблон вопросов на вкладке «Шаблоны» блока «Каналы (боты)».');
      return;
    }
    if (!ratingTemplateId) {
      alert('Создайте и выберите систему оценок на вкладке «Шаблоны» блока «Каналы (боты)».');
      return;
    }
    try {
      const response = await fetch('/api/channels', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          token,
          channel_name: channelName,
          is_active: true,
          question_template_id: questionTemplateId,
          rating_template_id: ratingTemplateId,
          questions_cfg: {
            question_template_id: questionTemplateId,
            rating_template_id: ratingTemplateId,
          },
        }),
      });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || ('HTTP ' + response.status));
      }
      document.getElementById('ch_token').value = '';
      document.getElementById('ch_name').value = '';
      updateNewChannelSelects();
      await loadChannels();
    } catch (error) {
      alert('Ошибка добавления: ' + error.message);
    }
  }

  async function saveChannel(id) {
    const rowEl = document.querySelector(`tr[data-channel-id="${id}"]`);
    const state = CHANNEL_STATES.get(id);
    if (!rowEl || !state) return;

    const nameEl = rowEl.querySelector('[data-field="channel_name"]');
    const activeEl = rowEl.querySelector('[data-field="is_active"]');
    const questionSelect = rowEl.querySelector('[data-role="channel-question-template"]');
    const ratingSelect = rowEl.querySelector('[data-role="channel-rating-template"]');

    const channelName = (nameEl?.value || '').trim();
    if (!channelName) {
      alert('Укажите имя канала.');
      return;
    }

    state.questionTemplateId = normalizeTemplateId(questionSelect?.value, BOT_QUESTION_TEMPLATE_OPTIONS, BOT_ACTIVE_QUESTION_TEMPLATE_ID);
    state.ratingTemplateId = normalizeTemplateId(ratingSelect?.value, BOT_RATING_TEMPLATE_OPTIONS, BOT_ACTIVE_RATING_TEMPLATE_ID);

    const body = {
      channel_name: channelName,
      is_active: activeEl?.checked ? 1 : 0,
      question_template_id: state.questionTemplateId,
      rating_template_id: state.ratingTemplateId,
      questions_cfg: {
        question_template_id: state.questionTemplateId,
        rating_template_id: state.ratingTemplateId,
      },
    };

    try {
      const response = await fetch(`/api/channels/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || ('HTTP ' + response.status));
      }
      alert('Настройки канала сохранены.');
      await loadChannels();
    } catch (error) {
      alert('Ошибка сохранения: ' + error.message);
    }
  }

  async function removeChannel(id) {
    if (!confirm('Удалить канал?')) return;
    try {
      const response = await fetch(`/api/channels/${id}`, { method: 'DELETE' });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || ('HTTP ' + response.status));
      }
      CHANNEL_STATES.delete(id);
      await loadChannels();
    } catch (error) {
      alert('Ошибка удаления: ' + error.message);
    }
  }
  </script>
</main>
  <script src="{{ url_for('static', filename='auth-management.js') }}"></script>
  <script src="{{ url_for('static', filename='sidebar.js') }}"></script>
  <script src="{{ url_for('static', filename='modal-transitions.js') }}"></script>
  <script src="{{ url_for('static', filename='bot-settings.js') }}"></script>
</body>
</html>
