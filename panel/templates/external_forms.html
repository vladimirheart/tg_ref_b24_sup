<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–í–Ω–µ—à–Ω–∏–µ —Ñ–æ—Ä–º—ã ‚Äî Bender</title>
  <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='bender-icon.svg') }}" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='sidebar.css') }}" rel="stylesheet" />
  <style>
    .question-card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; margin-bottom: 10px; background: #f8fafc; }
    .question-card .form-label { font-weight: 600; }
    .form-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .link-badge { font-size: 0.85rem; word-break: break-all; }
  </style>
</head>
<body class="with-sidebar sidebar-pinned">
  {% include "_sidebar.html" %}
  <main class="main-content container-fluid">
    <div class="container-fluid mt-4">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-4">
        <div>
          <h2 class="mb-0">üåê –í–Ω–µ—à–Ω–∏–µ —Ñ–æ—Ä–º—ã</h2>
          <p class="text-muted mb-0">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ñ–æ—Ä–º—ã —Å –≤—ã–ø–∞–¥–∞—é—â–∏–º–∏ —Å–ø–∏—Å–∫–∞–º–∏, —Å–æ–±–∏—Ä–∞–π—Ç–µ –æ—Ç–≤–µ—Ç—ã –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–æ–¥–∏—Ç–µ –∑–∞–¥–∞—á–∏.</p>
        </div>
        <button class="btn btn-outline-secondary" type="button" id="resetFormBtn">–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É</button>
      </div>

      <div class="row g-4">
        <div class="col-lg-6">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0" id="formTitle">–ù–æ–≤–∞—è —Ñ–æ—Ä–º–∞</h5>
                <span class="badge bg-secondary" id="formStatusBadge">–ß–µ—Ä–Ω–æ–≤–∏–∫</span>
              </div>
              <form id="externalFormEditor" novalidate>
                <div class="mb-3">
                  <label class="form-label" for="formName">–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã *</label>
                  <input type="text" class="form-control" id="formName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ó–∞—è–≤–∫–∞ –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ" required />
                </div>
                <div class="mb-3">
                  <label class="form-label" for="formDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                  <textarea class="form-control" id="formDescription" rows="2" placeholder="–ö—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏—Ç–µ, –∑–∞—á–µ–º –Ω—É–∂–Ω–∞ —Ñ–æ—Ä–º–∞"></textarea>
                </div>
                <div class="row g-3 mb-3">
                  <div class="col-md-8">
                    <label class="form-label" for="notifyRole">–†–æ–ª—å –¥–ª—è –æ–ø–æ–≤–µ—â–µ–Ω–∏—è</label>
                    <select class="form-select" id="notifyRole">
                      <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                      {% for role in roles %}
                      <option value="{{ role.id }}">{{ role.name }}{% if role.description %} ‚Äî {{ role.description }}{% endif %}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-4 d-flex align-items-end">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="formActive" checked />
                      <label class="form-check-label" for="formActive">–§–æ—Ä–º–∞ –∞–∫—Ç–∏–≤–Ω–∞</label>
                    </div>
                  </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0">–í–æ–ø—Ä–æ—Å—ã —Ñ–æ—Ä–º—ã</h6>
                  <button class="btn btn-outline-primary btn-sm" type="button" id="addQuestionBtn">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
                </div>
                <div id="questionsContainer"></div>

                <div class="d-flex justify-content-between align-items-center mt-3">
                  <div id="formMessage" class="text-muted small"></div>
                  <div class="form-actions">
                    <button class="btn btn-primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ä–º—É</button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã</h5>
                <span class="text-muted" id="formsCount">0 —Ñ–æ—Ä–º</span>
              </div>
              <div class="table-responsive">
                <table class="table align-middle" id="formsTable">
                  <thead>
                    <tr>
                      <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                      <th>–†–æ–ª—å</th>
                      <th>–°—Ç–∞—Ç—É—Å</th>
                      <th>–°—Å—ã–ª–∫–∞</th>
                      <th class="text-end">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const AVAILABLE_ROLES = {{ roles | tojson }} || [];
    const questionsContainer = document.getElementById('questionsContainer');
    const addQuestionBtn = document.getElementById('addQuestionBtn');
    const formMessage = document.getElementById('formMessage');
    const formsTableBody = document.querySelector('#formsTable tbody');
    const formsCount = document.getElementById('formsCount');
    const formTitle = document.getElementById('formTitle');
    const formStatusBadge = document.getElementById('formStatusBadge');
    const resetFormBtn = document.getElementById('resetFormBtn');
    const formActiveInput = document.getElementById('formActive');
    const notifyRoleSelect = document.getElementById('notifyRole');
    const formNameInput = document.getElementById('formName');
    const formDescriptionInput = document.getElementById('formDescription');

    let currentFormId = null;
    let formsState = [];

    function showMessage(message, type = 'muted') {
      formMessage.textContent = message || '';
      formMessage.className = `small text-${type}`;
    }

    function createQuestionCard(question = {}) {
      const wrapper = document.createElement('div');
      wrapper.className = 'question-card';
      wrapper.dataset.questionId = question.id || '';

      wrapper.innerHTML = `
        <div class="d-flex justify-content-between align-items-start gap-2">
          <div class="flex-grow-1">
            <label class="form-label">–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ *</label>
            <input type="text" class="form-control" value="${question.text || ''}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ñ–∏—Å" required />
          </div>
          <div class="form-check ms-2 mt-4">
            <input class="form-check-input" type="checkbox" ${question.required ? 'checked' : ''} />
            <label class="form-check-label">–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π</label>
          </div>
        </div>
        <div class="mt-2">
          <label class="form-label">–í–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ *</label>
          <textarea class="form-control" rows="2" placeholder="–ö–∞–∂–¥—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏">${(question.options || []).join('\n')}</textarea>
          <div class="text-muted small mt-1">–ö–ª–∏–µ–Ω—Ç —Å–º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π.</div>
        </div>
        <div class="d-flex justify-content-end mt-2">
          <button type="button" class="btn btn-outline-danger btn-sm" data-action="remove">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      `;

      wrapper.querySelector('[data-action="remove"]').addEventListener('click', () => {
        wrapper.remove();
      });

      return wrapper;
    }

    function renderQuestions(questions = []) {
      questionsContainer.innerHTML = '';
      if (!questions.length) {
        questionsContainer.appendChild(createQuestionCard());
        return;
      }
      questions.forEach((q) => questionsContainer.appendChild(createQuestionCard(q)));
    }

    function collectQuestions() {
      const cards = Array.from(questionsContainer.querySelectorAll('.question-card'));
      return cards
        .map((card, index) => {
          const [textInput] = card.getElementsByTagName('input');
          const requiredInput = card.querySelector('.form-check-input');
          const optionsTextarea = card.querySelector('textarea');
          const text = (textInput?.value || '').trim();
          const options = (optionsTextarea?.value || '')
            .split('\n')
            .map((item) => item.trim())
            .filter(Boolean);

          if (!text || !options.length) return null;

          return {
            id: card.dataset.questionId || undefined,
            text,
            required: requiredInput?.checked || false,
            options,
            order: index,
          };
        })
        .filter(Boolean);
    }

    function resetEditor() {
      currentFormId = null;
      formTitle.textContent = '–ù–æ–≤–∞—è —Ñ–æ—Ä–º–∞';
      formStatusBadge.textContent = '–ß–µ—Ä–Ω–æ–≤–∏–∫';
      formStatusBadge.className = 'badge bg-secondary';
      formNameInput.value = '';
      formDescriptionInput.value = '';
      notifyRoleSelect.value = '';
      formActiveInput.checked = true;
      renderQuestions();
      showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É.');
    }

    function populateEditor(form) {
      currentFormId = form.id;
      formTitle.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${form.name}`;
      formStatusBadge.textContent = form.is_active ? '–ê–∫—Ç–∏–≤–Ω–∞' : '–í—ã–∫–ª—é—á–µ–Ω–∞';
      formStatusBadge.className = `badge ${form.is_active ? 'bg-success' : 'bg-secondary'}`;
      formNameInput.value = form.name || '';
      formDescriptionInput.value = form.description || '';
      notifyRoleSelect.value = form.notify_role_id || '';
      formActiveInput.checked = !!form.is_active;
      renderQuestions(form.questions || []);
      showMessage('–†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –ø–æ–ª—è –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ä–º—É¬ª.');
    }

    function renderFormsTable() {
      formsTableBody.innerHTML = '';
      if (!formsState.length) {
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = '<td colspan="5" class="text-center text-muted py-3">–§–æ—Ä–º—ã –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω—ã</td>';
        formsTableBody.appendChild(emptyRow);
        formsCount.textContent = '0 —Ñ–æ—Ä–º';
        return;
      }

      formsState.forEach((form) => {
        const tr = document.createElement('tr');
        const roleName = form.notify_role_name || '‚Äî';
        const statusBadge = form.is_active
          ? '<span class="badge bg-success">–ê–∫—Ç–∏–≤–Ω–∞</span>'
          : '<span class="badge bg-secondary">–í—ã–∫–ª—é—á–µ–Ω–∞</span>';

        tr.innerHTML = `
          <td>${form.name}</td>
          <td>${roleName}</td>
          <td>${statusBadge}</td>
          <td><span class="badge bg-light text-dark link-badge">${form.public_url}</span></td>
          <td class="text-end">
            <div class="btn-group btn-group-sm" role="group">
              <button class="btn btn-outline-primary" data-action="edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
              <button class="btn btn-outline-secondary" data-action="copy">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
            </div>
          </td>
        `;

        tr.querySelector('[data-action="edit"]').addEventListener('click', () => populateEditor(form));
        tr.querySelector('[data-action="copy"]').addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(form.public_url);
            showMessage('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
          } catch (err) {
            showMessage('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É', 'danger');
          }
        });

        formsTableBody.appendChild(tr);
      });
      formsCount.textContent = `${formsState.length} —Ñ–æ—Ä–º`;
    }

    async function loadForms() {
      try {
        const response = await fetch('/api/external_forms');
        const data = await response.json();
        if (!response.ok || data.success === false) {
          throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ä–º—ã');
        }
        formsState = data.forms || [];
        renderFormsTable();
      } catch (error) {
        showMessage(error.message, 'danger');
      }
    }

    async function saveForm(event) {
      event.preventDefault();
      const name = formNameInput.value.trim();
      const description = formDescriptionInput.value.trim();
      const questions = collectQuestions();
      const notify_role_id = notifyRoleSelect.value || null;
      const is_active = formActiveInput.checked;

      if (!name) {
        showMessage('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã', 'danger');
        return;
      }
      if (!questions.length) {
        showMessage('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏.', 'danger');
        return;
      }

      const payload = {
        id: currentFormId,
        name,
        description,
        notify_role_id,
        is_active,
        questions,
      };

      try {
        const response = await fetch('/api/external_forms', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await response.json();
        if (!response.ok || data.success === false) {
          throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ä–º—É');
        }
        showMessage('–§–æ—Ä–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success');
        await loadForms();
        if (data.form) {
          populateEditor(data.form);
        } else {
          resetEditor();
        }
      } catch (error) {
        showMessage(error.message, 'danger');
      }
    }

    document.getElementById('externalFormEditor').addEventListener('submit', saveForm);
    addQuestionBtn.addEventListener('click', () => questionsContainer.appendChild(createQuestionCard()));
    resetFormBtn.addEventListener('click', resetEditor);

    resetEditor();
    loadForms();
  </script>
</body>
</html>
