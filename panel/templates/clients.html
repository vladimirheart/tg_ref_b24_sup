<!-- panel/templates/clients.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–ª–∏–µ–Ω—Ç—ã ‚Äî –ü–∞–Ω–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='sidebar.css') }}" rel="stylesheet" />
  <style>
  	  /* –°—Ç–∞—Ç–∏—á–Ω—ã–π –≤–µ—Ä—Ö–Ω–∏–π –±–∞—Ä */
	.navbar{
	  position: sticky;
	  top: 0;
	  z-index: 1030; /* –≤—ã—à–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
	}
    .sortable{cursor:pointer;user-select:none;position:relative}
    .sortable::after{content:" ‚Üï";font-size:.8em;opacity:.5}
    .sort-asc::after{content:" ‚Üë";opacity:1}
    .sort-desc::after{content:" ‚Üì";opacity:1}

    .table-dark th.sortable{
      background-color:#003366!important;color:#fff!important;font-weight:bold;
      transition:background-color .2s ease;
    }
    .table-dark th.sortable:hover{background-color:#cce6ff!important;color:#000!important}
  </style>
</head>
<body class="with-sidebar sidebar-pinned">
  {% include "_sidebar.html" %}
  <main class="main-content container-fluid">
  <div class="container-fluid mt-4">
    <h2>üë• –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤</h2>

    {% if status_filter %}
    <div class="alert alert-info d-flex align-items-center justify-content-between" role="alert">
      <span>–ü–æ–∫–∞–∑–∞–Ω—ã –∫–ª–∏–µ–Ω—Ç—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º ¬´{{ status_filter }}¬ª.</span>
      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('clients_list') }}">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</a>
    </div>
    {% endif %}

    <div class="mb-3">
      <input type="text" id="searchClients" class="form-control" placeholder="–ü–æ–∏—Å–∫ –ø–æ ID, —é–∑–µ—Ä–Ω–µ–π–º—É, –∏–º–µ–Ω–∏, –∫–∞–Ω–∞–ª—É –∏–ª–∏ —Å—Ç–∞—Ç—É—Å—É">
    </div>
	<div class="mb-2">
	  <label class="form-label me-2">Blacklist:</label>
	  <select class="form-select form-select-sm" style="width:auto;display:inline-block"
			  onchange="location.href='?blacklist='+this.value">
		<option value="" {{ ''==blacklist_filter and 'selected' or '' }}>–í—Å–µ</option>
		<option value="1" {{ '1'==blacklist_filter and 'selected' or '' }}>–¢–æ–ª—å–∫–æ –≤ –±–ª—ç–∫–ª–∏—Å—Ç–µ</option>
		<option value="0" {{ '0'==blacklist_filter and 'selected' or '' }}>–¢–æ–ª—å–∫–æ –Ω–µ –≤ –±–ª—ç–∫–ª–∏—Å—Ç–µ</option>
	  </select>
	</div>

    <table class="table table-striped table-hover" id="clientsTable">
      <thead class="table-dark">
        <tr>
          <th class="sortable" onclick="sortTable(0)">ID Telegram</th>
          <th class="sortable" onclick="sortTable(1)">–Æ–∑–µ—Ä–Ω–µ–π–º</th>
          <th class="sortable" onclick="sortTable(2)">–ò–º—è –≤ –ë–î</th>
          <th class="sortable" onclick="sortTable(3)">–ò–º—è –∫–∞–Ω–∞–ª–∞</th>
          <th class="sortable" onclick="sortTable(4)">–ó–∞—è–≤–æ–∫</th>
          <th class="sortable" onclick="sortTable(5)">–ó–∞—Ç—Ä–∞—á–µ–Ω–æ –≤—Ä–µ–º–µ–Ω–∏</th>
          <th class="sortable" onclick="sortTable(6)">–ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç</th>
          <th class="sortable" onclick="sortTable(7)">–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–Ω—Ç–∞–∫—Ç</th>
          <th class="sortable" onclick="sortTable(8)">–°—Ç–∞—Ç—É—Å</th>
          <th>Blacklist</th>
                  <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody>
        {% for c in clients %}
        <tr data-search="{{ c.user_id }} {{ c.username }} {{ c.client_name }} {{ c.channel_name }} {{ c.formatted_time }} {{ c.client_status }}">
          <td>
                          <div class="d-flex align-items-center gap-2">
                                <img src="/avatar/{{ c.user_id }}" width="24" height="24" class="rounded-circle" style="object-fit:cover;border:1px solid rgba(0,0,0,.08)" alt="">
                                <code>{{ c.user_id }}</code>
                          </div>
                  </td>
                  <td>{{ c.username or '‚Äî' }}</td>
          <td>{{ c.client_name if c.client_name and c.client_name != 'None' else '‚Äî' }}</td>
          <td>{{ c.channel_name or '‚Äî' }}</td>
          <td>{{ c.ticket_count }}</td>
          <td>{{ c.formatted_time }}</td>
          <td>
            {% if c.first_contact %}
              {{ c.first_contact.split('.')[0]|replace('T', ' ') }}
            {% else %} ‚Äî {% endif %}
          </td>
          <td>
            {% if c.last_contact %}
              {{ c.last_contact.split('.')[0]|replace('T', ' ') }}
            {% else %} ‚Äî {% endif %}
          </td>
          <td>{{ c.client_status or '‚Äî' }}</td>
                        <td>
                          {% if c.blacklist %}
                                <span class="badge text-bg-danger">–î–∞</span>
                                {% if c.unblock_requested %}
				  <span class="badge text-bg-warning ms-1">–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–Ω—è—Ç–∏–µ</span>
				{% endif %}
			  {% else %}
				<span class="badge text-bg-secondary">–ù–µ—Ç</span>
			  {% endif %}
			</td>
          <td>
            <a href="/client/{{ c.user_id }}" class="btn btn-sm btn-outline-info">–ö–∞—Ä—Ç–æ—á–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script>
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Å —É—á—ë—Ç–æ–º —Ç–∏–ø–æ–≤ –∫–æ–ª–æ–Ω–æ–∫
    function sortTable(colIndex){
      const table = document.getElementById('clientsTable');
      const tbody = table.tBodies[0];
      const rows = Array.from(tbody.rows);

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ –∫–ª–∞—Å—Å—É –Ω–∞ —Ç–µ–∫—É—â–µ–º TH
      const th = table.tHead.rows[0].cells[colIndex];
      const asc = !th.classList.contains('sort-asc');

      // –°–±—Ä–æ—Å –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ –Ω–∞ –≤—Å–µ—Ö –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö
      table.querySelectorAll('thead th.sortable').forEach(h => h.classList.remove('sort-asc','sort-desc'));
      th.classList.add(asc ? 'sort-asc' : 'sort-desc');

      // –ü–∞—Ä—Å–µ—Ä "–ó–∞—Ç—Ä–∞—á–µ–Ω–æ –≤—Ä–µ–º–µ–Ω–∏": "X —á Y –º–∏–Ω" -> –º–∏–Ω—É—Ç—ã
      function parseTimeToMinutes(str){
        if(!str || str === '‚Äî') return 0;
        let m = 0;
        const h = str.match(/(\d+)\s*—á/); if(h) m += parseInt(h[1])*60;
        const mi = str.match(/(\d+)\s*–º–∏–Ω/); if(mi) m += parseInt(mi[1]);
        return m;
      }

      rows.sort((a,b)=>{
        let A = a.cells[colIndex].textContent.trim();
        let B = b.cells[colIndex].textContent.trim();

        // –ö–æ–ª–æ–Ω–∫–∞ 4 (–∏–Ω–¥–µ–∫—Å 4) ‚Äî –ó–∞—è–≤–æ–∫ (—á–∏—Å–ª–æ)
        if(colIndex === 4){
          const aN = parseInt(A)||0, bN = parseInt(B)||0;
          return asc ? (aN-bN) : (bN-aN);
        }
        // –ö–æ–ª–æ–Ω–∫–∞ 5 ‚Äî –ó–∞—Ç—Ä–∞—á–µ–Ω–æ –≤—Ä–µ–º–µ–Ω–∏
        if(colIndex === 5){
          const aM = parseTimeToMinutes(A), bM = parseTimeToMinutes(B);
          return asc ? (aM-bM) : (bM-aM);
        }
        // –ö–æ–ª–æ–Ω–∫–∏ 6 –∏ 7 ‚Äî –¥–∞—Ç—ã
        if(colIndex === 6 || colIndex === 7){
          const aD = (A && A !== '‚Äî') ? new Date(A) : new Date(0);
          const bD = (B && B !== '‚Äî') ? new Date(B) : new Date(0);
          return asc ? (aD - bD) : (bD - aD);
        }
        // –û—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî —Å—Ç—Ä–æ–∫–∏
        return asc ? A.localeCompare(B) : B.localeCompare(A);
      });

      // –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º
      tbody.innerHTML = '';
      rows.forEach(r => tbody.appendChild(r));
    }

    // –ü–æ–∏—Å–∫ (ID, —é–∑–µ—Ä–Ω–µ–π–º, –∏–º—è, –∫–∞–Ω–∞–ª, –≤—Ä–µ–º—è, —Å—Ç–∞—Ç—É—Å)
    document.getElementById('searchClients').addEventListener('input', function(){
      const q = this.value.toLowerCase();
      document.querySelectorAll('#clientsTable tbody tr').forEach(tr=>{
        const text = (tr.dataset.search||'').toLowerCase();
        tr.style.display = text.includes(q) ? '' : 'none';
      });
    });
  </script>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{{ url_for('static', filename='sidebar.js') }}"></script>
  <script src="{{ url_for('static', filename='modal-transitions.js') }}"></script>
</body>
</html>
