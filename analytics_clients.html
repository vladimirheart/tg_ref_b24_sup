<!-- panel/templates/analytics_clients.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .client-row:hover {
      background-color: #f8f9fa;
      cursor: pointer;
    }
    .name-block {
      font-size: 0.95em;
    }
    .name-block .db-name {
      color: #007bff;
      font-weight: 500;
    }
    .name-block .tg-name {
      color: #6c757d;
    }
    .accordion-button::after {
      background-image: none;
      content: "‚ñº";
      font-size: 0.8em;
      transform: rotate(-90deg);
    }
    .accordion-button:not(.collapsed)::after {
      transform: rotate(0);
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="/">üì¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞</a>
      <div class="navbar-nav ms-auto">
		<a class="nav-link" href="/">–ó–∞—è–≤–∫–∏</a>
        <a class="nav-link" href="/analytics">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
        <a class="nav-link active" href="/analytics/clients">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤</a>
        <a class="nav-link" href="/clients">–ö–ª–∏–µ–Ω—Ç—ã</a>
        <a class="nav-link" href="/dashboard">–î–∞—à–±–æ—Ä–¥</a>
        <a class="nav-link" href="/settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
        <a class="nav-link" href="/logout">–í—ã—Ö–æ–¥</a>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <h2>üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤</h2>

    <div class="row mb-4">
      <div class="col-md-6">
        <h4>–¢–æ–ø-10 –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞—è–≤–æ–∫</h4>
        <ul class="list-group">
          {% for c in top_clients %}
          <li class="list-group-item d-flex justify-content-between align-items-center client-row" 
              onclick="loadClientDetails({{ c.user_id }})">
            <div>
              <strong>{{ c.username or c.user_id }}</strong><br>
              <small>ID: {{ c.user_id }} | –ó–∞—è–≤–æ–∫: {{ c.ticket_count }}</small>
            </div>
            <span class="badge bg-primary rounded-pill">{{ c.ticket_count }}</span>
          </li>
          {% endfor %}
        </ul>
      </div>
      <div class="col-md-6">
        <h4>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
        <ul class="list-group">
          {% for status, cnt in status_data.items() %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            {{ status }}
            <span class="badge bg-info text-dark rounded-pill">{{ cnt }}</span>
          </li>
          {% endfor %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            –í—Å–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤
            <span class="badge bg-secondary rounded-pill">{{ top_clients | length }}</span>
          </li>
        </ul>
      </div>
    </div>

    <h4>üìã –í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã</h4>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>ID Telegram</th>
          <th>–ò–º—è / –Æ–∑–µ—Ä–Ω–µ–π–º</th>
          <th>–ó–∞—è–≤–æ–∫</th>
          <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–Ω—Ç–∞–∫—Ç</th>
          <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
        </tr>
      </thead>
      <tbody>
        {% for c in top_clients %}
        <tr>
          <td><code>{{ c.user_id }}</code></td>
          <td>
            <div class="name-block">
              <div class="tg-name">{{ c.username or '‚Äî' }}</div>
              {% if c.client_name %}
                <div class="db-name">–ò–º—è –≤ –ë–î: {{ c.client_name }}</div>
              {% endif %}
            </div>
          </td>
          <td>{{ c.ticket_count }}</td>
          <td>
            {% if c.last_contact %}
              {{ c.last_contact.split(' ')[0] }}
            {% else %}
              ‚Äî
            {% endif %}
          </td>
          <td>
            <button class="btn btn-sm btn-outline-info" onclick="loadClientDetails({{ c.user_id }})">
              –ü–æ–¥—Ä–æ–±–Ω–µ–µ
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –¥–µ—Ç–∞–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞ -->
  <div class="modal fade" id="clientDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="clientModalTitle">–ö–ª–∏–µ–Ω—Ç: –∑–∞–≥—Ä—É–∑–∫–∞...</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="clientDetailsBody">
          <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    async function loadClientDetails(user_id) {
  const modal = new bootstrap.Modal(document.getElementById('clientDetailsModal'));
  const title = document.getElementById('clientModalTitle');
  const body = document.getElementById('clientDetailsBody');
  
  title.textContent = `–ö–ª–∏–µ–Ω—Ç: ${user_id}`;
  body.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>';

  try {
    const response = await fetch(`/client/${user_id}`);
    const html = await response.text();
    
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const container = doc.querySelector('.container');
    
    if (container) {
      body.innerHTML = container.innerHTML;

      // –£–¥–∞–ª—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
      const nav = body.querySelector('nav');
      if (nav) nav.remove();

      // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      const backBtn = body.querySelector('.btn[href="/clients"]');
      if (backBtn) {
        backBtn.href = "#";
        backBtn.onclick = (e) => {
          e.preventDefault();
          modal.hide();
        };
      }

    } else {
      body.innerHTML = '<p class="text-danger">–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω .container</p>';
    }

  } catch (e) {
    body.innerHTML = `<p class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}</p>`;
  }

  modal.show();
}
  </script>
</body>
</html>