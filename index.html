<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü–∞–Ω–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.22.1/dist/bootstrap-table.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet" />
  <style>
    /* –°—Ç–∞—Ç–∏—á–Ω—ã–π –≤–µ—Ä—Ö–Ω–∏–π –±–∞—Ä */
    .navbar {
      position: sticky;
      top: 0;
      z-index: 1030;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü */
    @media (max-width: 1024px) {
      .container {
        padding-left: 10px;
        padding-right: 10px;
      }
      
      .navbar-nav {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .navbar-nav .nav-link {
        padding: 0.5rem;
        font-size: 0.9rem;
      }
      
      .table-responsive {
        font-size: 0.85rem;
      }
      
      .chat-bubble {
        max-width: 90%;
      }
      
      .input-group-send {
        flex-direction: column;
      }
      
      .input-group-send textarea {
        min-height: 80px;
      }
      
      .modal-dialog {
        margin: 10px;
      }
      
      .btn-sm {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
      }
    }
    
    @media (max-width: 576px) {
      h2 {
        font-size: 1.5rem;
      }
      
      .badge {
        font-size: 0.7rem;
        margin-bottom: 5px;
      }
      
      .form-select, .form-control {
        font-size: 0.9rem;
      }
      
      .pagination {
        flex-wrap: wrap;
      }
      
      .page-link {
        padding: 0.3rem 0.6rem;
        font-size: 0.85rem;
      }
    }

    .chat-bubble { 
      padding: 8px 12px; 
      border-radius: 8px; 
      margin-bottom: 6px; 
      max-width: 80%; 
      word-wrap: break-word;
    }
    .from-user { background: #e3f2fd; align-self: flex-end; }
    .from-support { background: #d1f7d1; align-self: flex-start; }

    .chat-container { 
      min-height: 300px; 
      max-height: 500px; 
      overflow-y: auto; 
      padding: 10px; 
    }

    .chat-bubble p, .chat-bubble small, .chat-bubble strong {
      color: #000 !important;
    }

    .input-group-send {
      display: flex;
      align-items: stretch;
      gap: 8px;
    }
    .input-group-send textarea {
      flex: 1;
      resize: both;
      min-height: 60px;
      max-height: 200px;
    }
    .input-group-send .btn {
      white-space: nowrap;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –±–∏–∑–Ω–µ—Å–æ–≤ */
    .business-sushi { background-color: #F25F79 !important; color: white !important; }
    .business-blin { background-color: #FFD504 !important; color: black !important; }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è resize —Å—Ç–æ–ª–±—Ü–æ–≤ */
    .table th { 
      position: relative; 
      user-select: none;
    }
    .resize-handle {
      position: absolute;
      top: 0;
      right: 0;
      width: 5px;
      height: 100%;
      background-color: #ddd;
      cursor: col-resize;
      user-select: none;
    }
    
    .clickable-client {
      cursor: pointer;
      color: #0d6efd;
      text-decoration: underline;
    }
    .clickable-client:hover {
      color: #0a58ca;
    }

    .column-toggle {
      max-height: 300px;
      overflow-y: auto;
    }

    .problem-info {
      background-color: #f8f9fa;
      border-left: 4px solid #0d6efd;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 4px;
    }

    .resizing {
      cursor: col-resize;
      user-select: none;
    }

    .table-column-hidden {
      display: none;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã */
    .table th, .table td {
      word-break: break-word;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="/">üì¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <div class="navbar-nav ms-auto">
          <a class="nav-link" href="/analytics">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
          <a class="nav-link" href="/analytics/clients">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤</a>
          <a class="nav-link" href="/clients">–ö–ª–∏–µ–Ω—Ç—ã</a>
          <a class="nav-link" href="/dashboard">–î–∞—à–±–æ—Ä–¥</a>
          <a class="nav-link" href="/settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
          <a class="nav-link" href="/logout">–í—ã—Ö–æ–¥</a>
        </div>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>–°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫</h2>
      <div>
        <button class="btn btn-outline-secondary me-2" onclick="toggleColumnSettings()">
          ‚öôÔ∏è –°—Ç–æ–ª–±—Ü—ã
        </button>
        <select id="pageSize" class="form-select" style="width: 120px; display: inline-block;">
          <option value="5">5 –∑–∞—è–≤–æ–∫</option>
          <option value="20" selected>20 –∑–∞—è–≤–æ–∫</option>
          <option value="50">50 –∑–∞—è–≤–æ–∫</option>
          <option value="100">100 –∑–∞—è–≤–æ–∫</option>
          <option value="500">500 –∑–∞—è–≤–æ–∫</option>
        </select>
      </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ -->
    <div class="modal fade" id="columnSettingsModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body column-toggle">
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="toggleClient" checked>
              <label class="form-check-label" for="toggleClient">–ö–ª–∏–µ–Ω—Ç</label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="toggleClientStatus" checked>
              <label class="form-check-label" for="toggleClientStatus">–°—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞</label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="toggleTicketId" checked>
              <label class="form-check-label" for="toggleTicketId">ID –∑–∞—è–≤–∫–∏</label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="toggleBusiness" checked>
              <label class="form-check-label" for="toggleBusiness">–ë–∏–∑–Ω–µ—Å</label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="toggleLocation" checked>
              <label class="form-check-label" for="toggleLocation">–õ–æ–∫–∞—Ü–∏—è</label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="toggleProblem" checked>
              <label class="form-check-label" for="toggleProblem">–ü—Ä–æ–±–ª–µ–º–∞</label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="toggleResponsible" checked>
              <label class="form-check-label" for="toggleResponsible">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="toggleStatus" checked>
              <label class="form-check-label" for="toggleStatus">–°—Ç–∞—Ç—É—Å</label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="toggleDate" checked>
              <label class="form-check-label" for="toggleDate">–î–∞—Ç–∞</label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="toggleTime" checked>
              <label class="form-check-label" for="toggleTime">–í—Ä–µ–º—è</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            <button type="button" class="btn btn-primary" onclick="applyColumnSettings()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          </div>
        </div>
      </div>
    </div>

    <div class="filter-grid">
  <div class="input-group">
    <span class="input-group-text">üîç</span>
    <input type="text" id="searchInput" class="form-control" placeholder="–ü–æ–∏—Å–∫...">
  </div>
  
  <select id="filterStatus" class="form-select">
    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
    <option value="pending">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
    <option value="resolved">–†–µ—à–µ–Ω–æ</option>
  </select>
  
  <input type="text" id="filterUser" class="form-control" placeholder="–ö–ª–∏–µ–Ω—Ç (ID)">
  
  <input type="text" id="filterTicketId" class="form-control" placeholder="ID –∑–∞—è–≤–∫–∏">
  
  <input type="text" id="filterBusiness" class="form-control" placeholder="–ë–∏–∑–Ω–µ—Å">
  
  <input type="text" id="filterLocation" class="form-control" placeholder="–õ–æ–∫–∞—Ü–∏—è">
  
  <input type="text" id="filterClientStatus" class="form-control" placeholder="–°—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞">
  
  <input type="text" id="filterResponsible" class="form-control" placeholder="–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π">
  
  <input type="date" id="filterDateFrom" class="form-control" placeholder="–û—Ç –¥–∞—Ç—ã">
  
  <input type="date" id="filterDateTo" class="form-control" placeholder="–î–æ –¥–∞—Ç—ã">
</div>

    <div class="table-responsive">
      <table class="table table-striped" id="ticketsTable">
        <thead>
          <tr>
            <th data-column="client" data-field="client" data-resizable="true">–ö–ª–∏–µ–Ω—Ç</th>
            <th data-column="clientStatus" data-field="clientStatus" data-resizable="true">–°—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞</th>
            <th data-column="ticketId" data-field="ticketId" data-resizable="true">ID –∑–∞—è–≤–∫–∏</th>
            <th data-column="business" data-field="business" data-resizable="true">–ë–∏–∑–Ω–µ—Å</th>
            <th data-column="location" data-field="location" data-resizable="true">–õ–æ–∫–∞—Ü–∏—è</th>
            <th data-column="problem" data-field="problem" data-resizable="true">–ü—Ä–æ–±–ª–µ–º–∞</th>
            <th data-column="responsible" data-field="responsible" data-resizable="true">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th>
            <th data-column="status" data-field="status" data-resizable="true">–°—Ç–∞—Ç—É—Å</th>
            <th data-column="date" data-field="date" data-resizable="true">–î–∞—Ç–∞</th>
            <th data-column="time" data-field="time" data-resizable="true">–í—Ä–µ–º—è</th>
            <th data-column="actions" data-field="actions" data-resizable="true">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody id="ticketsBody">
        </tbody>
      </table>
    </div>

    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center" id="pagination">
      </ul>
    </nav>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –æ—Ç–≤–µ—Ç -->
  <div class="modal fade" id="replyModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">–û—Ç–≤–µ—Ç–∏—Ç—å</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <textarea id="replyText" class="form-control" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç..."></textarea>
          <input type="text" id="adminName" class="form-control mt-2" value="–ü–æ–¥–¥–µ—Ä–∂–∫–∞">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          <button type="button" class="btn btn-success" onclick="sendReply()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –∏—Å—Ç–æ—Ä–∏—è -->
  <div class="modal fade resizable-modal" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable modal-lg modal-dialog-centered" style="width: 80%; height: 80%;">
      <div class="modal-content" style="min-height: 400px;">
        <div class="modal-header">
          <h5 class="modal-title" id="historyModalTitle">üí¨ –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ ‚Äî ID –∑–∞—è–≤–∫–∏: <span id="ticketIdDisplay"></span></h5>
          <div class="d-flex align-items-center gap-2">
            <span id="clientDisplayName">‚Äî</span>
            <span class="badge bg-info" id="clientStatusDisplay"></span>
            <button type="button" class="btn btn-sm btn-outline-primary" id="editClientBtn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–º—è">
              ‚úèÔ∏è
            </button>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" style="padding: 0;">
          <div class="problem-info" id="problemInfo">
            <strong>–ü—Ä–æ–±–ª–µ–º–∞:</strong> <span id="problemText"></span>
          </div>
          <div class="chat-container" id="historyContent" style="min-height: 300px; padding: 15px;"></div>
        </div>
        <div class="modal-footer">
          <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫–∞ —Ä–µ–∂–∏–º–∞ -->
          <div class="input-group-send w-100">
            <textarea
              id="replyTextInHistory"
              class="form-control"
              placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç..."
            ></textarea>
            <button id="sendKeySettingBtn" class="btn btn-outline-secondary" type="button" style="width: 120px;" data-bs-toggle="dropdown">
              Enter ‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" data-mode="enter">Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</a></li>
              <li><a class="dropdown-item" href="#" data-mode="ctrlEnter">Ctrl+Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</a></li>
              <li><a class="dropdown-item" href="#" data-mode="enterNewline">Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞</a></li>
            </ul>
          </div>
          <div class="mt-2 d-flex justify-content-between w-100">
            <button type="button" id="closeTicketBtn" class="btn btn-danger">–ó–∞–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É</button>
            <button type="button" id="sendReplyInHistory" class="btn btn-primary">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –∑–∞–∫—Ä—ã—Ç–∏–µ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π -->
  <div class="modal fade" id="closeTicketModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">–ó–∞–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label for="categorySelect" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è</label>
          <select id="categorySelect" class="form-select">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>
          </select>
          <div class="form-text">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø–æ–º–æ–∂–µ—Ç –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          <button type="button" id="confirmCloseTicketBtn" class="btn btn-danger">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∞ -->
  <div class="modal fade" id="editClientNameModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∞</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="clientNameInput" class="form-label">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
            <input type="text" class="form-control" id="clientNameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞">
          </div>
          <div class="mb-3">
            <label for="clientUsernameInput" class="form-label">Username</label>
            <input type="text" class="form-control" id="clientUsernameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ username">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          <button type="button" class="btn btn-primary" onclick="saveClientName()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    window.settings = {
  "categories": {{ settings.categories | tojson if settings and settings.categories else '["–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è"]' | safe }}
};
  </script>
  <script>
    let currentUserId = null;
    let currentTicketId = null;
    let historyPolling = null;
    let clientData = null;
    let currentPageSize = 20;
    let columnSettings = {
      client: true,
      clientStatus: true,
      ticketId: true,
      business: true,
      location: true,
      problem: true,
      responsible: true,
      status: true,
      date: true,
      time: true,
      actions: true
    };
    
	// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤
function saveColumnWidths() {
  const widths = {};
  document.querySelectorAll('th[data-column]').forEach(th => {
    const column = th.getAttribute('data-column');
    widths[column] = th.style.width || getComputedStyle(th).width;
  });
  localStorage.setItem('columnWidths', JSON.stringify(widths));
}

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤
function restoreColumnWidths() {
  const savedWidths = localStorage.getItem('columnWidths');
  if (savedWidths) {
    const widths = JSON.parse(savedWidths);
    Object.keys(widths).forEach(column => {
      const th = document.querySelector(`th[data-column="${column}"]`);
      if (th && widths[column]) {
        th.style.width = widths[column];
        const index = Array.from(th.parentNode.children).indexOf(th);
        document.querySelectorAll('#ticketsBody tr').forEach(row => {
          const cell = row.children[index];
          if (cell) cell.style.width = widths[column];
        });
      }
    });
  }
}
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å—Ç–æ–ª–±—Ü–æ–≤
    const savedColumnSettings = localStorage.getItem('columnSettings');
    if (savedColumnSettings) {
      columnSettings = JSON.parse(savedColumnSettings);
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    const savedPageSize = localStorage.getItem('pageSize');
    if (savedPageSize) {
      currentPageSize = parseInt(savedPageSize);
      document.getElementById('pageSize').value = currentPageSize;
    }

    // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è resize —Å—Ç–æ–ª–±—Ü–æ–≤ ===
function initColumnResize() {
  const headers = document.querySelectorAll('th[data-resizable="true"]');
  headers.forEach(header => {
    const oldHandle = header.querySelector('.resize-handle');
    if (oldHandle) {
      oldHandle.remove();
    }
    
    const handle = document.createElement('div');
    handle.className = 'resize-handle';
    header.appendChild(handle);
    
    let startX, startWidth;
    
    handle.addEventListener('mousedown', function(e) {
      startX = e.pageX;
      startWidth = header.offsetWidth;
      document.documentElement.classList.add('resizing');
      
      function onMouseMove(e) {
        const width = startWidth + (e.pageX - startX);
        if (width > 50) {
          header.style.width = width + 'px';
          const index = Array.from(header.parentNode.children).indexOf(header);
          document.querySelectorAll('#ticketsBody tr').forEach(row => {
            const cell = row.children[index];
            if (cell) cell.style.width = width + 'px';
          });
        }
      }
      
      function onMouseUp() {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        document.documentElement.classList.remove('resizing');
        saveColumnWidths(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —à–∏—Ä–∏–Ω—É –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
      }
      
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
      e.preventDefault();
    });
  });

    }function initColumnResize() {
  const headers = document.querySelectorAll('th[data-resizable="true"]');
  headers.forEach(header => {
    const oldHandle = header.querySelector('.resize-handle');
    if (oldHandle) {
      oldHandle.remove();
    }
    
    const handle = document.createElement('div');
    handle.className = 'resize-handle';
    header.appendChild(handle);
    
    let startX, startWidth;
    
    handle.addEventListener('mousedown', function(e) {
      startX = e.pageX;
      startWidth = header.offsetWidth;
      document.documentElement.classList.add('resizing');
      
      function onMouseMove(e) {
        const width = startWidth + (e.pageX - startX);
        if (width > 50) {
          header.style.width = width + 'px';
          const index = Array.from(header.parentNode.children).indexOf(header);
          document.querySelectorAll('#ticketsBody tr').forEach(row => {
            const cell = row.children[index];
            if (cell) cell.style.width = width + 'px';
          });
        }
      }
      
      function onMouseUp() {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        document.documentElement.classList.remove('resizing');
        saveColumnWidths(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —à–∏—Ä–∏–Ω—É –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
      }
      
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
      e.preventDefault();
    });
  });
}

    // === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ ===
    function toggleColumnSettings() {
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤
      Object.keys(columnSettings).forEach(key => {
        const checkbox = document.getElementById(`toggle${key.charAt(0).toUpperCase() + key.slice(1)}`);
        if (checkbox) {
          checkbox.checked = columnSettings[key];
        }
      });
      new bootstrap.Modal(document.getElementById('columnSettingsModal')).show();
    }

    function applyColumnSettings() {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      Object.keys(columnSettings).forEach(key => {
        const checkbox = document.getElementById(`toggle${key.charAt(0).toUpperCase() + key.slice(1)}`);
        if (checkbox) {
          columnSettings[key] = checkbox.checked;
        }
      });
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ localStorage
      localStorage.setItem('columnSettings', JSON.stringify(columnSettings));
      
      // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ —Ç–∞–±–ª–∏—Ü–µ
      document.querySelectorAll('th[data-column]').forEach(th => {
        const column = th.getAttribute('data-column');
        const index = Array.from(th.parentNode.children).indexOf(th);
        
        if (columnSettings[column]) {
          th.classList.remove('table-column-hidden');
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫—É –≤ —Ç–µ–ª–µ —Ç–∞–±–ª–∏—Ü—ã
          document.querySelectorAll('#ticketsBody tr').forEach(row => {
            if (row.children[index]) {
              row.children[index].classList.remove('table-column-hidden');
            }
          });
        } else {
          th.classList.add('table-column-hidden');
          // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫—É –≤ —Ç–µ–ª–µ —Ç–∞–±–ª–∏—Ü—ã
          document.querySelectorAll('#ticketsBody tr').forEach(row => {
            if (row.children[index]) {
              row.children[index].classList.add('table-column-hidden');
            }
          });
        }
      });
      
      bootstrap.Modal.getInstance(document.getElementById('columnSettingsModal')).hide();
    }
    
    // === –û—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –æ—Ç–≤–µ—Ç–∞ ===
    function openReplyModal(user_id) {
      currentUserId = user_id;
      document.getElementById('replyText').value = '';
      new bootstrap.Modal(document.getElementById('replyModal')).show();
    }

    // === –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç ===
    async function sendReply() {
      const text = document.getElementById('replyText').value.trim();
      const admin = document.getElementById('adminName').value || '–ü–æ–¥–¥–µ—Ä–∂–∫–∞';
      if (!text) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞');
        return;
      }

      const response = await fetch('/reply', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: currentUserId, text, admin })
      });

      const data = await response.json();
      if (data.success) {
        alert('‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
        location.reload();
      } else {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
      }
    }

    // === –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ ===
    function loadSendSettings() {
      const saved = localStorage.getItem('sendKeySetting') || 'enter';
      const btn = document.getElementById('sendKeySettingBtn');
      updateSendButtonLabel(saved);
      return saved;
    }

    function updateSendButtonLabel(mode) {
      const btn = document.getElementById('sendKeySettingBtn');
      const labels = {
        'enter': 'Enter ‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å',
        'ctrlEnter': 'Ctrl+Enter ‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å',
        'enterNewline': 'Enter ‚Üí –ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞'
      };
      btn.textContent = labels[mode] || 'Enter ‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å';
    }

    // === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ ===
    document.querySelectorAll('#sendKeySettingBtn + .dropdown-menu a').forEach(item => {
      item.addEventListener('click', function (e) {
        e.preventDefault();
        const mode = this.getAttribute('data-mode');
        localStorage.setItem('sendKeySetting', mode);
        updateSendButtonLabel(mode);
      });
    });

    // === –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã ===
    async function autoRefreshTickets() {
      try {
        const responseStats = await fetch('/stats_data');
        const data = await responseStats.json();

        const totalEl = document.getElementById('total');
        const pendingEl = document.getElementById('pending');
        const resolvedEl = document.getElementById('resolved');

        if (totalEl) totalEl.textContent = data.total || 0;
        if (pendingEl) pendingEl.textContent = data.pending || 0;
        if (resolvedEl) resolvedEl.textContent = data.resolved || 0;

        const responseTable = await fetch('/tickets_list');
        const tickets = await responseTable.json();
        console.log("üì© –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏:", tickets);

        const container = document.getElementById('ticketsBody');
        if (container) container.innerHTML = '';

        tickets.slice(0, currentPageSize).forEach(t => {
          const username = t.username ? `@${t.username}` : '–Ω–µ—Ç —é–∑–µ—Ä–Ω–µ–π–º–∞';
          const clientName = t.client_name || '–Ω–µ –∑–∞–¥–∞–Ω–æ';

          const client = `
            <span class="clickable-client" onclick="window.open('/client/${t.user_id}', '_blank')">
              <code>${t.user_id}</code><br>
              <small>${username}</small><br>
              <small>${clientName}</small>
            </span>
          `;

          const statusBadge = t.status === 'resolved'
            ? `<span class="badge bg-success">‚úÖ –†–µ—à–µ–Ω–æ</span>`
            : `<span class="badge bg-warning text-dark">‚è≥ –í –æ–±—Ä–∞–±–æ—Ç–∫–µ</span>`;

          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –±–∏–∑–Ω–µ—Å–∞
          let businessClass = '';
          if (t.business === '–°—É—à–∏–í–µ—Å–ª–∞') {
            businessClass = 'business-sushi';
          } else if (t.business === '–ë–ª–∏–Ω–ë–µ—Ä–∏') {
            businessClass = 'business-blin';
          }

          const actionBtns = t.status !== 'resolved'
            ? `<button class="btn btn-sm btn-primary" onclick="openReplyModal(${t.user_id})">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
               <button class="btn btn-sm btn-danger" onclick="confirmClose(${t.user_id}, '${t.ticket_id}')">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>`
            : '';

          const row = document.createElement('tr');
          row.dataset.search = `${t.user_id} ${t.username} ${clientName} ${t.ticket_id} ${t.business} ${t.city} ${t.location_name} ${t.problem} ${t.status} ${t.responsible} ${t.created_date} ${t.client_status || ''}`.toLowerCase();
          
          // –°–æ–∑–¥–∞–µ–º —è—á–µ–π–∫–∏ —Å —É—á–µ—Ç–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤–∏–¥–∏–º–æ—Å—Ç–∏
          let rowHTML = '';
          if (columnSettings.client) rowHTML += `<td>${client}</td>`;
          if (columnSettings.clientStatus) rowHTML += `<td>${t.client_status || '‚Äî'}</td>`;
          if (columnSettings.ticketId) rowHTML += `<td><code>${t.ticket_id}</code></td>`;
          if (columnSettings.business) rowHTML += `<td class="${businessClass}">${t.business}</td>`;
          if (columnSettings.location) rowHTML += `<td>${t.city}<br><small>${t.location_name}</small></td>`;
          if (columnSettings.problem) rowHTML += `<td>${t.problem}</td>`;
          if (columnSettings.responsible) rowHTML += `<td>${t.responsible}</td>`;
          if (columnSettings.status) rowHTML += `<td>${statusBadge}</td>`;
          if (columnSettings.date) rowHTML += `<td>${t.created_date}</td>`;
          if (columnSettings.time) rowHTML += `<td>${t.created_time}</td>`;
          if (columnSettings.actions) rowHTML += `<td>
            <button class="btn btn-sm btn-outline-secondary" onclick="loadHistory(${t.user_id}, '${t.ticket_id}')">–ò—Å—Ç–æ—Ä–∏—è</button>
            ${actionBtns}
          </td>`;
          
          row.innerHTML = rowHTML;
          container.appendChild(row);
        });

        applyFilters();
        initColumnResize(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º resize –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
      } catch (e) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –≤ autoRefreshTickets:", e);
      }
    }

    // === –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è ===
    function applyFilters() {
      const search = document.getElementById('searchInput')?.value.toLowerCase() || '';
      const status = document.getElementById('filterStatus')?.value || '';
      const user = document.getElementById('filterUser')?.value.toLowerCase() || '';
      const ticketId = document.getElementById('filterTicketId')?.value.toLowerCase() || '';
      const business = document.getElementById('filterBusiness')?.value.toLowerCase() || '';
      const location = document.getElementById('filterLocation')?.value.toLowerCase() || '';
      const responsible = document.getElementById('filterResponsible')?.value.toLowerCase() || '';
      const clientStatus = document.getElementById('filterClientStatus')?.value.toLowerCase() || '';
      const dateFrom = document.getElementById('filterDateFrom')?.value || '';
      const dateTo = document.getElementById('filterDateTo')?.value || '';

      document.querySelectorAll('#ticketsBody tr').forEach(row => {
        const text = row.dataset.search || '';
        const createdDate = text.match(/\d{4}-\d{2}-\d{2}/)?.[0] || '';

        const matches = (!search || text.includes(search)) &&
                       (!status || text.includes(status)) &&
                       (!user || text.includes(user)) &&
                       (!ticketId || text.includes(ticketId)) &&
                       (!business || text.includes(business)) &&
                       (!location || text.includes(location)) &&
                       (!responsible || text.includes(responsible)) &&
                       (!clientStatus || text.includes(clientStatus)) &&
                       (!dateFrom || createdDate >= dateFrom) &&
                       (!dateTo || createdDate <= dateTo);

        row.style.display = matches ? '' : 'none';
      });
    }

    // === –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π ===
    document.getElementById('searchInput')?.addEventListener('input', applyFilters);
    document.getElementById('filterStatus')?.addEventListener('change', applyFilters);
    document.getElementById('filterUser')?.addEventListener('input', applyFilters);
    document.getElementById('filterTicketId')?.addEventListener('input', applyFilters);
    document.getElementById('filterBusiness')?.addEventListener('input', applyFilters);
    document.getElementById('filterLocation')?.addEventListener('input', applyFilters);
    document.getElementById('filterClientStatus')?.addEventListener('input', applyFilters);
    document.getElementById('filterDateFrom')?.addEventListener('input', applyFilters);
    document.getElementById('filterDateTo')?.addEventListener('input', applyFilters);
    document.getElementById('filterResponsible')?.addEventListener('input', applyFilters);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –∑–∞—è–≤–æ–∫
    document.getElementById('pageSize')?.addEventListener('change', function() {
      currentPageSize = parseInt(this.value);
      localStorage.setItem('pageSize', currentPageSize);
      autoRefreshTickets();
    });

    document.addEventListener('DOMContentLoaded', () => {
  loadSendSettings();
  autoRefreshTickets();
  setInterval(autoRefreshTickets, 5000);
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤
  setTimeout(() => {
    applyColumnSettings();
    restoreColumnWidths(); // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É —Å—Ç–æ–ª–±—Ü–æ–≤
  }, 100);
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  window.addEventListener('beforeunload', saveColumnWidths);
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
  let resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      applyColumnSettings();
      initColumnResize();
    }, 250);
  });
});

    // === –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é ===
async function loadHistory(user_id, ticket_id) {
  currentUserId = user_id;
  currentTicketId = ticket_id;

  try {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
    const responseTable = await fetch('/tickets_list');
    const tickets = await responseTable.json();
    const clientData = tickets.find(t => t.user_id == user_id);

    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫: ID –∑–∞—è–≤–∫–∏
    document.getElementById('ticketIdDisplay').textContent = ticket_id;

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∞ –∏ —Å—Ç–∞—Ç—É—Å–∞
    const displayName = clientData?.client_name || clientData?.username || '–ö–ª–∏–µ–Ω—Ç';
    document.getElementById('clientDisplayName').textContent = displayName;
    document.getElementById('clientStatusDisplay').textContent = clientData?.client_status || '‚Äî';

    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–æ–±–ª–µ–º—É
    document.getElementById('problemText').textContent = clientData?.problem || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';

    // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä–∞–Ω–¥–∞—à—É ‚Üí —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏
    document.getElementById('editClientBtn').onclick = function () {
      // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É —Ç–µ–∫—É—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
      document.getElementById('clientNameInput').value = clientData?.client_name || '';
      document.getElementById('clientUsernameInput').value = clientData?.username || '';
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      new bootstrap.Modal(document.getElementById('editClientNameModal')).show();
    };

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
    const response = await fetch(`/history?user_id=${user_id}&ticket_id=${ticket_id}`);
    const data = await response.json();
    const container = document.getElementById('historyContent');
    container.innerHTML = '';

    if (data.messages && data.messages.length === 0) {
      container.innerHTML = '<p class="text-muted">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>';
    } else {
      // –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
      data.messages.forEach(msg => {
        const cls = msg.sender === 'support' ? 'from-support' : 'from-user';
        let name = msg.sender === 'support' ? 'üõ† –ü–æ–¥–¥–µ—Ä–∂–∫–∞' : 'üë§ –ö–ª–∏–µ–Ω—Ç';

        if (msg.sender === 'user') {
          const clientName = clientData?.client_name;
          const username = clientData?.username;
          if (clientName && clientName !== '–Ω–µ –∑–∞–¥–∞–Ω–æ') {
            name = 'üë§ ' + clientName;
          } else if (username) {
            name = 'üë§ @' + username;
          } else {
            name = 'üë§ –ö–ª–∏–µ–Ω—Ç';
          }
        }

        const time = new Date(msg.timestamp).toLocaleString('ru-RU');
        const bubble = document.createElement('div');
        bubble.className = `chat-bubble ${cls}`;
        bubble.innerHTML = `
          <small>${time}</small><br>
          <strong>${name}</strong>
          <p class="mb-0">${msg.message.replace(/\n/g, '<br>')}</p>
        `;
        container.appendChild(bubble);
      });
    }

    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫—Ä—ã—Ç–∏–∏
    let ticket = {};
    try {
      const response = await fetch(`/tickets/${ticket_id}`);
      if (response.ok) ticket = await response.json();
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞—è–≤–∫–µ:", e);
    }

    if (ticket.status === 'resolved') {
      const closeTime = ticket.resolved_at ? new Date(ticket.resolved_at).toLocaleString('ru-RU') : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
      const closeBy = ticket.resolved_by || '–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏';
      const closeBubble = document.createElement('div');
      closeBubble.className = 'chat-bubble from-support';
      closeBubble.innerHTML = `
        <small>${closeTime}</small><br>
        <strong>üîö –°–∏—Å—Ç–µ–º–∞</strong>
        <p class="mb-0">–ó–∞—è–≤–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞: <strong>${closeBy}</strong></p>
      `;
      container.appendChild(closeBubble);
    }

    container.scrollTop = container.scrollHeight;

    // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = new bootstrap.Modal(document.getElementById('historyModal'));
    modal.show();

    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¢–û–õ–¨–ö–û —Å–æ–æ–±—â–µ–Ω–∏–π
    if (historyPolling) clearInterval(historyPolling);
    historyPolling = setInterval(async () => {
      const response = await fetch(`/history?user_id=${user_id}&ticket_id=${ticket_id}`);
      const data = await response.json();
      const container = document.getElementById('historyContent');
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–∫—Ä—ã—Ç–∏–∏ –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
      const closeMessage = container.querySelector('.from-support:last-child');
      let closeHtml = '';
      if (closeMessage && closeMessage.innerHTML.includes('–ó–∞—è–≤–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞')) {
        closeHtml = closeMessage.outerHTML;
      }
      
      // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
      container.innerHTML = closeHtml;

      // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
      data.messages.forEach(msg => {
        const cls = msg.sender === 'support' ? 'from-support' : 'from-user';
        let name = msg.sender === 'support' ? 'üõ† –ü–æ–¥–¥–µ—Ä–∂–∫–∞' : 'üë§ –ö–ª–∏–µ–Ω—Ç';
        if (msg.sender === 'user') {
          const clientName = clientData?.client_name;
          const username = clientData?.username;
          if (clientName && clientName !== '–Ω–µ –∑–∞–¥–∞–Ω–æ') {
            name = 'üë§ ' + clientName;
          } else if (username) {
            name = 'üë§ @' + username;
          } else {
            name = 'üë§ –ö–ª–∏–µ–Ω—Ç';
          }
        }
        const time = new Date(msg.timestamp).toLocaleString('ru-RU');
        const bubble = document.createElement('div');
        bubble.className = `chat-bubble ${cls}`;
        bubble.innerHTML = `
          <small>${time}</small><br>
          <strong>${name}</strong>
          <p class="mb-0">${msg.message.replace(/\n/g, '<br>')}</p>
        `;
        container.appendChild(bubble);
      });
      
      container.scrollTop = container.scrollHeight;
    }, 3000);
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏:", error);
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏");
  }
}

    // === –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter/Ctrl+Enter ===
    document.getElementById('replyTextInHistory').addEventListener('keydown', function (e) {
      const mode = localStorage.getItem('sendKeySetting') || 'enter';

      if (e.key === 'Enter') {
        if (mode === 'enter' && !e.shiftKey && !e.ctrlKey) {
          e.preventDefault();
          document.getElementById('sendReplyInHistory').click();
        } else if (mode === 'ctrlEnter' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          document.getElementById('sendReplyInHistory').click();
        } else if (mode === 'enterNewline' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          document.getElementById('sendReplyInHistory').click();
        }
      }
    });

    // === –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ ===
    const sendReplyInHistoryBtn = document.getElementById('sendReplyInHistory');
    if (sendReplyInHistoryBtn) {
      sendReplyInHistoryBtn.onclick = async function () {
        const text = document.getElementById('replyTextInHistory').value.trim();
        if (!text) return;

        const admin = document.getElementById('adminName').value || '–ü–æ–¥–¥–µ—Ä–∂–∫–∞';

        const response = await fetch('/reply', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            user_id: currentUserId, 
            text, 
            admin,
            ticket_id: currentTicketId 
          })
        });

        const data = await response.json();
        if (data.success) {
          document.getElementById('replyTextInHistory').value = '';
          if (data.reopened) {
            alert('‚ö†Ô∏è –ó–∞—è–≤–∫–∞ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∞');
          }
        } else {
          alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
        }
      };
    }

    // === –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ ===
    async function saveClientName() {
      const newName = document.getElementById('clientNameInput').value.trim();
      const newUsername = document.getElementById('clientUsernameInput').value.trim();
      
      if (!newName && !newUsername) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ');
        return;
      }

      try {
        const response = await fetch('/update_client', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: currentUserId,
            client_name: newName,
            username: newUsername
          })
        });

        const data = await response.json();
        if (data.success) {
          alert('‚úÖ –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –∏—Å—Ç–æ—Ä–∏–∏
          const displayName = newName || newUsername || '–ö–ª–∏–µ–Ω—Ç';
          document.getElementById('clientDisplayName').textContent = displayName;
          
          // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
          bootstrap.Modal.getInstance(document.getElementById('editClientNameModal')).hide();
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –æ–±—ä–µ–∫—Ç–µ clientData
          if (clientData) {
            clientData.client_name = newName;
            clientData.username = newUsername;
          }
        } else {
          alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–º–µ–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∞:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
      }
    }

    // === –ó–∞–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É (—á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –æ–∫–Ω–æ) ===
    document.getElementById('closeTicketBtn').onclick = function () {
      const modal = new bootstrap.Modal(document.getElementById('closeTicketModal'));
      const select = document.getElementById('categorySelect');
      select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>';
      window.settings.categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        select.appendChild(option);
      });
      modal.show();
    };

    // === –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ ===
    document.getElementById('confirmCloseTicketBtn').onclick = async function () {
      const select = document.getElementById('categorySelect');
      const category = select.value;
      const admin = prompt("–í–∞—à–µ –∏–º—è –∏–ª–∏ @username:", "–ü–æ–¥–¥–µ—Ä–∂–∫–∞");
      if (!admin) return;
      if (!category) {
        alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
        return;
      }

      const response = await fetch('/close_ticket', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          user_id: currentUserId, 
          admin, 
          category, 
          ticket_id: currentTicketId 
        })
      });

      const data = await response.json();
      if (data.success) {
        alert('‚úÖ –ó–∞—è–≤–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞');
        location.reload();
      } else {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
      }

      bootstrap.Modal.getInstance(document.getElementById('closeTicketModal')).hide();
    };

    // === –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ (–∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ–∫–Ω–∞) ===
    function confirmClose(user_id, ticket_id) {
      if (confirm("–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞—è–≤–∫—É?")) {
        loadHistory(user_id, ticket_id);
      }
    }
  </script>
</body>
</html>
